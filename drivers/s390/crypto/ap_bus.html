<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › crypto › ap_bus.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ap_bus.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/s390/crypto/ap_bus.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 IBM Corporation</span>
<span class="cm"> * Author(s): Cornelia Huck &lt;cornelia.huck@de.ibm.com&gt;</span>
<span class="cm"> *	      Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;</span>
<span class="cm"> *	      Ralph Wuerthner &lt;rwuerthn@de.ibm.com&gt;</span>
<span class="cm"> *	      Felix Beck &lt;felix.beck@de.ibm.com&gt;</span>
<span class="cm"> *	      Holger Dengler &lt;hd@linux.vnet.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Adjunct processor bus.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;ap&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel_stat.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;asm/reset.h&gt;</span>
<span class="cp">#include &lt;asm/airq.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;asm/isc.h&gt;</span>
<span class="cp">#include &lt;linux/hrtimer.h&gt;</span>
<span class="cp">#include &lt;linux/ktime.h&gt;</span>
<span class="cp">#include &lt;asm/facility.h&gt;</span>

<span class="cp">#include &quot;ap_bus.h&quot;</span>

<span class="cm">/* Some prototypes. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ap_scan_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ap_poll_all</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">hrtimer_restart</span> <span class="n">ap_poll_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">hrtimer</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ap_poll_thread_start</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ap_poll_thread_stop</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ap_request_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">ap_schedule_poll_timer</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__ap_poll_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ap_device_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ap_device_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ap_interrupt_handler</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">unused1</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused2</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ap_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ap_config_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ap_select_domain</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Module description.</span>
<span class="cm"> */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;IBM Corporation&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Adjunct Processor Bus driver, &quot;</span>
		   <span class="s">&quot;Copyright 2006 IBM Corporation&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Module parameter</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">ap_domain_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Adjunct Processor Domain Index */</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">ap_domain_index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0000</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="s">&quot;domain index for ap devices&quot;</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ap_domain_index</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ap_thread_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">poll_thread</span><span class="p">,</span> <span class="n">ap_thread_flag</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0000</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">poll_thread</span><span class="p">,</span> <span class="s">&quot;Turn on/off poll thread, default is 0 (off).&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">ap_root_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">ap_device_list_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">ap_device_list</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Workqueue &amp; timer for bus rescan.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">ap_work_queue</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">ap_config_timer</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ap_config_time</span> <span class="o">=</span> <span class="n">AP_CONFIG_TIME</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">ap_config_work</span><span class="p">,</span> <span class="n">ap_scan_bus</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Tasklet &amp; timer for AP request polling and interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DECLARE_TASKLET</span><span class="p">(</span><span class="n">ap_tasklet</span><span class="p">,</span> <span class="n">ap_poll_all</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">ap_poll_requests</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">ap_poll_wait</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">ap_poll_kthread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">ap_poll_thread_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">ap_poll_timer_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ap_interrupt_indicator</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hrtimer</span> <span class="n">ap_poll_timer</span><span class="p">;</span>
<span class="cm">/* In LPAR poll with 4kHz frequency. Poll every 250000 nanoseconds.</span>
<span class="cm"> * If z/VM change to 1500000 nanoseconds to adjust to z/VM polling.*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">poll_timeout</span> <span class="o">=</span> <span class="mi">250000</span><span class="p">;</span>

<span class="cm">/* Suspend flag */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ap_suspend_flag</span><span class="p">;</span>
<span class="cm">/* Flag to check if domain was set through module parameter domain=. This is</span>
<span class="cm"> * important when supsend and resume is done in a z/VM environment where the</span>
<span class="cm"> * domain might change. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">user_set_domain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_type</span> <span class="n">ap_bus_type</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * ap_using_interrupts() - Returns non-zero if interrupt support is</span>
<span class="cm"> * available.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ap_using_interrupts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ap_interrupt_indicator</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_intructions_available() - Test if AP instructions are available.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if the AP instructions are installed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ap_instructions_available</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg0</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">AP_MKQID</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg1</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg2</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;   .long 0xb2af0000</span><span class="se">\n</span><span class="s">&quot;</span>		<span class="cm">/* PQAP(TAPQ) */</span>
		<span class="s">&quot;0: la    %1,0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;1:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="n">EX_TABLE</span><span class="p">(</span><span class="mi">0</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="n">b</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg0</span><span class="p">),</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg1</span><span class="p">),</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg2</span><span class="p">)</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;cc&quot;</span> <span class="p">);</span>
	<span class="k">return</span> <span class="n">reg1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_interrupts_available(): Test if AP interrupts are available.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if AP interrupts are available.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_interrupts_available</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_facility</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">test_facility</span><span class="p">(</span><span class="mi">65</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_test_queue(): Test adjunct processor queue.</span>
<span class="cm"> * @qid: The AP queue number</span>
<span class="cm"> * @queue_depth: Pointer to queue depth value</span>
<span class="cm"> * @device_type: Pointer to device type value</span>
<span class="cm"> *</span>
<span class="cm"> * Returns AP queue status structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ap_queue_status</span>
<span class="nf">ap_test_queue</span><span class="p">(</span><span class="n">ap_qid_t</span> <span class="n">qid</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">queue_depth</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">device_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg0</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">qid</span><span class="p">;</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">ap_queue_status</span> <span class="n">reg1</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">);</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg2</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;.long 0xb2af0000&quot;</span>		<span class="cm">/* PQAP(TAPQ) */</span>
		     <span class="o">:</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg0</span><span class="p">),</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">reg1</span><span class="p">),</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg2</span><span class="p">)</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">device_type</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">reg2</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="o">*</span><span class="n">queue_depth</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">reg2</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">reg1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_reset_queue(): Reset adjunct processor queue.</span>
<span class="cm"> * @qid: The AP queue number</span>
<span class="cm"> *</span>
<span class="cm"> * Returns AP queue status structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ap_queue_status</span> <span class="nf">ap_reset_queue</span><span class="p">(</span><span class="n">ap_qid_t</span> <span class="n">qid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg0</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">qid</span> <span class="o">|</span> <span class="mh">0x01000000UL</span><span class="p">;</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">ap_queue_status</span> <span class="n">reg1</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">);</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg2</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;.long 0xb2af0000&quot;</span>		<span class="cm">/* PQAP(RAPQ) */</span>
		<span class="o">:</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg0</span><span class="p">),</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">reg1</span><span class="p">),</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg2</span><span class="p">)</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">reg1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_64BIT</span>
<span class="cm">/**</span>
<span class="cm"> * ap_queue_interruption_control(): Enable interruption for a specific AP.</span>
<span class="cm"> * @qid: The AP queue number</span>
<span class="cm"> * @ind: The notification indicator byte</span>
<span class="cm"> *</span>
<span class="cm"> * Returns AP queue status.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ap_queue_status</span>
<span class="nf">ap_queue_interruption_control</span><span class="p">(</span><span class="n">ap_qid_t</span> <span class="n">qid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ind</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg0</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">qid</span> <span class="o">|</span> <span class="mh">0x03000000UL</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg1_in</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x0000800000000000UL</span> <span class="o">|</span> <span class="n">AP_ISC</span><span class="p">;</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">ap_queue_status</span> <span class="n">reg1_out</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">);</span>
	<span class="k">register</span> <span class="kt">void</span> <span class="o">*</span><span class="n">reg2</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">ind</span><span class="p">;</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;.long 0xb2af0000&quot;</span>		<span class="cm">/* PQAP(AQIC) */</span>
		<span class="o">:</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg0</span><span class="p">),</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg1_in</span><span class="p">),</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">reg1_out</span><span class="p">),</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg2</span><span class="p">)</span>
		<span class="o">:</span>
		<span class="o">:</span> <span class="s">&quot;cc&quot;</span> <span class="p">);</span>
	<span class="k">return</span> <span class="n">reg1_out</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_64BIT</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ap_queue_status</span>
<span class="nf">__ap_query_functions</span><span class="p">(</span><span class="n">ap_qid_t</span> <span class="n">qid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">functions</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg0</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0UL</span> <span class="o">|</span> <span class="n">qid</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">ap_queue_status</span> <span class="n">reg1</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">AP_QUEUE_STATUS_INVALID</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg2</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">);</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;.long 0xb2af0000</span><span class="se">\n</span><span class="s">&quot;</span>		<span class="cm">/* PQAP(TAPQ) */</span>
		<span class="s">&quot;0:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="n">EX_TABLE</span><span class="p">(</span><span class="mi">0</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="n">b</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg0</span><span class="p">),</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg1</span><span class="p">),</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">reg2</span><span class="p">)</span>
		<span class="o">:</span>
		<span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">functions</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">reg2</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">reg1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * ap_query_functions(): Query supported functions.</span>
<span class="cm"> * @qid: The AP queue number</span>
<span class="cm"> * @functions: Pointer to functions field.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns</span>
<span class="cm"> *   0	     on success.</span>
<span class="cm"> *   -ENODEV  if queue not valid.</span>
<span class="cm"> *   -EBUSY   if device busy.</span>
<span class="cm"> *   -EINVAL  if query function is not supported</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_query_functions</span><span class="p">(</span><span class="n">ap_qid_t</span> <span class="n">qid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">functions</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
	<span class="k">struct</span> <span class="n">ap_queue_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">__ap_query_functions</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="n">functions</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AP_MAX_RESET</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap_queue_status_invalid_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">response_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_NORMAL</span>:
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_RESET_IN_PROGRESS</span>:
		<span class="k">case</span> <span class="n">AP_RESPONSE_BUSY</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_Q_NOT_AVAIL</span>:
		<span class="k">case</span> <span class="n">AP_RESPONSE_DECONFIGURED</span>:
		<span class="k">case</span> <span class="n">AP_RESPONSE_CHECKSTOPPED</span>:
		<span class="k">case</span> <span class="n">AP_RESPONSE_INVALID_ADDRESS</span>:
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_OTHERWISE_CHANGED</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">AP_MAX_RESET</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">__ap_query_functions</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="n">functions</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_4096_commands_availablen(): Check for availability of 4096 bit RSA</span>
<span class="cm"> * support.</span>
<span class="cm"> * @qid: The AP queue number</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if 4096 bit RSA keys are support fo the AP, returns 0 if not.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ap_4096_commands_available</span><span class="p">(</span><span class="n">ap_qid_t</span> <span class="n">qid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">functions</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap_query_functions</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">functions</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">test_ap_facility</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="n">test_ap_facility</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ap_4096_commands_available</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ap_queue_enable_interruption(): Enable interruption on an AP.</span>
<span class="cm"> * @qid: The AP queue number</span>
<span class="cm"> * @ind: the notification indicator byte</span>
<span class="cm"> *</span>
<span class="cm"> * Enables interruption on AP queue via ap_queue_interruption_control(). Based</span>
<span class="cm"> * on the return value it waits a while and tests the AP queue if interrupts</span>
<span class="cm"> * have been switched on using ap_test_queue().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_queue_enable_interruption</span><span class="p">(</span><span class="n">ap_qid_t</span> <span class="n">qid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ind</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
	<span class="k">struct</span> <span class="n">ap_queue_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t_depth</span><span class="p">,</span> <span class="n">t_device_type</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ap_queue_interruption_control</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="n">ind</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AP_MAX_RESET</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">response_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_NORMAL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">int_enabled</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_RESET_IN_PROGRESS</span>:
		<span class="k">case</span> <span class="n">AP_RESPONSE_BUSY</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_Q_NOT_AVAIL</span>:
		<span class="k">case</span> <span class="n">AP_RESPONSE_DECONFIGURED</span>:
		<span class="k">case</span> <span class="n">AP_RESPONSE_CHECKSTOPPED</span>:
		<span class="k">case</span> <span class="n">AP_RESPONSE_INVALID_ADDRESS</span>:
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_OTHERWISE_CHANGED</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">int_enabled</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">AP_MAX_RESET</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ap_test_queue</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t_depth</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t_device_type</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __ap_send(): Send message to adjunct processor queue.</span>
<span class="cm"> * @qid: The AP queue number</span>
<span class="cm"> * @psmid: The program supplied message identifier</span>
<span class="cm"> * @msg: The message text</span>
<span class="cm"> * @length: The message length</span>
<span class="cm"> * @special: Special Bit</span>
<span class="cm"> *</span>
<span class="cm"> * Returns AP queue status structure.</span>
<span class="cm"> * Condition code 1 on NQAP can&#39;t happen because the L bit is 1.</span>
<span class="cm"> * Condition code 2 on NQAP also means the send is incomplete,</span>
<span class="cm"> * because a segment boundary was reached. The NQAP is repeated.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ap_queue_status</span>
<span class="nf">__ap_send</span><span class="p">(</span><span class="n">ap_qid_t</span> <span class="n">qid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">psmid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span>
	  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">special</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span> <span class="kt">char</span> <span class="n">_</span><span class="p">[</span><span class="n">length</span><span class="p">];</span> <span class="p">}</span> <span class="n">msgblock</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg0</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">qid</span> <span class="o">|</span> <span class="mh">0x40000000UL</span><span class="p">;</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">ap_queue_status</span> <span class="n">reg1</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">);</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg2</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg3</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;3&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg4</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;4&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">psmid</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg5</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;5&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">psmid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">special</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">reg0</span> <span class="o">|=</span> <span class="mh">0x400000UL</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
		<span class="s">&quot;0: .long 0xb2ad0042</span><span class="se">\n</span><span class="s">&quot;</span>		<span class="cm">/* NQAP */</span>
		<span class="s">&quot;   brc   2,0b&quot;</span>
		<span class="o">:</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg0</span><span class="p">),</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">reg1</span><span class="p">),</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg2</span><span class="p">),</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg3</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">reg4</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">reg5</span><span class="p">),</span> <span class="s">&quot;m&quot;</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">msgblock</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;cc&quot;</span> <span class="p">);</span>
	<span class="k">return</span> <span class="n">reg1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ap_send</span><span class="p">(</span><span class="n">ap_qid_t</span> <span class="n">qid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">psmid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_queue_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">__ap_send</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="n">psmid</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">response_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AP_RESPONSE_NORMAL</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AP_RESPONSE_Q_FULL</span>:
	<span class="k">case</span> <span class="n">AP_RESPONSE_RESET_IN_PROGRESS</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AP_RESPONSE_REQ_FAC_NOT_INST</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="cm">/* Device is gone. */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ap_send</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * __ap_recv(): Receive message from adjunct processor queue.</span>
<span class="cm"> * @qid: The AP queue number</span>
<span class="cm"> * @psmid: Pointer to program supplied message identifier</span>
<span class="cm"> * @msg: The message text</span>
<span class="cm"> * @length: The message length</span>
<span class="cm"> *</span>
<span class="cm"> * Returns AP queue status structure.</span>
<span class="cm"> * Condition code 1 on DQAP means the receive has taken place</span>
<span class="cm"> * but only partially.	The response is incomplete, hence the</span>
<span class="cm"> * DQAP is repeated.</span>
<span class="cm"> * Condition code 2 on DQAP also means the receive is incomplete,</span>
<span class="cm"> * this time because a segment boundary was reached. Again, the</span>
<span class="cm"> * DQAP is repeated.</span>
<span class="cm"> * Note that gpr2 is used by the DQAP instruction to keep track of</span>
<span class="cm"> * any &#39;residual&#39; length, in case the instruction gets interrupted.</span>
<span class="cm"> * Hence it gets zeroed before the instruction.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ap_queue_status</span>
<span class="nf">__ap_recv</span><span class="p">(</span><span class="n">ap_qid_t</span> <span class="n">qid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">psmid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span> <span class="kt">char</span> <span class="n">_</span><span class="p">[</span><span class="n">length</span><span class="p">];</span> <span class="p">}</span> <span class="n">msgblock</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg0</span> <span class="n">asm</span><span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">qid</span> <span class="o">|</span> <span class="mh">0x80000000UL</span><span class="p">;</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">ap_queue_status</span> <span class="n">reg1</span> <span class="n">asm</span> <span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">);</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg2</span> <span class="n">asm</span><span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg4</span> <span class="n">asm</span><span class="p">(</span><span class="s">&quot;4&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg5</span> <span class="n">asm</span><span class="p">(</span><span class="s">&quot;5&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg6</span> <span class="n">asm</span><span class="p">(</span><span class="s">&quot;6&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg7</span> <span class="n">asm</span><span class="p">(</span><span class="s">&quot;7&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>


	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;0: .long 0xb2ae0064</span><span class="se">\n</span><span class="s">&quot;</span>		<span class="cm">/* DQAP */</span>
		<span class="s">&quot;   brc   6,0b</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="o">:</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg0</span><span class="p">),</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">reg1</span><span class="p">),</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg2</span><span class="p">),</span>
		<span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg4</span><span class="p">),</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg5</span><span class="p">),</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg6</span><span class="p">),</span> <span class="s">&quot;+d&quot;</span> <span class="p">(</span><span class="n">reg7</span><span class="p">),</span>
		<span class="s">&quot;=m&quot;</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">msgblock</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;cc&quot;</span> <span class="p">);</span>
	<span class="o">*</span><span class="n">psmid</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">reg6</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="n">reg7</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">reg1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ap_recv</span><span class="p">(</span><span class="n">ap_qid_t</span> <span class="n">qid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">psmid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_queue_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">__ap_recv</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="n">psmid</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">response_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AP_RESPONSE_NORMAL</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AP_RESPONSE_NO_PENDING_REPLY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">queue_empty</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AP_RESPONSE_RESET_IN_PROGRESS</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ap_recv</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ap_query_queue(): Check if an AP queue is available.</span>
<span class="cm"> * @qid: The AP queue number</span>
<span class="cm"> * @queue_depth: Pointer to queue depth value</span>
<span class="cm"> * @device_type: Pointer to device type value</span>
<span class="cm"> *</span>
<span class="cm"> * The test is repeated for AP_MAX_RESET times.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_query_queue</span><span class="p">(</span><span class="n">ap_qid_t</span> <span class="n">qid</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">queue_depth</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">device_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_queue_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t_depth</span><span class="p">,</span> <span class="n">t_device_type</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AP_MAX_RESET</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ap_test_queue</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t_depth</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t_device_type</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">response_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_NORMAL</span>:
			<span class="o">*</span><span class="n">queue_depth</span> <span class="o">=</span> <span class="n">t_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="o">*</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">t_device_type</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_Q_NOT_AVAIL</span>:
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_RESET_IN_PROGRESS</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_DECONFIGURED</span>:
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_CHECKSTOPPED</span>:
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_INVALID_ADDRESS</span>:
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_OTHERWISE_CHANGED</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_BUSY</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">AP_MAX_RESET</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_init_queue(): Reset an AP queue.</span>
<span class="cm"> * @qid: The AP queue number</span>
<span class="cm"> *</span>
<span class="cm"> * Reset an AP queue and wait for it to become available again.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_init_queue</span><span class="p">(</span><span class="n">ap_qid_t</span> <span class="n">qid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_queue_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ap_reset_queue</span><span class="p">(</span><span class="n">qid</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AP_MAX_RESET</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">response_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_NORMAL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">queue_empty</span><span class="p">)</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_Q_NOT_AVAIL</span>:
		<span class="k">case</span> <span class="n">AP_RESPONSE_DECONFIGURED</span>:
		<span class="k">case</span> <span class="n">AP_RESPONSE_CHECKSTOPPED</span>:
			<span class="n">i</span> <span class="o">=</span> <span class="n">AP_MAX_RESET</span><span class="p">;</span>	<span class="cm">/* return with -ENODEV */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_RESET_IN_PROGRESS</span>:
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_BUSY</span>:
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">AP_MAX_RESET</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ap_test_queue</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ap_using_interrupts</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ap_queue_enable_interruption</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="n">ap_interrupt_indicator</span><span class="p">);</span>
		<span class="cm">/* If interruption mode is supported by the machine,</span>
<span class="cm">		* but an AP can not be enabled for interruption then</span>
<span class="cm">		* the AP will be discarded.    */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Registering adapter interrupts for &quot;</span>
			       <span class="s">&quot;AP %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">AP_QID_DEVICE</span><span class="p">(</span><span class="n">qid</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_increase_queue_count(): Arm request timeout.</span>
<span class="cm"> * @ap_dev: Pointer to an AP device.</span>
<span class="cm"> *</span>
<span class="cm"> * Arm request timeout if an AP device was idle and a new request is submitted.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_increase_queue_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">request_timeout</span><span class="p">;</span>

	<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">AP_RESET_ARMED</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_decrease_queue_count(): Decrease queue count.</span>
<span class="cm"> * @ap_dev: Pointer to an AP device.</span>
<span class="cm"> *</span>
<span class="cm"> * If AP device is still alive, re-schedule request timeout if there are still</span>
<span class="cm"> * pending requests.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_decrease_queue_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">request_timeout</span><span class="p">;</span>

	<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/*</span>
<span class="cm">		 * The timeout timer should to be disabled now - since</span>
<span class="cm">		 * del_timer_sync() is very expensive, we just tell via the</span>
<span class="cm">		 * reset flag to ignore the pending timeout timer.</span>
<span class="cm">		 */</span>
		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">AP_RESET_IGNORE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * AP device related attributes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ap_hwtype_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span> <span class="o">=</span> <span class="n">to_ap_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">hwtype</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">ap_hwtype_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ap_depth_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span> <span class="o">=</span> <span class="n">to_ap_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">ap_depth_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ap_request_count_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span> <span class="o">=</span> <span class="n">to_ap_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">total_request_count</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">request_count</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">ap_request_count_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ap_modalias_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;ap:t%02X&quot;</span><span class="p">,</span> <span class="n">to_ap_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">modalias</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">ap_modalias_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">ap_dev_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hwtype</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_depth</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_request_count</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_modalias</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">ap_dev_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ap_dev_attrs</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ap_bus_match()</span>
<span class="cm"> * @dev: Pointer to device</span>
<span class="cm"> * @drv: Pointer to device_driver</span>
<span class="cm"> *</span>
<span class="cm"> * AP bus driver registration/unregistration.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_bus_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span> <span class="o">=</span> <span class="n">to_ap_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ap_driver</span> <span class="o">*</span><span class="n">ap_drv</span> <span class="o">=</span> <span class="n">to_ap_drv</span><span class="p">(</span><span class="n">drv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ap_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Compare device type of the device with the list of</span>
<span class="cm">	 * supported types of the device_driver.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="n">ap_drv</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="p">;</span> <span class="n">id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">AP_DEVICE_ID_MATCH_DEVICE_TYPE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">!=</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_uevent(): Uevent function for AP devices.</span>
<span class="cm"> * @dev: Pointer to device</span>
<span class="cm"> * @env: Pointer to kobj_uevent_env</span>
<span class="cm"> *</span>
<span class="cm"> * It sets up a single environment variable DEV_TYPE which contains the</span>
<span class="cm"> * hardware device type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_uevent</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobj_uevent_env</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span> <span class="o">=</span> <span class="n">to_ap_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Set up DEV_TYPE environment variable. */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;DEV_TYPE=%04X&quot;</span><span class="p">,</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Add MODALIAS= */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;MODALIAS=ap:t%02X&quot;</span><span class="p">,</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_bus_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span> <span class="o">=</span> <span class="n">to_ap_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap_suspend_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap_suspend_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Disable scanning for devices, thus we do not want to scan</span>
<span class="cm">		 * for them after removing.</span>
<span class="cm">		 */</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_config_timer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap_work_queue</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">ap_work_queue</span><span class="p">);</span>
			<span class="n">ap_work_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_tasklet</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Poll on the device until all requests are finished. */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">__ap_poll_device</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">unregistered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_bus_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span> <span class="o">=</span> <span class="n">to_ap_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap_suspend_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap_suspend_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap_interrupts_available</span><span class="p">())</span>
			<span class="n">ap_interrupt_indicator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_set_domain</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ap_domain_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">ap_select_domain</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_config_timer</span><span class="p">);</span>
		<span class="n">ap_config_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">ap_config_timeout</span><span class="p">;</span>
		<span class="n">ap_config_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ap_config_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ap_config_time</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_config_timer</span><span class="p">);</span>
		<span class="n">ap_work_queue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;kapwork&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap_work_queue</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">tasklet_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_tasklet</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap_using_interrupts</span><span class="p">())</span>
			<span class="n">ap_schedule_poll_timer</span><span class="p">();</span>
		<span class="k">else</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_tasklet</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap_thread_flag</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ap_poll_thread_start</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AP_QID_QUEUE</span><span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ap_domain_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">qid</span> <span class="o">=</span> <span class="n">AP_MKQID</span><span class="p">(</span><span class="n">AP_QID_DEVICE</span><span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">),</span>
				       <span class="n">ap_domain_index</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">ap_work_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_config_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_type</span> <span class="n">ap_bus_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ap&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap_bus_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uevent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap_uevent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">ap_bus_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ap_bus_resume</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_device_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span> <span class="o">=</span> <span class="n">to_ap_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ap_driver</span> <span class="o">*</span><span class="n">ap_drv</span> <span class="o">=</span> <span class="n">to_ap_drv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">drv</span> <span class="o">=</span> <span class="n">ap_drv</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ap_drv</span><span class="o">-&gt;</span><span class="n">probe</span> <span class="o">?</span> <span class="n">ap_drv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_device_list_lock</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_device_list</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_device_list_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __ap_flush_queue(): Flush requests.</span>
<span class="cm"> * @ap_dev: Pointer to the AP device</span>
<span class="cm"> *</span>
<span class="cm"> * Flush all requests from the request/pending queue of an AP device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ap_flush_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_message</span> <span class="o">*</span><span class="n">ap_msg</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ap_msg</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">pendingq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">pendingq_count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">receive</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">,</span> <span class="n">ap_msg</span><span class="p">,</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ap_msg</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">requestq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">requestq_count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">receive</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">,</span> <span class="n">ap_msg</span><span class="p">,</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ap_flush_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">__ap_flush_queue</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ap_flush_queue</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_device_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span> <span class="o">=</span> <span class="n">to_ap_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ap_driver</span> <span class="o">*</span><span class="n">ap_drv</span> <span class="o">=</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">;</span>

	<span class="n">ap_flush_queue</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_device_list_lock</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_device_list_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap_drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span>
		<span class="n">ap_drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">atomic_sub</span><span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_poll_requests</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ap_driver_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_driver</span> <span class="o">*</span><span class="n">ap_drv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span><span class="p">,</span>
		       <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap_drv</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

	<span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap_bus_type</span><span class="p">;</span>
	<span class="n">drv</span><span class="o">-&gt;</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ap_device_probe</span><span class="p">;</span>
	<span class="n">drv</span><span class="o">-&gt;</span><span class="n">remove</span> <span class="o">=</span> <span class="n">ap_device_remove</span><span class="p">;</span>
	<span class="n">drv</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="p">;</span>
	<span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">driver_register</span><span class="p">(</span><span class="n">drv</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ap_driver_register</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ap_driver_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_driver</span> <span class="o">*</span><span class="n">ap_drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_drv</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ap_driver_unregister</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * AP bus attributes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ap_domain_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_type</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap_domain_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">BUS_ATTR</span><span class="p">(</span><span class="n">ap_domain</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">ap_domain_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ap_config_time_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_type</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap_config_time</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ap_interrupts_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_type</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ap_using_interrupts</span><span class="p">()</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">BUS_ATTR</span><span class="p">(</span><span class="n">ap_interrupts</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">ap_interrupts_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ap_config_time_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_type</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">time</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">time</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">time</span> <span class="o">&gt;</span> <span class="mi">120</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ap_config_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_config_timer</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_config_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ap_config_time</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ap_config_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ap_config_time</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_config_timer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">BUS_ATTR</span><span class="p">(</span><span class="n">config_time</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">ap_config_time_show</span><span class="p">,</span> <span class="n">ap_config_time_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ap_poll_thread_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_type</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap_poll_kthread</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ap_poll_thread_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_type</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flag</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ap_poll_thread_start</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">ap_poll_thread_stop</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">BUS_ATTR</span><span class="p">(</span><span class="n">poll_thread</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">ap_poll_thread_show</span><span class="p">,</span> <span class="n">ap_poll_thread_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">poll_timeout_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_type</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">poll_timeout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">poll_timeout_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_type</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				  <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">time</span><span class="p">;</span>
	<span class="n">ktime_t</span> <span class="n">hr_time</span><span class="p">;</span>

	<span class="cm">/* 120 seconds = maximum poll interval */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">time</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span>
	    <span class="n">time</span> <span class="o">&gt;</span> <span class="mi">120000000000ULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">poll_timeout</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span>
	<span class="n">hr_time</span> <span class="o">=</span> <span class="n">ktime_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">poll_timeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hrtimer_is_queued</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_timer</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">hrtimer_forward</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_timer</span><span class="p">,</span> <span class="n">hrtimer_get_expires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_timer</span><span class="p">),</span> <span class="n">hr_time</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hrtimer_set_expires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_timer</span><span class="p">,</span> <span class="n">hr_time</span><span class="p">);</span>
		<span class="n">hrtimer_start_expires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_timer</span><span class="p">,</span> <span class="n">HRTIMER_MODE_ABS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">BUS_ATTR</span><span class="p">(</span><span class="n">poll_timeout</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">poll_timeout_show</span><span class="p">,</span> <span class="n">poll_timeout_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_attribute</span> <span class="o">*</span><span class="k">const</span> <span class="n">ap_bus_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">bus_attr_ap_domain</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bus_attr_config_time</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bus_attr_poll_thread</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bus_attr_ap_interrupts</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bus_attr_poll_timeout</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ap_select_domain(): Select an AP domain.</span>
<span class="cm"> *</span>
<span class="cm"> * Pick one of the 16 AP domains.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_select_domain</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">queue_depth</span><span class="p">,</span> <span class="n">device_type</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">max_count</span><span class="p">,</span> <span class="n">best_domain</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We want to use a single domain. Either the one specified with</span>
<span class="cm">	 * the &quot;domain=&quot; parameter or the domain with the maximum number</span>
<span class="cm">	 * of devices.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap_domain_index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ap_domain_index</span> <span class="o">&lt;</span> <span class="n">AP_DOMAINS</span><span class="p">)</span>
		<span class="cm">/* Domain has already been selected. */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">best_domain</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">max_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AP_DOMAINS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">AP_DEVICES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ap_qid_t</span> <span class="n">qid</span> <span class="o">=</span> <span class="n">AP_MKQID</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ap_query_queue</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue_depth</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_type</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">max_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
			<span class="n">best_domain</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">best_domain</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">ap_domain_index</span> <span class="o">=</span> <span class="n">best_domain</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_probe_device_type(): Find the device type of an AP.</span>
<span class="cm"> * @ap_dev: pointer to the AP device.</span>
<span class="cm"> *</span>
<span class="cm"> * Find the device type if query queue returned a device type of 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_probe_device_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x06</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x01</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x43</span><span class="p">,</span><span class="mh">0x43</span><span class="p">,</span><span class="mh">0x41</span><span class="p">,</span><span class="mh">0x2d</span><span class="p">,</span><span class="mh">0x41</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span>
		<span class="mh">0x50</span><span class="p">,</span><span class="mh">0x4c</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x4b</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x1c</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0xb8</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x70</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x41</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x54</span><span class="p">,</span><span class="mh">0x32</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xa0</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xb8</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x0a</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x49</span><span class="p">,</span><span class="mh">0x43</span><span class="p">,</span><span class="mh">0x53</span><span class="p">,</span><span class="mh">0x46</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span>
		<span class="mh">0x50</span><span class="p">,</span><span class="mh">0x4b</span><span class="p">,</span><span class="mh">0x0a</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x4b</span><span class="p">,</span><span class="mh">0x43</span><span class="p">,</span><span class="mh">0x53</span><span class="p">,</span>
		<span class="mh">0x2d</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0x2e</span><span class="p">,</span><span class="mh">0x32</span><span class="p">,</span><span class="mh">0x37</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span>
		<span class="mh">0x33</span><span class="p">,</span><span class="mh">0x44</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0x66</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="mh">0x88</span><span class="p">,</span><span class="mh">0x99</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x11</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x33</span><span class="p">,</span><span class="mh">0x44</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0x66</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="mh">0x88</span><span class="p">,</span>
		<span class="mh">0x99</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x33</span><span class="p">,</span><span class="mh">0x44</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0x66</span><span class="p">,</span>
		<span class="mh">0x77</span><span class="p">,</span><span class="mh">0x88</span><span class="p">,</span><span class="mh">0x99</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x33</span><span class="p">,</span><span class="mh">0x44</span><span class="p">,</span>
		<span class="mh">0x55</span><span class="p">,</span><span class="mh">0x66</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="mh">0x88</span><span class="p">,</span><span class="mh">0x99</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span>
		<span class="mh">0x33</span><span class="p">,</span><span class="mh">0x44</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0x66</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="mh">0x88</span><span class="p">,</span><span class="mh">0x99</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x11</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x33</span><span class="p">,</span><span class="mh">0x5d</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x5b</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span>
		<span class="mh">0x88</span><span class="p">,</span><span class="mh">0x1e</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x57</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x4f</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x03</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span>
		<span class="mh">0xce</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x2d</span><span class="p">,</span><span class="mh">0x5f</span><span class="p">,</span><span class="mh">0xa9</span><span class="p">,</span><span class="mh">0xde</span><span class="p">,</span><span class="mh">0x0c</span><span class="p">,</span>
		<span class="mh">0xf6</span><span class="p">,</span><span class="mh">0xd2</span><span class="p">,</span><span class="mh">0x7b</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0x4b</span><span class="p">,</span><span class="mh">0xf9</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span>
		<span class="mh">0x3d</span><span class="p">,</span><span class="mh">0xb4</span><span class="p">,</span><span class="mh">0xf4</span><span class="p">,</span><span class="mh">0xef</span><span class="p">,</span><span class="mh">0x78</span><span class="p">,</span><span class="mh">0xd5</span><span class="p">,</span><span class="mh">0xbe</span><span class="p">,</span><span class="mh">0x66</span><span class="p">,</span>
		<span class="mh">0x63</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span><span class="mh">0xef</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">,</span><span class="mh">0xfd</span><span class="p">,</span><span class="mh">0xa4</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">,</span><span class="mh">0xb0</span><span class="p">,</span>
		<span class="mh">0x8e</span><span class="p">,</span><span class="mh">0x29</span><span class="p">,</span><span class="mh">0xc2</span><span class="p">,</span><span class="mh">0xc9</span><span class="p">,</span><span class="mh">0x2e</span><span class="p">,</span><span class="mh">0xd8</span><span class="p">,</span><span class="mh">0x45</span><span class="p">,</span><span class="mh">0xb8</span><span class="p">,</span>
		<span class="mh">0x53</span><span class="p">,</span><span class="mh">0x8c</span><span class="p">,</span><span class="mh">0x6f</span><span class="p">,</span><span class="mh">0x4e</span><span class="p">,</span><span class="mh">0x72</span><span class="p">,</span><span class="mh">0x8f</span><span class="p">,</span><span class="mh">0x6c</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span>
		<span class="mh">0x9c</span><span class="p">,</span><span class="mh">0x88</span><span class="p">,</span><span class="mh">0xfc</span><span class="p">,</span><span class="mh">0x1e</span><span class="p">,</span><span class="mh">0xc5</span><span class="p">,</span><span class="mh">0x83</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0x57</span><span class="p">,</span>
		<span class="mh">0xf7</span><span class="p">,</span><span class="mh">0xdd</span><span class="p">,</span><span class="mh">0xfd</span><span class="p">,</span><span class="mh">0x4f</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x36</span><span class="p">,</span><span class="mh">0x95</span><span class="p">,</span><span class="mh">0x5d</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">ap_queue_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">psmid</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">__ap_send</span><span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">,</span> <span class="mh">0x0102030405060708ULL</span><span class="p">,</span>
			   <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">response_code</span> <span class="o">!=</span> <span class="n">AP_RESPONSE_NORMAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Wait for the test message to complete. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">__ap_recv</span><span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psmid</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">response_code</span> <span class="o">==</span> <span class="n">AP_RESPONSE_NORMAL</span> <span class="o">&amp;&amp;</span>
		    <span class="n">psmid</span> <span class="o">==</span> <span class="mh">0x0102030405060708ULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Got an answer. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x86</span><span class="p">)</span>
			<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">AP_DEVICE_TYPE_PCICC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">AP_DEVICE_TYPE_PCICA</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">reply</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_interrupt_handler</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">unused1</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kstat_cpu</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">()).</span><span class="n">irqs</span><span class="p">[</span><span class="n">IOINT_APB</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __ap_scan_bus(): Scan the AP bus.</span>
<span class="cm"> * @dev: Pointer to device</span>
<span class="cm"> * @data: Pointer to data</span>
<span class="cm"> *</span>
<span class="cm"> * Scan the AP bus for new devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ap_scan_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">to_ap_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">qid</span> <span class="o">==</span> <span class="p">(</span><span class="n">ap_qid_t</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_device_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span> <span class="o">=</span> <span class="n">to_ap_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_scan_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ap_qid_t</span> <span class="n">qid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">queue_depth</span><span class="p">,</span> <span class="n">device_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">device_functions</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap_select_domain</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AP_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qid</span> <span class="o">=</span> <span class="n">AP_MKQID</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ap_domain_index</span><span class="p">);</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">bus_find_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_bus_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">qid</span><span class="p">,</span>
				      <span class="n">__ap_scan_bus</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ap_query_queue</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue_depth</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
				<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">AP_RESET_TIMEOUT</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">ap_query_queue</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue_depth</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">device_type</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ap_dev</span> <span class="o">=</span> <span class="n">to_ap_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">unregistered</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">unregistered</span><span class="p">)</span>
					<span class="n">i</span><span class="o">--</span><span class="p">;</span>
				<span class="n">device_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ap_init_queue</span><span class="p">(</span><span class="n">qid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ap_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ap_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap_dev</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">qid</span> <span class="o">=</span> <span class="n">qid</span><span class="p">;</span>
		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_depth</span> <span class="o">=</span> <span class="n">queue_depth</span><span class="p">;</span>
		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">unregistered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">pendingq</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">requestq</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">ap_request_timeout</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ap_dev</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">device_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ap_probe_device_type</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">10</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ap_query_functions</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_functions</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_ap_facility</span><span class="p">(</span><span class="n">device_functions</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
				<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">AP_DEVICE_TYPE_CEX3C</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_ap_facility</span><span class="p">(</span><span class="n">device_functions</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
				<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">AP_DEVICE_TYPE_CEX3A</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">device_type</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap_bus_type</span><span class="p">;</span>
		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">ap_root_device</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;card%02x&quot;</span><span class="p">,</span>
				 <span class="n">AP_QID_DEVICE</span><span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">ap_device_release</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Add device attributes. */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ap_dev_attr_group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">unregistered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ap_config_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">ap_work_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_config_work</span><span class="p">);</span>
	<span class="n">ap_config_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ap_config_time</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_config_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __ap_schedule_poll_timer(): Schedule poll timer.</span>
<span class="cm"> *</span>
<span class="cm"> * Set up the timer to run the poll tasklet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__ap_schedule_poll_timer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ktime_t</span> <span class="n">hr_time</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_timer_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hrtimer_is_queued</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_timer</span><span class="p">)</span> <span class="o">||</span> <span class="n">ap_suspend_flag</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">hrtimer_expires_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_timer</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hr_time</span> <span class="o">=</span> <span class="n">ktime_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">poll_timeout</span><span class="p">);</span>
		<span class="n">hrtimer_forward_now</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_timer</span><span class="p">,</span> <span class="n">hr_time</span><span class="p">);</span>
		<span class="n">hrtimer_restart</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_timer</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_timer_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_schedule_poll_timer(): Schedule poll timer.</span>
<span class="cm"> *</span>
<span class="cm"> * Set up the timer to run the poll tasklet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ap_schedule_poll_timer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap_using_interrupts</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">__ap_schedule_poll_timer</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_poll_read(): Receive pending reply messages from an AP device.</span>
<span class="cm"> * @ap_dev: pointer to the AP device</span>
<span class="cm"> * @flags: pointer to control flags, bit 2^0 is set if another poll is</span>
<span class="cm"> *	   required, bit 2^1 is set if the poll timer needs to get armed</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if the device is still present, -ENODEV if not.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_poll_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_queue_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ap_message</span> <span class="o">*</span><span class="n">ap_msg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">__ap_recv</span><span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">psmid</span><span class="p">,</span>
			   <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">,</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">response_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AP_RESPONSE_NORMAL</span>:
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_requests</span><span class="p">);</span>
		<span class="n">ap_decrease_queue_count</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ap_msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">pendingq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">psmid</span> <span class="o">!=</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">psmid</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">pendingq_count</span><span class="o">--</span><span class="p">;</span>
			<span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">receive</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">,</span> <span class="n">ap_msg</span><span class="p">,</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AP_RESPONSE_NO_PENDING_REPLY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">queue_empty</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The card shouldn&#39;t forget requests but who knows. */</span>
			<span class="n">atomic_sub</span><span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_poll_requests</span><span class="p">);</span>
			<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">pendingq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">requestq</span><span class="p">);</span>
			<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">requestq_count</span> <span class="o">+=</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">pendingq_count</span><span class="p">;</span>
			<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">pendingq_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_poll_write(): Send messages from the request queue to an AP device.</span>
<span class="cm"> * @ap_dev: pointer to the AP device</span>
<span class="cm"> * @flags: pointer to control flags, bit 2^0 is set if another poll is</span>
<span class="cm"> *	   required, bit 2^1 is set if the poll timer needs to get armed</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if the device is still present, -ENODEV if not.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_poll_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_queue_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ap_message</span> <span class="o">*</span><span class="n">ap_msg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">requestq_count</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_count</span> <span class="o">&gt;=</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Start the next request on the queue. */</span>
	<span class="n">ap_msg</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">requestq</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ap_message</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">__ap_send</span><span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">,</span> <span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">psmid</span><span class="p">,</span>
			   <span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">,</span> <span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">special</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">response_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AP_RESPONSE_NORMAL</span>:
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_requests</span><span class="p">);</span>
		<span class="n">ap_increase_queue_count</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">);</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">pendingq</span><span class="p">);</span>
		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">requestq_count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">pendingq_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_count</span> <span class="o">&lt;</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_depth</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">requestq_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AP_RESPONSE_RESET_IN_PROGRESS</span>:
		<span class="n">__ap_schedule_poll_timer</span><span class="p">();</span>
	<span class="k">case</span> <span class="n">AP_RESPONSE_Q_FULL</span>:
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AP_RESPONSE_MESSAGE_TOO_BIG</span>:
	<span class="k">case</span> <span class="n">AP_RESPONSE_REQ_FAC_NOT_INST</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_poll_queue(): Poll AP device for pending replies and send new messages.</span>
<span class="cm"> * @ap_dev: pointer to the bus device</span>
<span class="cm"> * @flags: pointer to control flags, bit 2^0 is set if another poll is</span>
<span class="cm"> *	   required, bit 2^1 is set if the poll timer needs to get armed</span>
<span class="cm"> *</span>
<span class="cm"> * Poll AP device for pending replies and send new messages. If either</span>
<span class="cm"> * ap_poll_read or ap_poll_write returns -ENODEV unregister the device.</span>
<span class="cm"> * Returns 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ap_poll_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ap_poll_read</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ap_poll_write</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __ap_queue_message(): Queue a message to a device.</span>
<span class="cm"> * @ap_dev: pointer to the AP device</span>
<span class="cm"> * @ap_msg: the message to be queued</span>
<span class="cm"> *</span>
<span class="cm"> * Queue a message to a device. Returns 0 if successful.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ap_queue_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ap_message</span> <span class="o">*</span><span class="n">ap_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_queue_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">requestq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_count</span> <span class="o">&lt;</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">__ap_send</span><span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">,</span> <span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">psmid</span><span class="p">,</span>
				   <span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">,</span> <span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
				   <span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">special</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">response_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_NORMAL</span>:
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">pendingq</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_requests</span><span class="p">);</span>
			<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">pendingq_count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ap_increase_queue_count</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">);</span>
			<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">total_request_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_Q_FULL</span>:
		<span class="k">case</span> <span class="n">AP_RESPONSE_RESET_IN_PROGRESS</span>:
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">requestq</span><span class="p">);</span>
			<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">requestq_count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">total_request_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RESPONSE_REQ_FAC_NOT_INST</span>:
		<span class="k">case</span> <span class="n">AP_RESPONSE_MESSAGE_TOO_BIG</span>:
			<span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">receive</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">,</span> <span class="n">ap_msg</span><span class="p">,</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="cm">/* Device is gone. */</span>
			<span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">receive</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">,</span> <span class="n">ap_msg</span><span class="p">,</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">requestq</span><span class="p">);</span>
		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">requestq_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">total_request_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ap_schedule_poll_timer</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ap_queue_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ap_message</span> <span class="o">*</span><span class="n">ap_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* For asynchronous message handling a valid receive-callback</span>
<span class="cm">	 * is required. */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">receive</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">unregistered</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Make room on the queue by polling for finished requests. */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ap_poll_queue</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">__ap_queue_message</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">,</span> <span class="n">ap_msg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_wait</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">unregistered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">receive</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">,</span> <span class="n">ap_msg</span><span class="p">,</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ap_queue_message</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ap_cancel_message(): Cancel a crypto request.</span>
<span class="cm"> * @ap_dev: The AP device that has the message queued</span>
<span class="cm"> * @ap_msg: The message that is to be removed</span>
<span class="cm"> *</span>
<span class="cm"> * Cancel a crypto request. This is done by removing the request</span>
<span class="cm"> * from the device pending or request queue. Note that the</span>
<span class="cm"> * request stays on the AP queue. When it finishes the message</span>
<span class="cm"> * reply will be discarded because the psmid can&#39;t be found.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ap_cancel_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ap_message</span> <span class="o">*</span><span class="n">ap_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_message</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">pendingq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">psmid</span> <span class="o">==</span> <span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">psmid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">pendingq_count</span><span class="o">--</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">requestq_count</span><span class="o">--</span><span class="p">;</span>
	<span class="nl">found:</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_msg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ap_cancel_message</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ap_poll_timeout(): AP receive polling for finished AP requests.</span>
<span class="cm"> * @unused: Unused pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Schedules the AP tasklet using a high resolution timer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">hrtimer_restart</span> <span class="nf">ap_poll_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">hrtimer</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_tasklet</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">HRTIMER_NORESTART</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_reset(): Reset a not responding AP device.</span>
<span class="cm"> * @ap_dev: Pointer to the AP device</span>
<span class="cm"> *</span>
<span class="cm"> * Reset a not responding AP device and move all requests from the</span>
<span class="cm"> * pending queue to the request queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">AP_RESET_IGNORE</span><span class="p">;</span>
	<span class="n">atomic_sub</span><span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_poll_requests</span><span class="p">);</span>
	<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">queue_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">pendingq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">requestq</span><span class="p">);</span>
	<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">requestq_count</span> <span class="o">+=</span> <span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">pendingq_count</span><span class="p">;</span>
	<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">pendingq_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ap_init_queue</span><span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">unregistered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">__ap_schedule_poll_timer</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ap_poll_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">unregistered</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap_poll_queue</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">,</span> <span class="n">flags</span><span class="p">))</span>
			<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">unregistered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">==</span> <span class="n">AP_RESET_DO</span><span class="p">)</span>
			<span class="n">ap_reset</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_poll_all(): Poll all AP devices.</span>
<span class="cm"> * @dummy: Unused variable</span>
<span class="cm"> *</span>
<span class="cm"> * Poll all AP devices on the bus in a round robin fashion. Continue</span>
<span class="cm"> * polling until bit 2^0 of the control flags is not set. If bit 2^1</span>
<span class="cm"> * of the control flags has been set arm the poll timer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_poll_all</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">;</span>

	<span class="cm">/* Reset the indicator if interrupts are used. Thus new interrupts can</span>
<span class="cm">	 * be received. Doing it in the beginning of the tasklet is therefor</span>
<span class="cm">	 * important that no requests on any AP get lost.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap_using_interrupts</span><span class="p">())</span>
		<span class="n">xchg</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ap_interrupt_indicator</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_device_list_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_device_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">__ap_poll_device</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_device_list_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">ap_schedule_poll_timer</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_poll_thread(): Thread that polls for finished requests.</span>
<span class="cm"> * @data: Unused pointer</span>
<span class="cm"> *</span>
<span class="cm"> * AP bus poll thread. The purpose of this thread is to poll for</span>
<span class="cm"> * finished requests in a loop if there is a &quot;free&quot; cpu - that is</span>
<span class="cm"> * a cpu that doesn&#39;t have anything better to do. The polling stops</span>
<span class="cm"> * as soon as there is another task or if all messages have been</span>
<span class="cm"> * delivered.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_poll_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">requests</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span><span class="p">;</span>

	<span class="n">set_user_nice</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap_suspend_flag</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">need_resched</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">schedule</span><span class="p">();</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">requests</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_requests</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">requests</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">schedule</span><span class="p">();</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
		<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_device_list_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_device_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">__ap_poll_device</span><span class="p">(</span><span class="n">ap_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_device_list_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_poll_thread_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap_using_interrupts</span><span class="p">()</span> <span class="o">||</span> <span class="n">ap_suspend_flag</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_thread_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap_poll_kthread</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap_poll_kthread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">ap_poll_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;appoll&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">ap_poll_kthread</span><span class="p">)</span> <span class="o">?</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ap_poll_kthread</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">ap_poll_kthread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_thread_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_poll_thread_stop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_thread_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap_poll_kthread</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">ap_poll_kthread</span><span class="p">);</span>
		<span class="n">ap_poll_kthread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_thread_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_request_timeout(): Handling of request timeouts</span>
<span class="cm"> * @data: Holds the AP device.</span>
<span class="cm"> *</span>
<span class="cm"> * Handles request timeouts.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_request_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="n">ap_dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ap_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">==</span> <span class="n">AP_RESET_ARMED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap_dev</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">AP_RESET_DO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ap_using_interrupts</span><span class="p">())</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_tasklet</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_reset_domain</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap_domain_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AP_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ap_reset_queue</span><span class="p">(</span><span class="n">AP_MKQID</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ap_domain_index</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_reset_all</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AP_DOMAINS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">AP_DEVICES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ap_reset_queue</span><span class="p">(</span><span class="n">AP_MKQID</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">reset_call</span> <span class="n">ap_reset_call</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">ap_reset_all</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ap_module_init(): The module initialization code.</span>
<span class="cm"> *</span>
<span class="cm"> * Initializes the module.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">ap_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap_domain_index</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">ap_domain_index</span> <span class="o">&gt;=</span> <span class="n">AP_DOMAINS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%d is not a valid cryptographic domain</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ap_domain_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* In resume callback we need to know if the user had set the domain.</span>
<span class="cm">	 * If so, we can not just reset it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap_domain_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">user_set_domain</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap_instructions_available</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;The hardware system does not support &quot;</span>
			   <span class="s">&quot;AP instructions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap_interrupts_available</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">isc_register</span><span class="p">(</span><span class="n">AP_ISC</span><span class="p">);</span>
		<span class="n">ap_interrupt_indicator</span> <span class="o">=</span> <span class="n">s390_register_adapter_interrupt</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">ap_interrupt_handler</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">AP_ISC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ap_interrupt_indicator</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ap_interrupt_indicator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">isc_unregister</span><span class="p">(</span><span class="n">AP_ISC</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">register_reset_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_reset_call</span><span class="p">);</span>

	<span class="cm">/* Create /sys/bus/ap. */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bus_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_bus_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ap_bus_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bus_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_bus_type</span><span class="p">,</span> <span class="n">ap_bus_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_bus</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create /sys/devices/ap. */</span>
	<span class="n">ap_root_device</span> <span class="o">=</span> <span class="n">root_device_register</span><span class="p">(</span><span class="s">&quot;ap&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">ap_root_device</span><span class="p">)</span> <span class="o">?</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ap_root_device</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_bus</span><span class="p">;</span>

	<span class="n">ap_work_queue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;kapwork&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap_work_queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_root</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap_select_domain</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ap_scan_bus</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Setup the AP bus rescan timer. */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_config_timer</span><span class="p">);</span>
	<span class="n">ap_config_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">ap_config_timeout</span><span class="p">;</span>
	<span class="n">ap_config_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ap_config_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ap_config_time</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_config_timer</span><span class="p">);</span>

	<span class="cm">/* Setup the high resultion poll timer.</span>
<span class="cm">	 * If we are running under z/VM adjust polling to z/VM polling rate.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_IS_VM</span><span class="p">)</span>
		<span class="n">poll_timeout</span> <span class="o">=</span> <span class="mi">1500000</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_timer_lock</span><span class="p">);</span>
	<span class="n">hrtimer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_timer</span><span class="p">,</span> <span class="n">CLOCK_MONOTONIC</span><span class="p">,</span> <span class="n">HRTIMER_MODE_ABS</span><span class="p">);</span>
	<span class="n">ap_poll_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">ap_poll_timeout</span><span class="p">;</span>

	<span class="cm">/* Start the low priority AP bus poll thread. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap_thread_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ap_poll_thread_start</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_work</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_work:</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_config_timer</span><span class="p">);</span>
	<span class="n">hrtimer_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_timer</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">ap_work_queue</span><span class="p">);</span>
<span class="nl">out_root:</span>
	<span class="n">root_device_unregister</span><span class="p">(</span><span class="n">ap_root_device</span><span class="p">);</span>
<span class="nl">out_bus:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">bus_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_bus_type</span><span class="p">,</span> <span class="n">ap_bus_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_bus_type</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">unregister_reset_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_reset_call</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap_using_interrupts</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">s390_unregister_adapter_interrupt</span><span class="p">(</span><span class="n">ap_interrupt_indicator</span><span class="p">,</span> <span class="n">AP_ISC</span><span class="p">);</span>
		<span class="n">isc_unregister</span><span class="p">(</span><span class="n">AP_ISC</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ap_match_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ap_modules_exit(): The module termination code</span>
<span class="cm"> *</span>
<span class="cm"> * Terminates the module.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ap_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">ap_reset_domain</span><span class="p">();</span>
	<span class="n">ap_poll_thread_stop</span><span class="p">();</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_config_timer</span><span class="p">);</span>
	<span class="n">hrtimer_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_poll_timer</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">ap_work_queue</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_tasklet</span><span class="p">);</span>
	<span class="n">root_device_unregister</span><span class="p">(</span><span class="n">ap_root_device</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">dev</span> <span class="o">=</span> <span class="n">bus_find_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_bus_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		    <span class="n">__ap_match_all</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ap_bus_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">bus_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_bus_type</span><span class="p">,</span> <span class="n">ap_bus_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_bus_type</span><span class="p">);</span>
	<span class="n">unregister_reset_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_reset_call</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap_using_interrupts</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">s390_unregister_adapter_interrupt</span><span class="p">(</span><span class="n">ap_interrupt_indicator</span><span class="p">,</span> <span class="n">AP_ISC</span><span class="p">);</span>
		<span class="n">isc_unregister</span><span class="p">(</span><span class="n">AP_ISC</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ap_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ap_module_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
