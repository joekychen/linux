<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › char › tape_34xx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tape_34xx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  drivers/s390/char/tape_34xx.c</span>
<span class="cm"> *    tape device discipline for 3480/3490 tapes.</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright IBM Corp. 2001, 2009</span>
<span class="cm"> *    Author(s): Carsten Otte &lt;cotte@de.ibm.com&gt;</span>
<span class="cm"> *		 Tuan Ngo-Anh &lt;ngoanh@de.ibm.com&gt;</span>
<span class="cm"> *		 Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;tape_34xx&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bio.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#define TAPE_DBF_AREA	tape_34xx_dbf</span>

<span class="cp">#include &quot;tape.h&quot;</span>
<span class="cp">#include &quot;tape_std.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Pointer to debug area.</span>
<span class="cm"> */</span>
<span class="n">debug_info_t</span> <span class="o">*</span><span class="n">TAPE_DBF_AREA</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">TAPE_DBF_AREA</span><span class="p">);</span>

<span class="cp">#define TAPE34XX_FMT_3480	0</span>
<span class="cp">#define TAPE34XX_FMT_3480_2_XF	1</span>
<span class="cp">#define TAPE34XX_FMT_3480_XF	2</span>

<span class="k">struct</span> <span class="n">tape_34xx_block_id</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">wrap</span>		<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">segment</span>		<span class="o">:</span> <span class="mi">7</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">format</span>		<span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">block</span>		<span class="o">:</span> <span class="mi">22</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * A list of block ID&#39;s is used to faster seek blocks.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">tape_34xx_sbid</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tape_34xx_block_id</span>	<span class="n">bid</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">tape_34xx_delete_sbid_from</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Medium sense for 34xx tapes. There is no &#39;real&#39; medium sense call.</span>
<span class="cm"> * So we just do a normal sense.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__tape_34xx_medium_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sense</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * This isn&#39;t quite correct. But since INTERVENTION_REQUIRED</span>
<span class="cm">		 * means that the drive is &#39;neither ready nor on-line&#39; it is</span>
<span class="cm">		 * only slightly inaccurate to say there is no tape loaded if</span>
<span class="cm">		 * the drive isn&#39;t online...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SENSE_INTERVENTION_REQUIRED</span><span class="p">)</span>
			<span class="n">tape_med_state_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MS_UNLOADED</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tape_med_state_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MS_LOADED</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SENSE_WRITE_PROTECT</span><span class="p">)</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">tape_generic_status</span> <span class="o">|=</span> <span class="n">GMT_WR_PROT</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">tape_generic_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GMT_WR_PROT</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;tape_34xx: medium sense failed with rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
	<span class="n">tape_free_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tape_34xx_medium_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBF_EXCEPTION</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;MSEN fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_MSEN</span><span class="p">;</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">SENSE</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_do_io_interruptible</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="n">__tape_34xx_medium_sense</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tape_34xx_medium_sense_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBF_EXCEPTION</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;MSEN fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_MSEN</span><span class="p">;</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">SENSE</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">__tape_34xx_medium_sense</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">callback_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tape_do_io_async</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">tape_34xx_work</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_device</span>	<span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">tape_op</span>		 <span class="n">op</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	 <span class="n">work</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * These functions are currently used only to schedule a medium_sense for</span>
<span class="cm"> * later execution. This is because we get an interrupt whenever a medium</span>
<span class="cm"> * is inserted but cannot call tape_do_io* from an interrupt context.</span>
<span class="cm"> * Maybe that&#39;s useful for other actions we want to start from the</span>
<span class="cm"> * interrupt handler.</span>
<span class="cm"> * Note: the work handler is called by the system work queue. The tape</span>
<span class="cm"> * commands started by the handler need to be asynchrounous, otherwise</span>
<span class="cm"> * a deadlock can occur e.g. in case of a deferred cc=1 (see __tape_do_irq).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tape_34xx_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_34xx_work</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_34xx_work</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TO_MSEN</span>:
			<span class="n">tape_34xx_medium_sense_async</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;T34XX: internal error: unknown work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tape_put_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_34xx_schedule_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">enum</span> <span class="n">tape_op</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_34xx_work</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">tape_34xx_work_handler</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">tape_get_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">op</span>     <span class="o">=</span> <span class="n">op</span><span class="p">;</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Done Handler is called when dev stat = DEVICE-END (successful operation)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">tape_34xx_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;%s done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tape_op_verbose</span><span class="p">[</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">]);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TO_DSE</span>:
		<span class="k">case</span> <span class="n">TO_RUN</span>:
		<span class="k">case</span> <span class="n">TO_WRI</span>:
		<span class="k">case</span> <span class="n">TO_WTM</span>:
		<span class="k">case</span> <span class="n">TO_ASSIGN</span>:
		<span class="k">case</span> <span class="n">TO_UNASSIGN</span>:
			<span class="n">tape_34xx_delete_sbid_from</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">TAPE_IO_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">tape_34xx_erp_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;Error recovery failed for %s (RC=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">tape_op_verbose</span><span class="p">[</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">],</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">tape_34xx_erp_succeeded</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;Error Recovery successful for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">tape_op_verbose</span><span class="p">[</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">tape_34xx_done</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">tape_34xx_erp_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;xerp retr %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tape_op_verbose</span><span class="p">[</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">TAPE_IO_RETRY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is called, when no request is outstanding and we get an</span>
<span class="cm"> * interrupt</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_34xx_unsolicited_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">==</span> <span class="mh">0x85</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* READY */</span>
		<span class="cm">/* A medium was inserted in the drive. */</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;xuud med</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tape_34xx_delete_sbid_from</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tape_34xx_schedule_work</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">TO_MSEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;unsol.irq! dev end: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
		<span class="n">tape_dump_sense_dbf</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">TAPE_IO_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read Opposite Error Recovery Function:</span>
<span class="cm"> * Used, when Read Forward does not work</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_34xx_erp_read_opposite</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">TO_RFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We did read forward, but the data could not be read</span>
<span class="cm">		 * *correctly*. We transform the request to a read backward</span>
<span class="cm">		 * and try again.</span>
<span class="cm">		 */</span>
		<span class="n">tape_std_read_backward</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_retry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We tried to read forward and backward, but hat no</span>
<span class="cm">	 * success -&gt; failed.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_34xx_erp_bug</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">!=</span> <span class="n">TO_ASSIGN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;An unexpected condition %d &quot;</span>
			<span class="s">&quot;occurred in tape error recovery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">no</span><span class="p">);</span>
		<span class="n">tape_dump_sense_dbf</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle data overrun between cu and drive. The channel speed might</span>
<span class="cm"> * be too slow.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_34xx_erp_overrun</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A data overrun occurred between&quot;</span>
			<span class="s">&quot; the control unit and tape unit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tape_34xx_erp_bug</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle record sequence error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_34xx_erp_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x41</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * cu detected incorrect block-id sequence on tape.</span>
<span class="cm">		 */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The block ID sequence on the &quot;</span>
			<span class="s">&quot;tape is incorrect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Record sequence error bit is set, but erpa does not</span>
<span class="cm">	 * show record sequence error.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">tape_34xx_erp_bug</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function analyses the tape&#39;s sense-data in case of a unit-check.</span>
<span class="cm"> * If possible, it tries to recover from the error. Else the user is</span>
<span class="cm"> * informed about the problem.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_34xx_unit_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">inhibit_cu_recovery</span><span class="p">;</span>
	<span class="n">__u8</span><span class="o">*</span> <span class="n">sense</span><span class="p">;</span>

	<span class="n">inhibit_cu_recovery</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sense</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span>
		<span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SENSE_COMMAND_REJECT</span> <span class="o">&amp;&amp;</span>
		<span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SENSE_WRITE_PROTECT</span>
	<span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span>
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">TO_DSE</span> <span class="o">||</span>
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">TO_WRI</span> <span class="o">||</span>
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">TO_WTM</span>
		<span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* medium is write protected */</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_bug</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Special cases for various tape-states when reaching</span>
<span class="cm">	 * end of recorded area</span>
<span class="cm">	 *</span>
<span class="cm">	 * FIXME: Maybe a special case of the special case:</span>
<span class="cm">	 *        sense[0] == SENSE_EQUIPMENT_CHECK &amp;&amp;</span>
<span class="cm">	 *        sense[1] == SENSE_DRIVE_ONLINE    &amp;&amp;</span>
<span class="cm">	 *        sense[3] == 0x47 (Volume Fenced)</span>
<span class="cm">	 *</span>
<span class="cm">	 *        This was caused by continued FSF or FSR after an</span>
<span class="cm">	 *        &#39;End Of Data&#39;.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span>
		<span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SENSE_DATA_CHECK</span>      <span class="o">||</span>
		<span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SENSE_EQUIPMENT_CHECK</span> <span class="o">||</span>
		<span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SENSE_EQUIPMENT_CHECK</span> <span class="o">+</span> <span class="n">SENSE_DEFERRED_UNIT_CHECK</span>
	<span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
		<span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">SENSE_DRIVE_ONLINE</span> <span class="o">||</span>
		<span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">SENSE_BEGINNING_OF_TAPE</span> <span class="o">+</span> <span class="n">SENSE_WRITE_MODE</span>
	<span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * sense[0] == SENSE_DATA_CHECK   &amp;&amp;</span>
<span class="cm">		 * sense[1] == SENSE_DRIVE_ONLINE</span>
<span class="cm">		 * sense[3] == 0x36 (End Of Data)</span>
<span class="cm">		 *</span>
<span class="cm">		 * Further seeks might return a &#39;Volume Fenced&#39;.</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">TO_FSF</span>:
		<span class="k">case</span> <span class="n">TO_FSB</span>:
			<span class="cm">/* Trying to seek beyond end of recorded area */</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">TO_BSB</span>:
			<span class="k">return</span> <span class="n">tape_34xx_erp_retry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * sense[0] == SENSE_DATA_CHECK   &amp;&amp;</span>
<span class="cm">		 * sense[1] == SENSE_DRIVE_ONLINE &amp;&amp;</span>
<span class="cm">		 * sense[3] == 0x36 (End Of Data)</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">TO_LBL</span>:
			<span class="cm">/* Block could not be located. */</span>
			<span class="n">tape_34xx_delete_sbid_from</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">TO_RFO</span>:
			<span class="cm">/* Read beyond end of recorded area -&gt; 0 bytes read */</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * sense[0] == SENSE_EQUIPMENT_CHECK &amp;&amp;</span>
<span class="cm">		 * sense[1] == SENSE_DRIVE_ONLINE    &amp;&amp;</span>
<span class="cm">		 * sense[3] == 0x38 (Physical End Of Volume)</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">TO_WRI</span>:
			<span class="cm">/* Writing at physical end of volume */</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Sensing special bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SENSE_BUS_OUT_CHECK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_retry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SENSE_DATA_CHECK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * hardware failure, damaged tape or improper</span>
<span class="cm">		 * operating conditions</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x23</span>:
			<span class="cm">/* a read data check occurred */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SENSE_TAPE_SYNC_MODE</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">inhibit_cu_recovery</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>data check is not permanent, may be
recovered. We always use async-mode with
cu-recovery, so this should <em>never</em> happen.</p></td><td class="code"><div class="highlight"><pre>				<span class="k">return</span> <span class="n">tape_34xx_erp_bug</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span>
							 <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">);</span>

			<span class="cm">/* data check is permanent, CU recovery has failed */</span>
			<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A read error occurred &quot;</span>
				<span class="s">&quot;that cannot be recovered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">case</span> <span class="mh">0x25</span>:</pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>a write data check occurred</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">((</span><span class="n">sense</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SENSE_TAPE_SYNC_MODE</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">inhibit_cu_recovery</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>data check is not permanent, may be
recovered. We always use async-mode with
cu-recovery, so this should <em>never</em> happen.</p></td><td class="code"><div class="highlight"><pre>				<span class="k">return</span> <span class="n">tape_34xx_erp_bug</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span>
							 <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>data check is permanent, cu-recovery has failed</p></td><td class="code"><div class="highlight"><pre>			<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A write error on the &quot;</span>
				<span class="s">&quot;tape cannot be recovered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">case</span> <span class="mh">0x26</span>:
			<span class="cm">/* Data Check (read opposite) occurred. */</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_read_opposite</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
		<span class="k">case</span> <span class="mh">0x28</span>:
			<span class="cm">/* ID-Mark at tape start couldn&#39;t be written */</span>
			<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Writing the ID-mark &quot;</span>
				<span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">case</span> <span class="mh">0x31</span>:
			<span class="cm">/* Tape void. Tried to read beyond end of device. */</span>
			<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Reading the tape beyond&quot;</span>
				<span class="s">&quot; the end of the recorded area failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
		<span class="k">case</span> <span class="mh">0x41</span>:
			<span class="cm">/* Record sequence error. */</span>
			<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape contains an &quot;</span>
				<span class="s">&quot;incorrect block ID sequence</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="nl">default:</span>
			<span class="cm">/* all data checks for 3480 should result in one of</span>
<span class="cm">			 * the above erpa-codes. For 3490, other data-check</span>
<span class="cm">			 * conditions do exist. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">driver_info</span> <span class="o">==</span> <span class="n">tape_3480</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">tape_34xx_erp_bug</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span>
							 <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SENSE_OVERRUN</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_overrun</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SENSE_RECORD_SEQUENCE_ERR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_sequence</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>

	<span class="cm">/* Sensing erpa codes */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>:
		<span class="cm">/* Unit check with erpa code 0. Report and ignore. */</span>
		<span class="k">return</span> <span class="n">TAPE_IO_SUCCESS</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x21</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Data streaming not operational. CU will switch to</span>
<span class="cm">		 * interlock mode. Reissue the command.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_retry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x22</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Path equipment check. Might be drive adapter error, buffer</span>
<span class="cm">		 * error on the lower interface, internal path not usable,</span>
<span class="cm">		 * or error during cartridge load.</span>
<span class="cm">		 */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A path equipment check occurred&quot;</span>
			<span class="s">&quot; for the tape device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x24</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Load display check. Load display was command was issued,</span>
<span class="cm">		 * but the drive is displaying a drive check message. Can</span>
<span class="cm">		 * be threated as &quot;device end&quot;.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_succeeded</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x27</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Command reject. May indicate illegal channel program or</span>
<span class="cm">		 * buffer over/underrun. Since all channel programs are</span>
<span class="cm">		 * issued by this driver and ought be correct, we assume a</span>
<span class="cm">		 * over/underrun situation and retry the channel program.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_retry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x29</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Function incompatible. Either the tape is idrc compressed</span>
<span class="cm">		 * but the hardware isn&#39;t capable to do idrc, or a perform</span>
<span class="cm">		 * subsystem func is issued and the CU is not on-line.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x2a</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Unsolicited environmental data. An internal counter</span>
<span class="cm">		 * overflows, we can ignore this and reissue the cmd.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_retry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x2b</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Environmental data present. Indicates either unload</span>
<span class="cm">		 * completed ok or read buffered log command completed ok.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">TO_RUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Rewind unload completed ok. */</span>
			<span class="n">tape_med_state_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MS_UNLOADED</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_succeeded</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* tape_34xx doesn&#39;t use read buffered log commands. */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_bug</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="k">case</span> <span class="mh">0x2c</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Permanent equipment check. CU has tried recovery, but</span>
<span class="cm">		 * did not succeed.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x2d</span>:
		<span class="cm">/* Data security erase failure. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">TO_DSE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="cm">/* Data security erase failure, but no such command issued. */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_bug</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="k">case</span> <span class="mh">0x2e</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Not capable. This indicates either that the drive fails</span>
<span class="cm">		 * reading the format id mark or that that format specified</span>
<span class="cm">		 * is not supported by the drive.</span>
<span class="cm">		 */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape unit cannot process &quot;</span>
			<span class="s">&quot;the tape format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EMEDIUMTYPE</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x30</span>:
		<span class="cm">/* The medium is write protected. */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape medium is write-&quot;</span>
			<span class="s">&quot;protected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x32</span>:</pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Tension loss. We cannot recover this, it's an I/O error.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape does not have the &quot;</span>
			<span class="s">&quot;required tape tension</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x33</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Load Failure. The cartridge was not inserted correctly or</span>
<span class="cm">		 * the tape is not threaded correctly.</span>
<span class="cm">		 */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape unit failed to load&quot;</span>
			<span class="s">&quot; the cartridge</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tape_34xx_delete_sbid_from</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x34</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Unload failure. The drive cannot maintain tape tension</span>
<span class="cm">		 * and control tape movement during an unload operation.</span>
<span class="cm">		 */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Automatic unloading of the tape&quot;</span>
			<span class="s">&quot; cartridge failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">TO_RUN</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_bug</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="k">case</span> <span class="mh">0x35</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Drive equipment check. One of the following:</span>
<span class="cm">		 * - cu cannot recover from a drive detected error</span>
<span class="cm">		 * - a check code message is shown on drive display</span>
<span class="cm">		 * - the cartridge loader does not respond correctly</span>
<span class="cm">		 * - a failure occurs during an index, load, or unload cycle</span>
<span class="cm">		 */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;An equipment check has occurred&quot;</span>
			<span class="s">&quot; on the tape unit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x36</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">driver_info</span> <span class="o">==</span> <span class="n">tape_3490</span><span class="p">)</span>
			<span class="cm">/* End of data. */</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="cm">/* This erpa is reserved for 3480 */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_bug</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="k">case</span> <span class="mh">0x37</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Tape length error. The tape is shorter than reported in</span>
<span class="cm">		 * the beginning-of-tape data.</span>
<span class="cm">		 */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape information states an&quot;</span>
			<span class="s">&quot; incorrect length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x38</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Physical end of tape. A read/write operation reached</span>
<span class="cm">		 * the physical end of tape.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">==</span><span class="n">TO_WRI</span> <span class="o">||</span>
		    <span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">==</span><span class="n">TO_DSE</span> <span class="o">||</span>
		    <span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">==</span><span class="n">TO_WTM</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x39</span>:
		<span class="cm">/* Backward at Beginning of tape. */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x3a</span>:
		<span class="cm">/* Drive switched to not ready. */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape unit is not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x3b</span>:
		<span class="cm">/* Manual rewind or unload. This causes an I/O error. */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape medium has been &quot;</span>
			<span class="s">&quot;rewound or unloaded manually</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tape_34xx_delete_sbid_from</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x42</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Degraded mode. A condition that can cause degraded</span>
<span class="cm">		 * performance is detected.</span>
<span class="cm">		 */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape subsystem is running &quot;</span>
			<span class="s">&quot;in degraded mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_retry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x43</span>:
		<span class="cm">/* Drive not ready. */</span>
		<span class="n">tape_34xx_delete_sbid_from</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tape_med_state_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MS_UNLOADED</span><span class="p">);</span>
		<span class="cm">/* Some commands commands are successful even in this case */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SENSE_DRIVE_ONLINE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">TO_ASSIGN</span>:
				<span class="k">case</span> <span class="n">TO_UNASSIGN</span>:
				<span class="k">case</span> <span class="n">TO_DIS</span>:
				<span class="k">case</span> <span class="n">TO_NOP</span>:
					<span class="k">return</span> <span class="n">tape_34xx_done</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x44</span>:
		<span class="cm">/* Locate Block unsuccessful. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">!=</span> <span class="n">TO_BLOCK</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">!=</span> <span class="n">TO_LBL</span><span class="p">)</span>
			<span class="cm">/* No locate block was issued. */</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_bug</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span>
						 <span class="n">irb</span><span class="p">,</span> <span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x45</span>:
		<span class="cm">/* The drive is assigned to a different channel path. */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape unit is already &quot;</span>
			<span class="s">&quot;assigned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x46</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Drive not on-line. Drive may be switched offline,</span>
<span class="cm">		 * the power supply may be switched off or</span>
<span class="cm">		 * the drive address may not be set correctly.</span>
<span class="cm">		 */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape unit is not online</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x47</span>:
		<span class="cm">/* Volume fenced. CU reports volume integrity is lost. */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The control unit has fenced &quot;</span>
			<span class="s">&quot;access to the tape volume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tape_34xx_delete_sbid_from</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x48</span>:
		<span class="cm">/* Log sense data and retry request. */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_retry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x49</span>:
		<span class="cm">/* Bus out check. A parity check error on the bus was found. */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A parity error occurred on the &quot;</span>
			<span class="s">&quot;tape bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x4a</span>:
		<span class="cm">/* Control unit erp failed. */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;I/O error recovery failed on &quot;</span>
			<span class="s">&quot;the tape control unit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x4b</span>:
		<span class="cm">/*</span>
<span class="cm">		 * CU and drive incompatible. The drive requests micro-program</span>
<span class="cm">		 * patches, which are not available on the CU.</span>
<span class="cm">		 */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape unit requires a &quot;</span>
			<span class="s">&quot;firmware update</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x4c</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Recovered Check-One failure. Cu develops a hardware error,</span>
<span class="cm">		 * but is able to recover.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_retry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x4d</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">driver_info</span> <span class="o">==</span> <span class="n">tape_3490</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * Resetting event received. Since the driver does</span>
<span class="cm">			 * not support resetting event recovery (which has to</span>
<span class="cm">			 * be handled by the I/O Layer), retry our command.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_retry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
		<span class="cm">/* This erpa is reserved for 3480. */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_bug</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="k">case</span> <span class="mh">0x4e</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">driver_info</span> <span class="o">==</span> <span class="n">tape_3490</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Maximum block size exceeded. This indicates, that</span>
<span class="cm">			 * the block to be written is larger than allowed for</span>
<span class="cm">			 * buffered mode.</span>
<span class="cm">			 */</span>
			<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The maximum block size&quot;</span>
				<span class="s">&quot; for buffered mode is exceeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* This erpa is reserved for 3480. */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_bug</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="k">case</span> <span class="mh">0x50</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Read buffered log (Overflow). CU is running in extended</span>
<span class="cm">		 * buffered log mode, and a counter overflows. This should</span>
<span class="cm">		 * never happen, since we&#39;re never running in extended</span>
<span class="cm">		 * buffered log mode.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_retry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x51</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Read buffered log (EOV). EOF processing occurs while the</span>
<span class="cm">		 * CU is in extended buffered log mode. This should never</span>
<span class="cm">		 * happen, since we&#39;re never running in extended buffered</span>
<span class="cm">		 * log mode.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_retry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x52</span>:
		<span class="cm">/* End of Volume complete. Rewind unload completed ok. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">TO_RUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tape_med_state_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MS_UNLOADED</span><span class="p">);</span>
			<span class="n">tape_34xx_delete_sbid_from</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_succeeded</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_bug</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="k">case</span> <span class="mh">0x53</span>:
		<span class="cm">/* Global command intercept. */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_retry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x54</span>:
		<span class="cm">/* Channel interface recovery (temporary). */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_retry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x55</span>:
		<span class="cm">/* Channel interface recovery (permanent). */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A channel interface error cannot be&quot;</span>
			<span class="s">&quot; recovered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x56</span>:
		<span class="cm">/* Channel protocol error. */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A channel protocol error &quot;</span>
			<span class="s">&quot;occurred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x57</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">driver_info</span> <span class="o">==</span> <span class="n">tape_3480</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Attention intercept. */</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_retry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Global status intercept. */</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_retry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="mh">0x5a</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Tape length incompatible. The tape inserted is too long,</span>
<span class="cm">		 * which could cause damage to the tape or the drive.</span>
<span class="cm">		 */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape unit does not support &quot;</span>
			<span class="s">&quot;the tape length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x5b</span>:
		<span class="cm">/* Format 3480 XF incompatible */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SENSE_BEGINNING_OF_TAPE</span><span class="p">)</span>
			<span class="cm">/* The tape will get overwritten. */</span>
			<span class="k">return</span> <span class="n">tape_34xx_erp_retry</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape unit does not support&quot;</span>
			<span class="s">&quot; format 3480 XF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x5c</span>:
		<span class="cm">/* Format 3480-2 XF incompatible */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape unit does not support tape &quot;</span>
			<span class="s">&quot;format 3480-2 XF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x5d</span>:
		<span class="cm">/* Tape length violation. */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape unit does not support&quot;</span>
			<span class="s">&quot; the current tape length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EMEDIUMTYPE</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x5e</span>:
		<span class="cm">/* Compaction algorithm incompatible. */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape unit does not support&quot;</span>
			<span class="s">&quot; the compaction algorithm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">EMEDIUMTYPE</span><span class="p">);</span>

		<span class="cm">/* The following erpas should have been covered earlier. */</span>
	<span class="k">case</span> <span class="mh">0x23</span>: <span class="cm">/* Read data check. */</span>
	<span class="k">case</span> <span class="mh">0x25</span>: <span class="cm">/* Write data check. */</span>
	<span class="k">case</span> <span class="mh">0x26</span>: <span class="cm">/* Data check (read opposite). */</span>
	<span class="k">case</span> <span class="mh">0x28</span>: <span class="cm">/* Write id mark check. */</span>
	<span class="k">case</span> <span class="mh">0x31</span>: <span class="cm">/* Tape void. */</span>
	<span class="k">case</span> <span class="mh">0x40</span>: <span class="cm">/* Overrun error. */</span>
	<span class="k">case</span> <span class="mh">0x41</span>: <span class="cm">/* Record sequence error. */</span>
		<span class="cm">/* All other erpas are reserved for future use. */</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_bug</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="n">sense</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * 3480/3490 interrupt handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_34xx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tape_34xx_unsolicited_irq</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_EXCEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_DEV_END</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">TO_WRI</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Write at end of volume */</span>
		<span class="k">return</span> <span class="n">tape_34xx_erp_failed</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_CHECK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tape_34xx_unit_check</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_DEV_END</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * A unit exception occurs on skipping over a tapemark block.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_EXCEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">TO_BSB</span> <span class="o">||</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">TO_FSB</span><span class="p">)</span>
				<span class="n">request</span><span class="o">-&gt;</span><span class="n">rescnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Unit Exception!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">tape_34xx_done</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;xunknownirq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">tape_dump_sense_dbf</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TAPE_IO_STOP</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ioctl_overload</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_34xx_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">TAPE390_DISPLAY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">display_struct</span> <span class="n">disp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disp</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">disp</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">tape_std_display</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">tape_34xx_append_new_sbid</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_34xx_block_id</span> <span class="n">bid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">l</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_34xx_sbid</span> <span class="o">*</span>	<span class="n">new_sbid</span><span class="p">;</span>

	<span class="n">new_sbid</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_sbid</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_sbid</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">new_sbid</span><span class="o">-&gt;</span><span class="n">bid</span> <span class="o">=</span> <span class="n">bid</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_sbid</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Build up the search block ID list. The block ID consists of a logical</span>
<span class="cm"> * block number and a hardware specific part. The hardware specific part</span>
<span class="cm"> * helps the tape drive to speed up searching for a specific block.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tape_34xx_add_sbid</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_34xx_block_id</span> <span class="n">bid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span>	<span class="n">sbid_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tape_34xx_sbid</span> <span class="o">*</span>	<span class="n">sbid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span>	<span class="n">l</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * immediately return if there is no list at all or the block to add</span>
<span class="cm">	 * is located in segment 1 of wrap 0 because this position is used</span>
<span class="cm">	 * if no hardware position data is supplied.</span>
<span class="cm">	 */</span>
	<span class="n">sbid_list</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">discdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbid_list</span> <span class="o">||</span> <span class="p">(</span><span class="n">bid</span><span class="p">.</span><span class="n">segment</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">bid</span><span class="p">.</span><span class="n">wrap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Search the position where to insert the new entry. Hardware</span>
<span class="cm">	 * acceleration uses only the segment and wrap number. So we</span>
<span class="cm">	 * need only one entry for a specific wrap/segment combination.</span>
<span class="cm">	 * If there is a block with a lower number but the same hard-</span>
<span class="cm">	 * ware position data we just update the block number in the</span>
<span class="cm">	 * existing entry.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">sbid_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbid</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_34xx_sbid</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span>
			<span class="p">(</span><span class="n">sbid</span><span class="o">-&gt;</span><span class="n">bid</span><span class="p">.</span><span class="n">segment</span> <span class="o">==</span> <span class="n">bid</span><span class="p">.</span><span class="n">segment</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">sbid</span><span class="o">-&gt;</span><span class="n">bid</span><span class="p">.</span><span class="n">wrap</span>    <span class="o">==</span> <span class="n">bid</span><span class="p">.</span><span class="n">wrap</span><span class="p">)</span>
		<span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bid</span><span class="p">.</span><span class="n">block</span> <span class="o">&lt;</span> <span class="n">sbid</span><span class="o">-&gt;</span><span class="n">bid</span><span class="p">.</span><span class="n">block</span><span class="p">)</span>
				<span class="n">sbid</span><span class="o">-&gt;</span><span class="n">bid</span> <span class="o">=</span> <span class="n">bid</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">return</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Sort in according to logical block number. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bid</span><span class="p">.</span><span class="n">block</span> <span class="o">&lt;</span> <span class="n">sbid</span><span class="o">-&gt;</span><span class="n">bid</span><span class="p">.</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tape_34xx_append_new_sbid</span><span class="p">(</span><span class="n">bid</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* List empty or new block bigger than last entry. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">==</span> <span class="n">sbid_list</span><span class="p">)</span>
		<span class="n">tape_34xx_append_new_sbid</span><span class="p">(</span><span class="n">bid</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">);</span>

	<span class="n">DBF_LH</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Current list is:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">sbid_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbid</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_34xx_sbid</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">DBF_LH</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%d:%03d@%05d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sbid</span><span class="o">-&gt;</span><span class="n">bid</span><span class="p">.</span><span class="n">wrap</span><span class="p">,</span>
			<span class="n">sbid</span><span class="o">-&gt;</span><span class="n">bid</span><span class="p">.</span><span class="n">segment</span><span class="p">,</span>
			<span class="n">sbid</span><span class="o">-&gt;</span><span class="n">bid</span><span class="p">.</span><span class="n">block</span>
		<span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Delete all entries from the search block ID list that belong to tape blocks</span>
<span class="cm"> * equal or higher than the given number.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tape_34xx_delete_sbid_from</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span>	<span class="n">sbid_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tape_34xx_sbid</span> <span class="o">*</span>	<span class="n">sbid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span>	<span class="n">l</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span>	<span class="n">n</span><span class="p">;</span>

	<span class="n">sbid_list</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">discdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbid_list</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">sbid_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbid</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_34xx_sbid</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbid</span><span class="o">-&gt;</span><span class="n">bid</span><span class="p">.</span><span class="n">block</span> <span class="o">&gt;=</span> <span class="n">from</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBF_LH</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Delete sbid %d:%03d@%05d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sbid</span><span class="o">-&gt;</span><span class="n">bid</span><span class="p">.</span><span class="n">wrap</span><span class="p">,</span>
				<span class="n">sbid</span><span class="o">-&gt;</span><span class="n">bid</span><span class="p">.</span><span class="n">segment</span><span class="p">,</span>
				<span class="n">sbid</span><span class="o">-&gt;</span><span class="n">bid</span><span class="p">.</span><span class="n">block</span>
			<span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sbid</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Merge hardware position data into a block id.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tape_34xx_merge_sbid</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span>		<span class="n">device</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">tape_34xx_block_id</span> <span class="o">*</span>	<span class="n">bid</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_34xx_sbid</span> <span class="o">*</span>	<span class="n">sbid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tape_34xx_sbid</span> <span class="o">*</span>	<span class="n">sbid_to_use</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span>	<span class="n">sbid_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span>	<span class="n">l</span><span class="p">;</span>

	<span class="n">sbid_list</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">discdata</span><span class="p">;</span>
	<span class="n">bid</span><span class="o">-&gt;</span><span class="n">wrap</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bid</span><span class="o">-&gt;</span><span class="n">segment</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbid_list</span> <span class="o">||</span> <span class="n">list_empty</span><span class="p">(</span><span class="n">sbid_list</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sbid_to_use</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">sbid_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbid</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_34xx_sbid</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sbid</span><span class="o">-&gt;</span><span class="n">bid</span><span class="p">.</span><span class="n">block</span> <span class="o">&gt;=</span> <span class="n">bid</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">sbid_to_use</span> <span class="o">=</span> <span class="n">sbid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbid_to_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bid</span><span class="o">-&gt;</span><span class="n">wrap</span>    <span class="o">=</span> <span class="n">sbid_to_use</span><span class="o">-&gt;</span><span class="n">bid</span><span class="p">.</span><span class="n">wrap</span><span class="p">;</span>
		<span class="n">bid</span><span class="o">-&gt;</span><span class="n">segment</span> <span class="o">=</span> <span class="n">sbid_to_use</span><span class="o">-&gt;</span><span class="n">bid</span><span class="p">.</span><span class="n">segment</span><span class="p">;</span>
		<span class="n">DBF_LH</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Use %d:%03d@%05d for %05d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sbid_to_use</span><span class="o">-&gt;</span><span class="n">bid</span><span class="p">.</span><span class="n">wrap</span><span class="p">,</span>
			<span class="n">sbid_to_use</span><span class="o">-&gt;</span><span class="n">bid</span><span class="p">.</span><span class="n">segment</span><span class="p">,</span>
			<span class="n">sbid_to_use</span><span class="o">-&gt;</span><span class="n">bid</span><span class="p">.</span><span class="n">block</span><span class="p">,</span>
			<span class="n">bid</span><span class="o">-&gt;</span><span class="n">block</span>
		<span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_34xx_setup_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span>	<span class="n">discdata</span><span class="p">;</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;34xx device setup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">tape_std_assign</span><span class="p">(</span><span class="n">device</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">tape_34xx_medium_sense</span><span class="p">(</span><span class="n">device</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBF_LH</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;34xx medium sense returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">discdata</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">discdata</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="n">discdata</span><span class="p">);</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">discdata</span> <span class="o">=</span> <span class="n">discdata</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tape_34xx_cleanup_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tape_std_unassign</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">discdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tape_34xx_delete_sbid_from</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">discdata</span><span class="p">);</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">discdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * MTTELL: Tell block. Return the number of block relative to current file.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_34xx_mttell</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tape_34xx_block_id</span>	<span class="n">cbid</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tape_34xx_block_id</span>	<span class="n">dbid</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">block_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_std_read_block_id</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="p">(</span><span class="n">__u64</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">block_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">tape_34xx_add_sbid</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">block_id</span><span class="p">.</span><span class="n">cbid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">block_id</span><span class="p">.</span><span class="n">cbid</span><span class="p">.</span><span class="n">block</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTSEEK: seek to the specified block.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_34xx_mtseek</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tape_34xx_block_id</span> <span class="o">*</span>	<span class="n">bid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mt_count</span> <span class="o">&gt;</span> <span class="mh">0x3fffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_EXCEPTION</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;xsee parm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>

	<span class="cm">/* setup ccws */</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_LBL</span><span class="p">;</span>
	<span class="n">bid</span>         <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tape_34xx_block_id</span> <span class="o">*</span><span class="p">)</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">;</span>
	<span class="n">bid</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">TAPE34XX_FMT_3480_XF</span> <span class="o">:</span> <span class="n">TAPE34XX_FMT_3480</span><span class="p">;</span>
	<span class="n">bid</span><span class="o">-&gt;</span><span class="n">block</span>  <span class="o">=</span> <span class="n">mt_count</span><span class="p">;</span>
	<span class="n">tape_34xx_merge_sbid</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">bid</span><span class="p">);</span>

	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LOCATE</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* execute it */</span>
	<span class="k">return</span> <span class="n">tape_do_io_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * List of 3480/3490 magnetic tape commands.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">tape_mtop_fn</span> <span class="n">tape_34xx_mtop</span><span class="p">[</span><span class="n">TAPE_NR_MTOPS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">MTRESET</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtreset</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTFSF</span><span class="p">]</span>		 <span class="o">=</span> <span class="n">tape_std_mtfsf</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTBSF</span><span class="p">]</span>		 <span class="o">=</span> <span class="n">tape_std_mtbsf</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTFSR</span><span class="p">]</span>		 <span class="o">=</span> <span class="n">tape_std_mtfsr</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTBSR</span><span class="p">]</span>		 <span class="o">=</span> <span class="n">tape_std_mtbsr</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTWEOF</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtweof</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTREW</span><span class="p">]</span>		 <span class="o">=</span> <span class="n">tape_std_mtrew</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTOFFL</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtoffl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTNOP</span><span class="p">]</span>		 <span class="o">=</span> <span class="n">tape_std_mtnop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTRETEN</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtreten</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTBSFM</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtbsfm</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTFSFM</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtfsfm</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTEOM</span><span class="p">]</span>		 <span class="o">=</span> <span class="n">tape_std_mteom</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTERASE</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mterase</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTRAS1</span><span class="p">]</span>	 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTRAS2</span><span class="p">]</span>	 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTRAS3</span><span class="p">]</span>	 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTSETBLK</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtsetblk</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTSETDENSITY</span><span class="p">]</span>	 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTSEEK</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_34xx_mtseek</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTTELL</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_34xx_mttell</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTSETDRVBUFFER</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTFSS</span><span class="p">]</span>		 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTBSS</span><span class="p">]</span>		 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTWSM</span><span class="p">]</span>		 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTLOCK</span><span class="p">]</span>	 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTUNLOCK</span><span class="p">]</span>	 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTLOAD</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtload</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTUNLOAD</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtunload</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTCOMPRESSION</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtcompression</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTSETPART</span><span class="p">]</span>	 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTMKPART</span><span class="p">]</span>	 <span class="o">=</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Tape discipline structure for 3480 and 3490.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tape_discipline</span> <span class="n">tape_discipline_34xx</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_device</span> <span class="o">=</span> <span class="n">tape_34xx_setup_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup_device</span> <span class="o">=</span> <span class="n">tape_34xx_cleanup_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">process_eov</span> <span class="o">=</span> <span class="n">tape_std_process_eov</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">tape_34xx_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_block</span> <span class="o">=</span> <span class="n">tape_std_read_block</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_block</span> <span class="o">=</span> <span class="n">tape_std_write_block</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_fn</span> <span class="o">=</span> <span class="n">tape_34xx_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mtop_array</span> <span class="o">=</span> <span class="n">tape_34xx_mtop</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccw_device_id</span> <span class="n">tape_34xx_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">CCW_DEVICE_DEVTYPE</span><span class="p">(</span><span class="mh">0x3480</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3480</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">tape_3480</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">CCW_DEVICE_DEVTYPE</span><span class="p">(</span><span class="mh">0x3490</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3490</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">tape_3490</span><span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* end of list */</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_34xx_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tape_generic_online</span><span class="p">(</span>
		<span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">tape_discipline_34xx</span>
	<span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccw_driver</span> <span class="n">tape_34xx_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;tape_34xx&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">tape_34xx_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">tape_generic_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">tape_generic_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_online</span> <span class="o">=</span> <span class="n">tape_34xx_online</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_offline</span> <span class="o">=</span> <span class="n">tape_generic_offline</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span> <span class="o">=</span> <span class="n">tape_generic_pm_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">int_class</span> <span class="o">=</span> <span class="n">IOINT_TAP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_34xx_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">TAPE_DBF_AREA</span> <span class="o">=</span> <span class="n">debug_register</span> <span class="p">(</span> <span class="s">&quot;tape_34xx&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">TAPE_DBF_AREA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_sprintf_view</span><span class="p">);</span>
<span class="cp">#ifdef DBF_LIKE_HELL</span>
	<span class="n">debug_set_level</span><span class="p">(</span><span class="n">TAPE_DBF_AREA</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;34xx init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Register driver for 3480/3490 tapes. */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tape_34xx_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;34xx init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;34xx registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tape_34xx_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ccw_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tape_34xx_driver</span><span class="p">);</span>

	<span class="n">debug_unregister</span><span class="p">(</span><span class="n">TAPE_DBF_AREA</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">tape_34xx_ids</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;(C) 2001-2002 IBM Deutschland Entwicklung GmbH&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Linux on zSeries channel attached 3480 tape device driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">tape_34xx_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">tape_34xx_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
