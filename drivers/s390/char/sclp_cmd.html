<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › char › sclp_cmd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sclp_cmd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright IBM Corp. 2007, 2009</span>
<span class="cm"> *</span>
<span class="cm"> * Author(s): Heiko Carstens &lt;heiko.carstens@de.ibm.com&gt;,</span>
<span class="cm"> *	      Peter Oberparleiter &lt;peter.oberparleiter@de.ibm.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;sclp_cmd&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/mmzone.h&gt;</span>
<span class="cp">#include &lt;linux/memory.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;asm/chpid.h&gt;</span>
<span class="cp">#include &lt;asm/sclp.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/ctl_reg.h&gt;</span>

<span class="cp">#include &quot;sclp.h&quot;</span>

<span class="cp">#define SCLP_CMDW_READ_SCP_INFO		0x00020001</span>
<span class="cp">#define SCLP_CMDW_READ_SCP_INFO_FORCED	0x00120001</span>

<span class="k">struct</span> <span class="n">read_info_sccb</span> <span class="p">{</span>
	<span class="k">struct</span>	<span class="n">sccb_header</span> <span class="n">header</span><span class="p">;</span>	<span class="cm">/* 0-7 */</span>
	<span class="n">u16</span>	<span class="n">rnmax</span><span class="p">;</span>			<span class="cm">/* 8-9 */</span>
	<span class="n">u8</span>	<span class="n">rnsize</span><span class="p">;</span>			<span class="cm">/* 10 */</span>
	<span class="n">u8</span>	<span class="n">_reserved0</span><span class="p">[</span><span class="mi">24</span> <span class="o">-</span> <span class="mi">11</span><span class="p">];</span>	<span class="cm">/* 11-15 */</span>
	<span class="n">u8</span>	<span class="n">loadparm</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>		<span class="cm">/* 24-31 */</span>
	<span class="n">u8</span>	<span class="n">_reserved1</span><span class="p">[</span><span class="mi">48</span> <span class="o">-</span> <span class="mi">32</span><span class="p">];</span>	<span class="cm">/* 32-47 */</span>
	<span class="n">u64</span>	<span class="n">facilities</span><span class="p">;</span>		<span class="cm">/* 48-55 */</span>
	<span class="n">u8</span>	<span class="n">_reserved2</span><span class="p">[</span><span class="mi">84</span> <span class="o">-</span> <span class="mi">56</span><span class="p">];</span>	<span class="cm">/* 56-83 */</span>
	<span class="n">u8</span>	<span class="n">fac84</span><span class="p">;</span>			<span class="cm">/* 84 */</span>
	<span class="n">u8</span>	<span class="n">fac85</span><span class="p">;</span>			<span class="cm">/* 85 */</span>
	<span class="n">u8</span>	<span class="n">_reserved3</span><span class="p">[</span><span class="mi">91</span> <span class="o">-</span> <span class="mi">86</span><span class="p">];</span>	<span class="cm">/* 86-90 */</span>
	<span class="n">u8</span>	<span class="n">flags</span><span class="p">;</span>			<span class="cm">/* 91 */</span>
	<span class="n">u8</span>	<span class="n">_reserved4</span><span class="p">[</span><span class="mi">100</span> <span class="o">-</span> <span class="mi">92</span><span class="p">];</span>	<span class="cm">/* 92-99 */</span>
	<span class="n">u32</span>	<span class="n">rnsize2</span><span class="p">;</span>		<span class="cm">/* 100-103 */</span>
	<span class="n">u64</span>	<span class="n">rnmax2</span><span class="p">;</span>			<span class="cm">/* 104-111 */</span>
	<span class="n">u8</span>	<span class="n">_reserved5</span><span class="p">[</span><span class="mi">4096</span> <span class="o">-</span> <span class="mi">112</span><span class="p">];</span>	<span class="cm">/* 112-4095 */</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">,</span> <span class="n">aligned</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">)));</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">read_info_sccb</span> <span class="n">__initdata</span> <span class="n">early_read_info_sccb</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">early_read_info_sccb_valid</span><span class="p">;</span>

<span class="n">u64</span> <span class="n">sclp_facilities</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">sclp_fac84</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">sclp_fac85</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">rzm</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">rnmax</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sclp_cmd_sync_early</span><span class="p">(</span><span class="n">sclp_cmdw_t</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sccb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">__ctl_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sclp_service_call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">sccb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">__load_psw_mask</span><span class="p">(</span><span class="n">PSW_DEFAULT_KEY</span> <span class="o">|</span> <span class="n">PSW_MASK_BASE</span> <span class="o">|</span> <span class="n">PSW_MASK_EA</span> <span class="o">|</span>
			<span class="n">PSW_MASK_BA</span> <span class="o">|</span> <span class="n">PSW_MASK_EXT</span> <span class="o">|</span> <span class="n">PSW_MASK_WAIT</span><span class="p">);</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="cm">/* Contents of the sccb might have changed. */</span>
	<span class="n">barrier</span><span class="p">();</span>
	<span class="n">__ctl_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">sclp_read_info_early</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">read_info_sccb</span> <span class="o">*</span><span class="n">sccb</span><span class="p">;</span>
	<span class="n">sclp_cmdw_t</span> <span class="n">commands</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">SCLP_CMDW_READ_SCP_INFO_FORCED</span><span class="p">,</span>
				  <span class="n">SCLP_CMDW_READ_SCP_INFO</span><span class="p">};</span>

	<span class="n">sccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">early_read_info_sccb</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">commands</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">sccb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sccb</span><span class="p">));</span>
			<span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sccb</span><span class="p">);</span>
			<span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">function_code</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">control_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">sclp_cmd_sync_early</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sccb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">response_code</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">early_read_info_sccb_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">response_code</span> <span class="o">!=</span> <span class="mh">0x1f0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">sclp_facilities_detect</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">read_info_sccb</span> <span class="o">*</span><span class="n">sccb</span><span class="p">;</span>

	<span class="n">sclp_read_info_early</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">early_read_info_sccb_valid</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">early_read_info_sccb</span><span class="p">;</span>
	<span class="n">sclp_facilities</span> <span class="o">=</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">facilities</span><span class="p">;</span>
	<span class="n">sclp_fac84</span> <span class="o">=</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">fac84</span><span class="p">;</span>
	<span class="n">sclp_fac85</span> <span class="o">=</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">fac85</span><span class="p">;</span>
	<span class="n">rnmax</span> <span class="o">=</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">rnmax</span> <span class="o">?</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">rnmax</span> <span class="o">:</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">rnmax2</span><span class="p">;</span>
	<span class="n">rzm</span> <span class="o">=</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">rnsize</span> <span class="o">?</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">rnsize</span> <span class="o">:</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">rnsize2</span><span class="p">;</span>
	<span class="n">rzm</span> <span class="o">&lt;&lt;=</span> <span class="mi">20</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">sclp_get_rnmax</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rnmax</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">sclp_get_rzm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rzm</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">sclp_get_fac85</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sclp_fac85</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sclp_get_fac85</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This function will be called after sclp_facilities_detect(), which gets</span>
<span class="cm"> * called from early.c code. Therefore the sccb should have valid contents.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">sclp_get_ipl_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">sclp_ipl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">read_info_sccb</span> <span class="o">*</span><span class="n">sccb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">early_read_info_sccb_valid</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">sccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">early_read_info_sccb</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">is_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sccb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">has_dump</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">loadparm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sccb</span><span class="o">-&gt;</span><span class="n">loadparm</span><span class="p">,</span> <span class="n">LOADPARM_LEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sclp_sync_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">sclp_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">completion</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">complete</span><span class="p">(</span><span class="n">completion</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_sync_request</span><span class="p">(</span><span class="n">sclp_cmdw_t</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sccb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">completion</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sclp_req</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">sccb</span> <span class="o">=</span> <span class="n">sccb</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">SCLP_REQ_FILLED</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">sclp_sync_callback</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">callback_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">completion</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">completion</span><span class="p">);</span>

	<span class="cm">/* Perform sclp request. */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sclp_add_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">completion</span><span class="p">);</span>

	<span class="cm">/* Check response. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SCLP_REQ_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;sync request failed (cmd=0x%08x, &quot;</span>
			   <span class="s">&quot;status=0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CPU configuration related functions.</span>
<span class="cm"> */</span>

<span class="cp">#define SCLP_CMDW_READ_CPU_INFO		0x00010001</span>
<span class="cp">#define SCLP_CMDW_CONFIGURE_CPU		0x00110001</span>
<span class="cp">#define SCLP_CMDW_DECONFIGURE_CPU	0x00100001</span>

<span class="k">struct</span> <span class="n">read_cpu_info_sccb</span> <span class="p">{</span>
	<span class="k">struct</span>	<span class="n">sccb_header</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">nr_configured</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">offset_configured</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">nr_standby</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">offset_standby</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">reserved</span><span class="p">[</span><span class="mi">4096</span> <span class="o">-</span> <span class="mi">16</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">,</span> <span class="n">aligned</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">)));</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sclp_fill_cpu_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">sclp_cpu_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">read_cpu_info_sccb</span> <span class="o">*</span><span class="n">sccb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">sccb</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">nr_configured</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">standby</span> <span class="o">=</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">nr_standby</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">combined</span> <span class="o">=</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">nr_configured</span> <span class="o">+</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">nr_standby</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">has_cpu_type</span> <span class="o">=</span> <span class="n">sclp_fac84</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="n">page</span> <span class="o">+</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">offset_configured</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">combined</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sclp_cpu_entry</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sclp_get_cpu_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">sclp_cpu_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">read_cpu_info_sccb</span> <span class="o">*</span><span class="n">sccb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SCLP_HAS_CPU_INFO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="n">sccb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sccb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sccb</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">do_sync_request</span><span class="p">(</span><span class="n">SCLP_CMDW_READ_CPU_INFO</span><span class="p">,</span> <span class="n">sccb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">response_code</span> <span class="o">!=</span> <span class="mh">0x0010</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;readcpuinfo failed (response=0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">response_code</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sclp_fill_cpu_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">sccb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sccb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">cpu_configure_sccb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb_header</span> <span class="n">header</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">,</span> <span class="n">aligned</span><span class="p">(</span><span class="mi">8</span><span class="p">)));</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_cpu_configure</span><span class="p">(</span><span class="n">sclp_cmdw_t</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_configure_sccb</span> <span class="o">*</span><span class="n">sccb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SCLP_HAS_CPU_RECONFIG</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * This is not going to cross a page boundary since we force</span>
<span class="cm">	 * kmalloc to have a minimum alignment of 8 bytes on s390.</span>
<span class="cm">	 */</span>
	<span class="n">sccb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sccb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sccb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sccb</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">do_sync_request</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">sccb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">response_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x0020</span>:
	<span class="k">case</span> <span class="mh">0x0120</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;configure cpu failed (cmd=0x%08x, &quot;</span>
			   <span class="s">&quot;response=0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
			   <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">response_code</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sccb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sclp_cpu_configure</span><span class="p">(</span><span class="n">u8</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">do_cpu_configure</span><span class="p">(</span><span class="n">SCLP_CMDW_CONFIGURE_CPU</span> <span class="o">|</span> <span class="n">cpu</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sclp_cpu_deconfigure</span><span class="p">(</span><span class="n">u8</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">do_cpu_configure</span><span class="p">(</span><span class="n">SCLP_CMDW_DECONFIGURE_CPU</span> <span class="o">|</span> <span class="n">cpu</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MEMORY_HOTPLUG</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">sclp_mem_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">sclp_mem_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">sclp_max_storage_id</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sclp_storage_ids</span><span class="p">[</span><span class="mi">256</span> <span class="o">/</span> <span class="n">BITS_PER_LONG</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sclp_mem_state_changed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">memory_increment</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">standby</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">usecount</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">assign_storage_sccb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb_header</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rn</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">arch_get_memory_phys_device</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_pfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rzm</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">start_pfn</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">rzm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">rn2addr</span><span class="p">(</span><span class="n">u16</span> <span class="n">rn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">rn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rzm</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_assign_storage</span><span class="p">(</span><span class="n">sclp_cmdw_t</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">assign_storage_sccb</span> <span class="o">*</span><span class="n">sccb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">sccb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sccb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">sccb</span><span class="o">-&gt;</span><span class="n">rn</span> <span class="o">=</span> <span class="n">rn</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">do_sync_request</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">sccb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">response_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x0020</span>:
	<span class="k">case</span> <span class="mh">0x0120</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;assign storage failed (cmd=0x%08x, &quot;</span>
			   <span class="s">&quot;response=0x%04x, rn=0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
			   <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">response_code</span><span class="p">,</span> <span class="n">rn</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sccb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sclp_assign_storage</span><span class="p">(</span><span class="n">u16</span> <span class="n">rn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">do_assign_storage</span><span class="p">(</span><span class="mh">0x000d0001</span><span class="p">,</span> <span class="n">rn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">address</span> <span class="o">=</span> <span class="n">rn2addr</span><span class="p">(</span><span class="n">rn</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">address</span> <span class="o">&lt;</span> <span class="n">start</span> <span class="o">+</span> <span class="n">rzm</span><span class="p">;</span> <span class="n">address</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="n">page_set_storage_key</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">PAGE_DEFAULT_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sclp_unassign_storage</span><span class="p">(</span><span class="n">u16</span> <span class="n">rn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">do_assign_storage</span><span class="p">(</span><span class="mh">0x000c0001</span><span class="p">,</span> <span class="n">rn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">attach_storage_sccb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb_header</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">:</span><span class="mi">16</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">assigned</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">:</span><span class="mi">32</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sclp_attach_storage</span><span class="p">(</span><span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">attach_storage_sccb</span> <span class="o">*</span><span class="n">sccb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sccb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sccb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">do_sync_request</span><span class="p">(</span><span class="mh">0x00080001</span> <span class="o">|</span> <span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">sccb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">response_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x0020</span>:
		<span class="n">set_bit</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">sclp_storage_ids</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">assigned</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sccb</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">sclp_unassign_storage</span><span class="p">(</span><span class="n">sccb</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sccb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sclp_mem_change_state</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">online</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">memory_increment</span> <span class="o">*</span><span class="n">incr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">istart</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">incr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sclp_mem_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">istart</span> <span class="o">=</span> <span class="n">rn2addr</span><span class="p">(</span><span class="n">incr</span><span class="o">-&gt;</span><span class="n">rn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">istart</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">istart</span> <span class="o">+</span> <span class="n">rzm</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">incr</span><span class="o">-&gt;</span><span class="n">usecount</span><span class="o">++</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Don&#39;t break the loop if one assign fails. Loop may</span>
<span class="cm">			 * be walked again on CANCEL and we can&#39;t save</span>
<span class="cm">			 * information if state changed before or not.</span>
<span class="cm">			 * So continue and increase usecount for all increments.</span>
<span class="cm">			 */</span>
			<span class="n">rc</span> <span class="o">|=</span> <span class="n">sclp_assign_storage</span><span class="p">(</span><span class="n">incr</span><span class="o">-&gt;</span><span class="n">rn</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">incr</span><span class="o">-&gt;</span><span class="n">usecount</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">sclp_unassign_storage</span><span class="p">(</span><span class="n">incr</span><span class="o">-&gt;</span><span class="n">rn</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sclp_mem_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">memory_notify</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">arg</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">start_pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sclp_mem_mutex</span><span class="p">);</span>
	<span class="n">for_each_clear_bit</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">sclp_storage_ids</span><span class="p">,</span> <span class="n">sclp_max_storage_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">sclp_attach_storage</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MEM_ONLINE</span>:
	<span class="k">case</span> <span class="n">MEM_GOING_OFFLINE</span>:
	<span class="k">case</span> <span class="n">MEM_CANCEL_OFFLINE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MEM_GOING_ONLINE</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sclp_mem_change_state</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MEM_CANCEL_ONLINE</span>:
		<span class="n">sclp_mem_change_state</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MEM_OFFLINE</span>:
		<span class="n">sclp_mem_change_state</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">sclp_mem_state_changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sclp_mem_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span> <span class="o">?</span> <span class="n">NOTIFY_BAD</span> <span class="o">:</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">sclp_mem_nb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">sclp_mem_notifier</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">add_memory_merged</span><span class="p">(</span><span class="n">u16</span> <span class="n">rn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u16</span> <span class="n">first_rn</span><span class="p">,</span> <span class="n">num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rn</span> <span class="o">&amp;&amp;</span> <span class="n">first_rn</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">first_rn</span> <span class="o">+</span> <span class="n">num</span> <span class="o">==</span> <span class="n">rn</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">num</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first_rn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip_add</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">rn2addr</span><span class="p">(</span><span class="n">first_rn</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="p">)</span> <span class="n">num</span> <span class="o">*</span> <span class="n">rzm</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">VMEM_MAX_PHYS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip_add</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">VMEM_MAX_PHYS</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">VMEM_MAX_PHYS</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memory_end_set</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">memory_end</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">skip_add</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memory_end_set</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">memory_end</span><span class="p">))</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">memory_end</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">add_memory</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="nl">skip_add:</span>
	<span class="n">first_rn</span> <span class="o">=</span> <span class="n">rn</span><span class="p">;</span>
	<span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">sclp_add_standby_memory</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">memory_increment</span> <span class="o">*</span><span class="n">incr</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">incr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sclp_mem_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">incr</span><span class="o">-&gt;</span><span class="n">standby</span><span class="p">)</span>
			<span class="n">add_memory_merged</span><span class="p">(</span><span class="n">incr</span><span class="o">-&gt;</span><span class="n">rn</span><span class="p">);</span>
	<span class="n">add_memory_merged</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">insert_increment</span><span class="p">(</span><span class="n">u16</span> <span class="n">rn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">standby</span><span class="p">,</span> <span class="kt">int</span> <span class="n">assigned</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">memory_increment</span> <span class="o">*</span><span class="n">incr</span><span class="p">,</span> <span class="o">*</span><span class="n">new_incr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">last_rn</span><span class="p">;</span>

	<span class="n">new_incr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_incr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_incr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">new_incr</span><span class="o">-&gt;</span><span class="n">rn</span> <span class="o">=</span> <span class="n">rn</span><span class="p">;</span>
	<span class="n">new_incr</span><span class="o">-&gt;</span><span class="n">standby</span> <span class="o">=</span> <span class="n">standby</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">standby</span><span class="p">)</span>
		<span class="n">new_incr</span><span class="o">-&gt;</span><span class="n">usecount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">last_rn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sclp_mem_list</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">incr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sclp_mem_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">assigned</span> <span class="o">&amp;&amp;</span> <span class="n">incr</span><span class="o">-&gt;</span><span class="n">rn</span> <span class="o">&gt;</span> <span class="n">rn</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">assigned</span> <span class="o">&amp;&amp;</span> <span class="n">incr</span><span class="o">-&gt;</span><span class="n">rn</span> <span class="o">-</span> <span class="n">last_rn</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">last_rn</span> <span class="o">=</span> <span class="n">incr</span><span class="o">-&gt;</span><span class="n">rn</span><span class="p">;</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">incr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">assigned</span><span class="p">)</span>
		<span class="n">new_incr</span><span class="o">-&gt;</span><span class="n">rn</span> <span class="o">=</span> <span class="n">last_rn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_incr</span><span class="o">-&gt;</span><span class="n">rn</span> <span class="o">&gt;</span> <span class="n">rnmax</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">new_incr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_incr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sclp_mem_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sclp_mem_state_changed</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Memory hotplug state changed, suspend refused.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">read_storage_sccb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb_header</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">assigned</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">standby</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">:</span><span class="mi">16</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">sclp_mem_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">freeze</span>		<span class="o">=</span> <span class="n">sclp_mem_freeze</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">sclp_mem_pdrv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;sclp_mem&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sclp_mem_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sclp_detect_standby_memory</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">sclp_pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">read_storage_sccb</span> <span class="o">*</span><span class="n">sccb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">assigned</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">early_read_info_sccb_valid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sclp_facilities</span> <span class="o">&amp;</span> <span class="mh">0xe00000000000ULL</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xe00000000000ULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sccb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sccb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">assigned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">id</span> <span class="o">&lt;=</span> <span class="n">sclp_max_storage_id</span><span class="p">;</span> <span class="n">id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">sccb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">do_sync_request</span><span class="p">(</span><span class="mh">0x00040001</span> <span class="o">|</span> <span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">sccb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">response_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x0010</span>:
			<span class="n">set_bit</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">sclp_storage_ids</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">assigned</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sccb</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">assigned</span><span class="o">++</span><span class="p">;</span>
				<span class="n">insert_increment</span><span class="p">(</span><span class="n">sccb</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0310</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0410</span>:
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">assigned</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sccb</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">assigned</span><span class="o">++</span><span class="p">;</span>
				<span class="n">insert_increment</span><span class="p">(</span><span class="n">sccb</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">sclp_max_storage_id</span> <span class="o">=</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">max_id</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sclp_mem_list</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">rnmax</span> <span class="o">-</span> <span class="n">assigned</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">insert_increment</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_memory_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sclp_mem_nb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sclp_mem_pdrv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">sclp_pdev</span> <span class="o">=</span> <span class="n">platform_device_register_simple</span><span class="p">(</span><span class="s">&quot;sclp_mem&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">sclp_pdev</span><span class="p">)</span> <span class="o">?</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">sclp_pdev</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_driver</span><span class="p">;</span>
	<span class="n">sclp_add_standby_memory</span><span class="p">();</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">out_driver:</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sclp_mem_pdrv</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sccb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__initcall</span><span class="p">(</span><span class="n">sclp_detect_standby_memory</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_MEMORY_HOTPLUG */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Channel path configuration related functions.</span>
<span class="cm"> */</span>

<span class="cp">#define SCLP_CMDW_CONFIGURE_CHPATH		0x000f0001</span>
<span class="cp">#define SCLP_CMDW_DECONFIGURE_CHPATH		0x000e0001</span>
<span class="cp">#define SCLP_CMDW_READ_CHPATH_INFORMATION	0x00030001</span>

<span class="k">struct</span> <span class="n">chp_cfg_sccb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb_header</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ccm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">cssid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_chp_configure</span><span class="p">(</span><span class="n">sclp_cmdw_t</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">chp_cfg_sccb</span> <span class="o">*</span><span class="n">sccb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SCLP_HAS_CHP_RECONFIG</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="cm">/* Prepare sccb. */</span>
	<span class="n">sccb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">chp_cfg_sccb</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sccb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sccb</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">do_sync_request</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">sccb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">response_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x0020</span>:
	<span class="k">case</span> <span class="mh">0x0120</span>:
	<span class="k">case</span> <span class="mh">0x0440</span>:
	<span class="k">case</span> <span class="mh">0x0450</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;configure channel-path failed &quot;</span>
			   <span class="s">&quot;(cmd=0x%08x, response=0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
			   <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">response_code</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sccb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sclp_chp_configure - perform configure channel-path sclp command</span>
<span class="cm"> * @chpid: channel-path ID</span>
<span class="cm"> *</span>
<span class="cm"> * Perform configure channel-path command sclp command for specified chpid.</span>
<span class="cm"> * Return 0 after command successfully finished, non-zero otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sclp_chp_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">chp_id</span> <span class="n">chpid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">do_chp_configure</span><span class="p">(</span><span class="n">SCLP_CMDW_CONFIGURE_CHPATH</span> <span class="o">|</span> <span class="n">chpid</span><span class="p">.</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sclp_chp_deconfigure - perform deconfigure channel-path sclp command</span>
<span class="cm"> * @chpid: channel-path ID</span>
<span class="cm"> *</span>
<span class="cm"> * Perform deconfigure channel-path command sclp command for specified chpid</span>
<span class="cm"> * and wait for completion. On success return 0. Return non-zero otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sclp_chp_deconfigure</span><span class="p">(</span><span class="k">struct</span> <span class="n">chp_id</span> <span class="n">chpid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">do_chp_configure</span><span class="p">(</span><span class="n">SCLP_CMDW_DECONFIGURE_CHPATH</span> <span class="o">|</span> <span class="n">chpid</span><span class="p">.</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">chp_info_sccb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb_header</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">recognized</span><span class="p">[</span><span class="n">SCLP_CHP_INFO_MASK_SIZE</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">standby</span><span class="p">[</span><span class="n">SCLP_CHP_INFO_MASK_SIZE</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">configured</span><span class="p">[</span><span class="n">SCLP_CHP_INFO_MASK_SIZE</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">ccm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">cssid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/**</span>
<span class="cm"> * sclp_chp_read_info - perform read channel-path information sclp command</span>
<span class="cm"> * @info: resulting channel-path information data</span>
<span class="cm"> *</span>
<span class="cm"> * Perform read channel-path information sclp command and wait for completion.</span>
<span class="cm"> * On success, store channel-path information in @info and return 0. Return</span>
<span class="cm"> * non-zero otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sclp_chp_read_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">sclp_chp_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">chp_info_sccb</span> <span class="o">*</span><span class="n">sccb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SCLP_HAS_CHP_INFO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="cm">/* Prepare sccb. */</span>
	<span class="n">sccb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">chp_info_sccb</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sccb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sccb</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">do_sync_request</span><span class="p">(</span><span class="n">SCLP_CMDW_READ_CHPATH_INFORMATION</span><span class="p">,</span> <span class="n">sccb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">response_code</span> <span class="o">!=</span> <span class="mh">0x0010</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;read channel-path info failed &quot;</span>
			   <span class="s">&quot;(response=0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">response_code</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">recognized</span><span class="p">,</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">recognized</span><span class="p">,</span> <span class="n">SCLP_CHP_INFO_MASK_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">standby</span><span class="p">,</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">standby</span><span class="p">,</span> <span class="n">SCLP_CHP_INFO_MASK_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">configured</span><span class="p">,</span> <span class="n">sccb</span><span class="o">-&gt;</span><span class="n">configured</span><span class="p">,</span> <span class="n">SCLP_CHP_INFO_MASK_SIZE</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sccb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
