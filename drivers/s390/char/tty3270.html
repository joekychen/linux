<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › char › tty3270.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tty3270.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  drivers/s390/char/tty3270.c</span>
<span class="cm"> *    IBM/3270 Driver - tty functions.</span>
<span class="cm"> *</span>
<span class="cm"> *  Author(s):</span>
<span class="cm"> *    Original 3270 Code for 2.4 written by Richard Hitt (UTS Global)</span>
<span class="cm"> *    Rewritten for 2.5 by Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;</span>
<span class="cm"> *	-- Copyright (C) 2003 IBM Deutschland Entwicklung GmbH, IBM Corporation</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kdev_t.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/vt_kern.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>

<span class="cp">#include &lt;asm/ccwdev.h&gt;</span>
<span class="cp">#include &lt;asm/cio.h&gt;</span>
<span class="cp">#include &lt;asm/ebcdic.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;raw3270.h&quot;</span>
<span class="cp">#include &quot;tty3270.h&quot;</span>
<span class="cp">#include &quot;keyboard.h&quot;</span>

<span class="cp">#define TTY3270_CHAR_BUF_SIZE 256</span>
<span class="cp">#define TTY3270_OUTPUT_BUFFER_SIZE 1024</span>
<span class="cp">#define TTY3270_STRING_PAGES 5</span>

<span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">tty3270_driver</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tty3270_max_index</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">raw3270_fn</span> <span class="n">tty3270_fn</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">tty3270_cell</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">character</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">highlight</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">f_color</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tty3270_line</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270_cell</span> <span class="o">*</span><span class="n">cells</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define ESCAPE_NPAR 8</span>

<span class="cm">/*</span>
<span class="cm"> * The main tty view data structure.</span>
<span class="cm"> * FIXME:</span>
<span class="cm"> * 1) describe line orientation &amp; lines list concept against screen</span>
<span class="cm"> * 2) describe conversion of screen to lines</span>
<span class="cm"> * 3) describe line format.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">tty3270</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">raw3270_view</span> <span class="n">view</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">**</span><span class="n">freemem_pages</span><span class="p">;</span>		<span class="cm">/* Array of pages used for freemem. */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">freemem</span><span class="p">;</span>	<span class="cm">/* List of free memory for strings. */</span>

	<span class="cm">/* Output stuff. */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">lines</span><span class="p">;</span>		<span class="cm">/* List of lines. */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">update</span><span class="p">;</span>	<span class="cm">/* List of lines to update. */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">wcc</span><span class="p">;</span>		<span class="cm">/* Write control character. */</span>
	<span class="kt">int</span> <span class="n">nr_lines</span><span class="p">;</span>			<span class="cm">/* # lines in list. */</span>
	<span class="kt">int</span> <span class="n">nr_up</span><span class="p">;</span>			<span class="cm">/* # lines up in history. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">update_flags</span><span class="p">;</span>	<span class="cm">/* Update indication bits. */</span>
	<span class="k">struct</span> <span class="n">string</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>		<span class="cm">/* Lower right of display. */</span>
	<span class="k">struct</span> <span class="n">raw3270_request</span> <span class="o">*</span><span class="n">write</span><span class="p">;</span>	<span class="cm">/* Single write request. */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>	<span class="cm">/* Output delay timer. */</span>

	<span class="cm">/* Current tty screen. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">;</span>		<span class="cm">/* Current output position. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">highlight</span><span class="p">;</span>		<span class="cm">/* Blink/reverse/underscore */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">f_color</span><span class="p">;</span>		<span class="cm">/* Foreground color */</span>
	<span class="k">struct</span> <span class="n">tty3270_line</span> <span class="o">*</span><span class="n">screen</span><span class="p">;</span>

	<span class="cm">/* Input stuff. */</span>
	<span class="k">struct</span> <span class="n">string</span> <span class="o">*</span><span class="n">prompt</span><span class="p">;</span>		<span class="cm">/* Output string for input area. */</span>
	<span class="k">struct</span> <span class="n">string</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>		<span class="cm">/* Input string for read request. */</span>
	<span class="k">struct</span> <span class="n">raw3270_request</span> <span class="o">*</span><span class="n">read</span><span class="p">;</span>	<span class="cm">/* Single read request. */</span>
	<span class="k">struct</span> <span class="n">raw3270_request</span> <span class="o">*</span><span class="n">kreset</span><span class="p">;</span>	<span class="cm">/* Single keyboard reset request. */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">inattr</span><span class="p">;</span>		<span class="cm">/* Visible/invisible input. */</span>
	<span class="kt">int</span> <span class="n">throttle</span><span class="p">,</span> <span class="n">attn</span><span class="p">;</span>		<span class="cm">/* tty throttle/unthrottle. */</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span> <span class="n">readlet</span><span class="p">;</span>	<span class="cm">/* Tasklet to issue read request. */</span>
	<span class="k">struct</span> <span class="n">kbd_data</span> <span class="o">*</span><span class="n">kbd</span><span class="p">;</span>		<span class="cm">/* key_maps stuff. */</span>

	<span class="cm">/* Escape sequence parsing. */</span>
	<span class="kt">int</span> <span class="n">esc_state</span><span class="p">,</span> <span class="n">esc_ques</span><span class="p">,</span> <span class="n">esc_npar</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">esc_par</span><span class="p">[</span><span class="n">ESCAPE_NPAR</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">saved_cx</span><span class="p">,</span> <span class="n">saved_cy</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">saved_highlight</span><span class="p">,</span> <span class="n">saved_f_color</span><span class="p">;</span>

	<span class="cm">/* Command recalling. */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">rcl_lines</span><span class="p">;</span>	<span class="cm">/* List of recallable lines. */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">rcl_walk</span><span class="p">;</span>	<span class="cm">/* Point in rcl_lines list. */</span>
	<span class="kt">int</span> <span class="n">rcl_nr</span><span class="p">,</span> <span class="n">rcl_max</span><span class="p">;</span>		<span class="cm">/* Number/max number of rcl_lines. */</span>

	<span class="cm">/* Character array for put_char/flush_chars. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">char_count</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">char_buf</span><span class="p">[</span><span class="n">TTY3270_CHAR_BUF_SIZE</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* tty3270-&gt;update_flags. See tty3270_update for details. */</span>
<span class="cp">#define TTY_UPDATE_ERASE	1	</span><span class="cm">/* Use EWRITEA instead of WRITE. */</span><span class="cp"></span>
<span class="cp">#define TTY_UPDATE_LIST		2	</span><span class="cm">/* Update lines in tty3270-&gt;update. */</span><span class="cp"></span>
<span class="cp">#define TTY_UPDATE_INPUT	4	</span><span class="cm">/* Update input line. */</span><span class="cp"></span>
<span class="cp">#define TTY_UPDATE_STATUS	8	</span><span class="cm">/* Update status line. */</span><span class="cp"></span>
<span class="cp">#define TTY_UPDATE_ALL		16	</span><span class="cm">/* Recreate screen. */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">tty3270_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Setup timeout for a device. On timeout trigger an update.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tty3270_set_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">expires</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">expires</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">expires</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The input line are the two last lines of the screen.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_update_prompt</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">string</span> <span class="o">*</span><span class="n">line</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">off</span><span class="p">;</span>

	<span class="n">line</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">TF_INMDT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">inattr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">11</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">11</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">line</span><span class="o">-&gt;</span><span class="n">string</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">line</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">[</span><span class="mi">6</span> <span class="o">+</span> <span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">TO_IC</span><span class="p">;</span>
	<span class="cm">/* Clear to end of input line. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">11</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">[</span><span class="mi">7</span> <span class="o">+</span> <span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">TO_RA</span><span class="p">;</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">[</span><span class="mi">10</span> <span class="o">+</span> <span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span> <span class="o">*</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">raw3270_buffer_address</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">string</span><span class="o">+</span><span class="n">count</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">11</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">update_flags</span> <span class="o">|=</span> <span class="n">TTY_UPDATE_INPUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_create_prompt</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">blueprint</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="n">TO_SBA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="n">TO_SF</span><span class="p">,</span> <span class="n">TF_INPUT</span><span class="p">,</span>
		  <span class="cm">/* empty input string */</span>
		  <span class="n">TO_IC</span><span class="p">,</span> <span class="n">TO_RA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">string</span> <span class="o">*</span><span class="n">line</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">line</span> <span class="o">=</span> <span class="n">alloc_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">blueprint</span><span class="p">)</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">inattr</span> <span class="o">=</span> <span class="n">TF_INPUT</span><span class="p">;</span>
	<span class="cm">/* Copy blueprint to status line */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">line</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">blueprint</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">blueprint</span><span class="p">));</span>
	<span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">blueprint</span><span class="p">);</span>
	<span class="cm">/* Set output offsets. */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span> <span class="o">*</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">raw3270_buffer_address</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">string</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span> <span class="o">*</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">raw3270_buffer_address</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">string</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="cm">/* Allocate input string for reading. */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">alloc_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The status line is the last line of the screen. It shows the string</span>
<span class="cm"> * &quot;Running&quot;/&quot;Holding&quot; in the lower right corner of the screen.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_update_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span> <span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>

	<span class="n">str</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_up</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;History&quot;</span> <span class="o">:</span> <span class="s">&quot;Running&quot;</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">string</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">codepage_convert</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">ascebc</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">string</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">update_flags</span> <span class="o">|=</span> <span class="n">TTY_UPDATE_STATUS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_create_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span> <span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">blueprint</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="n">TO_SBA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TO_SF</span><span class="p">,</span> <span class="n">TF_LOG</span><span class="p">,</span> <span class="n">TO_SA</span><span class="p">,</span> <span class="n">TAT_COLOR</span><span class="p">,</span> <span class="n">TAC_GREEN</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TO_SF</span><span class="p">,</span> <span class="n">TF_LOG</span><span class="p">,</span> <span class="n">TO_SA</span><span class="p">,</span> <span class="n">TAT_COLOR</span><span class="p">,</span>
		  <span class="n">TAC_RESET</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">string</span> <span class="o">*</span><span class="n">line</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">line</span> <span class="o">=</span> <span class="n">alloc_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">blueprint</span><span class="p">));</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
	<span class="cm">/* Copy blueprint to status line */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">line</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">blueprint</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">blueprint</span><span class="p">));</span>
	<span class="cm">/* Set address to start of status string (= last 9 characters). */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span> <span class="o">*</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">raw3270_buffer_address</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">string</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set output offsets to 3270 datastream fragment of a tty string.</span>
<span class="cm"> * (TO_SBA offset at the start and TO_RA offset at the end of the string)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_update_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">string</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>

	<span class="n">raw3270_buffer_address</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">string</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span> <span class="o">*</span> <span class="n">nr</span><span class="p">);</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">string</span> <span class="o">+</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="n">TO_RA</span><span class="p">)</span>
		<span class="n">raw3270_buffer_address</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span> <span class="o">*</span> <span class="p">(</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Rebuild update list to print all lines.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_rebuild_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">string</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="n">nr_up</span><span class="p">;</span>

	<span class="cm">/* </span>
<span class="cm">	 * Throw away update list and create a new one,</span>
<span class="cm">	 * containing all lines that will fit on the screen.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">,</span> <span class="n">update</span><span class="p">)</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">);</span>
	<span class="n">line</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">nr_up</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_up</span><span class="p">;</span>
	<span class="n">list_for_each_entry_reverse</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr_up</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nr_up</span><span class="o">--</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tty3270_update_string</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">line</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">update_flags</span> <span class="o">|=</span> <span class="n">TTY_UPDATE_LIST</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Alloc string for size bytes. If there is not enough room in</span>
<span class="cm"> * freemem, free strings until there is room.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">string</span> <span class="o">*</span>
<span class="nf">tty3270_alloc_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">string</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">alloc_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_lines</span> <span class="o">&lt;=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">))</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_lines</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">free_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">alloc_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_up</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_up</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_lines</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_up</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_lines</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">tty3270_rebuild_update</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">tty3270_update_status</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add an empty line to the list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_blank_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">blueprint</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="n">TO_SBA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TO_SA</span><span class="p">,</span> <span class="n">TAT_EXTHI</span><span class="p">,</span> <span class="n">TAX_RESET</span><span class="p">,</span>
		  <span class="n">TO_SA</span><span class="p">,</span> <span class="n">TAT_COLOR</span><span class="p">,</span> <span class="n">TAC_RESET</span><span class="p">,</span> <span class="n">TO_RA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">string</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">tty3270_alloc_string</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">blueprint</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">blueprint</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">blueprint</span><span class="p">));</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">blueprint</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_lines</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_up</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_up</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write request completion callback.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_write_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">raw3270_request</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty3270</span><span class="p">,</span> <span class="n">view</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Write wasn&#39;t successful. Refresh all. */</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">update_flags</span> <span class="o">=</span> <span class="n">TTY_UPDATE_ALL</span><span class="p">;</span>
		<span class="n">tty3270_set_timer</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">raw3270_request_reset</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
	<span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update 3270 display.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">invalid_sba</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">raw3270_request</span> <span class="o">*</span><span class="n">wrq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">updated</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">string</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sba</span><span class="p">,</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">wrq</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wrq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty3270_set_timer</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">updated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">update_flags</span> <span class="o">&amp;</span> <span class="n">TTY_UPDATE_ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty3270_rebuild_update</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">tty3270_update_status</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">update_flags</span> <span class="o">=</span> <span class="n">TTY_UPDATE_ERASE</span> <span class="o">|</span> <span class="n">TTY_UPDATE_LIST</span> <span class="o">|</span>
			<span class="n">TTY_UPDATE_INPUT</span> <span class="o">|</span> <span class="n">TTY_UPDATE_STATUS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">update_flags</span> <span class="o">&amp;</span> <span class="n">TTY_UPDATE_ERASE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Use erase write alternate to erase display. */</span>
		<span class="n">raw3270_request_set_cmd</span><span class="p">(</span><span class="n">wrq</span><span class="p">,</span> <span class="n">TC_EWRITEA</span><span class="p">);</span>
		<span class="n">updated</span> <span class="o">|=</span> <span class="n">TTY_UPDATE_ERASE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">raw3270_request_set_cmd</span><span class="p">(</span><span class="n">wrq</span><span class="p">,</span> <span class="n">TC_WRITE</span><span class="p">);</span>

	<span class="n">raw3270_request_add_data</span><span class="p">(</span><span class="n">wrq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">wcc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">wcc</span> <span class="o">=</span> <span class="n">TW_NONE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update status line.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">update_flags</span> <span class="o">&amp;</span> <span class="n">TTY_UPDATE_STATUS</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raw3270_request_add_data</span><span class="p">(</span><span class="n">wrq</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span>
					     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">updated</span> <span class="o">|=</span> <span class="n">TTY_UPDATE_STATUS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Write input line.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">update_flags</span> <span class="o">&amp;</span> <span class="n">TTY_UPDATE_INPUT</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raw3270_request_add_data</span><span class="p">(</span><span class="n">wrq</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span>
					     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">updated</span> <span class="o">|=</span> <span class="n">TTY_UPDATE_INPUT</span><span class="p">;</span>

	<span class="n">sba</span> <span class="o">=</span> <span class="n">invalid_sba</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">update_flags</span> <span class="o">&amp;</span> <span class="n">TTY_UPDATE_LIST</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Write strings in the update list to the screen. */</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">,</span> <span class="n">update</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">str</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Skip TO_SBA at the start of the string if the</span>
<span class="cm">			 * last output position matches the start address</span>
<span class="cm">			 * of this line.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">sba</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">sba</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">str</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">len</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">raw3270_request_add_data</span><span class="p">(</span><span class="n">wrq</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">);</span>
			<span class="n">sba</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">string</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">))</span>
			<span class="n">updated</span> <span class="o">|=</span> <span class="n">TTY_UPDATE_LIST</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">tty3270_write_callback</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">raw3270_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">,</span> <span class="n">wrq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">update_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">updated</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">update_flags</span><span class="p">)</span>
			<span class="n">tty3270_set_timer</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">raw3270_request_reset</span><span class="p">(</span><span class="n">wrq</span><span class="p">);</span>
		<span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">,</span> <span class="n">wrq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Command recalling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_rcl_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">string</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_walk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_nr</span> <span class="o">&gt;=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_lines</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">string</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">free_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_nr</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">tty3270_alloc_string</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_lines</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_nr</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_rcl_backward</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbd_data</span> <span class="o">*</span><span class="n">kbd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty3270</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">string</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">inattr</span> <span class="o">==</span> <span class="n">TF_INPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_walk</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_walk</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_lines</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_walk</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_walk</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_lines</span><span class="p">))</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_walk</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_lines</span><span class="p">.</span><span class="n">prev</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_walk</span> <span class="o">?</span> 
			<span class="n">list_entry</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_walk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">string</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_walk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_walk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">string</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">tty3270_update_prompt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">tty3270_update_prompt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tty3270_set_timer</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Deactivate tty view.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_exit_tty</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbd_data</span> <span class="o">*</span><span class="n">kbd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty3270</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">raw3270_deactivate_view</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Scroll forward in history.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_scroll_forward</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbd_data</span> <span class="o">*</span><span class="n">kbd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty3270</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr_up</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">nr_up</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_up</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_up</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nr_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_up</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_up</span> <span class="o">=</span> <span class="n">nr_up</span><span class="p">;</span>
		<span class="n">tty3270_rebuild_update</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">tty3270_update_status</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">tty3270_set_timer</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Scroll backward in history.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_scroll_backward</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbd_data</span> <span class="o">*</span><span class="n">kbd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty3270</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr_up</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">nr_up</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_up</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_up</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_lines</span><span class="p">)</span>
		<span class="n">nr_up</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_lines</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_up</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_up</span> <span class="o">=</span> <span class="n">nr_up</span><span class="p">;</span>
		<span class="n">tty3270_rebuild_update</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">tty3270_update_status</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">tty3270_set_timer</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Pass input line to tty.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_read_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">raw3270_request</span> <span class="o">*</span><span class="n">rrq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">kreset_data</span> <span class="o">=</span> <span class="n">TW_KR</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty3270</span><span class="p">,</span> <span class="n">view</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Two AID keys are special: For 0x7d (enter) the input line</span>
<span class="cm">	 * has to be emitted to the tty and for 0x6d the screen</span>
<span class="cm">	 * needs to be redrawn.</span>
<span class="cm">	 */</span>
	<span class="n">input</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7d</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enter: write input to tty. */</span>
		<span class="n">input</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">string</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">6</span> <span class="o">-</span> <span class="n">rrq</span><span class="o">-&gt;</span><span class="n">rescnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">inattr</span> <span class="o">!=</span> <span class="n">TF_INPUTN</span><span class="p">)</span>
			<span class="n">tty3270_rcl_add</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_up</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tty3270_rebuild_update</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="n">tty3270_update_status</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Clear input area. */</span>
		<span class="n">tty3270_update_prompt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tty3270_set_timer</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x6d</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Display has been cleared. Redraw. */</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">update_flags</span> <span class="o">=</span> <span class="n">TTY_UPDATE_ALL</span><span class="p">;</span>
		<span class="n">tty3270_set_timer</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Start keyboard reset command. */</span>
	<span class="n">raw3270_request_reset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">kreset</span><span class="p">);</span>
	<span class="n">raw3270_request_set_cmd</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">kreset</span><span class="p">,</span> <span class="n">TC_WRITE</span><span class="p">);</span>
	<span class="n">raw3270_request_add_data</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">kreset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kreset_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">raw3270_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">kreset</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kbd_keycode</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">kbd</span><span class="p">,</span> <span class="o">*</span><span class="n">input</span><span class="o">++</span><span class="p">);</span>
	<span class="cm">/* Emit keycode for AID byte. */</span>
	<span class="n">kbd_keycode</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">kbd</span><span class="p">,</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">raw3270_request_reset</span><span class="p">(</span><span class="n">rrq</span><span class="p">);</span>
	<span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">,</span> <span class="n">rrq</span><span class="p">);</span>
	<span class="n">raw3270_put_view</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read request completion callback.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_read_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">raw3270_request</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty3270</span><span class="p">,</span> <span class="n">view</span><span class="p">);</span>
	<span class="n">raw3270_get_view</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">);</span>
	<span class="cm">/* Schedule tasklet to pass input to tty. */</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">readlet</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Issue a read request. Call with device lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_issue_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">raw3270_request</span> <span class="o">*</span><span class="n">rrq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rrq</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rrq</span><span class="p">)</span>
		<span class="cm">/* Read already scheduled. */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">tty3270_read_callback</span><span class="p">;</span>
	<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">callback_data</span> <span class="o">=</span> <span class="n">tp</span><span class="p">;</span>
	<span class="n">raw3270_request_set_cmd</span><span class="p">(</span><span class="n">rrq</span><span class="p">,</span> <span class="n">TC_READMOD</span><span class="p">);</span>
	<span class="n">raw3270_request_set_data</span><span class="p">(</span><span class="n">rrq</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="cm">/* Issue the read modified request. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">raw3270_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">,</span> <span class="n">rrq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">raw3270_start_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">,</span> <span class="n">rrq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">raw3270_request_reset</span><span class="p">(</span><span class="n">rrq</span><span class="p">);</span>
		<span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">,</span> <span class="n">rrq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Switch to the tty view.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tty3270_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">raw3270_view</span> <span class="o">*</span><span class="n">view</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty3270</span><span class="p">,</span> <span class="n">view</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">update_flags</span> <span class="o">=</span> <span class="n">TTY_UPDATE_ALL</span><span class="p">;</span>
	<span class="n">tty3270_set_timer</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_deactivate</span><span class="p">(</span><span class="k">struct</span> <span class="n">raw3270_view</span> <span class="o">*</span><span class="n">view</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty3270</span><span class="p">,</span> <span class="n">view</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tty3270_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">raw3270_request</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Handle ATTN. Schedule tasklet to read aid. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_ATTENTION</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">throttle</span><span class="p">)</span>
			<span class="n">tty3270_issue_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">attn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_CHECK</span><span class="p">)</span>
			<span class="n">rq</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="cm">/* Normal end. Copy residual count. */</span>
			<span class="n">rq</span><span class="o">-&gt;</span><span class="n">rescnt</span> <span class="o">=</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">RAW3270_IO_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate tty3270 structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span>
<span class="nf">tty3270_alloc_view</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pages</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem_pages</span> <span class="o">=</span>
		<span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">TTY3270_STRING_PAGES</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem_pages</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_tp</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_lines</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcl_max</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">tty_port_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span> <span class="n">tty3270_update</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">tp</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">readlet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span> <span class="n">tty3270_read_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pages</span> <span class="o">&lt;</span> <span class="n">TTY3270_STRING_PAGES</span><span class="p">;</span> <span class="n">pages</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem_pages</span><span class="p">[</span><span class="n">pages</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="o">|</span><span class="n">GFP_DMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem_pages</span><span class="p">[</span><span class="n">pages</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">out_pages</span><span class="p">;</span>
		<span class="n">add_string_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem</span><span class="p">,</span>
				  <span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem_pages</span><span class="p">[</span><span class="n">pages</span><span class="p">],</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">raw3270_request_alloc</span><span class="p">(</span><span class="n">TTY3270_OUTPUT_BUFFER_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_pages</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">raw3270_request_alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_write</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">kreset</span> <span class="o">=</span> <span class="n">raw3270_request_alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">kreset</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_read</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">kbd</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_reset</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tp</span><span class="p">;</span>

<span class="nl">out_reset:</span>
	<span class="n">raw3270_request_free</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">kreset</span><span class="p">);</span>
<span class="nl">out_read:</span>
	<span class="n">raw3270_request_free</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
<span class="nl">out_write:</span>
	<span class="n">raw3270_request_free</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
<span class="nl">out_pages:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pages</span><span class="o">--</span><span class="p">)</span>
		<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem_pages</span><span class="p">[</span><span class="n">pages</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem_pages</span><span class="p">);</span>
<span class="nl">out_tp:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free tty3270 structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_free_view</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pages</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">kbd_free</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">kbd</span><span class="p">);</span>
	<span class="n">raw3270_request_free</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">kreset</span><span class="p">);</span>
	<span class="n">raw3270_request_free</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
	<span class="n">raw3270_request_free</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pages</span> <span class="o">&lt;</span> <span class="n">TTY3270_STRING_PAGES</span><span class="p">;</span> <span class="n">pages</span><span class="o">++</span><span class="p">)</span>
		<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem_pages</span><span class="p">[</span><span class="n">pages</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem_pages</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate tty3270 screen.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tty3270_alloc_screen</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lines</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270_line</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">lines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lines</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">lines</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270_cell</span><span class="p">)</span> <span class="o">*</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">[</span><span class="n">lines</span><span class="p">].</span><span class="n">cells</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">[</span><span class="n">lines</span><span class="p">].</span><span class="n">cells</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_screen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_screen:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">lines</span><span class="o">--</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">[</span><span class="n">lines</span><span class="p">].</span><span class="n">cells</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">);</span>
<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free tty3270 screen.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_free_screen</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lines</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">lines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lines</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">lines</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">[</span><span class="n">lines</span><span class="p">].</span><span class="n">cells</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Unlink tty3270 data structure from tty.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">raw3270_view</span> <span class="o">*</span><span class="n">view</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty3270</span><span class="p">,</span> <span class="n">view</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">tty_port_tty_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">tty_hangup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">raw3270_put_view</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">);</span>
		<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free tty3270 data structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">raw3270_view</span> <span class="o">*</span><span class="n">view</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty3270</span><span class="p">,</span> <span class="n">view</span><span class="p">);</span>
	<span class="n">tty3270_free_screen</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tty3270_free_view</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Delayed freeing of tty3270 views.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_del_views</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tty3270_max_index</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">raw3270_view</span> <span class="o">*</span><span class="n">view</span> <span class="o">=</span>
			<span class="n">raw3270_find_view</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty3270_fn</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">RAW3270_FIRSTMINOR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">view</span><span class="p">))</span>
			<span class="n">raw3270_del_view</span><span class="p">(</span><span class="n">view</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">raw3270_fn</span> <span class="n">tty3270_fn</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">tty3270_activate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deactivate</span> <span class="o">=</span> <span class="n">tty3270_deactivate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty3270_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">tty3270_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">tty3270_free</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called whenever a 3270 tty is opened.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tty3270_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">raw3270_view</span> <span class="o">*</span><span class="n">view</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Check if the tty3270 is already there. */</span>
	<span class="n">view</span> <span class="o">=</span> <span class="n">raw3270_find_view</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty3270_fn</span><span class="p">,</span>
				  <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">+</span> <span class="n">RAW3270_FIRSTMINOR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">view</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty3270</span><span class="p">,</span> <span class="n">view</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">tp</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">winsize</span><span class="p">.</span><span class="n">ws_row</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">winsize</span><span class="p">.</span><span class="n">ws_col</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">low_latency</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* why to reassign? */</span>
		<span class="n">tty_port_tty_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">inattr</span> <span class="o">=</span> <span class="n">TF_INPUT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty3270_max_index</span> <span class="o">&lt;</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">tty3270_max_index</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Quick exit if there is no device for tty-&gt;index. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">view</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Allocate tty3270 structure on first open. */</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="n">tty3270_alloc_view</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">raw3270_add_view</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty3270_fn</span><span class="p">,</span>
			      <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">+</span> <span class="n">RAW3270_FIRSTMINOR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty3270_free_view</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tty3270_alloc_screen</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">raw3270_put_view</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">);</span>
		<span class="n">raw3270_del_view</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tty_port_tty_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">low_latency</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">tp</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">winsize</span><span class="p">.</span><span class="n">ws_row</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">winsize</span><span class="p">.</span><span class="n">ws_col</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span>

	<span class="n">tty3270_create_prompt</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tty3270_create_status</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tty3270_update_status</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="cm">/* Create blank line for every line in the tty output area. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tty3270_blank_line</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">fn_handler</span><span class="p">[</span><span class="n">KVAL</span><span class="p">(</span><span class="n">K_INCRCONSOLE</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tty3270_exit_tty</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">fn_handler</span><span class="p">[</span><span class="n">KVAL</span><span class="p">(</span><span class="n">K_SCROLLBACK</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tty3270_scroll_backward</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">fn_handler</span><span class="p">[</span><span class="n">KVAL</span><span class="p">(</span><span class="n">K_SCROLLFORW</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tty3270_scroll_forward</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">fn_handler</span><span class="p">[</span><span class="n">KVAL</span><span class="p">(</span><span class="n">K_CONS</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tty3270_rcl_backward</span><span class="p">;</span>
	<span class="n">kbd_ascebc</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">kbd</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">ascebc</span><span class="p">);</span>

	<span class="n">raw3270_activate_view</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called when the 3270 tty is closed. We wait</span>
<span class="cm"> * for the remaining request to be completed. Then we clean up.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">tty_port_tty_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">raw3270_put_view</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We always have room.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tty3270_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">INT_MAX</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Insert character into the screen at the current position with the</span>
<span class="cm"> * current color and highlight. This function does NOT do cursor movement.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tty3270_put_character</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270_line</span> <span class="o">*</span><span class="n">line</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty3270_cell</span> <span class="o">*</span><span class="n">cell</span><span class="p">;</span>

	<span class="n">line</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cell</span> <span class="o">=</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">cells</span> <span class="o">+</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">cell</span><span class="o">-&gt;</span><span class="n">character</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">ascebc</span><span class="p">[</span><span class="sc">&#39; &#39;</span><span class="p">];</span>
			<span class="n">cell</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span><span class="p">;</span>
			<span class="n">cell</span><span class="o">-&gt;</span><span class="n">f_color</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">f_color</span><span class="p">;</span>
			<span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cell</span> <span class="o">=</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">cells</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span>
	<span class="n">cell</span><span class="o">-&gt;</span><span class="n">character</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">ascebc</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">ch</span><span class="p">];</span>
	<span class="n">cell</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span><span class="p">;</span>
	<span class="n">cell</span><span class="o">-&gt;</span><span class="n">f_color</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">f_color</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert a tty3270_line to a 3270 data fragment usable for output.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_convert_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line_nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270_line</span> <span class="o">*</span><span class="n">line</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty3270_cell</span> <span class="o">*</span><span class="n">cell</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">string</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">highlight</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">f_color</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flen</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Determine how long the fragment will be. */</span>
	<span class="n">flen</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>		<span class="cm">/* Prefix (TO_SBA). */</span>
	<span class="n">line</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span> <span class="o">+</span> <span class="n">line_nr</span><span class="p">;</span>
	<span class="n">flen</span> <span class="o">+=</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">highlight</span> <span class="o">=</span> <span class="n">TAX_RESET</span><span class="p">;</span>
	<span class="n">f_color</span> <span class="o">=</span> <span class="n">TAC_RESET</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">cells</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">cell</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">!=</span> <span class="n">highlight</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">flen</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* TO_SA to switch highlight. */</span>
			<span class="n">highlight</span> <span class="o">=</span> <span class="n">cell</span><span class="o">-&gt;</span><span class="n">highlight</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">f_color</span> <span class="o">!=</span> <span class="n">f_color</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">flen</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* TO_SA to switch color. */</span>
			<span class="n">f_color</span> <span class="o">=</span> <span class="n">cell</span><span class="o">-&gt;</span><span class="n">f_color</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">highlight</span> <span class="o">!=</span> <span class="n">TAX_RESET</span><span class="p">)</span>
		<span class="n">flen</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* TO_SA to reset hightlight. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f_color</span> <span class="o">!=</span> <span class="n">TAC_RESET</span><span class="p">)</span>
		<span class="n">flen</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* TO_SA to reset color. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span><span class="p">)</span>
		<span class="n">flen</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* Postfix (TO_RA). */</span>

	<span class="cm">/* Find the line in the list. */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">line_nr</span><span class="p">;</span>
	<span class="n">list_for_each_entry_reverse</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check if the line needs to get reallocated.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="n">flen</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reallocate string. */</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">tty3270_alloc_string</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">flen</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">))</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">);</span>
		<span class="n">free_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">freemem</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write 3270 data fragment. */</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">TO_SBA</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">highlight</span> <span class="o">=</span> <span class="n">TAX_RESET</span><span class="p">;</span>
	<span class="n">f_color</span> <span class="o">=</span> <span class="n">TAC_RESET</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">cells</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">cell</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">!=</span> <span class="n">highlight</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">TO_SA</span><span class="p">;</span>
			<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">TAT_EXTHI</span><span class="p">;</span>
			<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">cell</span><span class="o">-&gt;</span><span class="n">highlight</span><span class="p">;</span>
			<span class="n">highlight</span> <span class="o">=</span> <span class="n">cell</span><span class="o">-&gt;</span><span class="n">highlight</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">f_color</span> <span class="o">!=</span> <span class="n">f_color</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">TO_SA</span><span class="p">;</span>
			<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">TAT_COLOR</span><span class="p">;</span>
			<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">cell</span><span class="o">-&gt;</span><span class="n">f_color</span><span class="p">;</span>
			<span class="n">f_color</span> <span class="o">=</span> <span class="n">cell</span><span class="o">-&gt;</span><span class="n">f_color</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">cell</span><span class="o">-&gt;</span><span class="n">character</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">highlight</span> <span class="o">!=</span> <span class="n">TAX_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">TO_SA</span><span class="p">;</span>
		<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">TAT_EXTHI</span><span class="p">;</span>
		<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">TAX_RESET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f_color</span> <span class="o">!=</span> <span class="n">TAC_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">TO_SA</span><span class="p">;</span>
		<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">TAT_COLOR</span><span class="p">;</span>
		<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">TAC_RESET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">TO_RA</span><span class="p">;</span>
		<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nr_up</span> <span class="o">+</span> <span class="n">line_nr</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Line is currently visible on screen. */</span>
		<span class="n">tty3270_update_string</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">line_nr</span><span class="p">);</span>
		<span class="cm">/* Add line to update list. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">update_flags</span> <span class="o">|=</span> <span class="n">TTY_UPDATE_LIST</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Do carriage return.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Do line feed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_lf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270_line</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tty3270_convert_line</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Last line just filled up. Add new, blank line. */</span>
	<span class="n">tty3270_blank_line</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">temp</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">tty3270_rebuild_update</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_ri</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">tty3270_convert_line</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">);</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Insert characters at current position.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_insert_characters</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270_line</span> <span class="o">*</span><span class="n">line</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">line</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">cells</span><span class="p">[</span><span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">].</span><span class="n">character</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">ascebc</span><span class="p">[</span><span class="sc">&#39; &#39;</span><span class="p">];</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">cells</span><span class="p">[</span><span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">].</span><span class="n">highlight</span> <span class="o">=</span> <span class="n">TAX_RESET</span><span class="p">;</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">cells</span><span class="p">[</span><span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">].</span><span class="n">f_color</span> <span class="o">=</span> <span class="n">TAC_RESET</span><span class="p">;</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span>
	<span class="n">k</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">-</span> <span class="n">n</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">k</span><span class="o">--</span><span class="p">)</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">cells</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">cells</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">+</span> <span class="n">k</span><span class="p">];</span>
	<span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span><span class="p">)</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">cells</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">+</span> <span class="n">n</span><span class="p">].</span><span class="n">character</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">ascebc</span><span class="p">[</span><span class="sc">&#39; &#39;</span><span class="p">];</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">cells</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">+</span> <span class="n">n</span><span class="p">].</span><span class="n">highlight</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span><span class="p">;</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">cells</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">+</span> <span class="n">n</span><span class="p">].</span><span class="n">f_color</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">f_color</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Delete characters at current position.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_delete_characters</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270_line</span> <span class="o">*</span><span class="n">line</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">line</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">cells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">cells</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">];</span>
	<span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Erase characters at current position.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_erase_characters</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270_line</span> <span class="o">*</span><span class="n">line</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty3270_cell</span> <span class="o">*</span><span class="n">cell</span><span class="p">;</span>

	<span class="n">line</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cell</span> <span class="o">=</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">cells</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cell</span><span class="o">-&gt;</span><span class="n">character</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="n">cell</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">=</span> <span class="n">TAX_RESET</span><span class="p">;</span>
		<span class="n">cell</span><span class="o">-&gt;</span><span class="n">f_color</span> <span class="o">=</span> <span class="n">TAC_RESET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Erase line, 3 different cases:</span>
<span class="cm"> *  Esc [ 0 K	Erase from current position to end of line inclusive</span>
<span class="cm"> *  Esc [ 1 K	Erase from beginning of line to current position inclusive</span>
<span class="cm"> *  Esc [ 2 K	Erase entire line (without moving cursor)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_erase_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270_line</span> <span class="o">*</span><span class="n">line</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty3270_cell</span> <span class="o">*</span><span class="n">cell</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">line</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cell</span> <span class="o">=</span> <span class="n">line</span><span class="o">-&gt;</span><span class="n">cells</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">cell</span><span class="o">-&gt;</span><span class="n">character</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
			<span class="n">cell</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">=</span> <span class="n">TAX_RESET</span><span class="p">;</span>
			<span class="n">cell</span><span class="o">-&gt;</span><span class="n">f_color</span> <span class="o">=</span> <span class="n">TAC_RESET</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">)</span>
			<span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">line</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tty3270_convert_line</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Erase display, 3 different cases:</span>
<span class="cm"> *  Esc [ 0 J	Erase from current position to bottom of screen inclusive</span>
<span class="cm"> *  Esc [ 1 J	Erase from top of screen to current position inclusive</span>
<span class="cm"> *  Esc [ 2 J	Erase entire screen (without moving the cursor)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_erase_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty3270_erase_line</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tty3270_convert_line</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tty3270_convert_line</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tty3270_erase_line</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tty3270_convert_line</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">tty3270_rebuild_update</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set attributes found in an escape sequence.</span>
<span class="cm"> *  Esc [ &lt;attr&gt; ; &lt;attr&gt; ; ... m</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_set_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">f_colors</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">TAC_DEFAULT</span><span class="p">,</span> <span class="n">TAC_RED</span><span class="p">,</span> <span class="n">TAC_GREEN</span><span class="p">,</span> <span class="n">TAC_YELLOW</span><span class="p">,</span> <span class="n">TAC_BLUE</span><span class="p">,</span>
		<span class="n">TAC_PINK</span><span class="p">,</span> <span class="n">TAC_TURQ</span><span class="p">,</span> <span class="n">TAC_WHITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TAC_DEFAULT</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">attr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_npar</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">attr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_par</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/* Reset */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">=</span> <span class="n">TAX_RESET</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">f_color</span> <span class="o">=</span> <span class="n">TAC_RESET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Highlight. */</span>
		<span class="k">case</span> <span class="mi">4</span>:		<span class="cm">/* Start underlining. */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">=</span> <span class="n">TAX_UNDER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:		<span class="cm">/* Start blink. */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">=</span> <span class="n">TAX_BLINK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7</span>:		<span class="cm">/* Start reverse. */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">=</span> <span class="n">TAX_REVER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">24</span>:	<span class="cm">/* End underlining */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">==</span> <span class="n">TAX_UNDER</span><span class="p">)</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">=</span> <span class="n">TAX_RESET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">25</span>:	<span class="cm">/* End blink. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">==</span> <span class="n">TAX_BLINK</span><span class="p">)</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">=</span> <span class="n">TAX_RESET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">27</span>:	<span class="cm">/* End reverse. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">==</span> <span class="n">TAX_REVER</span><span class="p">)</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">=</span> <span class="n">TAX_RESET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Foreground color. */</span>
		<span class="k">case</span> <span class="mi">30</span>:	<span class="cm">/* Black */</span>
		<span class="k">case</span> <span class="mi">31</span>:	<span class="cm">/* Red */</span>
		<span class="k">case</span> <span class="mi">32</span>:	<span class="cm">/* Green */</span>
		<span class="k">case</span> <span class="mi">33</span>:	<span class="cm">/* Yellow */</span>
		<span class="k">case</span> <span class="mi">34</span>:	<span class="cm">/* Blue */</span>
		<span class="k">case</span> <span class="mi">35</span>:	<span class="cm">/* Magenta */</span>
		<span class="k">case</span> <span class="mi">36</span>:	<span class="cm">/* Cyan */</span>
		<span class="k">case</span> <span class="mi">37</span>:	<span class="cm">/* White */</span>
		<span class="k">case</span> <span class="mi">39</span>:	<span class="cm">/* Black */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">f_color</span> <span class="o">=</span> <span class="n">f_colors</span><span class="p">[</span><span class="n">attr</span> <span class="o">-</span> <span class="mi">30</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">tty3270_getpar</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_par</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_par</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_goto_xy</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_cx</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cx</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">max_cy</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cy</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_cx</span><span class="p">);</span>
	<span class="n">cy</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="n">max_cy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cy</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty3270_convert_line</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span> <span class="o">=</span> <span class="n">cy</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process escape sequences. Known sequences:</span>
<span class="cm"> *  Esc 7			Save Cursor Position</span>
<span class="cm"> *  Esc 8			Restore Cursor Position</span>
<span class="cm"> *  Esc [ Pn ; Pn ; .. m	Set attributes</span>
<span class="cm"> *  Esc [ Pn ; Pn H		Cursor Position</span>
<span class="cm"> *  Esc [ Pn ; Pn f		Cursor Position</span>
<span class="cm"> *  Esc [ Pn A			Cursor Up</span>
<span class="cm"> *  Esc [ Pn B			Cursor Down</span>
<span class="cm"> *  Esc [ Pn C			Cursor Forward</span>
<span class="cm"> *  Esc [ Pn D			Cursor Backward</span>
<span class="cm"> *  Esc [ Pn G			Cursor Horizontal Absolute</span>
<span class="cm"> *  Esc [ Pn X			Erase Characters</span>
<span class="cm"> *  Esc [ Ps J			Erase in Display</span>
<span class="cm"> *  Esc [ Ps K			Erase in Line</span>
<span class="cm"> * // FIXME: add all the new ones.</span>
<span class="cm"> *</span>
<span class="cm"> *  Pn is a numeric parameter, a string of zero or more decimal digits.</span>
<span class="cm"> *  Ps is a selective parameter.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_escape_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="p">{</span> <span class="n">ESnormal</span><span class="p">,</span> <span class="n">ESesc</span><span class="p">,</span> <span class="n">ESsquare</span><span class="p">,</span> <span class="n">ESgetpars</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_state</span> <span class="o">==</span> <span class="n">ESnormal</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mh">0x1b</span><span class="p">)</span>
			<span class="cm">/* Starting new escape sequence. */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_state</span> <span class="o">=</span> <span class="n">ESesc</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_state</span> <span class="o">==</span> <span class="n">ESesc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_state</span> <span class="o">=</span> <span class="n">ESnormal</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;[&#39;</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_state</span> <span class="o">=</span> <span class="n">ESsquare</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;E&#39;</span>:
			<span class="n">tty3270_cr</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="n">tty3270_lf</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;M&#39;</span>:
			<span class="n">tty3270_ri</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;D&#39;</span>:
			<span class="n">tty3270_lf</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;Z&#39;</span>:		<span class="cm">/* Respond ID. */</span>
			<span class="n">kbd_puts_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[?6c&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;7&#39;</span>:		<span class="cm">/* Save cursor position. */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_cx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_cy</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_highlight</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_f_color</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">f_color</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;8&#39;</span>:		<span class="cm">/* Restore cursor position. */</span>
			<span class="n">tty3270_convert_line</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">);</span>
			<span class="n">tty3270_goto_xy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_cx</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_cy</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_highlight</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">f_color</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_f_color</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;c&#39;</span>:		<span class="cm">/* Reset terminal. */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_cy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_highlight</span> <span class="o">=</span> <span class="n">TAX_RESET</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">f_color</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_f_color</span> <span class="o">=</span> <span class="n">TAC_RESET</span><span class="p">;</span>
			<span class="n">tty3270_erase_display</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_state</span> <span class="o">==</span> <span class="n">ESsquare</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_state</span> <span class="o">=</span> <span class="n">ESgetpars</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_par</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_par</span><span class="p">));</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_npar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_ques</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_ques</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_state</span> <span class="o">==</span> <span class="n">ESgetpars</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;;&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_npar</span> <span class="o">&lt;</span> <span class="n">ESCAPE_NPAR</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_npar</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_par</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_npar</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_par</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_npar</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ch</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_state</span> <span class="o">=</span> <span class="n">ESnormal</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;n&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_ques</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>		<span class="cm">/* Status report. */</span>
			<span class="n">kbd_puts_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[0n&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Cursor report. */</span>
			<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[%d;%dR&quot;</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">kbd_puts_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_ques</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:
		<span class="n">tty3270_set_attributes</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;H&#39;</span>:	<span class="cm">/* Set cursor position. */</span>
	<span class="k">case</span> <span class="sc">&#39;f&#39;</span>:
		<span class="n">tty3270_goto_xy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tty3270_getpar</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">tty3270_getpar</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:	<span class="cm">/* Set y position. */</span>
		<span class="n">tty3270_goto_xy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">,</span> <span class="n">tty3270_getpar</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;A&#39;</span>:	<span class="cm">/* Cursor up. */</span>
	<span class="k">case</span> <span class="sc">&#39;F&#39;</span>:
		<span class="n">tty3270_goto_xy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span> <span class="o">-</span> <span class="n">tty3270_getpar</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;B&#39;</span>:	<span class="cm">/* Cursor down. */</span>
	<span class="k">case</span> <span class="sc">&#39;e&#39;</span>:
	<span class="k">case</span> <span class="sc">&#39;E&#39;</span>:
		<span class="n">tty3270_goto_xy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span> <span class="o">+</span> <span class="n">tty3270_getpar</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;C&#39;</span>:	<span class="cm">/* Cursor forward. */</span>
	<span class="k">case</span> <span class="sc">&#39;a&#39;</span>:
		<span class="n">tty3270_goto_xy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">+</span> <span class="n">tty3270_getpar</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;D&#39;</span>:	<span class="cm">/* Cursor backward. */</span>
		<span class="n">tty3270_goto_xy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">-</span> <span class="n">tty3270_getpar</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;G&#39;</span>:	<span class="cm">/* Set x position. */</span>
	<span class="k">case</span> <span class="sc">&#39;`&#39;</span>:
		<span class="n">tty3270_goto_xy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tty3270_getpar</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;X&#39;</span>:	<span class="cm">/* Erase Characters. */</span>
		<span class="n">tty3270_erase_characters</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tty3270_getpar</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;J&#39;</span>:	<span class="cm">/* Erase display. */</span>
		<span class="n">tty3270_erase_display</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;K&#39;</span>:	<span class="cm">/* Erase line. */</span>
		<span class="n">tty3270_erase_line</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;P&#39;</span>:	<span class="cm">/* Delete characters. */</span>
		<span class="n">tty3270_delete_characters</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tty3270_getpar</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;@&#39;</span>:	<span class="cm">/* Insert characters. */</span>
		<span class="n">tty3270_insert_characters</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tty3270_getpar</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:	<span class="cm">/* Save cursor position. */</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_cx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_cy</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_highlight</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_f_color</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">f_color</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;u&#39;</span>:	<span class="cm">/* Restore cursor position. */</span>
		<span class="n">tty3270_convert_line</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">);</span>
		<span class="n">tty3270_goto_xy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_cx</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_cy</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">highlight</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_highlight</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">f_color</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_f_color</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * String write routine for 3270 ttys</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_do_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i_msg</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i_msg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span> <span class="n">i_msg</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i_msg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">esc_state</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Continue escape sequence. */</span>
			<span class="n">tty3270_escape_sequence</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i_msg</span><span class="p">]);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i_msg</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x07</span>:		<span class="cm">/* &#39;\a&#39; -- Alarm */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">wcc</span> <span class="o">|=</span> <span class="n">TW_PLUSALARM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08</span>:		<span class="cm">/* Backspace. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="o">--</span><span class="p">;</span>
				<span class="n">tty3270_put_character</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x09</span>:		<span class="cm">/* &#39;\t&#39; -- Tabulate */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">&gt;=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tty3270_cr</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
					<span class="n">tty3270_lf</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">tty3270_put_character</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0a</span>:		<span class="cm">/* &#39;\n&#39; -- New Line */</span>
			<span class="n">tty3270_cr</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="n">tty3270_lf</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0c</span>:		<span class="cm">/* &#39;\f&#39; -- Form Feed */</span>
			<span class="n">tty3270_erase_display</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0d</span>:		<span class="cm">/* &#39;\r&#39; -- Carriage Return */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0f</span>:		<span class="cm">/* SuSE &quot;exit alternate mode&quot; */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1b</span>:		<span class="cm">/* Start escape sequence. */</span>
			<span class="n">tty3270_escape_sequence</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i_msg</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>		<span class="cm">/* Insert normal character. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span> <span class="o">&gt;=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">cols</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tty3270_cr</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
				<span class="n">tty3270_lf</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">tty3270_put_character</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i_msg</span><span class="p">]);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Convert current line to 3270 data fragment. */</span>
	<span class="n">tty3270_convert_line</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">);</span>

	<span class="cm">/* Setup timer to update display after 1/10 second */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">))</span>
		<span class="n">tty3270_set_timer</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * String write routine for 3270 ttys</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tty3270_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">,</span>
	      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">char_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty3270_do_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">char_buf</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">char_count</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">char_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tty3270_do_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Put single characters to the ttys character buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tty3270_put_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span> <span class="o">||</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">char_count</span> <span class="o">&gt;=</span> <span class="n">TTY3270_CHAR_BUF_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">char_buf</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">char_count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Flush all characters from the ttys characeter buffer put there</span>
<span class="cm"> * by tty3270_put_char.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_flush_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">char_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty3270_do_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">char_buf</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">char_count</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">char_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns the number of characters in the output buffer. This is</span>
<span class="cm"> * used in tty_wait_until_sent to wait until all characters have</span>
<span class="cm"> * appeared on the screen.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tty3270_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check for visible/invisible input switches</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">L_ICANON</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">?</span> <span class="n">TF_INPUT</span><span class="o">:</span> <span class="n">TF_INPUTN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">inattr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">inattr</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
			<span class="n">tty3270_update_prompt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">tty3270_set_timer</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Disable reading from a 3270 tty</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">throttle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enable reading from a 3270 tty</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">throttle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">attn</span><span class="p">)</span>
		<span class="n">tty3270_issue_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Hang up the tty device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>FIXME: implement</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tty3270_wait_until_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tty3270_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">kbd_ioctl</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">kbd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">tty3270_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty3270</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">kbd_ioctl</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">kbd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">tty3270_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">tty3270_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">tty3270_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">tty3270_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_char</span> <span class="o">=</span> <span class="n">tty3270_put_char</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_chars</span> <span class="o">=</span> <span class="n">tty3270_flush_chars</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">tty3270_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">tty3270_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span> <span class="o">=</span> <span class="n">tty3270_flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span> <span class="n">tty3270_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">tty3270_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hangup</span> <span class="o">=</span> <span class="n">tty3270_hangup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_until_sent</span> <span class="o">=</span> <span class="n">tty3270_wait_until_sent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">tty3270_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span> <span class="n">tty3270_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">tty3270_set_termios</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * 3270 tty registration code called from tty_init().</span>
<span class="cm"> * Most kernel services (incl. kmalloc) are available at this poimt.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tty3270_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">driver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">RAW3270_MAXDEVS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the tty_driver structure</span>
<span class="cm">	 * Entries in tty3270_driver that are NOT initialized:</span>
<span class="cm">	 * proc_entry, set_termios, flush_buffer, set_ldisc, write_proc</span>
<span class="cm">	 */</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;ttyTUB&quot;</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ttyTUB&quot;</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">IBM_TTY3270_MAJOR</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="n">RAW3270_FIRSTMINOR</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_SYSTEM</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">SYSTEM_TYPE_TTY</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_RESET_TERMIOS</span> <span class="o">|</span> <span class="n">TTY_DRIVER_DYNAMIC_DEV</span><span class="p">;</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty3270_ops</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">tty_register_driver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tty3270_driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">tty3270_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>

	<span class="n">driver</span> <span class="o">=</span> <span class="n">tty3270_driver</span><span class="p">;</span>
	<span class="n">tty3270_driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
	<span class="n">tty3270_del_views</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_CHARDEV_MAJOR</span><span class="p">(</span><span class="n">IBM_TTY3270_MAJOR</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">tty3270_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">tty3270_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
