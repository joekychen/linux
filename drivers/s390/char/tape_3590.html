<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › char › tape_3590.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tape_3590.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  drivers/s390/char/tape_3590.c</span>
<span class="cm"> *    tape device discipline for 3590 tapes.</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright IBM Corp. 2001, 2009</span>
<span class="cm"> *    Author(s): Stefan Bader &lt;shbader@de.ibm.com&gt;</span>
<span class="cm"> *		 Michael Holzheu &lt;holzheu@de.ibm.com&gt;</span>
<span class="cm"> *		 Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;tape_3590&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bio.h&gt;</span>
<span class="cp">#include &lt;asm/ebcdic.h&gt;</span>

<span class="cp">#define TAPE_DBF_AREA	tape_3590_dbf</span>
<span class="cp">#define BUFSIZE 512	</span><span class="cm">/* size of buffers for dynamic generated messages */</span><span class="cp"></span>

<span class="cp">#include &quot;tape.h&quot;</span>
<span class="cp">#include &quot;tape_std.h&quot;</span>
<span class="cp">#include &quot;tape_3590.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">tape_3590_wq</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Pointer to debug area.</span>
<span class="cm"> */</span>
<span class="n">debug_info_t</span> <span class="o">*</span><span class="n">TAPE_DBF_AREA</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">TAPE_DBF_AREA</span><span class="p">);</span>

<span class="cm">/*******************************************************************</span>
<span class="cm"> * Error Recovery functions:</span>
<span class="cm"> * - Read Opposite:		 implemented</span>
<span class="cm"> * - Read Device (buffered) log: BRA</span>
<span class="cm"> * - Read Library log:		 BRA</span>
<span class="cm"> * - Swap Devices:		 BRA</span>
<span class="cm"> * - Long Busy:			 implemented</span>
<span class="cm"> * - Special Intercept:		 BRA</span>
<span class="cm"> * - Read Alternate:		 implemented</span>
<span class="cm"> *******************************************************************/</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tape_3590_msg</span><span class="p">[</span><span class="n">TAPE_3590_MAX_MSG</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Lost Sense&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Assigned Elsewhere&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x12</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Allegiance Reset&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Shared Access Violation&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x20</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Command Reject&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x21</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Configuration Error&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x22</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Protection Exception&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x23</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Write Protect&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x24</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Write Length&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x25</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Read-Only Format&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x31</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Beginning of Partition&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x33</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;End of Partition&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x34</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;End of Data&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x35</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Block not found&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x40</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Device Intervention&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x41</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Loader Intervention&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x42</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Library Intervention&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x50</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Write Error&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x51</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Erase Error&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x52</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Formatting Error&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x53</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Read Error&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x54</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Unsupported Format&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x55</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;No Formatting&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x56</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Positioning lost&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x57</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Read Length&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x60</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Unsupported Medium&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x61</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Medium Length Error&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x62</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Medium removed&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x64</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Load Check&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x65</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Unload Check&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x70</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Equipment Check&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x71</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Bus out Check&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x72</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Protocol Error&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x73</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Interface Error&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x74</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Overrun&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x75</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Halt Signal&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x90</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Device fenced&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x91</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Device Path fenced&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Volume misplaced&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Volume inaccessible&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa2</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Volume in input&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa3</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Volume ejected&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa4</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;All categories reserved&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa5</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Duplicate Volume&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa6</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Library Manager Offline&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa7</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Library Output Station full&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa8</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Vision System non-operational&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa9</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Library Manager Equipment Check&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xaa</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Library Equipment Check&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xab</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;All Library Cells full&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xac</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;No Cleaner Volumes in Library&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xad</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;I/O Station door open&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xae</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Subsystem environmental alert&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">crypt_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">TAPE390_CRYPT_SUPPORTED</span><span class="p">(</span><span class="n">TAPE_3590_CRYPT_INFO</span><span class="p">(</span><span class="n">device</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">crypt_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">TAPE390_CRYPT_ON</span><span class="p">(</span><span class="n">TAPE_3590_CRYPT_INFO</span><span class="p">(</span><span class="n">device</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext_to_int_kekl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape390_kekl</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">tape3592_kekl</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">out</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TAPE390_KEKL_TYPE_HASH</span><span class="p">)</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">type_on_tape</span> <span class="o">==</span> <span class="n">TAPE390_KEKL_TYPE_HASH</span><span class="p">)</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">out</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">out</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	<span class="n">ASCEBC</span><span class="p">(</span><span class="n">out</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">out</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">int_to_ext_kekl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape3592_kekl</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">tape390_kekl</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">out</span><span class="p">));</span>
	<span class="k">if</span><span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TAPE390_KEKL_TYPE_HASH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TAPE390_KEKL_TYPE_LABEL</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">type_on_tape</span> <span class="o">=</span> <span class="n">TAPE390_KEKL_TYPE_HASH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">type_on_tape</span> <span class="o">=</span> <span class="n">TAPE390_KEKL_TYPE_LABEL</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">out</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">));</span>
	<span class="n">EBCASC</span><span class="p">(</span><span class="n">out</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">));</span>
	<span class="n">strim</span><span class="p">(</span><span class="n">out</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">int_to_ext_kekl_pair</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape3592_kekl_pair</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">tape390_kekl_pair</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">kekl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">TAPE390_KEKL_TYPE_NONE</span><span class="p">;</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">kekl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type_on_tape</span> <span class="o">=</span> <span class="n">TAPE390_KEKL_TYPE_NONE</span><span class="p">;</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">kekl</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">TAPE390_KEKL_TYPE_NONE</span><span class="p">;</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">kekl</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type_on_tape</span> <span class="o">=</span> <span class="n">TAPE390_KEKL_TYPE_NONE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">int_to_ext_kekl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">kekl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">out</span><span class="o">-&gt;</span><span class="n">kekl</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">kekl</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">TAPE390_KEKL_TYPE_NONE</span><span class="p">;</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">kekl</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type_on_tape</span> <span class="o">=</span> <span class="n">TAPE390_KEKL_TYPE_NONE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">int_to_ext_kekl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">kekl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">out</span><span class="o">-&gt;</span><span class="n">kekl</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">int_to_ext_kekl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">kekl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">out</span><span class="o">-&gt;</span><span class="n">kekl</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Invalid KEKL number: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_ext_kekl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape390_kekl</span> <span class="o">*</span><span class="n">kekl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kekl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TAPE390_KEKL_TYPE_NONE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kekl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&gt;</span> <span class="n">TAPE390_KEKL_TYPE_HASH</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kekl</span><span class="o">-&gt;</span><span class="n">type_on_tape</span> <span class="o">==</span> <span class="n">TAPE390_KEKL_TYPE_NONE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kekl</span><span class="o">-&gt;</span><span class="n">type_on_tape</span> <span class="o">&gt;</span> <span class="n">TAPE390_KEKL_TYPE_HASH</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">kekl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TAPE390_KEKL_TYPE_HASH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">kekl</span><span class="o">-&gt;</span><span class="n">type_on_tape</span> <span class="o">==</span> <span class="n">TAPE390_KEKL_TYPE_LABEL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">invalid:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_ext_kekl_pair</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape390_kekl_pair</span> <span class="o">*</span><span class="n">kekls</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_ext_kekl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kekls</span><span class="o">-&gt;</span><span class="n">kekl</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_ext_kekl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kekls</span><span class="o">-&gt;</span><span class="n">kekl</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
		<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">invalid:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Query KEKLs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tape_3592_kekl_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">tape390_kekl_pair</span> <span class="o">*</span><span class="n">ext_kekls</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tape3592_kekl_query_order</span> <span class="o">*</span><span class="n">order</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tape3592_kekl_query_data</span> <span class="o">*</span><span class="n">int_kekls</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;tape3592_kekl_query</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">int_kekls</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">int_kekls</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="o">|</span><span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">int_kekls</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">order</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_malloc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">order</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">order</span><span class="p">));</span>
	<span class="n">order</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mh">0xe2</span><span class="p">;</span>
	<span class="n">order</span><span class="o">-&gt;</span><span class="n">max_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_KEKL_QUERY</span><span class="p">;</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">PERF_SUBSYS_FUNC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">order</span><span class="p">),</span> <span class="n">order</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">READ_SS_DATA</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">int_kekls</span><span class="p">),</span>
		     <span class="n">int_kekls</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_do_io</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_request</span><span class="p">;</span>
	<span class="n">int_to_ext_kekl_pair</span><span class="p">(</span><span class="o">&amp;</span><span class="n">int_kekls</span><span class="o">-&gt;</span><span class="n">kekls</span><span class="p">,</span> <span class="n">ext_kekls</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail_request:</span>
	<span class="n">tape_free_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="nl">fail_malloc:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">int_kekls</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IOCTL: Query KEKLs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tape_3592_ioctl_kekl_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tape390_kekl_pair</span> <span class="o">*</span><span class="n">ext_kekls</span><span class="p">;</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;tape_3592_ioctl_kekl_query</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crypt_supported</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crypt_enabled</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EUNATCH</span><span class="p">;</span>
	<span class="n">ext_kekls</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ext_kekls</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext_kekls</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_3592_kekl_query</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ext_kekls</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="n">ext_kekls</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ext_kekls</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ext_kekls</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">tape_3590_mttell</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Set KEKLs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tape_3592_kekl_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">tape390_kekl_pair</span> <span class="o">*</span><span class="n">ext_kekls</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tape3592_kekl_set_order</span> <span class="o">*</span><span class="n">order</span><span class="p">;</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;tape3592_kekl_set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_ext_kekl_pair</span><span class="p">(</span><span class="n">ext_kekls</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;invalid kekls</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tape_3590_mttell</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADSLT</span><span class="p">;</span>
	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">order</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">order</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">order</span><span class="p">));</span>
	<span class="n">order</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mh">0xe3</span><span class="p">;</span>
	<span class="n">order</span><span class="o">-&gt;</span><span class="n">kekls</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ext_to_int_kekl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext_kekls</span><span class="o">-&gt;</span><span class="n">kekl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">kekls</span><span class="p">.</span><span class="n">kekl</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">ext_to_int_kekl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext_kekls</span><span class="o">-&gt;</span><span class="n">kekl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">kekls</span><span class="p">.</span><span class="n">kekl</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_KEKL_SET</span><span class="p">;</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">PERF_SUBSYS_FUNC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">order</span><span class="p">),</span> <span class="n">order</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tape_do_io_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IOCTL: Set KEKLs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tape_3592_ioctl_kekl_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tape390_kekl_pair</span> <span class="o">*</span><span class="n">ext_kekls</span><span class="p">;</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;tape_3592_ioctl_kekl_set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crypt_supported</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crypt_enabled</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EUNATCH</span><span class="p">;</span>
	<span class="n">ext_kekls</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ext_kekls</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext_kekls</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">ext_kekls</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ext_kekls</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_3592_kekl_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ext_kekls</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ext_kekls</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enable encryption</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="nf">__tape_3592_enable_crypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;tape_3592_enable_crypt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crypt_supported</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOSYS</span><span class="p">);</span>
	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">72</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">request</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">72</span><span class="p">);</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>       <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">36</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">36</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">36</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">36</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">36</span> <span class="o">+</span> <span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2f</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">36</span> <span class="o">+</span> <span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xc3</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">36</span> <span class="o">+</span> <span class="mi">35</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x72</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_CRYPT_ON</span><span class="p">;</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_CB</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MODE_SET_CB</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="mi">36</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">request</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tape_3592_enable_crypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">__tape_3592_enable_crypt</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tape_do_io_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tape_3592_enable_crypt_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">__tape_3592_enable_crypt</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="n">tape_do_io_async_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Disable encryption</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="nf">__tape_3592_disable_crypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;tape_3592_disable_crypt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crypt_supported</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOSYS</span><span class="p">);</span>
	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">72</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">request</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">72</span><span class="p">);</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>       <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">36</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">36</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">36</span> <span class="o">+</span> <span class="mi">35</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x32</span><span class="p">;</span>

	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_CRYPT_OFF</span><span class="p">;</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_CB</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MODE_SET_CB</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="mi">36</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">request</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tape_3592_disable_crypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">__tape_3592_disable_crypt</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tape_do_io_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tape_3592_disable_crypt_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">__tape_3592_disable_crypt</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="n">tape_do_io_async_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IOCTL: Set encryption status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tape_3592_ioctl_crypt_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape390_crypt_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;tape_3592_ioctl_crypt_set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crypt_supported</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TAPE390_CRYPT_ON_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TAPE390_CRYPT_ON_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tape_3592_enable_crypt</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">tape_3592_disable_crypt</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">tape_3590_sense_medium</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * IOCTL: Query enryption status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tape_3592_ioctl_crypt_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;tape_3592_ioctl_crypt_query</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crypt_supported</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="n">tape_3590_sense_medium</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TAPE_3590_CRYPT_INFO</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">TAPE_3590_CRYPT_INFO</span><span class="p">(</span><span class="n">device</span><span class="p">))))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * 3590 IOCTL Overload</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TAPE390_DISPLAY</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">display_struct</span> <span class="n">disp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disp</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">disp</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">tape_std_display</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">TAPE390_KEKL_SET</span>:
		<span class="k">return</span> <span class="n">tape_3592_ioctl_kekl_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TAPE390_KEKL_QUERY</span>:
		<span class="k">return</span> <span class="n">tape_3592_ioctl_kekl_query</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TAPE390_CRYPT_SET</span>:
		<span class="k">return</span> <span class="n">tape_3592_ioctl_crypt_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TAPE390_CRYPT_QUERY</span>:
		<span class="k">return</span> <span class="n">tape_3592_ioctl_crypt_query</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/* no additional ioctls */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SENSE Medium: Get Sense data about medium state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tape_3590_sense_medium</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_MSEN</span><span class="p">;</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MEDIUM_SENSE</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tape_do_io_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tape_3590_sense_medium_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_MSEN</span><span class="p">;</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MEDIUM_SENSE</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">);</span>
	<span class="n">tape_do_io_async_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTTELL: Tell block. Return the number of block relative to current file.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_mttell</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u64</span> <span class="n">block_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_std_read_block_id</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">block_id</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTSEEK: seek to the specified block.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_mtseek</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;xsee id: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_LBL</span><span class="p">;</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LOCATE</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tape_do_io_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read Opposite Error Recovery Function:</span>
<span class="cm"> * Used, when Read Forward does not work</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tape_3590_read_opposite</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_3590_disc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have allocated 4 ccws in tape_std_read, so we can now</span>
<span class="cm">	 * transform the request to a read backward, followed by a</span>
<span class="cm">	 * forward space block.</span>
<span class="cm">	 */</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_RBA</span><span class="p">;</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">discdata</span><span class="p">;</span>
	<span class="n">tape_ccw_cc_idal</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">read_back_op</span><span class="p">,</span>
			 <span class="n">device</span><span class="o">-&gt;</span><span class="n">char_data</span><span class="p">.</span><span class="n">idal_buf</span><span class="p">);</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">FORSPACEBLOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;xrop ccwg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read Attention Msg</span>
<span class="cm"> * This should be done after an interrupt with attention bit (0x80)</span>
<span class="cm"> * in device state.</span>
<span class="cm"> *</span>
<span class="cm"> * After a &quot;read attention message&quot; request there are two possible</span>
<span class="cm"> * results:</span>
<span class="cm"> *</span>
<span class="cm"> * 1. A unit check is presented, when attention sense is present (e.g. when</span>
<span class="cm"> * a medium has been unloaded). The attention sense comes then</span>
<span class="cm"> * together with the unit check. The recovery action is either &quot;retry&quot;</span>
<span class="cm"> * (in case there is an attention message pending) or &quot;permanent error&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * 2. The attention msg is written to the &quot;read subsystem data&quot; buffer.</span>
<span class="cm"> * In this case we probably should print it to the console.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tape_3590_read_attmsg_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_READ_ATTMSG</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PREP_RD_SS_DATA</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_ATTMSG</span><span class="p">;</span>	<span class="cm">/* read att msg */</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">PERFORM_SS_FUNC</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">READ_SS_DATA</span><span class="p">,</span> <span class="mi">4096</span> <span class="o">-</span> <span class="mi">12</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">tape_do_io_async_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * These functions are used to schedule follow-up actions from within an</span>
<span class="cm"> * interrupt context (like unsolicited interrupts).</span>
<span class="cm"> * Note: the work handler is called by the system work queue. The tape</span>
<span class="cm"> * commands started by the handler need to be asynchrounous, otherwise</span>
<span class="cm"> * a deadlock can occur e.g. in case of a deferred cc=1 (see __tape_do_irq).</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">work_handler_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">tape_op</span>        <span class="n">op</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>  <span class="n">work</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tape_3590_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">work_handler_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">work_handler_data</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TO_MSEN</span>:
		<span class="n">tape_3590_sense_medium_async</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TO_READ_ATTMSG</span>:
		<span class="n">tape_3590_read_attmsg_async</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TO_CRYPT_ON</span>:
		<span class="n">tape_3592_enable_crypt_async</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TO_CRYPT_OFF</span>:
		<span class="n">tape_3592_disable_crypt_async</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;T3590: work handler undefined for &quot;</span>
			  <span class="s">&quot;operation 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tape_put_device</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_schedule_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">enum</span> <span class="n">tape_op</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">work_handler_data</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">tape_3590_work_handler</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">tape_get_device</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">tape_3590_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tape_3590_med_state_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">tape_3590_med_sense</span> <span class="o">*</span><span class="n">sense</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape390_crypt_info</span> <span class="o">*</span><span class="n">c_info</span><span class="p">;</span>

	<span class="n">c_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">TAPE_3590_CRYPT_INFO</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;medium state: %x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">macst</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">masst</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">macst</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x04</span>:
	<span class="k">case</span> <span class="mh">0x05</span>:
	<span class="k">case</span> <span class="mh">0x06</span>:
		<span class="n">tape_med_state_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MS_UNLOADED</span><span class="p">);</span>
		<span class="n">TAPE_3590_CRYPT_INFO</span><span class="p">(</span><span class="n">device</span><span class="p">).</span><span class="n">medium_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x08</span>:
	<span class="k">case</span> <span class="mh">0x09</span>:
		<span class="n">tape_med_state_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MS_LOADED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">tape_med_state_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MS_UNKNOWN</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">c_info</span><span class="o">-&gt;</span><span class="n">medium_status</span> <span class="o">|=</span> <span class="n">TAPE390_MEDIUM_LOADED_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSENSE_CRYPT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;Medium is encrypted (%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">c_info</span><span class="o">-&gt;</span><span class="n">medium_status</span> <span class="o">|=</span> <span class="n">TAPE390_MEDIUM_ENCRYPTED_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>	<span class="p">{</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;Medium is not encrypted %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">c_info</span><span class="o">-&gt;</span><span class="n">medium_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TAPE390_MEDIUM_ENCRYPTED_MASK</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The done handler is called at device/channel end and wakes up the sleeping</span>
<span class="cm"> * process</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;%s done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tape_op_verbose</span><span class="p">[</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">]);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TO_BSB</span>:
	<span class="k">case</span> <span class="n">TO_BSF</span>:
	<span class="k">case</span> <span class="n">TO_DSE</span>:
	<span class="k">case</span> <span class="n">TO_FSB</span>:
	<span class="k">case</span> <span class="n">TO_FSF</span>:
	<span class="k">case</span> <span class="n">TO_LBL</span>:
	<span class="k">case</span> <span class="n">TO_RFO</span>:
	<span class="k">case</span> <span class="n">TO_RBA</span>:
	<span class="k">case</span> <span class="n">TO_REW</span>:
	<span class="k">case</span> <span class="n">TO_WRI</span>:
	<span class="k">case</span> <span class="n">TO_WTM</span>:
	<span class="k">case</span> <span class="n">TO_BLOCK</span>:
	<span class="k">case</span> <span class="n">TO_LOAD</span>:
		<span class="n">tape_med_state_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MS_LOADED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TO_RUN</span>:
		<span class="n">tape_med_state_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MS_UNLOADED</span><span class="p">);</span>
		<span class="n">tape_3590_schedule_work</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">TO_CRYPT_OFF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TO_MSEN</span>:
		<span class="n">tape_3590_med_state_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TO_CRYPT_ON</span>:
		<span class="n">TAPE_3590_CRYPT_INFO</span><span class="p">(</span><span class="n">device</span><span class="p">).</span><span class="n">status</span>
			<span class="o">|=</span> <span class="n">TAPE390_CRYPT_ON_MASK</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">)</span> <span class="o">|=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TO_CRYPT_OFF</span>:
		<span class="n">TAPE_3590_CRYPT_INFO</span><span class="p">(</span><span class="n">device</span><span class="p">).</span><span class="n">status</span>
			<span class="o">&amp;=</span> <span class="o">~</span><span class="n">TAPE390_CRYPT_ON_MASK</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TO_RBI</span>:	<span class="cm">/* RBI seems to succeed even without medium loaded. */</span>
	<span class="k">case</span> <span class="n">TO_NOP</span>:	<span class="cm">/* Same to NOP. */</span>
	<span class="k">case</span> <span class="n">TO_READ_CONFIG</span>:
	<span class="k">case</span> <span class="n">TO_READ_ATTMSG</span>:
	<span class="k">case</span> <span class="n">TO_DIS</span>:
	<span class="k">case</span> <span class="n">TO_ASSIGN</span>:
	<span class="k">case</span> <span class="n">TO_UNASSIGN</span>:
	<span class="k">case</span> <span class="n">TO_SIZE</span>:
	<span class="k">case</span> <span class="n">TO_KEKL_SET</span>:
	<span class="k">case</span> <span class="n">TO_KEKL_QUERY</span>:
	<span class="k">case</span> <span class="n">TO_RDC</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">TAPE_IO_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is called, when error recovery was successful</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">tape_3590_erp_succeded</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;Error Recovery successful for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">tape_op_verbose</span><span class="p">[</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">tape_3590_done</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is called, when error recovery was not successful</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">tape_3590_erp_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;Error Recovery failed for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">tape_op_verbose</span><span class="p">[</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">]);</span>
	<span class="n">tape_dump_sense_dbf</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Error Recovery do retry</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">tape_3590_erp_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Retry: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tape_op_verbose</span><span class="p">[</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">]);</span>
	<span class="n">tape_dump_sense_dbf</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TAPE_IO_RETRY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle unsolicited interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_unsolicited_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">==</span> <span class="n">DEV_STAT_CHN_END</span><span class="p">)</span>
		<span class="cm">/* Probably result of halt ssch */</span>
		<span class="k">return</span> <span class="n">TAPE_IO_PENDING</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">==</span> <span class="mh">0x85</span><span class="p">)</span>
		<span class="cm">/* Device Ready */</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;unsol.irq! tape ready: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_ATTENTION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tape_3590_schedule_work</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">TO_READ_ATTMSG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;unsol.irq! dev end: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
		<span class="n">tape_dump_sense_dbf</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* check medium state */</span>
	<span class="n">tape_3590_schedule_work</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">TO_MSEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TAPE_IO_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Basic Recovery routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_erp_basic</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_3590_sense</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>

	<span class="n">sense</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tape_3590_sense</span> <span class="o">*</span><span class="p">)</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">bra</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SENSE_BRA_PER</span>:
		<span class="k">return</span> <span class="n">tape_3590_erp_failed</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SENSE_BRA_CONT</span>:
		<span class="k">return</span> <span class="n">tape_3590_erp_succeded</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SENSE_BRA_RE</span>:
		<span class="k">return</span> <span class="n">tape_3590_erp_retry</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SENSE_BRA_DRE</span>:
		<span class="k">return</span> <span class="n">tape_3590_erp_failed</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">TAPE_IO_STOP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  RDL: Read Device (buffered) log</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_erp_read_buf_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We just do the basic error recovery at the moment (retry).</span>
<span class="cm">	 * Perhaps in the future, we read the log and dump it somewhere...</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  SWAP: Swap Devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_erp_swap</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This error recovery should swap the tapes</span>
<span class="cm">	 * if the original has a problem. The operation</span>
<span class="cm">	 * should proceed with the new tape... this</span>
<span class="cm">	 * should probably be done in user space!</span>
<span class="cm">	 */</span>
	<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape medium must be loaded into a &quot;</span>
		<span class="s">&quot;different tape unit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  LBY: Long Busy</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_erp_long_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;Device is busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TAPE_IO_LONG_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  SPI: Special Intercept</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_erp_special_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  RDA: Read Alternate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_erp_read_alternate</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_3590_disc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The issued Read Backward or Read Previous command is not</span>
<span class="cm">	 * supported by the device</span>
<span class="cm">	 * The recovery action should be to issue another command:</span>
<span class="cm">	 * Read Revious: if Read Backward is not supported</span>
<span class="cm">	 * Read Backward: if Read Previous is not supported</span>
<span class="cm">	 */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">discdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read_back_op</span> <span class="o">==</span> <span class="n">READ_PREVIOUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(%08x): No support for READ_PREVIOUS command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">read_back_op</span> <span class="o">=</span> <span class="n">READ_BACKWARD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(%08x): No support for READ_BACKWARD command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">read_back_op</span> <span class="o">=</span> <span class="n">READ_PREVIOUS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tape_3590_read_opposite</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tape_3590_erp_retry</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Error Recovery read opposite</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_erp_read_opposite</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TO_RFO</span>:
		<span class="cm">/*</span>
<span class="cm">		 * We did read forward, but the data could not be read.</span>
<span class="cm">		 * We will read backward and then skip forward again.</span>
<span class="cm">		 */</span>
		<span class="n">tape_3590_read_opposite</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_retry</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TO_RBA</span>:
		<span class="cm">/* We tried to read forward and backward, but hat no success */</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_failed</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_failed</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Print an MIM (Media Information  Message) (message code f0)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tape_3590_print_mim_msg_f0</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_3590_sense</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">exception</span><span class="p">,</span> <span class="o">*</span><span class="n">service</span><span class="p">;</span>

	<span class="n">exception</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">BUFSIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">service</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">BUFSIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exception</span> <span class="o">||</span> <span class="o">!</span><span class="n">service</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

	<span class="n">sense</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tape_3590_sense</span> <span class="o">*</span><span class="p">)</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">;</span>
	<span class="cm">/* Exception Message */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f70</span><span class="p">.</span><span class="n">emc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x02</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Data degraded&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x03</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Data degraded in partion %i&quot;</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f70</span><span class="p">.</span><span class="n">mp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x04</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Medium degraded&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x05</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Medium degraded in partition %i&quot;</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f70</span><span class="p">.</span><span class="n">mp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x06</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Block 0 Error&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x07</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Medium Exception 0x%02x&quot;</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f70</span><span class="p">.</span><span class="n">md</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;0x%02x&quot;</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f70</span><span class="p">.</span><span class="n">emc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Service Message */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f70</span><span class="p">.</span><span class="n">smc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x02</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Reference Media maintenance &quot;</span>
			<span class="s">&quot;procedure %i&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f70</span><span class="p">.</span><span class="n">md</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;0x%02x&quot;</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f70</span><span class="p">.</span><span class="n">smc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Tape media information: exception %s, &quot;</span>
		<span class="s">&quot;service %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>

<span class="nl">out_nomem:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">exception</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">service</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Print an I/O Subsystem Service Information Message (message code f1)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tape_3590_print_io_sim_msg_f1</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_3590_sense</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">exception</span><span class="p">,</span> <span class="o">*</span><span class="n">service</span><span class="p">;</span>

	<span class="n">exception</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">BUFSIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">service</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">BUFSIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exception</span> <span class="o">||</span> <span class="o">!</span><span class="n">service</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

	<span class="n">sense</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tape_3590_sense</span> <span class="o">*</span><span class="p">)</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">;</span>
	<span class="cm">/* Exception Message */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">emc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x01</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Effect of failure is unknown&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x02</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;CU Exception - no performance &quot;</span>
			<span class="s">&quot;impact&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x03</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;CU Exception on channel &quot;</span>
			<span class="s">&quot;interface 0x%02x&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x04</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;CU Exception on device path &quot;</span>
			<span class="s">&quot;0x%02x&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x05</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;CU Exception on library path &quot;</span>
			<span class="s">&quot;0x%02x&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x06</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;CU Exception on node 0x%02x&quot;</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x07</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;CU Exception on partition &quot;</span>
			<span class="s">&quot;0x%02x&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;0x%02x&quot;</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">emc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Service Message */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">smc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x01</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair impact is unknown&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x02</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will not impact cu &quot;</span>
			<span class="s">&quot;performance&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x03</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">mdf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable node &quot;</span>
				<span class="s">&quot;0x%x on CU&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable &quot;</span>
				<span class="s">&quot;nodes (0x%x-0x%x) on CU&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x04</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">mdf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable &quot;</span>
				<span class="s">&quot;channel path 0x%x on CU&quot;</span><span class="p">,</span>
				<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable cannel&quot;</span>
				<span class="s">&quot; paths (0x%x-0x%x) on CU&quot;</span><span class="p">,</span>
				<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x05</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">mdf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable device&quot;</span>
				<span class="s">&quot; path 0x%x on CU&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable device&quot;</span>
				<span class="s">&quot; paths (0x%x-0x%x) on CU&quot;</span><span class="p">,</span>
				<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x06</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">mdf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable &quot;</span>
				<span class="s">&quot;library path 0x%x on CU&quot;</span><span class="p">,</span>
				<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable &quot;</span>
				<span class="s">&quot;library paths (0x%x-0x%x) on CU&quot;</span><span class="p">,</span>
				<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x07</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable access to CU&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;0x%02x&quot;</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">smc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;I/O subsystem information: exception&quot;</span>
		<span class="s">&quot; %s, service %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
<span class="nl">out_nomem:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">exception</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">service</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Print an Device Subsystem Service Information Message (message code f2)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tape_3590_print_dev_sim_msg_f2</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_3590_sense</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">exception</span><span class="p">,</span> <span class="o">*</span><span class="n">service</span><span class="p">;</span>

	<span class="n">exception</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">BUFSIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">service</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">BUFSIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exception</span> <span class="o">||</span> <span class="o">!</span><span class="n">service</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nomem</span><span class="p">;</span>

	<span class="n">sense</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tape_3590_sense</span> <span class="o">*</span><span class="p">)</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">;</span>
	<span class="cm">/* Exception Message */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">emc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x01</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Effect of failure is unknown&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x02</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;DV Exception - no performance&quot;</span>
			<span class="s">&quot; impact&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x03</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;DV Exception on channel &quot;</span>
			<span class="s">&quot;interface 0x%02x&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x04</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;DV Exception on loader 0x%02x&quot;</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x05</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;DV Exception on message display&quot;</span>
			<span class="s">&quot; 0x%02x&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x06</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;DV Exception in tape path&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x07</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;DV Exception in drive&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;0x%02x&quot;</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">emc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Service Message */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">smc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x01</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair impact is unknown&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x02</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will not impact device &quot;</span>
			<span class="s">&quot;performance&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x03</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">mdf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable &quot;</span>
				<span class="s">&quot;channel path 0x%x on DV&quot;</span><span class="p">,</span>
				<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable &quot;</span>
				<span class="s">&quot;channel path (0x%x-0x%x) on DV&quot;</span><span class="p">,</span>
				<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x04</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">mdf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable &quot;</span>
				<span class="s">&quot;interface 0x%x on DV&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable &quot;</span>
				<span class="s">&quot;interfaces (0x%x-0x%x) on DV&quot;</span><span class="p">,</span>
				<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x05</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">mdf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable loader&quot;</span>
				<span class="s">&quot; 0x%x on DV&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable loader&quot;</span>
				<span class="s">&quot; (0x%x-0x%x) on DV&quot;</span><span class="p">,</span>
				<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x07</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable access to DV&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x08</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">mdf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable &quot;</span>
				<span class="s">&quot;message display 0x%x on DV&quot;</span><span class="p">,</span>
				<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Repair will disable &quot;</span>
				<span class="s">&quot;message displays (0x%x-0x%x) on DV&quot;</span><span class="p">,</span>
				 <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">md</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x09</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;Clean DV&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">,</span> <span class="s">&quot;0x%02x&quot;</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">smc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device subsystem information: exception&quot;</span>
		<span class="s">&quot; %s, service %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
<span class="nl">out_nomem:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">exception</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">service</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Print standard ERA Message</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tape_3590_print_era_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_3590_sense</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>

	<span class="n">sense</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tape_3590_sense</span> <span class="o">*</span><span class="p">)</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">mc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">mc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">mc</span> <span class="o">&lt;</span> <span class="n">TAPE_3590_MAX_MSG</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tape_3590_msg</span><span class="p">[</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape unit has &quot;</span>
				<span class="s">&quot;issued sense message %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tape_3590_msg</span><span class="p">[</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape unit has &quot;</span>
				<span class="s">&quot;issued an unknown sense message code 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sense</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">mc</span> <span class="o">==</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Standard Media Information Message */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MIM SEV=%i, MC=%02x, ES=%x/%x, &quot;</span>
			<span class="s">&quot;RC=%02x-%04x-%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f70</span><span class="p">.</span><span class="n">sev</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f70</span><span class="p">.</span><span class="n">emc</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f70</span><span class="p">.</span><span class="n">smc</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f70</span><span class="p">.</span><span class="n">refcode</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f70</span><span class="p">.</span><span class="n">mid</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f70</span><span class="p">.</span><span class="n">fid</span><span class="p">);</span>
		<span class="n">tape_3590_print_mim_msg_f0</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">mc</span> <span class="o">==</span> <span class="mh">0xf1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Standard I/O Subsystem Service Information Message */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IOSIM SEV=%i, DEVTYPE=3590/%02x,&quot;</span>
			<span class="s">&quot; MC=%02x, ES=%x/%x, REF=0x%04x-0x%04x-0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">sev</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">dev_model</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">emc</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">smc</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">refcode1</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">refcode2</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">refcode3</span><span class="p">);</span>
		<span class="n">tape_3590_print_io_sim_msg_f1</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">mc</span> <span class="o">==</span> <span class="mh">0xf2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Standard Device Service Information Message */</span>
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DEVSIM SEV=%i, DEVTYPE=3590/%02x&quot;</span>
			<span class="s">&quot;, MC=%02x, ES=%x/%x, REF=0x%04x-0x%04x-0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">sev</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">dev_model</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">emc</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">smc</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">refcode1</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">refcode2</span><span class="p">,</span>
			<span class="n">sense</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">f71</span><span class="p">.</span><span class="n">refcode3</span><span class="p">);</span>
		<span class="n">tape_3590_print_dev_sim_msg_f2</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">mc</span> <span class="o">==</span> <span class="mh">0xf3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Standard Library Service Information Message */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape unit has issued an unknown &quot;</span>
		<span class="s">&quot;sense message code %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tape_3590_crypt_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cu_rc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ekm_rc2</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>

	<span class="n">sense</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">tape_3590_sense</span> <span class="o">*</span><span class="p">)</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cu_rc</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ekm_rc2</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">sense</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cu_rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ekm_rc2</span> <span class="o">==</span> <span class="mh">0xee31</span><span class="p">))</span>
		<span class="cm">/* key not defined on EKM */</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">EKEYREJECTED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cu_rc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cu_rc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
		<span class="cm">/* No connection to EKM */</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">);</span>

	<span class="n">dev_err</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tape unit failed to obtain the &quot;</span>
		<span class="s">&quot;encryption key from EKM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOKEY</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  3590 error Recovery routine:</span>
<span class="cm"> *  If possible, it tries to recover from the error. If this is not possible,</span>
<span class="cm"> *  inform the user about the problem.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_unit_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_3590_sense</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>

	<span class="n">sense</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tape_3590_sense</span> <span class="o">*</span><span class="p">)</span> <span class="n">irb</span><span class="o">-&gt;</span><span class="n">ecw</span><span class="p">;</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;Unit Check: RQC = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">rc_rqc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * First check all RC-QRCs where we want to do something special</span>
<span class="cm">	 *   - &quot;break&quot;:     basic error recovery is done</span>
<span class="cm">	 *   - &quot;goto out:&quot;: just print error message if available</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">rc_rqc</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="mh">0x1110</span>:
		<span class="n">tape_3590_print_era_msg</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_read_buf_log</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>

	<span class="k">case</span> <span class="mh">0x2011</span>:
		<span class="n">tape_3590_print_era_msg</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_read_alternate</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>

	<span class="k">case</span> <span class="mh">0x2230</span>:
	<span class="k">case</span> <span class="mh">0x2231</span>:
		<span class="n">tape_3590_print_era_msg</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_special_interrupt</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x2240</span>:
		<span class="k">return</span> <span class="n">tape_3590_crypt_error</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>

	<span class="k">case</span> <span class="mh">0x3010</span>:
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(%08x): Backward at Beginning of Partition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x3012</span>:
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(%08x): Forward at End of Partition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x3020</span>:
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(%08x): End of Data Mark</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>

	<span class="k">case</span> <span class="mh">0x3122</span>:
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(%08x): Rewind Unload initiated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x3123</span>:
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;(%08x): Rewind Unload complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
		<span class="n">tape_med_state_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MS_UNLOADED</span><span class="p">);</span>
		<span class="n">tape_3590_schedule_work</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">TO_CRYPT_OFF</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">case</span> <span class="mh">0x4010</span>:
		<span class="cm">/*</span>
<span class="cm">		 * print additional msg since default msg</span>
<span class="cm">		 * &quot;device intervention&quot; is not very meaningfull</span>
<span class="cm">		 */</span>
		<span class="n">tape_med_state_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MS_UNLOADED</span><span class="p">);</span>
		<span class="n">tape_3590_schedule_work</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">TO_CRYPT_OFF</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x4012</span>:		<span class="cm">/* Device Long Busy */</span>
		<span class="cm">/* XXX: Also use long busy handling here? */</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;(%08x): LONG BUSY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
		<span class="n">tape_3590_print_era_msg</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x4014</span>:
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;(%08x): Crypto LONG BUSY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_long_busy</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>

	<span class="k">case</span> <span class="mh">0x5010</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">rac</span> <span class="o">==</span> <span class="mh">0xd0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Swap */</span>
			<span class="n">tape_3590_print_era_msg</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">tape_3590_erp_swap</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">rac</span> <span class="o">==</span> <span class="mh">0x26</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Read Opposite */</span>
			<span class="n">tape_3590_print_era_msg</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">tape_3590_erp_read_opposite</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span>
							   <span class="n">irb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x5020</span>:
	<span class="k">case</span> <span class="mh">0x5021</span>:
	<span class="k">case</span> <span class="mh">0x5022</span>:
	<span class="k">case</span> <span class="mh">0x5040</span>:
	<span class="k">case</span> <span class="mh">0x5041</span>:
	<span class="k">case</span> <span class="mh">0x5042</span>:
		<span class="n">tape_3590_print_era_msg</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_swap</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>

	<span class="k">case</span> <span class="mh">0x5110</span>:
	<span class="k">case</span> <span class="mh">0x5111</span>:
		<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">EMEDIUMTYPE</span><span class="p">);</span>

	<span class="k">case</span> <span class="mh">0x5120</span>:
	<span class="k">case</span> <span class="mh">0x1120</span>:
		<span class="n">tape_med_state_set</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MS_UNLOADED</span><span class="p">);</span>
		<span class="n">tape_3590_schedule_work</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">TO_CRYPT_OFF</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">);</span>

	<span class="k">case</span> <span class="mh">0x6020</span>:
		<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">EMEDIUMTYPE</span><span class="p">);</span>

	<span class="k">case</span> <span class="mh">0x8011</span>:
		<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x8013</span>:
		<span class="n">dev_warn</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A different host has privileged&quot;</span>
			<span class="s">&quot; access to the tape unit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_basic</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * 3590 interrupt handler:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">irb</span> <span class="o">*</span><span class="n">irb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tape_3590_unsolicited_irq</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_EXCEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_DEV_END</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">TO_WRI</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Write at end of volume */</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;End of volume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tape_3590_erp_failed</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_UNIT_CHECK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tape_3590_unit_check</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_DEV_END</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">==</span> <span class="n">DEV_STAT_UNIT_EXCEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">TO_FSB</span> <span class="o">||</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">TO_BSB</span><span class="p">)</span>
				<span class="n">request</span><span class="o">-&gt;</span><span class="n">rescnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Unit Exception!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">tape_3590_done</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_CHN_END</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;cannel end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TAPE_IO_PENDING</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irb</span><span class="o">-&gt;</span><span class="n">scsw</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">DEV_STAT_ATTENTION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Unit Attention when busy..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TAPE_IO_PENDING</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;xunknownirq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">tape_dump_sense_dbf</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TAPE_IO_STOP</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">tape_3590_read_dev_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">tape_3590_rdc_data</span> <span class="o">*</span><span class="n">rdc_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rdc_data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_RDC</span><span class="p">;</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">CCW_CMD_RDC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rdc_data</span><span class="p">),</span>
		     <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_do_io</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rdc_data</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rdc_data</span><span class="p">));</span>
	<span class="n">tape_free_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup device function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_setup_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tape_3590_disc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tape_3590_rdc_data</span> <span class="o">*</span><span class="n">rdc_data</span><span class="p">;</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;3590 device setup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_3590_disc_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">read_back_op</span> <span class="o">=</span> <span class="n">READ_PREVIOUS</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">discdata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">rdc_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rdc_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdc_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_kmalloc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_3590_read_dev_chars</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">rdc_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_LH</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;Read device characteristics failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_rdc_data</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_std_assign</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_rdc_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdc_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">TAPE390_CRYPT_SUPPORTED_MASK</span><span class="p">;</span>
		<span class="n">tape_3592_disable_crypt</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;Device has NO crypto support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Try to find out if medium is loaded */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_3590_sense_medium</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_LH</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;3590 medium sense returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_rdc_data</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_rdc_data:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rdc_data</span><span class="p">);</span>
<span class="nl">fail_kmalloc:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cleanup device function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tape_3590_cleanup_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">tape_3590_wq</span><span class="p">);</span>
	<span class="n">tape_std_unassign</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">discdata</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">discdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * List of 3590 magnetic tape commands.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">tape_mtop_fn</span> <span class="n">tape_3590_mtop</span><span class="p">[</span><span class="n">TAPE_NR_MTOPS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">MTRESET</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtreset</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTFSF</span><span class="p">]</span>		 <span class="o">=</span> <span class="n">tape_std_mtfsf</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTBSF</span><span class="p">]</span>		 <span class="o">=</span> <span class="n">tape_std_mtbsf</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTFSR</span><span class="p">]</span>		 <span class="o">=</span> <span class="n">tape_std_mtfsr</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTBSR</span><span class="p">]</span>		 <span class="o">=</span> <span class="n">tape_std_mtbsr</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTWEOF</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtweof</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTREW</span><span class="p">]</span>		 <span class="o">=</span> <span class="n">tape_std_mtrew</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTOFFL</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtoffl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTNOP</span><span class="p">]</span>		 <span class="o">=</span> <span class="n">tape_std_mtnop</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTRETEN</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtreten</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTBSFM</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtbsfm</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTFSFM</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtfsfm</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTEOM</span><span class="p">]</span>		 <span class="o">=</span> <span class="n">tape_std_mteom</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTERASE</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mterase</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTRAS1</span><span class="p">]</span>	 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTRAS2</span><span class="p">]</span>	 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTRAS3</span><span class="p">]</span>	 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTSETBLK</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtsetblk</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTSETDENSITY</span><span class="p">]</span>	 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTSEEK</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_3590_mtseek</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTTELL</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_3590_mttell</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTSETDRVBUFFER</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTFSS</span><span class="p">]</span>		 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTBSS</span><span class="p">]</span>		 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTWSM</span><span class="p">]</span>		 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTLOCK</span><span class="p">]</span>	 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTUNLOCK</span><span class="p">]</span>	 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTLOAD</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtload</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTUNLOAD</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtunload</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTCOMPRESSION</span><span class="p">]</span>	 <span class="o">=</span> <span class="n">tape_std_mtcompression</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTSETPART</span><span class="p">]</span>	 <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">MTMKPART</span><span class="p">]</span>	 <span class="o">=</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Tape discipline structure for 3590.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tape_discipline</span> <span class="n">tape_discipline_3590</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_device</span> <span class="o">=</span> <span class="n">tape_3590_setup_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup_device</span> <span class="o">=</span> <span class="n">tape_3590_cleanup_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">process_eov</span> <span class="o">=</span> <span class="n">tape_std_process_eov</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">tape_3590_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_block</span> <span class="o">=</span> <span class="n">tape_std_read_block</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_block</span> <span class="o">=</span> <span class="n">tape_std_write_block</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_fn</span> <span class="o">=</span> <span class="n">tape_3590_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mtop_array</span> <span class="o">=</span> <span class="n">tape_3590_mtop</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccw_device_id</span> <span class="n">tape_3590_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">CCW_DEVICE_DEVTYPE</span><span class="p">(</span><span class="mh">0x3590</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3590</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">tape_3590</span><span class="p">},</span>
	<span class="p">{</span><span class="n">CCW_DEVICE_DEVTYPE</span><span class="p">(</span><span class="mh">0x3592</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3592</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">tape_3592</span><span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* end of list */</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccw_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tape_generic_online</span><span class="p">(</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
				   <span class="o">&amp;</span><span class="n">tape_discipline_3590</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccw_driver</span> <span class="n">tape_3590_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;tape_3590&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">tape_3590_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">tape_generic_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">tape_generic_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_offline</span> <span class="o">=</span> <span class="n">tape_generic_offline</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_online</span> <span class="o">=</span> <span class="n">tape_3590_online</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span> <span class="o">=</span> <span class="n">tape_generic_pm_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">int_class</span> <span class="o">=</span> <span class="n">IOINT_TAP</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Setup discipline structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tape_3590_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">TAPE_DBF_AREA</span> <span class="o">=</span> <span class="n">debug_register</span><span class="p">(</span><span class="s">&quot;tape_3590&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">TAPE_DBF_AREA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_sprintf_view</span><span class="p">);</span>
<span class="cp">#ifdef DBF_LIKE_HELL</span>
	<span class="n">debug_set_level</span><span class="p">(</span><span class="n">TAPE_DBF_AREA</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;3590 init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">tape_3590_wq</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;tape_3590&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tape_3590_wq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Register driver for 3590 tapes. */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ccw_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tape_3590_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">tape_3590_wq</span><span class="p">);</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;3590 init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;3590 registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tape_3590_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ccw_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tape_3590_driver</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">tape_3590_wq</span><span class="p">);</span>
	<span class="n">debug_unregister</span><span class="p">(</span><span class="n">TAPE_DBF_AREA</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">tape_3590_ids</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;(C) 2001,2006 IBM Corporation&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Linux on zSeries channel attached 3590 tape device driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">tape_3590_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">tape_3590_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
