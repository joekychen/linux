<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › s390 › char › tape_std.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tape_std.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  drivers/s390/char/tape_std.c</span>
<span class="cm"> *    standard tape device functions for ibm tapes.</span>
<span class="cm"> *</span>
<span class="cm"> *  S390 and zSeries version</span>
<span class="cm"> *    Copyright (C) 2001,2002 IBM Deutschland Entwicklung GmbH, IBM Corporation</span>
<span class="cm"> *    Author(s): Carsten Otte &lt;cotte@de.ibm.com&gt;</span>
<span class="cm"> *		 Michael Holzheu &lt;holzheu@de.ibm.com&gt;</span>
<span class="cm"> *		 Tuan Ngo-Anh &lt;ngoanh@de.ibm.com&gt;</span>
<span class="cm"> *		 Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;</span>
<span class="cm"> *		 Stefan Bader &lt;shbader@de.ibm.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;tape&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/bio.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>

<span class="cp">#include &lt;asm/types.h&gt;</span>
<span class="cp">#include &lt;asm/idals.h&gt;</span>
<span class="cp">#include &lt;asm/ebcdic.h&gt;</span>
<span class="cp">#include &lt;asm/tape390.h&gt;</span>

<span class="cp">#define TAPE_DBF_AREA	tape_core_dbf</span>

<span class="cp">#include &quot;tape.h&quot;</span>
<span class="cp">#include &quot;tape_std.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * tape_std_assign</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tape_std_assign_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span>	<span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span>	<span class="n">device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">device</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">);</span>

	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%08x: Assignment timeout. Device busy.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_cancel_io</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;(%08x): Assign timeout: Cancel failed with rc = &quot;</span>
			  <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">tape_std_assign</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>                  <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>    <span class="n">timeout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>

	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_ASSIGN</span><span class="p">;</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The assign command sometimes blocks if the device is assigned</span>
<span class="cm">	 * to another host (actually this shouldn&#39;t happen but it does).</span>
<span class="cm">	 * So we set up a timeout for this call.</span>
<span class="cm">	 */</span>
	<span class="n">init_timer_on_stack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timeout</span><span class="p">);</span>
	<span class="n">timeout</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">tape_std_assign_timeout</span><span class="p">;</span>
	<span class="n">timeout</span><span class="p">.</span><span class="n">data</span>     <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">request</span><span class="p">;</span>
	<span class="n">timeout</span><span class="p">.</span><span class="n">expires</span>  <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timeout</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_do_io_interruptible</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%08x: assign failed - device might be busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%08x: Tape assigned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tape_free_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tape_std_unassign</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_unassign</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>                  <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">tape_state</span> <span class="o">==</span> <span class="n">TS_NOT_OPER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;(%08x): Can&#39;t unassign device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>

	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_UNASSIGN</span><span class="p">;</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">UNASSIGN</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">tape_do_io</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%08x: Unassign failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%08x: Tape unassigned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cdev_id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tape_free_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TAPE390_DISPLAY: Show a string on the tape display.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">display_struct</span> <span class="o">*</span><span class="n">disp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;TAPE: load display failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_DIS</span><span class="p">;</span>

	<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span> <span class="o">=</span> <span class="n">disp</span><span class="o">-&gt;</span><span class="n">cntrl</span><span class="p">;</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;TAPE: display cntrl=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">disp</span><span class="o">-&gt;</span><span class="n">cntrl</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">disp</span><span class="o">-&gt;</span><span class="n">message1</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">)</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="n">disp</span><span class="o">-&gt;</span><span class="n">message2</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ASCEBC</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">LOAD_DISPLAY</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_do_io_interruptible</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="n">tape_free_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read block id.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_read_block_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="n">__u64</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_RBI</span><span class="p">;</span>
	<span class="cm">/* setup ccws */</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">READ_BLOCK_ID</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* execute it */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_do_io</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* Get result from read buffer. */</span>
		<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">__u64</span> <span class="o">*</span><span class="p">)</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpdata</span><span class="p">;</span>
	<span class="n">tape_free_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">tape_std_terminate_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">required_tapemarks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBF_LH</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;tape%d: terminate write %dxEOF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">first_minor</span><span class="p">,</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">required_tapemarks</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_mtop</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MTWEOF</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">required_tapemarks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">required_tapemarks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tape_mtop</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MTBSR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTLOAD: Loads the tape.</span>
<span class="cm"> * The default implementation just wait until the tape medium state changes</span>
<span class="cm"> * to MS_LOADED.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mtload</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">state_change_wq</span><span class="p">,</span>
		<span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">medium_state</span> <span class="o">==</span> <span class="n">MS_LOADED</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTSETBLK: Set block size.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mtsetblk</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">idal_buffer</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>

	<span class="n">DBF_LH</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;tape_std_mtsetblk(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Just set block_size to 0. tapechar_read/tapechar_write</span>
<span class="cm">		 * will realloc the idal buffer if a bigger one than the</span>
<span class="cm">		 * current is needed.</span>
<span class="cm">		 */</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">char_data</span><span class="p">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">char_data</span><span class="p">.</span><span class="n">idal_buf</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">device</span><span class="o">-&gt;</span><span class="n">char_data</span><span class="p">.</span><span class="n">idal_buf</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="n">count</span><span class="p">)</span>
		<span class="cm">/* We already have a idal buffer of that size. */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">MAX_BLOCKSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;Invalid block size (%d &gt; %d) given.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">count</span><span class="p">,</span> <span class="n">MAX_BLOCKSIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate a new idal buffer. */</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">idal_buffer_alloc</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">new</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">char_data</span><span class="p">.</span><span class="n">idal_buf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">idal_buffer_free</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">char_data</span><span class="p">.</span><span class="n">idal_buf</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">char_data</span><span class="p">.</span><span class="n">idal_buf</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">char_data</span><span class="p">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">DBF_LH</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;new blocksize is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">char_data</span><span class="p">.</span><span class="n">block_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTRESET: Set block size to 0.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mtreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;TCHAR:devreset:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">char_data</span><span class="p">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTFSF: Forward space over &#39;count&#39; file marks. The tape is positioned</span>
<span class="cm"> * at the EOT (End of Tape) side of the file mark.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mtfsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="n">mt_count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_FSF</span><span class="p">;</span>
	<span class="cm">/* setup ccws */</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_repeat</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">FORSPACEFILE</span><span class="p">,</span> <span class="n">mt_count</span><span class="p">);</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* execute it */</span>
	<span class="k">return</span> <span class="n">tape_do_io_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTFSR: Forward space over &#39;count&#39; tape blocks (blocksize is set</span>
<span class="cm"> * via MTSETBLK.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mtfsr</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="n">mt_count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_FSB</span><span class="p">;</span>
	<span class="cm">/* setup ccws */</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_repeat</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">FORSPACEBLOCK</span><span class="p">,</span> <span class="n">mt_count</span><span class="p">);</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* execute it */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_do_io</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">rescnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_LH</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;FSR over tapemark</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tape_free_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTBSR: Backward space over &#39;count&#39; tape blocks.</span>
<span class="cm"> * (blocksize is set via MTSETBLK.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mtbsr</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="n">mt_count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_BSB</span><span class="p">;</span>
	<span class="cm">/* setup ccws */</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_repeat</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">BACKSPACEBLOCK</span><span class="p">,</span> <span class="n">mt_count</span><span class="p">);</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* execute it */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_do_io</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">rescnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_LH</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;BSR over tapemark</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tape_free_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTWEOF: Write &#39;count&#39; file marks at the current position.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mtweof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="n">mt_count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_WTM</span><span class="p">;</span>
	<span class="cm">/* setup ccws */</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_repeat</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">WRITETAPEMARK</span><span class="p">,</span> <span class="n">mt_count</span><span class="p">);</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* execute it */</span>
	<span class="k">return</span> <span class="n">tape_do_io_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTBSFM: Backward space over &#39;count&#39; file marks.</span>
<span class="cm"> * The tape is positioned at the BOT (Begin Of Tape) side of the</span>
<span class="cm"> * last skipped file mark.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mtbsfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="n">mt_count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_BSF</span><span class="p">;</span>
	<span class="cm">/* setup ccws */</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_repeat</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">BACKSPACEFILE</span><span class="p">,</span> <span class="n">mt_count</span><span class="p">);</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* execute it */</span>
	<span class="k">return</span> <span class="n">tape_do_io_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTBSF: Backward space over &#39;count&#39; file marks. The tape is positioned at</span>
<span class="cm"> * the EOT (End of Tape) side of the last skipped file mark.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mtbsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="n">mt_count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_BSF</span><span class="p">;</span>
	<span class="cm">/* setup ccws */</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_repeat</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">BACKSPACEFILE</span><span class="p">,</span> <span class="n">mt_count</span><span class="p">);</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* execute it */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_do_io_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_mtop</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MTFSR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTFSFM: Forward space over &#39;count&#39; file marks.</span>
<span class="cm"> * The tape is positioned at the BOT (Begin Of Tape) side</span>
<span class="cm"> * of the last skipped file mark.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mtfsfm</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccw1</span> <span class="o">*</span><span class="n">ccw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="n">mt_count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_FSF</span><span class="p">;</span>
	<span class="cm">/* setup ccws */</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_repeat</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">FORSPACEFILE</span><span class="p">,</span> <span class="n">mt_count</span><span class="p">);</span>
	<span class="n">ccw</span> <span class="o">=</span> <span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">ccw</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* execute it */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_do_io_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">tape_mtop</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MTBSR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTREW: Rewind the tape.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mtrew</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_REW</span><span class="p">;</span>
	<span class="cm">/* setup ccws */</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		    <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REWIND</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* execute it */</span>
	<span class="k">return</span> <span class="n">tape_do_io_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTOFFL: Rewind the tape and put the drive off-line.</span>
<span class="cm"> * Implement &#39;rewind unload&#39;</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mtoffl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_RUN</span><span class="p">;</span>
	<span class="cm">/* setup ccws */</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REWIND_UNLOAD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* execute it */</span>
	<span class="k">return</span> <span class="n">tape_do_io_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTNOP: &#39;No operation&#39;.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mtnop</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_NOP</span><span class="p">;</span>
	<span class="cm">/* setup ccws */</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* execute it */</span>
	<span class="k">return</span> <span class="n">tape_do_io_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTEOM: positions at the end of the portion of the tape already used</span>
<span class="cm"> * for recordind data. MTEOM positions after the last file mark, ready for</span>
<span class="cm"> * appending another file.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mteom</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Seek from the beginning of tape (rewind).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">tape_mtop</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MTREW</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The logical end of volume is given by two sewuential tapemarks.</span>
<span class="cm">	 * Look for this by skipping to the next file (over one tapemark)</span>
<span class="cm">	 * and then test for another one (fsr returns 1 if a tapemark was</span>
<span class="cm">	 * encountered).</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">tape_mtop</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MTFSF</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">tape_mtop</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MTFSR</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tape_mtop</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MTBSR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTRETEN: Retension the tape, i.e. forward space to end of tape and rewind.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mtreten</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_FSF</span><span class="p">;</span>
	<span class="cm">/* setup ccws */</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="n">FORSPACEFILE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">CCW_CMD_TIC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">);</span>
	<span class="cm">/* execute it, MTRETEN rc gets ignored */</span>
	<span class="n">tape_do_io_interruptible</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="n">tape_free_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tape_mtop</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MTREW</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTERASE: erases the tape.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mterase</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_DSE</span><span class="p">;</span>
	<span class="cm">/* setup ccws */</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REWIND</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ERASE_GAP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">DATA_SEC_ERASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">REWIND</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* execute it */</span>
	<span class="k">return</span> <span class="n">tape_do_io_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTUNLOAD: Rewind the tape and unload it.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mtunload</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tape_mtop</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MTOFFL</span><span class="p">,</span> <span class="n">mt_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MTCOMPRESSION: used to enable compression.</span>
<span class="cm"> * Sets the IDRC on/off.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">tape_std_mtcompression</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mt_count</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">mt_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBF_EXCEPTION</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;xcom parm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_NOP</span><span class="p">;</span>
	<span class="cm">/* setup ccws */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mt_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x08</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* execute it */</span>
	<span class="k">return</span> <span class="n">tape_do_io_free</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read Block</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span>
<span class="nf">tape_std_read_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have to alloc 4 ccws in order to be able to transform request</span>
<span class="cm">	 * into a read backward request in error case.</span>
<span class="cm">	 */</span>
	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBF_EXCEPTION</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;xrbl fail&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">request</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_RFO</span><span class="p">;</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">tape_ccw_end_idal</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">READ_FORWARD</span><span class="p">,</span>
			  <span class="n">device</span><span class="o">-&gt;</span><span class="n">char_data</span><span class="p">.</span><span class="n">idal_buf</span><span class="p">);</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;xrbl ccwg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">request</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read Block backward transformation function.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">tape_std_read_backward</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We have allocated 4 ccws in tape_std_read, so we can now</span>
<span class="cm">	 * transform the request to a read backward, followed by a</span>
<span class="cm">	 * forward space block.</span>
<span class="cm">	 */</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_RBA</span><span class="p">;</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">tape_ccw_cc_idal</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">READ_BACKWARD</span><span class="p">,</span>
			 <span class="n">device</span><span class="o">-&gt;</span><span class="n">char_data</span><span class="p">.</span><span class="n">idal_buf</span><span class="p">);</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">FORSPACEBLOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">tape_ccw_end</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;xrop ccwg&quot;</span><span class="p">);}</span>

<span class="cm">/*</span>
<span class="cm"> * Write Block</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span>
<span class="nf">tape_std_write_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tape_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">tape_alloc_request</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">request</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBF_EXCEPTION</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;xwbl fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">request</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">TO_WRI</span><span class="p">;</span>
	<span class="n">tape_ccw_cc</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span><span class="p">,</span> <span class="n">MODE_SET_DB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">modeset_byte</span><span class="p">);</span>
	<span class="n">tape_ccw_end_idal</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cpaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">WRITE_CMD</span><span class="p">,</span>
			  <span class="n">device</span><span class="o">-&gt;</span><span class="n">char_data</span><span class="p">.</span><span class="n">idal_buf</span><span class="p">);</span>
	<span class="n">DBF_EVENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;xwbl ccwg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">request</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called by frontend after an ENOSP on write</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">tape_std_process_eov</span><span class="p">(</span><span class="k">struct</span> <span class="n">tape_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * End of volume: We have to backspace the last written record, then</span>
<span class="cm">	 * we TRY to write a tapemark and then backspace over the written TM</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tape_mtop</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MTBSR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tape_mtop</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MTWEOF</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tape_mtop</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MTBSR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_assign</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_unassign</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_display</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_read_block_id</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mtload</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mtsetblk</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mtreset</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mtfsf</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mtfsr</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mtbsr</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mtweof</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mtbsfm</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mtbsf</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mtfsfm</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mtrew</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mtoffl</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mtnop</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mteom</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mtreten</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mterase</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mtunload</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_mtcompression</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_read_block</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_read_backward</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_write_block</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tape_std_process_eov</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
