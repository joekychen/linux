<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › leds › leds-lp5521.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>leds-lp5521.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * LP5521 LED chip driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Nokia Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Contact: Samu Onkalo &lt;samu.p.onkalo@nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * version 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	 See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/leds-lp5521.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#define LP5521_PROGRAM_LENGTH		32	</span><span class="cm">/* in bytes */</span><span class="cp"></span>

<span class="cp">#define LP5521_MAX_LEDS			3	</span><span class="cm">/* Maximum number of LEDs */</span><span class="cp"></span>
<span class="cp">#define LP5521_MAX_ENGINES		3	</span><span class="cm">/* Maximum number of engines */</span><span class="cp"></span>

<span class="cp">#define LP5521_ENG_MASK_BASE		0x30	</span><span class="cm">/* 00110000 */</span><span class="cp"></span>
<span class="cp">#define LP5521_ENG_STATUS_MASK		0x07	</span><span class="cm">/* 00000111 */</span><span class="cp"></span>

<span class="cp">#define LP5521_CMD_LOAD			0x15	</span><span class="cm">/* 00010101 */</span><span class="cp"></span>
<span class="cp">#define LP5521_CMD_RUN			0x2a	</span><span class="cm">/* 00101010 */</span><span class="cp"></span>
<span class="cp">#define LP5521_CMD_DIRECT		0x3f	</span><span class="cm">/* 00111111 */</span><span class="cp"></span>
<span class="cp">#define LP5521_CMD_DISABLED		0x00	</span><span class="cm">/* 00000000 */</span><span class="cp"></span>

<span class="cm">/* Registers */</span>
<span class="cp">#define LP5521_REG_ENABLE		0x00</span>
<span class="cp">#define LP5521_REG_OP_MODE		0x01</span>
<span class="cp">#define LP5521_REG_R_PWM		0x02</span>
<span class="cp">#define LP5521_REG_G_PWM		0x03</span>
<span class="cp">#define LP5521_REG_B_PWM		0x04</span>
<span class="cp">#define LP5521_REG_R_CURRENT		0x05</span>
<span class="cp">#define LP5521_REG_G_CURRENT		0x06</span>
<span class="cp">#define LP5521_REG_B_CURRENT		0x07</span>
<span class="cp">#define LP5521_REG_CONFIG		0x08</span>
<span class="cp">#define LP5521_REG_R_CHANNEL_PC		0x09</span>
<span class="cp">#define LP5521_REG_G_CHANNEL_PC		0x0A</span>
<span class="cp">#define LP5521_REG_B_CHANNEL_PC		0x0B</span>
<span class="cp">#define LP5521_REG_STATUS		0x0C</span>
<span class="cp">#define LP5521_REG_RESET		0x0D</span>
<span class="cp">#define LP5521_REG_GPO			0x0E</span>
<span class="cp">#define LP5521_REG_R_PROG_MEM		0x10</span>
<span class="cp">#define LP5521_REG_G_PROG_MEM		0x30</span>
<span class="cp">#define LP5521_REG_B_PROG_MEM		0x50</span>

<span class="cp">#define LP5521_PROG_MEM_BASE		LP5521_REG_R_PROG_MEM</span>
<span class="cp">#define LP5521_PROG_MEM_SIZE		0x20</span>

<span class="cm">/* Base register to set LED current */</span>
<span class="cp">#define LP5521_REG_LED_CURRENT_BASE	LP5521_REG_R_CURRENT</span>

<span class="cm">/* Base register to set the brightness */</span>
<span class="cp">#define LP5521_REG_LED_PWM_BASE		LP5521_REG_R_PWM</span>

<span class="cm">/* Bits in ENABLE register */</span>
<span class="cp">#define LP5521_MASTER_ENABLE		0x40	</span><span class="cm">/* Chip master enable */</span><span class="cp"></span>
<span class="cp">#define LP5521_LOGARITHMIC_PWM		0x80	</span><span class="cm">/* Logarithmic PWM adjustment */</span><span class="cp"></span>
<span class="cp">#define LP5521_EXEC_RUN			0x2A</span>
<span class="cp">#define LP5521_ENABLE_DEFAULT	\</span>
<span class="cp">	(LP5521_MASTER_ENABLE | LP5521_LOGARITHMIC_PWM)</span>
<span class="cp">#define LP5521_ENABLE_RUN_PROGRAM	\</span>
<span class="cp">	(LP5521_ENABLE_DEFAULT | LP5521_EXEC_RUN)</span>

<span class="cm">/* Status */</span>
<span class="cp">#define LP5521_EXT_CLK_USED		0x08</span>

<span class="cm">/* default R channel current register value */</span>
<span class="cp">#define LP5521_REG_R_CURR_DEFAULT	0xAF</span>

<span class="cm">/* Pattern Mode */</span>
<span class="cp">#define PATTERN_OFF	0</span>

<span class="k">struct</span> <span class="n">lp5521_engine</span> <span class="p">{</span>
	<span class="kt">int</span>		<span class="n">id</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">mode</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">prog_page</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">engine_mask</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">lp5521_led</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">id</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">chan_nr</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">led_current</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">max_current</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">led_classdev</span>	<span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">brightness_work</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">brightness</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5521_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">lock</span><span class="p">;</span> <span class="cm">/* Serialize control */</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>	<span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lp5521_engine</span>	<span class="n">engines</span><span class="p">[</span><span class="n">LP5521_MAX_ENGINES</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">lp5521_led</span>	<span class="n">leds</span><span class="p">[</span><span class="n">LP5521_MAX_LEDS</span><span class="p">];</span>
	<span class="n">u8</span>			<span class="n">num_channels</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">num_leds</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">lp5521_led</span> <span class="o">*</span><span class="nf">cdev_to_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lp5521_led</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="nf">engine_to_lp5521</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5521_engine</span> <span class="o">*</span><span class="n">engine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lp5521_chip</span><span class="p">,</span>
			    <span class="n">engines</span><span class="p">[</span><span class="n">engine</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="nf">led_to_lp5521</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5521_led</span> <span class="o">*</span><span class="n">led</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lp5521_chip</span><span class="p">,</span>
			    <span class="n">leds</span><span class="p">[</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">lp5521_led_brightness_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">lp5521_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5521_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5521_set_engine_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5521_engine</span> <span class="o">*</span><span class="n">engine</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">engine_to_lp5521</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">engine_state</span><span class="p">;</span>

	<span class="cm">/* Only transition between RUN and DIRECT mode are handled here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LP5521_CMD_LOAD</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LP5521_CMD_DISABLED</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">LP5521_CMD_DIRECT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5521_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_OP_MODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">engine_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set mode only for this engine */</span>
	<span class="n">engine_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">engine</span><span class="o">-&gt;</span><span class="n">engine_mask</span><span class="p">);</span>
	<span class="n">mode</span> <span class="o">&amp;=</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">engine_mask</span><span class="p">;</span>
	<span class="n">engine_state</span> <span class="o">|=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">lp5521_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_OP_MODE</span><span class="p">,</span> <span class="n">engine_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5521_load_program</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5521_engine</span> <span class="o">*</span><span class="n">eng</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pattern</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">engine_to_lp5521</span><span class="p">(</span><span class="n">eng</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>

	<span class="cm">/* move current engine to direct mode and remember the state */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5521_set_engine_mode</span><span class="p">(</span><span class="n">eng</span><span class="p">,</span> <span class="n">LP5521_CMD_DIRECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Mode change requires min 500 us delay. 1 - 2 ms  with margin */</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5521_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_OP_MODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* For loading, all the engines to load mode */</span>
	<span class="n">lp5521_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_OP_MODE</span><span class="p">,</span> <span class="n">LP5521_CMD_DIRECT</span><span class="p">);</span>
	<span class="cm">/* Mode change requires min 500 us delay. 1 - 2 ms  with margin */</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
	<span class="n">lp5521_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_OP_MODE</span><span class="p">,</span> <span class="n">LP5521_CMD_LOAD</span><span class="p">);</span>
	<span class="cm">/* Mode change requires min 500 us delay. 1 - 2 ms  with margin */</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">LP5521_PROG_MEM_BASE</span> <span class="o">+</span> <span class="n">eng</span><span class="o">-&gt;</span><span class="n">prog_page</span> <span class="o">*</span> <span class="n">LP5521_PROG_MEM_SIZE</span><span class="p">;</span>
	<span class="n">i2c_smbus_write_i2c_block_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
				<span class="n">addr</span><span class="p">,</span>
				<span class="n">LP5521_PROG_MEM_SIZE</span><span class="p">,</span>
				<span class="n">pattern</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">lp5521_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_OP_MODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5521_set_led_current</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">led</span><span class="p">,</span> <span class="n">u8</span> <span class="n">curr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">lp5521_write</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
		    <span class="n">LP5521_REG_LED_CURRENT_BASE</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">led</span><span class="p">].</span><span class="n">chan_nr</span><span class="p">,</span>
		    <span class="n">curr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lp5521_init_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">engine_mask</span> <span class="o">=</span> <span class="n">LP5521_ENG_MASK_BASE</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prog_page</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5521_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="n">lp5521_init_engine</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* Set all PWMs to direct control mode */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5521_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_OP_MODE</span><span class="p">,</span> <span class="n">LP5521_CMD_DIRECT</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">update_config</span> <span class="o">?</span>
		<span class="o">:</span> <span class="p">(</span><span class="n">LP5521_PWRSAVE_EN</span> <span class="o">|</span> <span class="n">LP5521_CP_MODE_AUTO</span> <span class="o">|</span> <span class="n">LP5521_R_TO_BATT</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5521_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_CONFIG</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>

	<span class="cm">/* Initialize all channels PWM to zero -&gt; leds off */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5521_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_R_PWM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5521_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_G_PWM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5521_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_B_PWM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set engines are set to run state when OP_MODE enables engines */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5521_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_ENABLE</span><span class="p">,</span>
			<span class="n">LP5521_ENABLE_RUN_PROGRAM</span><span class="p">);</span>
	<span class="cm">/* enable takes 500us. 1 - 2 ms leaves some margin */</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5521_run_selftest</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5521_read</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Check that ext clock is really in use if requested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clock_mode</span> <span class="o">==</span> <span class="n">LP5521_CLOCK_EXT</span><span class="p">)</span>
		<span class="k">if</span>  <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LP5521_EXT_CLK_USED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lp5521_set_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">brightness</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5521_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">cdev_to_led</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">brightness</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">brightness_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lp5521_led_brightness_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5521_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">lp5521_led</span><span class="p">,</span>
					      <span class="n">brightness_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">led_to_lp5521</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">lp5521_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_LED_PWM_BASE</span> <span class="o">+</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">chan_nr</span><span class="p">,</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Detect the chip by setting its ENABLE register and reading it back. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5521_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5521_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_ENABLE</span><span class="p">,</span> <span class="n">LP5521_ENABLE_DEFAULT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/* enable takes 500us. 1 - 2 ms leaves some margin */</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5521_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">!=</span> <span class="n">LP5521_ENABLE_DEFAULT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set engine mode and create appropriate sysfs attributes, if required. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5521_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5521_engine</span> <span class="o">*</span><span class="n">engine</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* if in that mode already do nothing, except for run */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">LP5521_CMD_RUN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LP5521_CMD_RUN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5521_set_engine_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">LP5521_CMD_RUN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LP5521_CMD_LOAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp5521_set_engine_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">LP5521_CMD_DISABLED</span><span class="p">);</span>
		<span class="n">lp5521_set_engine_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">LP5521_CMD_LOAD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LP5521_CMD_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp5521_set_engine_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">LP5521_CMD_DISABLED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">engine</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5521_do_store_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5521_engine</span> <span class="o">*</span><span class="n">engine</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">engine_to_lp5521</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">ret</span><span class="p">,</span> <span class="n">nrchars</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pattern</span><span class="p">[</span><span class="n">LP5521_PROGRAM_LENGTH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">LP5521_PROGRAM_LENGTH</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* separate sscanfs because length is working only for %s */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="s">&quot;%2s%n &quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nrchars</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&quot;%2x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="n">pattern</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">cmd</span><span class="p">;</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="n">nrchars</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Each instruction is 16bit long. Check that length is even */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">engine</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LP5521_CMD_LOAD</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5521_load_program</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">pattern</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed loading pattern</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wrong pattern format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_engine_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lp5521_do_store_load</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define store_load(nr)							\</span>
<span class="cp">static ssize_t store_engine##nr##_load(struct device *dev,		\</span>
<span class="cp">				     struct device_attribute *attr,	\</span>
<span class="cp">				     const char *buf, size_t len)	\</span>
<span class="cp">{									\</span>
<span class="cp">	return store_engine_load(dev, attr, buf, len, nr);		\</span>
<span class="cp">}</span>
<span class="n">store_load</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">store_load</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">store_load</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">show_engine_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LP5521_CMD_RUN</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;run</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">LP5521_CMD_LOAD</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;load</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">LP5521_CMD_DISABLED</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define show_mode(nr)							\</span>
<span class="cp">static ssize_t show_engine##nr##_mode(struct device *dev,		\</span>
<span class="cp">				    struct device_attribute *attr,	\</span>
<span class="cp">				    char *buf)				\</span>
<span class="cp">{									\</span>
<span class="cp">	return show_engine_mode(dev, attr, buf, nr);			\</span>
<span class="cp">}</span>
<span class="n">show_mode</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">show_mode</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">show_mode</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">store_engine_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5521_engine</span> <span class="o">*</span><span class="n">engine</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;run&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">lp5521_set_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">LP5521_CMD_RUN</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;load&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">lp5521_set_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">LP5521_CMD_LOAD</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
		<span class="n">lp5521_set_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">LP5521_CMD_DISABLED</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define store_mode(nr)							\</span>
<span class="cp">static ssize_t store_engine##nr##_mode(struct device *dev,		\</span>
<span class="cp">				     struct device_attribute *attr,	\</span>
<span class="cp">				     const char *buf, size_t len)	\</span>
<span class="cp">{									\</span>
<span class="cp">	return store_engine_mode(dev, attr, buf, len, nr);		\</span>
<span class="cp">}</span>
<span class="n">store_mode</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">store_mode</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">store_mode</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">show_max_current</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5521_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">cdev_to_led</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">max_current</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">show_current</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5521_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">cdev_to_led</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">led_current</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">store_current</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5521_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">cdev_to_led</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">led_to_lp5521</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">curr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">curr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curr</span> <span class="o">&gt;</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">max_current</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5521_set_led_current</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">curr</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">led_current</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">curr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">lp5521_selftest</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5521_run_selftest</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span> <span class="o">?</span> <span class="s">&quot;FAIL&quot;</span> <span class="o">:</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">lp5521_clear_program_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rgb_mem</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">LP5521_REG_R_PROG_MEM</span><span class="p">,</span>
		<span class="n">LP5521_REG_G_PROG_MEM</span><span class="p">,</span>
		<span class="n">LP5521_REG_B_PROG_MEM</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rgb_mem</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp5521_write</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">rgb_mem</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">lp5521_write</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">rgb_mem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">lp5521_write_program_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">base</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rgb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rgb</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">lp5521_write</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">rgb</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>

	<span class="n">lp5521_write</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lp5521_write</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">lp5521_led_pattern</span> <span class="o">*</span><span class="n">lp5521_get_pattern</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5521_led_pattern</span> <span class="o">*</span><span class="n">ptn</span><span class="p">;</span>
	<span class="n">ptn</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">patterns</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ptn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">lp5521_run_led_pattern</span><span class="p">(</span><span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5521_led_pattern</span> <span class="o">*</span><span class="n">ptn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_patterns</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_patterns</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;</span> <span class="n">num_patterns</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">PATTERN_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp5521_write</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">LP5521_REG_ENABLE</span><span class="p">,</span> <span class="n">LP5521_ENABLE_DEFAULT</span><span class="p">);</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
		<span class="n">lp5521_write</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">LP5521_REG_OP_MODE</span><span class="p">,</span> <span class="n">LP5521_CMD_DIRECT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ptn</span> <span class="o">=</span> <span class="n">lp5521_get_pattern</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptn</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">lp5521_write</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">LP5521_REG_OP_MODE</span><span class="p">,</span> <span class="n">LP5521_CMD_LOAD</span><span class="p">);</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>

		<span class="n">lp5521_clear_program_memory</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>

		<span class="n">lp5521_write_program_memory</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">LP5521_REG_R_PROG_MEM</span><span class="p">,</span>
					<span class="n">ptn</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">,</span> <span class="n">ptn</span><span class="o">-&gt;</span><span class="n">size_r</span><span class="p">);</span>
		<span class="n">lp5521_write_program_memory</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">LP5521_REG_G_PROG_MEM</span><span class="p">,</span>
					<span class="n">ptn</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">,</span> <span class="n">ptn</span><span class="o">-&gt;</span><span class="n">size_g</span><span class="p">);</span>
		<span class="n">lp5521_write_program_memory</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">LP5521_REG_B_PROG_MEM</span><span class="p">,</span>
					<span class="n">ptn</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="n">ptn</span><span class="o">-&gt;</span><span class="n">size_b</span><span class="p">);</span>

		<span class="n">lp5521_write</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">LP5521_REG_OP_MODE</span><span class="p">,</span> <span class="n">LP5521_CMD_RUN</span><span class="p">);</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
		<span class="n">lp5521_write</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">LP5521_REG_ENABLE</span><span class="p">,</span> <span class="n">LP5521_ENABLE_RUN_PROGRAM</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">store_led_pattern</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lp5521_run_led_pattern</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* led class device attributes */</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">led_current</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_current</span><span class="p">,</span> <span class="n">store_current</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">max_current</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="p">,</span> <span class="n">show_max_current</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">lp5521_led_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_led_current</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_max_current</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">lp5521_led_attribute_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">lp5521_led_attributes</span>
<span class="p">};</span>

<span class="cm">/* device attributes */</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">engine1_mode</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_engine1_mode</span><span class="p">,</span> <span class="n">store_engine1_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">engine2_mode</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_engine2_mode</span><span class="p">,</span> <span class="n">store_engine2_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">engine3_mode</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_engine3_mode</span><span class="p">,</span> <span class="n">store_engine3_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">engine1_load</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">store_engine1_load</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">engine2_load</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">store_engine2_load</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">engine3_load</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">store_engine3_load</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">selftest</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">lp5521_selftest</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">led_pattern</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">store_led_pattern</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">lp5521_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_engine1_mode</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_engine2_mode</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_engine3_mode</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_selftest</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_engine1_load</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_engine2_load</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_engine3_load</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_led_pattern</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">lp5521_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">lp5521_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5521_register_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp5521_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lp5521_unregister_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp5521_group</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_leds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">lp5521_led_attribute_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">lp5521_init_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5521_led</span> <span class="o">*</span><span class="n">led</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lp5521_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="n">LP5521_MAX_LEDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">led_config</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">led_current</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">led_current</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">led_config</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">led_current</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">max_current</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">led_config</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">max_current</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">chan_nr</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">led_config</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">chan_nr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">chan_nr</span> <span class="o">&gt;=</span> <span class="n">LP5521_MAX_LEDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Use channel numbers between 0 and %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">LP5521_MAX_LEDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">.</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">lp5521_set_brightness</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">led_config</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">led_config</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s:channel%d&quot;</span><span class="p">,</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">label</span> <span class="o">?:</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t register led on channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">lp5521_led_attribute_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t register current attribute</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">lp5521_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5521_chip</span>		<span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lp5521_platform_data</span>	<span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">led</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span>   <span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup_resources</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup_resources</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span> <span class="cm">/* Keep enable down at least 1ms */</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span> <span class="cm">/* 500us abs min. */</span>
	<span class="p">}</span>

	<span class="n">lp5521_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_RESET</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">);</span> <span class="cm">/*</span>
<span class="cm">				     * Exact value is not available. 10 - 20ms</span>
<span class="cm">				     * appears to be enough for reset.</span>
<span class="cm">				     */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure that the chip is reset by reading back the r channel</span>
<span class="cm">	 * current reg. This is dummy read is required on some platforms -</span>
<span class="cm">	 * otherwise further access to the R G B channels in the</span>
<span class="cm">	 * LP5521_REG_ENABLE register will not have any effect - strange!</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5521_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5521_REG_R_CURRENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">buf</span> <span class="o">!=</span> <span class="n">LP5521_REG_R_CURR_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error in resetting chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5521_detect</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Chip not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s programmable led chip found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5521_configure</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error configuring chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize leds */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_leds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">led</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Do not initialize channels that are not connected */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">led_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">led_current</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5521_init_led</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">led</span><span class="p">],</span> <span class="n">client</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pdata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error initializing leds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_leds</span><span class="o">++</span><span class="p">;</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">led</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">led</span><span class="p">;</span>
		<span class="cm">/* Set initial LED current */</span>
		<span class="n">lp5521_set_led_current</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">led</span><span class="p">,</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">led</span><span class="p">].</span><span class="n">led_current</span><span class="p">);</span>

		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">led</span><span class="p">].</span><span class="n">brightness_work</span><span class="p">),</span>
			<span class="n">lp5521_led_brightness_work</span><span class="p">);</span>

		<span class="n">led</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5521_register_sysfs</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;registering sysfs failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">fail3:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_leds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">);</span>
		<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">brightness_work</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">fail2:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">release_resources</span><span class="p">)</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">release_resources</span><span class="p">();</span>
<span class="nl">fail1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">lp5521_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5521_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">lp5521_run_led_pattern</span><span class="p">(</span><span class="n">PATTERN_OFF</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="n">lp5521_unregister_sysfs</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_leds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">);</span>
		<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">brightness_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">release_resources</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">release_resources</span><span class="p">();</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">lp5521_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;lp5521&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* Three channel chip */</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">lp5521_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">lp5521_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;lp5521&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">lp5521_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">lp5521_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">lp5521_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">lp5521_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mathias Nyman, Yuri Zaporozhets, Samu Onkalo&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;LP5521 LED engine&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
