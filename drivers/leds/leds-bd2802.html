<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › leds › leds-bd2802.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>leds-bd2802.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * leds-bd2802.c - RGB LED Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Samsung Electronics</span>
<span class="cm"> * Kim Kyuwon &lt;q1.kim@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Datasheet: http://www.rohm.com/products/databook/driver/pdf/bd2802gu-e.pdf</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/leds-bd2802.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>

<span class="cp">#define LED_CTL(rgb2en, rgb1en) ((rgb2en) &lt;&lt; 4 | ((rgb1en) &lt;&lt; 0))</span>

<span class="cp">#define BD2802_LED_OFFSET		0xa</span>
<span class="cp">#define BD2802_COLOR_OFFSET		0x3</span>

<span class="cp">#define BD2802_REG_CLKSETUP 		0x00</span>
<span class="cp">#define BD2802_REG_CONTROL 		0x01</span>
<span class="cp">#define BD2802_REG_HOURSETUP		0x02</span>
<span class="cp">#define BD2802_REG_CURRENT1SETUP	0x03</span>
<span class="cp">#define BD2802_REG_CURRENT2SETUP	0x04</span>
<span class="cp">#define BD2802_REG_WAVEPATTERN		0x05</span>

<span class="cp">#define BD2802_CURRENT_032		0x10 </span><span class="cm">/* 3.2mA */</span><span class="cp"></span>
<span class="cp">#define BD2802_CURRENT_000		0x00 </span><span class="cm">/* 0.0mA */</span><span class="cp"></span>

<span class="cp">#define BD2802_PATTERN_FULL		0x07</span>
<span class="cp">#define BD2802_PATTERN_HALF		0x03</span>

<span class="k">enum</span> <span class="n">led_ids</span> <span class="p">{</span>
	<span class="n">LED1</span><span class="p">,</span>
	<span class="n">LED2</span><span class="p">,</span>
	<span class="n">LED_NUM</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">led_colors</span> <span class="p">{</span>
	<span class="n">RED</span><span class="p">,</span>
	<span class="n">GREEN</span><span class="p">,</span>
	<span class="n">BLUE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">led_bits</span> <span class="p">{</span>
	<span class="n">BD2802_OFF</span><span class="p">,</span>
	<span class="n">BD2802_BLINK</span><span class="p">,</span>
	<span class="n">BD2802_ON</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * State &#39;0&#39; : &#39;off&#39;</span>
<span class="cm"> * State &#39;1&#39; : &#39;blink&#39;</span>
<span class="cm"> * State &#39;2&#39; : &#39;on&#39;.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">led_state</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">r</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">g</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">b</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">bd2802_led</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">bd2802_led_platform_data</span>	<span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>		<span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rw_semaphore</span>		<span class="n">rwsem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>		<span class="n">work</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">led_state</span>		<span class="n">led</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Making led_classdev as array is not recommended, because array</span>
<span class="cm">	 * members prevent using &#39;container_of&#39; macro. So repetitive works</span>
<span class="cm">	 * are needed.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">led_classdev</span>		<span class="n">cdev_led1r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">led_classdev</span>		<span class="n">cdev_led1g</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">led_classdev</span>		<span class="n">cdev_led1b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">led_classdev</span>		<span class="n">cdev_led2r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">led_classdev</span>		<span class="n">cdev_led2g</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">led_classdev</span>		<span class="n">cdev_led2b</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Advanced Configuration Function(ADF) mode:</span>
<span class="cm">	 * In ADF mode, user can set registers of BD2802GU directly,</span>
<span class="cm">	 * therefore BD2802GU doesn&#39;t enter reset state.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> 				<span class="n">adf_on</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">led_ids</span>			<span class="n">led_id</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">led_colors</span>			<span class="n">color</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">led_bits</span>			<span class="n">state</span><span class="p">;</span>

	<span class="cm">/* General attributes of RGB LEDs */</span>
	<span class="kt">int</span>				<span class="n">wave_pattern</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">rgb_current</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/*--------------------------------------------------------------*/</span>
<span class="cm">/*	BD2802GU helper functions					*/</span>
<span class="cm">/*--------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bd2802_is_rgb_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span><span class="p">,</span> <span class="k">enum</span> <span class="n">led_ids</span> <span class="n">id</span><span class="p">,</span>
							<span class="k">enum</span> <span class="n">led_colors</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RED</span>:
		<span class="k">return</span> <span class="o">!</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">r</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GREEN</span>:
		<span class="k">return</span> <span class="o">!</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">g</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BLUE</span>:
		<span class="k">return</span> <span class="o">!</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">b</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Invalid color</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bd2802_is_led_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span><span class="p">,</span> <span class="k">enum</span> <span class="n">led_ids</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">r</span> <span class="o">||</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">g</span> <span class="o">||</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">b</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bd2802_is_all_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LED_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bd2802_is_led_off</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">bd2802_get_base_offset</span><span class="p">(</span><span class="k">enum</span> <span class="n">led_ids</span> <span class="n">id</span><span class="p">,</span> <span class="k">enum</span> <span class="n">led_colors</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">id</span> <span class="o">*</span> <span class="n">BD2802_LED_OFFSET</span> <span class="o">+</span> <span class="n">color</span> <span class="o">*</span> <span class="n">BD2802_COLOR_OFFSET</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">bd2802_get_reg_addr</span><span class="p">(</span><span class="k">enum</span> <span class="n">led_ids</span> <span class="n">id</span><span class="p">,</span> <span class="k">enum</span> <span class="n">led_colors</span> <span class="n">color</span><span class="p">,</span>
								<span class="n">u8</span> <span class="n">reg_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">reg_offset</span> <span class="o">+</span> <span class="n">bd2802_get_base_offset</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*--------------------------------------------------------------*/</span>
<span class="cm">/*	BD2802GU core functions					*/</span>
<span class="cm">/*--------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bd2802_write_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: reg 0x%x, val 0x%x, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bd2802_update_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span><span class="p">,</span> <span class="k">enum</span> <span class="n">led_ids</span> <span class="n">id</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">led_colors</span> <span class="n">color</span><span class="p">,</span> <span class="k">enum</span> <span class="n">led_bits</span> <span class="n">led_bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LED_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">RED</span>:
				<span class="n">led</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="n">led_bit</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GREEN</span>:
				<span class="n">led</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">g</span> <span class="o">=</span> <span class="n">led_bit</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">BLUE</span>:
				<span class="n">led</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b</span> <span class="o">=</span> <span class="n">led_bit</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s: Invalid color</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">led_bit</span> <span class="o">==</span> <span class="n">BD2802_BLINK</span> <span class="o">||</span> <span class="n">led_bit</span> <span class="o">==</span> <span class="n">BD2802_ON</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bd2802_is_led_off</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bd2802_is_all_off</span><span class="p">(</span><span class="n">led</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">adf_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">reset_gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * In this case, other led is turned on, and current led is turned</span>
<span class="cm">	 * off. So set RGB LED Control register to stop the current RGB LED</span>
<span class="cm">	 */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">LED1</span><span class="p">)</span> <span class="o">?</span> <span class="n">LED_CTL</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="n">LED_CTL</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bd2802_write_byte</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">BD2802_REG_CONTROL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bd2802_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bd2802_led_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">bd2802_get_reg_addr</span><span class="p">(</span><span class="n">LED1</span><span class="p">,</span> <span class="n">RED</span><span class="p">,</span> <span class="n">BD2802_REG_HOURSETUP</span><span class="p">);</span>
	<span class="n">bd2802_write_byte</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">rgb_time</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">bd2802_get_reg_addr</span><span class="p">(</span><span class="n">LED2</span><span class="p">,</span> <span class="n">RED</span><span class="p">,</span> <span class="n">BD2802_REG_HOURSETUP</span><span class="p">);</span>
	<span class="n">bd2802_write_byte</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">rgb_time</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bd2802_reset_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">reset_gpio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">bd2802_configure</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bd2802_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span><span class="p">,</span> <span class="k">enum</span> <span class="n">led_ids</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">led_ids</span> <span class="n">other_led</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">LED1</span><span class="p">)</span> <span class="o">?</span> <span class="n">LED2</span> <span class="o">:</span> <span class="n">LED1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">,</span> <span class="n">other_led_on</span><span class="p">;</span>

	<span class="n">other_led_on</span> <span class="o">=</span> <span class="o">!</span><span class="n">bd2802_is_led_off</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">other_led</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">LED1</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">LED_CTL</span><span class="p">(</span><span class="n">other_led_on</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">LED_CTL</span><span class="p">(</span><span class="mi">1</span> <span class="p">,</span> <span class="n">other_led_on</span><span class="p">);</span>

	<span class="n">bd2802_write_byte</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">BD2802_REG_CONTROL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bd2802_set_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span><span class="p">,</span> <span class="k">enum</span> <span class="n">led_ids</span> <span class="n">id</span><span class="p">,</span>
							<span class="k">enum</span> <span class="n">led_colors</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bd2802_is_all_off</span><span class="p">(</span><span class="n">led</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">adf_on</span><span class="p">)</span>
		<span class="n">bd2802_reset_cancel</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">bd2802_get_reg_addr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">BD2802_REG_CURRENT1SETUP</span><span class="p">);</span>
	<span class="n">bd2802_write_byte</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">rgb_current</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">bd2802_get_reg_addr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">BD2802_REG_CURRENT2SETUP</span><span class="p">);</span>
	<span class="n">bd2802_write_byte</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">BD2802_CURRENT_000</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">bd2802_get_reg_addr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">BD2802_REG_WAVEPATTERN</span><span class="p">);</span>
	<span class="n">bd2802_write_byte</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">BD2802_PATTERN_FULL</span><span class="p">);</span>

	<span class="n">bd2802_enable</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="n">bd2802_update_state</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">BD2802_ON</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bd2802_set_blink</span><span class="p">(</span><span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span><span class="p">,</span> <span class="k">enum</span> <span class="n">led_ids</span> <span class="n">id</span><span class="p">,</span>
							<span class="k">enum</span> <span class="n">led_colors</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bd2802_is_all_off</span><span class="p">(</span><span class="n">led</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">adf_on</span><span class="p">)</span>
		<span class="n">bd2802_reset_cancel</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">bd2802_get_reg_addr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">BD2802_REG_CURRENT1SETUP</span><span class="p">);</span>
	<span class="n">bd2802_write_byte</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">BD2802_CURRENT_000</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">bd2802_get_reg_addr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">BD2802_REG_CURRENT2SETUP</span><span class="p">);</span>
	<span class="n">bd2802_write_byte</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">rgb_current</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">bd2802_get_reg_addr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">BD2802_REG_WAVEPATTERN</span><span class="p">);</span>
	<span class="n">bd2802_write_byte</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">wave_pattern</span><span class="p">);</span>

	<span class="n">bd2802_enable</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="n">bd2802_update_state</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">BD2802_BLINK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bd2802_turn_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span><span class="p">,</span> <span class="k">enum</span> <span class="n">led_ids</span> <span class="n">id</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">led_colors</span> <span class="n">color</span><span class="p">,</span> <span class="k">enum</span> <span class="n">led_bits</span> <span class="n">led_bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">led_bit</span> <span class="o">==</span> <span class="n">BD2802_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Only &#39;blink&#39; and &#39;on&#39; are allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">led_bit</span> <span class="o">==</span> <span class="n">BD2802_BLINK</span><span class="p">)</span>
		<span class="n">bd2802_set_blink</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bd2802_set_on</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bd2802_turn_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span><span class="p">,</span> <span class="k">enum</span> <span class="n">led_ids</span> <span class="n">id</span><span class="p">,</span>
							<span class="k">enum</span> <span class="n">led_colors</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bd2802_is_rgb_off</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">color</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">bd2802_get_reg_addr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">BD2802_REG_CURRENT1SETUP</span><span class="p">);</span>
	<span class="n">bd2802_write_byte</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">BD2802_CURRENT_000</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">bd2802_get_reg_addr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">BD2802_REG_CURRENT2SETUP</span><span class="p">);</span>
	<span class="n">bd2802_write_byte</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">BD2802_CURRENT_000</span><span class="p">);</span>

	<span class="n">bd2802_update_state</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">BD2802_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define BD2802_SET_REGISTER(reg_addr, reg_name)				\</span>
<span class="cp">static ssize_t bd2802_store_reg##reg_addr(struct device *dev,		\</span>
<span class="cp">	struct device_attribute *attr, const char *buf, size_t count)	\</span>
<span class="cp">{									\</span>
<span class="cp">	struct bd2802_led *led = i2c_get_clientdata(to_i2c_client(dev));\</span>
<span class="cp">	unsigned long val;						\</span>
<span class="cp">	int ret;							\</span>
<span class="cp">	if (!count)							\</span>
<span class="cp">		return -EINVAL;						\</span>
<span class="cp">	ret = strict_strtoul(buf, 16, &amp;val);				\</span>
<span class="cp">	if (ret)							\</span>
<span class="cp">		return ret;						\</span>
<span class="cp">	down_write(&amp;led-&gt;rwsem);					\</span>
<span class="cp">	bd2802_write_byte(led-&gt;client, reg_addr, (u8) val);		\</span>
<span class="cp">	up_write(&amp;led-&gt;rwsem);						\</span>
<span class="cp">	return count;							\</span>
<span class="cp">}									\</span>
<span class="cp">static struct device_attribute bd2802_reg##reg_addr##_attr = {		\</span>
<span class="cp">	.attr = {.name = reg_name, .mode = 0644},			\</span>
<span class="cp">	.store = bd2802_store_reg##reg_addr,				\</span>
<span class="cp">};</span>

<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="s">&quot;0x00&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="s">&quot;0x01&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="s">&quot;0x02&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="s">&quot;0x03&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="s">&quot;0x04&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x05</span><span class="p">,</span> <span class="s">&quot;0x05&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x06</span><span class="p">,</span> <span class="s">&quot;0x06&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="s">&quot;0x07&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span> <span class="s">&quot;0x08&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x09</span><span class="p">,</span> <span class="s">&quot;0x09&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x0a</span><span class="p">,</span> <span class="s">&quot;0x0a&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x0b</span><span class="p">,</span> <span class="s">&quot;0x0b&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x0c</span><span class="p">,</span> <span class="s">&quot;0x0c&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x0d</span><span class="p">,</span> <span class="s">&quot;0x0d&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x0e</span><span class="p">,</span> <span class="s">&quot;0x0e&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x0f</span><span class="p">,</span> <span class="s">&quot;0x0f&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s">&quot;0x10&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x11</span><span class="p">,</span> <span class="s">&quot;0x11&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x12</span><span class="p">,</span> <span class="s">&quot;0x12&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x13</span><span class="p">,</span> <span class="s">&quot;0x13&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x14</span><span class="p">,</span> <span class="s">&quot;0x14&quot;</span><span class="p">);</span>
<span class="n">BD2802_SET_REGISTER</span><span class="p">(</span><span class="mh">0x15</span><span class="p">,</span> <span class="s">&quot;0x15&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">bd2802_addr_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x00_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x01_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x02_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x03_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x04_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x05_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x06_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x07_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x08_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x09_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x0a_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x0b_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x0c_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x0d_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x0e_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x0f_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x10_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x11_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x12_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x13_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x14_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_reg0x15_attr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bd2802_enable_adv_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bd2802_addr_attributes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">bd2802_addr_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed: sysfs file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">bd2802_addr_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_remove_files</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bd2802_is_all_off</span><span class="p">(</span><span class="n">led</span><span class="p">))</span>
		<span class="n">bd2802_reset_cancel</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">adf_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">failed_remove_files:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">bd2802_addr_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bd2802_disable_adv_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bd2802_addr_attributes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">bd2802_addr_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bd2802_is_all_off</span><span class="p">(</span><span class="n">led</span><span class="p">))</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">reset_gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">adf_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bd2802_show_adv_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">rwsem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">adf_on</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">rwsem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bd2802_store_adv_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">rwsem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">adf_on</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;on&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">bd2802_enable_adv_conf</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">adf_on</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">bd2802_disable_adv_conf</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">rwsem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">bd2802_adv_conf_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;advanced_configuration&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">bd2802_show_adv_conf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">bd2802_store_adv_conf</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define BD2802_CONTROL_ATTR(attr_name, name_str)			\</span>
<span class="cp">static ssize_t bd2802_show_##attr_name(struct device *dev,		\</span>
<span class="cp">	struct device_attribute *attr, char *buf)			\</span>
<span class="cp">{									\</span>
<span class="cp">	struct bd2802_led *led = i2c_get_clientdata(to_i2c_client(dev));\</span>
<span class="cp">	ssize_t ret;							\</span>
<span class="cp">	down_read(&amp;led-&gt;rwsem);						\</span>
<span class="cp">	ret = sprintf(buf, &quot;0x%02x\n&quot;, led-&gt;attr_name);			\</span>
<span class="cp">	up_read(&amp;led-&gt;rwsem);						\</span>
<span class="cp">	return ret;							\</span>
<span class="cp">}									\</span>
<span class="cp">static ssize_t bd2802_store_##attr_name(struct device *dev,		\</span>
<span class="cp">	struct device_attribute *attr, const char *buf, size_t count)	\</span>
<span class="cp">{									\</span>
<span class="cp">	struct bd2802_led *led = i2c_get_clientdata(to_i2c_client(dev));\</span>
<span class="cp">	unsigned long val;						\</span>
<span class="cp">	int ret;							\</span>
<span class="cp">	if (!count)							\</span>
<span class="cp">		return -EINVAL;						\</span>
<span class="cp">	ret = strict_strtoul(buf, 16, &amp;val);				\</span>
<span class="cp">	if (ret)							\</span>
<span class="cp">		return ret;						\</span>
<span class="cp">	down_write(&amp;led-&gt;rwsem);					\</span>
<span class="cp">	led-&gt;attr_name = val;						\</span>
<span class="cp">	up_write(&amp;led-&gt;rwsem);						\</span>
<span class="cp">	return count;							\</span>
<span class="cp">}									\</span>
<span class="cp">static struct device_attribute bd2802_##attr_name##_attr = {		\</span>
<span class="cp">	.attr = {							\</span>
<span class="cp">		.name = name_str,					\</span>
<span class="cp">		.mode = 0644,						\</span>
<span class="cp">	},								\</span>
<span class="cp">	.show = bd2802_show_##attr_name,				\</span>
<span class="cp">	.store = bd2802_store_##attr_name,				\</span>
<span class="cp">};</span>

<span class="n">BD2802_CONTROL_ATTR</span><span class="p">(</span><span class="n">wave_pattern</span><span class="p">,</span> <span class="s">&quot;wave_pattern&quot;</span><span class="p">);</span>
<span class="n">BD2802_CONTROL_ATTR</span><span class="p">(</span><span class="n">rgb_current</span><span class="p">,</span> <span class="s">&quot;rgb_current&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">bd2802_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">bd2802_adv_conf_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_wave_pattern_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bd2802_rgb_current_attr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bd2802_led_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bd2802_led</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span>
		<span class="n">bd2802_turn_on</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">led_id</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bd2802_turn_off</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">led_id</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define BD2802_CONTROL_RGBS(name, id, clr)				\</span>
<span class="cp">static void bd2802_set_##name##_brightness(struct led_classdev *led_cdev,\</span>
<span class="cp">					enum led_brightness value)	\</span>
<span class="cp">{									\</span>
<span class="cp">	struct bd2802_led *led =					\</span>
<span class="cp">		container_of(led_cdev, struct bd2802_led, cdev_##name);	\</span>
<span class="cp">	led-&gt;led_id = id;						\</span>
<span class="cp">	led-&gt;color = clr;						\</span>
<span class="cp">	if (value == LED_OFF)						\</span>
<span class="cp">		led-&gt;state = BD2802_OFF;				\</span>
<span class="cp">	else								\</span>
<span class="cp">		led-&gt;state = BD2802_ON;					\</span>
<span class="cp">	schedule_work(&amp;led-&gt;work);					\</span>
<span class="cp">}									\</span>
<span class="cp">static int bd2802_set_##name##_blink(struct led_classdev *led_cdev,	\</span>
<span class="cp">		unsigned long *delay_on, unsigned long *delay_off)	\</span>
<span class="cp">{									\</span>
<span class="cp">	struct bd2802_led *led =					\</span>
<span class="cp">		container_of(led_cdev, struct bd2802_led, cdev_##name);	\</span>
<span class="cp">	if (*delay_on == 0 || *delay_off == 0)				\</span>
<span class="cp">		return -EINVAL;						\</span>
<span class="cp">	led-&gt;led_id = id;						\</span>
<span class="cp">	led-&gt;color = clr;						\</span>
<span class="cp">	led-&gt;state = BD2802_BLINK;					\</span>
<span class="cp">	schedule_work(&amp;led-&gt;work);					\</span>
<span class="cp">	return 0;							\</span>
<span class="cp">}</span>

<span class="n">BD2802_CONTROL_RGBS</span><span class="p">(</span><span class="n">led1r</span><span class="p">,</span> <span class="n">LED1</span><span class="p">,</span> <span class="n">RED</span><span class="p">);</span>
<span class="n">BD2802_CONTROL_RGBS</span><span class="p">(</span><span class="n">led1g</span><span class="p">,</span> <span class="n">LED1</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">);</span>
<span class="n">BD2802_CONTROL_RGBS</span><span class="p">(</span><span class="n">led1b</span><span class="p">,</span> <span class="n">LED1</span><span class="p">,</span> <span class="n">BLUE</span><span class="p">);</span>
<span class="n">BD2802_CONTROL_RGBS</span><span class="p">(</span><span class="n">led2r</span><span class="p">,</span> <span class="n">LED2</span><span class="p">,</span> <span class="n">RED</span><span class="p">);</span>
<span class="n">BD2802_CONTROL_RGBS</span><span class="p">(</span><span class="n">led2g</span><span class="p">,</span> <span class="n">LED2</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">);</span>
<span class="n">BD2802_CONTROL_RGBS</span><span class="p">(</span><span class="n">led2b</span><span class="p">,</span> <span class="n">LED2</span><span class="p">,</span> <span class="n">BLUE</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bd2802_register_led_classdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">bd2802_led_work</span><span class="p">);</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1r</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;led1_R&quot;</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1r</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">LED_OFF</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1r</span><span class="p">.</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">bd2802_set_led1r_brightness</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1r</span><span class="p">.</span><span class="n">blink_set</span> <span class="o">=</span> <span class="n">bd2802_set_led1r_blink</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t register LED %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1r</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_unregister_led1_R</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1g</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;led1_G&quot;</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1g</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">LED_OFF</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1g</span><span class="p">.</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">bd2802_set_led1g_brightness</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1g</span><span class="p">.</span><span class="n">blink_set</span> <span class="o">=</span> <span class="n">bd2802_set_led1g_blink</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1g</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t register LED %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1g</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_unregister_led1_G</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1b</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;led1_B&quot;</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1b</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">LED_OFF</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1b</span><span class="p">.</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">bd2802_set_led1b_brightness</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1b</span><span class="p">.</span><span class="n">blink_set</span> <span class="o">=</span> <span class="n">bd2802_set_led1b_blink</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1b</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t register LED %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1b</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_unregister_led1_B</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2r</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;led2_R&quot;</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2r</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">LED_OFF</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2r</span><span class="p">.</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">bd2802_set_led2r_brightness</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2r</span><span class="p">.</span><span class="n">blink_set</span> <span class="o">=</span> <span class="n">bd2802_set_led2r_blink</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t register LED %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2r</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_unregister_led2_R</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2g</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;led2_G&quot;</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2g</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">LED_OFF</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2g</span><span class="p">.</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">bd2802_set_led2g_brightness</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2g</span><span class="p">.</span><span class="n">blink_set</span> <span class="o">=</span> <span class="n">bd2802_set_led2g_blink</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2g</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t register LED %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2g</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_unregister_led2_G</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2b</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;led2_B&quot;</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2b</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">LED_OFF</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2b</span><span class="p">.</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">bd2802_set_led2b_brightness</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2b</span><span class="p">.</span><span class="n">blink_set</span> <span class="o">=</span> <span class="n">bd2802_set_led2b_blink</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2b</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">LED_CORE_SUSPENDRESUME</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2b</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t register LED %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2b</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_unregister_led2_B</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed_unregister_led2_B:</span>
	<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2g</span><span class="p">);</span>
<span class="nl">failed_unregister_led2_G:</span>
	<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2r</span><span class="p">);</span>
<span class="nl">failed_unregister_led2_R:</span>
	<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1b</span><span class="p">);</span>
<span class="nl">failed_unregister_led1_B:</span>
	<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1g</span><span class="p">);</span>
<span class="nl">failed_unregister_led1_G:</span>
	<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1r</span><span class="p">);</span>
<span class="nl">failed_unregister_led1_R:</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bd2802_unregister_led_classdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2b</span><span class="p">);</span>
	<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2g</span><span class="p">);</span>
	<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led2r</span><span class="p">);</span>
	<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1b</span><span class="p">);</span>
	<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1g</span><span class="p">);</span>
	<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev_led1r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bd2802_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bd2802_led_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">led</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bd2802_led</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">led</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate driver data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>

	<span class="cm">/* Configure RESET GPIO (L: RESET, H: RESET cancel) */</span>
	<span class="n">gpio_request_one</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">reset_gpio</span><span class="p">,</span> <span class="n">GPIOF_OUT_INIT_HIGH</span><span class="p">,</span> <span class="s">&quot;RGB_RESETB&quot;</span><span class="p">);</span>

	<span class="cm">/* Tacss = min 0.1ms */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* Detect BD2802GU */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">bd2802_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">BD2802_REG_CLKSETUP</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to detect device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_free</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;return 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* To save the power, reset BD2802 after detecting */</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">reset_gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Default attributes */</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">wave_pattern</span> <span class="o">=</span> <span class="n">BD2802_PATTERN_HALF</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">rgb_current</span> <span class="o">=</span> <span class="n">BD2802_CURRENT_032</span><span class="p">;</span>

	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">rwsem</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bd2802_attributes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">bd2802_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed: sysfs file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">bd2802_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed_unregister_dev_file</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">bd2802_register_led_classdev</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_unregister_dev_file</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed_unregister_dev_file:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bd2802_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="nl">failed_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">bd2802_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">reset_gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bd2802_unregister_led_classdev</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">adf_on</span><span class="p">)</span>
		<span class="n">bd2802_disable_adv_conf</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bd2802_attributes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bd2802_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bd2802_restore_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LED_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">)</span>
			<span class="n">bd2802_turn_on</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">RED</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">g</span><span class="p">)</span>
			<span class="n">bd2802_turn_on</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">g</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b</span><span class="p">)</span>
			<span class="n">bd2802_turn_on</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">BLUE</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bd2802_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">reset_gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bd2802_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bd2802_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bd2802_is_all_off</span><span class="p">(</span><span class="n">led</span><span class="p">)</span> <span class="o">||</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">adf_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bd2802_reset_cancel</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
		<span class="n">bd2802_restore_state</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SIMPLE_DEV_PM_OPS</span><span class="p">(</span><span class="n">bd2802_pm</span><span class="p">,</span> <span class="n">bd2802_suspend</span><span class="p">,</span> <span class="n">bd2802_resume</span><span class="p">);</span>
<span class="cp">#define BD2802_PM (&amp;bd2802_pm)</span>
<span class="cp">#else		</span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>
<span class="cp">#define BD2802_PM NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">bd2802_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;BD2802&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">bd2802_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">bd2802_i2c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;BD2802&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="n">BD2802_PM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">bd2802_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">bd2802_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">bd2802_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">bd2802_i2c_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kim Kyuwon &lt;q1.kim@samsung.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;BD2802 LED driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
