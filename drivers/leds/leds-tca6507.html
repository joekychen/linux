<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › leds › leds-tca6507.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>leds-tca6507.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * leds-tca6507</span>
<span class="cm"> *</span>
<span class="cm"> * The TCA6507 is a programmable LED controller that can drive 7</span>
<span class="cm"> * separate lines either by holding them low, or by pulsing them</span>
<span class="cm"> * with modulated width.</span>
<span class="cm"> * The modulation can be varied in a simple pattern to produce a blink or</span>
<span class="cm"> * double-blink.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver can configure each line either as a &#39;GPIO&#39; which is out-only</span>
<span class="cm"> * (no pull-up) or as an LED with variable brightness and hardware-assisted</span>
<span class="cm"> * blinking.</span>
<span class="cm"> *</span>
<span class="cm"> * Apart from OFF and ON there are three programmable brightness levels which</span>
<span class="cm"> * can be programmed from 0 to 15 and indicate how many 500usec intervals in</span>
<span class="cm"> * each 8msec that the led is &#39;on&#39;.  The levels are named MASTER, BANK0 and</span>
<span class="cm"> * BANK1.</span>
<span class="cm"> *</span>
<span class="cm"> * There are two different blink rates that can be programmed, each with</span>
<span class="cm"> * separate time for rise, on, fall, off and second-off.  Thus if 3 or more</span>
<span class="cm"> * different non-trivial rates are required, software must be used for the extra</span>
<span class="cm"> * rates. The two different blink rates must align with the two levels BANK0 and</span>
<span class="cm"> * BANK1.</span>
<span class="cm"> * This driver does not support double-blink so &#39;second-off&#39; always matches</span>
<span class="cm"> * &#39;off&#39;.</span>
<span class="cm"> *</span>
<span class="cm"> * Only 16 different times can be programmed in a roughly logarithmic scale from</span>
<span class="cm"> * 64ms to 16320ms.  To be precise the possible times are:</span>
<span class="cm"> *    0, 64, 128, 192, 256, 384, 512, 768,</span>
<span class="cm"> *    1024, 1536, 2048, 3072, 4096, 5760, 8128, 16320</span>
<span class="cm"> *</span>
<span class="cm"> * Times that cannot be closely matched with these must be</span>
<span class="cm"> * handled in software.  This driver allows 12.5% error in matching.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver does not allow rise/fall rates to be set explicitly.  When trying</span>
<span class="cm"> * to match a given &#39;on&#39; or &#39;off&#39; period, an appropriate pair of &#39;change&#39; and</span>
<span class="cm"> * &#39;hold&#39; times are chosen to get a close match.  If the target delay is even,</span>
<span class="cm"> * the &#39;change&#39; number will be the smaller; if odd, the &#39;hold&#39; number will be</span>
<span class="cm"> * the smaller.</span>

<span class="cm"> * Choosing pairs of delays with 12.5% errors allows us to match delays in the</span>
<span class="cm"> * ranges: 56-72, 112-144, 168-216, 224-27504, 28560-36720.</span>
<span class="cm"> * 26% of the achievable sums can be matched by multiple pairings. For example</span>
<span class="cm"> * 1536 == 1536+0, 1024+512, or 768+768.  This driver will always choose the</span>
<span class="cm"> * pairing with the least maximum - 768+768 in this case.  Other pairings are</span>
<span class="cm"> * not available.</span>
<span class="cm"> *</span>
<span class="cm"> * Access to the 3 levels and 2 blinks are on a first-come, first-served basis.</span>
<span class="cm"> * Access can be shared by multiple leds if they have the same level and</span>
<span class="cm"> * either same blink rates, or some don&#39;t blink.</span>
<span class="cm"> * When a led changes, it relinquishes access and tries again, so it might</span>
<span class="cm"> * lose access to hardware blink.</span>
<span class="cm"> * If a blink engine cannot be allocated, software blink is used.</span>
<span class="cm"> * If the desired brightness cannot be allocated, the closest available non-zero</span>
<span class="cm"> * brightness is used.  As &#39;full&#39; is always available, the worst case would be</span>
<span class="cm"> * to have two different blink rates at &#39;1&#39;, with Max at &#39;2&#39;, then other leds</span>
<span class="cm"> * will have to choose between &#39;2&#39; and &#39;16&#39;.  Hopefully this is not likely.</span>
<span class="cm"> *</span>
<span class="cm"> * Each bank (BANK0 and BANK1) has two usage counts - LEDs using the brightness</span>
<span class="cm"> * and LEDs using the blink.  It can only be reprogrammed when the appropriate</span>
<span class="cm"> * counter is zero.  The MASTER level has a single usage count.</span>
<span class="cm"> *</span>
<span class="cm"> * Each Led has programmable &#39;on&#39; and &#39;off&#39; time as milliseconds.  With each</span>
<span class="cm"> * there is a flag saying if it was explicitly requested or defaulted.</span>
<span class="cm"> * Similarly the banks know if each time was explicit or a default.  Defaults</span>
<span class="cm"> * are permitted to be changed freely - they are not recognised when matching.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * An led-tca6507 device must be provided with platform data.  This data</span>
<span class="cm"> * lists for each output: the name, default trigger, and whether the signal</span>
<span class="cm"> * is being used as a GPiO rather than an led.  &#39;struct led_plaform_data&#39;</span>
<span class="cm"> * is used for this.  If &#39;name&#39; is NULL, the output isn&#39;t used.  If &#39;flags&#39;</span>
<span class="cm"> * is TCA6507_MAKE_CPIO, the output is a GPO.</span>
<span class="cm"> * The &quot;struct led_platform_data&quot; can be embedded in a</span>
<span class="cm"> * &quot;struct tca6507_platform_data&quot; which adds a &#39;gpio_base&#39; for the GPiOs,</span>
<span class="cm"> * and a &#39;setup&#39; callback which is called once the GPiOs are available.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/leds-tca6507.h&gt;</span>

<span class="cm">/* LED select registers determine the source that drives LED outputs */</span>
<span class="cp">#define TCA6507_LS_LED_OFF	0x0	</span><span class="cm">/* Output HI-Z (off) */</span><span class="cp"></span>
<span class="cp">#define TCA6507_LS_LED_OFF1	0x1	</span><span class="cm">/* Output HI-Z (off) - not used */</span><span class="cp"></span>
<span class="cp">#define TCA6507_LS_LED_PWM0	0x2	</span><span class="cm">/* Output LOW with Bank0 rate */</span><span class="cp"></span>
<span class="cp">#define TCA6507_LS_LED_PWM1	0x3	</span><span class="cm">/* Output LOW with Bank1 rate */</span><span class="cp"></span>
<span class="cp">#define TCA6507_LS_LED_ON	0x4	</span><span class="cm">/* Output LOW (on) */</span><span class="cp"></span>
<span class="cp">#define TCA6507_LS_LED_MIR	0x5	</span><span class="cm">/* Output LOW with Master Intensity */</span><span class="cp"></span>
<span class="cp">#define TCA6507_LS_BLINK0	0x6	</span><span class="cm">/* Blink at Bank0 rate */</span><span class="cp"></span>
<span class="cp">#define TCA6507_LS_BLINK1	0x7	</span><span class="cm">/* Blink at Bank1 rate */</span><span class="cp"></span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">BANK0</span><span class="p">,</span>
	<span class="n">BANK1</span><span class="p">,</span>
	<span class="n">MASTER</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bank_source</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TCA6507_LS_LED_PWM0</span><span class="p">,</span>
	<span class="n">TCA6507_LS_LED_PWM1</span><span class="p">,</span>
	<span class="n">TCA6507_LS_LED_MIR</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">blink_source</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TCA6507_LS_BLINK0</span><span class="p">,</span>
	<span class="n">TCA6507_LS_BLINK1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* PWM registers */</span>
<span class="cp">#define	TCA6507_REG_CNT			11</span>

<span class="cm">/*</span>
<span class="cm"> * 0x00, 0x01, 0x02 encode the TCA6507_LS_* values, each output</span>
<span class="cm"> * owns one bit in each register</span>
<span class="cm"> */</span>
<span class="cp">#define	TCA6507_FADE_ON			0x03</span>
<span class="cp">#define	TCA6507_FULL_ON			0x04</span>
<span class="cp">#define	TCA6507_FADE_OFF		0x05</span>
<span class="cp">#define	TCA6507_FIRST_OFF		0x06</span>
<span class="cp">#define	TCA6507_SECOND_OFF		0x07</span>
<span class="cp">#define	TCA6507_MAX_INTENSITY		0x08</span>
<span class="cp">#define	TCA6507_MASTER_INTENSITY	0x09</span>
<span class="cp">#define	TCA6507_INITIALIZE		0x0A</span>

<span class="cp">#define	INIT_CODE			0x8</span>

<span class="cp">#define TIMECODES 16</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">time_codes</span><span class="p">[</span><span class="n">TIMECODES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">384</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span>
	<span class="mi">1024</span><span class="p">,</span> <span class="mi">1536</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="mi">3072</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="mi">5760</span><span class="p">,</span> <span class="mi">8128</span><span class="p">,</span> <span class="mi">16320</span>
<span class="p">};</span>

<span class="cm">/* Convert an led.brightness level (0..255) to a TCA6507 level (0..15) */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">TO_LEVEL</span><span class="p">(</span><span class="kt">int</span> <span class="n">brightness</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">brightness</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ...and convert back */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">TO_BRIGHT</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NUM_LEDS 7</span>
<span class="k">struct</span> <span class="n">tca6507_chip</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">reg_set</span><span class="p">;</span>	<span class="cm">/* One bit per register where</span>
<span class="cm">						 * a &#39;1&#39; means the register</span>
<span class="cm">						 * should be written */</span>
	<span class="n">u8</span>			<span class="n">reg_file</span><span class="p">[</span><span class="n">TCA6507_REG_CNT</span><span class="p">];</span>
	<span class="cm">/* Bank 2 is Master Intensity and doesn&#39;t use times */</span>
	<span class="k">struct</span> <span class="n">bank</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">level</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ontime</span><span class="p">,</span> <span class="n">offtime</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">on_dflt</span><span class="p">,</span> <span class="n">off_dflt</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">time_use</span><span class="p">,</span> <span class="n">level_use</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">bank</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>	<span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">work</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tca6507_led</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tca6507_chip</span>	<span class="o">*</span><span class="n">chip</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">led_classdev</span>	<span class="n">led_cdev</span><span class="p">;</span>
		<span class="kt">int</span>			<span class="n">num</span><span class="p">;</span>
		<span class="kt">int</span>			<span class="n">ontime</span><span class="p">,</span> <span class="n">offtime</span><span class="p">;</span>
		<span class="kt">int</span>			<span class="n">on_dflt</span><span class="p">,</span> <span class="n">off_dflt</span><span class="p">;</span>
		<span class="kt">int</span>			<span class="n">bank</span><span class="p">;</span>	<span class="cm">/* Bank used, or -1 */</span>
		<span class="kt">int</span>			<span class="n">blink</span><span class="p">;</span>	<span class="cm">/* Set if hardware-blinking */</span>
	<span class="p">}</span> <span class="n">leds</span><span class="p">[</span><span class="n">NUM_LEDS</span><span class="p">];</span>
<span class="cp">#ifdef CONFIG_GPIOLIB</span>
	<span class="k">struct</span> <span class="n">gpio_chip</span>		<span class="n">gpio</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>			<span class="o">*</span><span class="n">gpio_name</span><span class="p">[</span><span class="n">NUM_LEDS</span><span class="p">];</span>
	<span class="kt">int</span>				<span class="n">gpio_map</span><span class="p">[</span><span class="n">NUM_LEDS</span><span class="p">];</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">tca6507_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;tca6507&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">tca6507_id</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">choose_times</span><span class="p">(</span><span class="kt">int</span> <span class="n">msec</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">c1p</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">c2p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Choose two timecodes which add to &#39;msec&#39; as near as possible.</span>
<span class="cm">	 * The first returned is the &#39;on&#39; or &#39;off&#39; time.  The second is to be</span>
<span class="cm">	 * used as a &#39;fade-on&#39; or &#39;fade-off&#39; time.  If &#39;msec&#39; is even,</span>
<span class="cm">	 * the first will not be smaller than the second.  If &#39;msec&#39; is odd,</span>
<span class="cm">	 * the first will not be larger than the second.</span>
<span class="cm">	 * If we cannot get a sum within 1/8 of &#39;msec&#39; fail with -EINVAL,</span>
<span class="cm">	 * otherwise return the sum that was achieved, plus 1 if the first is</span>
<span class="cm">	 * smaller.</span>
<span class="cm">	 * If two possibilities are equally good (e.g. 512+0, 256+256), choose</span>
<span class="cm">	 * the first pair so there is more change-time visible (i.e. it is</span>
<span class="cm">	 * softer).</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmax</span> <span class="o">=</span> <span class="n">msec</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmin</span> <span class="o">=</span> <span class="n">msec</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">diff</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>

	<span class="cm">/* We start at &#39;1&#39; to ensure we never even think of choosing a</span>
<span class="cm">	 * total time of &#39;0&#39;.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">c1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">c1</span> <span class="o">&lt;</span> <span class="n">TIMECODES</span><span class="p">;</span> <span class="n">c1</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="n">time_codes</span><span class="p">[</span><span class="n">c1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">tmin</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">tmax</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">c2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c2</span> <span class="o">&lt;=</span> <span class="n">c1</span><span class="p">;</span> <span class="n">c2</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">tt</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">time_codes</span><span class="p">[</span><span class="n">c2</span><span class="p">];</span>
			<span class="kt">int</span> <span class="n">d</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tt</span> <span class="o">&lt;</span> <span class="n">tmin</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tt</span> <span class="o">&gt;</span> <span class="n">tmax</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* This works! */</span>
			<span class="n">d</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">msec</span> <span class="o">-</span> <span class="n">tt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;=</span> <span class="n">diff</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* Best yet */</span>
			<span class="o">*</span><span class="n">c1p</span> <span class="o">=</span> <span class="n">c1</span><span class="p">;</span>
			<span class="o">*</span><span class="n">c2p</span> <span class="o">=</span> <span class="n">c2</span><span class="p">;</span>
			<span class="n">diff</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">msec</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">65536</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">actual</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msec</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c1</span> <span class="o">=</span> <span class="o">*</span><span class="n">c2p</span><span class="p">;</span>
			<span class="o">*</span><span class="n">c2p</span> <span class="o">=</span> <span class="o">*</span><span class="n">c1p</span><span class="p">;</span>
			<span class="o">*</span><span class="n">c1p</span> <span class="o">=</span> <span class="n">c1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">actual</span> <span class="o">=</span> <span class="n">time_codes</span><span class="p">[</span><span class="o">*</span><span class="n">c1p</span><span class="p">]</span> <span class="o">+</span> <span class="n">time_codes</span><span class="p">[</span><span class="o">*</span><span class="n">c2p</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">c1p</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">c2p</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">actual</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">actual</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* No close match */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update the register file with the appropriate 3-bit state for</span>
<span class="cm"> * the given led.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">tca6507_chip</span> <span class="o">*</span><span class="n">tca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">led</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">led</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">bit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">tca</span><span class="o">-&gt;</span><span class="n">reg_file</span><span class="p">[</span><span class="n">bit</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">))</span>
			<span class="n">n</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">reg_file</span><span class="p">[</span><span class="n">bit</span><span class="p">]</span> <span class="o">!=</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tca</span><span class="o">-&gt;</span><span class="n">reg_file</span><span class="p">[</span><span class="n">bit</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">tca</span><span class="o">-&gt;</span><span class="n">reg_set</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Update the register file with the appropriate 4-bit code for</span>
<span class="cm"> * one bank or other.  This can be used for timers, for levels, or</span>
<span class="cm"> * for initialisation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">tca6507_chip</span> <span class="o">*</span><span class="n">tca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0xF</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bank</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">new</span> <span class="o">&lt;&lt;=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">tca</span><span class="o">-&gt;</span><span class="n">reg_file</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">|=</span> <span class="n">new</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">reg_file</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">!=</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tca</span><span class="o">-&gt;</span><span class="n">reg_file</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">tca</span><span class="o">-&gt;</span><span class="n">reg_set</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">reg</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Update brightness level. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">tca6507_chip</span> <span class="o">*</span><span class="n">tca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bank</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BANK0</span>:
	<span class="k">case</span> <span class="n">BANK1</span>:
		<span class="n">set_code</span><span class="p">(</span><span class="n">tca</span><span class="p">,</span> <span class="n">TCA6507_MAX_INTENSITY</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MASTER</span>:
		<span class="n">set_code</span><span class="p">(</span><span class="n">tca</span><span class="p">,</span> <span class="n">TCA6507_MASTER_INTENSITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">bank</span><span class="p">].</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Record all relevant time code for a given bank */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_times</span><span class="p">(</span><span class="k">struct</span> <span class="n">tca6507_chip</span> <span class="o">*</span><span class="n">tca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">choose_times</span><span class="p">(</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">bank</span><span class="p">].</span><span class="n">ontime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c2</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Chose on  times %d(%d) %d(%d) for %dms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">time_codes</span><span class="p">[</span><span class="n">c1</span><span class="p">],</span>
		<span class="n">c2</span><span class="p">,</span> <span class="n">time_codes</span><span class="p">[</span><span class="n">c2</span><span class="p">],</span> <span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">bank</span><span class="p">].</span><span class="n">ontime</span><span class="p">);</span>
	<span class="n">set_code</span><span class="p">(</span><span class="n">tca</span><span class="p">,</span> <span class="n">TCA6507_FADE_ON</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">c2</span><span class="p">);</span>
	<span class="n">set_code</span><span class="p">(</span><span class="n">tca</span><span class="p">,</span> <span class="n">TCA6507_FULL_ON</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">c1</span><span class="p">);</span>
	<span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">bank</span><span class="p">].</span><span class="n">ontime</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">choose_times</span><span class="p">(</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">bank</span><span class="p">].</span><span class="n">offtime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c2</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Chose off times %d(%d) %d(%d) for %dms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">time_codes</span><span class="p">[</span><span class="n">c1</span><span class="p">],</span>
		<span class="n">c2</span><span class="p">,</span> <span class="n">time_codes</span><span class="p">[</span><span class="n">c2</span><span class="p">],</span> <span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">bank</span><span class="p">].</span><span class="n">offtime</span><span class="p">);</span>
	<span class="n">set_code</span><span class="p">(</span><span class="n">tca</span><span class="p">,</span> <span class="n">TCA6507_FADE_OFF</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">c2</span><span class="p">);</span>
	<span class="n">set_code</span><span class="p">(</span><span class="n">tca</span><span class="p">,</span> <span class="n">TCA6507_FIRST_OFF</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">c1</span><span class="p">);</span>
	<span class="n">set_code</span><span class="p">(</span><span class="n">tca</span><span class="p">,</span> <span class="n">TCA6507_SECOND_OFF</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">c1</span><span class="p">);</span>
	<span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">bank</span><span class="p">].</span><span class="n">offtime</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">set_code</span><span class="p">(</span><span class="n">tca</span><span class="p">,</span> <span class="n">TCA6507_INITIALIZE</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">INIT_CODE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Write all needed register of tca6507 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tca6507_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tca6507_chip</span> <span class="o">*</span><span class="n">tca</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tca6507_chip</span><span class="p">,</span>
						<span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="n">tca</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">set</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">file</span><span class="p">[</span><span class="n">TCA6507_REG_CNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">set</span> <span class="o">=</span> <span class="n">tca</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">tca</span><span class="o">-&gt;</span><span class="n">reg_file</span><span class="p">,</span> <span class="n">TCA6507_REG_CNT</span><span class="p">);</span>
	<span class="n">tca</span><span class="o">-&gt;</span><span class="n">reg_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">TCA6507_REG_CNT</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">r</span><span class="p">))</span>
			<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">file</span><span class="p">[</span><span class="n">r</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">led_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">tca6507_led</span> <span class="o">*</span><span class="n">led</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If led owns any resource, release it. */</span>
	<span class="k">struct</span> <span class="n">tca6507_chip</span> <span class="o">*</span><span class="n">tca</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bank</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">+</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">blink</span><span class="p">)</span>
			<span class="n">b</span><span class="o">-&gt;</span><span class="n">time_use</span><span class="o">--</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">level_use</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">blink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">led_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">tca6507_led</span> <span class="o">*</span><span class="n">led</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Assign this led to a bank, configuring that bank if necessary. */</span>
	<span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">TO_LEVEL</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">.</span><span class="n">brightness</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tca6507_chip</span> <span class="o">*</span><span class="n">tca</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bank</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">TO_BRIGHT</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_select</span><span class="p">(</span><span class="n">tca</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">TCA6507_LS_LED_OFF</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">ontime</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">offtime</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Just set the brightness, choosing first usable bank.</span>
<span class="cm">		 * If none perfect, choose best.</span>
<span class="cm">		 * Count backwards so we check MASTER bank first</span>
<span class="cm">		 * to avoid wasting a timer.</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">best</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="cm">/* full-on */</span>
		<span class="kt">int</span> <span class="n">diff</span> <span class="o">=</span> <span class="mi">15</span><span class="o">-</span><span class="n">level</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_select</span><span class="p">(</span><span class="n">tca</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">TCA6507_LS_LED_ON</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">MASTER</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">BANK0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">d</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">level</span> <span class="o">==</span> <span class="n">level</span> <span class="o">||</span>
			    <span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">level_use</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">best</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">d</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">level</span> <span class="o">-</span> <span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">level</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;</span> <span class="n">diff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diff</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
				<span class="n">best</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">best</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Best brightness is full-on */</span>
			<span class="n">set_select</span><span class="p">(</span><span class="n">tca</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">TCA6507_LS_LED_ON</span><span class="p">);</span>
			<span class="n">led</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">LED_FULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">best</span><span class="p">].</span><span class="n">level_use</span><span class="p">)</span>
			<span class="n">set_level</span><span class="p">(</span><span class="n">tca</span><span class="p">,</span> <span class="n">best</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

		<span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">best</span><span class="p">].</span><span class="n">level_use</span><span class="o">++</span><span class="p">;</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">=</span> <span class="n">best</span><span class="p">;</span>
		<span class="n">set_select</span><span class="p">(</span><span class="n">tca</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">bank_source</span><span class="p">[</span><span class="n">best</span><span class="p">]);</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">TO_BRIGHT</span><span class="p">(</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">best</span><span class="p">].</span><span class="n">level</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have on/off time so we need to try to allocate a timing bank.</span>
<span class="cm">	 * First check if times are compatible with hardware and give up if</span>
<span class="cm">	 * not.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">choose_times</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">ontime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">choose_times</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">offtime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">BANK0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">BANK1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">level_use</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* not in use - it is ours! */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">level</span> <span class="o">!=</span> <span class="n">level</span><span class="p">)</span>
			<span class="cm">/* Incompatible level - skip */</span>
			<span class="cm">/* FIX: if timer matches we maybe should consider</span>
<span class="cm">			 * this anyway...</span>
<span class="cm">			 */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">time_use</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* Timer not in use, and level matches - use it */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">on_dflt</span> <span class="o">||</span>
		      <span class="n">led</span><span class="o">-&gt;</span><span class="n">on_dflt</span> <span class="o">||</span>
		      <span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ontime</span> <span class="o">==</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">ontime</span><span class="p">))</span>
			<span class="cm">/* on time is incompatible */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">off_dflt</span> <span class="o">||</span>
		      <span class="n">led</span><span class="o">-&gt;</span><span class="n">off_dflt</span> <span class="o">||</span>
		      <span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offtime</span> <span class="o">==</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">offtime</span><span class="p">))</span>
			<span class="cm">/* off time is incompatible */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* looks like a suitable match */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">BANK1</span><span class="p">)</span>
		<span class="cm">/* Nothing matches - how sad */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">level_use</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">set_level</span><span class="p">(</span><span class="n">tca</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">level_use</span><span class="o">++</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">on_dflt</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">on_dflt</span> <span class="o">||</span>
	    <span class="n">b</span><span class="o">-&gt;</span><span class="n">time_use</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">ontime</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">ontime</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">on_dflt</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">on_dflt</span><span class="p">;</span>
		<span class="n">need_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">off_dflt</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">off_dflt</span> <span class="o">||</span>
	    <span class="n">b</span><span class="o">-&gt;</span><span class="n">time_use</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">offtime</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">offtime</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">off_dflt</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">off_dflt</span><span class="p">;</span>
		<span class="n">need_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">need_init</span><span class="p">)</span>
		<span class="n">set_times</span><span class="p">(</span><span class="n">tca</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">ontime</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">ontime</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">offtime</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">offtime</span><span class="p">;</span>

	<span class="n">b</span><span class="o">-&gt;</span><span class="n">time_use</span><span class="o">++</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">blink</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">TO_BRIGHT</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>
	<span class="n">set_select</span><span class="p">(</span><span class="n">tca</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">blink_source</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">led_assign</span><span class="p">(</span><span class="k">struct</span> <span class="n">tca6507_led</span> <span class="o">*</span><span class="n">led</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tca6507_chip</span> <span class="o">*</span><span class="n">tca</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">led_release</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">led_prepare</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Can only fail on timer setup.  In that case we need to</span>
<span class="cm">		 * re-establish as steady level.</span>
<span class="cm">		 */</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">ontime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">offtime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">led_prepare</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tca6507_brightness_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">brightness</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tca6507_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tca6507_led</span><span class="p">,</span>
					       <span class="n">led_cdev</span><span class="p">);</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">brightness</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">ontime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">offtime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">led_assign</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tca6507_blink_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">delay_on</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">delay_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tca6507_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tca6507_led</span><span class="p">,</span>
					       <span class="n">led_cdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">delay_on</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">on_dflt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">delay_on</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">led_cdev</span><span class="o">-&gt;</span><span class="n">blink_delay_on</span><span class="p">)</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">on_dflt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">ontime</span> <span class="o">=</span> <span class="o">*</span><span class="n">delay_on</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">delay_off</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">off_dflt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">delay_off</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">led_cdev</span><span class="o">-&gt;</span><span class="n">blink_delay_off</span><span class="p">)</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">off_dflt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">offtime</span> <span class="o">=</span> <span class="o">*</span><span class="n">delay_off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">ontime</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">ontime</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">offtime</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">offtime</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">.</span><span class="n">brightness</span> <span class="o">==</span> <span class="n">LED_OFF</span><span class="p">)</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">LED_FULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">led_assign</span><span class="p">(</span><span class="n">led</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">ontime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">offtime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">LED_OFF</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">delay_on</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">ontime</span><span class="p">;</span>
	<span class="o">*</span><span class="n">delay_off</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">offtime</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_GPIOLIB</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tca6507_gpio_set_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tca6507_chip</span> <span class="o">*</span><span class="n">tca</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tca6507_chip</span><span class="p">,</span> <span class="n">gpio</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * &#39;OFF&#39; is floating high, and &#39;ON&#39; is pulled down, so it has the</span>
<span class="cm">	 * inverse sense of &#39;val&#39;.</span>
<span class="cm">	 */</span>
	<span class="n">set_select</span><span class="p">(</span><span class="n">tca</span><span class="p">,</span> <span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio_map</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span>
		   <span class="n">val</span> <span class="o">?</span> <span class="n">TCA6507_LS_LED_OFF</span> <span class="o">:</span> <span class="n">TCA6507_LS_LED_ON</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">reg_set</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tca6507_gpio_direction_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tca6507_gpio_set_value</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tca6507_probe_gpios</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">tca6507_chip</span> <span class="o">*</span><span class="n">tca</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">tca6507_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gpios</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_LEDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">.</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">.</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Configure as a gpio */</span>
			<span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio_name</span><span class="p">[</span><span class="n">gpios</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">.</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
			<span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio_map</span><span class="p">[</span><span class="n">gpios</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">gpios</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpios</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">label</span> <span class="o">=</span> <span class="s">&quot;gpio-tca6507&quot;</span><span class="p">;</span>
	<span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio_name</span><span class="p">;</span>
	<span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">ngpio</span> <span class="o">=</span> <span class="n">gpios</span><span class="p">;</span>
	<span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_base</span><span class="p">;</span>
	<span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">direction_output</span> <span class="o">=</span> <span class="n">tca6507_gpio_direction_output</span><span class="p">;</span>
	<span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set</span> <span class="o">=</span> <span class="n">tca6507_gpio_set_value</span><span class="p">;</span>
	<span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">gpiochip_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">ngpio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">)</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">ngpio</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tca6507_remove_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">tca6507_chip</span> <span class="o">*</span><span class="n">tca</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">ngpio</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">gpiochip_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;gpiochip_remove()&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_GPIOLIB */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tca6507_probe_gpios</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">tca6507_chip</span> <span class="o">*</span><span class="n">tca</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">tca6507_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tca6507_remove_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">tca6507_chip</span> <span class="o">*</span><span class="n">tca</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_GPIOLIB */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tca6507_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tca6507_chip</span> <span class="o">*</span><span class="n">tca</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tca6507_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="n">to_i2c_adapter</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_I2C</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span> <span class="o">||</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">.</span><span class="n">num_leds</span> <span class="o">!=</span> <span class="n">NUM_LEDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Need %d entries in platform-data list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">NUM_LEDS</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tca</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tca</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tca</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">tca</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">tca6507_work</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">tca</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_LEDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tca6507_led</span> <span class="o">*</span><span class="n">l</span> <span class="o">=</span> <span class="n">tca</span><span class="o">-&gt;</span><span class="n">leds</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">l</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">tca</span><span class="p">;</span>
		<span class="n">l</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">.</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">.</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">.</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
			<span class="n">l</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">.</span><span class="n">default_trigger</span>
				<span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">.</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">default_trigger</span><span class="p">;</span>
			<span class="n">l</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">.</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">tca6507_brightness_set</span><span class="p">;</span>
			<span class="n">l</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">.</span><span class="n">blink_set</span> <span class="o">=</span> <span class="n">tca6507_blink_set</span><span class="p">;</span>
			<span class="n">l</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tca6507_probe_gpios</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">tca</span><span class="p">,</span> <span class="n">pdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="cm">/* set all registers to known state - zero */</span>
	<span class="n">tca</span><span class="o">-&gt;</span><span class="n">reg_set</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">led_cdev</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
			<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">led_cdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tca</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">tca6507_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tca6507_chip</span> <span class="o">*</span><span class="n">tca</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tca6507_led</span> <span class="o">*</span><span class="n">tca_leds</span> <span class="o">=</span> <span class="n">tca</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_LEDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tca_leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">led_cdev</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
			<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca_leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">led_cdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tca6507_remove_gpio</span><span class="p">(</span><span class="n">tca</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tca</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">tca6507_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>   <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>    <span class="o">=</span> <span class="s">&quot;leds-tca6507&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">tca6507_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">tca6507_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">tca6507_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tca6507_leds_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca6507_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">tca6507_leds_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i2c_del_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tca6507_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">tca6507_leds_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">tca6507_leds_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;NeilBrown &lt;neilb@suse.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;TCA6507 LED/GPO driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
