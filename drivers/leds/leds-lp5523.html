<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › leds › leds-lp5523.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>leds-lp5523.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * lp5523.c - LP5523 LED Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Nokia Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Contact: Samu Onkalo &lt;samu.p.onkalo@nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * version 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/leds-lp5523.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#define LP5523_REG_ENABLE		0x00</span>
<span class="cp">#define LP5523_REG_OP_MODE		0x01</span>
<span class="cp">#define LP5523_REG_RATIOMETRIC_MSB	0x02</span>
<span class="cp">#define LP5523_REG_RATIOMETRIC_LSB	0x03</span>
<span class="cp">#define LP5523_REG_ENABLE_LEDS_MSB	0x04</span>
<span class="cp">#define LP5523_REG_ENABLE_LEDS_LSB	0x05</span>
<span class="cp">#define LP5523_REG_LED_CNTRL_BASE	0x06</span>
<span class="cp">#define LP5523_REG_LED_PWM_BASE		0x16</span>
<span class="cp">#define LP5523_REG_LED_CURRENT_BASE	0x26</span>
<span class="cp">#define LP5523_REG_CONFIG		0x36</span>
<span class="cp">#define LP5523_REG_CHANNEL1_PC		0x37</span>
<span class="cp">#define LP5523_REG_CHANNEL2_PC		0x38</span>
<span class="cp">#define LP5523_REG_CHANNEL3_PC		0x39</span>
<span class="cp">#define LP5523_REG_STATUS		0x3a</span>
<span class="cp">#define LP5523_REG_GPO			0x3b</span>
<span class="cp">#define LP5523_REG_VARIABLE		0x3c</span>
<span class="cp">#define LP5523_REG_RESET		0x3d</span>
<span class="cp">#define LP5523_REG_TEMP_CTRL		0x3e</span>
<span class="cp">#define LP5523_REG_TEMP_READ		0x3f</span>
<span class="cp">#define LP5523_REG_TEMP_WRITE		0x40</span>
<span class="cp">#define LP5523_REG_LED_TEST_CTRL	0x41</span>
<span class="cp">#define LP5523_REG_LED_TEST_ADC		0x42</span>
<span class="cp">#define LP5523_REG_ENG1_VARIABLE	0x45</span>
<span class="cp">#define LP5523_REG_ENG2_VARIABLE	0x46</span>
<span class="cp">#define LP5523_REG_ENG3_VARIABLE	0x47</span>
<span class="cp">#define LP5523_REG_MASTER_FADER1	0x48</span>
<span class="cp">#define LP5523_REG_MASTER_FADER2	0x49</span>
<span class="cp">#define LP5523_REG_MASTER_FADER3	0x4a</span>
<span class="cp">#define LP5523_REG_CH1_PROG_START	0x4c</span>
<span class="cp">#define LP5523_REG_CH2_PROG_START	0x4d</span>
<span class="cp">#define LP5523_REG_CH3_PROG_START	0x4e</span>
<span class="cp">#define LP5523_REG_PROG_PAGE_SEL	0x4f</span>
<span class="cp">#define LP5523_REG_PROG_MEM		0x50</span>

<span class="cp">#define LP5523_CMD_LOAD			0x15 </span><span class="cm">/* 00010101 */</span><span class="cp"></span>
<span class="cp">#define LP5523_CMD_RUN			0x2a </span><span class="cm">/* 00101010 */</span><span class="cp"></span>
<span class="cp">#define LP5523_CMD_DISABLED		0x00 </span><span class="cm">/* 00000000 */</span><span class="cp"></span>

<span class="cp">#define LP5523_ENABLE			0x40</span>
<span class="cp">#define LP5523_AUTO_INC			0x40</span>
<span class="cp">#define LP5523_PWR_SAVE			0x20</span>
<span class="cp">#define LP5523_PWM_PWR_SAVE		0x04</span>
<span class="cp">#define LP5523_CP_1			0x08</span>
<span class="cp">#define LP5523_CP_1_5			0x10</span>
<span class="cp">#define LP5523_CP_AUTO			0x18</span>
<span class="cp">#define LP5523_INT_CLK			0x01</span>
<span class="cp">#define LP5523_AUTO_CLK			0x02</span>
<span class="cp">#define LP5523_EN_LEDTEST		0x80</span>
<span class="cp">#define LP5523_LEDTEST_DONE		0x80</span>

<span class="cp">#define LP5523_DEFAULT_CURRENT		50 </span><span class="cm">/* microAmps */</span><span class="cp"></span>
<span class="cp">#define LP5523_PROGRAM_LENGTH		32 </span><span class="cm">/* in bytes */</span><span class="cp"></span>
<span class="cp">#define LP5523_PROGRAM_PAGES		6</span>
<span class="cp">#define LP5523_ADC_SHORTCIRC_LIM	80</span>

<span class="cp">#define LP5523_LEDS			9</span>
<span class="cp">#define LP5523_ENGINES			3</span>

<span class="cp">#define LP5523_ENG_MASK_BASE		0x30 </span><span class="cm">/* 00110000 */</span><span class="cp"></span>

<span class="cp">#define LP5523_ENG_STATUS_MASK          0x07 </span><span class="cm">/* 00000111 */</span><span class="cp"></span>

<span class="cp">#define LP5523_IRQ_FLAGS                IRQF_TRIGGER_FALLING</span>

<span class="cp">#define LP5523_EXT_CLK_USED		0x08</span>

<span class="cp">#define LED_ACTIVE(mux, led)		(!!(mux &amp; (0x0001 &lt;&lt; led)))</span>
<span class="cp">#define SHIFT_MASK(id)			(((id) - 1) * 2)</span>

<span class="k">struct</span> <span class="n">lp5523_engine</span> <span class="p">{</span>
	<span class="kt">int</span>		<span class="n">id</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">mode</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">prog_page</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">mux_page</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">led_mux</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">engine_mask</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">lp5523_led</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">id</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">chan_nr</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">led_current</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">max_current</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">led_classdev</span>     <span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">brightness_work</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">brightness</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">lock</span><span class="p">;</span> <span class="cm">/* Serialize control */</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>	<span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lp5523_engine</span>	<span class="n">engines</span><span class="p">[</span><span class="n">LP5523_ENGINES</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">lp5523_led</span>	<span class="n">leds</span><span class="p">[</span><span class="n">LP5523_LEDS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">lp5523_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">num_channels</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">num_leds</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">lp5523_led</span> <span class="o">*</span><span class="nf">cdev_to_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lp5523_led</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="nf">engine_to_lp5523</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5523_engine</span> <span class="o">*</span><span class="n">engine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lp5523_chip</span><span class="p">,</span>
			    <span class="n">engines</span><span class="p">[</span><span class="n">engine</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="nf">led_to_lp5523</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5523_led</span> <span class="o">*</span><span class="n">led</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lp5523_chip</span><span class="p">,</span>
			    <span class="n">leds</span><span class="p">[</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">lp5523_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5523_engine</span> <span class="o">*</span><span class="n">engine</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lp5523_set_engine_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5523_engine</span> <span class="o">*</span><span class="n">engine</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lp5523_load_program</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5523_engine</span> <span class="o">*</span><span class="n">engine</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pattern</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">lp5523_led_brightness_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5523_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5523_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5523_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_ENABLE</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5523_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5523_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* one pattern per engine setting led mux start and stop addresses */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pattern</span><span class="p">[][</span><span class="n">LP5523_PROGRAM_LENGTH</span><span class="p">]</span> <span class="o">=</span>  <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_ENABLE</span><span class="p">,</span> <span class="n">LP5523_ENABLE</span><span class="p">);</span>
	<span class="cm">/* Chip startup time is 500 us, 1 - 2 ms gives some margin */</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_CONFIG</span><span class="p">,</span>
			    <span class="n">LP5523_AUTO_INC</span> <span class="o">|</span> <span class="n">LP5523_PWR_SAVE</span> <span class="o">|</span>
			    <span class="n">LP5523_CP_AUTO</span> <span class="o">|</span> <span class="n">LP5523_AUTO_CLK</span> <span class="o">|</span>
			    <span class="n">LP5523_PWM_PWR_SAVE</span><span class="p">);</span>

	<span class="cm">/* turn on all leds */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_ENABLE_LEDS_MSB</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_ENABLE_LEDS_LSB</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* hardcode 32 bytes of memory for each engine from program memory */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_CH1_PROG_START</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_CH2_PROG_START</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_CH3_PROG_START</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="cm">/* write led mux address space for each channel */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_load_program</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_load_program</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_load_program</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">pattern</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not load mux programs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set all engines exec state and mode to run 00101010 */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_ENABLE</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">LP5523_CMD_RUN</span> <span class="o">|</span> <span class="n">LP5523_ENABLE</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_OP_MODE</span><span class="p">,</span> <span class="n">LP5523_CMD_RUN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not start mux programs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Let the programs run for couple of ms and check the engine status */</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">6000</span><span class="p">);</span>
	<span class="n">lp5523_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">LP5523_ENG_STATUS_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">LP5523_ENG_STATUS_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;all engines configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;status == %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cound not configure LED engine</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disabling engines</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_OP_MODE</span><span class="p">,</span> <span class="n">LP5523_CMD_DISABLED</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5523_set_engine_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5523_engine</span> <span class="o">*</span><span class="n">engine</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">engine_to_lp5523</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">engine_state</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5523_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_OP_MODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">engine_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">engine_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">engine</span><span class="o">-&gt;</span><span class="n">engine_mask</span><span class="p">);</span>

	<span class="cm">/* set mode only for this engine */</span>
	<span class="n">mode</span> <span class="o">&amp;=</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">engine_mask</span><span class="p">;</span>

	<span class="n">engine_state</span> <span class="o">|=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_OP_MODE</span><span class="p">,</span> <span class="n">engine_state</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5523_load_mux</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5523_engine</span> <span class="o">*</span><span class="n">engine</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mux</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">engine_to_lp5523</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_set_engine_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">LP5523_CMD_LOAD</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_PROG_PAGE_SEL</span><span class="p">,</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">mux_page</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_PROG_MEM</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">mux</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_PROG_MEM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">mux</span><span class="p">));</span>
	<span class="n">engine</span><span class="o">-&gt;</span><span class="n">led_mux</span> <span class="o">=</span> <span class="n">mux</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5523_load_program</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5523_engine</span> <span class="o">*</span><span class="n">engine</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pattern</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">engine_to_lp5523</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_set_engine_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">LP5523_CMD_LOAD</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_PROG_PAGE_SEL</span><span class="p">,</span>
			    <span class="n">engine</span><span class="o">-&gt;</span><span class="n">prog_page</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">i2c_smbus_write_i2c_block_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_PROG_MEM</span><span class="p">,</span>
					      <span class="n">LP5523_PROGRAM_LENGTH</span><span class="p">,</span> <span class="n">pattern</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5523_run_program</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5523_engine</span> <span class="o">*</span><span class="n">engine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">engine_to_lp5523</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_ENABLE</span><span class="p">,</span>
					<span class="n">LP5523_CMD_RUN</span> <span class="o">|</span> <span class="n">LP5523_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5523_set_engine_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">LP5523_CMD_RUN</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5523_mux_parse</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">mux</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp_mux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">LP5523_LEDS</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span> <span class="n">LP5523_LEDS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;1&#39;</span>:
			<span class="n">tmp_mux</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;0&#39;</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;\n&#39;</span>:
			<span class="n">i</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">mux</span> <span class="o">=</span> <span class="n">tmp_mux</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lp5523_mux_to_array</span><span class="p">(</span><span class="n">u16</span> <span class="n">led_mux</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">array</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LP5523_LEDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">array</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="n">LED_ACTIVE</span><span class="p">(</span><span class="n">led_mux</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>

	<span class="n">array</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*--------------------------------------------------------------*/</span>
<span class="cm">/*			Sysfs interface				*/</span>
<span class="cm">/*--------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_engine_leds</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">mux</span><span class="p">[</span><span class="n">LP5523_LEDS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">lp5523_mux_to_array</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">led_mux</span><span class="p">,</span> <span class="n">mux</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mux</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define show_leds(nr)							\</span>
<span class="cp">static ssize_t show_engine##nr##_leds(struct device *dev,		\</span>
<span class="cp">			    struct device_attribute *attr,		\</span>
<span class="cp">			    char *buf)					\</span>
<span class="cp">{									\</span>
<span class="cp">	return show_engine_leds(dev, attr, buf, nr);			\</span>
<span class="cp">}</span>
<span class="n">show_leds</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">show_leds</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">show_leds</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">store_engine_leds</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">mux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp5523_mux_parse</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mux</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">LP5523_CMD_LOAD</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp5523_load_mux</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">mux</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<span class="nl">leave:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define store_leds(nr)						\</span>
<span class="cp">static ssize_t store_engine##nr##_leds(struct device *dev,	\</span>
<span class="cp">			     struct device_attribute *attr,	\</span>
<span class="cp">			     const char *buf, size_t len)	\</span>
<span class="cp">{								\</span>
<span class="cp">	return store_engine_leds(dev, attr, buf, len, nr);	\</span>
<span class="cp">}</span>
<span class="n">store_leds</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">store_leds</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">store_leds</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">lp5523_selftest</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">led</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">adc</span><span class="p">,</span> <span class="n">vdd</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5523_read</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/* Check that ext clock is really in use if requested */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clock_mode</span> <span class="o">==</span> <span class="n">LP5523_CLOCK_EXT</span><span class="p">))</span>
		<span class="k">if</span>  <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LP5523_EXT_CLK_USED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/* Measure VDD (i.e. VBAT) first (channel 16 corresponds to VDD) */</span>
	<span class="n">lp5523_write</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_LED_TEST_CTRL</span><span class="p">,</span>
				    <span class="n">LP5523_EN_LEDTEST</span> <span class="o">|</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">6000</span><span class="p">);</span> <span class="cm">/* ADC conversion time is typically 2.7 ms */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5523_read</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LP5523_LEDTEST_DONE</span><span class="p">))</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">6000</span><span class="p">);</span> <span class="cm">/* Was not ready. Wait little bit */</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_read</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_LED_TEST_ADC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdd</span><span class="p">);</span>
	<span class="n">vdd</span><span class="o">--</span><span class="p">;</span>	<span class="cm">/* There may be some fluctuation in measurement */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LP5523_LEDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Skip non-existing channels */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">led_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">led_current</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Set default current */</span>
		<span class="n">lp5523_write</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
			<span class="n">LP5523_REG_LED_CURRENT_BASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">led_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">led_current</span><span class="p">);</span>

		<span class="n">lp5523_write</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_LED_PWM_BASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="cm">/* let current stabilize 2 - 4ms before measurements start */</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">);</span>
		<span class="n">lp5523_write</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
			     <span class="n">LP5523_REG_LED_TEST_CTRL</span><span class="p">,</span>
			     <span class="n">LP5523_EN_LEDTEST</span> <span class="o">|</span> <span class="n">i</span><span class="p">);</span>
		<span class="cm">/* ADC conversion time is 2.7 ms typically */</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">6000</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5523_read</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LP5523_LEDTEST_DONE</span><span class="p">))</span>
			<span class="n">usleep_range</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">6000</span><span class="p">);</span><span class="cm">/* Was not ready. Wait. */</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">lp5523_read</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_LED_TEST_ADC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adc</span> <span class="o">&gt;=</span> <span class="n">vdd</span> <span class="o">||</span> <span class="n">adc</span> <span class="o">&lt;</span> <span class="n">LP5523_ADC_SHORTCIRC_LIM</span><span class="p">)</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="s">&quot;LED %d FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">lp5523_write</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_LED_PWM_BASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="cm">/* Restore current */</span>
		<span class="n">lp5523_write</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
			<span class="n">LP5523_REG_LED_CURRENT_BASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">led</span><span class="p">].</span><span class="n">led_current</span><span class="p">);</span>
		<span class="n">led</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">release_lock</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">release_lock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">lp5523_set_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">brightness</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5523_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">cdev_to_led</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">brightness</span><span class="p">;</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">brightness_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">lp5523_led_brightness_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5523_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">lp5523_led</span><span class="p">,</span>
					      <span class="n">brightness_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">led_to_lp5523</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_LED_PWM_BASE</span> <span class="o">+</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">chan_nr</span><span class="p">,</span>
		     <span class="n">led</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">lp5523_do_store_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5523_engine</span> <span class="o">*</span><span class="n">engine</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">engine_to_lp5523</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">ret</span><span class="p">,</span> <span class="n">nrchars</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pattern</span><span class="p">[</span><span class="n">LP5523_PROGRAM_LENGTH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">LP5523_PROGRAM_LENGTH</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* separate sscanfs because length is working only for %s */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="s">&quot;%2s%n &quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nrchars</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&quot;%2x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="n">pattern</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">cmd</span><span class="p">;</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="n">nrchars</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Each instruction is 16bit long. Check that length is even */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">engine</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LP5523_CMD_LOAD</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5523_load_program</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">pattern</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed loading pattern</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wrong pattern format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">store_engine_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lp5523_do_store_load</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define store_load(nr)							\</span>
<span class="cp">static ssize_t store_engine##nr##_load(struct device *dev,		\</span>
<span class="cp">				     struct device_attribute *attr,	\</span>
<span class="cp">				     const char *buf, size_t len)	\</span>
<span class="cp">{									\</span>
<span class="cp">	return store_engine_load(dev, attr, buf, len, nr);		\</span>
<span class="cp">}</span>
<span class="n">store_load</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">store_load</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">store_load</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">show_engine_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LP5523_CMD_RUN</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;run</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">LP5523_CMD_LOAD</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;load</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">LP5523_CMD_DISABLED</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define show_mode(nr)							\</span>
<span class="cp">static ssize_t show_engine##nr##_mode(struct device *dev,		\</span>
<span class="cp">				    struct device_attribute *attr,	\</span>
<span class="cp">				    char *buf)				\</span>
<span class="cp">{									\</span>
<span class="cp">	return show_engine_mode(dev, attr, buf, nr);			\</span>
<span class="cp">}</span>
<span class="n">show_mode</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">show_mode</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">show_mode</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">store_engine_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5523_engine</span> <span class="o">*</span><span class="n">engine</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;run&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">lp5523_set_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">LP5523_CMD_RUN</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;load&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">lp5523_set_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">LP5523_CMD_LOAD</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
		<span class="n">lp5523_set_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">LP5523_CMD_DISABLED</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define store_mode(nr)							\</span>
<span class="cp">static ssize_t store_engine##nr##_mode(struct device *dev,		\</span>
<span class="cp">				     struct device_attribute *attr,	\</span>
<span class="cp">				     const char *buf, size_t len)	\</span>
<span class="cp">{									\</span>
<span class="cp">	return store_engine_mode(dev, attr, buf, len, nr);		\</span>
<span class="cp">}</span>
<span class="n">store_mode</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">store_mode</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">store_mode</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">show_max_current</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5523_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">cdev_to_led</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">max_current</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">show_current</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5523_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">cdev_to_led</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">led_current</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">store_current</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5523_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">cdev_to_led</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">led_to_lp5523</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">curr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">curr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curr</span> <span class="o">&gt;</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">max_current</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5523_write</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
			<span class="n">LP5523_REG_LED_CURRENT_BASE</span> <span class="o">+</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">chan_nr</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">curr</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">led_current</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">curr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* led class device attributes */</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">led_current</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_current</span><span class="p">,</span> <span class="n">store_current</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">max_current</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="p">,</span> <span class="n">show_max_current</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">lp5523_led_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_led_current</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_max_current</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">lp5523_led_attribute_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">lp5523_led_attributes</span>
<span class="p">};</span>

<span class="cm">/* device attributes */</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">engine1_mode</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_engine1_mode</span><span class="p">,</span> <span class="n">store_engine1_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">engine2_mode</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_engine2_mode</span><span class="p">,</span> <span class="n">store_engine2_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">engine3_mode</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_engine3_mode</span><span class="p">,</span> <span class="n">store_engine3_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">engine1_leds</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_engine1_leds</span><span class="p">,</span> <span class="n">store_engine1_leds</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">engine2_leds</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_engine2_leds</span><span class="p">,</span> <span class="n">store_engine2_leds</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">engine3_leds</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_engine3_leds</span><span class="p">,</span> <span class="n">store_engine3_leds</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">engine1_load</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">store_engine1_load</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">engine2_load</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">store_engine2_load</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">engine3_load</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">store_engine3_load</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">selftest</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">lp5523_selftest</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">lp5523_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_engine1_mode</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_engine2_mode</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_engine3_mode</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_selftest</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_engine1_load</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_engine1_leds</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_engine2_load</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_engine2_leds</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_engine3_load</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_engine3_leds</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">lp5523_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">lp5523_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5523_register_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp5523_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lp5523_unregister_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp5523_group</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_leds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">lp5523_led_attribute_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*--------------------------------------------------------------*/</span>
<span class="cm">/*			Set chip operating mode			*/</span>
<span class="cm">/*--------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5523_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5523_engine</span> <span class="o">*</span><span class="n">engine</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* if in that mode already do nothing, except for run */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">LP5523_CMD_RUN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LP5523_CMD_RUN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5523_run_program</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LP5523_CMD_LOAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp5523_set_engine_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">LP5523_CMD_DISABLED</span><span class="p">);</span>
		<span class="n">lp5523_set_engine_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">LP5523_CMD_LOAD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LP5523_CMD_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp5523_set_engine_mode</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">LP5523_CMD_DISABLED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">engine</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*--------------------------------------------------------------*/</span>
<span class="cm">/*			Probe, Attach, Remove			*/</span>
<span class="cm">/*--------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">lp5523_init_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5523_engine</span> <span class="o">*</span><span class="n">engine</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">id</span> <span class="o">&gt;</span> <span class="n">LP5523_ENGINES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">engine</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">engine</span><span class="o">-&gt;</span><span class="n">engine_mask</span> <span class="o">=</span> <span class="n">LP5523_ENG_MASK_BASE</span> <span class="o">&gt;&gt;</span> <span class="n">SHIFT_MASK</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="n">engine</span><span class="o">-&gt;</span><span class="n">prog_page</span> <span class="o">=</span> <span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">engine</span><span class="o">-&gt;</span><span class="n">mux_page</span> <span class="o">=</span> <span class="n">id</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">lp5523_init_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">lp5523_led</span> <span class="o">*</span><span class="n">led</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lp5523_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="n">LP5523_LEDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">led_config</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">led_current</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">led_current</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">led_config</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">led_current</span><span class="p">;</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">max_current</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">led_config</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">max_current</span><span class="p">;</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">chan_nr</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">led_config</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">chan_nr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">chan_nr</span> <span class="o">&gt;=</span> <span class="n">LP5523_LEDS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Use channel numbers between 0 and %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">LP5523_LEDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s:channel%d&quot;</span><span class="p">,</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">label</span> <span class="o">?:</span> <span class="s">&quot;lp5523&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

		<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">.</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">lp5523_set_brightness</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t register led on channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">chan</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">lp5523_led_attribute_group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t register current attribute</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">led_current</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">lp5523_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5523_chip</span>		<span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lp5523_platform_data</span>	<span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">led</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span>   <span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup_resources</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup_resources</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span> <span class="cm">/* Keep enable down at least 1ms */</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span> <span class="cm">/* 500us abs min. */</span>
	<span class="p">}</span>

	<span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LP5523_REG_RESET</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">);</span> <span class="cm">/*</span>
<span class="cm">				     * Exact value is not available. 10 - 20ms</span>
<span class="cm">				     * appears to be enough for reset.</span>
<span class="cm">				     */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5523_detect</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;LP5523 Programmable led chip found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Initialize engines */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5523_init_engine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error initializing engine</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5523_configure</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error configuring chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize leds */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_leds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">led</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Do not initialize channels that are not connected */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">led_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">led_current</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5523_init_led</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">led</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pdata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error initializing leds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_leds</span><span class="o">++</span><span class="p">;</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">led</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">led</span><span class="p">;</span>
		<span class="cm">/* Set LED current */</span>
		<span class="n">lp5523_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
			  <span class="n">LP5523_REG_LED_CURRENT_BASE</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">led</span><span class="p">].</span><span class="n">chan_nr</span><span class="p">,</span>
			  <span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">led</span><span class="p">].</span><span class="n">led_current</span><span class="p">);</span>

		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">led</span><span class="p">].</span><span class="n">brightness_work</span><span class="p">),</span>
			<span class="n">lp5523_led_brightness_work</span><span class="p">);</span>

		<span class="n">led</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lp5523_register_sysfs</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;registering sysfs failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">fail3:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_leds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">);</span>
		<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">brightness_work</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">fail2:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">release_resources</span><span class="p">)</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">release_resources</span><span class="p">();</span>
<span class="nl">fail1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lp5523_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lp5523_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">lp5523_unregister_sysfs</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_leds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdev</span><span class="p">);</span>
		<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">brightness_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">release_resources</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">release_resources</span><span class="p">();</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">lp5523_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;lp5523&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">lp5523_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">lp5523_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;lp5523&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">lp5523_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">lp5523_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">lp5523_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">lp5523_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mathias Nyman &lt;mathias.nyman@nokia.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;LP5523 LED engine&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
