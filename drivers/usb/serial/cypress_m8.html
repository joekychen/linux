<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › serial › cypress_m8.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cypress_m8.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * USB Cypress M8 driver</span>
<span class="cm"> *</span>
<span class="cm"> * 	Copyright (C) 2004</span>
<span class="cm"> * 	    Lonnie Mendez (dignome@gmail.com)</span>
<span class="cm"> *	Copyright (C) 2003,2004</span>
<span class="cm"> *	    Neil Whelchel (koyama@firstlight.net)</span>
<span class="cm"> *</span>
<span class="cm"> * 	This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * 	it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * 	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * 	(at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * See Documentation/usb/usb-serial.txt for more information on using this</span>
<span class="cm"> * driver</span>
<span class="cm"> *</span>
<span class="cm"> * See http://geocities.com/i0xox0i for information on this driver and the</span>
<span class="cm"> * earthmate usb device.</span>
<span class="cm"> */</span>

<span class="cm">/* Thanks to Neil Whelchel for writing the first cypress m8 implementation</span>
<span class="cm">   for linux. */</span>
<span class="cm">/* Thanks to cypress for providing references for the hid reports. */</span>
<span class="cm">/* Thanks to Jiang Zhang for providing links and for general help. */</span>
<span class="cm">/* Code originates and was built up from ftdi_sio, belkin, pl2303 and others.*/</span>


<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_driver.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/serial.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/kfifo.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &quot;cypress_m8.h&quot;</span>


<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">stats</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">interval</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">unstable_bauds</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Version Information</span>
<span class="cm"> */</span>
<span class="cp">#define DRIVER_VERSION &quot;v1.10&quot;</span>
<span class="cp">#define DRIVER_AUTHOR &quot;Lonnie Mendez &lt;dignome@gmail.com&gt;, Neil Whelchel &lt;koyama@firstlight.net&gt;&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;Cypress USB to Serial Driver&quot;</span>

<span class="cm">/* write buffer size defines */</span>
<span class="cp">#define CYPRESS_BUF_SIZE	1024</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">id_table_earthmate</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_ID_DELORME</span><span class="p">,</span> <span class="n">PRODUCT_ID_EARTHMATEUSB</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_ID_DELORME</span><span class="p">,</span> <span class="n">PRODUCT_ID_EARTHMATEUSB_LT20</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>						<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">id_table_cyphidcomrs232</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_ID_CYPRESS</span><span class="p">,</span> <span class="n">PRODUCT_ID_CYPHIDCOM</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_ID_POWERCOM</span><span class="p">,</span> <span class="n">PRODUCT_ID_UPS</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>						<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">id_table_nokiaca42v2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_ID_DAZZLE</span><span class="p">,</span> <span class="n">PRODUCT_ID_CA42</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>						<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">id_table_combined</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_ID_DELORME</span><span class="p">,</span> <span class="n">PRODUCT_ID_EARTHMATEUSB</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_ID_DELORME</span><span class="p">,</span> <span class="n">PRODUCT_ID_EARTHMATEUSB_LT20</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_ID_CYPRESS</span><span class="p">,</span> <span class="n">PRODUCT_ID_CYPHIDCOM</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_ID_POWERCOM</span><span class="p">,</span> <span class="n">PRODUCT_ID_UPS</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">VENDOR_ID_DAZZLE</span><span class="p">,</span> <span class="n">PRODUCT_ID_CA42</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>						<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">id_table_combined</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">packet_format</span> <span class="p">{</span>
	<span class="n">packet_format_1</span><span class="p">,</span>  <span class="cm">/* b0:status, b1:payload count */</span>
	<span class="n">packet_format_2</span>   <span class="cm">/* b0[7:3]:status, b0[2:0]:payload count */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cypress_private</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>		   <span class="cm">/* private lock */</span>
	<span class="kt">int</span> <span class="n">chiptype</span><span class="p">;</span>			   <span class="cm">/* identifier of device, for quirks/etc */</span>
	<span class="kt">int</span> <span class="n">bytes_in</span><span class="p">;</span>			   <span class="cm">/* used for statistics */</span>
	<span class="kt">int</span> <span class="n">bytes_out</span><span class="p">;</span>			   <span class="cm">/* used for statistics */</span>
	<span class="kt">int</span> <span class="n">cmd_count</span><span class="p">;</span>			   <span class="cm">/* used for statistics */</span>
	<span class="kt">int</span> <span class="n">cmd_ctrl</span><span class="p">;</span>			   <span class="cm">/* always set this to 1 before issuing a command */</span>
	<span class="k">struct</span> <span class="n">kfifo</span> <span class="n">write_fifo</span><span class="p">;</span>	   <span class="cm">/* write fifo */</span>
	<span class="kt">int</span> <span class="n">write_urb_in_use</span><span class="p">;</span>		   <span class="cm">/* write urb in use indicator */</span>
	<span class="kt">int</span> <span class="n">write_urb_interval</span><span class="p">;</span>            <span class="cm">/* interval to use for write urb */</span>
	<span class="kt">int</span> <span class="n">read_urb_interval</span><span class="p">;</span>             <span class="cm">/* interval to use for read urb */</span>
	<span class="kt">int</span> <span class="n">comm_is_ok</span><span class="p">;</span>                    <span class="cm">/* true if communication is (still) ok */</span>
	<span class="kt">int</span> <span class="n">termios_initialized</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">line_control</span><span class="p">;</span>	   	   <span class="cm">/* holds dtr / rts value */</span>
	<span class="n">__u8</span> <span class="n">current_status</span><span class="p">;</span>	   	   <span class="cm">/* received from last read - info on dsr,cts,cd,ri,etc */</span>
	<span class="n">__u8</span> <span class="n">current_config</span><span class="p">;</span>	   	   <span class="cm">/* stores the current configuration byte */</span>
	<span class="n">__u8</span> <span class="n">rx_flags</span><span class="p">;</span>			   <span class="cm">/* throttling - used from whiteheat/ftdi_sio */</span>
	<span class="k">enum</span> <span class="n">packet_format</span> <span class="n">pkt_fmt</span><span class="p">;</span>	   <span class="cm">/* format to use for packet send / receive */</span>
	<span class="kt">int</span> <span class="n">get_cfg_unsafe</span><span class="p">;</span>		   <span class="cm">/* If true, the CYPRESS_GET_CONFIG is unsafe */</span>
	<span class="kt">int</span> <span class="n">baud_rate</span><span class="p">;</span>			   <span class="cm">/* stores current baud rate in</span>
<span class="cm">					      integer form */</span>
	<span class="kt">int</span> <span class="n">isthrottled</span><span class="p">;</span>		   <span class="cm">/* if throttled, discard reads */</span>
	<span class="n">wait_queue_head_t</span> <span class="n">delta_msr_wait</span><span class="p">;</span>  <span class="cm">/* used for TIOCMIWAIT */</span>
	<span class="kt">char</span> <span class="n">prev_status</span><span class="p">,</span> <span class="n">diff_status</span><span class="p">;</span>	   <span class="cm">/* used for TIOCMIWAIT */</span>
	<span class="cm">/* we pass a pointer to this as the argument sent to</span>
<span class="cm">	   cypress_set_termios old_termios */</span>
	<span class="k">struct</span> <span class="n">ktermios</span> <span class="n">tmp_termios</span><span class="p">;</span> 	   <span class="cm">/* stores the old termios settings */</span>
<span class="p">};</span>

<span class="cm">/* function prototypes for the Cypress USB to serial device */</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">cypress_earthmate_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">cypress_hidcom_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">cypress_ca42v2_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cypress_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">cypress_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cypress_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cypress_dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">cypress_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cypress_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">cypress_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">cypress_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cypress_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">cypress_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">cypress_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">cypress_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cypress_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cypress_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cypress_set_dead</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cypress_read_int_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cypress_write_int_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="n">cypress_earthmate_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>		<span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>			<span class="s">&quot;earthmate&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span>			<span class="s">&quot;DeLorme Earthmate USB&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>			<span class="n">id_table_earthmate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_ports</span> <span class="o">=</span>			<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span> <span class="o">=</span>			<span class="n">cypress_earthmate_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>			<span class="n">cypress_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>				<span class="n">cypress_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>			<span class="n">cypress_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dtr_rts</span> <span class="o">=</span>			<span class="n">cypress_dtr_rts</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>			<span class="n">cypress_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span>			<span class="n">cypress_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>			<span class="n">cypress_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span>			<span class="n">cypress_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span>			<span class="n">cypress_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span>			<span class="n">cypress_tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span>		<span class="n">cypress_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span>		 	<span class="n">cypress_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span>			<span class="n">cypress_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_int_callback</span> <span class="o">=</span>		<span class="n">cypress_read_int_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_int_callback</span> <span class="o">=</span>		<span class="n">cypress_write_int_callback</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="n">cypress_hidcom_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>		<span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>			<span class="s">&quot;cyphidcom&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span>			<span class="s">&quot;HID-&gt;COM RS232 Adapter&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>			<span class="n">id_table_cyphidcomrs232</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_ports</span> <span class="o">=</span>			<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span> <span class="o">=</span>			<span class="n">cypress_hidcom_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>			<span class="n">cypress_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>				<span class="n">cypress_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>			<span class="n">cypress_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dtr_rts</span> <span class="o">=</span>			<span class="n">cypress_dtr_rts</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>			<span class="n">cypress_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span>			<span class="n">cypress_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>			<span class="n">cypress_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span>			<span class="n">cypress_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span>			<span class="n">cypress_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span>			<span class="n">cypress_tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span>		<span class="n">cypress_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span>			<span class="n">cypress_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span>			<span class="n">cypress_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_int_callback</span> <span class="o">=</span>		<span class="n">cypress_read_int_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_int_callback</span> <span class="o">=</span>		<span class="n">cypress_write_int_callback</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="n">cypress_ca42v2_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>		<span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>			<span class="s">&quot;nokiaca42v2&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span>			<span class="s">&quot;Nokia CA-42 V2 Adapter&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>			<span class="n">id_table_nokiaca42v2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_ports</span> <span class="o">=</span>			<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span> <span class="o">=</span>			<span class="n">cypress_ca42v2_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>			<span class="n">cypress_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>				<span class="n">cypress_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>			<span class="n">cypress_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dtr_rts</span> <span class="o">=</span>			<span class="n">cypress_dtr_rts</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>			<span class="n">cypress_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span>			<span class="n">cypress_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>			<span class="n">cypress_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span>			<span class="n">cypress_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span>			<span class="n">cypress_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span>			<span class="n">cypress_tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span>		<span class="n">cypress_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span>			<span class="n">cypress_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span>			<span class="n">cypress_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_int_callback</span> <span class="o">=</span>		<span class="n">cypress_read_int_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_int_callback</span> <span class="o">=</span>		<span class="n">cypress_write_int_callback</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="o">*</span> <span class="k">const</span> <span class="n">serial_drivers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">cypress_earthmate_device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cypress_hidcom_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">cypress_ca42v2_device</span><span class="p">,</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Cypress serial helper functions</span>
<span class="cm"> *****************************************************************************/</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">analyze_baud_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">speed_t</span> <span class="n">new_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unstable_bauds</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">new_rate</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The general purpose firmware for the Cypress M8 allows for</span>
<span class="cm">	 * a maximum speed of 57600bps (I have no idea whether DeLorme</span>
<span class="cm">	 * chose to use the general purpose firmware or not), if you</span>
<span class="cm">	 * need to modify this speed setting for your own project</span>
<span class="cm">	 * please add your own chiptype and modify the code likewise.</span>
<span class="cm">	 * The Cypress HID-&gt;COM device will work successfully up to</span>
<span class="cm">	 * 115200bps (but the actual throughput is around 3kBps).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_LOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Mike Isely &lt;isely@pobox.com&gt; 2-Feb-2008: The</span>
<span class="cm">		 * Cypress app note that describes this mechanism</span>
<span class="cm">		 * states the the low-speed part can&#39;t handle more</span>
<span class="cm">		 * than 800 bytes/sec, in which case 4800 baud is the</span>
<span class="cm">		 * safest speed for a part like that.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_rate</span> <span class="o">&gt;</span> <span class="mi">4800</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - failed setting baud rate, device incapable &quot;</span>
			    <span class="s">&quot;speed %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">new_rate</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chiptype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CT_EARTHMATE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">new_rate</span> <span class="o">&lt;=</span> <span class="mi">600</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* 300 and 600 baud rates are supported under</span>
<span class="cm">			 * the generic firmware, but are not used with</span>
<span class="cm">			 * NMEA and SiRF protocols */</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - failed setting baud rate, unsupported speed &quot;</span>
			    <span class="s">&quot;of %d on Earthmate GPS&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">new_rate</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">new_rate</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* This function can either set or retrieve the current serial line settings */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cypress_serial_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">speed_t</span> <span class="n">baud_rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_bits</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">stop_bits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">parity_enable</span><span class="p">,</span> <span class="kt">int</span> <span class="n">parity_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">cypress_request_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_baudrate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">feature_buffer</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">feature_len</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">comm_is_ok</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">feature_buffer</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">feature_len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">feature_buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cypress_request_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CYPRESS_SET_CONFIG</span>:
		<span class="cm">/* 0 means &#39;Hang up&#39; so doesn&#39;t change the true bit rate */</span>
		<span class="n">new_baudrate</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">baud_rate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">baud_rate</span> <span class="o">&amp;&amp;</span> <span class="n">baud_rate</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">baud_rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - baud rate is changing&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">analyze_baud_rate</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">baud_rate</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">new_baudrate</span> <span class="o">=</span> <span class="n">retval</span><span class="p">;</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - New baud rate set to %d&quot;</span><span class="p">,</span>
				    <span class="n">__func__</span><span class="p">,</span> <span class="n">new_baudrate</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - baud rate is being sent as %d&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">new_baudrate</span><span class="p">);</span>

		<span class="cm">/* fill the feature_buffer with new configuration */</span>
		<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">new_baudrate</span><span class="p">,</span> <span class="n">feature_buffer</span><span class="p">);</span>
		<span class="n">feature_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="n">data_bits</span><span class="p">;</span>   <span class="cm">/* assign data bits in 2 bit space ( max 3 ) */</span>
		<span class="cm">/* 1 bit gap */</span>
		<span class="n">feature_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">stop_bits</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>   <span class="cm">/* assign stop bits in 1 bit space */</span>
		<span class="n">feature_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">parity_enable</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>   <span class="cm">/* assign parity flag in 1 bit space */</span>
		<span class="n">feature_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">parity_type</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>   <span class="cm">/* assign parity type in 1 bit space */</span>
		<span class="cm">/* 1 bit gap */</span>
		<span class="n">feature_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">reset</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>   <span class="cm">/* assign reset at end of byte, 1 bit space */</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - device is being sent this feature report:&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - %02X - %02X - %02X - %02X - %02X&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">feature_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">feature_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">feature_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">feature_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			<span class="n">feature_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					<span class="n">HID_REQ_SET_REPORT</span><span class="p">,</span>
					<span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span><span class="p">,</span>
					<span class="mh">0x0300</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">feature_buffer</span><span class="p">,</span>
					<span class="n">feature_len</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tries</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">feature_len</span> <span class="o">&amp;&amp;</span>
			 <span class="n">retval</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">feature_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - failed sending serial &quot;</span>
				<span class="s">&quot;line settings - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
			<span class="n">cypress_set_dead</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">baud_rate</span> <span class="o">=</span> <span class="n">new_baudrate</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_config</span> <span class="o">=</span> <span class="n">feature_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="cm">/* If we asked for a speed change encode it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">baud_rate</span><span class="p">)</span>
				<span class="n">tty_encode_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span>
					<span class="n">new_baudrate</span><span class="p">,</span> <span class="n">new_baudrate</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CYPRESS_GET_CONFIG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">get_cfg_unsafe</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Not implemented for this device,</span>
<span class="cm">			   and if we try to do it we&#39;re likely</span>
<span class="cm">			   to crash the hardware. */</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - retreiving serial line settings&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					<span class="n">HID_REQ_GET_REPORT</span><span class="p">,</span>
					<span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span><span class="p">,</span>
					<span class="mh">0x0300</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">feature_buffer</span><span class="p">,</span>
					<span class="n">feature_len</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tries</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">feature_len</span>
						<span class="o">&amp;&amp;</span> <span class="n">retval</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">feature_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - failed to retrieve serial &quot;</span>
				<span class="s">&quot;line settings - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
			<span class="n">cypress_set_dead</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="cm">/* store the config in one byte, and later</span>
<span class="cm">			   use bit masks to check values */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_config</span> <span class="o">=</span> <span class="n">feature_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">baud_rate</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">feature_buffer</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="o">++</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_count</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">feature_buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* cypress_serial_control */</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cypress_set_dead</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">comm_is_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">comm_is_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cypress_m8 suspending failing port %d - &quot;</span>
		<span class="s">&quot;interval might be too short</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Cypress serial driver functions</span>
<span class="cm"> *****************************************************************************/</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">generic_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cypress_private</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">comm_is_ok</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">,</span> <span class="n">CYPRESS_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">delta_msr_wait</span><span class="p">);</span>

	<span class="n">usb_reset_configuration</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">line_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">termios_initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Default packet format setting is determined by packet size.</span>
<span class="cm">	   Anything with a size larger then 9 must have a separate</span>
<span class="cm">	   count field since the 3 bit count field is otherwise too</span>
<span class="cm">	   small.  Otherwise we can use the slightly more compact</span>
<span class="cm">	   format.  This is in accordance with the cypress_m8 serial</span>
<span class="cm">	   converter app note. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_size</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkt_fmt</span> <span class="o">=</span> <span class="n">packet_format_1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkt_fmt</span> <span class="o">=</span> <span class="n">packet_format_2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">write_urb_interval</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">read_urb_interval</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d read &amp; write intervals forced to %d&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">interval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">write_urb_interval</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_urb</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">read_urb_interval</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d intervals: read=%d write=%d&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">read_urb_interval</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">write_urb_interval</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">usb_set_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cypress_earthmate_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">generic_startup</span><span class="p">(</span><span class="n">serial</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Failed setting up port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chiptype</span> <span class="o">=</span> <span class="n">CT_EARTHMATE</span><span class="p">;</span>
	<span class="cm">/* All Earthmate devices use the separated-count packet</span>
<span class="cm">	   format!  Idiotic. */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkt_fmt</span> <span class="o">=</span> <span class="n">packet_format_1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span> <span class="o">!=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">PRODUCT_ID_EARTHMATEUSB</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* The old original USB Earthmate seemed able to</span>
<span class="cm">		   handle GET_CONFIG requests; everything they&#39;ve</span>
<span class="cm">		   produced since that time crashes if this command is</span>
<span class="cm">		   attempted :-( */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Marking this device as unsafe for GET_CONFIG &quot;</span>
		    <span class="s">&quot;commands&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">get_cfg_unsafe</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* cypress_earthmate_startup */</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cypress_hidcom_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">generic_startup</span><span class="p">(</span><span class="n">serial</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Failed setting up port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chiptype</span> <span class="o">=</span> <span class="n">CT_CYPHIDCOM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* cypress_hidcom_startup */</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cypress_ca42v2_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">generic_startup</span><span class="p">(</span><span class="n">serial</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Failed setting up port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chiptype</span> <span class="o">=</span> <span class="n">CT_CA42V2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* cypress_ca42v2_startup */</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cypress_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* all open ports are closed at this point */</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfifo_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cypress_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">comm_is_ok</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* clear halts before open */</span>
	<span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>
	<span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* reset read/write statistics */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bytes_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bytes_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Set termios */</span>
	<span class="n">cypress_send</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">cypress_set_termios</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tmp_termios</span><span class="p">);</span>

	<span class="cm">/* setup the port and start reading from the device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - interrupt_in_urb is empty!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">,</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_endpointAddress</span><span class="p">),</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span>
		<span class="n">cypress_read_int_callback</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">read_urb_interval</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - failed submitting read urb, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="n">cypress_set_dead</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">drain_delay</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* cypress_open */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cypress_dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="cm">/* drop dtr and rts */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">line_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> 
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">line_control</span> <span class="o">=</span> <span class="n">CONTROL_DTR</span> <span class="o">|</span> <span class="n">CONTROL_RTS</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cypress_write</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cypress_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* writing is potentially harmful, lock must be taken */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disconnected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">kfifo_reset_out</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - stopping urbs&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_urb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Statistics: %d Bytes In | %d Bytes Out | %d Commands Issued</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bytes_in</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bytes_out</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_count</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* cypress_close */</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cypress_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d, %d bytes&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="cm">/* line control commands, which need to be executed immediately,</span>
<span class="cm">	   are not put into the buffer for obvious reasons.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">kfifo_in_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="nl">finish:</span>
	<span class="n">cypress_send</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* cypress_write */</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cypress_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">actual_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">comm_is_ok</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - interrupt out size is %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
						<span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_size</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">write_urb_in_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - can&#39;t write, urb in use&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* clear buffer */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_size</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkt_fmt</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">packet_format_1</span>:
		<span class="cm">/* this is for the CY7C64013... */</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">line_control</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">packet_format_2</span>:
		<span class="cm">/* this is for the CY7C63743... */</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">line_control</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">line_control</span> <span class="o">&amp;</span> <span class="n">CONTROL_RESET</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">line_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CONTROL_RESET</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - line control command being issued&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">send</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">kfifo_out_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkt_fmt</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">packet_format_1</span>:
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">packet_format_2</span>:
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - count is %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

<span class="nl">send:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">write_urb_in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">)</span>
		<span class="n">actual_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">actual_size</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span>
			      <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkt_fmt</span> <span class="o">==</span> <span class="n">packet_format_1</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_size</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>

	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_urb</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">usb_sndintpipe</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_endpointAddress</span><span class="p">),</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_buffer</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_size</span><span class="p">,</span>
		<span class="n">cypress_write_int_callback</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">write_urb_interval</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err_console</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
				<span class="s">&quot;%s - failed submitting write urb, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">write_urb_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cypress_set_dead</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* do not count the line control and size bytes */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bytes_out</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">usb_serial_port_softint</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* cypress_send */</span>


<span class="cm">/* returns how much space is available in the soft buffer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cypress_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">room</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">room</span> <span class="o">=</span> <span class="n">kfifo_avail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - returns %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">room</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">room</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cypress_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">__u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">line_control</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_status</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">CONTROL_DTR</span><span class="p">)</span>        <span class="o">?</span> <span class="n">TIOCM_DTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">CONTROL_RTS</span><span class="p">)</span>       <span class="o">?</span> <span class="n">TIOCM_RTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_CTS</span><span class="p">)</span>        <span class="o">?</span> <span class="n">TIOCM_CTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_DSR</span><span class="p">)</span>        <span class="o">?</span> <span class="n">TIOCM_DSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_RI</span><span class="p">)</span>         <span class="o">?</span> <span class="n">TIOCM_RI</span>  <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_CD</span><span class="p">)</span>         <span class="o">?</span> <span class="n">TIOCM_CD</span>  <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - result = %x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cypress_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">line_control</span> <span class="o">|=</span> <span class="n">CONTROL_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">line_control</span> <span class="o">|=</span> <span class="n">CONTROL_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">line_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CONTROL_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">line_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CONTROL_DTR</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cypress_write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cypress_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d, cmd 0x%.4x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* This code comes from drivers/char/serial.c and ftdi_sio.c */</span>
	<span class="k">case</span> <span class="n">TIOCMIWAIT</span>:
		<span class="k">while</span> <span class="p">(</span><span class="n">priv</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">delta_msr_wait</span><span class="p">);</span>
			<span class="cm">/* see if a signal did it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">diff_status</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span> <span class="cm">/* no change =&gt; error */</span>

				<span class="cm">/* consume all events */</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">diff_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/* return 0 if caller wanted to know about</span>
<span class="cm">				   these bits */</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_RNG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&amp;</span> <span class="n">UART_RI</span><span class="p">))</span> <span class="o">||</span>
				    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_DSR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&amp;</span> <span class="n">UART_DSR</span><span class="p">))</span> <span class="o">||</span>
				    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&amp;</span> <span class="n">UART_CD</span><span class="p">))</span> <span class="o">||</span>
				    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&amp;</span> <span class="n">UART_CTS</span><span class="p">)))</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* otherwise caller can&#39;t care less about what</span>
<span class="cm">				 * happened, and so we continue to wait for</span>
<span class="cm">				 * more events.</span>
<span class="cm">				 */</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - arg not supported - it was 0x%04x - check include/asm/ioctls.h&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* cypress_ioctl */</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cypress_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">data_bits</span><span class="p">,</span> <span class="n">stop_bits</span><span class="p">,</span> <span class="n">parity_type</span><span class="p">,</span> <span class="n">parity_enable</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">,</span> <span class="n">iflag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">oldlines</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">linechange</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* We can&#39;t clean this one up as we don&#39;t know the device type</span>
<span class="cm">	   early enough */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">termios_initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chiptype</span> <span class="o">==</span> <span class="n">CT_EARTHMATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">)</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">=</span> <span class="n">B4800</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">HUPCL</span> <span class="o">|</span>
				<span class="n">CLOCAL</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="mi">4800</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="mi">4800</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chiptype</span> <span class="o">==</span> <span class="n">CT_CYPHIDCOM</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">)</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">=</span> <span class="n">B9600</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">HUPCL</span> <span class="o">|</span>
				<span class="n">CLOCAL</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chiptype</span> <span class="o">==</span> <span class="n">CT_CA42V2</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">)</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">=</span> <span class="n">B9600</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">HUPCL</span> <span class="o">|</span>
				<span class="n">CLOCAL</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">termios_initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Unsupported features need clearing */</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CMSPAR</span><span class="o">|</span><span class="n">CRTSCTS</span><span class="p">);</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
	<span class="n">iflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">;</span>

	<span class="cm">/* check if there are new settings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_termios</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tmp_termios</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set number of data bits, parity, stop bits */</span>
	<span class="cm">/* when parity is disabled the parity type bit is ignored */</span>

	<span class="cm">/* 1 means 2 stop bits, 0 means 1 stop bit */</span>
	<span class="n">stop_bits</span> <span class="o">=</span> <span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parity_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* 1 means odd parity, 0 means even parity */</span>
		<span class="n">parity_type</span> <span class="o">=</span> <span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">parity_enable</span> <span class="o">=</span> <span class="n">parity_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS5</span>:
		<span class="n">data_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS6</span>:
		<span class="n">data_bits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>:
		<span class="n">data_bits</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS8</span>:
		<span class="n">data_bits</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - CSIZE was set, but not CS5-CS8</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">data_bits</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">oldlines</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">line_control</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">==</span> <span class="n">B0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* drop dtr and rts */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - dropping the lines, baud rate 0bps&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">line_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CONTROL_DTR</span> <span class="o">|</span> <span class="n">CONTROL_RTS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">line_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">CONTROL_DTR</span> <span class="o">|</span> <span class="n">CONTROL_RTS</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - sending %d stop_bits, %d parity_enable, %d parity_type, &quot;</span>
			<span class="s">&quot;%d data_bits (+5)&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">stop_bits</span><span class="p">,</span>
			<span class="n">parity_enable</span><span class="p">,</span> <span class="n">parity_type</span><span class="p">,</span> <span class="n">data_bits</span><span class="p">);</span>

	<span class="n">cypress_serial_control</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span>
			<span class="n">data_bits</span><span class="p">,</span> <span class="n">stop_bits</span><span class="p">,</span>
			<span class="n">parity_enable</span><span class="p">,</span> <span class="n">parity_type</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">CYPRESS_SET_CONFIG</span><span class="p">);</span>

	<span class="cm">/* we perform a CYPRESS_GET_CONFIG so that the current settings are</span>
<span class="cm">	 * filled into the private structure this should confirm that all is</span>
<span class="cm">	 * working if it returns what we just set */</span>
	<span class="n">cypress_serial_control</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CYPRESS_GET_CONFIG</span><span class="p">);</span>

	<span class="cm">/* Here we can define custom tty settings for devices; the main tty</span>
<span class="cm">	 * termios flag base comes from empeg.c */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chiptype</span> <span class="o">==</span> <span class="n">CT_EARTHMATE</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">baud_rate</span> <span class="o">==</span> <span class="mi">4800</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Using custom termios settings for a baud rate of &quot;</span>
				<span class="s">&quot;4800bps.&quot;</span><span class="p">);</span>
		<span class="cm">/* define custom termios settings for NMEA protocol */</span>

		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="cm">/* input modes - */</span>
			<span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IGNBRK</span>  <span class="cm">/* disable ignore break */</span>
			<span class="o">|</span> <span class="n">BRKINT</span>     <span class="cm">/* disable break causes interrupt */</span>
			<span class="o">|</span> <span class="n">PARMRK</span>     <span class="cm">/* disable mark parity errors */</span>
			<span class="o">|</span> <span class="n">ISTRIP</span>     <span class="cm">/* disable clear high bit of input char */</span>
			<span class="o">|</span> <span class="n">INLCR</span>      <span class="cm">/* disable translate NL to CR */</span>
			<span class="o">|</span> <span class="n">IGNCR</span>      <span class="cm">/* disable ignore CR */</span>
			<span class="o">|</span> <span class="n">ICRNL</span>      <span class="cm">/* disable translate CR to NL */</span>
			<span class="o">|</span> <span class="n">IXON</span><span class="p">);</span>     <span class="cm">/* disable enable XON/XOFF flow control */</span>

		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_oflag</span> <span class="cm">/* output modes */</span>
			<span class="o">&amp;=</span> <span class="o">~</span><span class="n">OPOST</span><span class="p">;</span>    <span class="cm">/* disable postprocess output char */</span>

		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_lflag</span> <span class="cm">/* line discipline modes */</span>
			<span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ECHO</span>     <span class="cm">/* disable echo input characters */</span>
			<span class="o">|</span> <span class="n">ECHONL</span>      <span class="cm">/* disable echo new line */</span>
			<span class="o">|</span> <span class="n">ICANON</span>      <span class="cm">/* disable erase, kill, werase, and rprnt</span>
<span class="cm">					 special characters */</span>
			<span class="o">|</span> <span class="n">ISIG</span>        <span class="cm">/* disable interrupt, quit, and suspend</span>
<span class="cm">					 special characters */</span>
			<span class="o">|</span> <span class="n">IEXTEN</span><span class="p">);</span>    <span class="cm">/* disable non-POSIX special characters */</span>
	<span class="p">}</span> <span class="cm">/* CT_CYPHIDCOM: Application should handle this for device */</span>

	<span class="n">linechange</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">line_control</span> <span class="o">!=</span> <span class="n">oldlines</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* if necessary, set lines */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">linechange</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cypress_write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span> <span class="cm">/* cypress_set_termios */</span>


<span class="cm">/* returns amount of data still left in soft buffer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cypress_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">chars</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">chars</span> <span class="o">=</span> <span class="n">kfifo_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - returns %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">chars</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">chars</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cypress_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">=</span> <span class="n">THROTTLED</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cypress_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">actually_throttled</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">actually_throttled</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">ACTUALLY_THROTTLED</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">comm_is_ok</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">actually_throttled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - failed submitting read urb, &quot;</span>
					<span class="s">&quot;error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="n">cypress_set_dead</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cypress_read_int_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tty_flag</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">havedata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* success */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* precursor to disconnect so just go away */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EPIPE</span>:
		<span class="cm">/* Can&#39;t call usb_clear_halt while in_interrupt */</span>
		<span class="cm">/* FALLS THROUGH */</span>
	<span class="nl">default:</span>
		<span class="cm">/* something ugly is going on... */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - unexpected nonzero read status received: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">cypress_set_dead</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">THROTTLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - now throttling&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">|=</span> <span class="n">ACTUALLY_THROTTLED</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - bad tty pointer - exiting&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkt_fmt</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">packet_format_1</span>:
		<span class="cm">/* This is for the CY7C64013... */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_status</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF8</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">havedata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">packet_format_2</span>:
		<span class="cm">/* This is for the CY7C63743... */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_status</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF8</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">havedata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - wrong packet size - received %d bytes but packet &quot;</span>
		    <span class="s">&quot;said %d bytes&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">continue_read</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
						<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* check to see if status has changed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_status</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">prev_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">diff_status</span> <span class="o">|=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_status</span> <span class="o">^</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">prev_status</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">delta_msr_wait</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">prev_status</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* hangup, as defined in acm.c... this might be a bad place for it</span>
<span class="cm">	 * though */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_status</span> <span class="o">&amp;</span> <span class="n">UART_CD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - calling hangup&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">tty_hangup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">continue_read</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* There is one error bit... I&#39;m assuming it is a parity error</span>
<span class="cm">	 * indicator as the generic firmware will set this bit to 1 if a</span>
<span class="cm">	 * parity error occurs.</span>
<span class="cm">	 * I can not find reference to any other error events. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_status</span> <span class="o">&amp;</span> <span class="n">CYP_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">tty_flag</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Parity Error detected&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* process read if there is data other than line status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="n">bytes</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_insert_flip_string_fixed_flag</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">tty_flag</span><span class="p">,</span> <span class="n">bytes</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* control and status byte(s) are also counted */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bytes_in</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">continue_read:</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="cm">/* Continue trying to always read */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">comm_is_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_endpointAddress</span><span class="p">),</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span>
				<span class="n">cypress_read_int_callback</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">read_urb_interval</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - failed resubmitting &quot;</span>
					<span class="s">&quot;read urb, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">result</span><span class="p">);</span>
			<span class="n">cypress_set_dead</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span> <span class="cm">/* cypress_read_int_callback */</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cypress_write_int_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cypress_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* success */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* this urb is terminated, clean up */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - urb shutting down with status: %d&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">write_urb_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EPIPE</span>: <span class="cm">/* no break needed; clear halt and resubmit */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">comm_is_ok</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="cm">/* error in the urb, so we have to resubmit it */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - nonzero write bulk status received: %d&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_out_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - failed resubmitting write urb, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="n">cypress_set_dead</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%s - unexpected nonzero write status received: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">cypress_set_dead</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">write_urb_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* send any buffered data */</span>
	<span class="n">cypress_send</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_usb_serial_driver</span><span class="p">(</span><span class="n">serial_drivers</span><span class="p">,</span> <span class="n">id_table_combined</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRIVER_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug enabled or not&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="s">&quot;Enable statistics or not&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="s">&quot;Overrides interrupt interval&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">unstable_bauds</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">unstable_bauds</span><span class="p">,</span> <span class="s">&quot;Allow unstable baud rates&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
