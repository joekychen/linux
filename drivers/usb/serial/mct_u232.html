<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › serial › mct_u232.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mct_u232.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * MCT (Magic Control Technology Corp.) USB RS232 Converter Driver</span>
<span class="cm"> *</span>
<span class="cm"> *   Copyright (C) 2000 Wolfgang Grandegger (wolfgang@ces.ch)</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is largely derived from the Belkin USB Serial Adapter Driver</span>
<span class="cm"> * (see belkin_sa.[ch]). All of the information about the device was acquired</span>
<span class="cm"> * by using SniffUSB on Windows98. For technical details see mct_u232.h.</span>
<span class="cm"> *</span>
<span class="cm"> * William G. Greathouse and Greg Kroah-Hartman provided great help on how to</span>
<span class="cm"> * do the reverse engineering and how to write a USB serial device driver.</span>
<span class="cm"> *</span>
<span class="cm"> * TO BE DONE, TO BE CHECKED:</span>
<span class="cm"> *   DTR/RTS signal handling may be incomplete or incorrect. I have mainly</span>
<span class="cm"> *   implemented what I have seen with SniffUSB or found in belkin_sa.c.</span>
<span class="cm"> *   For further TODOs check also belkin_sa.c.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_driver.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/serial.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &quot;mct_u232.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Version Information</span>
<span class="cm"> */</span>
<span class="cp">#define DRIVER_VERSION &quot;z2.1&quot;		</span><span class="cm">/* Linux in-kernel version */</span><span class="cp"></span>
<span class="cp">#define DRIVER_AUTHOR &quot;Wolfgang Grandegger &lt;wolfgang@ces.ch&gt;&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;Magic Control Technology USB-RS232 converter driver&quot;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Function prototypes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">mct_u232_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mct_u232_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">mct_u232_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mct_u232_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mct_u232_dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mct_u232_read_int_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mct_u232_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mct_u232_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">mct_u232_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">mct_u232_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">mct_u232_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">mct_u232_get_icount</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">serial_icounter_struct</span> <span class="o">*</span><span class="n">icount</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mct_u232_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mct_u232_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * All of the device info needed for the MCT USB-RS232 converter.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MCT_U232_VID</span><span class="p">,</span> <span class="n">MCT_U232_PID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MCT_U232_VID</span><span class="p">,</span> <span class="n">MCT_U232_SITECOM_PID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MCT_U232_VID</span><span class="p">,</span> <span class="n">MCT_U232_DU_H3SP_PID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MCT_U232_BELKIN_F5U109_VID</span><span class="p">,</span> <span class="n">MCT_U232_BELKIN_F5U109_PID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>		<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="n">mct_u232_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;mct_u232&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span>	     <span class="s">&quot;MCT U232&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	     <span class="n">id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_ports</span> <span class="o">=</span>	     <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		     <span class="n">mct_u232_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	     <span class="n">mct_u232_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dtr_rts</span> <span class="o">=</span>	     <span class="n">mct_u232_dtr_rts</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span>	     <span class="n">mct_u232_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span>	     <span class="n">mct_u232_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_int_callback</span> <span class="o">=</span> <span class="n">mct_u232_read_int_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span>	     <span class="n">mct_u232_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span> <span class="o">=</span>	     <span class="n">mct_u232_break_ctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span>	     <span class="n">mct_u232_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span>	     <span class="n">mct_u232_tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span> <span class="o">=</span>	     <span class="n">mct_u232_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	     <span class="n">mct_u232_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>             <span class="n">mct_u232_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_icount</span> <span class="o">=</span>        <span class="n">mct_u232_get_icount</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="o">*</span> <span class="k">const</span> <span class="n">serial_drivers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">mct_u232_device</span><span class="p">,</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mct_u232_private</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	     <span class="n">control_state</span><span class="p">;</span> <span class="cm">/* Modem Line Setting (TIOCM) */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>        <span class="n">last_lcr</span><span class="p">;</span>      <span class="cm">/* Line Control Register */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	     <span class="n">last_lsr</span><span class="p">;</span>      <span class="cm">/* Line Status Register */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	     <span class="n">last_msr</span><span class="p">;</span>      <span class="cm">/* Modem Status Register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	     <span class="n">rx_flags</span><span class="p">;</span>      <span class="cm">/* Throttling flags */</span>
	<span class="k">struct</span> <span class="n">async_icount</span>  <span class="n">icount</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>    <span class="n">msr_wait</span><span class="p">;</span>	<span class="cm">/* for handling sleeping while waiting</span>
<span class="cm">						for msr change to happen */</span>
<span class="p">};</span>

<span class="cp">#define THROTTLED		0x01</span>

<span class="cm">/*</span>
<span class="cm"> * Handle vendor specific USB requests</span>
<span class="cm"> */</span>

<span class="cp">#define WDR_TIMEOUT 5000 </span><span class="cm">/* default urb timeout */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Later day 2.6.0-test kernels have new baud rates like B230400 which</span>
<span class="cm"> * we do not know how to support. We ignore them for the moment.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mct_u232_calculate_baud_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span>
					<span class="n">speed_t</span> <span class="n">value</span><span class="p">,</span> <span class="n">speed_t</span> <span class="o">*</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">)</span> <span class="o">==</span> <span class="n">MCT_U232_SITECOM_PID</span>
		<span class="o">||</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">)</span> <span class="o">==</span> <span class="n">MCT_U232_BELKIN_F5U109_PID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">300</span>:
			<span class="k">return</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">600</span>:
			<span class="k">return</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* this one not tested */</span>
		<span class="k">case</span> <span class="mi">1200</span>:
			<span class="k">return</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2400</span>:
			<span class="k">return</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4800</span>:
			<span class="k">return</span> <span class="mh">0x06</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">9600</span>:
			<span class="k">return</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">19200</span>:
			<span class="k">return</span> <span class="mh">0x09</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">38400</span>:
			<span class="k">return</span> <span class="mh">0x0a</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">57600</span>:
			<span class="k">return</span> <span class="mh">0x0b</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">115200</span>:
			<span class="k">return</span> <span class="mh">0x0c</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
			<span class="k">return</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* FIXME: Can we use any divider - should we do</span>
<span class="cm">		   divider = 115200/value;</span>
<span class="cm">		   real baud = 115200/divider */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">300</span>: <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">600</span>: <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1200</span>: <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2400</span>: <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4800</span>: <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">9600</span>: <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">19200</span>: <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">38400</span>: <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">57600</span>: <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">115200</span>: <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
			<span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">115200</span><span class="o">/</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mct_u232_set_baud_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">speed_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cts_enable_byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">speed_t</span> <span class="n">speed</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MCT_U232_MAX_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">divisor</span> <span class="o">=</span> <span class="n">mct_u232_calculate_baud_rate</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">speed</span><span class="p">);</span>
	<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">divisor</span><span class="p">),</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">MCT_U232_SET_BAUD_RATE_REQUEST</span><span class="p">,</span>
				<span class="n">MCT_U232_SET_REQUEST_TYPE</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">MCT_U232_SET_BAUD_RATE_SIZE</span><span class="p">,</span>
				<span class="n">WDR_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/*FIXME: What value speed results */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Set BAUD RATE %d failed (error = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">value</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tty_encode_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;set_baud_rate: value: 0x%x, divisor: 0x%x&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">divisor</span><span class="p">);</span>

	<span class="cm">/* Mimic the MCT-supplied Windows driver (version 1.21P.0104), which</span>
<span class="cm">	   always sends two extra USB &#39;device request&#39; messages after the</span>
<span class="cm">	   &#39;baud rate change&#39; message.  The actual functionality of the</span>
<span class="cm">	   request codes in these messages is not fully understood but these</span>
<span class="cm">	   particular codes are never seen in any operation besides a baud</span>
<span class="cm">	   rate change.  Both of these messages send a single byte of data.</span>
<span class="cm">	   In the first message, the value of this byte is always zero.</span>

<span class="cm">	   The second message has been determined experimentally to control</span>
<span class="cm">	   whether data will be transmitted to a device which is not asserting</span>
<span class="cm">	   the &#39;CTS&#39; signal.  If the second message&#39;s data byte is zero, data</span>
<span class="cm">	   will be transmitted even if &#39;CTS&#39; is not asserted (i.e. no hardware</span>
<span class="cm">	   flow control).  if the second message&#39;s data byte is nonzero (a</span>
<span class="cm">	   value of 1 is used by this driver), data will not be transmitted to</span>
<span class="cm">	   a device which is not asserting &#39;CTS&#39;.</span>
<span class="cm">	*/</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">MCT_U232_SET_UNKNOWN1_REQUEST</span><span class="p">,</span>
				<span class="n">MCT_U232_SET_REQUEST_TYPE</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">MCT_U232_SET_UNKNOWN1_SIZE</span><span class="p">,</span>
				<span class="n">WDR_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Sending USB device request code %d &quot;</span>
			<span class="s">&quot;failed (error = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MCT_U232_SET_UNKNOWN1_REQUEST</span><span class="p">,</span>
			<span class="n">rc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;&amp;</span> <span class="n">C_CRTSCTS</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
	   <span class="n">cts_enable_byte</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;set_baud_rate: send second control message, data = %02X&quot;</span><span class="p">,</span>
							<span class="n">cts_enable_byte</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cts_enable_byte</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">MCT_U232_SET_CTS_REQUEST</span><span class="p">,</span>
			<span class="n">MCT_U232_SET_REQUEST_TYPE</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">MCT_U232_SET_CTS_SIZE</span><span class="p">,</span>
			<span class="n">WDR_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Sending USB device request code %d &quot;</span>
			<span class="s">&quot;failed (error = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MCT_U232_SET_CTS_REQUEST</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* mct_u232_set_baud_rate */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mct_u232_set_line_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lcr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MCT_U232_MAX_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lcr</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">MCT_U232_SET_LINE_CTRL_REQUEST</span><span class="p">,</span>
			<span class="n">MCT_U232_SET_REQUEST_TYPE</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">MCT_U232_SET_LINE_CTRL_SIZE</span><span class="p">,</span>
			<span class="n">WDR_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Set LINE CTRL 0x%x failed (error = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lcr</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;set_line_ctrl: 0x%x&quot;</span><span class="p">,</span> <span class="n">lcr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* mct_u232_set_line_ctrl */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mct_u232_set_modem_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">control_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mcr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MCT_U232_MAX_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mcr</span> <span class="o">=</span> <span class="n">MCT_U232_MCR_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">control_state</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">MCT_U232_MCR_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">control_state</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">MCT_U232_MCR_RTS</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcr</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">MCT_U232_SET_MODEM_CTRL_REQUEST</span><span class="p">,</span>
			<span class="n">MCT_U232_SET_REQUEST_TYPE</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">MCT_U232_SET_MODEM_CTRL_SIZE</span><span class="p">,</span>
			<span class="n">WDR_TIMEOUT</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;set_modem_ctrl: state=0x%x ==&gt; mcr=0x%x&quot;</span><span class="p">,</span> <span class="n">control_state</span><span class="p">,</span> <span class="n">mcr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Set MODEM CTRL 0x%x failed (error = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mcr</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* mct_u232_set_modem_ctrl */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mct_u232_get_modem_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MCT_U232_MAX_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">msr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">MCT_U232_GET_MODEM_STAT_REQUEST</span><span class="p">,</span>
			<span class="n">MCT_U232_GET_REQUEST_TYPE</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">MCT_U232_GET_MODEM_STAT_SIZE</span><span class="p">,</span>
			<span class="n">WDR_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Get MODEM STATus failed (error = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="o">*</span><span class="n">msr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">msr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;get_modem_stat: 0x%x&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">msr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* mct_u232_get_modem_stat */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mct_u232_msr_to_icount</span><span class="p">(</span><span class="k">struct</span> <span class="n">async_icount</span> <span class="o">*</span><span class="n">icount</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">msr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Translate Control Line states */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MCT_U232_MSR_DDSR</span><span class="p">)</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MCT_U232_MSR_DCTS</span><span class="p">)</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MCT_U232_MSR_DRI</span><span class="p">)</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rng</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MCT_U232_MSR_DCD</span><span class="p">)</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* mct_u232_msr_to_icount */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mct_u232_msr_to_state</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">control_state</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">msr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Translate Control Line states */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MCT_U232_MSR_DSR</span><span class="p">)</span>
		<span class="o">*</span><span class="n">control_state</span> <span class="o">|=</span>  <span class="n">TIOCM_DSR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">control_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIOCM_DSR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MCT_U232_MSR_CTS</span><span class="p">)</span>
		<span class="o">*</span><span class="n">control_state</span> <span class="o">|=</span>  <span class="n">TIOCM_CTS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">control_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIOCM_CTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MCT_U232_MSR_RI</span><span class="p">)</span>
		<span class="o">*</span><span class="n">control_state</span> <span class="o">|=</span>  <span class="n">TIOCM_RI</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">control_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIOCM_RI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MCT_U232_MSR_CD</span><span class="p">)</span>
		<span class="o">*</span><span class="n">control_state</span> <span class="o">|=</span>  <span class="n">TIOCM_CD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">control_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIOCM_CD</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;msr_to_state: msr=0x%x ==&gt; state=0x%x&quot;</span><span class="p">,</span> <span class="n">msr</span><span class="p">,</span> <span class="o">*</span><span class="n">control_state</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* mct_u232_msr_to_state */</span>

<span class="cm">/*</span>
<span class="cm"> * Driver&#39;s tty interface functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mct_u232_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mct_u232_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mct_u232_private</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msr_wait</span><span class="p">);</span>
	<span class="n">usb_set_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">priv</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">write_wait</span><span class="p">);</span>

	<span class="cm">/* Puh, that&#39;s dirty */</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rport</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="cm">/* No unlinking, it wasn&#39;t submitted yet. */</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">read_urb</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">;</span>
	<span class="n">rport</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* mct_u232_startup */</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mct_u232_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mct_u232_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* My special items, the standard routines free my urbs */</span>
		<span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span> <span class="cm">/* mct_u232_release */</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="nf">mct_u232_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mct_u232_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">control_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">last_lcr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">last_msr</span><span class="p">;</span>

	<span class="cm">/* Compensate for a hardware bug: although the Sitecom U232-P25</span>
<span class="cm">	 * device reports a maximum output packet size of 32 bytes,</span>
<span class="cm">	 * it seems to be able to accept only 16 bytes (and that&#39;s what</span>
<span class="cm">	 * SniffUSB says too...)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">)</span>
						<span class="o">==</span> <span class="n">MCT_U232_SITECOM_PID</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">bulk_out_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* Do a defined restart: the normal serial device seems to</span>
<span class="cm">	 * always turn on DTR and RTS here, so do the same. I&#39;m not</span>
<span class="cm">	 * sure if this is really necessary. But it should not harm</span>
<span class="cm">	 * either.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">=</span> <span class="n">TIOCM_DTR</span> <span class="o">|</span> <span class="n">TIOCM_RTS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_lcr</span> <span class="o">=</span> <span class="p">(</span><span class="n">MCT_U232_DATA_BITS_8</span> <span class="o">|</span>
			  <span class="n">MCT_U232_PARITY_NONE</span> <span class="o">|</span>
			  <span class="n">MCT_U232_STOP_BITS_1</span><span class="p">);</span>
	<span class="n">control_state</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_state</span><span class="p">;</span>
	<span class="n">last_lcr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_lcr</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mct_u232_set_modem_ctrl</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">control_state</span><span class="p">);</span>
	<span class="n">mct_u232_set_line_ctrl</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">last_lcr</span><span class="p">);</span>

	<span class="cm">/* Read modem status and update control state */</span>
	<span class="n">mct_u232_get_modem_stat</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">last_msr</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_msr</span> <span class="o">=</span> <span class="n">last_msr</span><span class="p">;</span>
	<span class="n">mct_u232_msr_to_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_state</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_msr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;usb_submit_urb(read bulk) failed pipe 0x%x err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;usb_submit_urb(read int) failed pipe 0x%x err %d&quot;</span><span class="p">,</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* mct_u232_open */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mct_u232_dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">control_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mct_u232_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disconnected</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* drop DTR and RTS */</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">|=</span> <span class="n">TIOCM_DTR</span> <span class="o">|</span> <span class="n">TIOCM_RTS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TIOCM_DTR</span> <span class="o">|</span> <span class="n">TIOCM_RTS</span><span class="p">);</span>
		<span class="n">control_state</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_state</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">mct_u232_set_modem_ctrl</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">control_state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mct_u232_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* shutdown our urbs */</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="p">);</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">);</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span> <span class="cm">/* mct_u232_close */</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mct_u232_read_int_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mct_u232_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* success */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* this urb is terminated, clean up */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - urb shutting down with status: %d&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - nonzero urb status received: %d&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - bad serial pointer, exiting&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Work-a-round: handle the &#39;usual&#39; bulk-in pipe here</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tty_insert_flip_string</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
						<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
				<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The interrupt-in pipe signals exceptional conditions (modem line</span>
<span class="cm">	 * signal changes and errors). data[0] holds MSR, data[1] holds LSR.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_msr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">MCT_U232_MSR_INDEX</span><span class="p">];</span>

	<span class="cm">/* Record Control Line states */</span>
	<span class="n">mct_u232_msr_to_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_state</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_msr</span><span class="p">);</span>

	<span class="n">mct_u232_msr_to_icount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_msr</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* Not yet handled. See belkin_sa.c for further information */</span>
<span class="c">	/* Now to report any errors */</span>
<span class="c">	priv-&gt;last_lsr = data[MCT_U232_LSR_INDEX];</span>
<span class="c">	/*</span>
<span class="c">	 * fill in the flip buffer here, but I do not know the relation</span>
<span class="c">	 * to the current/next receive buffer or characters.  I need</span>
<span class="c">	 * to look in to this before committing any code.</span>
<span class="c">	 */</span>
<span class="c">	if (priv-&gt;last_lsr &amp; MCT_U232_LSR_ERR) {</span>
<span class="c">		tty = tty_port_tty_get(&amp;port-&gt;port);</span>
<span class="c">		/* Overrun Error */</span>
<span class="c">		if (priv-&gt;last_lsr &amp; MCT_U232_LSR_OE) {</span>
<span class="c">		}</span>
<span class="c">		/* Parity Error */</span>
<span class="c">		if (priv-&gt;last_lsr &amp; MCT_U232_LSR_PE) {</span>
<span class="c">		}</span>
<span class="c">		/* Framing Error */</span>
<span class="c">		if (priv-&gt;last_lsr &amp; MCT_U232_LSR_FE) {</span>
<span class="c">		}</span>
<span class="c">		/* Break Indicator */</span>
<span class="c">		if (priv-&gt;last_lsr &amp; MCT_U232_LSR_BI) {</span>
<span class="c">		}</span>
<span class="c">		tty_kref_put(tty);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">msr_wait</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - usb_submit_urb failed with result %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* mct_u232_read_int_callback */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mct_u232_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mct_u232_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflag</span> <span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old_cflag</span> <span class="o">=</span> <span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">control_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">last_lcr</span><span class="p">;</span>

	<span class="cm">/* get a local copy of the current port settings */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">control_state</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_state</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">last_lcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update baud rate.</span>
<span class="cm">	 * Do not attempt to cache old rates and skip settings,</span>
<span class="cm">	 * disconnects screw such tricks up completely.</span>
<span class="cm">	 * Premature optimization is the root of all evil.</span>
<span class="cm">	 */</span>

	<span class="cm">/* reassert DTR and RTS on transition from B0 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">old_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">==</span> <span class="n">B0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: baud was B0&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">control_state</span> <span class="o">|=</span> <span class="n">TIOCM_DTR</span> <span class="o">|</span> <span class="n">TIOCM_RTS</span><span class="p">;</span>
		<span class="n">mct_u232_set_modem_ctrl</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">control_state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mct_u232_set_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">serial</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">==</span> <span class="n">B0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: baud is B0&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="cm">/* Drop RTS and DTR */</span>
		<span class="n">control_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TIOCM_DTR</span> <span class="o">|</span> <span class="n">TIOCM_RTS</span><span class="p">);</span>
		<span class="n">mct_u232_set_modem_ctrl</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">control_state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update line control register (LCR)</span>
<span class="cm">	 */</span>

	<span class="cm">/* set the parity */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span>
		<span class="n">last_lcr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">MCT_U232_PARITY_ODD</span> <span class="o">:</span> <span class="n">MCT_U232_PARITY_EVEN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">last_lcr</span> <span class="o">|=</span> <span class="n">MCT_U232_PARITY_NONE</span><span class="p">;</span>

	<span class="cm">/* set the number of data bits */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS5</span>:
		<span class="n">last_lcr</span> <span class="o">|=</span> <span class="n">MCT_U232_DATA_BITS_5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS6</span>:
		<span class="n">last_lcr</span> <span class="o">|=</span> <span class="n">MCT_U232_DATA_BITS_6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>:
		<span class="n">last_lcr</span> <span class="o">|=</span> <span class="n">MCT_U232_DATA_BITS_7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS8</span>:
		<span class="n">last_lcr</span> <span class="o">|=</span> <span class="n">MCT_U232_DATA_BITS_8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;CSIZE was not CS5-CS8, using default of 8</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">last_lcr</span> <span class="o">|=</span> <span class="n">MCT_U232_DATA_BITS_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CMSPAR</span><span class="p">;</span>

	<span class="cm">/* set the number of stop bits */</span>
	<span class="n">last_lcr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">MCT_U232_STOP_BITS_2</span> <span class="o">:</span> <span class="n">MCT_U232_STOP_BITS_1</span><span class="p">;</span>

	<span class="n">mct_u232_set_line_ctrl</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">last_lcr</span><span class="p">);</span>

	<span class="cm">/* save off the modified port settings */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">=</span> <span class="n">control_state</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_lcr</span> <span class="o">=</span> <span class="n">last_lcr</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* mct_u232_set_termios */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mct_u232_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mct_u232_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lcr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lcr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_lcr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span><span class="p">)</span>
		<span class="n">lcr</span> <span class="o">|=</span> <span class="n">MCT_U232_SET_BREAK</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mct_u232_set_line_ctrl</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">lcr</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* mct_u232_break_ctl */</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">mct_u232_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mct_u232_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">control_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">control_state</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_state</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">control_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mct_u232_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mct_u232_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">control_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">control_state</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">control_state</span> <span class="o">|=</span> <span class="n">TIOCM_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">control_state</span> <span class="o">|=</span> <span class="n">TIOCM_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">control_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIOCM_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">control_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIOCM_DTR</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">=</span> <span class="n">control_state</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mct_u232_set_modem_ctrl</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">control_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mct_u232_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mct_u232_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">control_state</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">|=</span> <span class="n">THROTTLED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">C_CRTSCTS</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIOCM_RTS</span><span class="p">;</span>
		<span class="n">control_state</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_state</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">mct_u232_set_modem_ctrl</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">control_state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mct_u232_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mct_u232_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">control_state</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">THROTTLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">C_CRTSCTS</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">THROTTLED</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_state</span> <span class="o">|=</span> <span class="n">TIOCM_RTS</span><span class="p">;</span>
		<span class="n">control_state</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_state</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">mct_u232_set_modem_ctrl</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">control_state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="nf">mct_u232_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mct_u232_private</span> <span class="o">*</span><span class="n">mct_u232_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cnow</span><span class="p">,</span> <span class="n">cprev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d, cmd = 0x%x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">TIOCMIWAIT</span>:

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s (%d) TIOCMIWAIT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mct_u232_port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cprev</span> <span class="o">=</span> <span class="n">mct_u232_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mct_u232_port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mct_u232_port</span><span class="o">-&gt;</span><span class="n">msr_wait</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
			<span class="n">schedule</span><span class="p">();</span>
			<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mct_u232_port</span><span class="o">-&gt;</span><span class="n">msr_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
			<span class="cm">/* see if a signal did it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mct_u232_port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">cnow</span> <span class="o">=</span> <span class="n">mct_u232_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mct_u232_port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span> <span class="cm">/* no change =&gt; error */</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_RNG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_DSR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CD</span><span class="p">)</span>  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cprev</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="nf">mct_u232_get_icount</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">serial_icounter_struct</span> <span class="o">*</span><span class="n">icount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mct_u232_private</span> <span class="o">*</span><span class="n">mct_u232_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="o">*</span><span class="n">ic</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mct_u232_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mct_u232_port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">cts</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rng</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">dcd</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">overrun</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parity</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">brk</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">buf_overrun</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">buf_overrun</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mct_u232_port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s (%d) TIOCGICOUNT RX=%d, TX=%d&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">,</span> <span class="n">icount</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_usb_serial_driver</span><span class="p">(</span><span class="n">serial_drivers</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug enabled or not&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
