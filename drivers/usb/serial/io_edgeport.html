<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › serial › io_edgeport.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>io_edgeport.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Edgeport USB Serial Converter driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2000 Inside Out Networks, All rights reserved.</span>
<span class="cm"> * Copyright (C) 2001-2002 Greg Kroah-Hartman &lt;greg@kroah.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *	it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *	(at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * Supports the following devices:</span>
<span class="cm"> *	Edgeport/4</span>
<span class="cm"> *	Edgeport/4t</span>
<span class="cm"> *	Edgeport/2</span>
<span class="cm"> *	Edgeport/4i</span>
<span class="cm"> *	Edgeport/2i</span>
<span class="cm"> *	Edgeport/421</span>
<span class="cm"> *	Edgeport/21</span>
<span class="cm"> *	Rapidport/4</span>
<span class="cm"> *	Edgeport/8</span>
<span class="cm"> *	Edgeport/2D8</span>
<span class="cm"> *	Edgeport/4D8</span>
<span class="cm"> *	Edgeport/8i</span>
<span class="cm"> *</span>
<span class="cm"> * For questions or problems with this driver, contact Inside Out</span>
<span class="cm"> * Networks technical support, or Peter Berger &lt;pberger@brimson.com&gt;,</span>
<span class="cm"> * or Al Borchers &lt;alborchers@steinerpoint.com&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_driver.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/ihex.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/serial.h&gt;</span>
<span class="cp">#include &quot;io_edgeport.h&quot;</span>
<span class="cp">#include &quot;io_ionsp.h&quot;		</span><span class="cm">/* info for the iosp messages */</span><span class="cp"></span>
<span class="cp">#include &quot;io_16654.h&quot;		</span><span class="cm">/* 16654 UART defines */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Version Information</span>
<span class="cm"> */</span>
<span class="cp">#define DRIVER_VERSION &quot;v2.7&quot;</span>
<span class="cp">#define DRIVER_AUTHOR &quot;Greg Kroah-Hartman &lt;greg@kroah.com&gt; and David Iacovelli&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;Edgeport USB Serial Driver&quot;</span>

<span class="cp">#define MAX_NAME_LEN		64</span>

<span class="cp">#define CHASE_TIMEOUT		(5*HZ)		</span><span class="cm">/* 5 seconds */</span><span class="cp"></span>
<span class="cp">#define OPEN_TIMEOUT		(5*HZ)		</span><span class="cm">/* 5 seconds */</span><span class="cp"></span>
<span class="cp">#define COMMAND_TIMEOUT		(5*HZ)		</span><span class="cm">/* 5 seconds */</span><span class="cp"></span>

<span class="cm">/* receive port state */</span>
<span class="k">enum</span> <span class="n">RXSTATE</span> <span class="p">{</span>
	<span class="n">EXPECT_HDR1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>    <span class="cm">/* Expect header byte 1 */</span>
	<span class="n">EXPECT_HDR2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>    <span class="cm">/* Expect header byte 2 */</span>
	<span class="n">EXPECT_DATA</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>    <span class="cm">/* Expect &#39;RxBytesRemaining&#39; data */</span>
	<span class="n">EXPECT_HDR3</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>    <span class="cm">/* Expect header byte 3 (for status hdrs only) */</span>
<span class="p">};</span>


<span class="cm">/* Transmit Fifo</span>
<span class="cm"> * This Transmit queue is an extension of the edgeport Rx buffer.</span>
<span class="cm"> * The maximum amount of data buffered in both the edgeport</span>
<span class="cm"> * Rx buffer (maxTxCredits) and this buffer will never exceed maxTxCredits.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">TxFifo</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">head</span><span class="p">;</span>	<span class="cm">/* index to head pointer (write) */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tail</span><span class="p">;</span>	<span class="cm">/* index to tail pointer (read)  */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">count</span><span class="p">;</span>	<span class="cm">/* Bytes in queue */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">size</span><span class="p">;</span>	<span class="cm">/* Max size of queue (equal to Max number of TxCredits) */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">fifo</span><span class="p">;</span>	<span class="cm">/* allocated Buffer */</span>
<span class="p">};</span>

<span class="cm">/* This structure holds all of the local port information */</span>
<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="p">{</span>
	<span class="n">__u16</span>			<span class="n">txCredits</span><span class="p">;</span>		<span class="cm">/* our current credits for this port */</span>
	<span class="n">__u16</span>			<span class="n">maxTxCredits</span><span class="p">;</span>		<span class="cm">/* the max size of the port */</span>

	<span class="k">struct</span> <span class="n">TxFifo</span>		<span class="n">txfifo</span><span class="p">;</span>			<span class="cm">/* transmit fifo -- size will be maxTxCredits */</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">write_urb</span><span class="p">;</span>		<span class="cm">/* write URB for this port */</span>
	<span class="n">bool</span>			<span class="n">write_in_progress</span><span class="p">;</span>	<span class="cm">/* &#39;true&#39; while a write URB is outstanding */</span>
	<span class="n">spinlock_t</span>		<span class="n">ep_lock</span><span class="p">;</span>

	<span class="n">__u8</span>			<span class="n">shadowLCR</span><span class="p">;</span>		<span class="cm">/* last LCR value received */</span>
	<span class="n">__u8</span>			<span class="n">shadowMCR</span><span class="p">;</span>		<span class="cm">/* last MCR value received */</span>
	<span class="n">__u8</span>			<span class="n">shadowMSR</span><span class="p">;</span>		<span class="cm">/* last MSR value received */</span>
	<span class="n">__u8</span>			<span class="n">shadowLSR</span><span class="p">;</span>		<span class="cm">/* last LSR value received */</span>
	<span class="n">__u8</span>			<span class="n">shadowXonChar</span><span class="p">;</span>		<span class="cm">/* last value set as XON char in Edgeport */</span>
	<span class="n">__u8</span>			<span class="n">shadowXoffChar</span><span class="p">;</span>		<span class="cm">/* last value set as XOFF char in Edgeport */</span>
	<span class="n">__u8</span>			<span class="n">validDataMask</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">baudRate</span><span class="p">;</span>

	<span class="n">bool</span>			<span class="n">open</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">openPending</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">commandPending</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">closePending</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">chaseResponsePending</span><span class="p">;</span>

	<span class="n">wait_queue_head_t</span>	<span class="n">wait_chase</span><span class="p">;</span>		<span class="cm">/* for handling sleeping while waiting for chase to finish */</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">wait_open</span><span class="p">;</span>		<span class="cm">/* for handling sleeping while waiting for open to finish */</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">wait_command</span><span class="p">;</span>		<span class="cm">/* for handling sleeping while waiting for command to finish */</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">delta_msr_wait</span><span class="p">;</span>		<span class="cm">/* for handling sleeping while waiting for msr change to happen */</span>

	<span class="k">struct</span> <span class="n">async_icount</span>	<span class="n">icount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span>	<span class="o">*</span><span class="n">port</span><span class="p">;</span>			<span class="cm">/* loop back to the owner of this object */</span>
<span class="p">};</span>


<span class="cm">/* This structure holds all of the individual device information */</span>
<span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="p">{</span>
	<span class="kt">char</span>			<span class="n">name</span><span class="p">[</span><span class="n">MAX_NAME_LEN</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>		<span class="cm">/* string name of this device */</span>

	<span class="k">struct</span> <span class="n">edge_manuf_descriptor</span>	<span class="n">manuf_descriptor</span><span class="p">;</span>	<span class="cm">/* the manufacturer descriptor */</span>
	<span class="k">struct</span> <span class="n">edge_boot_descriptor</span>	<span class="n">boot_descriptor</span><span class="p">;</span>	<span class="cm">/* the boot firmware descriptor */</span>
	<span class="k">struct</span> <span class="n">edgeport_product_info</span>	<span class="n">product_info</span><span class="p">;</span>		<span class="cm">/* Product Info */</span>
	<span class="k">struct</span> <span class="n">edge_compatibility_descriptor</span> <span class="n">epic_descriptor</span><span class="p">;</span>	<span class="cm">/* Edgeport compatible descriptor */</span>
	<span class="kt">int</span>			<span class="n">is_epic</span><span class="p">;</span>			<span class="cm">/* flag if EPiC device or not */</span>

	<span class="n">__u8</span>			<span class="n">interrupt_in_endpoint</span><span class="p">;</span>		<span class="cm">/* the interrupt endpoint handle */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">interrupt_in_buffer</span><span class="p">;</span>		<span class="cm">/* the buffer we use for the interrupt endpoint */</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">interrupt_read_urb</span><span class="p">;</span>		<span class="cm">/* our interrupt urb */</span>

	<span class="n">__u8</span>			<span class="n">bulk_in_endpoint</span><span class="p">;</span>		<span class="cm">/* the bulk in endpoint handle */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">bulk_in_buffer</span><span class="p">;</span>		<span class="cm">/* the buffer we use for the bulk in endpoint */</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">read_urb</span><span class="p">;</span>			<span class="cm">/* our bulk read urb */</span>
	<span class="n">bool</span>			<span class="n">read_in_progress</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">es_lock</span><span class="p">;</span>

	<span class="n">__u8</span>			<span class="n">bulk_out_endpoint</span><span class="p">;</span>		<span class="cm">/* the bulk out endpoint handle */</span>

	<span class="n">__s16</span>			<span class="n">rxBytesAvail</span><span class="p">;</span>			<span class="cm">/* the number of bytes that we need to read from this device */</span>

	<span class="k">enum</span> <span class="n">RXSTATE</span>		<span class="n">rxState</span><span class="p">;</span>			<span class="cm">/* the current state of the bulk receive processor */</span>
	<span class="n">__u8</span>			<span class="n">rxHeader1</span><span class="p">;</span>			<span class="cm">/* receive header byte 1 */</span>
	<span class="n">__u8</span>			<span class="n">rxHeader2</span><span class="p">;</span>			<span class="cm">/* receive header byte 2 */</span>
	<span class="n">__u8</span>			<span class="n">rxHeader3</span><span class="p">;</span>			<span class="cm">/* receive header byte 3 */</span>
	<span class="n">__u8</span>			<span class="n">rxPort</span><span class="p">;</span>				<span class="cm">/* the port that we are currently receiving data for */</span>
	<span class="n">__u8</span>			<span class="n">rxStatusCode</span><span class="p">;</span>			<span class="cm">/* the receive status code */</span>
	<span class="n">__u8</span>			<span class="n">rxStatusParam</span><span class="p">;</span>			<span class="cm">/* the receive status paramater */</span>
	<span class="n">__s16</span>			<span class="n">rxBytesRemaining</span><span class="p">;</span>		<span class="cm">/* the number of port bytes left to read */</span>
	<span class="k">struct</span> <span class="n">usb_serial</span>	<span class="o">*</span><span class="n">serial</span><span class="p">;</span>			<span class="cm">/* loop back to the owner of this object */</span>
<span class="p">};</span>

<span class="cm">/* baud rate information */</span>
<span class="k">struct</span> <span class="n">divisor_table_entry</span> <span class="p">{</span>
	<span class="n">__u32</span>   <span class="n">BaudRate</span><span class="p">;</span>
	<span class="n">__u16</span>  <span class="n">Divisor</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Define table of divisors for Rev A EdgePort/4 hardware</span>
<span class="cm"> * These assume a 3.6864MHz crystal, the standard /16, and</span>
<span class="cm"> * MCR.7 = 0.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">divisor_table_entry</span> <span class="n">divisor_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>   <span class="mi">50</span><span class="p">,</span>		<span class="mi">4608</span><span class="p">},</span>
	<span class="p">{</span>   <span class="mi">75</span><span class="p">,</span>		<span class="mi">3072</span><span class="p">},</span>
	<span class="p">{</span>   <span class="mi">110</span><span class="p">,</span>	<span class="mi">2095</span><span class="p">},</span>	<span class="cm">/* 2094.545455 =&gt; 230450   =&gt; .0217 % over */</span>
	<span class="p">{</span>   <span class="mi">134</span><span class="p">,</span>	<span class="mi">1713</span><span class="p">},</span>	<span class="cm">/* 1713.011152 =&gt; 230398.5 =&gt; .00065% under */</span>
	<span class="p">{</span>   <span class="mi">150</span><span class="p">,</span>	<span class="mi">1536</span><span class="p">},</span>
	<span class="p">{</span>   <span class="mi">300</span><span class="p">,</span>	<span class="mi">768</span><span class="p">},</span>
	<span class="p">{</span>   <span class="mi">600</span><span class="p">,</span>	<span class="mi">384</span><span class="p">},</span>
	<span class="p">{</span>   <span class="mi">1200</span><span class="p">,</span>	<span class="mi">192</span><span class="p">},</span>
	<span class="p">{</span>   <span class="mi">1800</span><span class="p">,</span>	<span class="mi">128</span><span class="p">},</span>
	<span class="p">{</span>   <span class="mi">2400</span><span class="p">,</span>	<span class="mi">96</span><span class="p">},</span>
	<span class="p">{</span>   <span class="mi">4800</span><span class="p">,</span>	<span class="mi">48</span><span class="p">},</span>
	<span class="p">{</span>   <span class="mi">7200</span><span class="p">,</span>	<span class="mi">32</span><span class="p">},</span>
	<span class="p">{</span>   <span class="mi">9600</span><span class="p">,</span>	<span class="mi">24</span><span class="p">},</span>
	<span class="p">{</span>   <span class="mi">14400</span><span class="p">,</span>	<span class="mi">16</span><span class="p">},</span>
	<span class="p">{</span>   <span class="mi">19200</span><span class="p">,</span>	<span class="mi">12</span><span class="p">},</span>
	<span class="p">{</span>   <span class="mi">38400</span><span class="p">,</span>	<span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span>   <span class="mi">57600</span><span class="p">,</span>	<span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span>   <span class="mi">115200</span><span class="p">,</span>	<span class="mi">2</span><span class="p">},</span>
	<span class="p">{</span>   <span class="mi">230400</span><span class="p">,</span>	<span class="mi">1</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* local variables */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>

<span class="cm">/* Number of outstanding Command Write Urbs */</span>
<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">CmdUrbs</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>


<span class="cm">/* local function prototypes */</span>

<span class="cm">/* function prototypes for all URB callbacks */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">edge_interrupt_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">edge_bulk_in_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">edge_bulk_out_data_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">edge_bulk_out_cmd_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>

<span class="cm">/* function prototypes for the usbserial callbacks */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">edge_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">edge_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">edge_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">edge_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">edge_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">edge_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">edge_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">edge_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">edge_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">edge_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">edge_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">edge_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">edge_get_icount</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">serial_icounter_struct</span> <span class="o">*</span><span class="n">icount</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">edge_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">edge_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">edge_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">);</span>

<span class="cp">#include &quot;io_tables.h&quot;	</span><span class="cm">/* all of the devices that this driver supports */</span><span class="cp"></span>

<span class="cm">/* function prototypes for all of our local functions */</span>

<span class="k">static</span> <span class="kt">void</span>  <span class="n">process_rcvd_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">bufferLength</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">process_rcvd_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">,</span>
				<span class="n">__u8</span> <span class="n">byte2</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">byte3</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">edge_tty_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_new_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">newMsr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_new_lsr</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">lsrData</span><span class="p">,</span>
				<span class="n">__u8</span> <span class="n">lsr</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">send_iosp_ext_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">command</span><span class="p">,</span>
				<span class="n">__u8</span> <span class="n">param</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">calc_baud_rate_divisor</span><span class="p">(</span><span class="kt">int</span> <span class="n">baud_rate</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">divisor</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">send_cmd_write_baud_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">baudRate</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">change_port_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">send_cmd_write_uart_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span>
				<span class="n">__u8</span> <span class="n">regNum</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">regValue</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">write_cmd_usb</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">writeLength</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">send_more_port_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sram_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">extAddr</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">addr</span><span class="p">,</span>
					<span class="n">__u16</span> <span class="n">length</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rom_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">extAddr</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">addr</span><span class="p">,</span>
						<span class="n">__u16</span> <span class="n">length</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rom_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">extAddr</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">addr</span><span class="p">,</span>
					<span class="n">__u16</span> <span class="n">length</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">get_manufacturing_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">get_boot_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">load_application_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">unicode_to_ascii</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span>
				<span class="n">__le16</span> <span class="o">*</span><span class="n">unicode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unicode_size</span><span class="p">);</span>


<span class="cm">/* ************************************************************************ */</span>
<span class="cm">/* ************************************************************************ */</span>
<span class="cm">/* ************************************************************************ */</span>
<span class="cm">/* ************************************************************************ */</span>

<span class="cm">/************************************************************************</span>
<span class="cm"> *									*</span>
<span class="cm"> * update_edgeport_E2PROM()	Compare current versions of		*</span>
<span class="cm"> *				Boot ROM and Manufacture 		*</span>
<span class="cm"> *				Descriptors with versions		*</span>
<span class="cm"> *				embedded in this driver			*</span>
<span class="cm"> *									*</span>
<span class="cm"> ************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_edgeport_E2PROM</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">BootCurVer</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">BootNewVer</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">BootMajorVersion</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">BootMinorVersion</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">BootBuildNumber</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">Bootaddr</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ihex_binrec</span> <span class="o">*</span><span class="n">rec</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">response</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">iDownloadFile</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EDGE_DOWNLOAD_FILE_I930</span>:
		<span class="n">fw_name</span>	<span class="o">=</span> <span class="s">&quot;edgeport/boot.fw&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EDGE_DOWNLOAD_FILE_80251</span>:
		<span class="n">fw_name</span>	<span class="o">=</span> <span class="s">&quot;edgeport/boot2.fw&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">response</span> <span class="o">=</span> <span class="n">request_ihex_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to load image </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fw_name</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rec</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ihex_binrec</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">BootMajorVersion</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">BootMinorVersion</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">BootBuildNumber</span> <span class="o">=</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/* Check Boot Image Version */</span>
	<span class="n">BootCurVer</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">MajorVersion</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span>
		     <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">MinorVersion</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span>
		      <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">BuildNumber</span><span class="p">);</span>

	<span class="n">BootNewVer</span> <span class="o">=</span> <span class="p">(</span><span class="n">BootMajorVersion</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span>
		     <span class="p">(</span><span class="n">BootMinorVersion</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span>
		      <span class="n">BootBuildNumber</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Current Boot Image version %d.%d.%d&quot;</span><span class="p">,</span>
	    <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">MajorVersion</span><span class="p">,</span>
	    <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">MinorVersion</span><span class="p">,</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">BuildNumber</span><span class="p">));</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">BootNewVer</span> <span class="o">&gt;</span> <span class="n">BootCurVer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;**Update Boot Image from %d.%d.%d to %d.%d.%d&quot;</span><span class="p">,</span>
		    <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">MajorVersion</span><span class="p">,</span>
		    <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">MinorVersion</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">BuildNumber</span><span class="p">),</span>
		    <span class="n">BootMajorVersion</span><span class="p">,</span> <span class="n">BootMinorVersion</span><span class="p">,</span> <span class="n">BootBuildNumber</span><span class="p">);</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Downloading new Boot Image&quot;</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">rec</span> <span class="o">=</span> <span class="n">ihex_next_binrec</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span> <span class="n">rec</span><span class="p">;</span>
		     <span class="n">rec</span> <span class="o">=</span> <span class="n">ihex_next_binrec</span><span class="p">(</span><span class="n">rec</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">Bootaddr</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">response</span> <span class="o">=</span> <span class="n">rom_write</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span>
					     <span class="n">Bootaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
					     <span class="n">Bootaddr</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">,</span>
					     <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
					     <span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;rom_write failed (%x, %x, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">Bootaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">Bootaddr</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">,</span>
					<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Boot Image -- already up to date&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/************************************************************************</span>
<span class="c"> *</span>
<span class="c"> *  Get string descriptor from device</span>
<span class="c"> *</span>
<span class="c"> ************************************************************************/</span>
<span class="c">static int get_string_desc(struct usb_device *dev, int Id,</span>
<span class="c">				struct usb_string_descriptor **pRetDesc)</span>
<span class="c">{</span>
<span class="c">	struct usb_string_descriptor StringDesc;</span>
<span class="c">	struct usb_string_descriptor *pStringDesc;</span>

<span class="c">	dbg(&quot;%s - USB String ID = %d&quot;, __func__, Id);</span>

<span class="c">	if (!usb_get_descriptor(dev, USB_DT_STRING, Id, &amp;StringDesc,</span>
<span class="c">						sizeof(StringDesc)))</span>
<span class="c">		return 0;</span>

<span class="c">	pStringDesc = kmalloc(StringDesc.bLength, GFP_KERNEL);</span>
<span class="c">	if (!pStringDesc)</span>
<span class="c">		return -1;</span>

<span class="c">	if (!usb_get_descriptor(dev, USB_DT_STRING, Id, pStringDesc,</span>
<span class="c">							StringDesc.bLength)) {</span>
<span class="c">		kfree(pStringDesc);</span>
<span class="c">		return -1;</span>
<span class="c">	}</span>

<span class="c">	*pRetDesc = pStringDesc;</span>
<span class="c">	return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_product_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_product_info</span> <span class="o">*</span><span class="n">product_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Dump Product Info structure */</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;**Product Information:&quot;</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  ProductId             %x&quot;</span><span class="p">,</span> <span class="n">product_info</span><span class="o">-&gt;</span><span class="n">ProductId</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  NumPorts              %d&quot;</span><span class="p">,</span> <span class="n">product_info</span><span class="o">-&gt;</span><span class="n">NumPorts</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  ProdInfoVer           %d&quot;</span><span class="p">,</span> <span class="n">product_info</span><span class="o">-&gt;</span><span class="n">ProdInfoVer</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  IsServer              %d&quot;</span><span class="p">,</span> <span class="n">product_info</span><span class="o">-&gt;</span><span class="n">IsServer</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  IsRS232               %d&quot;</span><span class="p">,</span> <span class="n">product_info</span><span class="o">-&gt;</span><span class="n">IsRS232</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  IsRS422               %d&quot;</span><span class="p">,</span> <span class="n">product_info</span><span class="o">-&gt;</span><span class="n">IsRS422</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  IsRS485               %d&quot;</span><span class="p">,</span> <span class="n">product_info</span><span class="o">-&gt;</span><span class="n">IsRS485</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  RomSize               %d&quot;</span><span class="p">,</span> <span class="n">product_info</span><span class="o">-&gt;</span><span class="n">RomSize</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  RamSize               %d&quot;</span><span class="p">,</span> <span class="n">product_info</span><span class="o">-&gt;</span><span class="n">RamSize</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  CpuRev                %x&quot;</span><span class="p">,</span> <span class="n">product_info</span><span class="o">-&gt;</span><span class="n">CpuRev</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  BoardRev              %x&quot;</span><span class="p">,</span> <span class="n">product_info</span><span class="o">-&gt;</span><span class="n">BoardRev</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  BootMajorVersion      %d.%d.%d&quot;</span><span class="p">,</span> <span class="n">product_info</span><span class="o">-&gt;</span><span class="n">BootMajorVersion</span><span class="p">,</span>
	    <span class="n">product_info</span><span class="o">-&gt;</span><span class="n">BootMinorVersion</span><span class="p">,</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">product_info</span><span class="o">-&gt;</span><span class="n">BootBuildNumber</span><span class="p">));</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  FirmwareMajorVersion  %d.%d.%d&quot;</span><span class="p">,</span>
			<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">FirmwareMajorVersion</span><span class="p">,</span>
			<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">FirmwareMinorVersion</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">product_info</span><span class="o">-&gt;</span><span class="n">FirmwareBuildNumber</span><span class="p">));</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  ManufactureDescDate   %d/%d/%d&quot;</span><span class="p">,</span>
			<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">ManufactureDescDate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">ManufactureDescDate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">ManufactureDescDate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1900</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  iDownloadFile         0x%x&quot;</span><span class="p">,</span> <span class="n">product_info</span><span class="o">-&gt;</span><span class="n">iDownloadFile</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  EpicVer               %d&quot;</span><span class="p">,</span> <span class="n">product_info</span><span class="o">-&gt;</span><span class="n">EpicVer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_product_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_product_info</span> <span class="o">*</span><span class="n">product_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">product_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_product_info</span><span class="p">));</span>

	<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">ProductId</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ION_DEVICE_ID_80251_NETCHIP</span><span class="p">);</span>
	<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">NumPorts</span> <span class="o">=</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">NumPorts</span><span class="p">;</span>
	<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">ProdInfoVer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">RomSize</span> <span class="o">=</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">RomSize</span><span class="p">;</span>
	<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">RamSize</span> <span class="o">=</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">RamSize</span><span class="p">;</span>
	<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">CpuRev</span> <span class="o">=</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">CpuRev</span><span class="p">;</span>
	<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">BoardRev</span> <span class="o">=</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">BoardRev</span><span class="p">;</span>

	<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">BootMajorVersion</span> <span class="o">=</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">MajorVersion</span><span class="p">;</span>
	<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">BootMinorVersion</span> <span class="o">=</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">MinorVersion</span><span class="p">;</span>
	<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">BootBuildNumber</span> <span class="o">=</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">BuildNumber</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">product_info</span><span class="o">-&gt;</span><span class="n">ManufactureDescDate</span><span class="p">,</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">DescDate</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">DescDate</span><span class="p">));</span>

	<span class="cm">/* check if this is 2nd generation hardware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="n">ION_DEVICE_ID_80251_NETCHIP</span><span class="p">)</span>
		<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">iDownloadFile</span> <span class="o">=</span> <span class="n">EDGE_DOWNLOAD_FILE_80251</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">iDownloadFile</span> <span class="o">=</span> <span class="n">EDGE_DOWNLOAD_FILE_I930</span><span class="p">;</span>
 
	<span class="cm">/* Determine Product type and set appropriate flags */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">DEVICE_ID_FROM_USB_PRODUCT_ID</span><span class="p">(</span><span class="n">product_info</span><span class="o">-&gt;</span><span class="n">ProductId</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ION_DEVICE_ID_EDGEPORT_COMPATIBLE</span>:
	<span class="k">case</span> <span class="n">ION_DEVICE_ID_EDGEPORT_4T</span>:
	<span class="k">case</span> <span class="n">ION_DEVICE_ID_EDGEPORT_4</span>:
	<span class="k">case</span> <span class="n">ION_DEVICE_ID_EDGEPORT_2</span>:
	<span class="k">case</span> <span class="n">ION_DEVICE_ID_EDGEPORT_8_DUAL_CPU</span>:
	<span class="k">case</span> <span class="n">ION_DEVICE_ID_EDGEPORT_8</span>:
	<span class="k">case</span> <span class="n">ION_DEVICE_ID_EDGEPORT_421</span>:
	<span class="k">case</span> <span class="n">ION_DEVICE_ID_EDGEPORT_21</span>:
	<span class="k">case</span> <span class="n">ION_DEVICE_ID_EDGEPORT_2_DIN</span>:
	<span class="k">case</span> <span class="n">ION_DEVICE_ID_EDGEPORT_4_DIN</span>:
	<span class="k">case</span> <span class="n">ION_DEVICE_ID_EDGEPORT_16_DUAL_CPU</span>:
		<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">IsRS232</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ION_DEVICE_ID_EDGEPORT_2I</span>:	<span class="cm">/* Edgeport/2 RS422/RS485 */</span>
		<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">IsRS422</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">IsRS485</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ION_DEVICE_ID_EDGEPORT_8I</span>:	<span class="cm">/* Edgeport/4 RS422 */</span>
	<span class="k">case</span> <span class="n">ION_DEVICE_ID_EDGEPORT_4I</span>:	<span class="cm">/* Edgeport/4 RS422 */</span>
		<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">IsRS422</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dump_product_info</span><span class="p">(</span><span class="n">product_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_epic_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_product_info</span> <span class="o">*</span><span class="n">product_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edge_compatibility_descriptor</span> <span class="o">*</span><span class="n">epic</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epic_descriptor</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edge_compatibility_bits</span> <span class="o">*</span><span class="n">bits</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_epic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				 <span class="n">USB_REQUEST_ION_GET_EPIC_DESC</span><span class="p">,</span>
				 <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epic_descriptor</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">edge_compatibility_descriptor</span><span class="p">),</span>
				 <span class="mi">300</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s result = %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_epic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">product_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_product_info</span><span class="p">));</span>

		<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">NumPorts</span> <span class="o">=</span> <span class="n">epic</span><span class="o">-&gt;</span><span class="n">NumPorts</span><span class="p">;</span>
		<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">ProdInfoVer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">FirmwareMajorVersion</span> <span class="o">=</span> <span class="n">epic</span><span class="o">-&gt;</span><span class="n">MajorVersion</span><span class="p">;</span>
		<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">FirmwareMinorVersion</span> <span class="o">=</span> <span class="n">epic</span><span class="o">-&gt;</span><span class="n">MinorVersion</span><span class="p">;</span>
		<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">FirmwareBuildNumber</span> <span class="o">=</span> <span class="n">epic</span><span class="o">-&gt;</span><span class="n">BuildNumber</span><span class="p">;</span>
		<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">iDownloadFile</span> <span class="o">=</span> <span class="n">epic</span><span class="o">-&gt;</span><span class="n">iDownloadFile</span><span class="p">;</span>
		<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">EpicVer</span> <span class="o">=</span> <span class="n">epic</span><span class="o">-&gt;</span><span class="n">EpicVer</span><span class="p">;</span>
		<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">Epic</span> <span class="o">=</span> <span class="n">epic</span><span class="o">-&gt;</span><span class="n">Supports</span><span class="p">;</span>
		<span class="n">product_info</span><span class="o">-&gt;</span><span class="n">ProductId</span> <span class="o">=</span> <span class="n">ION_DEVICE_ID_EDGEPORT_COMPATIBLE</span><span class="p">;</span>
		<span class="n">dump_product_info</span><span class="p">(</span><span class="n">product_info</span><span class="p">);</span>

		<span class="n">bits</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epic_descriptor</span><span class="p">.</span><span class="n">Supports</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;**EPIC descriptor:&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  VendEnableSuspend: %s&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="o">-&gt;</span><span class="n">VendEnableSuspend</span>	<span class="o">?</span> <span class="s">&quot;TRUE&quot;</span><span class="o">:</span> <span class="s">&quot;FALSE&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  IOSPOpen         : %s&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="o">-&gt;</span><span class="n">IOSPOpen</span>		<span class="o">?</span> <span class="s">&quot;TRUE&quot;</span><span class="o">:</span> <span class="s">&quot;FALSE&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  IOSPClose        : %s&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="o">-&gt;</span><span class="n">IOSPClose</span>		<span class="o">?</span> <span class="s">&quot;TRUE&quot;</span><span class="o">:</span> <span class="s">&quot;FALSE&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  IOSPChase        : %s&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="o">-&gt;</span><span class="n">IOSPChase</span>		<span class="o">?</span> <span class="s">&quot;TRUE&quot;</span><span class="o">:</span> <span class="s">&quot;FALSE&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  IOSPSetRxFlow    : %s&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="o">-&gt;</span><span class="n">IOSPSetRxFlow</span>	<span class="o">?</span> <span class="s">&quot;TRUE&quot;</span><span class="o">:</span> <span class="s">&quot;FALSE&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  IOSPSetTxFlow    : %s&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="o">-&gt;</span><span class="n">IOSPSetTxFlow</span>	<span class="o">?</span> <span class="s">&quot;TRUE&quot;</span><span class="o">:</span> <span class="s">&quot;FALSE&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  IOSPSetXChar     : %s&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="o">-&gt;</span><span class="n">IOSPSetXChar</span>	<span class="o">?</span> <span class="s">&quot;TRUE&quot;</span><span class="o">:</span> <span class="s">&quot;FALSE&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  IOSPRxCheck      : %s&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="o">-&gt;</span><span class="n">IOSPRxCheck</span>	<span class="o">?</span> <span class="s">&quot;TRUE&quot;</span><span class="o">:</span> <span class="s">&quot;FALSE&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  IOSPSetClrBreak  : %s&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="o">-&gt;</span><span class="n">IOSPSetClrBreak</span>	<span class="o">?</span> <span class="s">&quot;TRUE&quot;</span><span class="o">:</span> <span class="s">&quot;FALSE&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  IOSPWriteMCR     : %s&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="o">-&gt;</span><span class="n">IOSPWriteMCR</span>	<span class="o">?</span> <span class="s">&quot;TRUE&quot;</span><span class="o">:</span> <span class="s">&quot;FALSE&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  IOSPWriteLCR     : %s&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="o">-&gt;</span><span class="n">IOSPWriteLCR</span>	<span class="o">?</span> <span class="s">&quot;TRUE&quot;</span><span class="o">:</span> <span class="s">&quot;FALSE&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  IOSPSetBaudRate  : %s&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="o">-&gt;</span><span class="n">IOSPSetBaudRate</span>	<span class="o">?</span> <span class="s">&quot;TRUE&quot;</span><span class="o">:</span> <span class="s">&quot;FALSE&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  TrueEdgeport     : %s&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="o">-&gt;</span><span class="n">TrueEdgeport</span>	<span class="o">?</span> <span class="s">&quot;TRUE&quot;</span><span class="o">:</span> <span class="s">&quot;FALSE&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/************************************************************************/</span>
<span class="cm">/************************************************************************/</span>
<span class="cm">/*            U S B  C A L L B A C K   F U N C T I O N S                */</span>
<span class="cm">/*            U S B  C A L L B A C K   F U N C T I O N S                */</span>
<span class="cm">/************************************************************************/</span>
<span class="cm">/************************************************************************/</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * edge_interrupt_callback</span>
<span class="cm"> *	this is the callback function for when we have received data on the</span>
<span class="cm"> *	interrupt endpoint.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_interrupt_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_serial</span>	<span class="o">*</span><span class="n">edge_serial</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_avail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">position</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">txCredits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">portNumber</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* success */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* this urb is terminated, clean up */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - urb shutting down with status: %d&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - nonzero urb status received: %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* process this interrupt-read even if there are no ports open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bytes_avail</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bytes_avail</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">es_lock</span><span class="p">);</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxBytesAvail</span> <span class="o">+=</span> <span class="n">bytes_avail</span><span class="p">;</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - bytes_avail=%d, rxBytesAvail=%d, read_in_progress=%d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bytes_avail</span><span class="p">,</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxBytesAvail</span><span class="p">,</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_in_progress</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxBytesAvail</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_in_progress</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - posting a read&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
					<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_in_progress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

					<span class="cm">/* we have pending bytes on the</span>
<span class="cm">					   bulk in pipe, send a request */</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - usb_submit_urb(read bulk) failed with result = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
						<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_in_progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">es_lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* grab the txcredits for the ports if available */</span>
		<span class="n">position</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">portNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">position</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">portNumber</span> <span class="o">&lt;</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">txCredits</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">position</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">position</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txCredits</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">port</span> <span class="o">=</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">portNumber</span><span class="p">];</span>
				<span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">);</span>
					<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span> <span class="o">+=</span> <span class="n">txCredits</span><span class="p">;</span>
					<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">);</span>
					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - txcredits for port%d = %d&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">portNumber</span><span class="p">,</span>
							<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span><span class="p">);</span>

					<span class="cm">/* tell the tty driver that something</span>
<span class="cm">					   has changed */</span>
					<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span>
						<span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
						<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="cm">/* Since we have more credit, check</span>
<span class="cm">					   if more data can be sent */</span>
					<span class="n">send_more_port_data</span><span class="p">(</span><span class="n">edge_serial</span><span class="p">,</span>
								<span class="n">edge_port</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">position</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="o">++</span><span class="n">portNumber</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - Error %d submitting control urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * edge_bulk_in_callback</span>
<span class="cm"> *	this is the callback function for when we have received data on the</span>
<span class="cm"> *	bulk in endpoint.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_bulk_in_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_serial</span>	<span class="o">*</span><span class="n">edge_serial</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span><span class="p">;</span>
	<span class="n">__u16</span>			<span class="n">raw_data_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - nonzero read bulk status received: %d&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_in_progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - read bulk callback with no data&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_in_progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">raw_data_length</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>

	<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">raw_data_length</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">es_lock</span><span class="p">);</span>

	<span class="cm">/* decrement our rxBytes available by the number that we just got */</span>
	<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxBytesAvail</span> <span class="o">-=</span> <span class="n">raw_data_length</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Received = %d, rxBytesAvail %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">raw_data_length</span><span class="p">,</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxBytesAvail</span><span class="p">);</span>

	<span class="n">process_rcvd_data</span><span class="p">(</span><span class="n">edge_serial</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>

	<span class="cm">/* check to see if there&#39;s any more data for us to read */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxBytesAvail</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - posting a read&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s - usb_submit_urb(read bulk) failed, &quot;</span>
				<span class="s">&quot;retval = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_in_progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_in_progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">es_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * edge_bulk_out_data_callback</span>
<span class="cm"> *	this is the callback function for when we have finished sending</span>
<span class="cm"> *	serial data on the bulk out endpoint.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_bulk_out_data_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - nonzero write bulk status received: %d&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* let the tty driver wakeup if it has a special</span>
<span class="cm">		   write_wakeup function */</span>
		<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="cm">/* Release the Write URB */</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_in_progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Check if more data needs to be sent */</span>
	<span class="n">send_more_port_data</span><span class="p">((</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">usb_get_serial_data</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">)),</span> <span class="n">edge_port</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * BulkOutCmdCallback</span>
<span class="cm"> *	this is the callback function for when we have finished sending a</span>
<span class="cm"> *	command	on the bulk out endpoint.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_bulk_out_cmd_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CmdUrbs</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - FREE URB %p (outstanding %d)&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">urb</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CmdUrbs</span><span class="p">));</span>


	<span class="cm">/* clean up the transfer buffer */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>

	<span class="cm">/* Free the command urb */</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - nonzero write bulk status received: %d&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get pointer to tty */</span>
	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/* tell the tty driver that something has changed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span>
		<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="cm">/* we have completed the command */</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">commandPending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">wait_command</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Driver tty interface functions</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * SerialOpen</span>
<span class="cm"> *	this function is called by the tty driver when a port is opened</span>
<span class="cm"> *	If successful, we return 0</span>
<span class="cm"> *	Otherwise we return a negative error number.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">response</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* see if we&#39;ve set up our endpoint info yet (can&#39;t set it up</span>
<span class="cm">	   in edge_startup as the structures were not set up at that time.) */</span>
	<span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
	<span class="n">edge_serial</span> <span class="o">=</span> <span class="n">usb_get_serial_data</span><span class="p">(</span><span class="n">serial</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_serial</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_in_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port0</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="cm">/* not set up yet, so do it now */</span>
		<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_in_buffer</span> <span class="o">=</span>
					<span class="n">port0</span><span class="o">-&gt;</span><span class="n">interrupt_in_buffer</span><span class="p">;</span>
		<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_in_endpoint</span> <span class="o">=</span>
					<span class="n">port0</span><span class="o">-&gt;</span><span class="n">interrupt_in_endpointAddress</span><span class="p">;</span>
		<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_read_urb</span> <span class="o">=</span> <span class="n">port0</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">;</span>
		<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">bulk_in_buffer</span> <span class="o">=</span> <span class="n">port0</span><span class="o">-&gt;</span><span class="n">bulk_in_buffer</span><span class="p">;</span>
		<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">bulk_in_endpoint</span> <span class="o">=</span>
					<span class="n">port0</span><span class="o">-&gt;</span><span class="n">bulk_in_endpointAddress</span><span class="p">;</span>
		<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_urb</span> <span class="o">=</span> <span class="n">port0</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">;</span>
		<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">bulk_out_endpoint</span> <span class="o">=</span>
					<span class="n">port0</span><span class="o">-&gt;</span><span class="n">bulk_out_endpointAddress</span><span class="p">;</span>

		<span class="cm">/* set up our interrupt urb */</span>
		<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_read_urb</span><span class="p">,</span>
		      <span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		      <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">port0</span><span class="o">-&gt;</span><span class="n">interrupt_in_endpointAddress</span><span class="p">),</span>
		      <span class="n">port0</span><span class="o">-&gt;</span><span class="n">interrupt_in_buffer</span><span class="p">,</span>
		      <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_read_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span>
		      <span class="n">edge_interrupt_callback</span><span class="p">,</span> <span class="n">edge_serial</span><span class="p">,</span>
		      <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_read_urb</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">);</span>

		<span class="cm">/* set up our bulk in urb */</span>
		<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">,</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">port0</span><span class="o">-&gt;</span><span class="n">bulk_in_endpointAddress</span><span class="p">),</span>
			<span class="n">port0</span><span class="o">-&gt;</span><span class="n">bulk_in_buffer</span><span class="p">,</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span>
			<span class="n">edge_bulk_in_callback</span><span class="p">,</span> <span class="n">edge_serial</span><span class="p">);</span>
		<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_in_progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* start interrupt read for this edgeport</span>
<span class="cm">		 * this interrupt will continue as long</span>
<span class="cm">		 * as the edgeport is connected */</span>
		<span class="n">response</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_read_urb</span><span class="p">,</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s - Error %d submitting control urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* initialize our wait queues */</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">wait_open</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">wait_chase</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">delta_msr_wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">wait_command</span><span class="p">);</span>

	<span class="cm">/* initialize our icount structure */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">));</span>

	<span class="cm">/* initialize our port settings */</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Can&#39;t send any data yet */</span>
	<span class="cm">/* Must always set this bit to enable ints! */</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">=</span> <span class="n">MCR_MASTER_IE</span><span class="p">;</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">chaseResponsePending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* send a open port command */</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">openPending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">open</span>        <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">send_iosp_ext_cmd</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">IOSP_CMD_OPEN_PORT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - error sending open port command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">openPending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* now wait for the port to be completely opened */</span>
	<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">wait_open</span><span class="p">,</span> <span class="o">!</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">openPending</span><span class="p">,</span>
								<span class="n">OPEN_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* open timed out */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - open timedout&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">openPending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create the txfifo */</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">.</span><span class="n">head</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">.</span><span class="n">tail</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">.</span><span class="n">count</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">maxTxCredits</span><span class="p">;</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">.</span><span class="n">fifo</span>	<span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">maxTxCredits</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">.</span><span class="n">fifo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - no memory&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">edge_close</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate a URB for the write */</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_in_progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - no memory&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">edge_close</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s(%d) - Initialize TX fifo to %d bytes&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">maxTxCredits</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s exited&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * block_until_chase_response</span>
<span class="cm"> *</span>
<span class="cm"> *	This function will block the close until one of the following:</span>
<span class="cm"> *		1. Response to our Chase comes from Edgeport</span>
<span class="cm"> *		2. A timeout of 10 seconds without activity has expired</span>
<span class="cm"> *		   (1K of Edgeport data @ 2400 baud ==&gt; 4 sec to empty)</span>
<span class="cm"> *</span>
<span class="cm"> ************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">block_until_chase_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">__u16</span> <span class="n">lastCredits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Save Last credits */</span>
		<span class="n">lastCredits</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span><span class="p">;</span>

		<span class="cm">/* Did we get our Chase response */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">chaseResponsePending</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Got Chase Response&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

			<span class="cm">/* did we get all of our credit back? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span> <span class="o">==</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">maxTxCredits</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Got all credits&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Block the thread for a while */</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">wait_chase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span>
						<span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
		<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">wait_chase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lastCredits</span> <span class="o">==</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No activity.. count down. */</span>
			<span class="n">loop</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">chaseResponsePending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Chase TIMEOUT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Reset timeout value back to 10 seconds */</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Last %d, Current %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">lastCredits</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span><span class="p">);</span>
			<span class="n">loop</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * block_until_tx_empty</span>
<span class="cm"> *</span>
<span class="cm"> *	This function will block the close until one of the following:</span>
<span class="cm"> *		1. TX count are 0</span>
<span class="cm"> *		2. The edgeport has stopped</span>
<span class="cm"> *		3. A timeout of 3 seconds without activity has expired</span>
<span class="cm"> *</span>
<span class="cm"> ************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">block_until_tx_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">TxFifo</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">lastCount</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Save Last count */</span>
		<span class="n">lastCount</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>

		<span class="cm">/* Is the Edgeport Buffer empty? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lastCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - TX Buffer Empty&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Block the thread for a while */</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">wait_chase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span>
						<span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
		<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">wait_chase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s wait&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lastCount</span> <span class="o">==</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No activity.. count down. */</span>
			<span class="n">loop</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - TIMEOUT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Reset timeout value back to seconds */</span>
			<span class="n">loop</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * edge_close</span>
<span class="cm"> *	this function is called by the tty driver when a port is closed</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">edge_serial</span> <span class="o">=</span> <span class="n">usb_get_serial_data</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">);</span>
	<span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_serial</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* block until tx is empty */</span>
	<span class="n">block_until_tx_empty</span><span class="p">(</span><span class="n">edge_port</span><span class="p">);</span>

	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">closePending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">epic_descriptor</span><span class="p">.</span><span class="n">Supports</span><span class="p">.</span><span class="n">IOSPChase</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* flush and chase */</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">chaseResponsePending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Sending IOSP_CMD_CHASE_PORT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">send_iosp_ext_cmd</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">IOSP_CMD_CHASE_PORT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* block until chase finished */</span>
			<span class="n">block_until_chase_response</span><span class="p">(</span><span class="n">edge_port</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">chaseResponsePending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">epic_descriptor</span><span class="p">.</span><span class="n">Supports</span><span class="p">.</span><span class="n">IOSPClose</span><span class="p">)))</span> <span class="p">{</span>
	       <span class="cm">/* close the port */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Sending IOSP_CMD_CLOSE_PORT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">send_iosp_ext_cmd</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">IOSP_CMD_CLOSE_PORT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* port-&gt;close = true; */</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">closePending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">openPending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if this urb had a transfer buffer already</span>
<span class="cm">				(old transfer) free it */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="p">);</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">.</span><span class="n">fifo</span><span class="p">);</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">.</span><span class="n">fifo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s exited&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * SerialWrite</span>
<span class="cm"> *	this function is called by the tty driver when data should be written</span>
<span class="cm"> *	to the port.</span>
<span class="cm"> *	If successful, we return the number of bytes written, otherwise we</span>
<span class="cm"> *	return a negative error number.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">TxFifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copySize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytesleft</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">firsthalf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">secondhalf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* get a pointer to the Tx fifo */</span>
	<span class="n">fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* calculate number of bytes to put in fifo */</span>
	<span class="n">copySize</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">count</span><span class="p">,</span>
				<span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span> <span class="o">-</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">));</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s(%d) of %d byte(s) Fifo room  %d -- will copy %d bytes&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
			<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span> <span class="o">-</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="n">copySize</span><span class="p">);</span>

	<span class="cm">/* catch writes of 0 bytes which the tty driver likes to give us,</span>
<span class="cm">	   and when txCredits is empty */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copySize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - copySize = Zero&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">finish_write</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* queue the data</span>
<span class="cm">	 * since we can never overflow the buffer we do not have to check for a</span>
<span class="cm">	 * full condition</span>
<span class="cm">	 *</span>
<span class="cm">	 * the copy is done is two parts -- first fill to the end of the buffer</span>
<span class="cm">	 * then copy the reset from the start of the buffer</span>
<span class="cm">	 */</span>
	<span class="n">bytesleft</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">firsthalf</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">bytesleft</span><span class="p">,</span> <span class="n">copySize</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - copy %d bytes of %d into fifo &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">firsthalf</span><span class="p">,</span> <span class="n">bytesleft</span><span class="p">);</span>

	<span class="cm">/* now copy our data */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">[</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">firsthalf</span><span class="p">);</span>
	<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">firsthalf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">[</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">]);</span>

	<span class="cm">/* update the index and size */</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">head</span>  <span class="o">+=</span> <span class="n">firsthalf</span><span class="p">;</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+=</span> <span class="n">firsthalf</span><span class="p">;</span>

	<span class="cm">/* wrap the index */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">==</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">secondhalf</span> <span class="o">=</span> <span class="n">copySize</span><span class="o">-</span><span class="n">firsthalf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">secondhalf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - copy rest of data %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">secondhalf</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">[</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">firsthalf</span><span class="p">],</span> <span class="n">secondhalf</span><span class="p">);</span>
		<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">secondhalf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">[</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">]);</span>
		<span class="cm">/* update the index and size */</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+=</span> <span class="n">secondhalf</span><span class="p">;</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">head</span>  <span class="o">+=</span> <span class="n">secondhalf</span><span class="p">;</span>
		<span class="cm">/* No need to check for wrap since we can not get to end of</span>
<span class="cm">		 * the fifo in this part</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

<span class="nl">finish_write:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">send_more_port_data</span><span class="p">((</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">usb_get_serial_data</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">),</span> <span class="n">edge_port</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s wrote %d byte(s) TxCredits %d, Fifo %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">copySize</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">copySize</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * send_more_port_data()</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine attempts to write additional UART transmit data</span>
<span class="cm"> *	to a port over the USB bulk pipe. It is called (1) when new</span>
<span class="cm"> *	data has been written to a port&#39;s TxBuffer from higher layers</span>
<span class="cm"> *	(2) when the peripheral sends us additional TxCredits indicating</span>
<span class="cm"> *	that it can accept more	Tx data for a given port; and (3) when</span>
<span class="cm"> *	a bulk write completes successfully and we want to see if we</span>
<span class="cm"> *	can transmit more.</span>
<span class="cm"> *</span>
<span class="cm"> ************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_more_port_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">TxFifo</span>	<span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span>	<span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">bytesleft</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">firsthalf</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">secondhalf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s(%d)&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_in_progress</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">open</span>             <span class="o">||</span>
	    <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s(%d) EXIT - fifo %d, PendingWrite = %d&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_in_progress</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_send</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* since the amount of data in the fifo will always fit into the</span>
<span class="cm">	 * edgeport buffer we do not need to check the write length</span>
<span class="cm">	 *</span>
<span class="cm">	 * Do we have enough credits for this port to make it worthwhile</span>
<span class="cm">	 * to bother queueing a write. If it&#39;s too small, say a few bytes,</span>
<span class="cm">	 * it&#39;s better to wait for more credits so we can do a larger write.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span> <span class="o">&lt;</span> <span class="n">EDGE_FW_GET_TX_CREDITS_SEND_THRESHOLD</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">maxTxCredits</span><span class="p">,</span> <span class="n">EDGE_FW_BULK_MAX_PACKET_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s(%d) Not enough credit - fifo %d TxCredit %d&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
			<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_send</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* lock this write */</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_in_progress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* get a pointer to the write_urb */</span>
	<span class="n">urb</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="p">;</span>

	<span class="cm">/* make sure transfer buffer is freed */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* build the data header for the buffer and port that we are about</span>
<span class="cm">	   to send out */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err_console</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
				<span class="s">&quot;%s - no more kernel memory...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_in_progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_send</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IOSP_BUILD_DATA_HDR1</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span>
				<span class="o">-</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IOSP_BUILD_DATA_HDR2</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span>
				<span class="o">-</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="cm">/* now copy our data */</span>
	<span class="n">bytesleft</span> <span class="o">=</span>  <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
	<span class="n">firsthalf</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">bytesleft</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">[</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">],</span> <span class="n">firsthalf</span><span class="p">);</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tail</span>  <span class="o">+=</span> <span class="n">firsthalf</span><span class="p">;</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-=</span> <span class="n">firsthalf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">==</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">secondhalf</span> <span class="o">=</span> <span class="n">count</span><span class="o">-</span><span class="n">firsthalf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">secondhalf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">firsthalf</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">[</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">],</span>
								<span class="n">secondhalf</span><span class="p">);</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tail</span>  <span class="o">+=</span> <span class="n">secondhalf</span><span class="p">;</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-=</span> <span class="n">secondhalf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
		<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="cm">/* fill up the urb with all of our data and submit it */</span>
	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">bulk_out_endpoint</span><span class="p">),</span>
			<span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span>
			<span class="n">edge_bulk_out_data_callback</span><span class="p">,</span> <span class="n">edge_port</span><span class="p">);</span>

	<span class="cm">/* decrement the number of credits we have by the number we just sent */</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* something went wrong */</span>
		<span class="n">dev_err_console</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
			<span class="s">&quot;%s - usb_submit_urb(write bulk) failed, status = %d, data lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_in_progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* revert the credits as something bad happened. */</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s wrote %d byte(s) TxCredit %d, Fifo %d&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

<span class="nl">exit_send:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * edge_write_room</span>
<span class="cm"> *	this function is called by the tty driver when it wants to know how</span>
<span class="cm"> *	many bytes of data we can accept for a specific port. If successful,</span>
<span class="cm"> *	we return the amount of room that we have for this port	(the txCredits)</span>
<span class="cm"> *	otherwise we return a negative error number.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">room</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">closePending</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port not opened&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* total of both buffers is still txCredit */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">room</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span> <span class="o">-</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - returns %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">room</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">room</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * edge_chars_in_buffer</span>
<span class="cm"> *	this function is called by the tty driver when it wants to know how</span>
<span class="cm"> *	many bytes of data we currently have outstanding in the port (data that</span>
<span class="cm"> *	has been written, but hasn&#39;t made it out the port yet)</span>
<span class="cm"> *	If successful, we return the number of bytes left to be written in the</span>
<span class="cm"> *	system,</span>
<span class="cm"> *	Otherwise we return a negative error number.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">num_chars</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">closePending</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port not opened&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">num_chars</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">maxTxCredits</span> <span class="o">-</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span> <span class="o">+</span>
						<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_chars</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s(port %d) - returns %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
						<span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">num_chars</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">num_chars</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * SerialThrottle</span>
<span class="cm"> *	this function is called by the tty driver when it wants to stop the data</span>
<span class="cm"> *	being read from the port.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port not opened&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if we are implementing XON/XOFF, send the stop character */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">stop_char</span> <span class="o">=</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">edge_write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stop_char</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if we are implementing RTS/CTS, toggle that line */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MCR_RTS</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">send_cmd_write_uart_register</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">MCR</span><span class="p">,</span>
							<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * edge_unthrottle</span>
<span class="cm"> *	this function is called by the tty driver when it wants to resume the</span>
<span class="cm"> *	data being read from the port (called after SerialThrottle is called)</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port not opened&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if we are implementing XON/XOFF, send the start character */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">start_char</span> <span class="o">=</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">edge_write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start_char</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* if we are implementing RTS/CTS, toggle that line */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">|=</span> <span class="n">MCR_RTS</span><span class="p">;</span>
		<span class="n">send_cmd_write_uart_register</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">MCR</span><span class="p">,</span>
						<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * SerialSetTermios</span>
<span class="cm"> *	this function is called by the tty driver when it wants to change</span>
<span class="cm"> * the termios structure</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflag</span><span class="p">;</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - clfag %08x iflag %08x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - old clfag %08x old iflag %08x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port not opened&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* change the port settings to the new ones specified */</span>
	<span class="n">change_port_settings</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">edge_port</span><span class="p">,</span> <span class="n">old_termios</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * get_lsr_info - get line status register info</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: Let user call ioctl() to get info when the UART physically</span>
<span class="cm"> * 	    is emptied.  On bus types like RS485, the transmitter must</span>
<span class="cm"> * 	    release the bus after transmitting. This must be done when</span>
<span class="cm"> * 	    the transmit shift register is empty, not be done when the</span>
<span class="cm"> * 	    transmit holding register is empty.  This functionality</span>
<span class="cm"> * 	    allows an RS485 driver to be written in user space.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_lsr_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">maxTxCredits</span> <span class="o">==</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span> <span class="o">&amp;&amp;</span>
	    <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s -- Empty&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">TIOCSER_TEMT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mcr</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">mcr</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">MCR_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">MCR_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_LOOP</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">MCR_LOOPBACK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MCR_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MCR_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_LOOP</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MCR_LOOPBACK</span><span class="p">;</span>

	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">=</span> <span class="n">mcr</span><span class="p">;</span>

	<span class="n">send_cmd_write_uart_register</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">MCR</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mcr</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">msr</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowMSR</span><span class="p">;</span>
	<span class="n">mcr</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">MCR_DTR</span><span class="p">)</span>	<span class="o">?</span> <span class="n">TIOCM_DTR</span><span class="o">:</span> <span class="mi">0</span><span class="p">)</span>	  <span class="cm">/* 0x002 */</span>
		  <span class="o">|</span> <span class="p">((</span><span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">MCR_RTS</span><span class="p">)</span>	<span class="o">?</span> <span class="n">TIOCM_RTS</span><span class="o">:</span> <span class="mi">0</span><span class="p">)</span>   <span class="cm">/* 0x004 */</span>
		  <span class="o">|</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">EDGEPORT_MSR_CTS</span><span class="p">)</span>	<span class="o">?</span> <span class="n">TIOCM_CTS</span><span class="o">:</span> <span class="mi">0</span><span class="p">)</span>   <span class="cm">/* 0x020 */</span>
		  <span class="o">|</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">EDGEPORT_MSR_CD</span><span class="p">)</span>	<span class="o">?</span> <span class="n">TIOCM_CAR</span><span class="o">:</span> <span class="mi">0</span><span class="p">)</span>   <span class="cm">/* 0x040 */</span>
		  <span class="o">|</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">EDGEPORT_MSR_RI</span><span class="p">)</span>	<span class="o">?</span> <span class="n">TIOCM_RI</span><span class="o">:</span>  <span class="mi">0</span><span class="p">)</span>   <span class="cm">/* 0x080 */</span>
		  <span class="o">|</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">EDGEPORT_MSR_DSR</span><span class="p">)</span>	<span class="o">?</span> <span class="n">TIOCM_DSR</span><span class="o">:</span> <span class="mi">0</span><span class="p">);</span>  <span class="cm">/* 0x100 */</span>


	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s -- %x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_get_icount</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">serial_icounter_struct</span> <span class="o">*</span><span class="n">icount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="n">cnow</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>

	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rng</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rng</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">overrun</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">parity</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">brk</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">buf_overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">buf_overrun</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s (%d) TIOCGICOUNT RX=%d, TX=%d&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">,</span> <span class="n">icount</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">retinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retinfo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>

	<span class="n">tmp</span><span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PORT_16550A</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">line</span>		<span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">port</span>		<span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">irq</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">ASYNC_SKIP_TEST</span> <span class="o">|</span> <span class="n">ASYNC_AUTO_IRQ</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">xmit_fifo_size</span>	<span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">maxTxCredits</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">baud_base</span>		<span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">close_delay</span>		<span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">closing_wait</span>	<span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">retinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">retinfo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * SerialIoctl</span>
<span class="cm"> *	this function handles any ioctl calls to the driver</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cprev</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d, cmd = 0x%x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIOCSERGETLSR</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s (%d) TIOCSERGETLSR&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">get_lsr_info</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">TIOCGSERIAL</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s (%d) TIOCGSERIAL&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">get_serial_info</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">TIOCMIWAIT</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s (%d) TIOCMIWAIT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">cprev</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">delta_msr_wait</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
			<span class="n">schedule</span><span class="p">();</span>
			<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">delta_msr_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
			<span class="cm">/* see if a signal did it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="n">cnow</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span> <span class="cm">/* no change =&gt; error */</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_RNG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_DSR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CD</span><span class="p">)</span>  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cprev</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* NOTREACHED */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * SerialBreak</span>
<span class="cm"> *	this function sends a break to the port</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span> <span class="o">=</span> <span class="n">usb_get_serial_data</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">epic_descriptor</span><span class="p">.</span><span class="n">Supports</span><span class="p">.</span><span class="n">IOSPChase</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* flush and chase */</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">chaseResponsePending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Sending IOSP_CMD_CHASE_PORT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">send_iosp_ext_cmd</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">IOSP_CMD_CHASE_PORT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* block until chase finished */</span>
			<span class="n">block_until_chase_response</span><span class="p">(</span><span class="n">edge_port</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">chaseResponsePending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">epic_descriptor</span><span class="p">.</span><span class="n">Supports</span><span class="p">.</span><span class="n">IOSPSetClrBreak</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Sending IOSP_CMD_SET_BREAK&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">send_iosp_ext_cmd</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span>
						<span class="n">IOSP_CMD_SET_BREAK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Sending IOSP_CMD_CLEAR_BREAK&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">send_iosp_ext_cmd</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span>
						<span class="n">IOSP_CMD_CLEAR_BREAK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - error sending break set/clear command.&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * process_rcvd_data</span>
<span class="cm"> *	this function handles the data received on the bulk in pipe.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_rcvd_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">bufferLength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">lastBufferLength</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">rxLen</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">lastBufferLength</span> <span class="o">=</span> <span class="n">bufferLength</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">bufferLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* failsafe incase we get a message that we don&#39;t understand */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lastBufferLength</span> <span class="o">==</span> <span class="n">bufferLength</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - stuck in loop, exiting it.&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lastBufferLength</span> <span class="o">=</span> <span class="n">bufferLength</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxState</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">EXPECT_HDR1</span>:
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxHeader1</span> <span class="o">=</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
			<span class="o">++</span><span class="n">buffer</span><span class="p">;</span>
			<span class="o">--</span><span class="n">bufferLength</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bufferLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxState</span> <span class="o">=</span> <span class="n">EXPECT_HDR2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* otherwise, drop on through */</span>
		<span class="k">case</span> <span class="n">EXPECT_HDR2</span>:
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxHeader2</span> <span class="o">=</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
			<span class="o">++</span><span class="n">buffer</span><span class="p">;</span>
			<span class="o">--</span><span class="n">bufferLength</span><span class="p">;</span>

			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Hdr1=%02X Hdr2=%02X&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			    <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxHeader1</span><span class="p">,</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxHeader2</span><span class="p">);</span>
			<span class="cm">/* Process depending on whether this header is</span>
<span class="cm">			 * data or status */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">IS_CMD_STAT_HDR</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxHeader1</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Decode this status header and go to</span>
<span class="cm">				 * EXPECT_HDR1 (if we can process the status</span>
<span class="cm">				 * with only 2 bytes), or go to EXPECT_HDR3 to</span>
<span class="cm">				 * get the third byte. */</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxPort</span> <span class="o">=</span>
				    <span class="n">IOSP_GET_HDR_PORT</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxHeader1</span><span class="p">);</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxStatusCode</span> <span class="o">=</span>
				    <span class="n">IOSP_GET_STATUS_CODE</span><span class="p">(</span>
						<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxHeader1</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IOSP_STATUS_IS_2BYTE</span><span class="p">(</span>
						<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxStatusCode</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* This status needs additional bytes.</span>
<span class="cm">					 * Save what we have and then wait for</span>
<span class="cm">					 * more data.</span>
<span class="cm">					 */</span>
					<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxStatusParam</span>
						<span class="o">=</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxHeader2</span><span class="p">;</span>
					<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxState</span> <span class="o">=</span> <span class="n">EXPECT_HDR3</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* We have all the header bytes, process the</span>
<span class="cm">				   status now */</span>
				<span class="n">process_rcvd_status</span><span class="p">(</span><span class="n">edge_serial</span><span class="p">,</span>
						<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxHeader2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxState</span> <span class="o">=</span> <span class="n">EXPECT_HDR1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxPort</span> <span class="o">=</span>
				    <span class="n">IOSP_GET_HDR_PORT</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxHeader1</span><span class="p">);</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxBytesRemaining</span> <span class="o">=</span>
				    <span class="n">IOSP_GET_HDR_DATA_LEN</span><span class="p">(</span>
						<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxHeader1</span><span class="p">,</span>
						<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxHeader2</span><span class="p">);</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Data for Port %u Len %u&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span>
						<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxPort</span><span class="p">,</span>
						<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxBytesRemaining</span><span class="p">);</span>

				<span class="cm">/* ASSERT(DevExt-&gt;RxPort &lt; DevExt-&gt;NumPorts);</span>
<span class="cm">				 * ASSERT(DevExt-&gt;RxBytesRemaining &lt;</span>
<span class="cm">				 *		IOSP_MAX_DATA_LENGTH);</span>
<span class="cm">				 */</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">bufferLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxState</span> <span class="o">=</span> <span class="n">EXPECT_DATA</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* Else, drop through */</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">EXPECT_DATA</span>: <span class="cm">/* Expect data */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bufferLength</span> <span class="o">&lt;</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxBytesRemaining</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rxLen</span> <span class="o">=</span> <span class="n">bufferLength</span><span class="p">;</span>
				<span class="cm">/* Expect data to start next buffer */</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxState</span> <span class="o">=</span> <span class="n">EXPECT_DATA</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* BufLen &gt;= RxBytesRemaining */</span>
				<span class="n">rxLen</span> <span class="o">=</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxBytesRemaining</span><span class="p">;</span>
				<span class="cm">/* Start another header next time */</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxState</span> <span class="o">=</span> <span class="n">EXPECT_HDR1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">bufferLength</span> <span class="o">-=</span> <span class="n">rxLen</span><span class="p">;</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxBytesRemaining</span> <span class="o">-=</span> <span class="n">rxLen</span><span class="p">;</span>

			<span class="cm">/* spit this data back into the tty driver if this</span>
<span class="cm">			   port is open */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxLen</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">port</span> <span class="o">=</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span>
							<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxPort</span><span class="p">];</span>
				<span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span>
						<span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Sending %d bytes to TTY for port %d&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">rxLen</span><span class="p">,</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxPort</span><span class="p">);</span>
						<span class="n">edge_tty_recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">rxLen</span><span class="p">);</span>
						<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span> <span class="o">+=</span> <span class="n">rxLen</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">buffer</span> <span class="o">+=</span> <span class="n">rxLen</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EXPECT_HDR3</span>:	<span class="cm">/* Expect 3rd byte of status header */</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxHeader3</span> <span class="o">=</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
			<span class="o">++</span><span class="n">buffer</span><span class="p">;</span>
			<span class="o">--</span><span class="n">bufferLength</span><span class="p">;</span>

			<span class="cm">/* We have all the header bytes, process the</span>
<span class="cm">			   status now */</span>
			<span class="n">process_rcvd_status</span><span class="p">(</span><span class="n">edge_serial</span><span class="p">,</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxStatusParam</span><span class="p">,</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxHeader3</span><span class="p">);</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxState</span> <span class="o">=</span> <span class="n">EXPECT_HDR1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * process_rcvd_status</span>
<span class="cm"> *	this function handles the any status messages received on the</span>
<span class="cm"> *	bulk in pipe.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_rcvd_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">,</span>
						<span class="n">__u8</span> <span class="n">byte2</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">byte3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">code</span> <span class="o">=</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxStatusCode</span><span class="p">;</span>

	<span class="cm">/* switch the port pointer to the one being currently talked about */</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxPort</span><span class="p">];</span>
	<span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - edge_port == NULL for port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxPort</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxPort</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">IOSP_EXT_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">byte2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IOSP_EXT_STATUS_CHASE_RSP</span>:
			<span class="cm">/* we want to do EXT status regardless of port</span>
<span class="cm">			 * open/closed */</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Port %u EXT CHASE_RSP Data = %02x&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxPort</span><span class="p">,</span> <span class="n">byte3</span><span class="p">);</span>
			<span class="cm">/* Currently, the only EXT_STATUS is Chase, so process</span>
<span class="cm">			 * here instead of one more call to one more subroutine</span>
<span class="cm">			 * If/when more EXT_STATUS, there&#39;ll be more work to do</span>
<span class="cm">			 * Also, we currently clear flag and close the port</span>
<span class="cm">			 * regardless of content of above&#39;s Byte3.</span>
<span class="cm">			 * We could choose to do something else when Byte3 says</span>
<span class="cm">			 * Timeout on Chase from Edgeport, like wait longer in</span>
<span class="cm">			 * block_until_chase_response, but for now we don&#39;t.</span>
<span class="cm">			 */</span>
			<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">chaseResponsePending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">wait_chase</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IOSP_EXT_STATUS_RX_CHECK_RSP</span>:
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s ========== Port %u CHECK_RSP Sequence = %02x =============&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxPort</span><span class="p">,</span> <span class="n">byte3</span><span class="p">);</span>
			<span class="cm">/* Port-&gt;RxCheckRsp = true; */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">IOSP_STATUS_OPEN_RSP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span> <span class="o">=</span> <span class="n">GET_TX_BUFFER_SIZE</span><span class="p">(</span><span class="n">byte3</span><span class="p">);</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">maxTxCredits</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Port %u Open Response Initial MSR = %02x TxBufferSize = %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxPort</span><span class="p">,</span> <span class="n">byte2</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">txCredits</span><span class="p">);</span>
		<span class="n">handle_new_msr</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">byte2</span><span class="p">);</span>

		<span class="cm">/* send the current line settings to the port so we are</span>
<span class="cm">		   in sync with any further termios calls */</span>
		<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">change_port_settings</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span>
				<span class="n">edge_port</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">);</span>
			<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* we have completed the open */</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">openPending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">wait_open</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If port is closed, silently discard all rcvd status. We can</span>
<span class="cm">	 * have cases where buffered status is received AFTER the close</span>
<span class="cm">	 * port command is sent to the Edgeport.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">||</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">closePending</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Not currently sent by Edgeport */</span>
	<span class="k">case</span> <span class="n">IOSP_STATUS_LSR</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Port %u LSR Status = %02x&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxPort</span><span class="p">,</span> <span class="n">byte2</span><span class="p">);</span>
		<span class="n">handle_new_lsr</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">byte2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOSP_STATUS_LSR_DATA</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Port %u LSR Status = %02x, Data = %02x&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxPort</span><span class="p">,</span> <span class="n">byte2</span><span class="p">,</span> <span class="n">byte3</span><span class="p">);</span>
		<span class="cm">/* byte2 is LSR Register */</span>
		<span class="cm">/* byte3 is broken data byte */</span>
		<span class="n">handle_new_lsr</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">byte2</span><span class="p">,</span> <span class="n">byte3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	case IOSP_EXT_4_STATUS:</span>
<span class="cm">	 *		dbg(&quot;%s - Port %u LSR Status = %02x Data = %02x&quot;,</span>
<span class="cm">	 *			__func__, edge_serial-&gt;rxPort, byte2, byte3);</span>
<span class="cm">	 *		break;</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">IOSP_STATUS_MSR</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Port %u MSR Status = %02x&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">rxPort</span><span class="p">,</span> <span class="n">byte2</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Process this new modem status and generate appropriate</span>
<span class="cm">		 * events, etc, based on the new status. This routine</span>
<span class="cm">		 * also saves the MSR in Port-&gt;ShadowMsr.</span>
<span class="cm">		 */</span>
		<span class="n">handle_new_msr</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">byte2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Unrecognized IOSP status code %u&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * edge_tty_recv</span>
<span class="cm"> *	this function passes data on to the tty flip buffer</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_tty_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">tty_insert_flip_string</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - dropping data, %d bytes lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">data</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">length</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * handle_new_msr</span>
<span class="cm"> *	this function handles any change to the msr register for a port.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_new_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">newMsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>  <span class="n">async_icount</span> <span class="o">*</span><span class="n">icount</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s %02x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">newMsr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newMsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EDGEPORT_MSR_DELTA_CTS</span> <span class="o">|</span> <span class="n">EDGEPORT_MSR_DELTA_DSR</span> <span class="o">|</span>
			<span class="n">EDGEPORT_MSR_DELTA_RI</span> <span class="o">|</span> <span class="n">EDGEPORT_MSR_DELTA_CD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>

		<span class="cm">/* update input line counters */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newMsr</span> <span class="o">&amp;</span> <span class="n">EDGEPORT_MSR_DELTA_CTS</span><span class="p">)</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newMsr</span> <span class="o">&amp;</span> <span class="n">EDGEPORT_MSR_DELTA_DSR</span><span class="p">)</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newMsr</span> <span class="o">&amp;</span> <span class="n">EDGEPORT_MSR_DELTA_CD</span><span class="p">)</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newMsr</span> <span class="o">&amp;</span> <span class="n">EDGEPORT_MSR_DELTA_RI</span><span class="p">)</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rng</span><span class="o">++</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">delta_msr_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Save the new modem status */</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowMSR</span> <span class="o">=</span> <span class="n">newMsr</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * handle_new_lsr</span>
<span class="cm"> *	this function handles any change to the lsr register for a port.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_new_lsr</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">lsrData</span><span class="p">,</span>
							<span class="n">__u8</span> <span class="n">lsr</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">newLsr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span>
		<span class="p">(</span><span class="n">LSR_OVER_ERR</span> <span class="o">|</span> <span class="n">LSR_PAR_ERR</span> <span class="o">|</span> <span class="n">LSR_FRM_ERR</span> <span class="o">|</span> <span class="n">LSR_BREAK</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="o">*</span><span class="n">icount</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - %02x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">newLsr</span><span class="p">);</span>

	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowLSR</span> <span class="o">=</span> <span class="n">lsr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newLsr</span> <span class="o">&amp;</span> <span class="n">LSR_BREAK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Parity and Framing errors only count if they</span>
<span class="cm">		 * occur exclusive of a break being</span>
<span class="cm">		 * received.</span>
<span class="cm">		 */</span>
		<span class="n">newLsr</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">LSR_OVER_ERR</span> <span class="o">|</span> <span class="n">LSR_BREAK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Place LSR data byte into Rx buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lsrData</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span>
				<span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">edge_tty_recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* update input line counters */</span>
	<span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newLsr</span> <span class="o">&amp;</span> <span class="n">LSR_BREAK</span><span class="p">)</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newLsr</span> <span class="o">&amp;</span> <span class="n">LSR_OVER_ERR</span><span class="p">)</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newLsr</span> <span class="o">&amp;</span> <span class="n">LSR_PAR_ERR</span><span class="p">)</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newLsr</span> <span class="o">&amp;</span> <span class="n">LSR_FRM_ERR</span><span class="p">)</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> * sram_write</span>
<span class="cm"> *	writes a number of bytes to the Edgeport device&#39;s sram starting at the</span>
<span class="cm"> *	given address.</span>
<span class="cm"> *	If successful returns the number of bytes written, otherwise it returns</span>
<span class="cm"> *	a negative error number of the problem.</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sram_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">extAddr</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">addr</span><span class="p">,</span>
					<span class="n">__u16</span> <span class="n">length</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">current_length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">transfer_buffer</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - %x, %x, %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">extAddr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="n">transfer_buffer</span> <span class="o">=</span>  <span class="n">kmalloc</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">transfer_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - kmalloc(%d) failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* need to split these writes up into 64 byte chunks */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span>
			<span class="n">current_length</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">current_length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

<span class="cm">/*		dbg(&quot;%s - writing %x, %x, %d&quot;, __func__,</span>
<span class="cm">					extAddr, addr, current_length); */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">transfer_buffer</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">current_length</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					<span class="n">USB_REQUEST_ION_WRITE_RAM</span><span class="p">,</span>
					<span class="mh">0x40</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">extAddr</span><span class="p">,</span> <span class="n">transfer_buffer</span><span class="p">,</span>
					<span class="n">current_length</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">current_length</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">current_length</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">current_length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">transfer_buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> * rom_write</span>
<span class="cm"> *	writes a number of bytes to the Edgeport device&#39;s ROM starting at the</span>
<span class="cm"> *	given address.</span>
<span class="cm"> *	If successful returns the number of bytes written, otherwise it returns</span>
<span class="cm"> *	a negative error number of the problem.</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rom_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">extAddr</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">addr</span><span class="p">,</span>
					<span class="n">__u16</span> <span class="n">length</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">current_length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">transfer_buffer</span><span class="p">;</span>

<span class="cm">/*	dbg(&quot;%s - %x, %x, %d&quot;, __func__, extAddr, addr, length); */</span>

	<span class="n">transfer_buffer</span> <span class="o">=</span>  <span class="n">kmalloc</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">transfer_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - kmalloc(%d) failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* need to split these writes up into 64 byte chunks */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span>
			<span class="n">current_length</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">current_length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
<span class="cm">/*		dbg(&quot;%s - writing %x, %x, %d&quot;, __func__,</span>
<span class="cm">					extAddr, addr, current_length); */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">transfer_buffer</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">current_length</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					<span class="n">USB_REQUEST_ION_WRITE_ROM</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
					<span class="n">addr</span><span class="p">,</span> <span class="n">extAddr</span><span class="p">,</span>
					<span class="n">transfer_buffer</span><span class="p">,</span> <span class="n">current_length</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">current_length</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">current_length</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">current_length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">transfer_buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> * rom_read</span>
<span class="cm"> *	reads a number of bytes from the Edgeport device starting at the given</span>
<span class="cm"> *	address.</span>
<span class="cm"> *	If successful returns the number of bytes read, otherwise it returns</span>
<span class="cm"> *	a negative error number of the problem.</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rom_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">extAddr</span><span class="p">,</span>
					<span class="n">__u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">length</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">current_length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">transfer_buffer</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - %x, %x, %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">extAddr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="n">transfer_buffer</span> <span class="o">=</span>  <span class="n">kmalloc</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">transfer_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - kmalloc(%d) failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* need to split these reads up into 64 byte chunks */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span>
			<span class="n">current_length</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">current_length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
<span class="cm">/*		dbg(&quot;%s - %x, %x, %d&quot;, __func__,</span>
<span class="cm">				extAddr, addr, current_length); */</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					<span class="n">USB_REQUEST_ION_READ_ROM</span><span class="p">,</span>
					<span class="mh">0xC0</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">extAddr</span><span class="p">,</span> <span class="n">transfer_buffer</span><span class="p">,</span>
					<span class="n">current_length</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">transfer_buffer</span><span class="p">,</span> <span class="n">current_length</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">current_length</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">current_length</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">current_length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">transfer_buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> * send_iosp_ext_cmd</span>
<span class="cm"> *	Is used to send a IOSP message to the Edgeport device</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_iosp_ext_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span>
						<span class="n">__u8</span> <span class="n">command</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="o">*</span><span class="n">currentCommand</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - %d, %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s - kmalloc(%d) failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">currentCommand</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="n">MAKE_CMD_EXT_CMD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">currentCommand</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">,</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span>
		<span class="n">command</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write_cmd_usb</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* something bad happened, let&#39;s free up the memory */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * write_cmd_usb</span>
<span class="cm"> *	this function writes the given buffer out to the bulk write endpoint.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_cmd_usb</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span> <span class="o">=</span>
				<span class="n">usb_get_serial_data</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>

	<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="cm">/* Allocate our next urb */</span>
	<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CmdUrbs</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - ALLOCATE URB %p (outstanding %d)&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CmdUrbs</span><span class="p">));</span>

	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">bulk_out_endpoint</span><span class="p">),</span>
			<span class="n">buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">edge_bulk_out_cmd_callback</span><span class="p">,</span> <span class="n">edge_port</span><span class="p">);</span>

	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">commandPending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* something went wrong */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		    <span class="s">&quot;%s - usb_submit_urb(write command) failed, status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CmdUrbs</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	wait_event(&amp;edge_port-&gt;wait_command, !edge_port-&gt;commandPending);</span>

<span class="c">	if (edge_port-&gt;commandPending) {</span>
<span class="c">		/* command timed out */</span>
<span class="c">		dbg(&quot;%s - command timed out&quot;, __func__);</span>
<span class="c">		status = -EINVAL;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * send_cmd_write_baud_rate</span>
<span class="cm"> *	this function sends the proper command to change the baud rate of the</span>
<span class="cm"> *	specified port.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_cmd_write_baud_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span>
								<span class="kt">int</span> <span class="n">baudRate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span> <span class="o">=</span>
				<span class="n">usb_get_serial_data</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmdBuffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">currCmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmdLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">divisor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">number</span> <span class="o">=</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">epic_descriptor</span><span class="p">.</span><span class="n">Supports</span><span class="p">.</span><span class="n">IOSPSetBaudRate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;SendCmdWriteBaudRate - NOT Setting baud rate for port = %d, baud = %d&quot;</span><span class="p">,</span>
		    <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">baudRate</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port = %d, baud = %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">baudRate</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">calc_baud_rate_divisor</span><span class="p">(</span><span class="n">baudRate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">divisor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - bad baud rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Alloc memory for the string of commands. */</span>
	<span class="n">cmdBuffer</span> <span class="o">=</span>  <span class="n">kmalloc</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdBuffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - kmalloc(%d) failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">currCmd</span> <span class="o">=</span> <span class="n">cmdBuffer</span><span class="p">;</span>

	<span class="cm">/* Enable access to divisor latch */</span>
	<span class="n">MAKE_CMD_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">currCmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdLen</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">LCR</span><span class="p">,</span> <span class="n">LCR_DL_ENABLE</span><span class="p">);</span>

	<span class="cm">/* Write the divisor itself */</span>
	<span class="n">MAKE_CMD_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">currCmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdLen</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">DLL</span><span class="p">,</span> <span class="n">LOW8</span><span class="p">(</span><span class="n">divisor</span><span class="p">));</span>
	<span class="n">MAKE_CMD_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">currCmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdLen</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">DLM</span><span class="p">,</span> <span class="n">HIGH8</span><span class="p">(</span><span class="n">divisor</span><span class="p">));</span>

	<span class="cm">/* Restore original value to disable access to divisor latch */</span>
	<span class="n">MAKE_CMD_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">currCmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdLen</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">LCR</span><span class="p">,</span>
						<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write_cmd_usb</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">cmdBuffer</span><span class="p">,</span> <span class="n">cmdLen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* something bad happened, let&#39;s free up the memory */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cmdBuffer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * calc_baud_rate_divisor</span>
<span class="cm"> *	this function calculates the proper baud rate divisor for the specified</span>
<span class="cm"> *	baud rate.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">calc_baud_rate_divisor</span><span class="p">(</span><span class="kt">int</span> <span class="n">baudrate</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">divisor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">custom</span><span class="p">;</span>


	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">baudrate</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">divisor_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">divisor_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BaudRate</span> <span class="o">==</span> <span class="n">baudrate</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">divisor</span> <span class="o">=</span> <span class="n">divisor_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Divisor</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* We have tried all of the standard baud rates</span>
<span class="cm">	 * lets try to calculate the divisor for this baud rate</span>
<span class="cm">	 * Make sure the baud rate is reasonable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">baudrate</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="o">&amp;&amp;</span> <span class="n">baudrate</span> <span class="o">&lt;</span> <span class="mi">230400</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* get divisor */</span>
		<span class="n">custom</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)((</span><span class="mi">230400L</span> <span class="o">+</span> <span class="n">baudrate</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">baudrate</span><span class="p">);</span>

		<span class="o">*</span><span class="n">divisor</span> <span class="o">=</span> <span class="n">custom</span><span class="p">;</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Baud %d = %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">baudrate</span><span class="p">,</span> <span class="n">custom</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * send_cmd_write_uart_register</span>
<span class="cm"> *  this function builds up a uart register message and sends to the device.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_cmd_write_uart_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span>
						<span class="n">__u8</span> <span class="n">regNum</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">regValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span> <span class="o">=</span>
				<span class="n">usb_get_serial_data</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmdBuffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">currCmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cmdLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - write to %s register 0x%02x&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">regNum</span> <span class="o">==</span> <span class="n">MCR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;MCR&quot;</span> <span class="o">:</span> <span class="s">&quot;LCR&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">regValue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">epic_descriptor</span><span class="p">.</span><span class="n">Supports</span><span class="p">.</span><span class="n">IOSPWriteMCR</span> <span class="o">&amp;&amp;</span>
	    <span class="n">regNum</span> <span class="o">==</span> <span class="n">MCR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;SendCmdWriteUartReg - Not writing to MCR Register&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">epic_descriptor</span><span class="p">.</span><span class="n">Supports</span><span class="p">.</span><span class="n">IOSPWriteLCR</span> <span class="o">&amp;&amp;</span>
	    <span class="n">regNum</span> <span class="o">==</span> <span class="n">LCR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;SendCmdWriteUartReg - Not writing to LCR Register&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Alloc memory for the string of commands. */</span>
	<span class="n">cmdBuffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmdBuffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">currCmd</span> <span class="o">=</span> <span class="n">cmdBuffer</span><span class="p">;</span>

	<span class="cm">/* Build a cmd in the buffer to write the given register */</span>
	<span class="n">MAKE_CMD_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">currCmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdLen</span><span class="p">,</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span>
		<span class="n">regNum</span><span class="p">,</span> <span class="n">regValue</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">write_cmd_usb</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">cmdBuffer</span><span class="p">,</span> <span class="n">cmdLen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* something bad happened, let&#39;s free up the memory */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cmdBuffer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * change_port_settings</span>
<span class="cm"> *	This routine is called to set the UART on the device to match the</span>
<span class="cm"> *	specified new settings.</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">change_port_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span> <span class="o">=</span>
			<span class="n">usb_get_serial_data</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">baud</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">lData</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">lParity</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">lStop</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">rxFlow</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">txFlow</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">openPending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port not opened&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS5</span>:
		<span class="n">lData</span> <span class="o">=</span> <span class="n">LCR_BITS_5</span><span class="p">;</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - data bits = 5&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS6</span>:
		<span class="n">lData</span> <span class="o">=</span> <span class="n">LCR_BITS_6</span><span class="p">;</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - data bits = 6&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>:
		<span class="n">lData</span> <span class="o">=</span> <span class="n">LCR_BITS_7</span><span class="p">;</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - data bits = 7&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">CS8</span>:
		<span class="n">lData</span> <span class="o">=</span> <span class="n">LCR_BITS_8</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - data bits = 8&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lParity</span> <span class="o">=</span> <span class="n">LCR_PAR_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CMSPAR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lParity</span> <span class="o">=</span> <span class="n">LCR_PAR_MARK</span><span class="p">;</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = mark&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">lParity</span> <span class="o">=</span> <span class="n">LCR_PAR_SPACE</span><span class="p">;</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = space&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lParity</span> <span class="o">=</span> <span class="n">LCR_PAR_ODD</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = odd&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lParity</span> <span class="o">=</span> <span class="n">LCR_PAR_EVEN</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = even&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = none&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lStop</span> <span class="o">=</span> <span class="n">LCR_STOP_2</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - stop bits = 2&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lStop</span> <span class="o">=</span> <span class="n">LCR_STOP_1</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - stop bits = 1&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* figure out the flow control settings */</span>
	<span class="n">rxFlow</span> <span class="o">=</span> <span class="n">txFlow</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxFlow</span> <span class="o">|=</span> <span class="n">IOSP_RX_FLOW_RTS</span><span class="p">;</span>
		<span class="n">txFlow</span> <span class="o">|=</span> <span class="n">IOSP_TX_FLOW_CTS</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - RTS/CTS is enabled&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - RTS/CTS is disabled&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* if we are implementing XON/XOFF, set the start and stop character</span>
<span class="cm">	   in the device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">I_IXON</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">stop_char</span>  <span class="o">=</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">start_char</span> <span class="o">=</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">epic_descriptor</span><span class="p">.</span><span class="n">Supports</span><span class="p">.</span><span class="n">IOSPSetXChar</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">send_iosp_ext_cmd</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span>
					<span class="n">IOSP_CMD_SET_XON_CHAR</span><span class="p">,</span> <span class="n">start_char</span><span class="p">);</span>
			<span class="n">send_iosp_ext_cmd</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span>
					<span class="n">IOSP_CMD_SET_XOFF_CHAR</span><span class="p">,</span> <span class="n">stop_char</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* if we are implementing INBOUND XON/XOFF */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rxFlow</span> <span class="o">|=</span> <span class="n">IOSP_RX_FLOW_XON_XOFF</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - INBOUND XON/XOFF is enabled, XON = %2x, XOFF = %2x&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">start_char</span><span class="p">,</span> <span class="n">stop_char</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - INBOUND XON/XOFF is disabled&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* if we are implementing OUTBOUND XON/XOFF */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">I_IXON</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">txFlow</span> <span class="o">|=</span> <span class="n">IOSP_TX_FLOW_XON_XOFF</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - OUTBOUND XON/XOFF is enabled, XON = %2x, XOFF = %2x&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">start_char</span><span class="p">,</span> <span class="n">stop_char</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - OUTBOUND XON/XOFF is disabled&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set flow control to the configured value */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">epic_descriptor</span><span class="p">.</span><span class="n">Supports</span><span class="p">.</span><span class="n">IOSPSetRxFlow</span><span class="p">)))</span>
		<span class="n">send_iosp_ext_cmd</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">IOSP_CMD_SET_RX_FLOW</span><span class="p">,</span> <span class="n">rxFlow</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">epic_descriptor</span><span class="p">.</span><span class="n">Supports</span><span class="p">.</span><span class="n">IOSPSetTxFlow</span><span class="p">)))</span>
		<span class="n">send_iosp_ext_cmd</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">IOSP_CMD_SET_TX_FLOW</span><span class="p">,</span> <span class="n">txFlow</span><span class="p">);</span>


	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LCR_BITS_MASK</span> <span class="o">|</span> <span class="n">LCR_STOP_MASK</span> <span class="o">|</span> <span class="n">LCR_PAR_MASK</span><span class="p">);</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span> <span class="o">|=</span> <span class="p">(</span><span class="n">lData</span> <span class="o">|</span> <span class="n">lParity</span> <span class="o">|</span> <span class="n">lStop</span><span class="p">);</span>

	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">validDataMask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* Send the updated LCR value to the EdgePort */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">send_cmd_write_uart_register</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">LCR</span><span class="p">,</span>
							<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* set up the MCR register and send it to the EdgePort */</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">=</span> <span class="n">MCR_MASTER_IE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MCR_DTR</span> <span class="o">|</span> <span class="n">MCR_RTS</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">send_cmd_write_uart_register</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">MCR</span><span class="p">,</span>
						<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Determine divisor based on baud rate */</span>
	<span class="n">baud</span> <span class="o">=</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">baud</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* pick a default, any default... */</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - baud rate = %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">send_cmd_write_baud_rate</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Speed change was not possible - put back the old speed */</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="n">tty_termios_baud_rate</span><span class="p">(</span><span class="n">old_termios</span><span class="p">);</span>
		<span class="n">tty_encode_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> * unicode_to_ascii</span>
<span class="cm"> *	Turns a string from Unicode into ASCII.</span>
<span class="cm"> *	Doesn&#39;t do a good job with any characters that are outside the normal</span>
<span class="cm"> *	ASCII range, but it&#39;s only for debugging...</span>
<span class="cm"> *	NOTE: expects the unicode in LE format</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">unicode_to_ascii</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span>
					<span class="n">__le16</span> <span class="o">*</span><span class="n">unicode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unicode_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* never happens, but... */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="o">--</span><span class="n">buflen</span><span class="p">;</span>		<span class="cm">/* space for nul */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">unicode_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">buflen</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">unicode</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> * get_manufacturing_desc</span>
<span class="cm"> *	reads in the manufacturing descriptor and stores it into the serial</span>
<span class="cm"> *	structure.</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_manufacturing_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">response</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;getting manufacturer descriptor&quot;</span><span class="p">);</span>

	<span class="n">response</span> <span class="o">=</span> <span class="n">rom_read</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span>
				<span class="p">(</span><span class="n">EDGE_MANUF_DESC_ADDR</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
				<span class="p">(</span><span class="n">__u16</span><span class="p">)(</span><span class="n">EDGE_MANUF_DESC_ADDR</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">),</span>
				<span class="n">EDGE_MANUF_DESC_LEN</span><span class="p">,</span>
				<span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;error in getting manufacturer descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">string</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;**Manufacturer Descriptor&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  RomSize:        %dK&quot;</span><span class="p">,</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">RomSize</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  RamSize:        %dK&quot;</span><span class="p">,</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">RamSize</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  CpuRev:         %d&quot;</span><span class="p">,</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">CpuRev</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  BoardRev:       %d&quot;</span><span class="p">,</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">BoardRev</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  NumPorts:       %d&quot;</span><span class="p">,</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">NumPorts</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  DescDate:       %d/%d/%d&quot;</span><span class="p">,</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">DescDate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">DescDate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">DescDate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1900</span><span class="p">);</span>
		<span class="n">unicode_to_ascii</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">string</span><span class="p">),</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">SerialNumber</span><span class="p">,</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">SerNumLength</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  SerialNumber: %s&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>
		<span class="n">unicode_to_ascii</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">string</span><span class="p">),</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">AssemblyNumber</span><span class="p">,</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">AssemblyNumLength</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  AssemblyNumber: %s&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>
		<span class="n">unicode_to_ascii</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">string</span><span class="p">),</span>
		    <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">OemAssyNumber</span><span class="p">,</span>
		    <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">OemAssyNumLength</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  OemAssyNumber:  %s&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  UartType:       %d&quot;</span><span class="p">,</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">UartType</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  IonPid:         %d&quot;</span><span class="p">,</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">IonPid</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  IonConfig:      %d&quot;</span><span class="p">,</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">manuf_descriptor</span><span class="p">.</span><span class="n">IonConfig</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> * get_boot_desc</span>
<span class="cm"> *	reads in the bootloader descriptor and stores it into the serial</span>
<span class="cm"> *	structure.</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_boot_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">response</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;getting boot descriptor&quot;</span><span class="p">);</span>

	<span class="n">response</span> <span class="o">=</span> <span class="n">rom_read</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span>
				<span class="p">(</span><span class="n">EDGE_BOOT_DESC_ADDR</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
				<span class="p">(</span><span class="n">__u16</span><span class="p">)(</span><span class="n">EDGE_BOOT_DESC_ADDR</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">),</span>
				<span class="n">EDGE_BOOT_DESC_LEN</span><span class="p">,</span>
				<span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;error in getting boot descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;**Boot Descriptor:&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  BootCodeLength: %d&quot;</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">BootCodeLength</span><span class="p">));</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  MajorVersion:   %d&quot;</span><span class="p">,</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">MajorVersion</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  MinorVersion:   %d&quot;</span><span class="p">,</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">MinorVersion</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  BuildNumber:    %d&quot;</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">BuildNumber</span><span class="p">));</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  Capabilities:   0x%x&quot;</span><span class="p">,</span>
		      <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">Capabilities</span><span class="p">));</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  UConfig0:       %d&quot;</span><span class="p">,</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">UConfig0</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  UConfig1:       %d&quot;</span><span class="p">,</span>
			<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">boot_descriptor</span><span class="p">.</span><span class="n">UConfig1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> * load_application_firmware</span>
<span class="cm"> *	This is called to load the application firmware to the device</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">load_application_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ihex_binrec</span> <span class="o">*</span><span class="n">rec</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">response</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">Operaddr</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">build</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">iDownloadFile</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">EDGE_DOWNLOAD_FILE_I930</span>:
			<span class="n">fw_info</span> <span class="o">=</span> <span class="s">&quot;downloading firmware version (930)&quot;</span><span class="p">;</span>
			<span class="n">fw_name</span>	<span class="o">=</span> <span class="s">&quot;edgeport/down.fw&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EDGE_DOWNLOAD_FILE_80251</span>:
			<span class="n">fw_info</span> <span class="o">=</span> <span class="s">&quot;downloading firmware version (80251)&quot;</span><span class="p">;</span>
			<span class="n">fw_name</span>	<span class="o">=</span> <span class="s">&quot;edgeport/down2.fw&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EDGE_DOWNLOAD_FILE_NONE</span>:
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;No download file specified, skipping download&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">response</span> <span class="o">=</span> <span class="n">request_ihex_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to load image </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fw_name</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rec</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ihex_binrec</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">build</span> <span class="o">=</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s %d.%d.%d&quot;</span><span class="p">,</span> <span class="n">fw_info</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">build</span><span class="p">);</span>

	<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">FirmwareMajorVersion</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">FirmwareMinorVersion</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">FirmwareBuildNumber</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">build</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rec</span> <span class="o">=</span> <span class="n">ihex_next_binrec</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span> <span class="n">rec</span><span class="p">;</span>
	     <span class="n">rec</span> <span class="o">=</span> <span class="n">ihex_next_binrec</span><span class="p">(</span><span class="n">rec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">Operaddr</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">response</span> <span class="o">=</span> <span class="n">sram_write</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span>
				     <span class="n">Operaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
				     <span class="n">Operaddr</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">,</span>
				     <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
				     <span class="o">&amp;</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;sram_write failed (%x, %x, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">Operaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">Operaddr</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">,</span>
				<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;sending exec_dl_code&quot;</span><span class="p">);</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">usb_control_msg</span> <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> 
				    <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
				    <span class="n">USB_REQUEST_ION_EXEC_DL_CODE</span><span class="p">,</span> 
				    <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3000</span><span class="p">);</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> * edge_startup</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">response</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">interrupt_in_found</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bulk_in_found</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bulk_out_found</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">__u32</span> <span class="n">descriptor</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>	<span class="n">EDGE_COMPATIBILITY_MASK0</span><span class="p">,</span>
					<span class="n">EDGE_COMPATIBILITY_MASK1</span><span class="p">,</span>
					<span class="n">EDGE_COMPATIBILITY_MASK2</span> <span class="p">};</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* create our private serial structure */</span>
	<span class="n">edge_serial</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_serial</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">es_lock</span><span class="p">);</span>
	<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">=</span> <span class="n">serial</span><span class="p">;</span>
	<span class="n">usb_set_serial_data</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">edge_serial</span><span class="p">);</span>

	<span class="cm">/* get the name for the device from the device */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">usb_string</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">iManufacturer</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MAX_NAME_LEN</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	<span class="n">usb_string</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">iProduct</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">MAX_NAME_LEN</span><span class="o">+</span><span class="mi">2</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Read the epic descriptor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_epic_descriptor</span><span class="p">(</span><span class="n">edge_serial</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* memcpy descriptor to Supports structures */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">epic_descriptor</span><span class="p">.</span><span class="n">Supports</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">edge_compatibility_bits</span><span class="p">));</span>

		<span class="cm">/* get the manufacturing descriptor for this device */</span>
		<span class="n">get_manufacturing_desc</span><span class="p">(</span><span class="n">edge_serial</span><span class="p">);</span>

		<span class="cm">/* get the boot descriptor */</span>
		<span class="n">get_boot_desc</span><span class="p">(</span><span class="n">edge_serial</span><span class="p">);</span>

		<span class="n">get_product_info</span><span class="p">(</span><span class="n">edge_serial</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set the number of ports from the manufacturing description */</span>
	<span class="cm">/* serial-&gt;num_ports = serial-&gt;product_info.NumPorts; */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">NumPorts</span> <span class="o">!=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device Reported %d serial ports &quot;</span>
			 <span class="s">&quot;vs. core thinking we have %d ports, email &quot;</span>
			 <span class="s">&quot;greg@kroah.com this information.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">NumPorts</span><span class="p">,</span>
			 <span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - time 1 %ld&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="cm">/* If not an EPiC device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* now load the application firmware into this device */</span>
		<span class="n">load_application_firmware</span><span class="p">(</span><span class="n">edge_serial</span><span class="p">);</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - time 2 %ld&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

		<span class="cm">/* Check current Edgeport EEPROM and update if necessary */</span>
		<span class="n">update_edgeport_E2PROM</span><span class="p">(</span><span class="n">edge_serial</span><span class="p">);</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - time 3 %ld&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

		<span class="cm">/* set the configuration to use #1 */</span>
<span class="cm">/*		dbg(&quot;set_configuration 1&quot;); */</span>
<span class="cm">/*		usb_set_configuration (dev, 1); */</span>
	<span class="p">}</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;  FirmwareMajorVersion  %d.%d.%d&quot;</span><span class="p">,</span>
	    <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">FirmwareMajorVersion</span><span class="p">,</span>
	    <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">FirmwareMinorVersion</span><span class="p">,</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">FirmwareBuildNumber</span><span class="p">));</span>

	<span class="cm">/* we set up the pointers to the endpoints in the edge_open function,</span>
<span class="cm">	 * as the structures aren&#39;t created yet. */</span>

	<span class="cm">/* set up our port private structures */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">edge_port</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								   <span class="n">__func__</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">j</span><span class="p">]));</span>
				<span class="n">usb_set_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
									<span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">usb_set_serial_data</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">edge_serial</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">);</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">usb_set_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">edge_port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">response</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* EPIC thing, set up our interrupt polling now and our read</span>
<span class="cm">		 * urb, so that the device knows it really is connected. */</span>
		<span class="n">interrupt_in_found</span> <span class="o">=</span> <span class="n">bulk_in_found</span> <span class="o">=</span> <span class="n">bulk_out_found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
						<span class="p">.</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">buffer_size</span><span class="p">;</span>

			<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span>
							<span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>
			<span class="n">buffer_size</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">endpoint</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interrupt_in_found</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">usb_endpoint_is_int_in</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)))</span> <span class="p">{</span>
				<span class="cm">/* we found a interrupt in endpoint */</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;found interrupt in&quot;</span><span class="p">);</span>

				<span class="cm">/* not set up yet, so do it now */</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_read_urb</span> <span class="o">=</span>
						<span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_read_urb</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_in_buffer</span> <span class="o">=</span>
					<span class="n">kmalloc</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_in_buffer</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_read_urb</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_in_endpoint</span> <span class="o">=</span>
						<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">;</span>

				<span class="cm">/* set up our interrupt urb */</span>
				<span class="n">usb_fill_int_urb</span><span class="p">(</span>
					<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_read_urb</span><span class="p">,</span>
					<span class="n">dev</span><span class="p">,</span>
					<span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">),</span>
					<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_in_buffer</span><span class="p">,</span>
					<span class="n">buffer_size</span><span class="p">,</span>
					<span class="n">edge_interrupt_callback</span><span class="p">,</span>
					<span class="n">edge_serial</span><span class="p">,</span>
					<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>

				<span class="n">interrupt_in_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bulk_in_found</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">usb_endpoint_is_bulk_in</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)))</span> <span class="p">{</span>
				<span class="cm">/* we found a bulk in endpoint */</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;found bulk in&quot;</span><span class="p">);</span>

				<span class="cm">/* not set up yet, so do it now */</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_urb</span> <span class="o">=</span>
						<span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">bulk_in_buffer</span> <span class="o">=</span>
					<span class="n">kmalloc</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">bulk_in_buffer</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">bulk_in_endpoint</span> <span class="o">=</span>
						<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">;</span>

				<span class="cm">/* set up our bulk in urb */</span>
				<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
					<span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">),</span>
					<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">bulk_in_buffer</span><span class="p">,</span>
					<span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">endpoint</span><span class="p">),</span>
					<span class="n">edge_bulk_in_callback</span><span class="p">,</span>
					<span class="n">edge_serial</span><span class="p">);</span>
				<span class="n">bulk_in_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bulk_out_found</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">usb_endpoint_is_bulk_out</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)))</span> <span class="p">{</span>
				<span class="cm">/* we found a bulk out endpoint */</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;found bulk out&quot;</span><span class="p">);</span>
				<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">bulk_out_endpoint</span> <span class="o">=</span>
						<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">;</span>
				<span class="n">bulk_out_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interrupt_in_found</span> <span class="o">||</span> <span class="o">!</span><span class="n">bulk_in_found</span> <span class="o">||</span> <span class="o">!</span><span class="n">bulk_out_found</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error - the proper endpoints &quot;</span>
				<span class="s">&quot;were not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* start interrupt read for this edgeport this interrupt will</span>
<span class="cm">		 * continue as long as the edgeport is connected */</span>
		<span class="n">response</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_read_urb</span><span class="p">,</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s - Error %d submitting control urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">response</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> * edge_disconnect</span>
<span class="cm"> *	This function is called whenever the device is removed from the usb bus.</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span> <span class="o">=</span> <span class="n">usb_get_serial_data</span><span class="p">(</span><span class="n">serial</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* stop reads and writes on all ports */</span>
	<span class="cm">/* free up our endpoint stuff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">is_epic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_read_urb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_read_urb</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">interrupt_in_buffer</span><span class="p">);</span>

		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">bulk_in_buffer</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> * edge_release</span>
<span class="cm"> *	This function is called when the device structure is deallocated.</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span> <span class="o">=</span> <span class="n">usb_get_serial_data</span><span class="p">(</span><span class="n">serial</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">edge_serial</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_usb_serial_driver</span><span class="p">(</span><span class="n">serial_drivers</span><span class="p">,</span> <span class="n">id_table_combined</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;edgeport/boot.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;edgeport/boot2.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;edgeport/down.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;edgeport/down2.fw&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug enabled or not&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
