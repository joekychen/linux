<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › serial › cp210x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cp210x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Silicon Laboratories CP210x USB to RS232 serial adaptor driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005 Craig Shelley (craig@microtron.org.uk)</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License version</span>
<span class="cm"> *	2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Support to set flow control line levels using TIOCMGET and TIOCMSET</span>
<span class="cm"> * thanks to Karl Hiramoto karl@hiramoto.org. RTSCTS hardware flow</span>
<span class="cm"> * control thanks to Munir Nassar nassarmu@real-time.com</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/usb/serial.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Version Information</span>
<span class="cm"> */</span>
<span class="cp">#define DRIVER_VERSION &quot;v0.09&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;Silicon Labs CP210x RS232 serial adaptor driver&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Function Prototypes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cp210x_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cp210x_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cp210x_get_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cp210x_get_termios_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cflagp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">baudp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cp210x_change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cp210x_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">ktermios</span><span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cp210x_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cp210x_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cp210x_tiocmset_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cp210x_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cp210x_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cp210x_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cp210x_dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x045B</span><span class="p">,</span> <span class="mh">0x0053</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Renesas RX610 RX-Stick */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0471</span><span class="p">,</span> <span class="mh">0x066A</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* AKTAKOM ACE-1001 cable */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0489</span><span class="p">,</span> <span class="mh">0xE000</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Pirelli Broadband S.p.A, DP-L10 SIP/GSM Mobile */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0489</span><span class="p">,</span> <span class="mh">0xE003</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Pirelli Broadband S.p.A, DP-L10 SIP/GSM Mobile */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0745</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* CipherLab USB CCD Barcode Scanner 1000 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x08e6</span><span class="p">,</span> <span class="mh">0x5501</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Gemalto Prox-PU/CU contactless smartcard reader */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x08FD</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Digianswer A/S , ZigBee/802.15.4 MAC Device */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0BED</span><span class="p">,</span> <span class="mh">0x1100</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* MEI (TM) Cashflow-SC Bill/Voucher Acceptor */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0BED</span><span class="p">,</span> <span class="mh">0x1101</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* MEI series 2000 Combo Acceptor */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0FCF</span><span class="p">,</span> <span class="mh">0x1003</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Dynastream ANT development board */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0FCF</span><span class="p">,</span> <span class="mh">0x1004</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Dynastream ANT2USB */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0FCF</span><span class="p">,</span> <span class="mh">0x1006</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Dynastream ANT development board */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10A6</span><span class="p">,</span> <span class="mh">0xAA26</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Knock-off DCU-11 cable */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10AB</span><span class="p">,</span> <span class="mh">0x10C5</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Siemens MC60 Cable */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10B5</span><span class="p">,</span> <span class="mh">0xAC70</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Nokia CA-42 USB */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x0F91</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Vstabi */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x1101</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Arkham Technology DS101 Bus Monitor */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x1601</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Arkham Technology DS101 Adapter */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x800A</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* SPORTident BSM7-D-USB main station */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x803B</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Pololu USB-serial converter */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x8044</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Cygnal Debug Adapter */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x804E</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Software Bisque Paramount ME build-in converter */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x8053</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Enfora EDG1228 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x8054</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Enfora GSM2228 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x8066</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Argussoft In-System Programmer */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x806F</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* IMS USB to RS422 Converter Cable */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x807A</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Crumb128 board */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x80C4</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Cygnal Integrated Products, Inc., Optris infrared thermometer */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x80CA</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Degree Controls Inc */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x80DD</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Tracient RFID */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x80F6</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Suunto sports instrument */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x8115</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Arygon NFC/Mifare Reader */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x813D</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Burnside Telecom Deskmobile */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x813F</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Tams Master Easy Control */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x814A</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* West Mountain Radio RIGblaster P&amp;P */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x814B</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* West Mountain Radio RIGtalk */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x8156</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* B&amp;G H3000 link cable */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x815E</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Helicomm IP-Link 1220-DVM */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x815F</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Timewave HamLinkUSB */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x818B</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* AVIT Research USB to TTL */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x819F</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* MJS USB Toslink Switcher */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x81A6</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* ThinkOptics WavIt */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x81A9</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Multiplex RC Interface */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x81AC</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* MSD Dash Hawk */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x81AD</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* INSYS USB Modem */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x81C8</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Lipowsky Industrie Elektronik GmbH, Baby-JTAG */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x81E2</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Lipowsky Industrie Elektronik GmbH, Baby-LIN */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x81E7</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Aerocomm Radio */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x81E8</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Zephyr Bioharness */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x81F2</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* C1007 HF band RFID controller */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x8218</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Lipowsky Industrie Elektronik GmbH, HARP-1 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x822B</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Modem EDGE(GSM) Comander 2 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x826B</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Cygnal Integrated Products, Inc., Fasttrax GPS demonstration module */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x8293</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Telegesis ETRX2USB */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x82F9</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Procyon AVS */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x8341</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Siemens MC35PU GPRS Modem */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x8382</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Cygnal Integrated Products, Inc. */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x83A8</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Amber Wireless AMB2560 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x83D8</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* DekTec DTA Plus VHF/UHF Booster/Attenuator */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x8411</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Kyocera GPS Module */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x8418</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* IRZ Automation Teleport SG-10 GSM/GPRS Modem */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x846E</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* BEI USB Sensor Interface (VCP) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x8477</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Balluff RFID */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x85EA</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* AC-Services IBUS-IF */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x85EB</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* AC-Services CIS-IBUS */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x8664</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* AC-Services CAN-IF */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0x8665</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* AC-Services OBD-IF */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0xEA60</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Silicon Labs factory default */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0xEA61</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Silicon Labs factory default */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0xEA70</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Silicon Labs factory default */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0xEA80</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Silicon Labs factory default */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0xEA71</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Infinity GPS-MIC-1 Radio Monophone */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0xF001</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Elan Digital Systems USBscope50 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0xF002</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Elan Digital Systems USBwave12 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0xF003</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Elan Digital Systems USBpulse100 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C4</span><span class="p">,</span> <span class="mh">0xF004</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Elan Digital Systems USBcount50 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10C5</span><span class="p">,</span> <span class="mh">0xEA61</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Silicon Labs MobiData GPRS USB Modem */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x10CE</span><span class="p">,</span> <span class="mh">0xEA6A</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Silicon Labs MobiData GPRS USB Modem 100EU */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x13AD</span><span class="p">,</span> <span class="mh">0x9999</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Baltech card reader */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1555</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Owen AC4 USB-RS485 Converter */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x166A</span><span class="p">,</span> <span class="mh">0x0201</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Clipsal 5500PACA C-Bus Pascal Automation Controller */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x166A</span><span class="p">,</span> <span class="mh">0x0301</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Clipsal 5800PC C-Bus Wireless PC Interface */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x166A</span><span class="p">,</span> <span class="mh">0x0303</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Clipsal 5500PCU C-Bus USB interface */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x166A</span><span class="p">,</span> <span class="mh">0x0304</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Clipsal 5000CT2 C-Bus Black and White Touchscreen */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x166A</span><span class="p">,</span> <span class="mh">0x0305</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Clipsal C-5000CT2 C-Bus Spectrum Colour Touchscreen */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x166A</span><span class="p">,</span> <span class="mh">0x0401</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Clipsal L51xx C-Bus Architectural Dimmer */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x166A</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Clipsal 5560884 C-Bus Multi-room Audio Matrix Switcher */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x16D6</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Jablotron serial interface */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x16DC</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* W-IE-NE-R Plein &amp; Baus GmbH PL512 Power Supply */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x16DC</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* W-IE-NE-R Plein &amp; Baus GmbH RCM Remote Control for MARATON Power Supply */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x16DC</span><span class="p">,</span> <span class="mh">0x0012</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* W-IE-NE-R Plein &amp; Baus GmbH MPOD Multi Channel Power Supply */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x16DC</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* W-IE-NE-R Plein &amp; Baus GmbH CML Control, Monitoring and Data Logger */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x17A8</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Kamstrup Optical Eye/3-wire */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x17A8</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Kamstrup M-Bus Master MultiPort 250D */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x17F4</span><span class="p">,</span> <span class="mh">0xAAAA</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Wavesense Jazz blood glucose meter */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1843</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Vaisala USB Instrument Cable */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x18EF</span><span class="p">,</span> <span class="mh">0xE00F</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* ELV USB-I2C-Interface */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1BE3</span><span class="p">,</span> <span class="mh">0x07A6</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* WAGO 750-923 USB Service Cable */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1E29</span><span class="p">,</span> <span class="mh">0x0102</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Festo CPX-USB */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1E29</span><span class="p">,</span> <span class="mh">0x0501</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Festo CMSP */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x3195</span><span class="p">,</span> <span class="mh">0xF190</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Link Instruments MSO-19 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x3195</span><span class="p">,</span> <span class="mh">0xF280</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Link Instruments MSO-28 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x3195</span><span class="p">,</span> <span class="mh">0xF281</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Link Instruments MSO-28 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x413C</span><span class="p">,</span> <span class="mh">0x9500</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* DW700 GPS USB interface */</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* Terminating Entry */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">cp210x_port_private</span> <span class="p">{</span>
	<span class="n">__u8</span>			<span class="n">bInterfaceNumber</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="n">cp210x_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> 	<span class="s">&quot;cp210x&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">id_table</span>		<span class="o">=</span> <span class="n">id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_ports</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bulk_in_size</span>		<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bulk_out_size</span>		<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">cp210x_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>			<span class="o">=</span> <span class="n">cp210x_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span>		<span class="o">=</span> <span class="n">cp210x_break_ctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span>		<span class="o">=</span> <span class="n">cp210x_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> 		<span class="o">=</span> <span class="n">cp210x_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span>		<span class="o">=</span> <span class="n">cp210x_tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>			<span class="o">=</span> <span class="n">cp210x_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">cp210x_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dtr_rts</span>		<span class="o">=</span> <span class="n">cp210x_dtr_rts</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="o">*</span> <span class="k">const</span> <span class="n">serial_drivers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">cp210x_device</span><span class="p">,</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="cm">/* Config request types */</span>
<span class="cp">#define REQTYPE_HOST_TO_INTERFACE	0x41</span>
<span class="cp">#define REQTYPE_INTERFACE_TO_HOST	0xc1</span>
<span class="cp">#define REQTYPE_HOST_TO_DEVICE	0x40</span>
<span class="cp">#define REQTYPE_DEVICE_TO_HOST	0xc0</span>

<span class="cm">/* Config request codes */</span>
<span class="cp">#define CP210X_IFC_ENABLE	0x00</span>
<span class="cp">#define CP210X_SET_BAUDDIV	0x01</span>
<span class="cp">#define CP210X_GET_BAUDDIV	0x02</span>
<span class="cp">#define CP210X_SET_LINE_CTL	0x03</span>
<span class="cp">#define CP210X_GET_LINE_CTL	0x04</span>
<span class="cp">#define CP210X_SET_BREAK	0x05</span>
<span class="cp">#define CP210X_IMM_CHAR		0x06</span>
<span class="cp">#define CP210X_SET_MHS		0x07</span>
<span class="cp">#define CP210X_GET_MDMSTS	0x08</span>
<span class="cp">#define CP210X_SET_XON		0x09</span>
<span class="cp">#define CP210X_SET_XOFF		0x0A</span>
<span class="cp">#define CP210X_SET_EVENTMASK	0x0B</span>
<span class="cp">#define CP210X_GET_EVENTMASK	0x0C</span>
<span class="cp">#define CP210X_SET_CHAR		0x0D</span>
<span class="cp">#define CP210X_GET_CHARS	0x0E</span>
<span class="cp">#define CP210X_GET_PROPS	0x0F</span>
<span class="cp">#define CP210X_GET_COMM_STATUS	0x10</span>
<span class="cp">#define CP210X_RESET		0x11</span>
<span class="cp">#define CP210X_PURGE		0x12</span>
<span class="cp">#define CP210X_SET_FLOW		0x13</span>
<span class="cp">#define CP210X_GET_FLOW		0x14</span>
<span class="cp">#define CP210X_EMBED_EVENTS	0x15</span>
<span class="cp">#define CP210X_GET_EVENTSTATE	0x16</span>
<span class="cp">#define CP210X_SET_CHARS	0x19</span>
<span class="cp">#define CP210X_GET_BAUDRATE	0x1D</span>
<span class="cp">#define CP210X_SET_BAUDRATE	0x1E</span>

<span class="cm">/* CP210X_IFC_ENABLE */</span>
<span class="cp">#define UART_ENABLE		0x0001</span>
<span class="cp">#define UART_DISABLE		0x0000</span>

<span class="cm">/* CP210X_(SET|GET)_BAUDDIV */</span>
<span class="cp">#define BAUD_RATE_GEN_FREQ	0x384000</span>

<span class="cm">/* CP210X_(SET|GET)_LINE_CTL */</span>
<span class="cp">#define BITS_DATA_MASK		0X0f00</span>
<span class="cp">#define BITS_DATA_5		0X0500</span>
<span class="cp">#define BITS_DATA_6		0X0600</span>
<span class="cp">#define BITS_DATA_7		0X0700</span>
<span class="cp">#define BITS_DATA_8		0X0800</span>
<span class="cp">#define BITS_DATA_9		0X0900</span>

<span class="cp">#define BITS_PARITY_MASK	0x00f0</span>
<span class="cp">#define BITS_PARITY_NONE	0x0000</span>
<span class="cp">#define BITS_PARITY_ODD		0x0010</span>
<span class="cp">#define BITS_PARITY_EVEN	0x0020</span>
<span class="cp">#define BITS_PARITY_MARK	0x0030</span>
<span class="cp">#define BITS_PARITY_SPACE	0x0040</span>

<span class="cp">#define BITS_STOP_MASK		0x000f</span>
<span class="cp">#define BITS_STOP_1		0x0000</span>
<span class="cp">#define BITS_STOP_1_5		0x0001</span>
<span class="cp">#define BITS_STOP_2		0x0002</span>

<span class="cm">/* CP210X_SET_BREAK */</span>
<span class="cp">#define BREAK_ON		0x0001</span>
<span class="cp">#define BREAK_OFF		0x0000</span>

<span class="cm">/* CP210X_(SET_MHS|GET_MDMSTS) */</span>
<span class="cp">#define CONTROL_DTR		0x0001</span>
<span class="cp">#define CONTROL_RTS		0x0002</span>
<span class="cp">#define CONTROL_CTS		0x0010</span>
<span class="cp">#define CONTROL_DSR		0x0020</span>
<span class="cp">#define CONTROL_RING		0x0040</span>
<span class="cp">#define CONTROL_DCD		0x0080</span>
<span class="cp">#define CONTROL_WRITE_DTR	0x0100</span>
<span class="cp">#define CONTROL_WRITE_RTS	0x0200</span>

<span class="cm">/*</span>
<span class="cm"> * cp210x_get_config</span>
<span class="cm"> * Reads from the CP210x configuration registers</span>
<span class="cm"> * &#39;size&#39; is specified in bytes.</span>
<span class="cm"> * &#39;data&#39; is a pointer to a pre-allocated array of integers large</span>
<span class="cm"> * enough to hold &#39;size&#39; bytes (with 4 bytes to each integer)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cp210x_get_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">request</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cp210x_port_private</span> <span class="o">*</span><span class="n">port_priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">length</span><span class="p">;</span>

	<span class="cm">/* Number of integers required to contain the array */</span>
	<span class="n">length</span> <span class="o">=</span> <span class="p">(((</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le32</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Issue the request, attempting to read &#39;size&#39; bytes */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">request</span><span class="p">,</span> <span class="n">REQTYPE_INTERFACE_TO_HOST</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
				<span class="n">port_priv</span><span class="o">-&gt;</span><span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				<span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>

	<span class="cm">/* Convert data into an array of integers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Unable to send config request, &quot;</span>
				<span class="s">&quot;request=0x%x size=%d result=%d&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * cp210x_set_config</span>
<span class="cm"> * Writes to the CP210x configuration registers</span>
<span class="cm"> * Values less than 16 bits wide are sent directly</span>
<span class="cm"> * &#39;size&#39; is specified in bytes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cp210x_set_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">request</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cp210x_port_private</span> <span class="o">*</span><span class="n">port_priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">length</span><span class="p">;</span>

	<span class="cm">/* Number of integers required to contain the array */</span>
	<span class="n">length</span> <span class="o">=</span> <span class="p">(((</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">length</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le32</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Array of integers into bytes */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">request</span><span class="p">,</span> <span class="n">REQTYPE_HOST_TO_INTERFACE</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
				<span class="n">port_priv</span><span class="o">-&gt;</span><span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				<span class="n">USB_CTRL_SET_TIMEOUT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">request</span><span class="p">,</span> <span class="n">REQTYPE_HOST_TO_INTERFACE</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">port_priv</span><span class="o">-&gt;</span><span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">USB_CTRL_SET_TIMEOUT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span> <span class="o">||</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Unable to send request, &quot;</span>
				<span class="s">&quot;request=0x%x size=%d result=%d&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * cp210x_set_config_single</span>
<span class="cm"> * Convenience function for calling cp210x_set_config on single data values</span>
<span class="cm"> * without requiring an integer pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">cp210x_set_config_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">request</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cp210x_set_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * cp210x_quantise_baudrate</span>
<span class="cm"> * Quantises the baud rate as per AN205 Table 1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">cp210x_quantise_baudrate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">300</span><span class="p">)</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">600</span><span class="p">)</span>      <span class="n">baud</span> <span class="o">=</span> <span class="mi">600</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">1200</span><span class="p">)</span>     <span class="n">baud</span> <span class="o">=</span> <span class="mi">1200</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">1800</span><span class="p">)</span>     <span class="n">baud</span> <span class="o">=</span> <span class="mi">1800</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">2400</span><span class="p">)</span>     <span class="n">baud</span> <span class="o">=</span> <span class="mi">2400</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">4000</span><span class="p">)</span>     <span class="n">baud</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">4803</span><span class="p">)</span>     <span class="n">baud</span> <span class="o">=</span> <span class="mi">4800</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">7207</span><span class="p">)</span>     <span class="n">baud</span> <span class="o">=</span> <span class="mi">7200</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">9612</span><span class="p">)</span>     <span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">14428</span><span class="p">)</span>    <span class="n">baud</span> <span class="o">=</span> <span class="mi">14400</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">16062</span><span class="p">)</span>    <span class="n">baud</span> <span class="o">=</span> <span class="mi">16000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">19250</span><span class="p">)</span>    <span class="n">baud</span> <span class="o">=</span> <span class="mi">19200</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">28912</span><span class="p">)</span>    <span class="n">baud</span> <span class="o">=</span> <span class="mi">28800</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">38601</span><span class="p">)</span>    <span class="n">baud</span> <span class="o">=</span> <span class="mi">38400</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">51558</span><span class="p">)</span>    <span class="n">baud</span> <span class="o">=</span> <span class="mi">51200</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">56280</span><span class="p">)</span>    <span class="n">baud</span> <span class="o">=</span> <span class="mi">56000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">58053</span><span class="p">)</span>    <span class="n">baud</span> <span class="o">=</span> <span class="mi">57600</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">64111</span><span class="p">)</span>    <span class="n">baud</span> <span class="o">=</span> <span class="mi">64000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">77608</span><span class="p">)</span>    <span class="n">baud</span> <span class="o">=</span> <span class="mi">76800</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">117028</span><span class="p">)</span>   <span class="n">baud</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">129347</span><span class="p">)</span>   <span class="n">baud</span> <span class="o">=</span> <span class="mi">128000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">156868</span><span class="p">)</span>   <span class="n">baud</span> <span class="o">=</span> <span class="mi">153600</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">237832</span><span class="p">)</span>   <span class="n">baud</span> <span class="o">=</span> <span class="mi">230400</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">254234</span><span class="p">)</span>   <span class="n">baud</span> <span class="o">=</span> <span class="mi">250000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">273066</span><span class="p">)</span>   <span class="n">baud</span> <span class="o">=</span> <span class="mi">256000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">491520</span><span class="p">)</span>   <span class="n">baud</span> <span class="o">=</span> <span class="mi">460800</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">567138</span><span class="p">)</span>   <span class="n">baud</span> <span class="o">=</span> <span class="mi">500000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">670254</span><span class="p">)</span>   <span class="n">baud</span> <span class="o">=</span> <span class="mi">576000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="p">)</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="mi">921600</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&gt;</span> <span class="mi">2000000</span><span class="p">)</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="mi">2000000</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">baud</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cp210x_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">cp210x_set_config_single</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_IFC_ENABLE</span><span class="p">,</span>
								<span class="n">UART_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - Unable to enable UART</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Configure the termios structure */</span>
	<span class="n">cp210x_get_termios</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="cm">/* The baud rate must be initialised on cp2104 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">cp210x_change_speed</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">usb_serial_generic_open</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cp210x_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_serial_generic_close</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disconnected</span><span class="p">)</span>
		<span class="n">cp210x_set_config_single</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_IFC_ENABLE</span><span class="p">,</span> <span class="n">UART_DISABLE</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * cp210x_get_termios</span>
<span class="cm"> * Reads the baud rate, data bits, parity, stop bits and flow control mode</span>
<span class="cm"> * from the device, corrects any unsupported values, and configures the</span>
<span class="cm"> * termios structure to reflect the state of the device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cp210x_get_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp210x_get_termios_port</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">baud</span><span class="p">);</span>
		<span class="n">tty_encode_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflag</span><span class="p">;</span>
		<span class="n">cflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cp210x_get_termios_port</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cflag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">baud</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * cp210x_get_termios_port</span>
<span class="cm"> * This is the heart of cp210x_get_termios which always uses a &amp;usb_serial_port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cp210x_get_termios_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cflagp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">baudp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflag</span><span class="p">,</span> <span class="n">modem_ctl</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>

	<span class="n">cp210x_get_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_GET_BAUDRATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">baud</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - baud rate = %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
	<span class="o">*</span><span class="n">baudp</span> <span class="o">=</span> <span class="n">baud</span><span class="p">;</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="o">*</span><span class="n">cflagp</span><span class="p">;</span>

	<span class="n">cp210x_get_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_GET_LINE_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CSIZE</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">BITS_DATA_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BITS_DATA_5</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - data bits = 5&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cflag</span> <span class="o">|=</span> <span class="n">CS5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BITS_DATA_6</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - data bits = 6&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cflag</span> <span class="o">|=</span> <span class="n">CS6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BITS_DATA_7</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - data bits = 7&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cflag</span> <span class="o">|=</span> <span class="n">CS7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BITS_DATA_8</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - data bits = 8&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cflag</span> <span class="o">|=</span> <span class="n">CS8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BITS_DATA_9</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - data bits = 9 (not supported, using 8 data bits)&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
		<span class="n">cflag</span> <span class="o">|=</span> <span class="n">CS8</span><span class="p">;</span>
		<span class="n">bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BITS_DATA_MASK</span><span class="p">;</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">BITS_DATA_8</span><span class="p">;</span>
		<span class="n">cp210x_set_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_SET_LINE_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Unknown number of data bits, using 8&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cflag</span> <span class="o">|=</span> <span class="n">CS8</span><span class="p">;</span>
		<span class="n">bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BITS_DATA_MASK</span><span class="p">;</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">BITS_DATA_8</span><span class="p">;</span>
		<span class="n">cp210x_set_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_SET_LINE_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">BITS_PARITY_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BITS_PARITY_NONE</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = NONE&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PARENB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BITS_PARITY_ODD</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = ODD&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cflag</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PARENB</span><span class="o">|</span><span class="n">PARODD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BITS_PARITY_EVEN</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = EVEN&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PARODD</span><span class="p">;</span>
		<span class="n">cflag</span> <span class="o">|=</span> <span class="n">PARENB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BITS_PARITY_MARK</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = MARK&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cflag</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PARENB</span><span class="o">|</span><span class="n">PARODD</span><span class="o">|</span><span class="n">CMSPAR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BITS_PARITY_SPACE</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = SPACE&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PARODD</span><span class="p">;</span>
		<span class="n">cflag</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PARENB</span><span class="o">|</span><span class="n">CMSPAR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Unknown parity mode, disabling parity&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PARENB</span><span class="p">;</span>
		<span class="n">bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BITS_PARITY_MASK</span><span class="p">;</span>
		<span class="n">cp210x_set_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_SET_LINE_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CSTOPB</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">BITS_STOP_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BITS_STOP_1</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - stop bits = 1&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BITS_STOP_1_5</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - stop bits = 1.5 (not supported, using 1 stop bit)&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
		<span class="n">bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BITS_STOP_MASK</span><span class="p">;</span>
		<span class="n">cp210x_set_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_SET_LINE_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BITS_STOP_2</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - stop bits = 2&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cflag</span> <span class="o">|=</span> <span class="n">CSTOPB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Unknown number of stop bits, using 1 stop bit&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
		<span class="n">bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BITS_STOP_MASK</span><span class="p">;</span>
		<span class="n">cp210x_set_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_SET_LINE_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cp210x_get_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_GET_FLOW</span><span class="p">,</span> <span class="n">modem_ctl</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modem_ctl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0008</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - flow control = CRTSCTS&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cflag</span> <span class="o">|=</span> <span class="n">CRTSCTS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - flow control = NONE&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CRTSCTS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">cflagp</span> <span class="o">=</span> <span class="n">cflag</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CP2101 supports the following baud rates:</span>
<span class="cm"> *</span>
<span class="cm"> *	300, 600, 1200, 1800, 2400, 4800, 7200, 9600, 14400, 19200, 28800,</span>
<span class="cm"> *	38400, 56000, 57600, 115200, 128000, 230400, 460800, 921600</span>
<span class="cm"> *</span>
<span class="cm"> * CP2102 and CP2103 support the following additional rates:</span>
<span class="cm"> *</span>
<span class="cm"> *	4000, 16000, 51200, 64000, 76800, 153600, 250000, 256000, 500000,</span>
<span class="cm"> *	576000</span>
<span class="cm"> *</span>
<span class="cm"> * The device will map a requested rate to a supported one, but the result</span>
<span class="cm"> * of requests for rates greater than 1053257 is undefined (see AN205).</span>
<span class="cm"> *</span>
<span class="cm"> * CP2104, CP2105 and CP2110 support most rates up to 2M, 921k and 1M baud,</span>
<span class="cm"> * respectively, with an error less than 1%. The actual rates are determined</span>
<span class="cm"> * by</span>
<span class="cm"> *</span>
<span class="cm"> *	div = round(freq / (2 x prescale x request))</span>
<span class="cm"> *	actual = freq / (2 x prescale x div)</span>
<span class="cm"> *</span>
<span class="cm"> * For CP2104 and CP2105 freq is 48Mhz and prescale is 4 for request &lt;= 365bps</span>
<span class="cm"> * or 1 otherwise.</span>
<span class="cm"> * For CP2110 freq is 24Mhz and prescale is 4 for request &lt;= 300bps or 1</span>
<span class="cm"> * otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cp210x_change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">baud</span><span class="p">;</span>

	<span class="n">baud</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ospeed</span><span class="p">;</span>

	<span class="cm">/* This maps the requested rate to a rate valid on cp2102 or cp2103,</span>
<span class="cm">	 * or to an arbitrary rate in [1M,2M].</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE: B0 is not implemented.</span>
<span class="cm">	 */</span>
	<span class="n">baud</span> <span class="o">=</span> <span class="n">cp210x_quantise_baudrate</span><span class="p">(</span><span class="n">baud</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - setting baud rate to %u&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp210x_set_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_SET_BAUDRATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">baud</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">baud</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to set baud rate to %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_termios</span><span class="p">)</span>
			<span class="n">baud</span> <span class="o">=</span> <span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_ospeed</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tty_encode_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cp210x_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflag</span><span class="p">,</span> <span class="n">old_cflag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">modem_ctl</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
	<span class="n">old_cflag</span> <span class="o">=</span> <span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ospeed</span> <span class="o">!=</span> <span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_ospeed</span><span class="p">)</span>
		<span class="n">cp210x_change_speed</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">old_termios</span><span class="p">);</span>

	<span class="cm">/* If the number of data bits is to be updated */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">old_cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cp210x_get_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_GET_LINE_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BITS_DATA_MASK</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CS5</span>:
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">BITS_DATA_5</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - data bits = 5&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CS6</span>:
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">BITS_DATA_6</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - data bits = 6&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CS7</span>:
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">BITS_DATA_7</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - data bits = 7&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CS8</span>:
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">BITS_DATA_8</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - data bits = 8&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*case CS9:</span>
<span class="cm">			bits |= BITS_DATA_9;</span>
<span class="cm">			dbg(&quot;%s - data bits = 9&quot;, __func__);</span>
<span class="cm">			break;*/</span>
		<span class="nl">default:</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;cp210x driver does not &quot;</span>
					<span class="s">&quot;support the number of bits requested,&quot;</span>
					<span class="s">&quot; using 8 bit mode&quot;</span><span class="p">);</span>
				<span class="n">bits</span> <span class="o">|=</span> <span class="n">BITS_DATA_8</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp210x_set_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_SET_LINE_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Number of data bits requested &quot;</span>
					<span class="s">&quot;not supported by device&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cflag</span>     <span class="o">&amp;</span> <span class="p">(</span><span class="n">PARENB</span><span class="o">|</span><span class="n">PARODD</span><span class="o">|</span><span class="n">CMSPAR</span><span class="p">))</span> <span class="o">!=</span>
	    <span class="p">(</span><span class="n">old_cflag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PARENB</span><span class="o">|</span><span class="n">PARODD</span><span class="o">|</span><span class="n">CMSPAR</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">cp210x_get_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_GET_LINE_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BITS_PARITY_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CMSPAR</span><span class="p">)</span> <span class="p">{</span>
			    <span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span> <span class="p">{</span>
				    <span class="n">bits</span> <span class="o">|=</span> <span class="n">BITS_PARITY_MARK</span><span class="p">;</span>
				    <span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = MARK&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				    <span class="n">bits</span> <span class="o">|=</span> <span class="n">BITS_PARITY_SPACE</span><span class="p">;</span>
				    <span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = SPACE&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			    <span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			    <span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span> <span class="p">{</span>
				    <span class="n">bits</span> <span class="o">|=</span> <span class="n">BITS_PARITY_ODD</span><span class="p">;</span>
				    <span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = ODD&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				    <span class="n">bits</span> <span class="o">|=</span> <span class="n">BITS_PARITY_EVEN</span><span class="p">;</span>
				    <span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = EVEN&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			    <span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp210x_set_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_SET_LINE_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Parity mode not supported by device&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">old_cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cp210x_get_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_GET_LINE_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BITS_STOP_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">BITS_STOP_2</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - stop bits = 2&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">BITS_STOP_1</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - stop bits = 1&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp210x_set_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_SET_LINE_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Number of stop bits requested &quot;</span>
					<span class="s">&quot;not supported by device&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">old_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cp210x_get_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_GET_FLOW</span><span class="p">,</span> <span class="n">modem_ctl</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - read modem controls = 0x%.4x 0x%.4x 0x%.4x 0x%.4x&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">modem_ctl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">modem_ctl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				<span class="n">modem_ctl</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">modem_ctl</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">modem_ctl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x7B</span><span class="p">;</span>
			<span class="n">modem_ctl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x09</span><span class="p">;</span>
			<span class="n">modem_ctl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - flow control = CRTSCTS&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">modem_ctl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x7B</span><span class="p">;</span>
			<span class="n">modem_ctl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">modem_ctl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - flow control = NONE&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - write modem controls = 0x%.4x 0x%.4x 0x%.4x 0x%.4x&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">modem_ctl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">modem_ctl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				<span class="n">modem_ctl</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">modem_ctl</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">cp210x_set_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_SET_FLOW</span><span class="p">,</span> <span class="n">modem_ctl</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cp210x_tiocmset</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cp210x_tiocmset_port</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="n">clear</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cp210x_tiocmset_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">CONTROL_RTS</span><span class="p">;</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">CONTROL_WRITE_RTS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">CONTROL_DTR</span><span class="p">;</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">CONTROL_WRITE_DTR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CONTROL_RTS</span><span class="p">;</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">CONTROL_WRITE_RTS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CONTROL_DTR</span><span class="p">;</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">CONTROL_WRITE_DTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - control = 0x%.4x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cp210x_set_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_SET_MHS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cp210x_dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">cp210x_tiocmset_port</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TIOCM_DTR</span><span class="o">|</span><span class="n">TIOCM_RTS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cp210x_tiocmset_port</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TIOCM_DTR</span><span class="o">|</span><span class="n">TIOCM_RTS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cp210x_tiocmget</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">cp210x_get_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_GET_MDMSTS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">CONTROL_DTR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span><span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">CONTROL_RTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span><span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">CONTROL_CTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span><span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">CONTROL_DSR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span><span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">CONTROL_RING</span><span class="p">)</span><span class="o">?</span> <span class="n">TIOCM_RI</span>  <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span><span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">CONTROL_DCD</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CD</span>  <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - control = 0x%.2x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cp210x_break_ctl</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">BREAK_OFF</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">BREAK_ON</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - turning break %s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">state</span> <span class="o">==</span> <span class="n">BREAK_OFF</span> <span class="o">?</span> <span class="s">&quot;off&quot;</span> <span class="o">:</span> <span class="s">&quot;on&quot;</span><span class="p">);</span>
	<span class="n">cp210x_set_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CP210X_SET_BREAK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cp210x_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cp210x_port_private</span> <span class="o">*</span><span class="n">port_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* cp210x buffers behave strangely unless device is reset */</span>
	<span class="n">usb_reset_device</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port_priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">port_priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_priv</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">port_priv</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">port_priv</span><span class="p">));</span>
		<span class="n">port_priv</span><span class="o">-&gt;</span><span class="n">bInterfaceNumber</span> <span class="o">=</span>
		    <span class="n">serial</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>

		<span class="n">usb_set_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">port_priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cp210x_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cp210x_port_private</span> <span class="o">*</span><span class="n">port_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port_priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">port_priv</span><span class="p">);</span>
		<span class="n">usb_set_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">module_usb_serial_driver</span><span class="p">(</span><span class="n">serial_drivers</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRIVER_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Enable verbose debugging messages&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
