<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › serial › safe_serial.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>safe_serial.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Safe Encapsulated USB Serial Driver</span>
<span class="cm"> *</span>
<span class="cm"> *      Copyright (C) 2010 Johan Hovold &lt;jhovold@gmail.com&gt;</span>
<span class="cm"> *      Copyright (C) 2001 Lineo</span>
<span class="cm"> *      Copyright (C) 2001 Hewlett-Packard</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *	it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *	(at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * By:</span>
<span class="cm"> *      Stuart Lynne &lt;sl@lineo.com&gt;, Tom Rushworth &lt;tbr@lineo.com&gt;</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The encapsultaion is designed to overcome difficulties with some USB</span>
<span class="cm"> * hardware.</span>
<span class="cm"> *</span>
<span class="cm"> * While the USB protocol has a CRC over the data while in transit, i.e. while</span>
<span class="cm"> * being carried over the bus, there is no end to end protection. If the</span>
<span class="cm"> * hardware has any problems getting the data into or out of the USB transmit</span>
<span class="cm"> * and receive FIFO&#39;s then data can be lost.</span>
<span class="cm"> *</span>
<span class="cm"> * This protocol adds a two byte trailer to each USB packet to specify the</span>
<span class="cm"> * number of bytes of valid data and a 10 bit CRC that will allow the receiver</span>
<span class="cm"> * to verify that the entire USB packet was received without error.</span>
<span class="cm"> *</span>
<span class="cm"> * Because in this case the sender and receiver are the class and function</span>
<span class="cm"> * drivers there is now end to end protection.</span>
<span class="cm"> *</span>
<span class="cm"> * There is an additional option that can be used to force all transmitted</span>
<span class="cm"> * packets to be padded to the maximum packet size. This provides a work</span>
<span class="cm"> * around for some devices which have problems with small USB packets.</span>
<span class="cm"> *</span>
<span class="cm"> * Assuming a packetsize of N:</span>
<span class="cm"> *</span>
<span class="cm"> *      0..N-2  data and optional padding</span>
<span class="cm"> *</span>
<span class="cm"> *      N-2     bits 7-2 - number of bytes of valid data</span>
<span class="cm"> *              bits 1-0 top two bits of 10 bit CRC</span>
<span class="cm"> *      N-1     bottom 8 bits of 10 bit CRC</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      | Data Length       | 10 bit CRC                                |</span>
<span class="cm"> *      + 7 . 6 . 5 . 4 . 3 . 2 . 1 . 0 | 7 . 6 . 5 . 4 . 3 . 2 . 1 . 0 +</span>
<span class="cm"> *</span>
<span class="cm"> * The 10 bit CRC is computed across the sent data, followed by the trailer</span>
<span class="cm"> * with the length set and the CRC set to zero. The CRC is then OR&#39;d into</span>
<span class="cm"> * the trailer.</span>
<span class="cm"> *</span>
<span class="cm"> * When received a 10 bit CRC is computed over the entire frame including</span>
<span class="cm"> * the trailer and should be equal to zero.</span>
<span class="cm"> *</span>
<span class="cm"> * Two module parameters are used to control the encapsulation, if both are</span>
<span class="cm"> * turned of the module works as a simple serial device with NO</span>
<span class="cm"> * encapsulation.</span>
<span class="cm"> *</span>
<span class="cm"> * See linux/drivers/usbd/serial_fd for a device function driver</span>
<span class="cm"> * implementation of this.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_driver.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/serial.h&gt;</span>


<span class="cp">#ifndef CONFIG_USB_SERIAL_SAFE_PADDED</span>
<span class="cp">#define CONFIG_USB_SERIAL_SAFE_PADDED 0</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">safe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">padded</span> <span class="o">=</span> <span class="n">CONFIG_USB_SERIAL_SAFE_PADDED</span><span class="p">;</span>

<span class="cp">#define DRIVER_VERSION &quot;v0.1&quot;</span>
<span class="cp">#define DRIVER_AUTHOR &quot;sl@lineo.com, tbr@lineo.com, Johan Hovold &lt;jhovold@gmail.com&gt;&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;USB Safe Encapsulated Serial&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">__u16</span> <span class="n">vendor</span><span class="p">;</span>		<span class="cm">/* no default */</span>
<span class="k">static</span> <span class="n">__u16</span> <span class="n">product</span><span class="p">;</span>		<span class="cm">/* no default */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vendor</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vendor</span><span class="p">,</span> <span class="s">&quot;User specified USB idVendor (required)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="s">&quot;User specified USB idProduct (required)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug enabled or not&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">safe</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">safe</span><span class="p">,</span> <span class="s">&quot;Turn Safe Encapsulation On/Off&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">padded</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">padded</span><span class="p">,</span> <span class="s">&quot;Pad to full wMaxPacketSize On/Off&quot;</span><span class="p">);</span>

<span class="cp">#define CDC_DEVICE_CLASS                        0x02</span>

<span class="cp">#define CDC_INTERFACE_CLASS                     0x02</span>
<span class="cp">#define CDC_INTERFACE_SUBCLASS                  0x06</span>

<span class="cp">#define LINEO_INTERFACE_CLASS                   0xff</span>

<span class="cp">#define LINEO_INTERFACE_SUBCLASS_SAFENET        0x01</span>
<span class="cp">#define LINEO_SAFENET_CRC                       0x01</span>
<span class="cp">#define LINEO_SAFENET_CRC_PADDED                0x02</span>

<span class="cp">#define LINEO_INTERFACE_SUBCLASS_SAFESERIAL     0x02</span>
<span class="cp">#define LINEO_SAFESERIAL_CRC                    0x01</span>
<span class="cp">#define LINEO_SAFESERIAL_CRC_PADDED             0x02</span>


<span class="cp">#define MY_USB_DEVICE(vend, prod, dc, ic, isc) \</span>
<span class="cp">	.match_flags = USB_DEVICE_ID_MATCH_DEVICE | \</span>
<span class="cp">		       USB_DEVICE_ID_MATCH_DEV_CLASS | \</span>
<span class="cp">		       USB_DEVICE_ID_MATCH_INT_CLASS | \</span>
<span class="cp">		       USB_DEVICE_ID_MATCH_INT_SUBCLASS, \</span>
<span class="cp">	.idVendor = (vend), \</span>
<span class="cp">	.idProduct = (prod),\</span>
<span class="cp">	.bDeviceClass = (dc),\</span>
<span class="cp">	.bInterfaceClass = (ic), \</span>
<span class="cp">	.bInterfaceSubClass = (isc),</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">MY_USB_DEVICE</span><span class="p">(</span><span class="mh">0x49f</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">CDC_DEVICE_CLASS</span><span class="p">,</span> <span class="n">LINEO_INTERFACE_CLASS</span><span class="p">,</span> <span class="n">LINEO_INTERFACE_SUBCLASS_SAFESERIAL</span><span class="p">)},</span>	<span class="cm">/* Itsy */</span>
	<span class="p">{</span><span class="n">MY_USB_DEVICE</span><span class="p">(</span><span class="mh">0x3f0</span><span class="p">,</span> <span class="mh">0x2101</span><span class="p">,</span> <span class="n">CDC_DEVICE_CLASS</span><span class="p">,</span> <span class="n">LINEO_INTERFACE_CLASS</span><span class="p">,</span> <span class="n">LINEO_INTERFACE_SUBCLASS_SAFESERIAL</span><span class="p">)},</span>	<span class="cm">/* Calypso */</span>
	<span class="p">{</span><span class="n">MY_USB_DEVICE</span><span class="p">(</span><span class="mh">0x4dd</span><span class="p">,</span> <span class="mh">0x8001</span><span class="p">,</span> <span class="n">CDC_DEVICE_CLASS</span><span class="p">,</span> <span class="n">LINEO_INTERFACE_CLASS</span><span class="p">,</span> <span class="n">LINEO_INTERFACE_SUBCLASS_SAFESERIAL</span><span class="p">)},</span>	<span class="cm">/* Iris */</span>
	<span class="p">{</span><span class="n">MY_USB_DEVICE</span><span class="p">(</span><span class="mh">0x4dd</span><span class="p">,</span> <span class="mh">0x8002</span><span class="p">,</span> <span class="n">CDC_DEVICE_CLASS</span><span class="p">,</span> <span class="n">LINEO_INTERFACE_CLASS</span><span class="p">,</span> <span class="n">LINEO_INTERFACE_SUBCLASS_SAFESERIAL</span><span class="p">)},</span>	<span class="cm">/* Collie */</span>
	<span class="p">{</span><span class="n">MY_USB_DEVICE</span><span class="p">(</span><span class="mh">0x4dd</span><span class="p">,</span> <span class="mh">0x8003</span><span class="p">,</span> <span class="n">CDC_DEVICE_CLASS</span><span class="p">,</span> <span class="n">LINEO_INTERFACE_CLASS</span><span class="p">,</span> <span class="n">LINEO_INTERFACE_SUBCLASS_SAFESERIAL</span><span class="p">)},</span>	<span class="cm">/* Collie */</span>
	<span class="p">{</span><span class="n">MY_USB_DEVICE</span><span class="p">(</span><span class="mh">0x4dd</span><span class="p">,</span> <span class="mh">0x8004</span><span class="p">,</span> <span class="n">CDC_DEVICE_CLASS</span><span class="p">,</span> <span class="n">LINEO_INTERFACE_CLASS</span><span class="p">,</span> <span class="n">LINEO_INTERFACE_SUBCLASS_SAFESERIAL</span><span class="p">)},</span>	<span class="cm">/* Collie */</span>
	<span class="p">{</span><span class="n">MY_USB_DEVICE</span><span class="p">(</span><span class="mh">0x5f9</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">CDC_DEVICE_CLASS</span><span class="p">,</span> <span class="n">LINEO_INTERFACE_CLASS</span><span class="p">,</span> <span class="n">LINEO_INTERFACE_SUBCLASS_SAFESERIAL</span><span class="p">)},</span>	<span class="cm">/* Sharp tmp */</span>
	<span class="cm">/* extra null entry for module vendor/produc parameters */</span>
	<span class="p">{</span><span class="n">MY_USB_DEVICE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CDC_DEVICE_CLASS</span><span class="p">,</span> <span class="n">LINEO_INTERFACE_CLASS</span><span class="p">,</span> <span class="n">LINEO_INTERFACE_SUBCLASS_SAFESERIAL</span><span class="p">)},</span>
	<span class="p">{}</span>			<span class="cm">/* terminating entry  */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">__u16</span> <span class="n">crc10_table</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x000</span><span class="p">,</span> <span class="mh">0x233</span><span class="p">,</span> <span class="mh">0x255</span><span class="p">,</span> <span class="mh">0x066</span><span class="p">,</span> <span class="mh">0x299</span><span class="p">,</span> <span class="mh">0x0aa</span><span class="p">,</span> <span class="mh">0x0cc</span><span class="p">,</span> <span class="mh">0x2ff</span><span class="p">,</span>
	<span class="mh">0x301</span><span class="p">,</span> <span class="mh">0x132</span><span class="p">,</span> <span class="mh">0x154</span><span class="p">,</span> <span class="mh">0x367</span><span class="p">,</span> <span class="mh">0x198</span><span class="p">,</span> <span class="mh">0x3ab</span><span class="p">,</span> <span class="mh">0x3cd</span><span class="p">,</span> <span class="mh">0x1fe</span><span class="p">,</span>
	<span class="mh">0x031</span><span class="p">,</span> <span class="mh">0x202</span><span class="p">,</span> <span class="mh">0x264</span><span class="p">,</span> <span class="mh">0x057</span><span class="p">,</span> <span class="mh">0x2a8</span><span class="p">,</span> <span class="mh">0x09b</span><span class="p">,</span> <span class="mh">0x0fd</span><span class="p">,</span> <span class="mh">0x2ce</span><span class="p">,</span>
	<span class="mh">0x330</span><span class="p">,</span> <span class="mh">0x103</span><span class="p">,</span> <span class="mh">0x165</span><span class="p">,</span> <span class="mh">0x356</span><span class="p">,</span> <span class="mh">0x1a9</span><span class="p">,</span> <span class="mh">0x39a</span><span class="p">,</span> <span class="mh">0x3fc</span><span class="p">,</span> <span class="mh">0x1cf</span><span class="p">,</span>
	<span class="mh">0x062</span><span class="p">,</span> <span class="mh">0x251</span><span class="p">,</span> <span class="mh">0x237</span><span class="p">,</span> <span class="mh">0x004</span><span class="p">,</span> <span class="mh">0x2fb</span><span class="p">,</span> <span class="mh">0x0c8</span><span class="p">,</span> <span class="mh">0x0ae</span><span class="p">,</span> <span class="mh">0x29d</span><span class="p">,</span>
	<span class="mh">0x363</span><span class="p">,</span> <span class="mh">0x150</span><span class="p">,</span> <span class="mh">0x136</span><span class="p">,</span> <span class="mh">0x305</span><span class="p">,</span> <span class="mh">0x1fa</span><span class="p">,</span> <span class="mh">0x3c9</span><span class="p">,</span> <span class="mh">0x3af</span><span class="p">,</span> <span class="mh">0x19c</span><span class="p">,</span>
	<span class="mh">0x053</span><span class="p">,</span> <span class="mh">0x260</span><span class="p">,</span> <span class="mh">0x206</span><span class="p">,</span> <span class="mh">0x035</span><span class="p">,</span> <span class="mh">0x2ca</span><span class="p">,</span> <span class="mh">0x0f9</span><span class="p">,</span> <span class="mh">0x09f</span><span class="p">,</span> <span class="mh">0x2ac</span><span class="p">,</span>
	<span class="mh">0x352</span><span class="p">,</span> <span class="mh">0x161</span><span class="p">,</span> <span class="mh">0x107</span><span class="p">,</span> <span class="mh">0x334</span><span class="p">,</span> <span class="mh">0x1cb</span><span class="p">,</span> <span class="mh">0x3f8</span><span class="p">,</span> <span class="mh">0x39e</span><span class="p">,</span> <span class="mh">0x1ad</span><span class="p">,</span>
	<span class="mh">0x0c4</span><span class="p">,</span> <span class="mh">0x2f7</span><span class="p">,</span> <span class="mh">0x291</span><span class="p">,</span> <span class="mh">0x0a2</span><span class="p">,</span> <span class="mh">0x25d</span><span class="p">,</span> <span class="mh">0x06e</span><span class="p">,</span> <span class="mh">0x008</span><span class="p">,</span> <span class="mh">0x23b</span><span class="p">,</span>
	<span class="mh">0x3c5</span><span class="p">,</span> <span class="mh">0x1f6</span><span class="p">,</span> <span class="mh">0x190</span><span class="p">,</span> <span class="mh">0x3a3</span><span class="p">,</span> <span class="mh">0x15c</span><span class="p">,</span> <span class="mh">0x36f</span><span class="p">,</span> <span class="mh">0x309</span><span class="p">,</span> <span class="mh">0x13a</span><span class="p">,</span>
	<span class="mh">0x0f5</span><span class="p">,</span> <span class="mh">0x2c6</span><span class="p">,</span> <span class="mh">0x2a0</span><span class="p">,</span> <span class="mh">0x093</span><span class="p">,</span> <span class="mh">0x26c</span><span class="p">,</span> <span class="mh">0x05f</span><span class="p">,</span> <span class="mh">0x039</span><span class="p">,</span> <span class="mh">0x20a</span><span class="p">,</span>
	<span class="mh">0x3f4</span><span class="p">,</span> <span class="mh">0x1c7</span><span class="p">,</span> <span class="mh">0x1a1</span><span class="p">,</span> <span class="mh">0x392</span><span class="p">,</span> <span class="mh">0x16d</span><span class="p">,</span> <span class="mh">0x35e</span><span class="p">,</span> <span class="mh">0x338</span><span class="p">,</span> <span class="mh">0x10b</span><span class="p">,</span>
	<span class="mh">0x0a6</span><span class="p">,</span> <span class="mh">0x295</span><span class="p">,</span> <span class="mh">0x2f3</span><span class="p">,</span> <span class="mh">0x0c0</span><span class="p">,</span> <span class="mh">0x23f</span><span class="p">,</span> <span class="mh">0x00c</span><span class="p">,</span> <span class="mh">0x06a</span><span class="p">,</span> <span class="mh">0x259</span><span class="p">,</span>
	<span class="mh">0x3a7</span><span class="p">,</span> <span class="mh">0x194</span><span class="p">,</span> <span class="mh">0x1f2</span><span class="p">,</span> <span class="mh">0x3c1</span><span class="p">,</span> <span class="mh">0x13e</span><span class="p">,</span> <span class="mh">0x30d</span><span class="p">,</span> <span class="mh">0x36b</span><span class="p">,</span> <span class="mh">0x158</span><span class="p">,</span>
	<span class="mh">0x097</span><span class="p">,</span> <span class="mh">0x2a4</span><span class="p">,</span> <span class="mh">0x2c2</span><span class="p">,</span> <span class="mh">0x0f1</span><span class="p">,</span> <span class="mh">0x20e</span><span class="p">,</span> <span class="mh">0x03d</span><span class="p">,</span> <span class="mh">0x05b</span><span class="p">,</span> <span class="mh">0x268</span><span class="p">,</span>
	<span class="mh">0x396</span><span class="p">,</span> <span class="mh">0x1a5</span><span class="p">,</span> <span class="mh">0x1c3</span><span class="p">,</span> <span class="mh">0x3f0</span><span class="p">,</span> <span class="mh">0x10f</span><span class="p">,</span> <span class="mh">0x33c</span><span class="p">,</span> <span class="mh">0x35a</span><span class="p">,</span> <span class="mh">0x169</span><span class="p">,</span>
	<span class="mh">0x188</span><span class="p">,</span> <span class="mh">0x3bb</span><span class="p">,</span> <span class="mh">0x3dd</span><span class="p">,</span> <span class="mh">0x1ee</span><span class="p">,</span> <span class="mh">0x311</span><span class="p">,</span> <span class="mh">0x122</span><span class="p">,</span> <span class="mh">0x144</span><span class="p">,</span> <span class="mh">0x377</span><span class="p">,</span>
	<span class="mh">0x289</span><span class="p">,</span> <span class="mh">0x0ba</span><span class="p">,</span> <span class="mh">0x0dc</span><span class="p">,</span> <span class="mh">0x2ef</span><span class="p">,</span> <span class="mh">0x010</span><span class="p">,</span> <span class="mh">0x223</span><span class="p">,</span> <span class="mh">0x245</span><span class="p">,</span> <span class="mh">0x076</span><span class="p">,</span>
	<span class="mh">0x1b9</span><span class="p">,</span> <span class="mh">0x38a</span><span class="p">,</span> <span class="mh">0x3ec</span><span class="p">,</span> <span class="mh">0x1df</span><span class="p">,</span> <span class="mh">0x320</span><span class="p">,</span> <span class="mh">0x113</span><span class="p">,</span> <span class="mh">0x175</span><span class="p">,</span> <span class="mh">0x346</span><span class="p">,</span>
	<span class="mh">0x2b8</span><span class="p">,</span> <span class="mh">0x08b</span><span class="p">,</span> <span class="mh">0x0ed</span><span class="p">,</span> <span class="mh">0x2de</span><span class="p">,</span> <span class="mh">0x021</span><span class="p">,</span> <span class="mh">0x212</span><span class="p">,</span> <span class="mh">0x274</span><span class="p">,</span> <span class="mh">0x047</span><span class="p">,</span>
	<span class="mh">0x1ea</span><span class="p">,</span> <span class="mh">0x3d9</span><span class="p">,</span> <span class="mh">0x3bf</span><span class="p">,</span> <span class="mh">0x18c</span><span class="p">,</span> <span class="mh">0x373</span><span class="p">,</span> <span class="mh">0x140</span><span class="p">,</span> <span class="mh">0x126</span><span class="p">,</span> <span class="mh">0x315</span><span class="p">,</span>
	<span class="mh">0x2eb</span><span class="p">,</span> <span class="mh">0x0d8</span><span class="p">,</span> <span class="mh">0x0be</span><span class="p">,</span> <span class="mh">0x28d</span><span class="p">,</span> <span class="mh">0x072</span><span class="p">,</span> <span class="mh">0x241</span><span class="p">,</span> <span class="mh">0x227</span><span class="p">,</span> <span class="mh">0x014</span><span class="p">,</span>
	<span class="mh">0x1db</span><span class="p">,</span> <span class="mh">0x3e8</span><span class="p">,</span> <span class="mh">0x38e</span><span class="p">,</span> <span class="mh">0x1bd</span><span class="p">,</span> <span class="mh">0x342</span><span class="p">,</span> <span class="mh">0x171</span><span class="p">,</span> <span class="mh">0x117</span><span class="p">,</span> <span class="mh">0x324</span><span class="p">,</span>
	<span class="mh">0x2da</span><span class="p">,</span> <span class="mh">0x0e9</span><span class="p">,</span> <span class="mh">0x08f</span><span class="p">,</span> <span class="mh">0x2bc</span><span class="p">,</span> <span class="mh">0x043</span><span class="p">,</span> <span class="mh">0x270</span><span class="p">,</span> <span class="mh">0x216</span><span class="p">,</span> <span class="mh">0x025</span><span class="p">,</span>
	<span class="mh">0x14c</span><span class="p">,</span> <span class="mh">0x37f</span><span class="p">,</span> <span class="mh">0x319</span><span class="p">,</span> <span class="mh">0x12a</span><span class="p">,</span> <span class="mh">0x3d5</span><span class="p">,</span> <span class="mh">0x1e6</span><span class="p">,</span> <span class="mh">0x180</span><span class="p">,</span> <span class="mh">0x3b3</span><span class="p">,</span>
	<span class="mh">0x24d</span><span class="p">,</span> <span class="mh">0x07e</span><span class="p">,</span> <span class="mh">0x018</span><span class="p">,</span> <span class="mh">0x22b</span><span class="p">,</span> <span class="mh">0x0d4</span><span class="p">,</span> <span class="mh">0x2e7</span><span class="p">,</span> <span class="mh">0x281</span><span class="p">,</span> <span class="mh">0x0b2</span><span class="p">,</span>
	<span class="mh">0x17d</span><span class="p">,</span> <span class="mh">0x34e</span><span class="p">,</span> <span class="mh">0x328</span><span class="p">,</span> <span class="mh">0x11b</span><span class="p">,</span> <span class="mh">0x3e4</span><span class="p">,</span> <span class="mh">0x1d7</span><span class="p">,</span> <span class="mh">0x1b1</span><span class="p">,</span> <span class="mh">0x382</span><span class="p">,</span>
	<span class="mh">0x27c</span><span class="p">,</span> <span class="mh">0x04f</span><span class="p">,</span> <span class="mh">0x029</span><span class="p">,</span> <span class="mh">0x21a</span><span class="p">,</span> <span class="mh">0x0e5</span><span class="p">,</span> <span class="mh">0x2d6</span><span class="p">,</span> <span class="mh">0x2b0</span><span class="p">,</span> <span class="mh">0x083</span><span class="p">,</span>
	<span class="mh">0x12e</span><span class="p">,</span> <span class="mh">0x31d</span><span class="p">,</span> <span class="mh">0x37b</span><span class="p">,</span> <span class="mh">0x148</span><span class="p">,</span> <span class="mh">0x3b7</span><span class="p">,</span> <span class="mh">0x184</span><span class="p">,</span> <span class="mh">0x1e2</span><span class="p">,</span> <span class="mh">0x3d1</span><span class="p">,</span>
	<span class="mh">0x22f</span><span class="p">,</span> <span class="mh">0x01c</span><span class="p">,</span> <span class="mh">0x07a</span><span class="p">,</span> <span class="mh">0x249</span><span class="p">,</span> <span class="mh">0x0b6</span><span class="p">,</span> <span class="mh">0x285</span><span class="p">,</span> <span class="mh">0x2e3</span><span class="p">,</span> <span class="mh">0x0d0</span><span class="p">,</span>
	<span class="mh">0x11f</span><span class="p">,</span> <span class="mh">0x32c</span><span class="p">,</span> <span class="mh">0x34a</span><span class="p">,</span> <span class="mh">0x179</span><span class="p">,</span> <span class="mh">0x386</span><span class="p">,</span> <span class="mh">0x1b5</span><span class="p">,</span> <span class="mh">0x1d3</span><span class="p">,</span> <span class="mh">0x3e0</span><span class="p">,</span>
	<span class="mh">0x21e</span><span class="p">,</span> <span class="mh">0x02d</span><span class="p">,</span> <span class="mh">0x04b</span><span class="p">,</span> <span class="mh">0x278</span><span class="p">,</span> <span class="mh">0x087</span><span class="p">,</span> <span class="mh">0x2b4</span><span class="p">,</span> <span class="mh">0x2d2</span><span class="p">,</span> <span class="mh">0x0e1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define CRC10_INITFCS     0x000	</span><span class="cm">/* Initial FCS value */</span><span class="cp"></span>
<span class="cp">#define CRC10_GOODFCS     0x000	</span><span class="cm">/* Good final FCS value */</span><span class="cp"></span>
<span class="cp">#define CRC10_FCS(fcs, c) ((((fcs) &lt;&lt; 8) &amp; 0x3ff) ^ crc10_table[((fcs) &gt;&gt; 2) &amp; 0xff] ^ (c))</span>

<span class="cm">/**</span>
<span class="cm"> * fcs_compute10 - memcpy and calculate 10 bit CRC across buffer</span>
<span class="cm"> * @sp: pointer to buffer</span>
<span class="cm"> * @len: number of bytes</span>
<span class="cm"> * @fcs: starting FCS</span>
<span class="cm"> *</span>
<span class="cm"> * Perform a memcpy and calculate fcs using ppp 10bit CRC algorithm. Return</span>
<span class="cm"> * new 10 bit FCS.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__u16</span> <span class="n">__inline__</span> <span class="nf">fcs_compute10</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">fcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fcs</span> <span class="o">=</span> <span class="n">CRC10_FCS</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="o">*</span><span class="n">sp</span><span class="o">++</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">fcs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">safe_process_read_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">length</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">actual_length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">fcs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">length</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">safe</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">fcs</span> <span class="o">=</span> <span class="n">fcs_compute10</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">CRC10_INITFCS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - bad CRC %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fcs</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">actual_length</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">actual_length</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - inconsistent lengths %d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">actual_length</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - actual: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">actual_length</span><span class="p">);</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">actual_length</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">tty_insert_flip_string</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">safe_prepare_write_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
						<span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">trailer_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pkt_len</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">fcs</span><span class="p">;</span>

	<span class="n">trailer_len</span> <span class="o">=</span> <span class="n">safe</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">kfifo_out_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">trailer_len</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">safe</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* pad if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padded</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">-</span> <span class="n">count</span> <span class="o">-</span> <span class="n">trailer_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="n">trailer_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set count */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">pkt_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">pkt_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* compute fcs and insert into trailer */</span>
	<span class="n">fcs</span> <span class="o">=</span> <span class="n">fcs_compute10</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">,</span> <span class="n">CRC10_INITFCS</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">pkt_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">fcs</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">pkt_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">fcs</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pkt_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">safe_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceProtocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LINEO_SAFESERIAL_CRC</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LINEO_SAFESERIAL_CRC_PADDED</span>:
		<span class="n">padded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="n">safe_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;safe_serial&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>		<span class="n">id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_ports</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">process_read_urb</span> <span class="o">=</span>	<span class="n">safe_process_read_urb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_write_buffer</span> <span class="o">=</span>	<span class="n">safe_prepare_write_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span> <span class="o">=</span>		<span class="n">safe_startup</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="o">*</span> <span class="k">const</span> <span class="n">serial_drivers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">safe_device</span><span class="p">,</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">safe_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">KBUILD_MODNAME</span> <span class="s">&quot;: &quot;</span> <span class="n">DRIVER_VERSION</span> <span class="s">&quot;:&quot;</span>
	       <span class="n">DRIVER_DESC</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* if we have vendor / product parameters patch them into id list */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vendor</span> <span class="o">||</span> <span class="n">product</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">KBUILD_MODNAME</span> <span class="s">&quot;: vendor: %x product: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">vendor</span><span class="p">,</span> <span class="n">product</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">id_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idVendor</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">id_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idProduct</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">id_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idVendor</span> <span class="o">=</span> <span class="n">vendor</span><span class="p">;</span>
				<span class="n">id_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idProduct</span> <span class="o">=</span> <span class="n">product</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">usb_serial_register_drivers</span><span class="p">(</span><span class="n">serial_drivers</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">safe_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_serial_deregister_drivers</span><span class="p">(</span><span class="n">serial_drivers</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">safe_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">safe_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
