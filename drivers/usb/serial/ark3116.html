<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › serial › ark3116.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ark3116.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2009 by Bart Hartgers (bart.hartgers+ark3116@gmail.com)</span>
<span class="cm"> * Original version:</span>
<span class="cm"> * Copyright (C) 2006</span>
<span class="cm"> *   Simon Schulz (ark3116_driver &lt;at&gt; auctionant.de)</span>
<span class="cm"> *</span>
<span class="cm"> * ark3116</span>
<span class="cm"> * - implements a driver for the arkmicro ark3116 chipset (vendor=0x6547,</span>
<span class="cm"> *   productid=0x0232) (used in a datacable called KQ-U8A)</span>
<span class="cm"> *</span>
<span class="cm"> * Supports full modem status lines, break, hardware flow control. Does not</span>
<span class="cm"> * support software flow control, since I do not know how to enable it in hw.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is a essentially new implementation. I initially dug</span>
<span class="cm"> * into the old ark3116.c driver and suddenly realized the ark3116 is</span>
<span class="cm"> * a 16450 with a USB interface glued to it. See comments at the</span>
<span class="cm"> * bottom of this file.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2 of the License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/serial.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/serial_reg.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Version information</span>
<span class="cm"> */</span>

<span class="cp">#define DRIVER_VERSION &quot;v0.7&quot;</span>
<span class="cp">#define DRIVER_AUTHOR &quot;Bart Hartgers &lt;bart.hartgers+ark3116@gmail.com&gt;&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;USB ARK3116 serial/IrDA driver&quot;</span>
<span class="cp">#define DRIVER_DEV_DESC &quot;ARK3116 RS232/IrDA&quot;</span>
<span class="cp">#define DRIVER_NAME &quot;ark3116&quot;</span>

<span class="cm">/* usb timeout of 1 second */</span>
<span class="cp">#define ARK_TIMEOUT (1*HZ)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x6547</span><span class="p">,</span> <span class="mh">0x0232</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x18ec</span><span class="p">,</span> <span class="mh">0x3118</span><span class="p">)</span> <span class="p">},</span>		<span class="cm">/* USB to IrDA adapter */</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_irda</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x18ec</span> <span class="o">&amp;&amp;</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x3118</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ark3116_private</span> <span class="p">{</span>
	<span class="n">wait_queue_head_t</span>       <span class="n">delta_msr_wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_icount</span>	<span class="n">icount</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">irda</span><span class="p">;</span>	<span class="cm">/* 1 for irda device */</span>

	<span class="cm">/* protects hw register updates */</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">hw_lock</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">quot</span><span class="p">;</span>	<span class="cm">/* baudrate divisor */</span>
	<span class="n">__u32</span>			<span class="n">lcr</span><span class="p">;</span>	<span class="cm">/* line control register value */</span>
	<span class="n">__u32</span>			<span class="n">hcr</span><span class="p">;</span>	<span class="cm">/* handshake control register (0x8)</span>
<span class="cm">					 * value */</span>
	<span class="n">__u32</span>			<span class="n">mcr</span><span class="p">;</span>	<span class="cm">/* modem contol register value */</span>

	<span class="cm">/* protects the status values below */</span>
	<span class="n">spinlock_t</span>		<span class="n">status_lock</span><span class="p">;</span>
	<span class="n">__u32</span>			<span class="n">msr</span><span class="p">;</span>	<span class="cm">/* modem status register value */</span>
	<span class="n">__u32</span>			<span class="n">lsr</span><span class="p">;</span>	<span class="cm">/* line status register value */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ark3116_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="n">reg</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	 <span class="cm">/* 0xfe 0x40 are magic values taken from original driver */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				 <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
				 <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ARK_TIMEOUT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ark3116_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="cm">/* 0xfe 0xc0 are magic values taken from original driver */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				 <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
				 <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ARK_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">calc_divisor</span><span class="p">(</span><span class="kt">int</span> <span class="n">bps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Original ark3116 made some exceptions in rounding here</span>
<span class="cm">	 * because windows did the same. Assume that is not really</span>
<span class="cm">	 * necessary.</span>
<span class="cm">	 * Crystal is 12MHz, probably because of USB, but we divide by 4?</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">12000000</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">bps</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">bps</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ark3116_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ark3116_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* make sure we have our end-points */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_bulk_in</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_bulk_out</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_interrupt_in</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - missing endpoint - &quot;</span>
			<span class="s">&quot;bulk in: %d, bulk out: %d, int in %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span>
			<span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_bulk_in</span><span class="p">,</span>
			<span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_bulk_out</span><span class="p">,</span>
			<span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_interrupt_in</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ark3116_private</span><span class="p">),</span>
		       <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">delta_msr_wait</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_lock</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irda</span> <span class="o">=</span> <span class="n">is_irda</span><span class="p">(</span><span class="n">serial</span><span class="p">);</span>

	<span class="n">usb_set_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* setup the hardware */</span>
	<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* disable DMA */</span>
	<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* handshake control */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="mh">0x8</span>     <span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* modem control */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irda</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="mh">0xb</span> <span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="mh">0xb</span> <span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="mh">0xc</span> <span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="mh">0xd</span> <span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
		<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="mh">0xa</span> <span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* setup baudrate */</span>
	<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_DLAB</span><span class="p">);</span>

	<span class="cm">/* setup for 9600 8N1 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">quot</span> <span class="o">=</span> <span class="n">calc_divisor</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
	<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_DLL</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">quot</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_DLM</span><span class="p">,</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">quot</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">=</span> <span class="n">UART_LCR_WLEN8</span><span class="p">;</span>
	<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_WLEN8</span><span class="p">);</span>

	<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irda</span><span class="p">)</span>
		<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s using %s mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">KBUILD_MODNAME</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irda</span> <span class="o">?</span> <span class="s">&quot;IrDA&quot;</span> <span class="o">:</span> <span class="s">&quot;RS232&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ark3116_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ark3116_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/* device is closed, so URBs and DMA should be down */</span>

	<span class="n">usb_set_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ark3116_init_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">;</span>
	<span class="o">*</span><span class="n">termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">=</span> <span class="n">B9600</span> <span class="o">|</span> <span class="n">CS8</span>
				      <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">HUPCL</span> <span class="o">|</span> <span class="n">CLOCAL</span><span class="p">;</span>
	<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ark3116_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ark3116_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflag</span> <span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bps</span> <span class="o">=</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">quot</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">lcr</span><span class="p">,</span> <span class="n">hcr</span><span class="p">,</span> <span class="n">eval</span><span class="p">;</span>

	<span class="cm">/* set data bit count */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS5</span>:
		<span class="n">lcr</span> <span class="o">=</span> <span class="n">UART_LCR_WLEN5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS6</span>:
		<span class="n">lcr</span> <span class="o">=</span> <span class="n">UART_LCR_WLEN6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>:
		<span class="n">lcr</span> <span class="o">=</span> <span class="n">UART_LCR_WLEN7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">CS8</span>:
		<span class="n">lcr</span> <span class="o">=</span> <span class="n">UART_LCR_WLEN8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span>
		<span class="n">lcr</span> <span class="o">|=</span> <span class="n">UART_LCR_STOP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span>
		<span class="n">lcr</span> <span class="o">|=</span> <span class="n">UART_LCR_PARITY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">))</span>
		<span class="n">lcr</span> <span class="o">|=</span> <span class="n">UART_LCR_EPAR</span><span class="p">;</span>
<span class="cp">#ifdef CMSPAR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CMSPAR</span><span class="p">)</span>
		<span class="n">lcr</span> <span class="o">|=</span> <span class="n">UART_LCR_SPAR</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* handshake control */</span>
	<span class="n">hcr</span> <span class="o">=</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x03</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="cm">/* calc baudrate */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - setting bps to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bps</span><span class="p">);</span>
	<span class="n">eval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bps</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">quot</span> <span class="o">=</span> <span class="n">calc_divisor</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bps</span> <span class="o">&lt;</span> <span class="mi">75</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">bps</span> <span class="o">&gt;</span> <span class="mi">3000000</span><span class="p">))</span>
			<span class="n">bps</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
		<span class="n">quot</span> <span class="o">=</span> <span class="n">calc_divisor</span><span class="p">(</span><span class="n">bps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">460800</span>:
		<span class="n">eval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">quot</span> <span class="o">=</span> <span class="n">calc_divisor</span><span class="p">(</span><span class="n">bps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">921600</span>:
		<span class="n">eval</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">quot</span> <span class="o">=</span> <span class="n">calc_divisor</span><span class="p">(</span><span class="n">bps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Update state: synchronize */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

	<span class="cm">/* keep old LCR_SBC bit */</span>
	<span class="n">lcr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">&amp;</span> <span class="n">UART_LCR_SBC</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - setting hcr:0x%02x,lcr:0x%02x,quot:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">hcr</span><span class="p">,</span> <span class="n">lcr</span><span class="p">,</span> <span class="n">quot</span><span class="p">);</span>

	<span class="cm">/* handshake control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hcr</span> <span class="o">!=</span> <span class="n">hcr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hcr</span> <span class="o">=</span> <span class="n">hcr</span><span class="p">;</span>
		<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">hcr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* baudrate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">quot</span> <span class="o">!=</span> <span class="n">quot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">quot</span> <span class="o">=</span> <span class="n">quot</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">=</span> <span class="n">lcr</span><span class="p">;</span> <span class="cm">/* need to write lcr anyway */</span>

		<span class="cm">/* disable DMA since transmit/receive is</span>
<span class="cm">		 * shadowed by UART_DLL</span>
<span class="cm">		 */</span>
		<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span>
				  <span class="n">lcr</span><span class="o">|</span><span class="n">UART_LCR_DLAB</span><span class="p">);</span>
		<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_DLL</span><span class="p">,</span> <span class="n">quot</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_DLM</span><span class="p">,</span> <span class="p">(</span><span class="n">quot</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="cm">/* restore lcr */</span>
		<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">lcr</span><span class="p">);</span>
		<span class="cm">/* magic baudrate thingy: not sure what it does,</span>
<span class="cm">		 * but windows does this as well.</span>
<span class="cm">		 */</span>
		<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="n">eval</span><span class="p">);</span>

		<span class="cm">/* enable DMA */</span>
		<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="n">UART_FCR_DMA_SELECT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">!=</span> <span class="n">lcr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">=</span> <span class="n">lcr</span><span class="p">;</span>
		<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">lcr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

	<span class="cm">/* check for software flow control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">I_IXON</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%s: don&#39;t know how to do software flow control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">KBUILD_MODNAME</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Don&#39;t rewrite B0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_termios_baud_rate</span><span class="p">(</span><span class="n">termios</span><span class="p">))</span>
		<span class="n">tty_termios_encode_baud_rate</span><span class="p">(</span><span class="n">termios</span><span class="p">,</span> <span class="n">bps</span><span class="p">,</span> <span class="n">bps</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ark3116_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable DMA */</span>
		<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* deactivate interrupts */</span>
		<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">usb_serial_generic_close</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_interrupt_in</span><span class="p">)</span>
			<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ark3116_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ark3116_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_serial_generic_open</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - usb_serial_generic_open failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* remove any data still left: also clears error state */</span>
	<span class="n">ark3116_read_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_RX</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="cm">/* read modem status */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">=</span> <span class="n">ark3116_read_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_MSR</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="cm">/* read line status */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">lsr</span> <span class="o">=</span> <span class="n">ark3116_read_reg</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;submit irq_in urb failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">result</span><span class="p">);</span>
		<span class="n">ark3116_close</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* activate interrupts */</span>
	<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">UART_IER_MSI</span><span class="o">|</span><span class="n">UART_IER_RLSI</span><span class="p">);</span>

	<span class="cm">/* enable DMA */</span>
	<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="n">UART_FCR_DMA_SELECT</span><span class="p">);</span>

	<span class="cm">/* setup termios */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">ark3116_set_termios</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="nl">err_out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ark3116_get_icount</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">serial_icounter_struct</span> <span class="o">*</span><span class="n">icount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ark3116_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cnow</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rng</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rng</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">overrun</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">parity</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">brk</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">buf_overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">buf_overrun</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ark3116_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ark3116_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">serstruct</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_arg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIOCGSERIAL</span>:
		<span class="cm">/* XXX: Some of these values are probably wrong. */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serstruct</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serstruct</span><span class="p">));</span>
		<span class="n">serstruct</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_16654</span><span class="p">;</span>
		<span class="n">serstruct</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>
		<span class="n">serstruct</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
		<span class="n">serstruct</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">serstruct</span><span class="p">.</span><span class="n">baud_base</span> <span class="o">=</span> <span class="mi">460800</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">user_arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serstruct</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serstruct</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIOCSSERIAL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serstruct</span><span class="p">,</span> <span class="n">user_arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serstruct</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIOCMIWAIT</span>:
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
			<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">delta_msr_wait</span><span class="p">);</span>
			<span class="cm">/* see if a signal did it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">prev</span><span class="p">.</span><span class="n">rng</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rng</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">prev</span><span class="p">.</span><span class="n">dsr</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dsr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">prev</span><span class="p">.</span><span class="n">dcd</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dcd</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">prev</span><span class="p">.</span><span class="n">cts</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">cts</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_RNG</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">prev</span><span class="p">.</span><span class="n">rng</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rng</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_DSR</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">prev</span><span class="p">.</span><span class="n">dsr</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dsr</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CD</span>  <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">prev</span><span class="p">.</span><span class="n">dcd</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dcd</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CTS</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">prev</span><span class="p">.</span><span class="n">cts</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">cts</span><span class="p">)))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ark3116_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ark3116_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">__u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcr</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span>  <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DSR</span>  <span class="o">?</span> <span class="n">TIOCM_DSR</span>  <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_CTS</span>  <span class="o">?</span> <span class="n">TIOCM_CTS</span>  <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_RI</span>   <span class="o">?</span> <span class="n">TIOCM_RI</span>   <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span>  <span class="o">?</span> <span class="n">TIOCM_CD</span>   <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ctrl</span>   <span class="o">&amp;</span> <span class="n">UART_MCR_DTR</span>  <span class="o">?</span> <span class="n">TIOCM_DTR</span>  <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ctrl</span>   <span class="o">&amp;</span> <span class="n">UART_MCR_RTS</span>  <span class="o">?</span> <span class="n">TIOCM_RTS</span>  <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ctrl</span>   <span class="o">&amp;</span> <span class="n">UART_MCR_OUT1</span> <span class="o">?</span> <span class="n">TIOCM_OUT1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ctrl</span>   <span class="o">&amp;</span> <span class="n">UART_MCR_OUT2</span> <span class="o">?</span> <span class="n">TIOCM_OUT2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ark3116_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">clr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ark3116_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/* we need to take the mutex here, to make sure that the value</span>
<span class="cm">	 * in priv-&gt;mcr is actually the one that is in the hardware</span>
<span class="cm">	 */</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_OUT1</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_OUT1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_OUT2</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_OUT2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clr</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MCR_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clr</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MCR_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clr</span> <span class="o">&amp;</span> <span class="n">TIOCM_OUT1</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MCR_OUT1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clr</span> <span class="o">&amp;</span> <span class="n">TIOCM_OUT2</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MCR_OUT2</span><span class="p">;</span>

	<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcr</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ark3116_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ark3116_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/* LCR is also used for other things: protect access */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">|=</span> <span class="n">UART_LCR_SBC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_LCR_SBC</span><span class="p">;</span>

	<span class="n">ark3116_write_reg</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">lcr</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ark3116_update_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">msr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ark3116_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">=</span> <span class="n">msr</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_ANY_DELTA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* update input line counters */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCTS</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">cts</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DDSR</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DDCD</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dcd</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_TERI</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rng</span><span class="o">++</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">delta_msr_wait</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ark3116_update_lsr</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">lsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ark3116_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* combine bits */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">lsr</span> <span class="o">|=</span> <span class="n">lsr</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span><span class="o">&amp;</span><span class="n">UART_LSR_BRK_ERROR_BITS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_BI</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_FE</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_PE</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_OE</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ark3116_read_int_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* this urb is terminated, clean up */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - urb shutting down with status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - nonzero urb status received: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* success */</span>
		<span class="cm">/* discovered this by trail and error... */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xe8</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">__u8</span> <span class="n">id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&amp;</span><span class="n">UART_IIR_ID</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: iir=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">UART_IIR_MSI</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: msr=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
				<span class="n">ark3116_update_msr</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">UART_IIR_RLSI</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: lsr=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="n">ark3116_update_lsr</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Not sure what this data meant...</span>
<span class="cm">		 */</span>
		<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				      <span class="n">__func__</span><span class="p">,</span>
				      <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span>
				      <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - Error %d submitting interrupt urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Data comes in via the bulk (data) URB, erors/interrupts via the int URB.</span>
<span class="cm"> * This means that we cannot be sure which data byte has an associated error</span>
<span class="cm"> * condition, so we report an error for all data in the next bulk read.</span>
<span class="cm"> *</span>
<span class="cm"> * Actually, there might even be a window between the bulk data leaving the</span>
<span class="cm"> * ark and reading/resetting the lsr in the read_bulk_callback where an</span>
<span class="cm"> * interrupt for the next data block could come in.</span>
<span class="cm"> * Without somekind of ordering on the ark, we would have to report the</span>
<span class="cm"> * error for the next block of data as well...</span>
<span class="cm"> * For now, let&#39;s pretend this can&#39;t happen.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ark3116_process_read_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ark3116_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tty_flag</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">lsr</span><span class="p">;</span>

	<span class="cm">/* update line status */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lsr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">lsr</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">lsr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_LSR_BRK_ERROR_BITS</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_BRK_ERROR_BITS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_BI</span><span class="p">)</span>
			<span class="n">tty_flag</span> <span class="o">=</span> <span class="n">TTY_BREAK</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_PE</span><span class="p">)</span>
			<span class="n">tty_flag</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_FE</span><span class="p">)</span>
			<span class="n">tty_flag</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>

		<span class="cm">/* overrun is special, not associated with a char */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_OE</span><span class="p">)</span>
			<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TTY_OVERRUN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tty_insert_flip_string_fixed_flag</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">tty_flag</span><span class="p">,</span>
							<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="n">ark3116_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;ark3116&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>		<span class="n">id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_ports</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span> <span class="o">=</span>		<span class="n">ark3116_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>		<span class="n">ark3116_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span>		<span class="n">ark3116_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_termios</span> <span class="o">=</span>		<span class="n">ark3116_init_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">ark3116_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span>		<span class="n">ark3116_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span>		<span class="n">ark3116_tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_icount</span> <span class="o">=</span>		<span class="n">ark3116_get_icount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">ark3116_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">ark3116_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span> <span class="o">=</span> 		<span class="n">ark3116_break_ctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_int_callback</span> <span class="o">=</span> 	<span class="n">ark3116_read_int_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">process_read_urb</span> <span class="o">=</span>	<span class="n">ark3116_process_read_urb</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="o">*</span> <span class="k">const</span> <span class="n">serial_drivers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">ark3116_device</span><span class="p">,</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="n">module_usb_serial_driver</span><span class="p">(</span><span class="n">serial_drivers</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Enable debug&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The following describes what I learned from studying the old</span>
<span class="cm"> * ark3116.c driver, disassembling the windows driver, and some lucky</span>
<span class="cm"> * guesses. Since I do not have any datasheet or other</span>
<span class="cm"> * documentation, inaccuracies are almost guaranteed.</span>
<span class="cm"> *</span>
<span class="cm"> * Some specs for the ARK3116 can be found here:</span>
<span class="cm"> * http://web.archive.org/web/20060318000438/</span>
<span class="cm"> *   www.arkmicro.com/en/products/view.php?id=10</span>
<span class="cm"> * On that page, 2 GPIO pins are mentioned: I assume these are the</span>
<span class="cm"> * OUT1 and OUT2 pins of the UART, so I added support for those</span>
<span class="cm"> * through the MCR. Since the pins are not available on my hardware,</span>
<span class="cm"> * I could not verify this.</span>
<span class="cm"> * Also, it states there is &quot;on-chip hardware flow control&quot;. I have</span>
<span class="cm"> * discovered how to enable that. Unfortunately, I do not know how to</span>
<span class="cm"> * enable XON/XOFF (software) flow control, which would need support</span>
<span class="cm"> * from the chip as well to work. Because of the wording on the web</span>
<span class="cm"> * page there is a real possibility the chip simply does not support</span>
<span class="cm"> * software flow control.</span>
<span class="cm"> *</span>
<span class="cm"> * I got my ark3116 as part of a mobile phone adapter cable. On the</span>
<span class="cm"> * PCB, the following numbered contacts are present:</span>
<span class="cm"> *</span>
<span class="cm"> *  1:- +5V</span>
<span class="cm"> *  2:o DTR</span>
<span class="cm"> *  3:i RX</span>
<span class="cm"> *  4:i DCD</span>
<span class="cm"> *  5:o RTS</span>
<span class="cm"> *  6:o TX</span>
<span class="cm"> *  7:i RI</span>
<span class="cm"> *  8:i DSR</span>
<span class="cm"> * 10:- 0V</span>
<span class="cm"> * 11:i CTS</span>
<span class="cm"> *</span>
<span class="cm"> * On my chip, all signals seem to be 3.3V, but 5V tolerant. But that</span>
<span class="cm"> * may be different for the one you have ;-).</span>
<span class="cm"> *</span>
<span class="cm"> * The windows driver limits the registers to 0-F, so I assume there</span>
<span class="cm"> * are actually 16 present on the device.</span>
<span class="cm"> *</span>
<span class="cm"> * On an UART interrupt, 4 bytes of data come in on the interrupt</span>
<span class="cm"> * endpoint. The bytes are 0xe8 IIR LSR MSR.</span>
<span class="cm"> *</span>
<span class="cm"> * The baudrate seems to be generated from the 12MHz crystal, using</span>
<span class="cm"> * 4-times subsampling. So quot=12e6/(4*baud). Also see description</span>
<span class="cm"> * of register E.</span>
<span class="cm"> *</span>
<span class="cm"> * Registers 0-7:</span>
<span class="cm"> * These seem to be the same as for a regular 16450. The FCR is set</span>
<span class="cm"> * to UART_FCR_DMA_SELECT (0x8), I guess to enable transfers between</span>
<span class="cm"> * the UART and the USB bridge/DMA engine.</span>
<span class="cm"> *</span>
<span class="cm"> * Register 8:</span>
<span class="cm"> * By trial and error, I found out that bit 0 enables hardware CTS,</span>
<span class="cm"> * stopping TX when CTS is +5V. Bit 1 does the same for RTS, making</span>
<span class="cm"> * RTS +5V when the 3116 cannot transfer the data to the USB bus</span>
<span class="cm"> * (verified by disabling the reading URB). Note that as far as I can</span>
<span class="cm"> * tell, the windows driver does NOT use this, so there might be some</span>
<span class="cm"> * hardware bug or something.</span>
<span class="cm"> *</span>
<span class="cm"> * According to a patch provided here</span>
<span class="cm"> * (http://lkml.org/lkml/2009/7/26/56), the ARK3116 can also be used</span>
<span class="cm"> * as an IrDA dongle. Since I do not have such a thing, I could not</span>
<span class="cm"> * investigate that aspect. However, I can speculate ;-).</span>
<span class="cm"> *</span>
<span class="cm"> * - IrDA encodes data differently than RS232. Most likely, one of</span>
<span class="cm"> *   the bits in registers 9..E enables the IR ENDEC (encoder/decoder).</span>
<span class="cm"> * - Depending on the IR transceiver, the input and output need to be</span>
<span class="cm"> *   inverted, so there are probably bits for that as well.</span>
<span class="cm"> * - IrDA is half-duplex, so there should be a bit for selecting that.</span>
<span class="cm"> *</span>
<span class="cm"> * This still leaves at least two registers unaccounted for. Perhaps</span>
<span class="cm"> * The chip can do XON/XOFF or CRC in HW?</span>
<span class="cm"> *</span>
<span class="cm"> * Register 9:</span>
<span class="cm"> * Set to 0x00 for IrDA, when the baudrate is initialised.</span>
<span class="cm"> *</span>
<span class="cm"> * Register A:</span>
<span class="cm"> * Set to 0x01 for IrDA, at init.</span>
<span class="cm"> *</span>
<span class="cm"> * Register B:</span>
<span class="cm"> * Set to 0x01 for IrDA, 0x00 for RS232, at init.</span>
<span class="cm"> *</span>
<span class="cm"> * Register C:</span>
<span class="cm"> * Set to 00 for IrDA, at init.</span>
<span class="cm"> *</span>
<span class="cm"> * Register D:</span>
<span class="cm"> * Set to 0x41 for IrDA, at init.</span>
<span class="cm"> *</span>
<span class="cm"> * Register E:</span>
<span class="cm"> * Somekind of baudrate override. The windows driver seems to set</span>
<span class="cm"> * this to 0x00 for normal baudrates, 0x01 for 460800, 0x02 for 921600.</span>
<span class="cm"> * Since 460800 and 921600 cannot be obtained by dividing 3MHz by an integer,</span>
<span class="cm"> * it could be somekind of subdivisor thingy.</span>
<span class="cm"> * However,it does not seem to do anything: selecting 921600 (divisor 3,</span>
<span class="cm"> * reg E=2), still gets 1 MHz. I also checked if registers 9, C or F would</span>
<span class="cm"> * work, but they don&#39;t.</span>
<span class="cm"> *</span>
<span class="cm"> * Register F: unknown</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
