<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › serial › io_ti.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>io_ti.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Edgeport USB Serial Converter driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2000-2002 Inside Out Networks, All rights reserved.</span>
<span class="cm"> * Copyright (C) 2001-2002 Greg Kroah-Hartman &lt;greg@kroah.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *	it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *	(at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * Supports the following devices:</span>
<span class="cm"> *	EP/1 EP/2 EP/4 EP/21 EP/22 EP/221 EP/42 EP/421 WATCHPORT</span>
<span class="cm"> *</span>
<span class="cm"> * For questions or problems with this driver, contact Inside Out</span>
<span class="cm"> * Networks technical support, or Peter Berger &lt;pberger@brimson.com&gt;,</span>
<span class="cm"> * or Al Borchers &lt;alborchers@steinerpoint.com&gt;.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_driver.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/kfifo.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/serial.h&gt;</span>

<span class="cp">#include &quot;io_16654.h&quot;</span>
<span class="cp">#include &quot;io_usbvend.h&quot;</span>
<span class="cp">#include &quot;io_ti.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Version Information</span>
<span class="cm"> */</span>
<span class="cp">#define DRIVER_VERSION &quot;v0.7mode043006&quot;</span>
<span class="cp">#define DRIVER_AUTHOR &quot;Greg Kroah-Hartman &lt;greg@kroah.com&gt; and David Iacovelli&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;Edgeport USB Serial Driver&quot;</span>

<span class="cp">#define EPROM_PAGE_SIZE		64</span>


<span class="cm">/* different hardware types */</span>
<span class="cp">#define HARDWARE_TYPE_930	0</span>
<span class="cp">#define HARDWARE_TYPE_TIUMP	1</span>

<span class="cm">/* IOCTL_PRIVATE_TI_GET_MODE Definitions */</span>
<span class="cp">#define	TI_MODE_CONFIGURING	0   </span><span class="cm">/* Device has not entered start device */</span><span class="cp"></span>
<span class="cp">#define	TI_MODE_BOOT		1   </span><span class="cm">/* Staying in boot mode		   */</span><span class="cp"></span>
<span class="cp">#define TI_MODE_DOWNLOAD	2   </span><span class="cm">/* Made it to download mode		   */</span><span class="cp"></span>
<span class="cp">#define TI_MODE_TRANSITIONING	3   </span><span class="cm">/* Currently in boot mode but</span>
<span class="cm">				       transitioning to download mode	   */</span><span class="cp"></span>

<span class="cm">/* read urb state */</span>
<span class="cp">#define EDGE_READ_URB_RUNNING	0</span>
<span class="cp">#define EDGE_READ_URB_STOPPING	1</span>
<span class="cp">#define EDGE_READ_URB_STOPPED	2</span>

<span class="cp">#define EDGE_CLOSING_WAIT	4000	</span><span class="cm">/* in .01 sec */</span><span class="cp"></span>

<span class="cp">#define EDGE_OUT_BUF_SIZE	1024</span>


<span class="cm">/* Product information read from the Edgeport */</span>
<span class="k">struct</span> <span class="n">product_info</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">TiMode</span><span class="p">;</span>			<span class="cm">/* Current TI Mode  */</span>
	<span class="n">__u8</span>	<span class="n">hardware_type</span><span class="p">;</span>		<span class="cm">/* Type of hardware */</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="p">{</span>
	<span class="n">__u16</span> <span class="n">uart_base</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">dma_address</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">shadow_msr</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">shadow_mcr</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">shadow_lsr</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">lsr_mask</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">ump_read_timeout</span><span class="p">;</span>		<span class="cm">/* Number of milliseconds the UMP will</span>
<span class="cm">					   wait without data before completing</span>
<span class="cm">					   a read short */</span>
	<span class="kt">int</span> <span class="n">baud_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">close_pending</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lsr_event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_icount</span>	<span class="n">icount</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">delta_msr_wait</span><span class="p">;</span>	<span class="cm">/* for handling sleeping while</span>
<span class="cm">						   waiting for msr change to</span>
<span class="cm">						   happen */</span>
	<span class="k">struct</span> <span class="n">edgeport_serial</span>	<span class="o">*</span><span class="n">edge_serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span>	<span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">bUartMode</span><span class="p">;</span>		<span class="cm">/* Port type, 0: RS232, etc. */</span>
	<span class="n">spinlock_t</span> <span class="n">ep_lock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ep_read_urb_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ep_write_urb_in_use</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kfifo</span> <span class="n">write_fifo</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">product_info</span> <span class="n">product_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">TI_I2C_Type</span><span class="p">;</span>			<span class="cm">/* Type of I2C in UMP */</span>
	<span class="n">u8</span> <span class="n">TiReadI2C</span><span class="p">;</span>			<span class="cm">/* Set to TRUE if we have read the</span>
<span class="cm">					   I2c in Boot Mode */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">es_lock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_ports_open</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/* Devices that this driver supports */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">edgeport_1port_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_1</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_TI3410_EDGEPORT_1</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_TI3410_EDGEPORT_1I</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_PROXIMITY</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_MOTION</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_MOISTURE</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_TEMPERATURE</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_HUMIDITY</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_POWER</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_LIGHT</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_RADIATION</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_DISTANCE</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_ACCELERATION</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_PROX_DIST</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_PLUS_PWR_HP4CD</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_PLUS_PWR_PCI</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">edgeport_2port_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_2C</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_2I</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_421</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_21</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_42</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_4</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_4I</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_22I</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_221C</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_22C</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_21C</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* The 4, 8 and 16 port devices show up as multiple 2 port devices */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_4S</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_8</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_8S</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_416</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_416B</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Devices that this driver supports */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">id_table_combined</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_1</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_TI3410_EDGEPORT_1</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_TI3410_EDGEPORT_1I</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_PROXIMITY</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_MOTION</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_MOISTURE</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_TEMPERATURE</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_HUMIDITY</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_POWER</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_LIGHT</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_RADIATION</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_DISTANCE</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_ACCELERATION</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_WP_PROX_DIST</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_PLUS_PWR_HP4CD</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_PLUS_PWR_PCI</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_2C</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_2I</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_421</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_21</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_42</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_4</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_4I</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_22I</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_221C</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_22C</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_21C</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_4S</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_8</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_8S</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_416</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ION</span><span class="p">,</span> <span class="n">ION_DEVICE_ID_TI_EDGEPORT_416B</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">id_table_combined</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">OperationalMajorVersion</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">OperationalMinorVersion</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">OperationalBuildNumber</span><span class="p">;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">closing_wait</span> <span class="o">=</span> <span class="n">EDGE_CLOSING_WAIT</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">ignore_cpu_rev</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">default_uart_mode</span><span class="p">;</span>		<span class="cm">/* RS232 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">edge_tty_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">stop_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">restart_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">edge_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">edge_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>

<span class="cm">/* sysfs attributes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">edge_create_sysfs_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">edge_remove_sysfs_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_vread_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">request</span><span class="p">,</span>
				<span class="n">__u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">request</span><span class="p">,</span>
			<span class="p">(</span><span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span><span class="p">),</span>
			<span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - wanted to write %d, but only wrote %d&quot;</span><span class="p">,</span>
					     <span class="n">__func__</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECOMM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_vsend_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">request</span><span class="p">,</span>
				<span class="n">__u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">request</span><span class="p">,</span>
			<span class="p">(</span><span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span><span class="p">),</span>
			<span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - wanted to write %d, but only wrote %d&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECOMM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">command</span><span class="p">,</span>
				<span class="n">__u8</span> <span class="n">moduleid</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ti_vsend_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">moduleid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* clear tx/rx buffers and fifo in TI UMP */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">purge_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port_number</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d, mask %x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port_number</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">send_cmd</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">UMPC_PURGE_PORT</span><span class="p">,</span>
					<span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">UMPM_UART1_PORT</span> <span class="o">+</span> <span class="n">port_number</span><span class="p">),</span>
					<span class="n">mask</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * read_download_mem - Read edgeport memory from TI chip</span>
<span class="cm"> * @dev: usb device pointer</span>
<span class="cm"> * @start_address: Device CPU address at which to read</span>
<span class="cm"> * @length: Length of above data</span>
<span class="cm"> * @address_type: Can read both XDATA and I2C</span>
<span class="cm"> * @buffer: pointer to input data buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_download_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start_address</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">address_type</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">read_length</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">be_start_address</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - @ %x for %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="cm">/* Read in blocks of 64 bytes</span>
<span class="cm">	 * (TI firmware can&#39;t handle more than 64 byte reads)</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span>
			<span class="n">read_length</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">read_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span><span class="n">length</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - @ %x for %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			     <span class="n">start_address</span><span class="p">,</span> <span class="n">read_length</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">be_start_address</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">start_address</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ti_vread_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">UMPC_MEMORY_READ</span><span class="p">,</span>
					<span class="p">(</span><span class="n">__u16</span><span class="p">)</span><span class="n">address_type</span><span class="p">,</span>
					<span class="p">(</span><span class="n">__force</span> <span class="n">__u16</span><span class="p">)</span><span class="n">be_start_address</span><span class="p">,</span>
					<span class="n">buffer</span><span class="p">,</span> <span class="n">read_length</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - ERROR %x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					      <span class="n">read_length</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

		<span class="cm">/* Update pointers/length */</span>
		<span class="n">start_address</span> <span class="o">+=</span> <span class="n">read_length</span><span class="p">;</span>
		<span class="n">buffer</span> <span class="o">+=</span> <span class="n">read_length</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">read_length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_ram</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start_address</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_download_mem</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
					<span class="n">DTK_ADDR_SPACE_XDATA</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read edgeport memory to a given block */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_boot_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">start_address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ti_vread_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">UMPC_MEMORY_READ</span><span class="p">,</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">TI_I2C_Type</span><span class="p">,</span>
				<span class="p">(</span><span class="n">__u16</span><span class="p">)(</span><span class="n">start_address</span><span class="o">+</span><span class="n">i</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - ERROR %x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - start_address = %x, length = %d&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="n">serial</span><span class="o">-&gt;</span><span class="n">TiReadI2C</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write given block to TI EPROM memory */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_boot_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">start_address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* Must do a read before write */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">TiReadI2C</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s - out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read_boot_mem</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ti_vsend_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">UMPC_MEMORY_WRITE</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="p">(</span><span class="n">__u16</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="n">start_address</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - start_sddr = %x, length = %d&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Write edgeport I2C memory to TI chip	*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_i2c_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">start_address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">address_type</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">write_length</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">be_start_address</span><span class="p">;</span>

	<span class="cm">/* We can only send a maximum of 1 aligned byte page at a time */</span>

	<span class="cm">/* calculate the number of bytes left in the first page */</span>
	<span class="n">write_length</span> <span class="o">=</span> <span class="n">EPROM_PAGE_SIZE</span> <span class="o">-</span>
				<span class="p">(</span><span class="n">start_address</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EPROM_PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_length</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">)</span>
		<span class="n">write_length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - BytesInFirstPage Addr = %x, length = %d&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="n">write_length</span><span class="p">);</span>
	<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">write_length</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="cm">/* Write first page */</span>
	<span class="n">be_start_address</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">start_address</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_vsend_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">UMPC_MEMORY_WRITE</span><span class="p">,</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span><span class="n">address_type</span><span class="p">,</span>
				<span class="p">(</span><span class="n">__force</span> <span class="n">__u16</span><span class="p">)</span><span class="n">be_start_address</span><span class="p">,</span>
				<span class="n">buffer</span><span class="p">,</span>	<span class="n">write_length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - ERROR %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">length</span>		<span class="o">-=</span> <span class="n">write_length</span><span class="p">;</span>
	<span class="n">start_address</span>	<span class="o">+=</span> <span class="n">write_length</span><span class="p">;</span>
	<span class="n">buffer</span>		<span class="o">+=</span> <span class="n">write_length</span><span class="p">;</span>

	<span class="cm">/* We should be aligned now -- can write</span>
<span class="cm">	   max page size bytes at a time */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">EPROM_PAGE_SIZE</span><span class="p">)</span>
			<span class="n">write_length</span> <span class="o">=</span> <span class="n">EPROM_PAGE_SIZE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">write_length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Page Write Addr = %x, length = %d&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="n">write_length</span><span class="p">);</span>
		<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">write_length</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

		<span class="cm">/* Write next page */</span>
		<span class="n">be_start_address</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">start_address</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ti_vsend_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">UMPC_MEMORY_WRITE</span><span class="p">,</span>
				<span class="p">(</span><span class="n">__u16</span><span class="p">)</span><span class="n">address_type</span><span class="p">,</span>
				<span class="p">(</span><span class="n">__force</span> <span class="n">__u16</span><span class="p">)</span><span class="n">be_start_address</span><span class="p">,</span>
				<span class="n">buffer</span><span class="p">,</span> <span class="n">write_length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - ERROR %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">length</span>		<span class="o">-=</span> <span class="n">write_length</span><span class="p">;</span>
		<span class="n">start_address</span>	<span class="o">+=</span> <span class="n">write_length</span><span class="p">;</span>
		<span class="n">buffer</span>		<span class="o">+=</span> <span class="n">write_length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Examine the UMP DMA registers and LSR</span>
<span class="cm"> *</span>
<span class="cm"> * Check the MSBit of the X and Y DMA byte count registers.</span>
<span class="cm"> * A zero in this bit indicates that the TX DMA buffers are empty</span>
<span class="cm"> * then check the TX Empty bit in the UART.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tx_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">out_endpoint_desc_block</span> <span class="o">*</span><span class="n">oedb</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">lsr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">oedb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">oedb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oedb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lsr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>	<span class="cm">/* Sigh, that&#39;s right, just one byte,</span>
<span class="cm">					   as not all platforms can do DMA</span>
<span class="cm">					   from stack */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lsr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">oedb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Read the DMA Count Registers */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read_ram</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dma_address</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">oedb</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">oedb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_is_tx_active</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - XByteCount    0x%X&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">oedb</span><span class="o">-&gt;</span><span class="n">XByteCount</span><span class="p">);</span>

	<span class="cm">/* and the LSR */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read_ram</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart_base</span> <span class="o">+</span> <span class="n">UMPMEM_OFFS_UART_LSR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lsr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_is_tx_active</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - LSR = 0x%X&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">lsr</span><span class="p">);</span>

	<span class="cm">/* If either buffer has data or we are transmitting then return TRUE */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">oedb</span><span class="o">-&gt;</span><span class="n">XByteCount</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bytes_left</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UMP_UART_LSR_TX_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bytes_left</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* We return Not Active if we get any kind of error */</span>
<span class="nl">exit_is_tx_active:</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - return %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bytes_left</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">lsr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">oedb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bytes_left</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">chase_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">,</span>
								<span class="kt">int</span> <span class="n">flush</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">baud_rate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
	<span class="n">wait_queue_t</span> <span class="n">wait</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="n">EDGE_CLOSING_WAIT</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>

	<span class="cm">/* wait for data to drain from the buffer */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">init_waitqueue_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">write_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
		<span class="o">||</span> <span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
		<span class="o">||</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">disconnected</span><span class="p">)</span>
			<span class="cm">/* disconnect */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">write_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flush</span><span class="p">)</span>
		<span class="n">kfifo_reset_out</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="cm">/* wait for data to drain from the device */</span>
	<span class="n">timeout</span> <span class="o">+=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="kt">long</span><span class="p">)(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">timeout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
						<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disconnected</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* not disconnected */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_active</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* disconnected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disconnected</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* wait one more character time, based on baud rate */</span>
	<span class="cm">/* (tx_active doesn&#39;t seem to wait for the last byte) */</span>
	<span class="n">baud_rate</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">baud_rate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">baud_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">baud_rate</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">baud_rate</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">choose_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * There may be multiple configurations on this device, in which case</span>
<span class="cm">	 * we would need to read and parse all of them to find out which one</span>
<span class="cm">	 * we want. However, we just support one config at this point,</span>
<span class="cm">	 * configuration # 1, which is Config Descriptor 0.</span>
<span class="cm">	 */</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Number of Interfaces = %d&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumInterfaces</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - MAX Power            = %d&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bMaxPower</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumInterfaces</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - bNumInterfaces is not 1, ERROR!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_rom</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">start_address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">TiMode</span> <span class="o">==</span> <span class="n">TI_MODE_DOWNLOAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read_download_mem</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					       <span class="n">start_address</span><span class="p">,</span>
					       <span class="n">length</span><span class="p">,</span>
					       <span class="n">serial</span><span class="o">-&gt;</span><span class="n">TI_I2C_Type</span><span class="p">,</span>
					       <span class="n">buffer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read_boot_mem</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
								<span class="n">buffer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_rom</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start_address</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">TiMode</span> <span class="o">==</span> <span class="n">TI_MODE_BOOT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">write_boot_mem</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
								<span class="n">buffer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">TiMode</span> <span class="o">==</span> <span class="n">TI_MODE_DOWNLOAD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">write_i2c_mem</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
						<span class="n">serial</span><span class="o">-&gt;</span><span class="n">TI_I2C_Type</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* Read a descriptor header from I2C based on type */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_descriptor_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">desc_type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ti_i2c_desc</span> <span class="o">*</span><span class="n">rom_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">start_address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Search for requested descriptor in I2C */</span>
	<span class="n">start_address</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read_rom</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span>
				   <span class="n">start_address</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_desc</span><span class="p">),</span>
				   <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">rom_desc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rom_desc</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">==</span> <span class="n">desc_type</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">start_address</span><span class="p">;</span>

		<span class="n">start_address</span> <span class="o">=</span> <span class="n">start_address</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_desc</span><span class="p">)</span>
							<span class="o">+</span> <span class="n">rom_desc</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">start_address</span> <span class="o">&lt;</span> <span class="n">TI_MAX_I2C_SIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rom_desc</span><span class="o">-&gt;</span><span class="n">Type</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Validate descriptor checksum */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">valid_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_desc</span> <span class="o">*</span><span class="n">rom_desc</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">cs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rom_desc</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">cs</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">!=</span> <span class="n">rom_desc</span><span class="o">-&gt;</span><span class="n">CheckSum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Mismatch %x - %x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rom_desc</span><span class="o">-&gt;</span><span class="n">CheckSum</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Make sure that the I2C image is good */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_i2c_image</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_i2c_desc</span> <span class="o">*</span><span class="n">rom_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start_address</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">ttype</span><span class="p">;</span>

	<span class="n">rom_desc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rom_desc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rom_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">TI_MAX_I2C_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory when allocating buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read the first byte (Signature0) must be 0x52 or 0x10 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read_rom</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buffer</span> <span class="o">!=</span> <span class="n">UMP5152</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">!=</span> <span class="n">UMP3410</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - invalid buffer signature</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Validate the I2C */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read_rom</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span>
				<span class="n">start_address</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_desc</span><span class="p">),</span>
				<span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">rom_desc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">start_address</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_desc</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">rom_desc</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">TI_MAX_I2C_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - structure too big, erroring out.&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s Type = 0x%x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rom_desc</span><span class="o">-&gt;</span><span class="n">Type</span><span class="p">);</span>

		<span class="cm">/* Skip type 2 record */</span>
		<span class="n">ttype</span> <span class="o">=</span> <span class="n">rom_desc</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ttype</span> <span class="o">!=</span> <span class="n">I2C_DESC_TYPE_FIRMWARE_BASIC</span>
			<span class="o">&amp;&amp;</span> <span class="n">ttype</span> <span class="o">!=</span> <span class="n">I2C_DESC_TYPE_FIRMWARE_AUTO</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Read the descriptor data */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">read_rom</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">start_address</span> <span class="o">+</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_desc</span><span class="p">),</span>
						<span class="n">rom_desc</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">valid_csum</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">start_address</span> <span class="o">=</span> <span class="n">start_address</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_desc</span><span class="p">)</span> <span class="o">+</span>
								<span class="n">rom_desc</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">rom_desc</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">I2C_DESC_TYPE_ION</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">start_address</span> <span class="o">&lt;</span> <span class="n">TI_MAX_I2C_SIZE</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rom_desc</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">I2C_DESC_TYPE_ION</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">start_address</span> <span class="o">&gt;</span> <span class="n">TI_MAX_I2C_SIZE</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_manuf_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start_address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_i2c_desc</span> <span class="o">*</span><span class="n">rom_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edge_ti_manuf_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">rom_desc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rom_desc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rom_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">start_address</span> <span class="o">=</span> <span class="n">get_descriptor_addr</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">I2C_DESC_TYPE_ION</span><span class="p">,</span>
								<span class="n">rom_desc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">start_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Edge Descriptor not found in I2C&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read the descriptor data */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read_rom</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">start_address</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_desc</span><span class="p">),</span>
						<span class="n">rom_desc</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">valid_csum</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">edge_ti_manuf_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - IonConfig      0x%x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">IonConfig</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Version          %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">Version</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Cpu/Board      0x%x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">CpuRev_BoardRev</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - NumPorts         %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">NumPorts</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - NumVirtualPorts  %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">NumVirtualPorts</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - TotalPorts       %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">TotalPorts</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Build firmware header used for firmware update */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_i2c_fw_hdr</span><span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buffer_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">cs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_i2c_desc</span> <span class="o">*</span><span class="n">i2c_header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_i2c_image_header</span> <span class="o">*</span><span class="n">img_header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_i2c_firmware_rec</span> <span class="o">*</span><span class="n">firmware_rec</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span> <span class="o">=</span> <span class="s">&quot;edgeport/down3.bin&quot;</span><span class="p">;</span>

	<span class="cm">/* In order to update the I2C firmware we must change the type 2 record</span>
<span class="cm">	 * to type 0xF2.  This will force the UMP to come up in Boot Mode.</span>
<span class="cm">	 * Then while in boot mode, the driver will download the latest</span>
<span class="cm">	 * firmware (padded to 15.5k) into the UMP ram.  And finally when the</span>
<span class="cm">	 * device comes back up in download mode the driver will cause the new</span>
<span class="cm">	 * firmware to be copied from the UMP Ram to I2C and the firmware will</span>
<span class="cm">	 * update the record type from 0xf2 to 0x02.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Allocate a 15.5k buffer + 2 bytes for version number</span>
<span class="cm">	 * (Firmware Record) */</span>
	<span class="n">buffer_size</span> <span class="o">=</span> <span class="p">(((</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">512</span> <span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_firmware_rec</span><span class="p">));</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Set entire image of 0xffs</p></td><td class="code"><div class="highlight"><pre>	<span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to load image </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fw_name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Save Download Version Number */</span>
	<span class="n">OperationalMajorVersion</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">OperationalMinorVersion</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">OperationalBuildNumber</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* Copy version number into firmware record */</span>
	<span class="n">firmware_rec</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_firmware_rec</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>

	<span class="n">firmware_rec</span><span class="o">-&gt;</span><span class="n">Ver_Major</span>	<span class="o">=</span> <span class="n">OperationalMajorVersion</span><span class="p">;</span>
	<span class="n">firmware_rec</span><span class="o">-&gt;</span><span class="n">Ver_Minor</span>	<span class="o">=</span> <span class="n">OperationalMinorVersion</span><span class="p">;</span>

	<span class="cm">/* Pointer to fw_down memory image */</span>
	<span class="n">img_header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_image_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_firmware_rec</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_image_header</span><span class="p">)],</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">img_header</span><span class="o">-&gt;</span><span class="n">Length</span><span class="p">));</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buffer_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">cs</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="cm">/* Build new header */</span>
	<span class="n">i2c_header</span> <span class="o">=</span>  <span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">;</span>
	<span class="n">firmware_rec</span> <span class="o">=</span>  <span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_firmware_rec</span><span class="o">*</span><span class="p">)</span><span class="n">i2c_header</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">;</span>

	<span class="n">i2c_header</span><span class="o">-&gt;</span><span class="n">Type</span>	<span class="o">=</span> <span class="n">I2C_DESC_TYPE_FIRMWARE_BLANK</span><span class="p">;</span>
	<span class="n">i2c_header</span><span class="o">-&gt;</span><span class="n">Size</span>	<span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span><span class="n">buffer_size</span><span class="p">;</span>
	<span class="n">i2c_header</span><span class="o">-&gt;</span><span class="n">CheckSum</span>	<span class="o">=</span> <span class="n">cs</span><span class="p">;</span>
	<span class="n">firmware_rec</span><span class="o">-&gt;</span><span class="n">Ver_Major</span>	<span class="o">=</span> <span class="n">OperationalMajorVersion</span><span class="p">;</span>
	<span class="n">firmware_rec</span><span class="o">-&gt;</span><span class="n">Ver_Minor</span>	<span class="o">=</span> <span class="n">OperationalMinorVersion</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Try to figure out what type of I2c we have */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_type_bootmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s - out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Try to read type 2 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_vread_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">UMPC_MEMORY_READ</span><span class="p">,</span>
				<span class="n">DTK_ADDR_SPACE_I2C_TYPE_II</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - read 2 status error = %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - read 2 data = 0x%x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">==</span> <span class="n">UMP5152</span> <span class="o">||</span> <span class="o">*</span><span class="n">data</span> <span class="o">==</span> <span class="n">UMP3410</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - ROM_TYPE_II&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">serial</span><span class="o">-&gt;</span><span class="n">TI_I2C_Type</span> <span class="o">=</span> <span class="n">DTK_ADDR_SPACE_I2C_TYPE_II</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Try to read type 3 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_vread_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">UMPC_MEMORY_READ</span><span class="p">,</span>
				<span class="n">DTK_ADDR_SPACE_I2C_TYPE_III</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="n">data</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - read 3 status error = %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - read 2 data = 0x%x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">==</span> <span class="n">UMP5152</span> <span class="o">||</span> <span class="o">*</span><span class="n">data</span> <span class="o">==</span> <span class="n">UMP3410</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - ROM_TYPE_III&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">serial</span><span class="o">-&gt;</span><span class="n">TI_I2C_Type</span> <span class="o">=</span> <span class="n">DTK_ADDR_SPACE_I2C_TYPE_III</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Unknown&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">serial</span><span class="o">-&gt;</span><span class="n">TI_I2C_Type</span> <span class="o">=</span> <span class="n">DTK_ADDR_SPACE_I2C_TYPE_II</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bulk_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num_sent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bulk_out_endpointAddress</span><span class="p">),</span>
			<span class="n">buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">num_sent</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Download given firmware image to the device (IN BOOT MODE) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">download_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span>
							<span class="kt">int</span> <span class="n">image_length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">transfer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* Transfer firmware image */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">image_length</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Read the next buffer from file */</span>
		<span class="n">transfer</span> <span class="o">=</span> <span class="n">image_length</span> <span class="o">-</span> <span class="n">pos</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">transfer</span> <span class="o">&gt;</span> <span class="n">EDGE_FW_BULK_MAX_PACKET_SIZE</span><span class="p">)</span>
			<span class="n">transfer</span> <span class="o">=</span> <span class="n">EDGE_FW_BULK_MAX_PACKET_SIZE</span><span class="p">;</span>

		<span class="cm">/* Transfer data */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">bulk_xfer</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">image</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span>
							<span class="n">transfer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">done</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Advance buffer pointer */</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* FIXME!!! */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">config_boot_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_cpu_rev</span><span class="p">(</span><span class="k">struct</span> <span class="n">edge_ti_manuf_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">TI_GET_CPU_REVISION</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">CpuRev_BoardRev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * DownloadTIFirmware - Download run-time operating firmware to the TI5052</span>
<span class="cm"> *</span>
<span class="cm"> * This routine downloads the main operating code into the TI5052, using the</span>
<span class="cm"> * boot code already burned into E2PROM or ROM.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">download_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start_address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edge_ti_manuf_descriptor</span> <span class="o">*</span><span class="n">ti_manuf_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface_descriptor</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">download_cur_ver</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">download_new_ver</span><span class="p">;</span>

	<span class="cm">/* This routine is entered by both the BOOT mode and the Download mode</span>
<span class="cm">	 * We can determine which code is running by the reading the config</span>
<span class="cm">	 * descriptor and if we have only one bulk pipe it is in boot mode</span>
<span class="cm">	 */</span>
	<span class="n">serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">hardware_type</span> <span class="o">=</span> <span class="n">HARDWARE_TYPE_TIUMP</span><span class="p">;</span>

	<span class="cm">/* Default to type 2 i2c */</span>
	<span class="n">serial</span><span class="o">-&gt;</span><span class="n">TI_I2C_Type</span> <span class="o">=</span> <span class="n">DTK_ADDR_SPACE_I2C_TYPE_II</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">choose_config</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">interface</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interface</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - no interface set, error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup initial mode -- the default mode 0 is TI_MODE_CONFIGURING</span>
<span class="cm">	 * if we have more than one endpoint we are definitely in download</span>
<span class="cm">	 * mode</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">bNumEndpoints</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">TiMode</span> <span class="o">=</span> <span class="n">TI_MODE_DOWNLOAD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* Otherwise we will remain in configuring mode */</span>
		<span class="n">serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">TiMode</span> <span class="o">=</span> <span class="n">TI_MODE_CONFIGURING</span><span class="p">;</span>

	<span class="cm">/********************************************************************/</span>
	<span class="cm">/* Download Mode */</span>
	<span class="cm">/********************************************************************/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">TiMode</span> <span class="o">==</span> <span class="n">TI_MODE_DOWNLOAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ti_i2c_desc</span> <span class="o">*</span><span class="n">rom_desc</span><span class="p">;</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - RUNNING IN DOWNLOAD MODE&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">check_i2c_image</span><span class="p">(</span><span class="n">serial</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - DOWNLOAD MODE -- BAD I2C&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Validate Hardware version number</span>
<span class="cm">		 * Read Manufacturing Descriptor from TI Based Edgeport</span>
<span class="cm">		 */</span>
		<span class="n">ti_manuf_desc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ti_manuf_desc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ti_manuf_desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">get_manuf_info</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check version number of ION descriptor */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ignore_cpu_rev</span> <span class="o">&amp;&amp;</span> <span class="n">ti_cpu_rev</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Wrong CPU Rev %d (Must be 2)&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ti_cpu_rev</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
  		<span class="p">}</span>

		<span class="n">rom_desc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rom_desc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rom_desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Search for type 2 record (firmware record) */</span>
		<span class="n">start_address</span> <span class="o">=</span> <span class="n">get_descriptor_addr</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span>
				<span class="n">I2C_DESC_TYPE_FIRMWARE_BASIC</span><span class="p">,</span> <span class="n">rom_desc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start_address</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ti_i2c_firmware_rec</span> <span class="o">*</span><span class="n">firmware_version</span><span class="p">;</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">record</span><span class="p">;</span>

			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Found Type FIRMWARE (Type 2) record&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>

			<span class="n">firmware_version</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">firmware_version</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">firmware_version</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Validate version number</span>
<span class="cm">			 * Read the descriptor data</span>
<span class="cm">			 */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">read_rom</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">start_address</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_desc</span><span class="p">),</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_firmware_rec</span><span class="p">),</span>
					<span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">firmware_version</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">firmware_version</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Check version number of download with current</span>
<span class="cm">			   version in I2c */</span>
			<span class="n">download_cur_ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmware_version</span><span class="o">-&gt;</span><span class="n">Ver_Major</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
					   <span class="p">(</span><span class="n">firmware_version</span><span class="o">-&gt;</span><span class="n">Ver_Minor</span><span class="p">);</span>
			<span class="n">download_new_ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">OperationalMajorVersion</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
					   <span class="p">(</span><span class="n">OperationalMinorVersion</span><span class="p">);</span>

			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - &gt;&gt; FW Versions Device %d.%d  Driver %d.%d&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span>
			    <span class="n">firmware_version</span><span class="o">-&gt;</span><span class="n">Ver_Major</span><span class="p">,</span>
			    <span class="n">firmware_version</span><span class="o">-&gt;</span><span class="n">Ver_Minor</span><span class="p">,</span>
			    <span class="n">OperationalMajorVersion</span><span class="p">,</span>
			    <span class="n">OperationalMinorVersion</span><span class="p">);</span>

			<span class="cm">/* Check if we have an old version in the I2C and</span>
<span class="cm">			   update if necessary */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">download_cur_ver</span> <span class="o">&lt;</span> <span class="n">download_new_ver</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Update I2C dld from %d.%d to %d.%d&quot;</span><span class="p">,</span>
				    <span class="n">__func__</span><span class="p">,</span>
				    <span class="n">firmware_version</span><span class="o">-&gt;</span><span class="n">Ver_Major</span><span class="p">,</span>
				    <span class="n">firmware_version</span><span class="o">-&gt;</span><span class="n">Ver_Minor</span><span class="p">,</span>
				    <span class="n">OperationalMajorVersion</span><span class="p">,</span>
				    <span class="n">OperationalMinorVersion</span><span class="p">);</span>

				<span class="n">record</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">record</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">firmware_version</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* In order to update the I2C firmware we must</span>
<span class="cm">				 * change the type 2 record to type 0xF2. This</span>
<span class="cm">				 * will force the UMP to come up in Boot Mode.</span>
<span class="cm">				 * Then while in boot mode, the driver will</span>
<span class="cm">				 * download the latest firmware (padded to</span>
<span class="cm">				 * 15.5k) into the UMP ram. Finally when the</span>
<span class="cm">				 * device comes back up in download mode the</span>
<span class="cm">				 * driver will cause the new firmware to be</span>
<span class="cm">				 * copied from the UMP Ram to I2C and the</span>
<span class="cm">				 * firmware will update the record type from</span>
<span class="cm">				 * 0xf2 to 0x02.</span>
<span class="cm">				 */</span>
				<span class="o">*</span><span class="n">record</span> <span class="o">=</span> <span class="n">I2C_DESC_TYPE_FIRMWARE_BLANK</span><span class="p">;</span>

				<span class="cm">/* Change the I2C Firmware record type to</span>
<span class="cm">				   0xf2 to trigger an update */</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">write_rom</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">record</span><span class="p">),</span> <span class="n">record</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">firmware_version</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* verify the write -- must do this in order</span>
<span class="cm">				 * for write to complete before we do the</span>
<span class="cm">				 * hardware reset</span>
<span class="cm">				 */</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">read_rom</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span>
							<span class="n">start_address</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">record</span><span class="p">),</span>
							<span class="n">record</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">firmware_version</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">record</span> <span class="o">!=</span> <span class="n">I2C_DESC_TYPE_FIRMWARE_BLANK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="s">&quot;%s - error resetting device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">firmware_version</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - HARDWARE RESET&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

				<span class="cm">/* Reset UMP -- Back to BOOT MODE */</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">ti_vsend_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">UMPC_HARDWARE_RESET</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - HARDWARE RESET return %d&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

				<span class="cm">/* return an error on purpose. */</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">firmware_version</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">firmware_version</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Search for type 0xF2 record (firmware blank record) */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">start_address</span> <span class="o">=</span> <span class="n">get_descriptor_addr</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">I2C_DESC_TYPE_FIRMWARE_BLANK</span><span class="p">,</span> <span class="n">rom_desc</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#define HEADER_SIZE	(sizeof(struct ti_i2c_desc) + \</span>
<span class="cp">					sizeof(struct ti_i2c_firmware_rec))</span>
			<span class="n">__u8</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
			<span class="n">__u8</span> <span class="o">*</span><span class="n">vheader</span><span class="p">;</span>

			<span class="n">header</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">HEADER_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">header</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">vheader</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">HEADER_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vheader</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Found Type BLANK FIRMWARE (Type F2) record&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * In order to update the I2C firmware we must change</span>
<span class="cm">			 * the type 2 record to type 0xF2. This will force the</span>
<span class="cm">			 * UMP to come up in Boot Mode.  Then while in boot</span>
<span class="cm">			 * mode, the driver will download the latest firmware</span>
<span class="cm">			 * (padded to 15.5k) into the UMP ram. Finally when the</span>
<span class="cm">			 * device comes back up in download mode the driver</span>
<span class="cm">			 * will cause the new firmware to be copied from the</span>
<span class="cm">			 * UMP Ram to I2C and the firmware will update the</span>
<span class="cm">			 * record type from 0xf2 to 0x02.</span>
<span class="cm">			 */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">build_i2c_fw_hdr</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">vheader</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Update I2C with type 0xf2 record with correct</span>
<span class="cm">			   size and checksum */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write_rom</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span>
						<span class="n">start_address</span><span class="p">,</span>
						<span class="n">HEADER_SIZE</span><span class="p">,</span>
						<span class="n">header</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">vheader</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* verify the write -- must do this in order for</span>
<span class="cm">			   write to complete before we do the hardware reset */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">read_rom</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span>
							<span class="n">HEADER_SIZE</span><span class="p">,</span> <span class="n">vheader</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - can&#39;t read header back&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">vheader</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">vheader</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">HEADER_SIZE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - write download record failed&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">vheader</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">vheader</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>

			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Start firmware update&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

			<span class="cm">/* Tell firmware to copy download image into I2C */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ti_vsend_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">UMPC_COPY_DNLD_TO_I2C</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		  	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Update complete 0x%x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s - UMPC_COPY_DNLD_TO_I2C failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>The device is running the download code</p></td><td class="code"><div class="highlight"><pre>		<span class="n">kfree</span><span class="p">(</span><span class="n">rom_desc</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/********************************************************************/</span>
	<span class="cm">/* Boot Mode */</span>
	<span class="cm">/********************************************************************/</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - RUNNING IN BOOT MODE&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Configure the TI device so we can use the BULK pipes for download */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">config_boot_dev</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">)</span>
							<span class="o">!=</span> <span class="n">USB_VENDOR_ID_ION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - VID = 0x%x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">));</span>
		<span class="n">serial</span><span class="o">-&gt;</span><span class="n">TI_I2C_Type</span> <span class="o">=</span> <span class="n">DTK_ADDR_SPACE_I2C_TYPE_II</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">stayinbootmode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We have an ION device (I2c Must be programmed)</span>
<span class="cm">	   Determine I2C image type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_type_bootmode</span><span class="p">(</span><span class="n">serial</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">stayinbootmode</span><span class="p">;</span>

	<span class="cm">/* Check for ION Vendor ID and that the I2C is valid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_i2c_image</span><span class="p">(</span><span class="n">serial</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ti_i2c_image_header</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">__u8</span> <span class="n">cs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">__u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">buffer_size</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span> <span class="o">=</span> <span class="s">&quot;edgeport/down3.bin&quot;</span><span class="p">;</span>

		<span class="cm">/* Validate Hardware version number</span>
<span class="cm">		 * Read Manufacturing Descriptor from TI Based Edgeport</span>
<span class="cm">		 */</span>
		<span class="n">ti_manuf_desc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ti_manuf_desc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ti_manuf_desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">get_manuf_info</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">stayinbootmode</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check for version 2 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ignore_cpu_rev</span> <span class="o">&amp;&amp;</span> <span class="n">ti_cpu_rev</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Wrong CPU Rev %d (Must be 2)&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">ti_cpu_rev</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">stayinbootmode</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">ti_manuf_desc</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * In order to update the I2C firmware we must change the type</span>
<span class="cm">		 * 2 record to type 0xF2. This will force the UMP to come up</span>
<span class="cm">		 * in Boot Mode.  Then while in boot mode, the driver will</span>
<span class="cm">		 * download the latest firmware (padded to 15.5k) into the</span>
<span class="cm">		 * UMP ram. Finally when the device comes back up in download</span>
<span class="cm">		 * mode the driver will cause the new firmware to be copied</span>
<span class="cm">		 * from the UMP Ram to I2C and the firmware will update the</span>
<span class="cm">		 * record type from 0xf2 to 0x02.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Do we really have to copy the whole firmware image,</span>
<span class="cm">		 * or could we do this in place!</span>
<span class="cm">		 */</span>

		<span class="cm">/* Allocate a 15.5k buffer + 3 byte header */</span>
		<span class="n">buffer_size</span> <span class="o">=</span> <span class="p">(((</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">512</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_image_header</span><span class="p">));</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Initialize the buffer to 0xff (pad the buffer) */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to load image </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">fw_name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_image_header</span><span class="p">);</span>
				<span class="n">i</span> <span class="o">&lt;</span> <span class="n">buffer_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">cs</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_image_header</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>

		<span class="cm">/* update length and checksum after padding */</span>
		<span class="n">header</span><span class="o">-&gt;</span><span class="n">Length</span> 	 <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)(</span><span class="n">buffer_size</span> <span class="o">-</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_i2c_image_header</span><span class="p">)));</span>
		<span class="n">header</span><span class="o">-&gt;</span><span class="n">CheckSum</span> <span class="o">=</span> <span class="n">cs</span><span class="p">;</span>

		<span class="cm">/* Download the operational code  */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Downloading operational code image (TI UMP)&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">download_code</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Error downloading operational code image&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Device will reboot */</span>
		<span class="n">serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">TiMode</span> <span class="o">=</span> <span class="n">TI_MODE_TRANSITIONING</span><span class="p">;</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Download successful -- Device rebooting...&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>

		<span class="cm">/* return an error on purpose */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">stayinbootmode:</span>
	<span class="cm">/* Eprom is invalid or blank stay in boot mode */</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - STAYING IN BOOT MODE&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">serial</span><span class="o">-&gt;</span><span class="n">product_info</span><span class="p">.</span><span class="n">TiMode</span> <span class="o">=</span> <span class="n">TI_MODE_BOOT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_do_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">feature</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port_number</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>
	<span class="n">on</span> <span class="o">=</span> <span class="o">!!</span><span class="n">on</span><span class="p">;</span>	<span class="cm">/* 1 or 0 not bitmask */</span>
	<span class="k">return</span> <span class="n">send_cmd</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">feature</span><span class="p">,</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">UMPM_UART1_PORT</span> <span class="o">+</span> <span class="n">port_number</span><span class="p">),</span>
			<span class="n">on</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">restore_mcr</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">mcr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - %x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mcr</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_do_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UMPC_SET_CLR_DTR</span><span class="p">,</span> <span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">MCR_DTR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_do_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UMPC_SET_CLR_RTS</span><span class="p">,</span> <span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">MCR_RTS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ti_do_config</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UMPC_SET_CLR_LOOPBACK</span><span class="p">,</span> <span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">MCR_LOOPBACK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Convert TI LSR to standard UART flags */</span>
<span class="k">static</span> <span class="n">__u8</span> <span class="nf">map_line_status</span><span class="p">(</span><span class="n">__u8</span> <span class="n">ti_lsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">lsr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#define MAP_FLAG(flagUmp, flagUart)    \</span>
<span class="cp">	if (ti_lsr &amp; flagUmp) \</span>
<span class="cp">		lsr |= flagUart;</span>

	<span class="n">MAP_FLAG</span><span class="p">(</span><span class="n">UMP_UART_LSR_OV_MASK</span><span class="p">,</span> <span class="n">LSR_OVER_ERR</span><span class="p">)</span>	<span class="cm">/* overrun */</span>
	<span class="n">MAP_FLAG</span><span class="p">(</span><span class="n">UMP_UART_LSR_PE_MASK</span><span class="p">,</span> <span class="n">LSR_PAR_ERR</span><span class="p">)</span>	<span class="cm">/* parity error */</span>
	<span class="n">MAP_FLAG</span><span class="p">(</span><span class="n">UMP_UART_LSR_FE_MASK</span><span class="p">,</span> <span class="n">LSR_FRM_ERR</span><span class="p">)</span>	<span class="cm">/* framing error */</span>
	<span class="n">MAP_FLAG</span><span class="p">(</span><span class="n">UMP_UART_LSR_BR_MASK</span><span class="p">,</span> <span class="n">LSR_BREAK</span><span class="p">)</span>	<span class="cm">/* break detected */</span>
	<span class="n">MAP_FLAG</span><span class="p">(</span><span class="n">UMP_UART_LSR_RX_MASK</span><span class="p">,</span> <span class="n">LSR_RX_AVAIL</span><span class="p">)</span>	<span class="cm">/* rx data available */</span>
	<span class="n">MAP_FLAG</span><span class="p">(</span><span class="n">UMP_UART_LSR_TX_MASK</span><span class="p">,</span> <span class="n">LSR_TX_EMPTY</span><span class="p">)</span>	<span class="cm">/* tx hold reg empty */</span>

<span class="cp">#undef MAP_FLAG</span>

	<span class="k">return</span> <span class="n">lsr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_new_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">msr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="o">*</span><span class="n">icount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - %02x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">msr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EDGEPORT_MSR_DELTA_CTS</span> <span class="o">|</span> <span class="n">EDGEPORT_MSR_DELTA_DSR</span> <span class="o">|</span>
			<span class="n">EDGEPORT_MSR_DELTA_RI</span> <span class="o">|</span> <span class="n">EDGEPORT_MSR_DELTA_CD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>

		<span class="cm">/* update input line counters */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">EDGEPORT_MSR_DELTA_CTS</span><span class="p">)</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">EDGEPORT_MSR_DELTA_DSR</span><span class="p">)</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">EDGEPORT_MSR_DELTA_CD</span><span class="p">)</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">EDGEPORT_MSR_DELTA_RI</span><span class="p">)</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rng</span><span class="o">++</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">delta_msr_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Save the new modem status */</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadow_msr</span> <span class="o">=</span> <span class="n">msr</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="cm">/* handle CTS flow control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="n">C_CRTSCTS</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">EDGEPORT_MSR_CTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_new_lsr</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lsr_data</span><span class="p">,</span>
							<span class="n">__u8</span> <span class="n">lsr</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="o">*</span><span class="n">icount</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">new_lsr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">LSR_OVER_ERR</span> <span class="o">|</span> <span class="n">LSR_PAR_ERR</span> <span class="o">|</span>
						<span class="n">LSR_FRM_ERR</span> <span class="o">|</span> <span class="n">LSR_BREAK</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - %02x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">new_lsr</span><span class="p">);</span>

	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadow_lsr</span> <span class="o">=</span> <span class="n">lsr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_lsr</span> <span class="o">&amp;</span> <span class="n">LSR_BREAK</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * Parity and Framing errors only count if they</span>
<span class="cm">		 * occur exclusive of a break being received.</span>
<span class="cm">		 */</span>
		<span class="n">new_lsr</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">LSR_OVER_ERR</span> <span class="o">|</span> <span class="n">LSR_BREAK</span><span class="p">);</span>

	<span class="cm">/* Place LSR data byte into Rx buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lsr_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">edge_tty_recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* update input line counters */</span>
	<span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_lsr</span> <span class="o">&amp;</span> <span class="n">LSR_BREAK</span><span class="p">)</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_lsr</span> <span class="o">&amp;</span> <span class="n">LSR_OVER_ERR</span><span class="p">)</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_lsr</span> <span class="o">&amp;</span> <span class="n">LSR_PAR_ERR</span><span class="p">)</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_lsr</span> <span class="o">&amp;</span> <span class="n">LSR_FRM_ERR</span><span class="p">)</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_interrupt_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_number</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">function</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">lsr</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">msr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* success */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* this urb is terminated, clean up */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - urb shutting down with status: %d&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - nonzero urb status received: &quot;</span>
			<span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - no data in urb&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - expecting packet of size 2, got %d&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port_number</span> <span class="o">=</span> <span class="n">TIUMP_GET_PORT_FROM_CODE</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">function</span>    <span class="o">=</span> <span class="n">TIUMP_GET_FUNC_FROM_CODE</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port_number %d, function %d, info 0x%x&quot;</span><span class="p">,</span>
	     <span class="n">__func__</span><span class="p">,</span> <span class="n">port_number</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">port_number</span><span class="p">];</span>
	<span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edge_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - edge_port not found&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIUMP_INTERRUPT_CODE_LSR</span>:
		<span class="n">lsr</span> <span class="o">=</span> <span class="n">map_line_status</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UMP_UART_LSR_DATA_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Save the LSR event for bulk read</span>
<span class="cm">			   completion routine */</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - LSR Event Port %u LSR Status = %02x&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">,</span> <span class="n">port_number</span><span class="p">,</span> <span class="n">lsr</span><span class="p">);</span>
			<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">lsr_event</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">lsr_mask</span> <span class="o">=</span> <span class="n">lsr</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - ===== Port %d LSR Status = %02x ======&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">,</span> <span class="n">port_number</span><span class="p">,</span> <span class="n">lsr</span><span class="p">);</span>
			<span class="n">handle_new_lsr</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lsr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TIUMP_INTERRUPT_CODE_MSR</span>:	<span class="cm">/* MSR */</span>
		<span class="cm">/* Copy MSR from UMP */</span>
		<span class="n">msr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - ===== Port %u MSR Status = %02x ======&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">port_number</span><span class="p">,</span> <span class="n">msr</span><span class="p">);</span>
		<span class="n">handle_new_msr</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">msr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - Unknown Interrupt code from UMP %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - usb_submit_urb failed with result %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_bulk_in_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_number</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* success */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* this urb is terminated, clean up */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - urb shutting down with status: %d&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - nonzero read bulk status received: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - stopping read!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port_number</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">lsr_event</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">lsr_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s ===== Port %u LSR Status = %02x, Data = %02x ======&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">port_number</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">lsr_mask</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
		<span class="n">handle_new_lsr</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">lsr_mask</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
		<span class="cm">/* Adjust buffer length/pointer */</span>
		<span class="o">--</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
		<span class="o">++</span><span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">close_pending</span><span class="p">)</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - close pending, dropping data on the floor&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">edge_tty_recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
							<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span> <span class="o">+=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="cm">/* continue read unless stopped */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_read_urb_state</span> <span class="o">==</span> <span class="n">EDGE_READ_URB_RUNNING</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_read_urb_state</span> <span class="o">==</span> <span class="n">EDGE_READ_URB_STOPPING</span><span class="p">)</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_read_urb_state</span> <span class="o">=</span> <span class="n">EDGE_READ_URB_STOPPED</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - usb_submit_urb failed with result %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_tty_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">queued</span><span class="p">;</span>

	<span class="n">queued</span> <span class="o">=</span> <span class="n">tty_insert_flip_string</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queued</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - dropping data, %d bytes lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="n">queued</span><span class="p">);</span>
	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_bulk_out_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_write_urb_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* success */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* this urb is terminated, clean up */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - urb shutting down with status: %d&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err_console</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="s">&quot;%s - nonzero write bulk status &quot;</span>
			<span class="s">&quot;received: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* send any buffered data */</span>
	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">edge_send</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_number</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">open_settings</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">transaction_timeout</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">port_number</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">port_number</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">uart_base</span> <span class="o">=</span> <span class="n">UMPMEM_BASE_UART1</span><span class="p">;</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">dma_address</span> <span class="o">=</span> <span class="n">UMPD_OEDB1_ADDRESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">uart_base</span> <span class="o">=</span> <span class="n">UMPMEM_BASE_UART2</span><span class="p">;</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">dma_address</span> <span class="o">=</span> <span class="n">UMPD_OEDB2_ADDRESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown port number!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port_number = %d, uart_base = %04x, dma_address = %04x&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">port_number</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">uart_base</span><span class="p">,</span>
				<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">dma_address</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">));</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">delta_msr_wait</span><span class="p">);</span>

	<span class="cm">/* turn off loopback */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_do_config</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">UMPC_SET_CLR_LOOPBACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s - cannot send clear loopback command, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set up the port settings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">edge_set_termios</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">);</span>

	<span class="cm">/* open up the port */</span>

	<span class="cm">/* milliseconds to timeout for DMA transfer */</span>
	<span class="n">transaction_timeout</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ump_read_timeout</span> <span class="o">=</span>
				<span class="n">max</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="p">((</span><span class="n">transaction_timeout</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>

	<span class="cm">/* milliseconds to timeout for DMA transfer */</span>
	<span class="n">open_settings</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">UMP_DMA_MODE_CONTINOUS</span> <span class="o">|</span>
			     <span class="n">UMP_PIPE_TRANS_TIMEOUT_ENA</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">transaction_timeout</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - Sending UMPC_OPEN_PORT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Tell TI to open and start the port */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">send_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">UMPC_OPEN_PORT</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">UMPM_UART1_PORT</span> <span class="o">+</span> <span class="n">port_number</span><span class="p">),</span> <span class="n">open_settings</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - cannot send open command, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Start the DMA? */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">send_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">UMPC_START_PORT</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">UMPM_UART1_PORT</span> <span class="o">+</span> <span class="n">port_number</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - cannot send start DMA command, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear TX and RX buffers in UMP */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">purge_port</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UMP_PORT_DIR_OUT</span> <span class="o">|</span> <span class="n">UMP_PORT_DIR_IN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - cannot send clear buffers command, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read Initial MSR */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_vread_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">UMPC_READ_MSR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="p">(</span><span class="n">__u16</span><span class="p">)(</span><span class="n">UMPM_UART1_PORT</span> <span class="o">+</span> <span class="n">port_number</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadow_msr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - cannot send read MSR command, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;ShadowMSR 0x%X&quot;</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadow_msr</span><span class="p">);</span>

	<span class="cm">/* Set Initial MCR */</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadow_mcr</span> <span class="o">=</span> <span class="n">MCR_RTS</span> <span class="o">|</span> <span class="n">MCR_DTR</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;ShadowMCR 0x%X&quot;</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadow_mcr</span><span class="p">);</span>

	<span class="n">edge_serial</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">edge_serial</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">es_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">num_ports_open</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we are the first port to open, post the interrupt urb */</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s - no interrupt urb present, exiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">release_es_lock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">edge_serial</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s - usb_submit_urb failed with value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">release_es_lock</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * reset the data toggle on the bulk endpoints to work around bug in</span>
<span class="cm">	 * host controllers where things get out of sync some times</span>
<span class="cm">	 */</span>
	<span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

	<span class="cm">/* start up our bulk read urb */</span>
	<span class="n">urb</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - no read urb present, exiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlink_int_urb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_read_urb_state</span> <span class="o">=</span> <span class="n">EDGE_READ_URB_RUNNING</span><span class="p">;</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">edge_port</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - read bulk usb_submit_urb failed with value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlink_int_urb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">++</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">num_ports_open</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - exited&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">goto</span> <span class="n">release_es_lock</span><span class="p">;</span>

<span class="nl">unlink_int_urb:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">num_ports_open</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">);</span>
<span class="nl">release_es_lock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">es_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_number</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">edge_serial</span> <span class="o">=</span> <span class="n">usb_get_serial_data</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">);</span>
	<span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_serial</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* The bulkreadcompletion routine will check</span>
<span class="cm">	 * this flag and dump add read data */</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">close_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* chase the port close and flush */</span>
	<span class="n">chase_port</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="n">closing_wait</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="p">);</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_write_urb_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* assuming we can still talk to the device,</span>
<span class="cm">	 * send a close port command to it */</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - send umpc_close_port&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">port_number</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disconnected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">send_cmd</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				     <span class="n">UMPC_CLOSE_PORT</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">UMPM_UART1_PORT</span> <span class="o">+</span> <span class="n">port_number</span><span class="p">),</span>
				     <span class="mi">0</span><span class="p">,</span>
				     <span class="nb">NULL</span><span class="p">,</span>
				     <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">es_lock</span><span class="p">);</span>
	<span class="o">--</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">num_ports_open</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">num_ports_open</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* last port is now closed, let&#39;s shut down our interrupt urb */</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">);</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">num_ports_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">es_lock</span><span class="p">);</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">close_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - exited&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - write request of 0 bytes&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">close_pending</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">kfifo_in_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">);</span>
	<span class="n">edge_send</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>


	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_write_urb_in_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">kfifo_out</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">,</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">bulk_out_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_write_urb_in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>

	<span class="cm">/* set up our urb */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* send the data out the bulk port */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err_console</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
			<span class="s">&quot;%s - failed submitting write urb, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_write_urb_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* TODO: reschedule edge_send */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* wakeup any process waiting for writes to complete */</span>
	<span class="cm">/* there is now more room in the buffer for new writes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">room</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">close_pending</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">room</span> <span class="o">=</span> <span class="n">kfifo_avail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - returns %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">room</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">room</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">chars</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">close_pending</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">chars</span> <span class="o">=</span> <span class="n">kfifo_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - returns %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">chars</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">chars</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* if we are implementing XON/XOFF, send the stop character */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">stop_char</span> <span class="o">=</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">edge_write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stop_char</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - failed to write stop character, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* if we are implementing RTS/CTS, stop reads */</span>
	<span class="cm">/* and the Edgeport will clear the RTS line */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">C_CRTSCTS</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">stop_read</span><span class="p">(</span><span class="n">edge_port</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* if we are implementing XON/XOFF, send the start character */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">start_char</span> <span class="o">=</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">edge_write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start_char</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - failed to write start character, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* if we are implementing RTS/CTS, restart reads */</span>
	<span class="cm">/* are the Edgeport will assert the RTS line */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">C_CRTSCTS</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">restart_read</span><span class="p">(</span><span class="n">edge_port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s - read bulk usb_submit_urb failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_read_urb_state</span> <span class="o">==</span> <span class="n">EDGE_READ_URB_RUNNING</span><span class="p">)</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_read_urb_state</span> <span class="o">=</span> <span class="n">EDGE_READ_URB_STOPPING</span><span class="p">;</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadow_mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MCR_RTS</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">restart_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_read_urb_state</span> <span class="o">==</span> <span class="n">EDGE_READ_URB_STOPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_read_urb_state</span> <span class="o">=</span> <span class="n">EDGE_READ_URB_RUNNING</span><span class="p">;</span>
	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadow_mcr</span> <span class="o">|=</span> <span class="n">MCR_RTS</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">change_port_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ump_uart_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">baud</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_number</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span>
					<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">config</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">config</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span> <span class="o">=</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* These flags must be set */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">|=</span> <span class="n">UMP_MASK_UART_FLAGS_RECEIVE_MS_INT</span><span class="p">;</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">|=</span> <span class="n">UMP_MASK_UART_FLAGS_AUTO_START_ON_ERR</span><span class="p">;</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">bUartMode</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">bUartMode</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS5</span>:
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">bDataBits</span> <span class="o">=</span> <span class="n">UMP_UART_CHAR5BITS</span><span class="p">;</span>
		    <span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - data bits = 5&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS6</span>:
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">bDataBits</span> <span class="o">=</span> <span class="n">UMP_UART_CHAR6BITS</span><span class="p">;</span>
		    <span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - data bits = 6&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>:
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">bDataBits</span> <span class="o">=</span> <span class="n">UMP_UART_CHAR7BITS</span><span class="p">;</span>
		    <span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - data bits = 7&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		    <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">CS8</span>:
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">bDataBits</span> <span class="o">=</span> <span class="n">UMP_UART_CHAR8BITS</span><span class="p">;</span>
		    <span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - data bits = 8&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">|=</span> <span class="n">UMP_MASK_UART_FLAGS_PARITY</span><span class="p">;</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">bParity</span> <span class="o">=</span> <span class="n">UMP_UART_ODDPARITY</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = odd&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">|=</span> <span class="n">UMP_MASK_UART_FLAGS_PARITY</span><span class="p">;</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">bParity</span> <span class="o">=</span> <span class="n">UMP_UART_EVENPARITY</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = even&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">bParity</span> <span class="o">=</span> <span class="n">UMP_UART_NOPARITY</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = none&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">bStopBits</span> <span class="o">=</span> <span class="n">UMP_UART_STOPBIT2</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - stop bits = 2&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">bStopBits</span> <span class="o">=</span> <span class="n">UMP_UART_STOPBIT1</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - stop bits = 1&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* figure out the flow control settings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">|=</span> <span class="n">UMP_MASK_UART_FLAGS_OUT_X_CTS_FLOW</span><span class="p">;</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">|=</span> <span class="n">UMP_MASK_UART_FLAGS_RTS_FLOW</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - RTS/CTS is enabled&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - RTS/CTS is disabled&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">restart_read</span><span class="p">(</span><span class="n">edge_port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* if we are implementing XON/XOFF, set the start and stop</span>
<span class="cm">	   character in the device */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">cXon</span>  <span class="o">=</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">cXoff</span> <span class="o">=</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="cm">/* if we are implementing INBOUND XON/XOFF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">|=</span> <span class="n">UMP_MASK_UART_FLAGS_IN_X</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - INBOUND XON/XOFF is enabled, XON = %2x, XOFF = %2x&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">cXon</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">cXoff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - INBOUND XON/XOFF is disabled&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* if we are implementing OUTBOUND XON/XOFF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXON</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">|=</span> <span class="n">UMP_MASK_UART_FLAGS_OUT_X</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - OUTBOUND XON/XOFF is enabled, XON = %2x, XOFF = %2x&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">cXon</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">cXoff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - OUTBOUND XON/XOFF is disabled&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CMSPAR</span><span class="p">;</span>

	<span class="cm">/* Round the baud rate */</span>
	<span class="n">baud</span> <span class="o">=</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">baud</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* pick a default, any default... */</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tty_encode_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">baud_rate</span> <span class="o">=</span> <span class="n">baud</span><span class="p">;</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">wBaudRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)((</span><span class="mi">461550L</span> <span class="o">+</span> <span class="n">baud</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">baud</span><span class="p">);</span>

	<span class="cm">/* FIXME: Recompute actual baud from divisor here */</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - baud rate = %d, wBaudRate = %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span>
							<span class="n">config</span><span class="o">-&gt;</span><span class="n">wBaudRate</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;wBaudRate:   %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="mi">461550L</span> <span class="o">/</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">wBaudRate</span><span class="p">));</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;wFlags:    0x%x&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bDataBits:   %d&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">bDataBits</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bParity:     %d&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">bParity</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bStopBits:   %d&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">bStopBits</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;cXon:        %d&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">cXon</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;cXoff:       %d&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">cXoff</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bUartMode:   %d&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">bUartMode</span><span class="p">);</span>

	<span class="cm">/* move the word values into big endian mode */</span>
	<span class="n">cpu_to_be16s</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span><span class="p">);</span>
	<span class="n">cpu_to_be16s</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">wBaudRate</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">send_cmd</span><span class="p">(</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">UMPC_SET_CONFIG</span><span class="p">,</span>
				<span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">UMPM_UART1_PORT</span> <span class="o">+</span> <span class="n">port_number</span><span class="p">),</span>
				<span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">config</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - error %d when trying to write config to device&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflag</span><span class="p">;</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - clfag %08x iflag %08x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - old clfag %08x old iflag %08x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* change the port settings to the new ones specified */</span>
	<span class="n">change_port_settings</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">edge_port</span><span class="p">,</span> <span class="n">old_termios</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mcr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mcr</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadow_mcr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">MCR_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">MCR_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_LOOP</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">MCR_LOOPBACK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MCR_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MCR_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_LOOP</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MCR_LOOPBACK</span><span class="p">;</span>

	<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadow_mcr</span> <span class="o">=</span> <span class="n">mcr</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">restore_mcr</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">mcr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mcr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">msr</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadow_msr</span><span class="p">;</span>
	<span class="n">mcr</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">shadow_mcr</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">MCR_DTR</span><span class="p">)</span>	<span class="o">?</span> <span class="n">TIOCM_DTR</span><span class="o">:</span> <span class="mi">0</span><span class="p">)</span>	  <span class="cm">/* 0x002 */</span>
		  <span class="o">|</span> <span class="p">((</span><span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">MCR_RTS</span><span class="p">)</span>	<span class="o">?</span> <span class="n">TIOCM_RTS</span><span class="o">:</span> <span class="mi">0</span><span class="p">)</span>   <span class="cm">/* 0x004 */</span>
		  <span class="o">|</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">EDGEPORT_MSR_CTS</span><span class="p">)</span>	<span class="o">?</span> <span class="n">TIOCM_CTS</span><span class="o">:</span> <span class="mi">0</span><span class="p">)</span>   <span class="cm">/* 0x020 */</span>
		  <span class="o">|</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">EDGEPORT_MSR_CD</span><span class="p">)</span>	<span class="o">?</span> <span class="n">TIOCM_CAR</span><span class="o">:</span> <span class="mi">0</span><span class="p">)</span>   <span class="cm">/* 0x040 */</span>
		  <span class="o">|</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">EDGEPORT_MSR_RI</span><span class="p">)</span>	<span class="o">?</span> <span class="n">TIOCM_RI</span><span class="o">:</span>  <span class="mi">0</span><span class="p">)</span>   <span class="cm">/* 0x080 */</span>
		  <span class="o">|</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">EDGEPORT_MSR_DSR</span><span class="p">)</span>	<span class="o">?</span> <span class="n">TIOCM_DSR</span><span class="o">:</span> <span class="mi">0</span><span class="p">);</span>  <span class="cm">/* 0x100 */</span>


	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s -- %x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_get_icount</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">serial_icounter_struct</span> <span class="o">*</span><span class="n">icount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="o">*</span><span class="n">ic</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>

	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">cts</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rng</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">dcd</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">;</span>
        <span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">;</span>
        <span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">;</span>
        <span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parity</span><span class="p">;</span>
        <span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">overrun</span><span class="p">;</span>
        <span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">brk</span><span class="p">;</span>
        <span class="n">icount</span><span class="o">-&gt;</span><span class="n">buf_overrun</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">buf_overrun</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">retinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retinfo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>

	<span class="n">tmp</span><span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PORT_16550A</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">line</span>		<span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">port</span>		<span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">irq</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">ASYNC_SKIP_TEST</span> <span class="o">|</span> <span class="n">ASYNC_AUTO_IRQ</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">xmit_fifo_size</span>	<span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">bulk_out_size</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">baud_base</span>		<span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">close_delay</span>		<span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">closing_wait</span>	<span class="o">=</span> <span class="n">closing_wait</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">retinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">retinfo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cprev</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d, cmd = 0x%x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIOCGSERIAL</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - (%d) TIOCGSERIAL&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">get_serial_info</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TIOCMIWAIT</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - (%d) TIOCMIWAIT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">cprev</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">delta_msr_wait</span><span class="p">);</span>
			<span class="cm">/* see if a signal did it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="n">cnow</span> <span class="o">=</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span> <span class="cm">/* no change =&gt; error */</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_RNG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_DSR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CD</span><span class="p">)</span>  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cprev</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* not reached */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Off */</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - state = %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">break_state</span><span class="p">);</span>

	<span class="cm">/* chase the port close */</span>
	<span class="n">chase_port</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">bv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* On */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_do_config</span><span class="p">(</span><span class="n">edge_port</span><span class="p">,</span> <span class="n">UMPC_SET_CLR_BREAK</span><span class="p">,</span> <span class="n">bv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - error %d sending break set/clear command.&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edgeport_serial</span> <span class="o">*</span><span class="n">edge_serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* create our private serial structure */</span>
	<span class="n">edge_serial</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_serial</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_serial</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">es_lock</span><span class="p">);</span>
	<span class="n">edge_serial</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">=</span> <span class="n">serial</span><span class="p">;</span>
	<span class="n">usb_set_serial_data</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">edge_serial</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">download_fw</span><span class="p">(</span><span class="n">edge_serial</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">edge_serial</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set up our port private structures */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">edge_port</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">edgeport_port</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edge_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">ep_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">,</span> <span class="n">EDGE_OUT_BUF_SIZE</span><span class="p">,</span>
								<span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">edge_port</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">edge_serial</span> <span class="o">=</span> <span class="n">edge_serial</span><span class="p">;</span>
		<span class="n">usb_set_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">edge_port</span><span class="p">);</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">bUartMode</span> <span class="o">=</span> <span class="n">default_uart_mode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="k">for</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">kfifo_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">edge_port</span><span class="p">);</span>
		<span class="n">usb_set_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">edge_serial</span><span class="p">);</span>
	<span class="n">usb_set_serial_data</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">edge_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">kfifo_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">edge_port</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">usb_get_serial_data</span><span class="p">(</span><span class="n">serial</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/* Sysfs Attributes */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_uart_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">to_usb_serial_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">bUartMode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_uart_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">valbuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">to_usb_serial_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">edgeport_port</span> <span class="o">*</span><span class="n">edge_port</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">valbuf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: setting uart_mode = %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span>
		<span class="n">edge_port</span><span class="o">-&gt;</span><span class="n">bUartMode</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - uart_mode %d is invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">uart_mode</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_uart_mode</span><span class="p">,</span>
							<span class="n">store_uart_mode</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_create_sysfs_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_uart_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edge_remove_sysfs_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_uart_mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="n">edgeport_1port_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;edgeport_ti_1&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">description</span>		<span class="o">=</span> <span class="s">&quot;Edgeport TI 1 port adapter&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>		<span class="o">=</span> <span class="n">edgeport_1port_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_ports</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">edge_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>			<span class="o">=</span> <span class="n">edge_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span>		<span class="o">=</span> <span class="n">edge_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span>		<span class="o">=</span> <span class="n">edge_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>			<span class="o">=</span> <span class="n">edge_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>		<span class="o">=</span> <span class="n">edge_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">edge_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_probe</span>		<span class="o">=</span> <span class="n">edge_create_sysfs_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_remove</span>		<span class="o">=</span> <span class="n">edge_remove_sysfs_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>			<span class="o">=</span> <span class="n">edge_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span>		<span class="o">=</span> <span class="n">edge_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span>		<span class="o">=</span> <span class="n">edge_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span>		<span class="o">=</span> <span class="n">edge_tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_icount</span>		<span class="o">=</span> <span class="n">edge_get_icount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>			<span class="o">=</span> <span class="n">edge_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span>		<span class="o">=</span> <span class="n">edge_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span>	<span class="o">=</span> <span class="n">edge_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span>		<span class="o">=</span> <span class="n">edge_break</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_int_callback</span>	<span class="o">=</span> <span class="n">edge_interrupt_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_bulk_callback</span>	<span class="o">=</span> <span class="n">edge_bulk_in_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_bulk_callback</span>	<span class="o">=</span> <span class="n">edge_bulk_out_callback</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="n">edgeport_2port_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;edgeport_ti_2&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">description</span>		<span class="o">=</span> <span class="s">&quot;Edgeport TI 2 port adapter&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>		<span class="o">=</span> <span class="n">edgeport_2port_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_ports</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">edge_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>			<span class="o">=</span> <span class="n">edge_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span>		<span class="o">=</span> <span class="n">edge_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span>		<span class="o">=</span> <span class="n">edge_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>			<span class="o">=</span> <span class="n">edge_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>		<span class="o">=</span> <span class="n">edge_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">edge_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_probe</span>		<span class="o">=</span> <span class="n">edge_create_sysfs_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_remove</span>		<span class="o">=</span> <span class="n">edge_remove_sysfs_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>			<span class="o">=</span> <span class="n">edge_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span>		<span class="o">=</span> <span class="n">edge_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span>		<span class="o">=</span> <span class="n">edge_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span>		<span class="o">=</span> <span class="n">edge_tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>			<span class="o">=</span> <span class="n">edge_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span>		<span class="o">=</span> <span class="n">edge_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span>	<span class="o">=</span> <span class="n">edge_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span>		<span class="o">=</span> <span class="n">edge_break</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_int_callback</span>	<span class="o">=</span> <span class="n">edge_interrupt_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_bulk_callback</span>	<span class="o">=</span> <span class="n">edge_bulk_in_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_bulk_callback</span>	<span class="o">=</span> <span class="n">edge_bulk_out_callback</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="o">*</span> <span class="k">const</span> <span class="n">serial_drivers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">edgeport_1port_device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edgeport_2port_device</span><span class="p">,</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="n">module_usb_serial_driver</span><span class="p">(</span><span class="n">serial_drivers</span><span class="p">,</span> <span class="n">id_table_combined</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;edgeport/down3.bin&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug enabled or not&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">closing_wait</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">closing_wait</span><span class="p">,</span> <span class="s">&quot;Maximum wait for data to drain, in .01 secs&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">ignore_cpu_rev</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ignore_cpu_rev</span><span class="p">,</span>
			<span class="s">&quot;Ignore the cpu revision when connecting to a device&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">default_uart_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">default_uart_mode</span><span class="p">,</span> <span class="s">&quot;Default uart_mode, 0=RS232, ...&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
