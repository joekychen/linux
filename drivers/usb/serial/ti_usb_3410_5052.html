<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › serial › ti_usb_3410_5052.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ti_usb_3410_5052.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* vi: ts=8 sw=8</span>
<span class="cm"> *</span>
<span class="cm"> * TI 3410/5052 USB Serial Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004 Texas Instruments</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is based on the Linux io_ti driver, which is</span>
<span class="cm"> *   Copyright (C) 2000-2002 Inside Out Networks</span>
<span class="cm"> *   Copyright (C) 2001-2002 Greg Kroah-Hartman</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * For questions or problems with this driver, contact Texas Instruments</span>
<span class="cm"> * technical support, or Al Borchers &lt;alborchers@steinerpoint.com&gt;, or</span>
<span class="cm"> * Peter Berger &lt;pberger@brimson.com&gt;.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_driver.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/kfifo.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/serial.h&gt;</span>

<span class="cp">#include &quot;ti_usb_3410_5052.h&quot;</span>

<span class="cm">/* Defines */</span>

<span class="cp">#define TI_DRIVER_VERSION	&quot;v0.10&quot;</span>
<span class="cp">#define TI_DRIVER_AUTHOR	&quot;Al Borchers &lt;alborchers@steinerpoint.com&gt;&quot;</span>
<span class="cp">#define TI_DRIVER_DESC		&quot;TI USB 3410/5052 Serial Driver&quot;</span>

<span class="cp">#define TI_FIRMWARE_BUF_SIZE	16284</span>

<span class="cp">#define TI_WRITE_BUF_SIZE	1024</span>

<span class="cp">#define TI_TRANSFER_TIMEOUT	2</span>

<span class="cp">#define TI_DEFAULT_CLOSING_WAIT	4000		</span><span class="cm">/* in .01 secs */</span><span class="cp"></span>

<span class="cm">/* supported setserial flags */</span>
<span class="cp">#define TI_SET_SERIAL_FLAGS	0</span>

<span class="cm">/* read urb states */</span>
<span class="cp">#define TI_READ_URB_RUNNING	0</span>
<span class="cp">#define TI_READ_URB_STOPPING	1</span>
<span class="cp">#define TI_READ_URB_STOPPED	2</span>

<span class="cp">#define TI_EXTRA_VID_PID_COUNT	5</span>


<span class="cm">/* Structures */</span>

<span class="k">struct</span> <span class="n">ti_port</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">tp_is_open</span><span class="p">;</span>
	<span class="n">__u8</span>			<span class="n">tp_msr</span><span class="p">;</span>
	<span class="n">__u8</span>			<span class="n">tp_lsr</span><span class="p">;</span>
	<span class="n">__u8</span>			<span class="n">tp_shadow_mcr</span><span class="p">;</span>
	<span class="n">__u8</span>			<span class="n">tp_uart_mode</span><span class="p">;</span>	<span class="cm">/* 232 or 485 modes */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">tp_uart_base_addr</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tp_flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tp_closing_wait</span><span class="p">;</span><span class="cm">/* in .01 secs */</span>
	<span class="k">struct</span> <span class="n">async_icount</span>	<span class="n">tp_icount</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">tp_msr_wait</span><span class="p">;</span>	<span class="cm">/* wait for msr change */</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">tp_write_wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_device</span>	<span class="o">*</span><span class="n">tp_tdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span>	<span class="o">*</span><span class="n">tp_port</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">tp_lock</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tp_read_urb_state</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tp_write_urb_in_use</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kfifo</span>		<span class="n">write_fifo</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ti_device</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">td_open_close_lock</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">td_open_port_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial</span>	<span class="o">*</span><span class="n">td_serial</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">td_is_3410</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">td_urb_error</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/* Function Declarations */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ti_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ti_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ti_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ti_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_get_icount</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">serial_icounter_struct</span> <span class="o">*</span><span class="n">icount</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ti_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ti_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ti_interrupt_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ti_bulk_in_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ti_bulk_out_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ti_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ti_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_set_mcr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mcr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_get_lsr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_get_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ret_arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_set_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">new_arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ti_handle_new_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">msr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ti_drain</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flush</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ti_stop_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_restart_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_command_out_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_device</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">command</span><span class="p">,</span>
	<span class="n">__u16</span> <span class="n">moduleid</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_command_in_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_device</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">command</span><span class="p">,</span>
	<span class="n">__u16</span> <span class="n">moduleid</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_write_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_device</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
	<span class="n">__u8</span> <span class="n">mask</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">byte</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ti_download_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_device</span> <span class="o">*</span><span class="n">tdev</span><span class="p">);</span>


<span class="cm">/* Data */</span>

<span class="cm">/* module parameters */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">closing_wait</span> <span class="o">=</span> <span class="n">TI_DEFAULT_CLOSING_WAIT</span><span class="p">;</span>
<span class="k">static</span> <span class="n">ushort</span> <span class="n">vendor_3410</span><span class="p">[</span><span class="n">TI_EXTRA_VID_PID_COUNT</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vendor_3410_count</span><span class="p">;</span>
<span class="k">static</span> <span class="n">ushort</span> <span class="n">product_3410</span><span class="p">[</span><span class="n">TI_EXTRA_VID_PID_COUNT</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">product_3410_count</span><span class="p">;</span>
<span class="k">static</span> <span class="n">ushort</span> <span class="n">vendor_5052</span><span class="p">[</span><span class="n">TI_EXTRA_VID_PID_COUNT</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vendor_5052_count</span><span class="p">;</span>
<span class="k">static</span> <span class="n">ushort</span> <span class="n">product_5052</span><span class="p">[</span><span class="n">TI_EXTRA_VID_PID_COUNT</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">product_5052_count</span><span class="p">;</span>

<span class="cm">/* supported devices */</span>
<span class="cm">/* the array dimension is the number of default entries plus */</span>
<span class="cm">/* TI_EXTRA_VID_PID_COUNT user defined entries plus 1 terminating */</span>
<span class="cm">/* null entry */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">ti_id_table_3410</span><span class="p">[</span><span class="mi">15</span><span class="o">+</span><span class="n">TI_EXTRA_VID_PID_COUNT</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">TI_VENDOR_ID</span><span class="p">,</span> <span class="n">TI_3410_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">TI_VENDOR_ID</span><span class="p">,</span> <span class="n">TI_3410_EZ430_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MTS_VENDOR_ID</span><span class="p">,</span> <span class="n">MTS_GSM_NO_FW_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MTS_VENDOR_ID</span><span class="p">,</span> <span class="n">MTS_CDMA_NO_FW_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MTS_VENDOR_ID</span><span class="p">,</span> <span class="n">MTS_CDMA_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MTS_VENDOR_ID</span><span class="p">,</span> <span class="n">MTS_GSM_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MTS_VENDOR_ID</span><span class="p">,</span> <span class="n">MTS_EDGE_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MTS_VENDOR_ID</span><span class="p">,</span> <span class="n">MTS_MT9234MU_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MTS_VENDOR_ID</span><span class="p">,</span> <span class="n">MTS_MT9234ZBA_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MTS_VENDOR_ID</span><span class="p">,</span> <span class="n">MTS_MT9234ZBAOLD_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">IBM_VENDOR_ID</span><span class="p">,</span> <span class="n">IBM_4543_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">IBM_VENDOR_ID</span><span class="p">,</span> <span class="n">IBM_454B_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">IBM_VENDOR_ID</span><span class="p">,</span> <span class="n">IBM_454C_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ABBOTT_VENDOR_ID</span><span class="p">,</span> <span class="n">ABBOTT_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">TI_VENDOR_ID</span><span class="p">,</span> <span class="n">FRI2_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">ti_id_table_5052</span><span class="p">[</span><span class="mi">5</span><span class="o">+</span><span class="n">TI_EXTRA_VID_PID_COUNT</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">TI_VENDOR_ID</span><span class="p">,</span> <span class="n">TI_5052_BOOT_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">TI_VENDOR_ID</span><span class="p">,</span> <span class="n">TI_5152_BOOT_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">TI_VENDOR_ID</span><span class="p">,</span> <span class="n">TI_5052_EEPROM_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">TI_VENDOR_ID</span><span class="p">,</span> <span class="n">TI_5052_FIRMWARE_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">ti_id_table_combined</span><span class="p">[</span><span class="mi">19</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">TI_EXTRA_VID_PID_COUNT</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">TI_VENDOR_ID</span><span class="p">,</span> <span class="n">TI_3410_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">TI_VENDOR_ID</span><span class="p">,</span> <span class="n">TI_3410_EZ430_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MTS_VENDOR_ID</span><span class="p">,</span> <span class="n">MTS_GSM_NO_FW_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MTS_VENDOR_ID</span><span class="p">,</span> <span class="n">MTS_CDMA_NO_FW_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MTS_VENDOR_ID</span><span class="p">,</span> <span class="n">MTS_CDMA_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MTS_VENDOR_ID</span><span class="p">,</span> <span class="n">MTS_GSM_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MTS_VENDOR_ID</span><span class="p">,</span> <span class="n">MTS_EDGE_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MTS_VENDOR_ID</span><span class="p">,</span> <span class="n">MTS_MT9234MU_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MTS_VENDOR_ID</span><span class="p">,</span> <span class="n">MTS_MT9234ZBA_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">MTS_VENDOR_ID</span><span class="p">,</span> <span class="n">MTS_MT9234ZBAOLD_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">TI_VENDOR_ID</span><span class="p">,</span> <span class="n">TI_5052_BOOT_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">TI_VENDOR_ID</span><span class="p">,</span> <span class="n">TI_5152_BOOT_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">TI_VENDOR_ID</span><span class="p">,</span> <span class="n">TI_5052_EEPROM_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">TI_VENDOR_ID</span><span class="p">,</span> <span class="n">TI_5052_FIRMWARE_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">IBM_VENDOR_ID</span><span class="p">,</span> <span class="n">IBM_4543_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">IBM_VENDOR_ID</span><span class="p">,</span> <span class="n">IBM_454B_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">IBM_VENDOR_ID</span><span class="p">,</span> <span class="n">IBM_454C_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ABBOTT_VENDOR_ID</span><span class="p">,</span> <span class="n">ABBOTT_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">TI_VENDOR_ID</span><span class="p">,</span> <span class="n">FRI2_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="n">ti_1port_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ti_usb_3410_5052_1&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">description</span>		<span class="o">=</span> <span class="s">&quot;TI USB 3410 1 port adapter&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>		<span class="o">=</span> <span class="n">ti_id_table_3410</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_ports</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>			<span class="o">=</span> <span class="n">ti_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">ti_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">ti_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>			<span class="o">=</span> <span class="n">ti_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>			<span class="o">=</span> <span class="n">ti_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span>		<span class="o">=</span> <span class="n">ti_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span>	<span class="o">=</span> <span class="n">ti_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span>		<span class="o">=</span> <span class="n">ti_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span>		<span class="o">=</span> <span class="n">ti_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>			<span class="o">=</span> <span class="n">ti_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span>		<span class="o">=</span> <span class="n">ti_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span>		<span class="o">=</span> <span class="n">ti_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span>		<span class="o">=</span> <span class="n">ti_tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_icount</span>		<span class="o">=</span> <span class="n">ti_get_icount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span>		<span class="o">=</span> <span class="n">ti_break</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_int_callback</span>	<span class="o">=</span> <span class="n">ti_interrupt_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_bulk_callback</span>	<span class="o">=</span> <span class="n">ti_bulk_in_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_bulk_callback</span>	<span class="o">=</span> <span class="n">ti_bulk_out_callback</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="n">ti_2port_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ti_usb_3410_5052_2&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">description</span>		<span class="o">=</span> <span class="s">&quot;TI USB 5052 2 port adapter&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>		<span class="o">=</span> <span class="n">ti_id_table_5052</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_ports</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>			<span class="o">=</span> <span class="n">ti_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">ti_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">ti_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>			<span class="o">=</span> <span class="n">ti_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>			<span class="o">=</span> <span class="n">ti_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span>		<span class="o">=</span> <span class="n">ti_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span>	<span class="o">=</span> <span class="n">ti_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span>		<span class="o">=</span> <span class="n">ti_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span>		<span class="o">=</span> <span class="n">ti_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>			<span class="o">=</span> <span class="n">ti_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span>		<span class="o">=</span> <span class="n">ti_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span>		<span class="o">=</span> <span class="n">ti_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span>		<span class="o">=</span> <span class="n">ti_tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_icount</span>		<span class="o">=</span> <span class="n">ti_get_icount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span>		<span class="o">=</span> <span class="n">ti_break</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_int_callback</span>	<span class="o">=</span> <span class="n">ti_interrupt_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_bulk_callback</span>	<span class="o">=</span> <span class="n">ti_bulk_in_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_bulk_callback</span>	<span class="o">=</span> <span class="n">ti_bulk_out_callback</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="o">*</span> <span class="k">const</span> <span class="n">serial_drivers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">ti_1port_device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti_2port_device</span><span class="p">,</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="cm">/* Module */</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">TI_DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">TI_DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">TI_DRIVER_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;ti_3410.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;ti_5052.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;mts_cdma.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;mts_gsm.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;mts_edge.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;mts_mt9234mu.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;mts_mt9234zba.fw&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Enable debugging, 0=no, 1=yes&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">closing_wait</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">closing_wait</span><span class="p">,</span>
    <span class="s">&quot;Maximum wait for data to drain in close, in .01 secs, default is 4000&quot;</span><span class="p">);</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">vendor_3410</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vendor_3410_count</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vendor_3410</span><span class="p">,</span>
		<span class="s">&quot;Vendor ids for 3410 based devices, 1-5 short integers&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">product_3410</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">product_3410_count</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">product_3410</span><span class="p">,</span>
		<span class="s">&quot;Product ids for 3410 based devices, 1-5 short integers&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">vendor_5052</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vendor_5052_count</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vendor_5052</span><span class="p">,</span>
		<span class="s">&quot;Vendor ids for 5052 based devices, 1-5 short integers&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">product_5052</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">product_5052_count</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">product_5052</span><span class="p">,</span>
		<span class="s">&quot;Product ids for 5052 based devices, 1-5 short integers&quot;</span><span class="p">);</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">ti_id_table_combined</span><span class="p">);</span>


<span class="cm">/* Functions */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ti_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* insert extra vendor and product ids */</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ti_id_table_combined</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">TI_EXTRA_VID_PID_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">j</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ti_id_table_3410</span><span class="p">)</span> <span class="o">-</span> <span class="n">TI_EXTRA_VID_PID_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">(</span><span class="n">vendor_3410_count</span><span class="p">,</span> <span class="n">product_3410_count</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ti_id_table_3410</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">idVendor</span> <span class="o">=</span> <span class="n">vendor_3410</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ti_id_table_3410</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">idProduct</span> <span class="o">=</span> <span class="n">product_3410</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ti_id_table_3410</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">match_flags</span> <span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span><span class="p">;</span>
		<span class="n">ti_id_table_combined</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">idVendor</span> <span class="o">=</span> <span class="n">vendor_3410</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ti_id_table_combined</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">idProduct</span> <span class="o">=</span> <span class="n">product_3410</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ti_id_table_combined</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">match_flags</span> <span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">j</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ti_id_table_5052</span><span class="p">)</span> <span class="o">-</span> <span class="n">TI_EXTRA_VID_PID_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">(</span><span class="n">vendor_5052_count</span><span class="p">,</span> <span class="n">product_5052_count</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ti_id_table_5052</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">idVendor</span> <span class="o">=</span> <span class="n">vendor_5052</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ti_id_table_5052</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">idProduct</span> <span class="o">=</span> <span class="n">product_5052</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ti_id_table_5052</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">match_flags</span> <span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span><span class="p">;</span>
		<span class="n">ti_id_table_combined</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">idVendor</span> <span class="o">=</span> <span class="n">vendor_5052</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ti_id_table_combined</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">idProduct</span> <span class="o">=</span> <span class="n">product_5052</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ti_id_table_combined</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">match_flags</span> <span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_serial_register_drivers</span><span class="p">(</span><span class="n">serial_drivers</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">ti_id_table_combined</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">KBUILD_MODNAME</span> <span class="s">&quot;: &quot;</span> <span class="n">TI_DRIVER_VERSION</span> <span class="s">&quot;:&quot;</span>
			       <span class="n">TI_DRIVER_DESC</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ti_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_serial_deregister_drivers</span><span class="p">(</span><span class="n">serial_drivers</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ti_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ti_exit</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ti_device</span> <span class="o">*</span><span class="n">tdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>


	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - product 0x%4X, num configurations %d, configuration value %d&quot;</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">),</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">bNumConfigurations</span><span class="p">,</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">actconfig</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bConfigurationValue</span><span class="p">);</span>

	<span class="cm">/* create device structure */</span>
	<span class="n">tdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_open_close_lock</span><span class="p">);</span>
	<span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_serial</span> <span class="o">=</span> <span class="n">serial</span><span class="p">;</span>
	<span class="n">usb_set_serial_data</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">tdev</span><span class="p">);</span>

	<span class="cm">/* determine device type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_match_id</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">,</span> <span class="n">ti_id_table_3410</span><span class="p">))</span>
		<span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_is_3410</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - device type is %s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_is_3410</span> <span class="o">?</span> <span class="s">&quot;3410&quot;</span> <span class="o">:</span> <span class="s">&quot;5052&quot;</span><span class="p">);</span>

	<span class="cm">/* if we have only 1 configuration, download firmware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">bNumConfigurations</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ti_download_firmware</span><span class="p">(</span><span class="n">tdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">free_tdev</span><span class="p">;</span>

		<span class="cm">/* 3410 must be reset, 5052 resets itself */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_is_3410</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="n">usb_reset_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_tdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the second configuration must be set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">actconfig</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bConfigurationValue</span> <span class="o">==</span> <span class="n">TI_BOOT_CONFIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_driver_set_configuration</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TI_ACTIVE_CONFIG</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">status</span> <span class="o">?</span> <span class="n">status</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_tdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set up port structures */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tport</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_tports</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">);</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_uart_base_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span>
				<span class="n">TI_UART1_BASE_ADDR</span> <span class="o">:</span> <span class="n">TI_UART2_BASE_ADDR</span><span class="p">);</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_closing_wait</span> <span class="o">=</span> <span class="n">closing_wait</span><span class="p">;</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_msr_wait</span><span class="p">);</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_write_wait</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">,</span> <span class="n">TI_WRITE_BUF_SIZE</span><span class="p">,</span>
								<span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tport</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_tports</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_port</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_tdev</span> <span class="o">=</span> <span class="n">tdev</span><span class="p">;</span>
		<span class="n">usb_set_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tport</span><span class="p">);</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_uart_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* default is RS232 */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_tports:</span>
	<span class="k">for</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tport</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">kfifo_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tport</span><span class="p">);</span>
		<span class="n">usb_set_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">free_tdev:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tdev</span><span class="p">);</span>
	<span class="n">usb_set_serial_data</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_device</span> <span class="o">*</span><span class="n">tdev</span> <span class="o">=</span> <span class="n">usb_get_serial_data</span><span class="p">(</span><span class="n">serial</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tport</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tport</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfifo_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tport</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">tdev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ti_device</span> <span class="o">*</span><span class="n">tdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_number</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">open_settings</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">TI_PIPE_MODE_CONTINOUS</span> <span class="o">|</span>
			     <span class="n">TI_PIPE_TIMEOUT_ENABLE</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">TI_TRANSFER_TIMEOUT</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">tdev</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_tdev</span><span class="p">;</span>

	<span class="cm">/* only one open on any port on a device at a time */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_open_close_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">port_number</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_icount</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_icount</span><span class="p">));</span>

	<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_msr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_shadow_mcr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">TI_MCR_RTS</span> <span class="o">|</span> <span class="n">TI_MCR_DTR</span><span class="p">);</span>

	<span class="cm">/* start interrupt urb the first time a port is opened on this device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_open_port_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - start interrupt in urb&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - no interrupt urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">release_lock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">tdev</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s - submit interrupt urb failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">release_lock</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">ti_set_termios</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - sending TI_OPEN_PORT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_command_out_sync</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">TI_OPEN_PORT</span><span class="p">,</span>
		<span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">TI_UART1_PORT</span> <span class="o">+</span> <span class="n">port_number</span><span class="p">),</span> <span class="n">open_settings</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - cannot send open command, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlink_int_urb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - sending TI_START_PORT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_command_out_sync</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">TI_START_PORT</span><span class="p">,</span>
		<span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">TI_UART1_PORT</span> <span class="o">+</span> <span class="n">port_number</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - cannot send start command, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlink_int_urb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - sending TI_PURGE_PORT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_command_out_sync</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">TI_PURGE_PORT</span><span class="p">,</span>
		<span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">TI_UART1_PORT</span> <span class="o">+</span> <span class="n">port_number</span><span class="p">),</span> <span class="n">TI_PURGE_INPUT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - cannot clear input buffers, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlink_int_urb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_command_out_sync</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">TI_PURGE_PORT</span><span class="p">,</span>
		<span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">TI_UART1_PORT</span> <span class="o">+</span> <span class="n">port_number</span><span class="p">),</span> <span class="n">TI_PURGE_OUTPUT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - cannot clear output buffers, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlink_int_urb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reset the data toggle on the bulk endpoints to work around bug in</span>
<span class="cm">	 * host controllers where things get out of sync some times */</span>
	<span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">ti_set_termios</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - sending TI_OPEN_PORT (2)&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_command_out_sync</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">TI_OPEN_PORT</span><span class="p">,</span>
		<span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">TI_UART1_PORT</span> <span class="o">+</span> <span class="n">port_number</span><span class="p">),</span> <span class="n">open_settings</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - cannot send open command (2), %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlink_int_urb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - sending TI_START_PORT (2)&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_command_out_sync</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">TI_START_PORT</span><span class="p">,</span>
		<span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">TI_UART1_PORT</span> <span class="o">+</span> <span class="n">port_number</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - cannot send start command (2), %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlink_int_urb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* start read urb */</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - start read urb&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">urb</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - no read urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlink_int_urb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_read_urb_state</span> <span class="o">=</span> <span class="n">TI_READ_URB_RUNNING</span><span class="p">;</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">tport</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - submit read urb failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlink_int_urb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_is_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="o">++</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_open_port_count</span><span class="p">;</span>

	<span class="k">goto</span> <span class="n">release_lock</span><span class="p">;</span>

<span class="nl">unlink_int_urb:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_open_port_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">);</span>
<span class="nl">release_lock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_open_close_lock</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - exit %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ti_device</span> <span class="o">*</span><span class="n">tdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_number</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_unlock</span><span class="p">;</span>

	<span class="n">tdev</span> <span class="o">=</span> <span class="n">usb_get_serial_data</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">);</span>
	<span class="n">tport</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tdev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">tport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_is_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ti_drain</span><span class="p">(</span><span class="n">tport</span><span class="p">,</span> <span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_closing_wait</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="p">);</span>
	<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_write_urb_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">port_number</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - sending TI_CLOSE_PORT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_command_out_sync</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">TI_CLOSE_PORT</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">TI_UART1_PORT</span> <span class="o">+</span> <span class="n">port_number</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - cannot send close port command, %d</span><span class="se">\n</span><span class="s">&quot;</span>
							<span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="cm">/* if mutex_lock is interrupted, continue anyway */</span>
	<span class="n">do_unlock</span> <span class="o">=</span> <span class="o">!</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_open_close_lock</span><span class="p">);</span>
	<span class="o">--</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_tdev</span><span class="o">-&gt;</span><span class="n">td_open_port_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_tdev</span><span class="o">-&gt;</span><span class="n">td_open_port_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* last port is closed, shut down interrupt urb */</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">);</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_tdev</span><span class="o">-&gt;</span><span class="n">td_open_port_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_unlock</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_open_close_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - write request of 0 bytes&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tport</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_is_open</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">kfifo_in_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">);</span>
	<span class="n">ti_send</span><span class="p">(</span><span class="n">tport</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">room</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">room</span> <span class="o">=</span> <span class="n">kfifo_avail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - returns %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">room</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">room</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">chars</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">chars</span> <span class="o">=</span> <span class="n">kfifo_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - returns %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">chars</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">chars</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">C_CRTSCTS</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">ti_stop_read</span><span class="p">(</span><span class="n">tport</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">C_CRTSCTS</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ti_restart_read</span><span class="p">(</span><span class="n">tport</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - cannot restart read, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_get_icount</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">serial_icounter_struct</span> <span class="o">*</span><span class="n">icount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cnow</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_icount</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - (%d) TIOCGICOUNT RX=%d, TX=%d&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		<span class="n">cnow</span><span class="p">.</span><span class="n">rx</span><span class="p">,</span> <span class="n">cnow</span><span class="p">.</span><span class="n">tx</span><span class="p">);</span>

	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rng</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rng</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">overrun</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">parity</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">brk</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">buf_overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">buf_overrun</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cprev</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d, cmd = 0x%04X&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIOCGSERIAL</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - (%d) TIOCGSERIAL&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ti_get_serial_info</span><span class="p">(</span><span class="n">tport</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TIOCSSERIAL</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - (%d) TIOCSSERIAL&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ti_set_serial_info</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">tport</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TIOCMIWAIT</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - (%d) TIOCMIWAIT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">cprev</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_icount</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_msr_wait</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="n">cnow</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_icount</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span> <span class="cm">/* no change =&gt; error */</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_RNG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_DSR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CD</span><span class="p">)</span>  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">)))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cprev</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ti_uart_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
	<span class="n">tcflag_t</span> <span class="n">cflag</span><span class="p">,</span> <span class="n">iflag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">baud</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_number</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mcr</span><span class="p">;</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
	<span class="n">iflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - cflag %08x, iflag %08x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cflag</span><span class="p">,</span> <span class="n">iflag</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - old clfag %08x, old iflag %08x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">config</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">config</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* these flags must be set */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">|=</span> <span class="n">TI_UART_ENABLE_MS_INTS</span><span class="p">;</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">|=</span> <span class="n">TI_UART_ENABLE_AUTO_START_DMA</span><span class="p">;</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">bUartMode</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_uart_mode</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS5</span>:
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">bDataBits</span> <span class="o">=</span> <span class="n">TI_UART_5_DATA_BITS</span><span class="p">;</span>
		    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS6</span>:
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">bDataBits</span> <span class="o">=</span> <span class="n">TI_UART_6_DATA_BITS</span><span class="p">;</span>
		    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>:
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">bDataBits</span> <span class="o">=</span> <span class="n">TI_UART_7_DATA_BITS</span><span class="p">;</span>
		    <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">CS8</span>:
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">bDataBits</span> <span class="o">=</span> <span class="n">TI_UART_8_DATA_BITS</span><span class="p">;</span>
		    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* CMSPAR isn&#39;t supported by this driver */</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CMSPAR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">|=</span> <span class="n">TI_UART_ENABLE_PARITY_CHECKING</span><span class="p">;</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">bParity</span> <span class="o">=</span> <span class="n">TI_UART_ODD_PARITY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">|=</span> <span class="n">TI_UART_ENABLE_PARITY_CHECKING</span><span class="p">;</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">bParity</span> <span class="o">=</span> <span class="n">TI_UART_EVEN_PARITY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TI_UART_ENABLE_PARITY_CHECKING</span><span class="p">;</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">bParity</span> <span class="o">=</span> <span class="n">TI_UART_NO_PARITY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">bStopBits</span> <span class="o">=</span> <span class="n">TI_UART_2_STOP_BITS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">bStopBits</span> <span class="o">=</span> <span class="n">TI_UART_1_STOP_BITS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* RTS flow control must be off to drop RTS for baud rate B0 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B0</span><span class="p">)</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">|=</span> <span class="n">TI_UART_ENABLE_RTS_IN</span><span class="p">;</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">|=</span> <span class="n">TI_UART_ENABLE_CTS_OUT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ti_restart_read</span><span class="p">(</span><span class="n">tport</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">I_IXON</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">cXon</span>  <span class="o">=</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">cXoff</span> <span class="o">=</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">|=</span> <span class="n">TI_UART_ENABLE_X_IN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ti_restart_read</span><span class="p">(</span><span class="n">tport</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">I_IXON</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span> <span class="o">|=</span> <span class="n">TI_UART_ENABLE_X_OUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">baud</span> <span class="o">=</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">baud</span><span class="p">)</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_tdev</span><span class="o">-&gt;</span><span class="n">td_is_3410</span><span class="p">)</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">wBaudRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)((</span><span class="mi">923077</span> <span class="o">+</span> <span class="n">baud</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">baud</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">wBaudRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)((</span><span class="mi">461538</span> <span class="o">+</span> <span class="n">baud</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">baud</span><span class="p">);</span>

	<span class="cm">/* FIXME: Should calculate resulting baud here and report it back */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B0</span><span class="p">)</span>
		<span class="n">tty_encode_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - BaudRate=%d, wBaudRate=%d, wFlags=0x%04X, bDataBits=%d, bParity=%d, bStopBits=%d, cXon=%d, cXoff=%d, bUartMode=%d&quot;</span><span class="p">,</span>
	<span class="n">__func__</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">wBaudRate</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">bDataBits</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">bParity</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">bStopBits</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">cXon</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">cXoff</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">bUartMode</span><span class="p">);</span>

	<span class="n">cpu_to_be16s</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">wBaudRate</span><span class="p">);</span>
	<span class="n">cpu_to_be16s</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">wFlags</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_command_out_sync</span><span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_tdev</span><span class="p">,</span> <span class="n">TI_SET_CONFIG</span><span class="p">,</span>
		<span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">TI_UART1_PORT</span> <span class="o">+</span> <span class="n">port_number</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">config</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">config</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - cannot set config on port %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">port_number</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="cm">/* SET_CONFIG asserts RTS and DTR, reset them correctly */</span>
	<span class="n">mcr</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_shadow_mcr</span><span class="p">;</span>
	<span class="cm">/* if baud rate is B0, clear RTS and DTR */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">==</span> <span class="n">B0</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TI_MCR_DTR</span> <span class="o">|</span> <span class="n">TI_MCR_RTS</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_set_mcr</span><span class="p">(</span><span class="n">tport</span><span class="p">,</span> <span class="n">mcr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - cannot set modem control on port %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">port_number</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mcr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">msr</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_msr</span><span class="p">;</span>
	<span class="n">mcr</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_shadow_mcr</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">TI_MCR_DTR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">TI_MCR_RTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">TI_MCR_LOOP</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_LOOP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">TI_MSR_CTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">TI_MSR_CD</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CAR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">TI_MSR_RI</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RI</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">TI_MSR_DSR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - 0x%04X&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mcr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mcr</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_shadow_mcr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">TI_MCR_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">TI_MCR_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_LOOP</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">TI_MCR_LOOP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TI_MCR_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TI_MCR_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_LOOP</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TI_MCR_LOOP</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ti_set_mcr</span><span class="p">(</span><span class="n">tport</span><span class="p">,</span> <span class="n">mcr</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - state = %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">break_state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ti_drain</span><span class="p">(</span><span class="n">tport</span><span class="p">,</span> <span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_closing_wait</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_write_byte</span><span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_tdev</span><span class="p">,</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_uart_base_addr</span> <span class="o">+</span> <span class="n">TI_UART_OFFSET_LCR</span><span class="p">,</span>
		<span class="n">TI_LCR_BREAK</span><span class="p">,</span> <span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="n">TI_LCR_BREAK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - error setting break, %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_interrupt_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ti_device</span> <span class="o">*</span><span class="n">tdev</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span> <span class="o">=</span> <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_number</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">function</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">msr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - urb shutting down, %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_urb_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - nonzero urb status, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_urb_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - bad packet size, %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">TI_CODE_HARDWARE_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - hardware error, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port_number</span> <span class="o">=</span> <span class="n">TI_GET_PORT_FROM_CODE</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">function</span> <span class="o">=</span> <span class="n">TI_GET_FUNC_FROM_CODE</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port_number %d, function %d, data 0x%02X&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">port_number</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port_number</span> <span class="o">&gt;=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - bad port number, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">port_number</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">port_number</span><span class="p">];</span>

	<span class="n">tport</span> <span class="o">=</span> <span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tport</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TI_CODE_DATA_ERROR</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - DATA ERROR, port %d, data 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">port_number</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TI_CODE_MODEM_STATUS</span>:
		<span class="n">msr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d, msr 0x%02X&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port_number</span><span class="p">,</span> <span class="n">msr</span><span class="p">);</span>
		<span class="n">ti_handle_new_msr</span><span class="p">(</span><span class="n">tport</span><span class="p">,</span> <span class="n">msr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - unknown interrupt code, 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - resubmit interrupt urb failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_bulk_in_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - urb shutting down, %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_tdev</span><span class="o">-&gt;</span><span class="n">td_urb_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_write_wait</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - nonzero urb status, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_tdev</span><span class="o">-&gt;</span><span class="n">td_urb_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_write_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - stopping read!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_is_open</span><span class="p">)</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port closed, dropping data&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ti_recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span>
						<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
						<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">);</span>
			<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_icount</span><span class="p">.</span><span class="n">rx</span> <span class="o">+=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="cm">/* continue to read unless stopping */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_read_urb_state</span> <span class="o">==</span> <span class="n">TI_READ_URB_RUNNING</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_read_urb_state</span> <span class="o">==</span> <span class="n">TI_READ_URB_STOPPING</span><span class="p">)</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_read_urb_state</span> <span class="o">=</span> <span class="n">TI_READ_URB_STOPPED</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - resubmit read urb failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_bulk_out_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_write_urb_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - urb shutting down, %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_tdev</span><span class="o">-&gt;</span><span class="n">td_urb_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_write_wait</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err_console</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="s">&quot;%s - nonzero urb status, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_tdev</span><span class="o">-&gt;</span><span class="n">td_urb_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_write_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* send any buffered data */</span>
	<span class="n">ti_send</span><span class="p">(</span><span class="n">tport</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">tty_insert_flip_string</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - dropping data, %d bytes lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>	<span class="cm">/* FIXME */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_write_urb_in_use</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">kfifo_out</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">,</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">bulk_out_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_write_urb_in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">usb_serial_debug_data</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>

	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">port</span><span class="o">-&gt;</span><span class="n">bulk_out_endpointAddress</span><span class="p">),</span>
			   <span class="n">port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
			   <span class="n">ti_bulk_out_callback</span><span class="p">,</span> <span class="n">tport</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err_console</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="s">&quot;%s - submit write urb failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_write_urb_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* TODO: reschedule ti_send */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_icount</span><span class="p">.</span><span class="n">tx</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* more room in the buffer for new writes, wakeup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_write_wait</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_set_mcr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mcr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_write_byte</span><span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_tdev</span><span class="p">,</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_uart_base_addr</span> <span class="o">+</span> <span class="n">TI_UART_OFFSET_MCR</span><span class="p">,</span>
		<span class="n">TI_MCR_RTS</span> <span class="o">|</span> <span class="n">TI_MCR_DTR</span> <span class="o">|</span> <span class="n">TI_MCR_LOOP</span><span class="p">,</span> <span class="n">mcr</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_shadow_mcr</span> <span class="o">=</span> <span class="n">mcr</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_get_lsr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_device</span> <span class="o">*</span><span class="n">tdev</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_tdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_number</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_port_status</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port_status</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_command_in_sync</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">TI_GET_PORT_STATUS</span><span class="p">,</span>
		<span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">TI_UART1_PORT</span><span class="o">+</span><span class="n">port_number</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - get port status command failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - lsr 0x%02X&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bLSR</span><span class="p">);</span>

	<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lsr</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bLSR</span><span class="p">;</span>

<span class="nl">free_data:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_get_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ret_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">ret_serial</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret_arg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret_serial</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ret_serial</span><span class="p">));</span>

	<span class="n">ret_serial</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_16550A</span><span class="p">;</span>
	<span class="n">ret_serial</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>
	<span class="n">ret_serial</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>
	<span class="n">ret_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_flags</span><span class="p">;</span>
	<span class="n">ret_serial</span><span class="p">.</span><span class="n">xmit_fifo_size</span> <span class="o">=</span> <span class="n">TI_WRITE_BUF_SIZE</span><span class="p">;</span>
	<span class="n">ret_serial</span><span class="p">.</span><span class="n">baud_base</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_tdev</span><span class="o">-&gt;</span><span class="n">td_is_3410</span> <span class="o">?</span> <span class="mi">921600</span> <span class="o">:</span> <span class="mi">460800</span><span class="p">;</span>
	<span class="n">ret_serial</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_closing_wait</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ret_arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret_serial</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ret_arg</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_set_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">new_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">new_serial</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_serial</span><span class="p">,</span> <span class="n">new_arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_serial</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_flags</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TI_SET_SERIAL_FLAGS</span><span class="p">;</span>
	<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_closing_wait</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">closing_wait</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_handle_new_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">msr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="o">*</span><span class="n">icount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - msr 0x%02X&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">msr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">TI_MSR_DELTA_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_icount</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">TI_MSR_DELTA_CTS</span><span class="p">)</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">TI_MSR_DELTA_DSR</span><span class="p">)</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">TI_MSR_DELTA_CD</span><span class="p">)</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">TI_MSR_DELTA_RI</span><span class="p">)</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rng</span><span class="o">++</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_msr_wait</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_msr</span> <span class="o">=</span> <span class="n">msr</span> <span class="o">&amp;</span> <span class="n">TI_MSR_MASK</span><span class="p">;</span>

	<span class="cm">/* handle CTS flow control */</span>
	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="n">C_CRTSCTS</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">TI_MSR_CTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_drain</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flush</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ti_device</span> <span class="o">*</span><span class="n">tdev</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_tdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_port</span><span class="p">;</span>
	<span class="n">wait_queue_t</span> <span class="n">wait</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">);</span>

	<span class="cm">/* wait for data to drain from the buffer */</span>
	<span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_urb_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_waitqueue_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_write_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
		<span class="o">||</span> <span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
		<span class="o">||</span> <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_urb_error</span>
		<span class="o">||</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disconnected</span><span class="p">)</span>  <span class="cm">/* disconnect */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">);</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_write_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="cm">/* flush any remaining data in the buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flush</span><span class="p">)</span>
		<span class="n">kfifo_reset_out</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="cm">/* wait for data to drain from the device */</span>
	<span class="cm">/* wait for empty tx register, plus 20 ms */</span>
	<span class="n">timeout</span> <span class="o">+=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lsr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TI_LSR_TX_EMPTY</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="kt">long</span><span class="p">)(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">timeout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
	<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lsr</span><span class="o">&amp;</span><span class="n">TI_LSR_TX_EMPTY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_urb_error</span>
	<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disconnected</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ti_get_lsr</span><span class="p">(</span><span class="n">tport</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_stop_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_read_urb_state</span> <span class="o">==</span> <span class="n">TI_READ_URB_RUNNING</span><span class="p">)</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_read_urb_state</span> <span class="o">=</span> <span class="n">TI_READ_URB_STOPPING</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_restart_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_read_urb_state</span> <span class="o">==</span> <span class="n">TI_READ_URB_STOPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_read_urb_state</span> <span class="o">=</span> <span class="n">TI_READ_URB_RUNNING</span><span class="p">;</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">tport</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
		<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_read_urb_state</span> <span class="o">=</span> <span class="n">TI_READ_URB_RUNNING</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_command_out_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_device</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">command</span><span class="p">,</span>
	<span class="n">__u16</span> <span class="n">moduleid</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">command</span><span class="p">,</span>
		<span class="p">(</span><span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span><span class="p">),</span>
		<span class="n">value</span><span class="p">,</span> <span class="n">moduleid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECOMM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_command_in_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_device</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">command</span><span class="p">,</span>
	<span class="n">__u16</span> <span class="n">moduleid</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">command</span><span class="p">,</span>
		<span class="p">(</span><span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span><span class="p">),</span>
		<span class="n">value</span><span class="p">,</span> <span class="n">moduleid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECOMM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_write_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_device</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
	<span class="n">__u8</span> <span class="n">mask</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">byte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_write_data_bytes</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - addr 0x%08lX, mask 0x%02X, byte 0x%02X&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_write_data_bytes</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">bAddrType</span> <span class="o">=</span> <span class="n">TI_RW_DATA_ADDR_XDATA</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">bDataType</span> <span class="o">=</span> <span class="n">TI_RW_DATA_BYTE</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">bDataCounter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">wBaseAddrHi</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">addr</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">wBaseAddrLo</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">bData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">bData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ti_command_out_sync</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">TI_WRITE_DATA</span><span class="p">,</span> <span class="n">TI_RAM_PORT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_do_download</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span>
						<span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_firmware_header</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_firmware_header</span><span class="p">);</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">pos</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)(</span><span class="n">cs</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">[</span><span class="n">pos</span><span class="p">]);</span>

	<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ti_firmware_header</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">__u16</span><span class="p">)(</span><span class="n">size</span>
					<span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_firmware_header</span><span class="p">)));</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">bCheckSum</span> <span class="o">=</span> <span class="n">cs</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - downloading firmware&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">pos</span> <span class="o">+=</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">pos</span><span class="p">,</span> <span class="n">TI_DOWNLOAD_MAX_PACKET_SIZE</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">done</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_download_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_device</span> <span class="o">*</span><span class="n">tdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buffer_size</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bulk_out_endpointAddress</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="cm">/* try ID specific firmware first, then try generic firmware */</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;ti_usb-v%04x-p%04x.fw&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">,</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span> <span class="o">==</span> <span class="n">MTS_VENDOR_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">MTS_CDMA_PRODUCT_ID</span>:
				<span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;mts_cdma.fw&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MTS_GSM_PRODUCT_ID</span>:
				<span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;mts_gsm.fw&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MTS_EDGE_PRODUCT_ID</span>:
				<span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;mts_edge.fw&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MTS_MT9234MU_PRODUCT_ID</span>:
				<span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;mts_mt9234mu.fw&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MTS_MT9234ZBA_PRODUCT_ID</span>:
				<span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;mts_mt9234zba.fw&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MTS_MT9234ZBAOLD_PRODUCT_ID</span>:
				<span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;mts_mt9234zba.fw&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">td_is_3410</span><span class="p">)</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;ti_3410.fw&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;ti_5052.fw&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - firmware not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_p</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">TI_FIRMWARE_BUF_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - firmware too large %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_p</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_p</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer_size</span> <span class="o">=</span> <span class="n">TI_FIRMWARE_BUF_SIZE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ti_firmware_header</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">fw_p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw_p</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">fw_p</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">buffer_size</span> <span class="o">-</span> <span class="n">fw_p</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ti_do_download</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">fw_p</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s ENOMEM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - error downloading firmware, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - download successful&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
