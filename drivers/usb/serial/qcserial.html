<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › serial › qcserial.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>qcserial.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Qualcomm Serial USB driver</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (c) 2008 QUALCOMM Incorporated.</span>
<span class="cm"> *	Copyright (c) 2009 Greg Kroah-Hartman &lt;gregkh@suse.de&gt;</span>
<span class="cm"> *	Copyright (c) 2009 Novell Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License version</span>
<span class="cm"> *	2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/serial.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;usb-wwan.h&quot;</span>

<span class="cp">#define DRIVER_AUTHOR &quot;Qualcomm Inc&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;Qualcomm USB Serial driver&quot;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>

<span class="cp">#define DEVICE_G1K(v, p) \</span>
<span class="cp">	USB_DEVICE(v, p), .driver_info = 1</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Gobi 1000 devices */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9211</span><span class="p">)},</span>	<span class="cm">/* Acer Gobi QDL device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9212</span><span class="p">)},</span>	<span class="cm">/* Acer Gobi Modem Device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x03f0</span><span class="p">,</span> <span class="mh">0x1f1d</span><span class="p">)},</span>	<span class="cm">/* HP un2400 Gobi Modem Device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x03f0</span><span class="p">,</span> <span class="mh">0x201d</span><span class="p">)},</span>	<span class="cm">/* HP un2400 Gobi QDL Device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x04da</span><span class="p">,</span> <span class="mh">0x250d</span><span class="p">)},</span>	<span class="cm">/* Panasonic Gobi Modem device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x04da</span><span class="p">,</span> <span class="mh">0x250c</span><span class="p">)},</span>	<span class="cm">/* Panasonic Gobi QDL device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x413c</span><span class="p">,</span> <span class="mh">0x8172</span><span class="p">)},</span>	<span class="cm">/* Dell Gobi Modem device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x413c</span><span class="p">,</span> <span class="mh">0x8171</span><span class="p">)},</span>	<span class="cm">/* Dell Gobi QDL device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x1410</span><span class="p">,</span> <span class="mh">0xa001</span><span class="p">)},</span>	<span class="cm">/* Novatel Gobi Modem device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x1410</span><span class="p">,</span> <span class="mh">0xa008</span><span class="p">)},</span>	<span class="cm">/* Novatel Gobi QDL device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x0b05</span><span class="p">,</span> <span class="mh">0x1776</span><span class="p">)},</span>	<span class="cm">/* Asus Gobi Modem device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x0b05</span><span class="p">,</span> <span class="mh">0x1774</span><span class="p">)},</span>	<span class="cm">/* Asus Gobi QDL device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x19d2</span><span class="p">,</span> <span class="mh">0xfff3</span><span class="p">)},</span>	<span class="cm">/* ONDA Gobi Modem device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x19d2</span><span class="p">,</span> <span class="mh">0xfff2</span><span class="p">)},</span>	<span class="cm">/* ONDA Gobi QDL device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x1557</span><span class="p">,</span> <span class="mh">0x0a80</span><span class="p">)},</span>	<span class="cm">/* OQO Gobi QDL device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9001</span><span class="p">)},</span>   <span class="cm">/* Generic Gobi Modem device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9002</span><span class="p">)},</span>	<span class="cm">/* Generic Gobi Modem device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9202</span><span class="p">)},</span>	<span class="cm">/* Generic Gobi Modem device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9203</span><span class="p">)},</span>	<span class="cm">/* Generic Gobi Modem device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9222</span><span class="p">)},</span>	<span class="cm">/* Generic Gobi Modem device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9008</span><span class="p">)},</span>	<span class="cm">/* Generic Gobi QDL device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9009</span><span class="p">)},</span>	<span class="cm">/* Generic Gobi Modem device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9201</span><span class="p">)},</span>	<span class="cm">/* Generic Gobi QDL device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9221</span><span class="p">)},</span>	<span class="cm">/* Generic Gobi QDL device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9231</span><span class="p">)},</span>	<span class="cm">/* Generic Gobi QDL device */</span>
	<span class="p">{</span><span class="n">DEVICE_G1K</span><span class="p">(</span><span class="mh">0x1f45</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">)},</span>	<span class="cm">/* Unknown Gobi QDL device */</span>

	<span class="cm">/* Gobi 2000 devices */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1410</span><span class="p">,</span> <span class="mh">0xa010</span><span class="p">)},</span>	<span class="cm">/* Novatel Gobi 2000 QDL device */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1410</span><span class="p">,</span> <span class="mh">0xa011</span><span class="p">)},</span>	<span class="cm">/* Novatel Gobi 2000 QDL device */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1410</span><span class="p">,</span> <span class="mh">0xa012</span><span class="p">)},</span>	<span class="cm">/* Novatel Gobi 2000 QDL device */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1410</span><span class="p">,</span> <span class="mh">0xa013</span><span class="p">)},</span>	<span class="cm">/* Novatel Gobi 2000 QDL device */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1410</span><span class="p">,</span> <span class="mh">0xa014</span><span class="p">)},</span>	<span class="cm">/* Novatel Gobi 2000 QDL device */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x413c</span><span class="p">,</span> <span class="mh">0x8185</span><span class="p">)},</span>	<span class="cm">/* Dell Gobi 2000 QDL device (N0218, VU936) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x413c</span><span class="p">,</span> <span class="mh">0x8186</span><span class="p">)},</span>	<span class="cm">/* Dell Gobi 2000 Modem device (N0218, VU936) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9208</span><span class="p">)},</span>	<span class="cm">/* Generic Gobi 2000 QDL device */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x920b</span><span class="p">)},</span>	<span class="cm">/* Generic Gobi 2000 Modem device */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9224</span><span class="p">)},</span>	<span class="cm">/* Sony Gobi 2000 QDL device (N0279, VU730) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9225</span><span class="p">)},</span>	<span class="cm">/* Sony Gobi 2000 Modem device (N0279, VU730) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9244</span><span class="p">)},</span>	<span class="cm">/* Samsung Gobi 2000 QDL device (VL176) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9245</span><span class="p">)},</span>	<span class="cm">/* Samsung Gobi 2000 Modem device (VL176) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x03f0</span><span class="p">,</span> <span class="mh">0x241d</span><span class="p">)},</span>	<span class="cm">/* HP Gobi 2000 QDL device (VP412) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x03f0</span><span class="p">,</span> <span class="mh">0x251d</span><span class="p">)},</span>	<span class="cm">/* HP Gobi 2000 Modem device (VP412) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9214</span><span class="p">)},</span>	<span class="cm">/* Acer Gobi 2000 QDL device (VP413) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9215</span><span class="p">)},</span>	<span class="cm">/* Acer Gobi 2000 Modem device (VP413) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9264</span><span class="p">)},</span>	<span class="cm">/* Asus Gobi 2000 QDL device (VR305) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9265</span><span class="p">)},</span>	<span class="cm">/* Asus Gobi 2000 Modem device (VR305) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9234</span><span class="p">)},</span>	<span class="cm">/* Top Global Gobi 2000 QDL device (VR306) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9235</span><span class="p">)},</span>	<span class="cm">/* Top Global Gobi 2000 Modem device (VR306) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9274</span><span class="p">)},</span>	<span class="cm">/* iRex Technologies Gobi 2000 QDL device (VR307) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9275</span><span class="p">)},</span>	<span class="cm">/* iRex Technologies Gobi 2000 Modem device (VR307) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9000</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 2000 QDL device (VT773) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9001</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 2000 Modem device (VT773) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9002</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 2000 Modem device (VT773) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9003</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 2000 Modem device (VT773) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9004</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 2000 Modem device (VT773) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 2000 Modem device (VT773) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9006</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 2000 Modem device (VT773) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9007</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 2000 Modem device (VT773) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9008</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 2000 Modem device (VT773) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9009</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 2000 Modem device (VT773) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x900a</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 2000 Modem device (VT773) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9011</span><span class="p">)},</span>   <span class="cm">/* Sierra Wireless Gobi 2000 Modem device (MC8305) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x16d8</span><span class="p">,</span> <span class="mh">0x8001</span><span class="p">)},</span>	<span class="cm">/* CMDTech Gobi 2000 QDL device (VU922) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x16d8</span><span class="p">,</span> <span class="mh">0x8002</span><span class="p">)},</span>	<span class="cm">/* CMDTech Gobi 2000 Modem device (VU922) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9204</span><span class="p">)},</span>	<span class="cm">/* Gobi 2000 QDL device */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x9205</span><span class="p">)},</span>	<span class="cm">/* Gobi 2000 Modem device */</span>

	<span class="cm">/* Gobi 3000 devices */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x03f0</span><span class="p">,</span> <span class="mh">0x371d</span><span class="p">)},</span>	<span class="cm">/* HP un2430 Gobi 3000 QDL */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x920c</span><span class="p">)},</span>	<span class="cm">/* Gobi 3000 QDL */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05c6</span><span class="p">,</span> <span class="mh">0x920d</span><span class="p">)},</span>	<span class="cm">/* Gobi 3000 Composite */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1410</span><span class="p">,</span> <span class="mh">0xa020</span><span class="p">)},</span>   <span class="cm">/* Novatel Gobi 3000 QDL */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1410</span><span class="p">,</span> <span class="mh">0xa021</span><span class="p">)},</span>	<span class="cm">/* Novatel Gobi 3000 Composite */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x413c</span><span class="p">,</span> <span class="mh">0x8193</span><span class="p">)},</span>	<span class="cm">/* Dell Gobi 3000 QDL */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x413c</span><span class="p">,</span> <span class="mh">0x8194</span><span class="p">)},</span>	<span class="cm">/* Dell Gobi 3000 Composite */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9010</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 3000 QDL */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9012</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 3000 QDL */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9013</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 3000 Modem device (MC8355) */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9014</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 3000 QDL */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9015</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 3000 Modem device */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9018</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 3000 QDL */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1199</span><span class="p">,</span> <span class="mh">0x9019</span><span class="p">)},</span>	<span class="cm">/* Sierra Wireless Gobi 3000 Modem device */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x12D1</span><span class="p">,</span> <span class="mh">0x14F0</span><span class="p">)},</span>	<span class="cm">/* Sony Gobi 3000 QDL */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x12D1</span><span class="p">,</span> <span class="mh">0x14F1</span><span class="p">)},</span>	<span class="cm">/* Sony Gobi 3000 Composite */</span>
	<span class="p">{</span> <span class="p">}</span>				<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qcprobe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_wwan_intf_private</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">intf</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">nintf</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">ifnum</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_gobi1k</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_info</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Is Gobi 1000 = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">is_gobi1k</span><span class="p">);</span>

	<span class="n">nintf</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">actconfig</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumInterfaces</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Num Interfaces = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nintf</span><span class="p">);</span>
	<span class="n">ifnum</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;This Interface = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifnum</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_wwan_intf_private</span><span class="p">),</span>
					 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">susp_lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">nintf</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* QDL mode */</span>
		<span class="cm">/* Gobi 2000 has a single altsetting, older ones have two */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">num_altsetting</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">intf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">num_altsetting</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
		    <span class="n">usb_endpoint_is_bulk_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">usb_endpoint_is_bulk_out</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;QDL port found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">num_altsetting</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Success */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifnum</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Could not set interface, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">retval</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">3</span>:
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="cm">/* Composite mode; don&#39;t bind to the QMI/net interface as that</span>
<span class="cm">		 * gets handled by other drivers.</span>
<span class="cm">		 */</span>

		<span class="cm">/* Gobi 1K USB layout:</span>
<span class="cm">		 * 0: serial port (doesn&#39;t respond)</span>
<span class="cm">		 * 1: serial port (doesn&#39;t respond)</span>
<span class="cm">		 * 2: AT-capable modem port</span>
<span class="cm">		 * 3: QMI/net</span>
<span class="cm">		 *</span>
<span class="cm">		 * Gobi 2K+ USB layout:</span>
<span class="cm">		 * 0: QMI/net</span>
<span class="cm">		 * 1: DM/DIAG (use libqcdm from ModemManager for communication)</span>
<span class="cm">		 * 2: AT-capable modem port</span>
<span class="cm">		 * 3: NMEA</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ifnum</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_gobi1k</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Gobi 2K+ DM/DIAG interface found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Could not set interface, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">retval</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ifnum</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Modem port found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Could not set interface, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">retval</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ifnum</span><span class="o">==</span><span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_gobi1k</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * NMEA (serial line 9600 8N1)</span>
<span class="cm">			 * # echo &quot;\$GPS_START&quot; &gt; /dev/ttyUSBx</span>
<span class="cm">			 * # echo &quot;\$GPS_STOP&quot;  &gt; /dev/ttyUSBx</span>
<span class="cm">			 */</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Gobi 2K+ NMEA GPS interface found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Could not set interface, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">retval</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unknown number of interfaces: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nintf</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set serial-&gt;private if not returning -ENODEV */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="n">usb_set_serial_data</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qc_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_wwan_intf_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_serial_data</span><span class="p">(</span><span class="n">serial</span><span class="p">);</span>

	<span class="cm">/* Call usb_wwan release &amp; free the private data allocated in qcprobe */</span>
	<span class="n">usb_wwan_release</span><span class="p">(</span><span class="n">serial</span><span class="p">);</span>
	<span class="n">usb_set_serial_data</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="n">qcdevice</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>     <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>      <span class="o">=</span> <span class="s">&quot;qcserial&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">description</span>         <span class="o">=</span> <span class="s">&quot;Qualcomm USB modem&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>            <span class="o">=</span> <span class="n">id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_ports</span>           <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>               <span class="o">=</span> <span class="n">qcprobe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		     <span class="o">=</span> <span class="n">usb_wwan_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>		     <span class="o">=</span> <span class="n">usb_wwan_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		     <span class="o">=</span> <span class="n">usb_wwan_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span>	     <span class="o">=</span> <span class="n">usb_wwan_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span>     <span class="o">=</span> <span class="n">usb_wwan_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span>		     <span class="o">=</span> <span class="n">usb_wwan_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	     <span class="o">=</span> <span class="n">usb_wwan_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	     <span class="o">=</span> <span class="n">qc_release</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	     <span class="o">=</span> <span class="n">usb_wwan_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		     <span class="o">=</span> <span class="n">usb_wwan_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="o">*</span> <span class="k">const</span> <span class="n">serial_drivers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">qcdevice</span><span class="p">,</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="n">module_usb_serial_driver</span><span class="p">(</span><span class="n">serial_drivers</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug enabled or not&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
