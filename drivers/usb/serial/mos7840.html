<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › serial › mos7840.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mos7840.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> * Clean ups from Moschip version and a few ioctl implementations by:</span>
<span class="cm"> *	Paul B Schroeder &lt;pschroeder &quot;at&quot; uplogix &quot;dot&quot; com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Originally based on drivers/usb/serial/io_edgeport.c which is:</span>
<span class="cm"> *      Copyright (C) 2000 Inside Out Networks, All rights reserved.</span>
<span class="cm"> *      Copyright (C) 2001-2002 Greg Kroah-Hartman &lt;greg@kroah.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_driver.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/serial.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Version Information</span>
<span class="cm"> */</span>
<span class="cp">#define DRIVER_VERSION &quot;1.3.2&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;Moschip 7840/7820 USB Serial Driver&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * 16C50 UART register defines</span>
<span class="cm"> */</span>

<span class="cp">#define LCR_BITS_5             0x00	</span><span class="cm">/* 5 bits/char */</span><span class="cp"></span>
<span class="cp">#define LCR_BITS_6             0x01	</span><span class="cm">/* 6 bits/char */</span><span class="cp"></span>
<span class="cp">#define LCR_BITS_7             0x02	</span><span class="cm">/* 7 bits/char */</span><span class="cp"></span>
<span class="cp">#define LCR_BITS_8             0x03	</span><span class="cm">/* 8 bits/char */</span><span class="cp"></span>
<span class="cp">#define LCR_BITS_MASK          0x03	</span><span class="cm">/* Mask for bits/char field */</span><span class="cp"></span>

<span class="cp">#define LCR_STOP_1             0x00	</span><span class="cm">/* 1 stop bit */</span><span class="cp"></span>
<span class="cp">#define LCR_STOP_1_5           0x04	</span><span class="cm">/* 1.5 stop bits (if 5   bits/char) */</span><span class="cp"></span>
<span class="cp">#define LCR_STOP_2             0x04	</span><span class="cm">/* 2 stop bits   (if 6-8 bits/char) */</span><span class="cp"></span>
<span class="cp">#define LCR_STOP_MASK          0x04	</span><span class="cm">/* Mask for stop bits field */</span><span class="cp"></span>

<span class="cp">#define LCR_PAR_NONE           0x00	</span><span class="cm">/* No parity */</span><span class="cp"></span>
<span class="cp">#define LCR_PAR_ODD            0x08	</span><span class="cm">/* Odd parity */</span><span class="cp"></span>
<span class="cp">#define LCR_PAR_EVEN           0x18	</span><span class="cm">/* Even parity */</span><span class="cp"></span>
<span class="cp">#define LCR_PAR_MARK           0x28	</span><span class="cm">/* Force parity bit to 1 */</span><span class="cp"></span>
<span class="cp">#define LCR_PAR_SPACE          0x38	</span><span class="cm">/* Force parity bit to 0 */</span><span class="cp"></span>
<span class="cp">#define LCR_PAR_MASK           0x38	</span><span class="cm">/* Mask for parity field */</span><span class="cp"></span>

<span class="cp">#define LCR_SET_BREAK          0x40	</span><span class="cm">/* Set Break condition */</span><span class="cp"></span>
<span class="cp">#define LCR_DL_ENABLE          0x80	</span><span class="cm">/* Enable access to divisor latch */</span><span class="cp"></span>

<span class="cp">#define MCR_DTR                0x01	</span><span class="cm">/* Assert DTR */</span><span class="cp"></span>
<span class="cp">#define MCR_RTS                0x02	</span><span class="cm">/* Assert RTS */</span><span class="cp"></span>
<span class="cp">#define MCR_OUT1               0x04	</span><span class="cm">/* Loopback only: Sets state of RI */</span><span class="cp"></span>
<span class="cp">#define MCR_MASTER_IE          0x08	</span><span class="cm">/* Enable interrupt outputs */</span><span class="cp"></span>
<span class="cp">#define MCR_LOOPBACK           0x10	</span><span class="cm">/* Set internal (digital) loopback mode */</span><span class="cp"></span>
<span class="cp">#define MCR_XON_ANY            0x20	</span><span class="cm">/* Enable any char to exit XOFF mode */</span><span class="cp"></span>

<span class="cp">#define MOS7840_MSR_CTS        0x10	</span><span class="cm">/* Current state of CTS */</span><span class="cp"></span>
<span class="cp">#define MOS7840_MSR_DSR        0x20	</span><span class="cm">/* Current state of DSR */</span><span class="cp"></span>
<span class="cp">#define MOS7840_MSR_RI         0x40	</span><span class="cm">/* Current state of RI */</span><span class="cp"></span>
<span class="cp">#define MOS7840_MSR_CD         0x80	</span><span class="cm">/* Current state of CD */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Defines used for sending commands to port</span>
<span class="cm"> */</span>

<span class="cp">#define WAIT_FOR_EVER   (HZ * 0)	</span><span class="cm">/* timeout urb is wait for ever */</span><span class="cp"></span>
<span class="cp">#define MOS_WDR_TIMEOUT (HZ * 5)	</span><span class="cm">/* default urb timeout */</span><span class="cp"></span>

<span class="cp">#define MOS_PORT1       0x0200</span>
<span class="cp">#define MOS_PORT2       0x0300</span>
<span class="cp">#define MOS_VENREG      0x0000</span>
<span class="cp">#define MOS_MAX_PORT	0x02</span>
<span class="cp">#define MOS_WRITE       0x0E</span>
<span class="cp">#define MOS_READ        0x0D</span>

<span class="cm">/* Requests */</span>
<span class="cp">#define MCS_RD_RTYPE    0xC0</span>
<span class="cp">#define MCS_WR_RTYPE    0x40</span>
<span class="cp">#define MCS_RDREQ       0x0D</span>
<span class="cp">#define MCS_WRREQ       0x0E</span>
<span class="cp">#define MCS_CTRL_TIMEOUT        500</span>
<span class="cp">#define VENDOR_READ_LENGTH      (0x01)</span>

<span class="cp">#define MAX_NAME_LEN    64</span>

<span class="cp">#define ZLP_REG1  0x3A		</span><span class="cm">/* Zero_Flag_Reg1    58 */</span><span class="cp"></span>
<span class="cp">#define ZLP_REG5  0x3E		</span><span class="cm">/* Zero_Flag_Reg5    62 */</span><span class="cp"></span>

<span class="cm">/* For higher baud Rates use TIOCEXBAUD */</span>
<span class="cp">#define TIOCEXBAUD     0x5462</span>

<span class="cm">/* vendor id and device id defines */</span>

<span class="cm">/* The native mos7840/7820 component */</span>
<span class="cp">#define USB_VENDOR_ID_MOSCHIP           0x9710</span>
<span class="cp">#define MOSCHIP_DEVICE_ID_7840          0x7840</span>
<span class="cp">#define MOSCHIP_DEVICE_ID_7820          0x7820</span>
<span class="cp">#define MOSCHIP_DEVICE_ID_7810          0x7810</span>
<span class="cm">/* The native component can have its vendor/device id&#39;s overridden</span>
<span class="cm"> * in vendor-specific implementations.  Such devices can be handled</span>
<span class="cm"> * by making a change here, in id_table.</span>
<span class="cm"> */</span>
<span class="cp">#define USB_VENDOR_ID_BANDB              0x0856</span>
<span class="cp">#define BANDB_DEVICE_ID_USO9ML2_2        0xAC22</span>
<span class="cp">#define BANDB_DEVICE_ID_USO9ML2_2P       0xBC00</span>
<span class="cp">#define BANDB_DEVICE_ID_USO9ML2_4        0xAC24</span>
<span class="cp">#define BANDB_DEVICE_ID_USO9ML2_4P       0xBC01</span>
<span class="cp">#define BANDB_DEVICE_ID_US9ML2_2         0xAC29</span>
<span class="cp">#define BANDB_DEVICE_ID_US9ML2_4         0xAC30</span>
<span class="cp">#define BANDB_DEVICE_ID_USPTL4_2         0xAC31</span>
<span class="cp">#define BANDB_DEVICE_ID_USPTL4_4         0xAC32</span>
<span class="cp">#define BANDB_DEVICE_ID_USOPTL4_2        0xAC42</span>
<span class="cp">#define BANDB_DEVICE_ID_USOPTL4_2P       0xBC02</span>
<span class="cp">#define BANDB_DEVICE_ID_USOPTL4_4        0xAC44</span>
<span class="cp">#define BANDB_DEVICE_ID_USOPTL4_4P       0xBC03</span>
<span class="cp">#define BANDB_DEVICE_ID_USOPTL2_4        0xAC24</span>

<span class="cm">/* This driver also supports</span>
<span class="cm"> * ATEN UC2324 device using Moschip MCS7840</span>
<span class="cm"> * ATEN UC2322 device using Moschip MCS7820</span>
<span class="cm"> */</span>
<span class="cp">#define USB_VENDOR_ID_ATENINTL		0x0557</span>
<span class="cp">#define ATENINTL_DEVICE_ID_UC2324	0x2011</span>
<span class="cp">#define ATENINTL_DEVICE_ID_UC2322	0x7820</span>

<span class="cm">/* Interrupt Routine Defines    */</span>

<span class="cp">#define SERIAL_IIR_RLS      0x06</span>
<span class="cp">#define SERIAL_IIR_MS       0x00</span>

<span class="cm">/*</span>
<span class="cm"> *  Emulation of the bit mask on the LINE STATUS REGISTER.</span>
<span class="cm"> */</span>
<span class="cp">#define SERIAL_LSR_DR       0x0001</span>
<span class="cp">#define SERIAL_LSR_OE       0x0002</span>
<span class="cp">#define SERIAL_LSR_PE       0x0004</span>
<span class="cp">#define SERIAL_LSR_FE       0x0008</span>
<span class="cp">#define SERIAL_LSR_BI       0x0010</span>

<span class="cp">#define MOS_MSR_DELTA_CTS   0x10</span>
<span class="cp">#define MOS_MSR_DELTA_DSR   0x20</span>
<span class="cp">#define MOS_MSR_DELTA_RI    0x40</span>
<span class="cp">#define MOS_MSR_DELTA_CD    0x80</span>

<span class="cm">/* Serial Port register Address */</span>
<span class="cp">#define INTERRUPT_ENABLE_REGISTER  ((__u16)(0x01))</span>
<span class="cp">#define FIFO_CONTROL_REGISTER      ((__u16)(0x02))</span>
<span class="cp">#define LINE_CONTROL_REGISTER      ((__u16)(0x03))</span>
<span class="cp">#define MODEM_CONTROL_REGISTER     ((__u16)(0x04))</span>
<span class="cp">#define LINE_STATUS_REGISTER       ((__u16)(0x05))</span>
<span class="cp">#define MODEM_STATUS_REGISTER      ((__u16)(0x06))</span>
<span class="cp">#define SCRATCH_PAD_REGISTER       ((__u16)(0x07))</span>
<span class="cp">#define DIVISOR_LATCH_LSB          ((__u16)(0x00))</span>
<span class="cp">#define DIVISOR_LATCH_MSB          ((__u16)(0x01))</span>

<span class="cp">#define CLK_MULTI_REGISTER         ((__u16)(0x02))</span>
<span class="cp">#define CLK_START_VALUE_REGISTER   ((__u16)(0x03))</span>
<span class="cp">#define GPIO_REGISTER              ((__u16)(0x07))</span>

<span class="cp">#define SERIAL_LCR_DLAB            ((__u16)(0x0080))</span>

<span class="cm">/*</span>
<span class="cm"> * URB POOL related defines</span>
<span class="cm"> */</span>
<span class="cp">#define NUM_URBS                        16	</span><span class="cm">/* URB Count */</span><span class="cp"></span>
<span class="cp">#define URB_TRANSFER_BUFFER_SIZE        32	</span><span class="cm">/* URB Size  */</span><span class="cp"></span>

<span class="cm">/* LED on/off milliseconds*/</span>
<span class="cp">#define LED_ON_MS	500</span>
<span class="cp">#define LED_OFF_MS	500</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">device_type</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_MOSCHIP</span><span class="p">,</span> <span class="n">MOSCHIP_DEVICE_ID_7840</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_MOSCHIP</span><span class="p">,</span> <span class="n">MOSCHIP_DEVICE_ID_7820</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_MOSCHIP</span><span class="p">,</span> <span class="n">MOSCHIP_DEVICE_ID_7810</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_BANDB</span><span class="p">,</span> <span class="n">BANDB_DEVICE_ID_USO9ML2_2</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_BANDB</span><span class="p">,</span> <span class="n">BANDB_DEVICE_ID_USO9ML2_2P</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_BANDB</span><span class="p">,</span> <span class="n">BANDB_DEVICE_ID_USO9ML2_4</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_BANDB</span><span class="p">,</span> <span class="n">BANDB_DEVICE_ID_USO9ML2_4P</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_BANDB</span><span class="p">,</span> <span class="n">BANDB_DEVICE_ID_US9ML2_2</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_BANDB</span><span class="p">,</span> <span class="n">BANDB_DEVICE_ID_US9ML2_4</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_BANDB</span><span class="p">,</span> <span class="n">BANDB_DEVICE_ID_USPTL4_2</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_BANDB</span><span class="p">,</span> <span class="n">BANDB_DEVICE_ID_USPTL4_4</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_BANDB</span><span class="p">,</span> <span class="n">BANDB_DEVICE_ID_USOPTL4_2</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_BANDB</span><span class="p">,</span> <span class="n">BANDB_DEVICE_ID_USOPTL4_2P</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_BANDB</span><span class="p">,</span> <span class="n">BANDB_DEVICE_ID_USOPTL4_4</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_BANDB</span><span class="p">,</span> <span class="n">BANDB_DEVICE_ID_USOPTL4_4P</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_BANDB</span><span class="p">,</span> <span class="n">BANDB_DEVICE_ID_USOPTL2_4</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ATENINTL</span><span class="p">,</span> <span class="n">ATENINTL_DEVICE_ID_UC2324</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_ATENINTL</span><span class="p">,</span> <span class="n">ATENINTL_DEVICE_ID_UC2322</span><span class="p">)},</span>
	<span class="p">{}</span>			<span class="cm">/* terminating entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>

<span class="cm">/* This structure holds all of the local port information */</span>

<span class="k">struct</span> <span class="n">moschip_port</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">port_num</span><span class="p">;</span>		<span class="cm">/*Actual port number in the device(1,2,etc) */</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">write_urb</span><span class="p">;</span>	<span class="cm">/* write URB for this port */</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">read_urb</span><span class="p">;</span>	<span class="cm">/* read URB for this port */</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">int_urb</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">shadowLCR</span><span class="p">;</span>		<span class="cm">/* last LCR value received */</span>
	<span class="n">__u8</span> <span class="n">shadowMCR</span><span class="p">;</span>		<span class="cm">/* last MCR value received */</span>
	<span class="kt">char</span> <span class="n">open</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">open_ports</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">zombie</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">wait_chase</span><span class="p">;</span>	<span class="cm">/* for handling sleeping while waiting for chase to finish */</span>
	<span class="n">wait_queue_head_t</span> <span class="n">delta_msr_wait</span><span class="p">;</span>	<span class="cm">/* for handling sleeping while waiting for msr change to happen */</span>
	<span class="kt">int</span> <span class="n">delta_msr_cond</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">icount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>	<span class="cm">/* loop back to the owner of this object */</span>

	<span class="cm">/* Offsets */</span>
	<span class="n">__u8</span> <span class="n">SpRegOffset</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">ControlRegOffset</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">DcrRegOffset</span><span class="p">;</span>
	<span class="cm">/* for processing control URBS in interrupt context */</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">control_urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">dr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ctrl_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">MsrLsr</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">pool_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">write_urb_pool</span><span class="p">[</span><span class="n">NUM_URBS</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">busy</span><span class="p">[</span><span class="n">NUM_URBS</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">read_urb_busy</span><span class="p">;</span>

	<span class="cm">/* For device(s) with LED indicator */</span>
	<span class="n">bool</span> <span class="n">has_led</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">led_flag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">led_timer1</span><span class="p">;</span>	<span class="cm">/* Timer for LED on */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">led_timer2</span><span class="p">;</span>	<span class="cm">/* Timer for LED off */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * mos7840_set_reg_sync</span>
<span class="cm"> * 	To set the Control register by calling usb_fill_control_urb function</span>
<span class="cm"> *	by passing usb_sndctrlpipe function as parameter.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_set_reg_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">reg</span><span class="p">,</span>
				<span class="n">__u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_set_reg_sync offset is %x, value %x&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">MCS_WRREQ</span><span class="p">,</span>
			       <span class="n">MCS_WR_RTYPE</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">MOS_WDR_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mos7840_get_reg_sync</span>
<span class="cm"> * 	To set the Uart register by calling usb_fill_control_urb function by</span>
<span class="cm"> *	passing usb_rcvctrlpipe function as parameter.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_get_reg_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">reg</span><span class="p">,</span>
				<span class="n">__u16</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">VENDOR_READ_LENGTH</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">MCS_RDREQ</span><span class="p">,</span>
			      <span class="n">MCS_RD_RTYPE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">VENDOR_READ_LENGTH</span><span class="p">,</span>
			      <span class="n">MOS_WDR_TIMEOUT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_get_reg_sync offset is %x, return val %x&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mos7840_set_uart_reg</span>
<span class="cm"> *	To set the Uart register by calling usb_fill_control_urb function by</span>
<span class="cm"> *	passing usb_sndctrlpipe function as parameter.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_set_uart_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">reg</span><span class="p">,</span>
				<span class="n">__u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">;</span>
	<span class="cm">/* For the UART control registers, the application number need</span>
<span class="cm">	   to be Or&#39;ed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">__u16</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span>
				<span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_set_uart_reg application number is %x&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">__u16</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">__u16</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span>
			      <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_set_uart_reg application number is %x&quot;</span><span class="p">,</span>
			    <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">|=</span>
			    <span class="p">(((</span><span class="n">__u16</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span>
			      <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">))</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_set_uart_reg application number is %x&quot;</span><span class="p">,</span>
			    <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">MCS_WRREQ</span><span class="p">,</span>
			       <span class="n">MCS_WR_RTYPE</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">MOS_WDR_TIMEOUT</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mos7840_get_uart_reg</span>
<span class="cm"> *	To set the Control register by calling usb_fill_control_urb function</span>
<span class="cm"> *	by passing usb_rcvctrlpipe function as parameter.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_get_uart_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">reg</span><span class="p">,</span>
				<span class="n">__u16</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">Wval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">VENDOR_READ_LENGTH</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* dbg(&quot;application number is %4x&quot;,</span>
<span class="cm">	    (((__u16)port-&gt;number - (__u16)(port-&gt;serial-&gt;minor))+1)&lt;&lt;8); */</span>
	<span class="cm">/* Wval  is same as application number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Wval</span> <span class="o">=</span>
		    <span class="p">(((</span><span class="n">__u16</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">))</span> <span class="o">+</span>
		     <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_get_uart_reg application number is %x&quot;</span><span class="p">,</span> <span class="n">Wval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">__u16</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Wval</span> <span class="o">=</span> <span class="p">(((</span><span class="n">__u16</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span>
			      <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_get_uart_reg application number is %x&quot;</span><span class="p">,</span>
			    <span class="n">Wval</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">Wval</span> <span class="o">=</span> <span class="p">(((</span><span class="n">__u16</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span>
			      <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">))</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_get_uart_reg application number is %x&quot;</span><span class="p">,</span>
			    <span class="n">Wval</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">MCS_RDREQ</span><span class="p">,</span>
			      <span class="n">MCS_RD_RTYPE</span><span class="p">,</span> <span class="n">Wval</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">VENDOR_READ_LENGTH</span><span class="p">,</span>
			      <span class="n">MOS_WDR_TIMEOUT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_dump_serial_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;***************************************&quot;</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;SpRegOffset is %2x&quot;</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">SpRegOffset</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;ControlRegOffset is %2x&quot;</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ControlRegOffset</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;DCRRegOffset is %2x&quot;</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">DcrRegOffset</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;***************************************&quot;</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/************************************************************************/</span>
<span class="cm">/************************************************************************/</span>
<span class="cm">/*             I N T E R F A C E   F U N C T I O N S			*/</span>
<span class="cm">/*             I N T E R F A C E   F U N C T I O N S			*/</span>
<span class="cm">/************************************************************************/</span>
<span class="cm">/************************************************************************/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mos7840_set_port_private</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_set_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="nf">mos7840_get_port_private</span><span class="p">(</span><span class="k">struct</span>
							    <span class="n">usb_serial_port</span>
							    <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="p">)</span><span class="n">usb_get_serial_port_data</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_handle_new_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">new_msr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="o">*</span><span class="n">icount</span><span class="p">;</span>
	<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_msr</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">MOS_MSR_DELTA_CTS</span> <span class="o">|</span> <span class="n">MOS_MSR_DELTA_DSR</span> <span class="o">|</span> <span class="n">MOS_MSR_DELTA_RI</span> <span class="o">|</span>
	     <span class="n">MOS_MSR_DELTA_CD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>

		<span class="cm">/* update input line counters */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_msr</span> <span class="o">&amp;</span> <span class="n">MOS_MSR_DELTA_CTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span><span class="o">++</span><span class="p">;</span>
			<span class="n">smp_wmb</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_msr</span> <span class="o">&amp;</span> <span class="n">MOS_MSR_DELTA_DSR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
			<span class="n">smp_wmb</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_msr</span> <span class="o">&amp;</span> <span class="n">MOS_MSR_DELTA_CD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span><span class="o">++</span><span class="p">;</span>
			<span class="n">smp_wmb</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_msr</span> <span class="o">&amp;</span> <span class="n">MOS_MSR_DELTA_RI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rng</span><span class="o">++</span><span class="p">;</span>
			<span class="n">smp_wmb</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_handle_new_lsr</span><span class="p">(</span><span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">new_lsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="o">*</span><span class="n">icount</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - %02x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">new_lsr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_lsr</span> <span class="o">&amp;</span> <span class="n">SERIAL_LSR_BI</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Parity and Framing errors only count if they</span>
<span class="cm">		 * occur exclusive of a break being</span>
<span class="cm">		 * received.</span>
<span class="cm">		 */</span>
		<span class="n">new_lsr</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span> <span class="p">(</span><span class="n">SERIAL_LSR_OE</span> <span class="o">|</span> <span class="n">SERIAL_LSR_BI</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* update input line counters */</span>
	<span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_lsr</span> <span class="o">&amp;</span> <span class="n">SERIAL_LSR_BI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_lsr</span> <span class="o">&amp;</span> <span class="n">SERIAL_LSR_OE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_lsr</span> <span class="o">&amp;</span> <span class="n">SERIAL_LSR_PE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_lsr</span> <span class="o">&amp;</span> <span class="n">SERIAL_LSR_FE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/************************************************************************/</span>
<span class="cm">/************************************************************************/</span>
<span class="cm">/*            U S B  C A L L B A C K   F U N C T I O N S                */</span>
<span class="cm">/*            U S B  C A L L B A C K   F U N C T I O N S                */</span>
<span class="cm">/************************************************************************/</span>
<span class="cm">/************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_control_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">regval</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* success */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* this urb is terminated, clean up */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - urb shutting down with status: %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - nonzero urb status received: %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s urb buffer size is %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s mos7840_port-&gt;MsrLsr is %d port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">MsrLsr</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="n">regval</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s data is %x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">MsrLsr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mos7840_handle_new_msr</span><span class="p">(</span><span class="n">mos7840_port</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">MsrLsr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mos7840_handle_new_lsr</span><span class="p">(</span><span class="n">mos7840_port</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">zombie</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">int_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - Error %d submitting interrupt urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_get_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mcs</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">Wval</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">reg</span><span class="p">,</span>
			   <span class="n">__u16</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">mcs</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">dr</span> <span class="o">=</span> <span class="n">mcs</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">mcs</span><span class="o">-&gt;</span><span class="n">ctrl_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="n">MCS_RD_RTYPE</span><span class="p">;</span>
	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">MCS_RDREQ</span><span class="p">;</span>
	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">wValue</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">Wval</span><span class="p">);</span>	<span class="cm">/* 0 */</span>
	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">wIndex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">usb_fill_control_urb</span><span class="p">(</span><span class="n">mcs</span><span class="o">-&gt;</span><span class="n">control_urb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			     <span class="n">mos7840_control_callback</span><span class="p">,</span> <span class="n">mcs</span><span class="p">);</span>
	<span class="n">mcs</span><span class="o">-&gt;</span><span class="n">control_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">mcs</span><span class="o">-&gt;</span><span class="n">control_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_set_led_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* Success */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* This urb is terminated, clean up */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - urb shutting down with status: %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - nonzero urb status received: %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_set_led_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mcs</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">wval</span><span class="p">,</span>
				<span class="n">__u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">mcs</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">dr</span> <span class="o">=</span> <span class="n">mcs</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">;</span>

	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="n">MCS_WR_RTYPE</span><span class="p">;</span>
	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">MCS_WRREQ</span><span class="p">;</span>
	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">wValue</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wval</span><span class="p">);</span>
	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">wIndex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">usb_fill_control_urb</span><span class="p">(</span><span class="n">mcs</span><span class="o">-&gt;</span><span class="n">control_urb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mos7840_set_led_callback</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">mcs</span><span class="o">-&gt;</span><span class="n">control_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_set_led_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">reg</span><span class="p">,</span>
				<span class="n">__u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">MCS_WRREQ</span><span class="p">,</span> <span class="n">MCS_WR_RTYPE</span><span class="p">,</span>
			<span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOS_WDR_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_led_off</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mcs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="cm">/* Turn off LED */</span>
	<span class="n">mos7840_set_led_async</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="mh">0x0300</span><span class="p">,</span> <span class="n">MODEM_CONTROL_REGISTER</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcs</span><span class="o">-&gt;</span><span class="n">led_timer2</span><span class="p">,</span>
				<span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">LED_OFF_MS</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_led_flag_off</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mcs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">mcs</span><span class="o">-&gt;</span><span class="n">led_flag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * mos7840_interrupt_callback</span>
<span class="cm"> *	this is the callback function for when we have received data on the</span>
<span class="cm"> *	interrupt endpoint.</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_interrupt_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">Data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">sp</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">st</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">wval</span><span class="p">,</span> <span class="n">wreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* success */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* this urb is terminated, clean up */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - urb shutting down with status: %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - nonzero urb status received: %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>

	<span class="n">serial</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="cm">/* Moschip get 5 bytes</span>
<span class="cm">	 * Byte 1 IIR Port 1 (port.number is 0)</span>
<span class="cm">	 * Byte 2 IIR Port 2 (port.number is 1)</span>
<span class="cm">	 * Byte 3 IIR Port 3 (port.number is 2)</span>
<span class="cm">	 * Byte 4 IIR Port 4 (port.number is 3)</span>
<span class="cm">	 * Byte 5 FIFO status for both */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Wrong data !!!&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">sp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">sp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">st</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">wval</span> <span class="o">=</span>
		    <span class="p">(((</span><span class="n">__u16</span><span class="p">)</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span>
		      <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;SP%d No Interrupt !!!&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">SERIAL_IIR_RLS</span>:
					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Serial Port %d: Receiver status error or &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;address bit detected in 9-bit mode&quot;</span><span class="p">);</span>
					<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">MsrLsr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">wreg</span> <span class="o">=</span> <span class="n">LINE_STATUS_REGISTER</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">SERIAL_IIR_MS</span>:
					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Serial Port %d: Modem status change&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">MsrLsr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">wreg</span> <span class="o">=</span> <span class="n">MODEM_STATUS_REGISTER</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">zombie</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rv</span> <span class="o">=</span> <span class="n">mos7840_get_reg</span><span class="p">(</span><span class="n">mos7840_port</span><span class="p">,</span> <span class="n">wval</span><span class="p">,</span> <span class="n">wreg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Data</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="cm">/* the completion handler for the control urb will resubmit */</span>
		<span class="k">return</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - Error %d submitting interrupt urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_port_paranoia_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port == NULL&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port-&gt;serial == NULL&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Inline functions to check the sanity of a pointer that is passed to us */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_serial_paranoia_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - serial == NULL&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - serial-&gt;type == NULL!&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="nf">mos7840_get_usb_serial</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
						 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* if no port was specified, or it fails a paranoia check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span> <span class="o">||</span>
	    <span class="n">mos7840_port_paranoia_check</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">mos7840_serial_paranoia_check</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">function</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* then say that we don&#39;t have a valid usb_serial thing,</span>
<span class="cm">		 * which will end up genrating -ENODEV return values */</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * mos7840_bulk_in_callback</span>
<span class="cm"> *	this is the callback function for when we have received data on the</span>
<span class="cm"> *	bulk in endpoint.</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_bulk_in_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mos7840_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;NULL mos7840_port pointer&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;nonzero read bulk status received: %d&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb_busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="p">)</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port_paranoia_check</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Port Paranoia failed&quot;</span><span class="p">);</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb_busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">serial</span> <span class="o">=</span> <span class="n">mos7840_get_usb_serial</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Bad serial pointer&quot;</span><span class="p">);</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb_busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tty_insert_flip_string</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot; %s &quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span> <span class="o">+=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_port-&gt;icount.rx is %d:&quot;</span><span class="p">,</span>
		    <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;URB KILLED !!!&quot;</span><span class="p">);</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb_busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Turn on LED */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">has_led</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">led_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">led_flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">mos7840_set_led_async</span><span class="p">(</span><span class="n">mos7840_port</span><span class="p">,</span> <span class="mh">0x0301</span><span class="p">,</span>
					<span class="n">MODEM_CONTROL_REGISTER</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">led_timer1</span><span class="p">,</span>
				<span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">LED_ON_MS</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb_busy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;usb_submit_urb(read bulk) failed, retval = %d&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb_busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * mos7840_bulk_out_data_callback</span>
<span class="cm"> *	this is the callback function for when we have finished sending</span>
<span class="cm"> *	serial data on the bulk out endpoint.</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_bulk_out_data_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_URBS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span> <span class="o">==</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">write_urb_pool</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;nonzero write bulk status received:%d&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port_paranoia_check</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Port Paranoia failed&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span>
		<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/************************************************************************/</span>
<span class="cm">/*       D R I V E R  T T Y  I N T E R F A C E  F U N C T I O N S       */</span>
<span class="cm">/************************************************************************/</span>
<span class="cp">#ifdef MCSSerialProbe</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_serial_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/*need to implement the mode_reg reading and updating\</span>
<span class="cm">	   structures usb_serial_ device_type\</span>
<span class="cm">	   (i.e num_ports, num_bulkin,bulkout etc) */</span>
	<span class="cm">/* Also we can update the changes  attach */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * mos7840_open</span>
<span class="cm"> *	this function is called by the tty driver when a port is opened</span>
<span class="cm"> *	If successful, we return 0</span>
<span class="cm"> *	Otherwise we return a negative error number.</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">response</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">Data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">port0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port_paranoia_check</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Port Paranoia failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_serial_paranoia_check</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Serial Paranoia failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">port0</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">port0</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">port0</span><span class="o">-&gt;</span><span class="n">open_ports</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Initialising the write urb pool */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NUM_URBS</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">write_urb_pool</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">urb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No more urbs???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">URB_TRANSFER_BUFFER_SIZE</span><span class="p">,</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">write_urb_pool</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s-out of memory for urb buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Initialize MCS7840 -- Write Init values to corresponding Registers</span>
<span class="cm"> *</span>
<span class="cm"> * Register Index</span>
<span class="cm"> * 1 : IER</span>
<span class="cm"> * 2 : FCR</span>
<span class="cm"> * 3 : LCR</span>
<span class="cm"> * 4 : MCR</span>
<span class="cm"> *</span>
<span class="cm"> * 0x08 : SP1/2 Control Reg</span>
<span class="cm"> *****************************************************************************/</span>

	<span class="cm">/* NEED to check the following Block */</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_get_reg_sync</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">SpRegOffset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Reading Spreg failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">Data</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_reg_sync</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">SpRegOffset</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;writing Spreg failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">Data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_reg_sync</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">SpRegOffset</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;writing Spreg failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* End of block to be checked */</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_get_reg_sync</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ControlRegOffset</span><span class="p">,</span>
									<span class="o">&amp;</span><span class="n">Data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Reading Controlreg failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">Data</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>		<span class="cm">/* Driver done bit */</span>
	<span class="n">Data</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>		<span class="cm">/* rx_disable */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_reg_sync</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
				<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ControlRegOffset</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;writing Controlreg failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* do register settings here */</span>
	<span class="cm">/* Set all regs to the device default values. */</span>
	<span class="cm">/***********************************</span>
<span class="cm">	 * First Disable all interrupts.</span>
<span class="cm">	 ***********************************/</span>
	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">INTERRUPT_ENABLE_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;disabling interrupts failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Set FIFO_CONTROL_REGISTER to the default value */</span>
	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">FIFO_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Writing FIFO_CONTROL_REGISTER  failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0xcf</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">FIFO_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Writing FIFO_CONTROL_REGISTER  failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">LINE_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span> <span class="o">=</span> <span class="n">Data</span><span class="p">;</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">MODEM_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">=</span> <span class="n">Data</span><span class="p">;</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_get_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">LINE_CONTROL_REGISTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Data</span><span class="p">);</span>
	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span> <span class="o">=</span> <span class="n">Data</span><span class="p">;</span>

	<span class="n">Data</span> <span class="o">|=</span> <span class="n">SERIAL_LCR_DLAB</span><span class="p">;</span>	<span class="cm">/* data latch enable in LCR 0x80 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">LINE_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">DIVISOR_LATCH_LSB</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">DIVISOR_LATCH_MSB</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_get_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">LINE_CONTROL_REGISTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Data</span><span class="p">);</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="n">Data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SERIAL_LCR_DLAB</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">LINE_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span> <span class="o">=</span> <span class="n">Data</span><span class="p">;</span>

	<span class="cm">/* clearing Bulkin and Bulkout Fifo */</span>
	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_get_reg_sync</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">SpRegOffset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Data</span><span class="p">);</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="n">Data</span> <span class="o">|</span> <span class="mh">0x0c</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_reg_sync</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">SpRegOffset</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="n">Data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0c</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_reg_sync</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">SpRegOffset</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
	<span class="cm">/* Finally enable all interrupts */</span>
	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">INTERRUPT_ENABLE_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="cm">/* clearing rx_disable */</span>
	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_get_reg_sync</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ControlRegOffset</span><span class="p">,</span>
									<span class="o">&amp;</span><span class="n">Data</span><span class="p">);</span>
	<span class="n">Data</span> <span class="o">=</span> <span class="n">Data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_reg_sync</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ControlRegOffset</span><span class="p">,</span>
									<span class="n">Data</span><span class="p">);</span>

	<span class="cm">/* rx_negate */</span>
	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_get_reg_sync</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ControlRegOffset</span><span class="p">,</span>
									<span class="o">&amp;</span><span class="n">Data</span><span class="p">);</span>
	<span class="n">Data</span> <span class="o">=</span> <span class="n">Data</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_reg_sync</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ControlRegOffset</span><span class="p">,</span>
									<span class="n">Data</span><span class="p">);</span>

	<span class="cm">/* Check to see if we&#39;ve set up our endpoint info yet    *</span>
<span class="cm">	 * (can&#39;t set it up in mos7840_startup as the structures *</span>
<span class="cm">	 * were not set up at that time.)                        */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port0</span><span class="o">-&gt;</span><span class="n">open_ports</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interrupt_in_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* set up interrupt urb */</span>
			<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">,</span>
				<span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interrupt_in_endpointAddress</span><span class="p">),</span>
				<span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interrupt_in_buffer</span><span class="p">,</span>
				<span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="o">-&gt;</span>
				<span class="n">transfer_buffer_length</span><span class="p">,</span>
				<span class="n">mos7840_interrupt_callback</span><span class="p">,</span>
				<span class="n">serial</span><span class="p">,</span>
				<span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">);</span>

			<span class="cm">/* start interrupt read for mos7840               *</span>
<span class="cm">			 * will continue as long as mos7840 is connected  */</span>

			<span class="n">response</span> <span class="o">=</span>
			    <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">,</span>
					   <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - Error %d submitting &quot;</span>
					<span class="s">&quot;interrupt urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span>

	<span class="p">}</span>

	<span class="cm">/* see if we&#39;ve set up our endpoint info yet   *</span>
<span class="cm">	 * (can&#39;t set it up in mos7840_startup as the  *</span>
<span class="cm">	 * structures were not set up at that time.)   */</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;port number is %d&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;serial number is %d&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Bulkin endpoint is %d&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">bulk_in_endpointAddress</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;BulkOut endpoint is %d&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">bulk_out_endpointAddress</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Interrupt endpoint is %d&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">interrupt_in_endpointAddress</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;port&#39;s number in the device is %d&quot;</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">);</span>
	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">;</span>

	<span class="cm">/* set up our bulk in urb */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">((((</span><span class="n">__u16</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">__u16</span><span class="p">)(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">))</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">,</span>
			<span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">bulk_in_endpointAddress</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">bulk_in_buffer</span><span class="p">,</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span>
			<span class="n">mos7840_bulk_in_callback</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">,</span>
			<span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">bulk_in_endpointAddress</span><span class="p">),</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">bulk_in_buffer</span><span class="p">,</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span>
			<span class="n">mos7840_bulk_in_callback</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_open: bulkin endpoint is %d&quot;</span><span class="p">,</span>
	    <span class="n">port</span><span class="o">-&gt;</span><span class="n">bulk_in_endpointAddress</span><span class="p">);</span>
	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb_busy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - Error %d submitting control urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb_busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize our wait queues */</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">wait_chase</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">delta_msr_wait</span><span class="p">);</span>

	<span class="cm">/* initialize our icount structure */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">));</span>

	<span class="cm">/* initialize our port settings */</span>
	<span class="cm">/* Must set to enable ints! */</span>
	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">=</span> <span class="n">MCR_MASTER_IE</span><span class="p">;</span>
	<span class="cm">/* send a open port command */</span>
	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* mos7840_change_port_settings(mos7840_port,old_termios); */</span>
	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;usb_serial serial:%p       mos7840_port:%p</span><span class="se">\n</span><span class="s">      usb_serial_port port:%p&quot;</span><span class="p">,</span>
				<span class="n">serial</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * mos7840_chars_in_buffer</span>
<span class="cm"> *	this function is called by the tty driver when it wants to know how many</span>
<span class="cm"> *	bytes of data we currently have outstanding in the port (data that has</span>
<span class="cm"> *	been written, but hasn&#39;t made it out the port yet)</span>
<span class="cm"> *	If successful, we return the number of bytes left to be written in the</span>
<span class="cm"> *	system,</span>
<span class="cm"> *	Otherwise we return zero.</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chars</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port_paranoia_check</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Invalid port&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_URBS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">chars</span> <span class="o">+=</span> <span class="n">URB_TRANSFER_BUFFER_SIZE</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - returns %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">chars</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">chars</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * mos7840_close</span>
<span class="cm"> *	this function is called by the tty driver when a port is closed</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">port0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">Data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port_paranoia_check</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Port Paranoia failed&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">serial</span> <span class="o">=</span> <span class="n">mos7840_get_usb_serial</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Serial Paranoia failed&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">port0</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">port0</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NUM_URBS</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">write_urb_pool</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>

	<span class="cm">/* Freeing Write URBs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NUM_URBS</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">write_urb_pool</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">write_urb_pool</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">write_urb_pool</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span>
				      <span class="n">transfer_buffer</span><span class="p">);</span>

			<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">write_urb_pool</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* While closing port, shutdown all bulk read, write  *</span>
<span class="cm">	 * and interrupt read if they exists                  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Shutdown bulk write&quot;</span><span class="p">);</span>
			<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Shutdown bulk read&quot;</span><span class="p">);</span>
			<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">);</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb_busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">control_urb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Shutdown control read&quot;</span><span class="p">);</span>
			<span class="cm">/*/      usb_kill_urb (mos7840_port-&gt;control_urb); */</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cm">/*      if(mos7840_port-&gt;ctrl_buf != NULL) */</span>
<span class="cm">/*              kfree(mos7840_port-&gt;ctrl_buf); */</span>
	<span class="n">port0</span><span class="o">-&gt;</span><span class="n">open_ports</span><span class="o">--</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_num_open_ports in close%d:in port%d&quot;</span><span class="p">,</span>
	    <span class="n">port0</span><span class="o">-&gt;</span><span class="n">open_ports</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port0</span><span class="o">-&gt;</span><span class="n">open_ports</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Shutdown interrupt_in_urb&quot;</span><span class="p">);</span>
			<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interrupt_in_urb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if this urb had a transfer buffer already (old tx) free it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">write_urb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">MODEM_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">INTERRUPT_ENABLE_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * mos7840_block_until_chase_response</span>
<span class="cm"> *</span>
<span class="cm"> *	This function will block the close until one of the following:</span>
<span class="cm"> *		1. Response to our Chase comes from mos7840</span>
<span class="cm"> *		2. A timeout of 10 seconds without activity has expired</span>
<span class="cm"> *		   (1K of mos7840 data @ 2400 baud ==&gt; 4 sec to empty)</span>
<span class="cm"> *</span>
<span class="cm"> ************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_block_until_chase_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">mos7840_chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

		<span class="cm">/* Check for Buffer status */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* Block the thread for a while */</span>
		<span class="n">interruptible_sleep_on_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">wait_chase</span><span class="p">,</span>
					       <span class="n">timeout</span><span class="p">);</span>
		<span class="cm">/* No activity.. count down section */</span>
		<span class="n">wait</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - TIMEOUT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Reset timeout value back to seconds */</span>
			<span class="n">wait</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * mos7840_break</span>
<span class="cm"> *	this function sends a break to the port</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port_paranoia_check</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Port Paranoia failed&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">serial</span> <span class="o">=</span> <span class="n">mos7840_get_usb_serial</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Serial Paranoia failed&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="cm">/* flush and block until tx is empty */</span>
		<span class="n">mos7840_block_until_chase_response</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span> <span class="o">|</span> <span class="n">LCR_SET_BREAK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCR_SET_BREAK</span><span class="p">;</span>

	<span class="cm">/* FIXME: no locking on shadowLCR anywhere in driver */</span>
	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mcs7840_break mos7840_port-&gt;shadowLCR is %x&quot;</span><span class="p">,</span>
	    <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span><span class="p">);</span>
	<span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">LINE_CONTROL_REGISTER</span><span class="p">,</span>
			     <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * mos7840_write_room</span>
<span class="cm"> *	this function is called by the tty driver when it wants to know how many</span>
<span class="cm"> *	bytes of data we can accept for a specific port.</span>
<span class="cm"> *	If successful, we return the amount of room that we have for this port</span>
<span class="cm"> *	Otherwise we return a negative error number.</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">room</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port_paranoia_check</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Invalid port&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot; mos7840_write_room:leaving ...........&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;mos7840_break:leaving ...........&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_URBS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">room</span> <span class="o">+=</span> <span class="n">URB_TRANSFER_BUFFER_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">room</span> <span class="o">=</span> <span class="p">(</span><span class="n">room</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">room</span> <span class="o">-</span> <span class="n">URB_TRANSFER_BUFFER_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - returns %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">room</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">room</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * mos7840_write</span>
<span class="cm"> *	this function is called by the tty driver when data should be written to</span>
<span class="cm"> *	the port.</span>
<span class="cm"> *	If successful, we return the number of bytes written, otherwise we</span>
<span class="cm"> *      return a negative error number.</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">transfer_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="cm">/* __u16 Data; */</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">current_position</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data1</span><span class="p">;</span>

<span class="cp">#ifdef NOTMOS7840</span>
	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_get_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">LINE_CONTROL_REGISTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Data</span><span class="p">);</span>
	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span> <span class="o">=</span> <span class="n">Data</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_write: LINE_CONTROL_REGISTER is %x&quot;</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_write: mos7840_port-&gt;shadowLCR is %x&quot;</span><span class="p">,</span>
	    <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span><span class="p">);</span>

	<span class="cm">/* Data = 0x03; */</span>
	<span class="cm">/* status = mos7840_set_uart_reg(port,LINE_CONTROL_REGISTER,Data); */</span>
	<span class="cm">/* mos7840_port-&gt;shadowLCR=Data;//Need to add later */</span>

	<span class="n">Data</span> <span class="o">|=</span> <span class="n">SERIAL_LCR_DLAB</span><span class="p">;</span>	<span class="cm">/* data latch enable in LCR 0x80 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">LINE_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="cm">/* Data = 0x0c; */</span>
	<span class="cm">/* status = mos7840_set_uart_reg(port,DIVISOR_LATCH_LSB,Data); */</span>
	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_get_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">DIVISOR_LATCH_LSB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Data</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_write:DLL value is %x&quot;</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_get_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">DIVISOR_LATCH_MSB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Data</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_write:DLM value is %x&quot;</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="n">Data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SERIAL_LCR_DLAB</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_write: mos7840_port-&gt;shadowLCR is %x&quot;</span><span class="p">,</span>
	    <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">LINE_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port_paranoia_check</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Port Paranoia failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_serial_paranoia_check</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Serial Paranoia failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;mos7840_port is NULL&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* try to find a free urb in the list */</span>
	<span class="n">urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_URBS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">urb</span> <span class="o">=</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">write_urb_pool</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;URB:%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - no more free urbs&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span>
		    <span class="n">kmalloc</span><span class="p">(</span><span class="n">URB_TRANSFER_BUFFER_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err_console</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="s">&quot;%s no more kernel memory...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">transfer_size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">URB_TRANSFER_BUFFER_SIZE</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span> <span class="n">current_position</span><span class="p">,</span> <span class="n">transfer_size</span><span class="p">);</span>

	<span class="cm">/* fill urb with data and submit  */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">((((</span><span class="n">__u16</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">__u16</span><span class="p">)(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">))</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span>
			<span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">bulk_out_endpointAddress</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
			<span class="n">transfer_size</span><span class="p">,</span>
			<span class="n">mos7840_bulk_out_data_callback</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span>
			<span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">bulk_out_endpointAddress</span><span class="p">),</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
			<span class="n">transfer_size</span><span class="p">,</span>
			<span class="n">mos7840_bulk_out_data_callback</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">data1</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bulkout endpoint is %d&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">bulk_out_endpointAddress</span><span class="p">);</span>

	<span class="cm">/* Turn on LED */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">has_led</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">led_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">led_flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">mos7840_set_led_sync</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">MODEM_CONTROL_REGISTER</span><span class="p">,</span> <span class="mh">0x0301</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">led_timer1</span><span class="p">,</span>
				<span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">LED_ON_MS</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* send it down the pipe */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_err_console</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="s">&quot;%s - usb_submit_urb(write bulk) failed &quot;</span>
			<span class="s">&quot;with status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">bytes_sent</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bytes_sent</span> <span class="o">=</span> <span class="n">transfer_size</span><span class="p">;</span>
	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span> <span class="o">+=</span> <span class="n">transfer_size</span><span class="p">;</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_port-&gt;icount.tx is %d:&quot;</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">bytes_sent</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * mos7840_throttle</span>
<span class="cm"> *	this function is called by the tty driver when it wants to stop the data</span>
<span class="cm"> *	being read from the port.</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port_paranoia_check</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Invalid port&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;- port %d&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;port not opened&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if we are implementing XON/XOFF, send the stop character */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">stop_char</span> <span class="o">=</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stop_char</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* if we are implementing RTS/CTS, toggle that line */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MCR_RTS</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">MODEM_CONTROL_REGISTER</span><span class="p">,</span>
					 <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * mos7840_unthrottle</span>
<span class="cm"> *	this function is called by the tty driver when it wants to resume</span>
<span class="cm"> *	the data being read from the port (called after mos7840_throttle is</span>
<span class="cm"> *	called)</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port_paranoia_check</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Invalid port&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port not opened&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if we are implementing XON/XOFF, send the start character */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">start_char</span> <span class="o">=</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start_char</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if we are implementing RTS/CTS, toggle that line */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">|=</span> <span class="n">MCR_RTS</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">MODEM_CONTROL_REGISTER</span><span class="p">,</span>
					 <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">msr</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">mcr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_get_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">MODEM_STATUS_REGISTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msr</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_get_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">MODEM_CONTROL_REGISTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcr</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">MCR_DTR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">((</span><span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">MCR_RTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">((</span><span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">MCR_LOOPBACK</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_LOOP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MOS7840_MSR_CTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MOS7840_MSR_CD</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CAR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MOS7840_MSR_RI</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RI</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MOS7840_MSR_DSR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - 0x%04X&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mcr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* FIXME: What locks the port registers ? */</span>
	<span class="n">mcr</span> <span class="o">=</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MCR_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MCR_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_LOOP</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MCR_LOOPBACK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">MCR_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">MCR_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_LOOP</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">MCR_LOOPBACK</span><span class="p">;</span>

	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">=</span> <span class="n">mcr</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">MODEM_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">mcr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;setting MODEM_CONTROL_REGISTER Failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * mos7840_calc_baud_rate_divisor</span>
<span class="cm"> *	this function calculates the proper baud rate divisor for the specified</span>
<span class="cm"> *	baud rate.</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_calc_baud_rate_divisor</span><span class="p">(</span><span class="kt">int</span> <span class="n">baudRate</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">divisor</span><span class="p">,</span>
					  <span class="n">__u16</span> <span class="o">*</span><span class="n">clk_sel_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">baudRate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">baudRate</span> <span class="o">&lt;=</span> <span class="mi">115200</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">divisor</span> <span class="o">=</span> <span class="mi">115200</span> <span class="o">/</span> <span class="n">baudRate</span><span class="p">;</span>
		<span class="o">*</span><span class="n">clk_sel_val</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">baudRate</span> <span class="o">&gt;</span> <span class="mi">115200</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">baudRate</span> <span class="o">&lt;=</span> <span class="mi">230400</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">divisor</span> <span class="o">=</span> <span class="mi">230400</span> <span class="o">/</span> <span class="n">baudRate</span><span class="p">;</span>
		<span class="o">*</span><span class="n">clk_sel_val</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">baudRate</span> <span class="o">&gt;</span> <span class="mi">230400</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">baudRate</span> <span class="o">&lt;=</span> <span class="mi">403200</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">divisor</span> <span class="o">=</span> <span class="mi">403200</span> <span class="o">/</span> <span class="n">baudRate</span><span class="p">;</span>
		<span class="o">*</span><span class="n">clk_sel_val</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">baudRate</span> <span class="o">&gt;</span> <span class="mi">403200</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">baudRate</span> <span class="o">&lt;=</span> <span class="mi">460800</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">divisor</span> <span class="o">=</span> <span class="mi">460800</span> <span class="o">/</span> <span class="n">baudRate</span><span class="p">;</span>
		<span class="o">*</span><span class="n">clk_sel_val</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">baudRate</span> <span class="o">&gt;</span> <span class="mi">460800</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">baudRate</span> <span class="o">&lt;=</span> <span class="mi">806400</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">divisor</span> <span class="o">=</span> <span class="mi">806400</span> <span class="o">/</span> <span class="n">baudRate</span><span class="p">;</span>
		<span class="o">*</span><span class="n">clk_sel_val</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">baudRate</span> <span class="o">&gt;</span> <span class="mi">806400</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">baudRate</span> <span class="o">&lt;=</span> <span class="mi">921600</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">divisor</span> <span class="o">=</span> <span class="mi">921600</span> <span class="o">/</span> <span class="n">baudRate</span><span class="p">;</span>
		<span class="o">*</span><span class="n">clk_sel_val</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">baudRate</span> <span class="o">&gt;</span> <span class="mi">921600</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">baudRate</span> <span class="o">&lt;=</span> <span class="mi">1572864</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">divisor</span> <span class="o">=</span> <span class="mi">1572864</span> <span class="o">/</span> <span class="n">baudRate</span><span class="p">;</span>
		<span class="o">*</span><span class="n">clk_sel_val</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">baudRate</span> <span class="o">&gt;</span> <span class="mi">1572864</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">baudRate</span> <span class="o">&lt;=</span> <span class="mi">3145728</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">divisor</span> <span class="o">=</span> <span class="mi">3145728</span> <span class="o">/</span> <span class="n">baudRate</span><span class="p">;</span>
		<span class="o">*</span><span class="n">clk_sel_val</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef NOTMCS7840</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mos7840_divisor_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_divisor_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BaudRate</span> <span class="o">==</span> <span class="n">baudrate</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">divisor</span> <span class="o">=</span> <span class="n">mos7840_divisor_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Divisor</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* After trying for all the standard baud rates    *</span>
<span class="cm">	 * Try calculating the divisor for this baud rate  */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">baudrate</span> <span class="o">&gt;</span> <span class="mi">75</span> <span class="o">&amp;&amp;</span> <span class="n">baudrate</span> <span class="o">&lt;</span> <span class="mi">230400</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* get the divisor */</span>
		<span class="n">custom</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="mi">230400L</span> <span class="o">/</span> <span class="n">baudrate</span><span class="p">);</span>

		<span class="cm">/* Check for round off */</span>
		<span class="n">round1</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="mi">2304000L</span> <span class="o">/</span> <span class="n">baudrate</span><span class="p">);</span>
		<span class="n">round</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="n">round1</span> <span class="o">-</span> <span class="p">(</span><span class="n">custom</span> <span class="o">*</span> <span class="mi">10</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">round</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">custom</span><span class="o">++</span><span class="p">;</span>
		<span class="o">*</span><span class="n">divisor</span> <span class="o">=</span> <span class="n">custom</span><span class="p">;</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot; Baud %d = %d&quot;</span><span class="p">,</span> <span class="n">baudrate</span><span class="p">,</span> <span class="n">custom</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot; Baud calculation Failed...&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * mos7840_send_cmd_write_baud_rate</span>
<span class="cm"> *	this function sends the proper command to change the baud rate of the</span>
<span class="cm"> *	specified port.</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_send_cmd_write_baud_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">baudRate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">divisor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">Data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">number</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">clk_sel_val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="p">)</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port_paranoia_check</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Invalid port&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_serial_paranoia_check</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Invalid Serial&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">number</span> <span class="o">=</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port = %d, baud = %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">baudRate</span><span class="p">);</span>
	<span class="cm">/* reset clk_uart_sel in spregOffset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">baudRate</span> <span class="o">&gt;</span> <span class="mi">115200</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef HW_flow_control</span>
		<span class="cm">/* NOTE: need to see the pther register to modify */</span>
		<span class="cm">/* setting h/w flow control bit to 1 */</span>
		<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x2b</span><span class="p">;</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">=</span> <span class="n">Data</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">MODEM_CONTROL_REGISTER</span><span class="p">,</span>
									<span class="n">Data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Writing spreg failed in set_serial_baud&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef HW_flow_control</span>
		<span class="cm">/* setting h/w flow control bit to 0 */</span>
		<span class="n">Data</span> <span class="o">=</span> <span class="mh">0xb</span><span class="p">;</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">=</span> <span class="n">Data</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">MODEM_CONTROL_REGISTER</span><span class="p">,</span>
									<span class="n">Data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Writing spreg failed in set_serial_baud&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* baudRate &lt;= 115200) */</span>
		<span class="n">clk_sel_val</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_calc_baud_rate_divisor</span><span class="p">(</span><span class="n">baudRate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">divisor</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">clk_sel_val</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_get_reg_sync</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">SpRegOffset</span><span class="p">,</span>
								 <span class="o">&amp;</span><span class="n">Data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;reading spreg failed in set_serial_baud&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">Data</span> <span class="o">=</span> <span class="p">(</span><span class="n">Data</span> <span class="o">&amp;</span> <span class="mh">0x8f</span><span class="p">)</span> <span class="o">|</span> <span class="n">clk_sel_val</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_reg_sync</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">SpRegOffset</span><span class="p">,</span>
								<span class="n">Data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Writing spreg failed in set_serial_baud&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Calculate the Divisor */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - bad baud rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Enable access to divisor latch */</span>
		<span class="n">Data</span> <span class="o">=</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span> <span class="o">|</span> <span class="n">SERIAL_LCR_DLAB</span><span class="p">;</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span> <span class="o">=</span> <span class="n">Data</span><span class="p">;</span>
		<span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">LINE_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

		<span class="cm">/* Write the divisor */</span>
		<span class="n">Data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">divisor</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;set_serial_baud Value to write DLL is %x&quot;</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
		<span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">DIVISOR_LATCH_LSB</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

		<span class="n">Data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">divisor</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;set_serial_baud Value to write DLM is %x&quot;</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
		<span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">DIVISOR_LATCH_MSB</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

		<span class="cm">/* Disable access to divisor latch */</span>
		<span class="n">Data</span> <span class="o">=</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SERIAL_LCR_DLAB</span><span class="p">;</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span> <span class="o">=</span> <span class="n">Data</span><span class="p">;</span>
		<span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">LINE_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * mos7840_change_port_settings</span>
<span class="cm"> *	This routine is called to set the UART on the device to match</span>
<span class="cm"> *      the specified new settings.</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_change_port_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">baud</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">iflag</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">lData</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">lParity</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">lStop</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">Data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="p">)</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port_paranoia_check</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Invalid port&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_serial_paranoia_check</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Invalid Serial&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port not opened&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lData</span> <span class="o">=</span> <span class="n">LCR_BITS_8</span><span class="p">;</span>
	<span class="n">lStop</span> <span class="o">=</span> <span class="n">LCR_STOP_1</span><span class="p">;</span>
	<span class="n">lParity</span> <span class="o">=</span> <span class="n">LCR_PAR_NONE</span><span class="p">;</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
	<span class="n">iflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">;</span>

	<span class="cm">/* Change the number of bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CS5</span>:
			<span class="n">lData</span> <span class="o">=</span> <span class="n">LCR_BITS_5</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CS6</span>:
			<span class="n">lData</span> <span class="o">=</span> <span class="n">LCR_BITS_6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CS7</span>:
			<span class="n">lData</span> <span class="o">=</span> <span class="n">LCR_BITS_7</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">CS8</span>:
			<span class="n">lData</span> <span class="o">=</span> <span class="n">LCR_BITS_8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Change the Parity bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lParity</span> <span class="o">=</span> <span class="n">LCR_PAR_ODD</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = odd&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lParity</span> <span class="o">=</span> <span class="n">LCR_PAR_EVEN</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = even&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - parity = none&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CMSPAR</span><span class="p">)</span>
		<span class="n">lParity</span> <span class="o">=</span> <span class="n">lParity</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">;</span>

	<span class="cm">/* Change the Stop bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lStop</span> <span class="o">=</span> <span class="n">LCR_STOP_2</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - stop bits = 2&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lStop</span> <span class="o">=</span> <span class="n">LCR_STOP_1</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - stop bits = 1&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Update the LCR with the correct value */</span>
	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span> <span class="o">&amp;=</span>
	    <span class="o">~</span><span class="p">(</span><span class="n">LCR_BITS_MASK</span> <span class="o">|</span> <span class="n">LCR_STOP_MASK</span> <span class="o">|</span> <span class="n">LCR_PAR_MASK</span><span class="p">);</span>
	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span> <span class="o">|=</span> <span class="p">(</span><span class="n">lData</span> <span class="o">|</span> <span class="n">lParity</span> <span class="o">|</span> <span class="n">lStop</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_change_port_settings mos7840_port-&gt;shadowLCR is %x&quot;</span><span class="p">,</span>
	    <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span><span class="p">);</span>
	<span class="cm">/* Disable Interrupts */</span>
	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">INTERRUPT_ENABLE_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">FIFO_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0xcf</span><span class="p">;</span>
	<span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">FIFO_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="cm">/* Send the updated LCR value to the mos7840 */</span>
	<span class="n">Data</span> <span class="o">=</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span><span class="p">;</span>

	<span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">LINE_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x00b</span><span class="p">;</span>
	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">=</span> <span class="n">Data</span><span class="p">;</span>
	<span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">MODEM_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x00b</span><span class="p">;</span>
	<span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">MODEM_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="cm">/* set up the MCR register and send it to the mos7840 */</span>

	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">=</span> <span class="n">MCR_MASTER_IE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MCR_DTR</span> <span class="o">|</span> <span class="n">MCR_RTS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MCR_XON_ANY</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MCR_XON_ANY</span><span class="p">);</span>

	<span class="n">Data</span> <span class="o">=</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowMCR</span><span class="p">;</span>
	<span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">MODEM_CONTROL_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="cm">/* Determine divisor based on baud rate */</span>
	<span class="n">baud</span> <span class="o">=</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">baud</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* pick a default, any default... */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Picked default baud...&quot;</span><span class="p">);</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - baud rate = %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_send_cmd_write_baud_rate</span><span class="p">(</span><span class="n">mos7840_port</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="cm">/* Enable Interrupts */</span>
	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">;</span>
	<span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">INTERRUPT_ENABLE_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb_busy</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb_busy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;usb_submit_urb(read bulk) failed, status = %d&quot;</span><span class="p">,</span>
			    <span class="n">status</span><span class="p">);</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb_busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">delta_msr_wait</span><span class="p">);</span>
	<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">delta_msr_cond</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_change_port_settings mos7840_port-&gt;shadowLCR is End %x&quot;</span><span class="p">,</span>
	    <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">shadowLCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * mos7840_set_termios</span>
<span class="cm"> *	this function is called by the tty driver when it wants to change</span>
<span class="cm"> *	the termios structure</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port_paranoia_check</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Invalid port&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">serial</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_serial_paranoia_check</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Invalid Serial&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port not opened&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;setting termios - &quot;</span><span class="p">);</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - clfag %08x iflag %08x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">RELEVANT_IFLAG</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">));</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - old clfag %08x old iflag %08x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">RELEVANT_IFLAG</span><span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">));</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="cm">/* change the port settings to the new ones specified */</span>

	<span class="n">mos7840_change_port_settings</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="p">,</span> <span class="n">old_termios</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;URB KILLED !!!!!&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb_busy</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb_busy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;usb_submit_urb(read bulk) failed, status = %d&quot;</span><span class="p">,</span>
			    <span class="n">status</span><span class="p">);</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">read_urb_busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * mos7840_get_lsr_info - get line status register info</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: Let user call ioctl() to get info when the UART physically</span>
<span class="cm"> * 	    is emptied.  On bus types like RS485, the transmitter must</span>
<span class="cm"> * 	    release the bus after transmitting. This must be done when</span>
<span class="cm"> * 	    the transmit shift register is empty, not be done when the</span>
<span class="cm"> * 	    transmit holding register is empty.  This functionality</span>
<span class="cm"> * 	    allows an RS485 driver to be written in user space.</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_get_lsr_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">mos7840_chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s -- Empty&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">TIOCSER_TEMT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * mos7840_get_serial_info</span>
<span class="cm"> *      function to get information about serial port</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_get_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">retinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retinfo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>

	<span class="n">tmp</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_16550A</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ASYNC_SKIP_TEST</span> <span class="o">|</span> <span class="n">ASYNC_AUTO_IRQ</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">xmit_fifo_size</span> <span class="o">=</span> <span class="n">NUM_URBS</span> <span class="o">*</span> <span class="n">URB_TRANSFER_BUFFER_SIZE</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">baud_base</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">retinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">retinfo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_get_icount</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">serial_icounter_struct</span> <span class="o">*</span><span class="n">icount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cnow</span><span class="p">;</span>

	<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">cnow</span> <span class="o">=</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>

	<span class="n">smp_rmb</span><span class="p">();</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rng</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rng</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">overrun</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">parity</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">brk</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">buf_overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">buf_overrun</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s (%d) TIOCGICOUNT RX=%d, TX=%d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">,</span> <span class="n">icount</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * SerialIoctl</span>
<span class="cm"> *	this function handles any ioctl calls to the driver</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cprev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port_paranoia_check</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Invalid port&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - port %d, cmd = 0x%x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* return number of bytes available */</span>

	<span class="k">case</span> <span class="n">TIOCSERGETLSR</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s (%d) TIOCSERGETLSR&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">mos7840_get_lsr_info</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">TIOCGSERIAL</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s (%d) TIOCGSERIAL&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">mos7840_get_serial_info</span><span class="p">(</span><span class="n">mos7840_port</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">TIOCSSERIAL</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s (%d) TIOCSSERIAL&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TIOCMIWAIT</span>:
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s (%d) TIOCMIWAIT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">cprev</span> <span class="o">=</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* interruptible_sleep_on(&amp;mos7840_port-&gt;delta_msr_wait); */</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">delta_msr_cond</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">delta_msr_wait</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span>
						  <span class="n">delta_msr_cond</span> <span class="o">==</span> <span class="mi">1</span><span class="p">));</span>

			<span class="cm">/* see if a signal did it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="n">cnow</span> <span class="o">=</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
			<span class="n">smp_rmb</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>	<span class="cm">/* no change =&gt; error */</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_RNG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_DSR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cprev</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* NOTREACHED */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7810_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pass_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mcr_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">test_pattern</span> <span class="o">=</span> <span class="mh">0x55AA</span><span class="p">;</span>

	<span class="cm">/* Store MCR setting */</span>
	<span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">MCS_RDREQ</span><span class="p">,</span> <span class="n">MCS_RD_RTYPE</span><span class="p">,</span> <span class="mh">0x0300</span><span class="p">,</span> <span class="n">MODEM_CONTROL_REGISTER</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">mcr_data</span><span class="p">,</span> <span class="n">VENDOR_READ_LENGTH</span><span class="p">,</span> <span class="n">MOS_WDR_TIMEOUT</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Send the 1-bit test pattern out to MCS7810 test pin */</span>
		<span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">MCS_WRREQ</span><span class="p">,</span> <span class="n">MCS_WR_RTYPE</span><span class="p">,</span>
			<span class="p">(</span><span class="mh">0x0300</span> <span class="o">|</span> <span class="p">(((</span><span class="n">test_pattern</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)),</span>
			<span class="n">MODEM_CONTROL_REGISTER</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOS_WDR_TIMEOUT</span><span class="p">);</span>

		<span class="cm">/* Read the test pattern back */</span>
		<span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">MCS_RDREQ</span><span class="p">,</span> <span class="n">MCS_RD_RTYPE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GPIO_REGISTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span>
			<span class="n">VENDOR_READ_LENGTH</span><span class="p">,</span> <span class="n">MOS_WDR_TIMEOUT</span><span class="p">);</span>

		<span class="cm">/* If this is a MCS7810 device, both test patterns must match */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">test_pattern</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="o">~</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">pass_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Restore MCR setting */</span>
	<span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">MCS_WRREQ</span><span class="p">,</span>
		<span class="n">MCS_WR_RTYPE</span><span class="p">,</span> <span class="mh">0x0300</span> <span class="o">|</span> <span class="n">mcr_data</span><span class="p">,</span> <span class="n">MODEM_CONTROL_REGISTER</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">MOS_WDR_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pass_count</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_calc_num_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u16</span> <span class="n">data</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mos7840_num_ports</span><span class="p">;</span>

	<span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">MCS_RDREQ</span><span class="p">,</span> <span class="n">MCS_RD_RTYPE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GPIO_REGISTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span>
		<span class="n">VENDOR_READ_LENGTH</span><span class="p">,</span> <span class="n">MOS_WDR_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span> <span class="o">==</span> <span class="n">MOSCHIP_DEVICE_ID_7810</span> <span class="o">||</span>
		<span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span> <span class="o">==</span> <span class="n">MOSCHIP_DEVICE_ID_7820</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_type</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* For a MCS7840 device GPIO0 must be set to 1 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">device_type</span> <span class="o">=</span> <span class="n">MOSCHIP_DEVICE_ID_7840</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mos7810_check</span><span class="p">(</span><span class="n">serial</span><span class="p">))</span>
			<span class="n">device_type</span> <span class="o">=</span> <span class="n">MOSCHIP_DEVICE_ID_7810</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">device_type</span> <span class="o">=</span> <span class="n">MOSCHIP_DEVICE_ID_7820</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mos7840_num_ports</span> <span class="o">=</span> <span class="p">(</span><span class="n">device_type</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000F</span><span class="p">;</span>
	<span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_bulk_in</span> <span class="o">=</span> <span class="n">mos7840_num_ports</span><span class="p">;</span>
	<span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_bulk_out</span> <span class="o">=</span> <span class="n">mos7840_num_ports</span><span class="p">;</span>
	<span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">=</span> <span class="n">mos7840_num_ports</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mos7840_num_ports</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * mos7840_startup</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mos7840_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">Data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Invalid Handler&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* we set up the pointers to the endpoints in the mos7840_open *</span>
<span class="cm">	 * function, as the structures aren&#39;t created yet.             */</span>

	<span class="cm">/* set up port private structures */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span> <span class="p">(</span><span class="s">&quot;mos7840_startup: configuring port %d............&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">moschip_port</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="cm">/* don&#39;t follow NULL pointer cleaning up */</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Initialize all port interrupt end point to port 0 int</span>
<span class="cm">		 * endpoint. Our device has only one interrupt end point</span>
<span class="cm">		 * common to all port */</span>

		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">mos7840_set_port_private</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mos7840_port</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">);</span>

		<span class="cm">/* minor is not initialised until later by</span>
<span class="cm">		 * usb-serial.c:get_free_serial() and cannot therefore be used</span>
<span class="cm">		 * to index device instances */</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dbg</span> <span class="p">(</span><span class="s">&quot;serial-&gt;port[i]-&gt;number = %d&quot;</span><span class="p">,</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">dbg</span> <span class="p">(</span><span class="s">&quot;serial-&gt;port[i]-&gt;serial-&gt;minor = %d&quot;</span><span class="p">,</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">dbg</span> <span class="p">(</span><span class="s">&quot;mos7840_port-&gt;port_num = %d&quot;</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">);</span>
		<span class="n">dbg</span> <span class="p">(</span><span class="s">&quot;serial-&gt;minor = %d&quot;</span><span class="p">,</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">SpRegOffset</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ControlRegOffset</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">DcrRegOffset</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">SpRegOffset</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ControlRegOffset</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">;</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">DcrRegOffset</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">SpRegOffset</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ControlRegOffset</span> <span class="o">=</span> <span class="mh">0xb</span><span class="p">;</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">DcrRegOffset</span> <span class="o">=</span> <span class="mh">0x19</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">SpRegOffset</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ControlRegOffset</span> <span class="o">=</span> <span class="mh">0xb</span><span class="p">;</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">DcrRegOffset</span> <span class="o">=</span> <span class="mh">0x19</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">SpRegOffset</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">;</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ControlRegOffset</span> <span class="o">=</span> <span class="mh">0xd</span><span class="p">;</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">DcrRegOffset</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mos7840_dump_serial_port</span><span class="p">(</span><span class="n">mos7840_port</span><span class="p">);</span>
		<span class="n">mos7840_set_port_private</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mos7840_port</span><span class="p">);</span>

		<span class="cm">/* enable rx_disable bit in control register */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_get_reg_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				 <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ControlRegOffset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Reading ControlReg failed status-0x%x&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;ControlReg Reading success val is %x, status%d&quot;</span><span class="p">,</span>
			    <span class="n">Data</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">Data</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>	<span class="cm">/* setting driver done bit */</span>
		<span class="n">Data</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>	<span class="cm">/* sp1_bit to have cts change reflect in</span>
<span class="cm">				   modem status reg */</span>

		<span class="cm">/* Data |= 0x20; //rx_disable bit */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_reg_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					 <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ControlRegOffset</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Writing ControlReg failed(rx_disable) status-0x%x&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;ControlReg Writing success(rx_disable) status%d&quot;</span><span class="p">,</span>
			    <span class="n">status</span><span class="p">);</span>

		<span class="cm">/* Write default values in DCR (i.e 0x01 in DCR0, 0x05 in DCR2</span>
<span class="cm">		   and 0x24 in DCR3 */</span>
		<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_reg_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			 <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">DcrRegOffset</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">Data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Writing DCR0 failed status-0x%x&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;DCR0 Writing success status%d&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_reg_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			 <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">DcrRegOffset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Writing DCR1 failed status-0x%x&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;DCR1 Writing success status%d&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x24</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_reg_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			 <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">DcrRegOffset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">Data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Writing DCR2 failed status-0x%x&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;DCR2 Writing success status%d&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="cm">/* write values in clkstart0x0 and clkmulti 0x20 */</span>
		<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_reg_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					 <span class="n">CLK_START_VALUE_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Writing CLK_START_VALUE_REGISTER failed status-0x%x&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;CLK_START_VALUE_REGISTER Writing success status%d&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_reg_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">CLK_MULTI_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Writing CLK_MULTI_REGISTER failed status-0x%x&quot;</span><span class="p">,</span>
			    <span class="n">status</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;CLK_MULTI_REGISTER Writing success status%d&quot;</span><span class="p">,</span>
			    <span class="n">status</span><span class="p">);</span>

		<span class="cm">/* write value 0x0 to scratchpad register */</span>
		<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_uart_reg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						<span class="n">SCRATCH_PAD_REGISTER</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Writing SCRATCH_PAD_REGISTER failed status-0x%x&quot;</span><span class="p">,</span>
			    <span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;SCRATCH_PAD_REGISTER Writing success status%d&quot;</span><span class="p">,</span>
			    <span class="n">status</span><span class="p">);</span>

		<span class="cm">/* Zero Length flag register */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">Data</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_reg_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				      <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ZLP_REG1</span> <span class="o">+</span>
				      <span class="p">((</span><span class="n">__u16</span><span class="p">)</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">)),</span> <span class="n">Data</span><span class="p">);</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;ZLIP offset %x&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ZLP_REG1</span> <span class="o">+</span>
					<span class="p">((</span><span class="n">__u16</span><span class="p">)</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">)));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Writing ZLP_REG%d failed status-0x%x&quot;</span><span class="p">,</span>
				    <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;ZLP_REG%d Writing success status%d&quot;</span><span class="p">,</span>
				    <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">Data</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_reg_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			      <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ZLP_REG1</span> <span class="o">+</span>
			      <span class="p">((</span><span class="n">__u16</span><span class="p">)</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x1</span><span class="p">),</span> <span class="n">Data</span><span class="p">);</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;ZLIP offset %x&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ZLP_REG1</span> <span class="o">+</span>
				     <span class="p">((</span><span class="n">__u16</span><span class="p">)</span> <span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x1</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Writing ZLP_REG%d failed status-0x%x&quot;</span><span class="p">,</span>
				    <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;ZLP_REG%d Writing success status%d&quot;</span><span class="p">,</span>
				    <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">control_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ctrl_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">dr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ctrlrequest</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">control_urb</span> <span class="o">||</span> <span class="o">!</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ctrl_buf</span> <span class="o">||</span>
							<span class="o">!</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">has_led</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* Initialize LED timers */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">MOSCHIP_DEVICE_ID_7810</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">has_led</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">led_timer1</span><span class="p">);</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">led_timer1</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">mos7840_led_off</span><span class="p">;</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">led_timer1</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
					<span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">LED_ON_MS</span><span class="p">);</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">led_timer1</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span>
						<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mos7840_port</span><span class="p">;</span>

			<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">led_timer2</span><span class="p">);</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">led_timer2</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span>
						<span class="n">mos7840_led_flag_off</span><span class="p">;</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">led_timer2</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
					<span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">LED_OFF_MS</span><span class="p">);</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">led_timer2</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span>
						<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mos7840_port</span><span class="p">;</span>

			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">led_flag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="cm">/* Turn off LED */</span>
			<span class="n">mos7840_set_led_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						<span class="n">MODEM_CONTROL_REGISTER</span><span class="p">,</span> <span class="mh">0x0300</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dbg</span> <span class="p">(</span><span class="s">&quot;mos7840_startup: all ports configured...........&quot;</span><span class="p">);</span>

	<span class="cm">/* Zero Length flag enable */</span>
	<span class="n">Data</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mos7840_set_reg_sync</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ZLP_REG5</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Writing ZLP_REG5 failed status-0x%x&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;ZLP_REG5 Writing success status%d&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="cm">/* setting configuration feature to one */</span>
	<span class="n">usb_control_msg</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="p">(</span><span class="n">__u8</span><span class="p">)</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="k">for</span> <span class="p">(</span><span class="cm">/* nothing */</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ctrl_buf</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">control_urb</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mos7840_port</span><span class="p">);</span>
		<span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * mos7840_disconnect</span>
<span class="cm"> *	This function is called whenever the device is removed from the usb bus.</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Invalid Handler&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check for the ports to be closed,close the ports and disconnect */</span>

	<span class="cm">/* free private structure allocated for serial port  *</span>
<span class="cm">	 * stop reads and writes on all ports                */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">dbg</span> <span class="p">(</span><span class="s">&quot;mos7840_port %d = %p&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">zombie</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">control_urb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * mos7840_release</span>
<span class="cm"> *	This function is called when the usb_serial structure is freed.</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mos7840_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_serial</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moschip_port</span> <span class="o">*</span><span class="n">mos7840_port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Invalid Handler&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check for the ports to be closed,close the ports and disconnect */</span>

	<span class="cm">/* free private structure allocated for serial port  *</span>
<span class="cm">	 * stop reads and writes on all ports                */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">serial</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mos7840_port</span> <span class="o">=</span> <span class="n">mos7840_get_port_private</span><span class="p">(</span><span class="n">serial</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mos7840_port %d = %p&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mos7840_port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">has_led</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Turn off LED */</span>
				<span class="n">mos7840_set_led_sync</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
						<span class="n">MODEM_CONTROL_REGISTER</span><span class="p">,</span> <span class="mh">0x0300</span><span class="p">);</span>

				<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">led_timer1</span><span class="p">);</span>
				<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">led_timer2</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">ctrl_buf</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mos7840_port</span><span class="o">-&gt;</span><span class="n">dr</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mos7840_port</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="n">moschip7840_4port_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		   <span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		   <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mos7840&quot;</span><span class="p">,</span>
		   <span class="p">},</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">DRIVER_DESC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_ports</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">mos7840_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">mos7840_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">mos7840_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">mos7840_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">mos7840_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span> <span class="n">mos7840_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">mos7840_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">calc_num_ports</span> <span class="o">=</span> <span class="n">mos7840_calc_num_ports</span><span class="p">,</span>
<span class="cp">#ifdef MCSSerialProbe</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">mos7840_serial_probe</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">mos7840_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">mos7840_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span> <span class="o">=</span> <span class="n">mos7840_break</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span> <span class="n">mos7840_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span> <span class="n">mos7840_tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_icount</span> <span class="o">=</span> <span class="n">mos7840_get_icount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attach</span> <span class="o">=</span> <span class="n">mos7840_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">mos7840_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">mos7840_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_bulk_callback</span> <span class="o">=</span> <span class="n">mos7840_bulk_in_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_int_callback</span> <span class="o">=</span> <span class="n">mos7840_interrupt_callback</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_serial_driver</span> <span class="o">*</span> <span class="k">const</span> <span class="n">serial_drivers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">moschip7840_4port_device</span><span class="p">,</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="n">module_usb_serial_driver</span><span class="p">(</span><span class="n">serial_drivers</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug enabled or not&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
