<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › misc › sisusbvga › sisusb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>sisusb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * sisusb - usb kernel driver for SiS315(E) based USB2VGA dongles</span>
<span class="cm"> *</span>
<span class="cm"> * Main part</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005 by Thomas Winischhofer, Vienna, Austria</span>
<span class="cm"> *</span>
<span class="cm"> * If distributed as part of the Linux kernel, this code is licensed under the</span>
<span class="cm"> * terms of the GPL v2.</span>
<span class="cm"> *</span>
<span class="cm"> * Otherwise, the following license terms apply:</span>
<span class="cm"> *</span>
<span class="cm"> * * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * * modification, are permitted provided that the following conditions</span>
<span class="cm"> * * are met:</span>
<span class="cm"> * * 1) Redistributions of source code must retain the above copyright</span>
<span class="cm"> * *    notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> * * 2) Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> * *    notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> * *    documentation and/or other materials provided with the distribution.</span>
<span class="cm"> * * 3) The name of the author may not be used to endorse or promote products</span>
<span class="cm"> * *    derived from this software without specific psisusbr written permission.</span>
<span class="cm"> * *</span>
<span class="cm"> * * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS&#39;&#39; AND ANY EXPRESSED OR</span>
<span class="cm"> * * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</span>
<span class="cm"> * * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.</span>
<span class="cm"> * * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="cm"> * * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT</span>
<span class="cm"> * * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="cm"> * * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="cm"> * * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> * * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<span class="cm"> * * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:	Thomas Winischhofer &lt;thomas@winischhofer.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/kref.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>

<span class="cp">#include &quot;sisusb.h&quot;</span>
<span class="cp">#include &quot;sisusb_init.h&quot;</span>

<span class="cp">#ifdef INCL_SISUSB_CON</span>
<span class="cp">#include &lt;linux/font.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#define SISUSB_DONTSYNC</span>

<span class="cm">/* Forward declarations / clean-up routines */</span>

<span class="cp">#ifdef INCL_SISUSB_CON</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sisusb_first_vc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sisusb_last_vc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">sisusb_first_vc</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">sisusb_last_vc</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="s">&quot;Number of first console to take over (1 - MAX_NR_CONSOLES)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="s">&quot;Number of last console to take over (1 - MAX_NR_CONSOLES)&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">sisusb_driver</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisusb_free_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUMOBUFS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">obuf</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">obuf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">obuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">ibuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">ibuf</span><span class="p">);</span>
		<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">ibuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisusb_free_urbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUMOBUFS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisurbout</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisurbout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisurbin</span><span class="p">);</span>
	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisurbin</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Level 0: USB transport layer */</span>

<span class="cm">/* 1. out-bulks */</span>

<span class="cm">/* out-urb management */</span>

<span class="cm">/* Return 1 if all free, 0 otherwise */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_all_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">numobufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">urbstatus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SU_URB_BUSY</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Kill all busy URBs */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisusb_kill_all_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sisusb_all_free</span><span class="p">(</span><span class="n">sisusb</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">numobufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">urbstatus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SU_URB_BUSY</span><span class="p">)</span>
			<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisurbout</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Return 1 if ok, 0 if error (not all complete within timeout) */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_wait_all_out_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
				<span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">sisusb_all_free</span><span class="p">(</span><span class="n">sisusb</span><span class="p">)),</span>
				 <span class="n">timeout</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_outurb_available</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">numobufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">urbstatus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SU_URB_BUSY</span><span class="o">|</span><span class="n">SU_URB_ALLOC</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_get_free_outbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
				<span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">sisusb_outurb_available</span><span class="p">(</span><span class="n">sisusb</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">timeout</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_alloc_outbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">sisusb_outurb_available</span><span class="p">(</span><span class="n">sisusb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">urbstatus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">SU_URB_ALLOC</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisusb_free_outbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">numobufs</span><span class="p">))</span>
		<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">urbstatus</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SU_URB_ALLOC</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* completion callback */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisusb_bulk_completeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_urb_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sisusb</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">sisusb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifndef SISUSB_DONTSYNC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span>
		<span class="o">*</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span> <span class="o">+=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">urbstatus</span><span class="p">[</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">urbindex</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SU_URB_BUSY</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_bulkout_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">actual_length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisurbout</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">byteswritten</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set up URB */</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
		<span class="n">sisusb_bulk_completeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">urbout_context</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>

	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">tflags</span><span class="p">;</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set up context */</span>
	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">urbout_context</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">actual_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="o">?</span>
						<span class="nb">NULL</span> <span class="o">:</span> <span class="n">actual_length</span><span class="p">;</span>

	<span class="cm">/* Declare this urb/buffer in use */</span>
	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">urbstatus</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">|=</span> <span class="n">SU_URB_BUSY</span><span class="p">;</span>

	<span class="cm">/* Submit URB */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="cm">/* If OK, and if timeout &gt; 0, wait for completion */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span>
				   <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">urbstatus</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SU_URB_BUSY</span><span class="p">)),</span>
				   <span class="n">timeout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">urbstatus</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SU_URB_BUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* URB timed out... kill it and report error */</span>
			<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Otherwise, report urb status */</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
			<span class="n">byteswritten</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">actual_length</span><span class="p">)</span>
		<span class="o">*</span><span class="n">actual_length</span> <span class="o">=</span> <span class="n">byteswritten</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 2. in-bulks */</span>

<span class="cm">/* completion callback */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisusb_bulk_completein</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">completein</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_bulkin_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">actual_length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisurbin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">readbytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			<span class="n">sisusb_bulk_completein</span><span class="p">,</span> <span class="n">sisusb</span><span class="p">);</span>

	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">tflags</span><span class="p">;</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">completein</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">,</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">completein</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">completein</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* URB timed out... kill it and report error */</span>
			<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* URB completed within timeout */</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
			<span class="n">readbytes</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">actual_length</span><span class="p">)</span>
		<span class="o">*</span><span class="n">actual_length</span> <span class="o">=</span> <span class="n">readbytes</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Level 1:  */</span>

<span class="cm">/* Send a bulk message of variable size</span>
<span class="cm"> *</span>
<span class="cm"> * To copy the data from userspace, give pointer to &quot;userbuffer&quot;,</span>
<span class="cm"> * to copy from (non-DMA) kernel memory, give &quot;kernbuffer&quot;. If</span>
<span class="cm"> * both of these are NULL, it is assumed, that the transfer</span>
<span class="cm"> * buffer &quot;sisusb-&gt;obuf[index]&quot; is set up with the data to send.</span>
<span class="cm"> * Index is ignored if either kernbuffer or userbuffer is set.</span>
<span class="cm"> * If async is nonzero, URBs will be sent without waiting for</span>
<span class="cm"> * completion of the previous URB.</span>
<span class="cm"> *</span>
<span class="cm"> * (return 0 on success)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sisusb_send_bulk_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">kernbuffer</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userbuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
		<span class="kt">ssize_t</span> <span class="o">*</span><span class="n">bytes_written</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tflags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">async</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retry</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">passsize</span><span class="p">,</span> <span class="n">thispass</span><span class="p">,</span> <span class="n">transferred_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fromuser</span> <span class="o">=</span> <span class="p">(</span><span class="n">userbuffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fromkern</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernbuffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">bytes_written</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* If we copy data from kernel or userspace, force the</span>
<span class="cm">	 * allocation of a buffer/urb. If we have the data in</span>
<span class="cm">	 * the transfer buffer[index] already, reuse the buffer/URB</span>
<span class="cm">	 * if the length is &gt; buffer size. (So, transmitting</span>
<span class="cm">	 * large data amounts directly from the transfer buffer</span>
<span class="cm">	 * treats the buffer as a ring buffer. However, we need</span>
<span class="cm">	 * to sync in this case.)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fromuser</span> <span class="o">||</span> <span class="n">fromkern</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">obufsize</span><span class="p">)</span>
		<span class="n">async</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">passsize</span> <span class="o">=</span> <span class="n">thispass</span> <span class="o">=</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">obufsize</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="o">?</span>
						<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">obufsize</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">sisusb_get_free_outbuf</span><span class="p">(</span><span class="n">sisusb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="n">buffer</span> <span class="o">=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">obuf</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fromuser</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">userbuffer</span><span class="p">,</span> <span class="n">passsize</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="n">userbuffer</span> <span class="o">+=</span> <span class="n">passsize</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fromkern</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">kernbuffer</span><span class="p">,</span> <span class="n">passsize</span><span class="p">);</span>
			<span class="n">kernbuffer</span> <span class="o">+=</span> <span class="n">passsize</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="n">retry</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">thispass</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

			<span class="n">result</span> <span class="o">=</span> <span class="n">sisusb_bulkout_msg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
						<span class="n">index</span><span class="p">,</span>
						<span class="n">pipe</span><span class="p">,</span>
						<span class="n">buffer</span><span class="p">,</span>
						<span class="n">thispass</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">transferred_len</span><span class="p">,</span>
						<span class="n">async</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
						<span class="n">tflags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* Will not happen if async */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retry</span><span class="o">--</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>

				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">async</span> <span class="o">&amp;&amp;</span> <span class="n">transferred_len</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">thispass</span> <span class="o">-=</span> <span class="n">transferred_len</span><span class="p">;</span>
				<span class="n">buffer</span> <span class="o">+=</span> <span class="n">transferred_len</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

		<span class="p">(</span><span class="o">*</span><span class="n">bytes_written</span><span class="p">)</span> <span class="o">+=</span> <span class="n">passsize</span><span class="p">;</span>
		<span class="n">count</span>            <span class="o">-=</span> <span class="n">passsize</span><span class="p">;</span>

		<span class="cm">/* Force new allocation in next iteration */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fromuser</span> <span class="o">||</span> <span class="n">fromkern</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef SISUSB_DONTSYNC</span>
		<span class="p">(</span><span class="o">*</span><span class="n">bytes_written</span><span class="p">)</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="cm">/* Some URBs/buffers might be busy */</span>
<span class="cp">#else</span>
		<span class="n">sisusb_wait_all_out_complete</span><span class="p">(</span><span class="n">sisusb</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">bytes_written</span><span class="p">)</span> <span class="o">=</span> <span class="n">transferred_len</span><span class="p">;</span>
		<span class="cm">/* All URBs and all buffers are available */</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">((</span><span class="o">*</span><span class="n">bytes_written</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Receive a bulk message of variable size</span>
<span class="cm"> *</span>
<span class="cm"> * To copy the data to userspace, give pointer to &quot;userbuffer&quot;,</span>
<span class="cm"> * to copy to kernel memory, give &quot;kernbuffer&quot;. One of them</span>
<span class="cm"> * MUST be set. (There is no technique for letting the caller</span>
<span class="cm"> * read directly from the ibuf.)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sisusb_recv_bulk_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">kernbuffer</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userbuffer</span><span class="p">,</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">bytes_read</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retry</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bufsize</span><span class="p">,</span> <span class="n">thispass</span><span class="p">,</span> <span class="n">transferred_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">bytes_read</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">ibuf</span><span class="p">;</span>
	<span class="n">bufsize</span> <span class="o">=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">ibufsize</span><span class="p">;</span>

	<span class="n">retry</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

<span class="cp">#ifdef SISUSB_DONTSYNC</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisusb_wait_all_out_complete</span><span class="p">(</span><span class="n">sisusb</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

		<span class="n">thispass</span> <span class="o">=</span> <span class="p">(</span><span class="n">bufsize</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="o">?</span> <span class="n">bufsize</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">sisusb_bulkin_msg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
					   <span class="n">pipe</span><span class="p">,</span>
					   <span class="n">buffer</span><span class="p">,</span>
					   <span class="n">thispass</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">transferred_len</span><span class="p">,</span>
					   <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
					   <span class="n">tflags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">transferred_len</span><span class="p">)</span>
			<span class="n">thispass</span> <span class="o">=</span> <span class="n">transferred_len</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retry</span><span class="o">--</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>

			<span class="k">continue</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">thispass</span><span class="p">)</span> <span class="p">{</span>

			<span class="p">(</span><span class="o">*</span><span class="n">bytes_read</span><span class="p">)</span> <span class="o">+=</span> <span class="n">thispass</span><span class="p">;</span>
			<span class="n">count</span>         <span class="o">-=</span> <span class="n">thispass</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">userbuffer</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">userbuffer</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">thispass</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

				<span class="n">userbuffer</span> <span class="o">+=</span> <span class="n">thispass</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="n">memcpy</span><span class="p">(</span><span class="n">kernbuffer</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">thispass</span><span class="p">);</span>
				<span class="n">kernbuffer</span> <span class="o">+=</span> <span class="n">thispass</span><span class="p">;</span>

			<span class="p">}</span>

		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="p">((</span><span class="o">*</span><span class="n">bytes_read</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sisusb_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">sisusb_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">bytes_transferred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef SISUSB_DONTSYNC</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisusb_wait_all_out_complete</span><span class="p">(</span><span class="n">sisusb</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Eventually correct endianness */</span>
	<span class="n">SISUSB_CORRECT_ENDIANNESS_PACKET</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>

	<span class="cm">/* 1. send the packet */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_bulk_msg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_EP_GFX_OUT</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_transferred</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* 2. if packet len == 6, it means we read, so wait for 32bit</span>
<span class="cm">		 *    return value and write it to packet-&gt;data</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_recv_bulk_msg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_EP_GFX_IN</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_transferred</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sisusb_send_bridge_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sisusb_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">bytes_transferred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef SISUSB_DONTSYNC</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisusb_wait_all_out_complete</span><span class="p">(</span><span class="n">sisusb</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Eventually correct endianness */</span>
	<span class="n">SISUSB_CORRECT_ENDIANNESS_PACKET</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>

	<span class="cm">/* 1. send the packet */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_bulk_msg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_EP_BRIDGE_OUT</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_transferred</span><span class="p">,</span> <span class="n">tflags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* 2. if packet len == 6, it means we read, so wait for 32bit</span>
<span class="cm">		 *    return value and write it to packet-&gt;data</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_recv_bulk_msg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_EP_BRIDGE_IN</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_transferred</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* access video memory and mmio (return 0 on success) */</span>

<span class="cm">/* Low level */</span>

<span class="cm">/* The following routines assume being used to transfer byte, word,</span>
<span class="cm"> * long etc.</span>
<span class="cm"> * This means that</span>
<span class="cm"> *   - the write routines expect &quot;data&quot; in machine endianness format.</span>
<span class="cm"> *     The data will be converted to leXX in sisusb_xxx_packet.</span>
<span class="cm"> *   - the read routines can expect read data in machine-endianess.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sisusb_write_memio_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
							<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_packet</span> <span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sisusb_write_memio_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
							<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_packet</span> <span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0003</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>   <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0006</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>   <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000c</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>   <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0008</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>   <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0001</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>   <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sisusb_write_memio_24bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
							<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_packet</span> <span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0007</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000e</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000c</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0001</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0008</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0003</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sisusb_write_memio_long</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
							<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_packet</span> <span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000f</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000e</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0001</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000c</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0003</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0008</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0007</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The xxx_bulk routines copy a buffer of variable size. They treat the</span>
<span class="cm"> * buffer as chars, therefore lsb/msb has to be corrected if using the</span>
<span class="cm"> * byte/word/long/etc routines for speed-up</span>
<span class="cm"> *</span>
<span class="cm"> * If data is from userland, set &quot;userbuffer&quot; (and clear &quot;kernbuffer&quot;),</span>
<span class="cm"> * if data is in kernel space, set &quot;kernbuffer&quot; (and clear &quot;userbuffer&quot;);</span>
<span class="cm"> * if neither &quot;kernbuffer&quot; nor &quot;userbuffer&quot; are given, it is assumed</span>
<span class="cm"> * that the data already is in the transfer buffer &quot;sisusb-&gt;obuf[index]&quot;.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sisusb_write_mem_bulk</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">kernbuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userbuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
				<span class="kt">ssize_t</span> <span class="o">*</span><span class="n">bytes_written</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_packet</span> <span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">msgcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>   <span class="n">swap8</span><span class="p">,</span> <span class="n">fromkern</span> <span class="o">=</span> <span class="n">kernbuffer</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>  <span class="n">swap16</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">swap32</span><span class="p">,</span> <span class="n">flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* if neither kernbuffer not userbuffer are given, assume</span>
<span class="cm">	 * data in obuf</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fromkern</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">userbuffer</span><span class="p">)</span>
		<span class="n">kernbuffer</span> <span class="o">=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">obuf</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="p">(</span><span class="o">*</span><span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">length</span> <span class="o">&amp;=</span> <span class="mh">0x00ffffff</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>

	    <span class="k">switch</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">userbuffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">swap8</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userbuffer</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">swap8</span> <span class="o">=</span> <span class="n">kernbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_write_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
							<span class="n">SISUSB_TYPE_MEM</span><span class="p">,</span>
							<span class="n">addr</span><span class="p">,</span> <span class="n">swap8</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">bytes_written</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">userbuffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">swap16</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userbuffer</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">swap16</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">kernbuffer</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_write_memio_word</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
							<span class="n">SISUSB_TYPE_MEM</span><span class="p">,</span>
							<span class="n">addr</span><span class="p">,</span>
							<span class="n">swap16</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">bytes_written</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">3</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">userbuffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">userbuffer</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
				<span class="n">swap32</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="cp">#else</span>
				<span class="n">swap32</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="cp">#endif</span>
			<span class="p">}</span> <span class="k">else</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
				<span class="n">swap32</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="n">kernbuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">kernbuffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="cp">#else</span>
				<span class="n">swap32</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernbuffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="n">kernbuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">kernbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="cp">#endif</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_write_memio_24bit</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
							<span class="n">SISUSB_TYPE_MEM</span><span class="p">,</span>
							<span class="n">addr</span><span class="p">,</span>
							<span class="n">swap32</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">bytes_written</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">4</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">userbuffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">swap32</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userbuffer</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">swap32</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">kernbuffer</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_write_memio_long</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
							<span class="n">SISUSB_TYPE_MEM</span><span class="p">,</span>
							<span class="n">addr</span><span class="p">,</span>
							<span class="n">swap32</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">bytes_written</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">length</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="p">{</span>

			   <span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="mh">0x001f</span><span class="p">;</span>
			   <span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="mh">0x000001d4</span><span class="p">;</span>
			   <span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			   <span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_bridge_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			   <span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="mh">0x001f</span><span class="p">;</span>
			   <span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="mh">0x000001d0</span><span class="p">;</span>
			   <span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
			   <span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_bridge_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			   <span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="mh">0x001f</span><span class="p">;</span>
			   <span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="mh">0x000001c0</span><span class="p">;</span>
			   <span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">flag</span> <span class="o">|</span> <span class="mh">0x16</span><span class="p">;</span>
			   <span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_bridge_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			   <span class="k">if</span> <span class="p">(</span><span class="n">userbuffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_bulk_msg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
							<span class="n">SISUSB_EP_GFX_LBULK_OUT</span><span class="p">,</span>
							<span class="p">(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">),</span>
							<span class="nb">NULL</span><span class="p">,</span> <span class="n">userbuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							<span class="n">bytes_written</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">userbuffer</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">bytes_written</span><span class="p">);</span>
			   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fromkern</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_bulk_msg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
							<span class="n">SISUSB_EP_GFX_LBULK_OUT</span><span class="p">,</span>
							<span class="p">(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">),</span>
							<span class="n">kernbuffer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							<span class="n">bytes_written</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">kernbuffer</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">bytes_written</span><span class="p">);</span>
			   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_bulk_msg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
							<span class="n">SISUSB_EP_GFX_LBULK_OUT</span><span class="p">,</span>
							<span class="p">(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">),</span>
							<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
							<span class="n">bytes_written</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">kernbuffer</span> <span class="o">+=</span> <span class="p">((</span><span class="o">*</span><span class="n">bytes_written</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">obufsize</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
			   <span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			   <span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="mh">0x001f</span><span class="p">;</span>
			   <span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="mh">0x00000194</span><span class="p">;</span>
			   <span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			   <span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_bridge_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			   <span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="mh">0x001f</span><span class="p">;</span>
			   <span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="mh">0x00000190</span><span class="p">;</span>
			   <span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
			   <span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_bridge_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			   <span class="k">if</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">flagb0</span> <span class="o">!=</span> <span class="mh">0x16</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="mh">0x001f</span><span class="p">;</span>
				<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="mh">0x00000180</span><span class="p">;</span>
				<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">flag</span> <span class="o">|</span> <span class="mh">0x16</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_bridge_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">flagb0</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>
			   <span class="p">}</span>
			   <span class="k">if</span> <span class="p">(</span><span class="n">userbuffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_bulk_msg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
							<span class="n">SISUSB_EP_GFX_BULK_OUT</span><span class="p">,</span>
							<span class="p">(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">),</span>
							<span class="nb">NULL</span><span class="p">,</span> <span class="n">userbuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							<span class="n">bytes_written</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">userbuffer</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">bytes_written</span><span class="p">);</span>
			   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fromkern</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_bulk_msg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
							<span class="n">SISUSB_EP_GFX_BULK_OUT</span><span class="p">,</span>
							<span class="p">(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">),</span>
							<span class="n">kernbuffer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							<span class="n">bytes_written</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">kernbuffer</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">bytes_written</span><span class="p">);</span>
			   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_bulk_msg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
							<span class="n">SISUSB_EP_GFX_BULK_OUT</span><span class="p">,</span>
							<span class="p">(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">),</span>
							<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
							<span class="n">bytes_written</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">kernbuffer</span> <span class="o">+=</span> <span class="p">((</span><span class="o">*</span><span class="n">bytes_written</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">obufsize</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
			   <span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">msgcount</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">msgcount</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">)</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Wrote %zd of %d bytes, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="o">*</span><span class="n">bytes_written</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msgcount</span> <span class="o">==</span> <span class="mi">500</span><span class="p">)</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Too many errors, logging stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">bytes_written</span><span class="p">);</span>
			<span class="n">length</span> <span class="o">-=</span> <span class="p">(</span><span class="o">*</span><span class="n">bytes_written</span><span class="p">);</span>
	    <span class="p">}</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Remember: Read data in packet is in machine-endianess! So for</span>
<span class="cm"> * byte, word, 24bit, long no endian correction is necessary.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sisusb_read_memio_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
							<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_packet</span> <span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">CLEARPACKET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sisusb_read_memio_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
							<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_packet</span> <span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">CLEARPACKET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0003</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">packet</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0006</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000c</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0008</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0001</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sisusb_read_memio_24bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
							<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_packet</span> <span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0007</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000e</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000c</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0001</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">|=</span> <span class="p">((</span><span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0008</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0003</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">|=</span> <span class="p">((</span><span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sisusb_read_memio_long</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
							<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_packet</span> <span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000f</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">packet</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000e</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0001</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000c</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0003</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0008</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0007</span><span class="p">;</span>
			<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sisusb_read_mem_bulk</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">kernbuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span>
				<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userbuffer</span><span class="p">,</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">bytes_read</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">swap16</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">swap32</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">length</span> <span class="o">&amp;=</span> <span class="mh">0x00ffffff</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>

	    <span class="k">switch</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="mi">1</span>:

			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_MEM</span><span class="p">,</span>
								<span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">(</span><span class="o">*</span><span class="n">bytes_read</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">userbuffer</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						<span class="p">(</span><span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userbuffer</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">kernbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_memio_word</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_MEM</span><span class="p">,</span>
								<span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">swap16</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">(</span><span class="o">*</span><span class="n">bytes_read</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">userbuffer</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">swap16</span><span class="p">,</span>
						<span class="p">(</span><span class="n">u16</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userbuffer</span><span class="p">))</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">kernbuffer</span><span class="p">)</span> <span class="o">=</span> <span class="n">swap16</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_memio_24bit</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_MEM</span><span class="p">,</span>
								<span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">swap32</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">(</span><span class="o">*</span><span class="n">bytes_read</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">swap32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">swap32</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">swap32</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="cp">#else</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">swap32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">swap32</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">swap32</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="cp">#endif</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">userbuffer</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">userbuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">kernbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
					<span class="n">kernbuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
					<span class="n">kernbuffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_memio_long</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_MEM</span><span class="p">,</span>
								<span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">swap32</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">(</span><span class="o">*</span><span class="n">bytes_read</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">userbuffer</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">swap32</span><span class="p">,</span>
						<span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userbuffer</span><span class="p">))</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

					<span class="n">userbuffer</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">kernbuffer</span><span class="p">)</span> <span class="o">=</span> <span class="n">swap32</span><span class="p">;</span>
					<span class="n">kernbuffer</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">length</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
	    <span class="p">}</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* High level: Gfx (indexed) register access */</span>

<span class="cp">#ifdef INCL_SISUSB_CON</span>
<span class="kt">int</span>
<span class="nf">sisusb_setreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sisusb_write_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_IO</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">sisusb_getreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sisusb_read_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_IO</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">int</span>
<span class="nf">sisusb_setidxreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_write_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_IO</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_write_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_IO</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">sisusb_getidxreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_write_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_IO</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_IO</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">sisusb_setidxregandor</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idx</span><span class="p">,</span>
							<span class="n">u8</span> <span class="n">myand</span><span class="p">,</span> <span class="n">u8</span> <span class="n">myor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_write_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_IO</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_IO</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">myand</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">myor</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_write_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_IO</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_setidxregmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idx</span><span class="p">,</span>
							<span class="n">u8</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_write_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_IO</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_IO</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_write_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_IO</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">sisusb_setidxregor</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">myor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">(</span><span class="n">sisusb_setidxregandor</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">myor</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">sisusb_setidxregand</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">myand</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">(</span><span class="n">sisusb_setidxregandor</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">myand</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Write/read video ram */</span>

<span class="cp">#ifdef INCL_SISUSB_CON</span>
<span class="kt">int</span>
<span class="nf">sisusb_writeb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">adr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">(</span><span class="n">sisusb_write_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_MEM</span><span class="p">,</span> <span class="n">adr</span><span class="p">,</span> <span class="n">data</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">sisusb_readb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">adr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">(</span><span class="n">sisusb_read_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_MEM</span><span class="p">,</span> <span class="n">adr</span><span class="p">,</span> <span class="n">data</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">sisusb_copy_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">bytes_written</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">(</span><span class="n">sisusb_write_mem_bulk</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bytes_written</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#ifdef SISUSBENDIANTEST</span>
<span class="kt">int</span>
<span class="nf">sisusb_read_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">bytes_written</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">(</span><span class="n">sisusb_read_mem_bulk</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bytes_written</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef SISUSBENDIANTEST</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisusb_testreadwrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="n">srcbuffer</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x77</span> <span class="p">};</span>
    <span class="kt">char</span> <span class="n">destbuffer</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
    <span class="kt">size_t</span> <span class="n">dummy</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>

    <span class="n">sisusb_copy_memory</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">srcbuffer</span><span class="p">,</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vrambase</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sisusb: rwtest %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">sisusb_read_memory</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">destbuffer</span><span class="p">,</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vrambase</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	     <span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rwtest read[%d] = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">destbuffer</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* access pci config registers (reg numbers 0, 4, 8, etc) */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_write_pci_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_packet</span> <span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="mh">0x008f</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">regnum</span> <span class="o">|</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_read_pci_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_packet</span> <span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="mh">0x008f</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">regnum</span> <span class="o">|</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">packet</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Clear video RAM */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_clear_vram</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&lt;</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vrambase</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vrambase</span> <span class="o">+</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vramsize</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vrambase</span> <span class="o">+</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vramsize</span><span class="p">)</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vrambase</span> <span class="o">+</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vramsize</span> <span class="o">-</span> <span class="n">address</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* allocate free buffer/urb and clear the buffer */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">sisusb_alloc_outbuf</span><span class="p">(</span><span class="n">sisusb</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">obuf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">obufsize</span><span class="p">);</span>

	<span class="cm">/* We can write a length &gt; buffer size here. The buffer</span>
<span class="cm">	 * data will simply be re-used (like a ring-buffer).</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_write_mem_bulk</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">j</span><span class="p">);</span>

	<span class="cm">/* Free the buffer/urb */</span>
	<span class="n">sisusb_free_outbuf</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize the graphics core (return 0 on success)</span>
<span class="cm"> * This resets the graphics hardware and puts it into</span>
<span class="cm"> * a defined mode (640x480@60Hz)</span>
<span class="cm"> */</span>

<span class="cp">#define GETREG(r,d)     sisusb_read_memio_byte(sisusb, SISUSB_TYPE_IO, r, d)</span>
<span class="cp">#define SETREG(r,d)	sisusb_write_memio_byte(sisusb, SISUSB_TYPE_IO, r, d)</span>
<span class="cp">#define SETIREG(r,i,d)	sisusb_setidxreg(sisusb, r, i, d)</span>
<span class="cp">#define GETIREG(r,i,d)  sisusb_getidxreg(sisusb, r, i, d)</span>
<span class="cp">#define SETIREGOR(r,i,o)	sisusb_setidxregor(sisusb, r, i, o)</span>
<span class="cp">#define SETIREGAND(r,i,a)	sisusb_setidxregand(sisusb, r, i, a)</span>
<span class="cp">#define SETIREGANDOR(r,i,a,o)	sisusb_setidxregandor(sisusb, r, i, a, o)</span>
<span class="cp">#define READL(a,d)	sisusb_read_memio_long(sisusb, SISUSB_TYPE_MEM, a, d)</span>
<span class="cp">#define WRITEL(a,d)	sisusb_write_memio_long(sisusb, SISUSB_TYPE_MEM, a, d)</span>
<span class="cp">#define READB(a,d)	sisusb_read_memio_byte(sisusb, SISUSB_TYPE_MEM, a, d)</span>
<span class="cp">#define WRITEB(a,d)	sisusb_write_memio_byte(sisusb, SISUSB_TYPE_MEM, a, d)</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_triggersr16</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ramtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp8</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">GETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ramtype</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp8</span> <span class="o">&amp;=</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">);</span>
		<span class="n">tmp8</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmp8</span> <span class="o">|=</span> <span class="mh">0xc0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">);</span>
		<span class="n">tmp8</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">);</span>
		<span class="n">tmp8</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">);</span>
		<span class="n">tmp8</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">);</span>
		<span class="n">tmp8</span> <span class="o">|=</span> <span class="mh">0xd0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">);</span>
		<span class="n">tmp8</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">);</span>
		<span class="n">tmp8</span> <span class="o">|=</span> <span class="mh">0xa0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_getbuswidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bw</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">ramtype</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ramptr</span> <span class="o">=</span> <span class="n">SISUSB_PCI_MEMBASE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">GETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramtype</span><span class="p">);</span>
	<span class="n">ramtype</span> <span class="o">&amp;=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ramtype</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_triggersr16</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">ramtype</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x01234567</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span>  <span class="mi">4</span><span class="p">,</span> <span class="mh">0x456789ab</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span>  <span class="mi">8</span><span class="p">,</span> <span class="mh">0x89abcdef</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="mh">0xcdef0123</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">28</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">READL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span>  <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">READL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span>  <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t1</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">READL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span>  <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t2</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">READL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ramtype</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="o">*</span><span class="n">chab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">*</span><span class="n">bw</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">t3</span> <span class="o">!=</span> <span class="mh">0xcdef0123</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">t2</span> <span class="o">!=</span> <span class="mh">0x89abcdef</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">t1</span> <span class="o">==</span> <span class="mh">0x456789ab</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">t0</span> <span class="o">==</span> <span class="mh">0x01234567</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">chab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">*</span><span class="n">bw</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">t1</span> <span class="o">!=</span> <span class="mh">0x456789ab</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">t0</span> <span class="o">!=</span> <span class="mh">0x01234567</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">chab</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">*</span><span class="n">bw</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGANDOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span><span class="mh">0x01</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_triggersr16</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">ramtype</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x89abcdef</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span>  <span class="mi">4</span><span class="p">,</span> <span class="mh">0xcdef0123</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span>  <span class="mi">8</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0xaaaaaaaa</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0xaaaaaaaa</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">READL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span>  <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">t1</span> <span class="o">!=</span> <span class="mh">0xcdef0123</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">bw</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="o">*</span><span class="n">chab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">*</span><span class="n">bw</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>	<span class="cm">/* default: cha, bw = 64 */</span>

		<span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t1</span> <span class="o">==</span> <span class="mh">0x456789ab</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t0</span> <span class="o">==</span> <span class="mh">0x01234567</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">chab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">*</span><span class="n">bw</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
				<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t0</span> <span class="o">==</span> <span class="mh">0x01234567</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">chab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">*</span><span class="n">bw</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
				<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_triggersr16</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">ramtype</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span>  <span class="mi">0</span><span class="p">,</span> <span class="mh">0x01234567</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span>  <span class="mi">4</span><span class="p">,</span> <span class="mh">0x456789ab</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span>  <span class="mi">8</span><span class="p">,</span> <span class="mh">0x89abcdef</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="mh">0xcdef0123</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">28</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">READL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span>  <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t0</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">READL</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span>  <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">t1</span> <span class="o">==</span> <span class="mh">0x456789ab</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">t0</span> <span class="o">==</span> <span class="mh">0x01234567</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">chab</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">*</span><span class="n">bw</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
					<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
				<span class="p">}</span> <span class="cm">/* else error */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">t0</span> <span class="o">==</span> <span class="mh">0x01234567</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">chab</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">*</span><span class="n">bw</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
					<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
				<span class="p">}</span> <span class="cm">/* else error */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_verify_mclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ramptr</span> <span class="o">=</span> <span class="n">SISUSB_PCI_MEMBASE</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEB</span><span class="p">(</span><span class="n">ramptr</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEB</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">READB</span><span class="p">(</span><span class="n">ramptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp1</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">READB</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp1</span> <span class="o">!=</span> <span class="mh">0xaa</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tmp2</span> <span class="o">!=</span> <span class="mh">0x55</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">GETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp1</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp1</span> <span class="o">&amp;</span> <span class="mh">0xfb</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>  <span class="cm">/* not on 330 */</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">);</span> <span class="cm">/* not on 330 */</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEB</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">READB</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp1</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEB</span><span class="p">(</span><span class="n">ramptr</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_set_rank</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">iret</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">rankno</span><span class="p">,</span> <span class="n">u8</span> <span class="n">chab</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">dramtype</span><span class="p">[][</span><span class="mi">5</span><span class="p">],</span>
			<span class="kt">int</span> <span class="n">bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ranksize</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="o">*</span><span class="n">iret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rankno</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dramtype</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ranksize</span> <span class="o">=</span> <span class="n">dramtype</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">bw</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ranksize</span> <span class="o">*</span> <span class="n">rankno</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">ranksize</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">+=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">rankno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">bw</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">chab</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_triggersr16</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* sic! */</span>

	<span class="o">*</span><span class="n">iret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_check_rbc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">iret</span><span class="p">,</span> <span class="n">u32</span> <span class="n">inc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">testn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">j</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="o">*</span><span class="n">iret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">testn</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">WRITEL</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vrambase</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
		<span class="n">j</span> <span class="o">+=</span> <span class="n">inc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">testn</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">READL</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vrambase</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">j</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">j</span> <span class="o">+=</span> <span class="n">inc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">iret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_check_ranks</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">iret</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rankno</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bw</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">rtype</span><span class="p">[][</span><span class="mi">5</span><span class="p">])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i2ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inc</span><span class="p">;</span>

	<span class="o">*</span><span class="n">iret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">rankno</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">rtype</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
			    <span class="n">rtype</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
			    <span class="n">rtype</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
			    <span class="n">bw</span> <span class="o">/</span> <span class="mi">64</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_check_rbc</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2ret</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">inc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">rtype</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">bw</span> <span class="o">/</span> <span class="mi">64</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_check_rbc</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2ret</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">inc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="n">bw</span> <span class="o">/</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_check_rbc</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2ret</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="o">*</span><span class="n">iret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_get_sdram_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">iret</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bw</span><span class="p">,</span>
								<span class="kt">int</span> <span class="n">chab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i2ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">sdramtype</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mh">0x35</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mh">0x44</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mh">0x31</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mh">0x25</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mh">0x34</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x21</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x30</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x24</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">2</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="o">*</span><span class="n">iret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* error */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGANDOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">sdramtype</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_set_rank</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2ret</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
						<span class="n">chab</span><span class="p">,</span> <span class="n">sdramtype</span><span class="p">,</span> <span class="n">bw</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2ret</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_check_ranks</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2ret</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						<span class="n">bw</span><span class="p">,</span> <span class="n">sdramtype</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i2ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">iret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* ram size found */</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_setup_screen</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clrall</span><span class="p">,</span> <span class="kt">int</span> <span class="n">drwfr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">modex</span><span class="p">,</span> <span class="n">modey</span><span class="p">,</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="n">modex</span> <span class="o">=</span> <span class="mi">640</span><span class="p">;</span> <span class="n">modey</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span> <span class="n">bpp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">address</span> <span class="o">=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vrambase</span><span class="p">;</span>	<span class="cm">/* Clear video ram */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clrall</span><span class="p">)</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vramsize</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">modex</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">*</span> <span class="n">modey</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_clear_vram</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">drwfr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">modex</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">address</span> <span class="o">=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vrambase</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_write_memio_word</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_MEM</span><span class="p">,</span>
							<span class="n">address</span><span class="p">,</span> <span class="mh">0xf100</span><span class="p">);</span>
			<span class="n">address</span> <span class="o">+=</span> <span class="p">(</span><span class="n">modex</span> <span class="o">*</span> <span class="p">(</span><span class="n">modey</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_write_memio_word</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_MEM</span><span class="p">,</span>
							<span class="n">address</span><span class="p">,</span> <span class="mh">0xf100</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">modey</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">address</span> <span class="o">=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vrambase</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">*</span> <span class="n">modex</span><span class="p">)</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_write_memio_word</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_MEM</span><span class="p">,</span>
							<span class="n">address</span><span class="p">,</span> <span class="mh">0xf100</span><span class="p">);</span>
			<span class="n">address</span> <span class="o">+=</span> <span class="p">((</span><span class="n">modex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_write_memio_word</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISUSB_TYPE_MEM</span><span class="p">,</span>
							<span class="n">address</span><span class="p">,</span> <span class="mh">0xf100</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_set_default_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">touchengines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">modex</span><span class="p">,</span> <span class="n">modey</span><span class="p">,</span> <span class="n">bpp</span><span class="p">,</span> <span class="n">du</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sr31</span><span class="p">,</span> <span class="n">cr63</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">attrdata</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0x06</span><span class="p">,</span><span class="mh">0x07</span><span class="p">,</span>
		<span class="mh">0x08</span><span class="p">,</span><span class="mh">0x09</span><span class="p">,</span><span class="mh">0x0a</span><span class="p">,</span><span class="mh">0x0b</span><span class="p">,</span><span class="mh">0x0c</span><span class="p">,</span><span class="mh">0x0d</span><span class="p">,</span><span class="mh">0x0e</span><span class="p">,</span><span class="mh">0x0f</span><span class="p">,</span>
		<span class="mh">0x01</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">crtcrdata</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x5f</span><span class="p">,</span><span class="mh">0x4f</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x82</span><span class="p">,</span><span class="mh">0x54</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x0b</span><span class="p">,</span><span class="mh">0x3e</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0xea</span><span class="p">,</span><span class="mh">0x8c</span><span class="p">,</span><span class="mh">0xdf</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0xe7</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0xa3</span><span class="p">,</span>
		<span class="mh">0xff</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">grcdata</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0x0f</span><span class="p">,</span>
		<span class="mh">0xff</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">crtcdata</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x5f</span><span class="p">,</span><span class="mh">0x4f</span><span class="p">,</span><span class="mh">0x4f</span><span class="p">,</span><span class="mh">0x83</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0x81</span><span class="p">,</span><span class="mh">0x0b</span><span class="p">,</span><span class="mh">0x3e</span><span class="p">,</span>
		<span class="mh">0xe9</span><span class="p">,</span><span class="mh">0x8b</span><span class="p">,</span><span class="mh">0xdf</span><span class="p">,</span><span class="mh">0xe8</span><span class="p">,</span><span class="mh">0x0c</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span>
		<span class="mh">0x00</span>
	<span class="p">};</span>

	<span class="n">modex</span> <span class="o">=</span> <span class="mi">640</span><span class="p">;</span> <span class="n">modey</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span> <span class="n">bpp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">GETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sr31</span><span class="p">);</span>
	<span class="n">GETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr63</span><span class="p">);</span>
	<span class="n">SETIREGOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="n">cr63</span> <span class="o">&amp;</span> <span class="mh">0xbf</span><span class="p">);</span>
	<span class="n">SETIREGOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">SETIREGOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">);</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>	<span class="cm">/* seq */</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">);</span>
	<span class="n">SETREG</span><span class="p">(</span><span class="n">SISMISCW</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">);</span>		<span class="cm">/* misc */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x18</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* crtc */</span>
		<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">crtcrdata</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x13</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* att */</span>
		<span class="n">GETREG</span><span class="p">(</span><span class="n">SISINPSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp8</span><span class="p">);</span>
		<span class="n">SETREG</span><span class="p">(</span><span class="n">SISAR</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">SETREG</span><span class="p">(</span><span class="n">SISAR</span><span class="p">,</span> <span class="n">attrdata</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">SISINPSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp8</span><span class="p">);</span>
	<span class="n">SETREG</span><span class="p">(</span><span class="n">SISAR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
	<span class="n">SETREG</span><span class="p">(</span><span class="n">SISAR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">SISINPSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp8</span><span class="p">);</span>
	<span class="n">SETREG</span><span class="p">(</span><span class="n">SISAR</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">GETREG</span><span class="p">(</span><span class="n">SISINPSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp8</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x08</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* grc */</span>
		<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISGR</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">grcdata</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISGR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x0E</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* clr ext */</span>
		<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">);</span>
	<span class="n">SETREG</span><span class="p">(</span><span class="n">SISMISCW</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">);</span>		<span class="cm">/* sync */</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* crtc */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">crtcdata</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">crtcdata</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mh">0x15</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">crtcdata</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">crtcdata</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="p">(</span><span class="n">crtcdata</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">));</span>
	<span class="n">SETIREGANDOR</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="p">((</span><span class="n">crtcdata</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">);</span>
	<span class="n">du</span> <span class="o">=</span> <span class="p">(</span><span class="n">modex</span> <span class="o">/</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* offset/pitch */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modex</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="n">du</span> <span class="o">+=</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="n">SETIREGANDOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="p">((</span><span class="n">du</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="p">(</span><span class="n">du</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">du</span> <span class="o">&lt;&lt;=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">tmp8</span> <span class="o">=</span> <span class="n">du</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">du</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="n">tmp8</span><span class="o">++</span><span class="p">;</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">);</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* VCLK */</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">);</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">);</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">);</span>	<span class="cm">/* FIFO */</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">);</span>
	<span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">);</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">);</span>
	<span class="n">SETIREGOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>	<span class="cm">/* mode regs */</span>
	<span class="n">SETIREGANDOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">);</span>
	<span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">);</span>
	<span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">);</span>
	<span class="n">SETIREGANDOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
	<span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">);</span>
	<span class="n">SETIREGANDOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">);</span>

	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* adjust frame */</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">);</span>

	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">);</span>	<span class="cm">/* enable display */</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="p">(</span><span class="n">cr63</span> <span class="o">&amp;</span> <span class="mh">0xbf</span><span class="p">));</span>
	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="p">(</span><span class="n">sr31</span> <span class="o">&amp;</span> <span class="mh">0xfb</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">touchengines</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">);</span>	<span class="cm">/* enable engines */</span>
		<span class="n">SETIREGOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">);</span>

		<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>	<span class="cm">/* disable cmdqueue */</span>
		<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>	<span class="cm">/* we just set std mode #44 */</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_init_gfxcore</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">chab</span><span class="p">,</span> <span class="n">iret</span><span class="p">,</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp8</span><span class="p">,</span> <span class="n">ramtype</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp32</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">mclktable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span>
		<span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span>
		<span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span>
		<span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">143</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">eclktable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span>
		<span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span>
		<span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span>
		<span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">143</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ramtypetable1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span>
		<span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span>
		<span class="mh">0xba</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span>
		<span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span>
		<span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
		<span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ramtypetable2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span>
		<span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xf8</span>
	<span class="p">};</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">retry</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Enable VGA */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">GETREG</span><span class="p">(</span><span class="n">SISVGAEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp8</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETREG</span><span class="p">(</span><span class="n">SISVGAEN</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp8</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">));</span>

		<span class="cm">/* Enable GPU access to VRAM */</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">GETREG</span><span class="p">(</span><span class="n">SISMISCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp8</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETREG</span><span class="p">(</span><span class="n">SISMISCW</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp8</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Reset registers */</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETREG</span><span class="p">(</span><span class="n">SISMISCW</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x1f</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x27</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x31</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x3d</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x1b</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x79</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x7c</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">GETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramtype</span><span class="p">);</span>
		<span class="n">ramtype</span> <span class="o">&amp;=</span> <span class="mh">0x03</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="n">mclktable</span><span class="p">[</span><span class="n">ramtype</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="n">mclktable</span><span class="p">[(</span><span class="n">ramtype</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="n">mclktable</span><span class="p">[(</span><span class="n">ramtype</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="n">eclktable</span><span class="p">[</span><span class="n">ramtype</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">eclktable</span><span class="p">[(</span><span class="n">ramtype</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">eclktable</span><span class="p">[(</span><span class="n">ramtype</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x15</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x1b</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ramtypetable1</span><span class="p">[(</span><span class="n">j</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">ramtype</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x44</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ramtypetable2</span><span class="p">[(</span><span class="n">j</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">ramtype</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGOR</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISCAP</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">GETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp8</span><span class="p">);</span>
		<span class="n">tmp8</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISPART1</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp32</span><span class="p">);</span>
		<span class="n">tmp32</span> <span class="o">&amp;=</span> <span class="mh">0x00f00000</span><span class="p">;</span>
		<span class="n">tmp8</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp32</span> <span class="o">==</span> <span class="mh">0x100000</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x33</span> <span class="o">:</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">);</span>
		<span class="n">tmp8</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp32</span> <span class="o">==</span> <span class="mh">0x100000</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xaa</span> <span class="o">:</span> <span class="mh">0x88</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_set_default_mode</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_triggersr16</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">ramtype</span><span class="p">);</span>

		<span class="cm">/* Disable refresh */</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGAND</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_getbuswidth</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chab</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_verify_mclk</span><span class="p">(</span><span class="n">sisusb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ramtype</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_get_sdram_size</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iret</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">chab</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;RAM size detection failed, assuming 8MB video RAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span><span class="mh">0x14</span><span class="p">,</span><span class="mh">0x31</span><span class="p">);</span>
				<span class="cm">/* TODO */</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DDR RAM device found, assuming 8MB video RAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span><span class="mh">0x14</span><span class="p">,</span><span class="mh">0x31</span><span class="p">);</span>
			<span class="cm">/* *** TODO *** */</span>
		<span class="p">}</span>

		<span class="cm">/* Enable refresh */</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">ramtypetable1</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">ramtype</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">ramtypetable1</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="n">ramtype</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="n">ramtypetable1</span><span class="p">[</span><span class="mi">16</span> <span class="o">+</span> <span class="n">ramtype</span><span class="p">]);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREGOR</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">SETIREG</span><span class="p">(</span><span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef SETREG</span>
<span class="cp">#undef GETREG</span>
<span class="cp">#undef SETIREG</span>
<span class="cp">#undef GETIREG</span>
<span class="cp">#undef SETIREGOR</span>
<span class="cp">#undef SETIREGAND</span>
<span class="cp">#undef SETIREGANDOR</span>
<span class="cp">#undef READL</span>
<span class="cp">#undef WRITEL</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sisusb_get_ramconfig</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp8</span><span class="p">,</span> <span class="n">tmp82</span><span class="p">,</span> <span class="n">ramtype</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ramtypetext1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ramtypetext2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>	<span class="s">&quot;SDR SDRAM&quot;</span><span class="p">,</span> <span class="s">&quot;SDR SGRAM&quot;</span><span class="p">,</span>
					<span class="s">&quot;DDR SDRAM&quot;</span><span class="p">,</span> <span class="s">&quot;DDR SGRAM&quot;</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">busSDR</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">busDDR</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>  <span class="mi">64</span><span class="p">,</span>  <span class="mi">64</span><span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">busDDRA</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">64</span><span class="o">+</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="o">+</span><span class="mi">32</span> <span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="o">+</span><span class="mi">32</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="o">+</span><span class="mi">32</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">};</span>

	<span class="n">sisusb_getidxreg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp8</span><span class="p">);</span>
	<span class="n">sisusb_getidxreg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp82</span><span class="p">);</span>
	<span class="n">sisusb_getidxreg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISSR</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramtype</span><span class="p">);</span>
	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vramsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">tmp8</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">ramtype</span> <span class="o">&amp;=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">tmp8</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="n">ramtypetext1</span> <span class="o">=</span> <span class="s">&quot;1 ch/1 r&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp82</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bw</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bw</span> <span class="o">=</span> <span class="n">busSDR</span><span class="p">[(</span><span class="n">tmp8</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)];</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">ramtypetext1</span> <span class="o">=</span> <span class="s">&quot;1 ch/2 r&quot;</span><span class="p">;</span>
		<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vramsize</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bw</span> <span class="o">=</span> <span class="n">busSDR</span><span class="p">[(</span><span class="n">tmp8</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">ramtypetext1</span> <span class="o">=</span> <span class="s">&quot;asymmeric&quot;</span><span class="p">;</span>
		<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vramsize</span> <span class="o">+=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vramsize</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
		<span class="n">bw</span> <span class="o">=</span> <span class="n">busDDRA</span><span class="p">[(</span><span class="n">tmp8</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">ramtypetext1</span> <span class="o">=</span> <span class="s">&quot;2 channel&quot;</span><span class="p">;</span>
		<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vramsize</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bw</span> <span class="o">=</span> <span class="n">busDDR</span><span class="p">[(</span><span class="n">tmp8</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%dMB %s %s, bus width %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vramsize</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">),</span> <span class="n">ramtypetext1</span><span class="p">,</span>
			<span class="n">ramtypetext2</span><span class="p">[</span><span class="n">ramtype</span><span class="p">],</span> <span class="n">bw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_do_init_gfxdevice</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_packet</span> <span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp32</span><span class="p">;</span>

	<span class="cm">/* Do some magic */</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="mh">0x001f</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="mh">0x00000324</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="mh">0x00000004</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusb_send_bridge_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="mh">0x001f</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="mh">0x00000364</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="mh">0x00000004</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_bridge_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="mh">0x001f</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="mh">0x00000384</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="mh">0x00000004</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_bridge_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="mh">0x001f</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="mh">0x00000100</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="mh">0x00000700</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_bridge_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="mh">0x000f</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="mh">0x00000004</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_bridge_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">data</span> <span class="o">|=</span> <span class="mh">0x17</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_bridge_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Init BAR 0 (VRAM) */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp32</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_write_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xfffffff0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp32</span><span class="p">);</span>
	<span class="n">tmp32</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">tmp32</span> <span class="o">|=</span> <span class="n">SISUSB_PCI_MEMBASE</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_write_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">tmp32</span><span class="p">);</span>

	<span class="cm">/* Init BAR 1 (MMIO) */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp32</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_write_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xfffffff0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp32</span><span class="p">);</span>
	<span class="n">tmp32</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">tmp32</span> <span class="o">|=</span> <span class="n">SISUSB_PCI_MMIOBASE</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_write_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">tmp32</span><span class="p">);</span>

	<span class="cm">/* Init BAR 2 (i/o ports) */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp32</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_write_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xfffffff0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp32</span><span class="p">);</span>
	<span class="n">tmp32</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">tmp32</span> <span class="o">|=</span> <span class="n">SISUSB_PCI_IOPORTBASE</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_write_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">tmp32</span><span class="p">);</span>

	<span class="cm">/* Enable memory and i/o access */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp32</span><span class="p">);</span>
	<span class="n">tmp32</span> <span class="o">|=</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_write_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">tmp32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Some further magic */</span>
		<span class="n">packet</span><span class="p">.</span><span class="n">header</span>  <span class="o">=</span> <span class="mh">0x001f</span><span class="p">;</span>
		<span class="n">packet</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="mh">0x00000050</span><span class="p">;</span>
		<span class="n">packet</span><span class="p">.</span><span class="n">data</span>    <span class="o">=</span> <span class="mh">0x000000ff</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_send_bridge_packet</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize the graphics device (return 0 on success)</span>
<span class="cm"> * This initializes the net2280 as well as the PCI registers</span>
<span class="cm"> * of the graphics board.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_init_gfxdevice</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">initscreen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp32</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">devinit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Read PCI BARs and see if they have been set up */</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp32</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp32</span> <span class="o">&amp;</span> <span class="mh">0xfffffff0</span><span class="p">)</span> <span class="o">==</span> <span class="n">SISUSB_PCI_MEMBASE</span><span class="p">)</span> <span class="n">test</span><span class="o">++</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp32</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp32</span> <span class="o">&amp;</span> <span class="mh">0xfffffff0</span><span class="p">)</span> <span class="o">==</span> <span class="n">SISUSB_PCI_MMIOBASE</span><span class="p">)</span> <span class="n">test</span><span class="o">++</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_read_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp32</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp32</span> <span class="o">&amp;</span> <span class="mh">0xfffffff0</span><span class="p">)</span> <span class="o">==</span> <span class="n">SISUSB_PCI_IOPORTBASE</span><span class="p">)</span> <span class="n">test</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* No? So reset the device */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">devinit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">test</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_do_init_gfxdevice</span><span class="p">(</span><span class="n">sisusb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">devinit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">devinit</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Initialize the graphics core */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sisusb_init_gfxcore</span><span class="p">(</span><span class="n">sisusb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">gfxinit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sisusb_get_ramconfig</span><span class="p">(</span><span class="n">sisusb</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_set_default_mode</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_setup_screen</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">initscreen</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef INCL_SISUSB_CON</span>

<span class="cm">/* Set up default text mode:</span>
<span class="cm">   - Set text mode (0x03)</span>
<span class="cm">   - Upload default font</span>
<span class="cm">   - Upload user font (if available)</span>
<span class="cm">*/</span>

<span class="kt">int</span>
<span class="nf">sisusb_reset_text_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">font_slot</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">font_desc</span> <span class="o">*</span><span class="n">myfont</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tempbuf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">tempbufb</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">written</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">bootstring</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;SiSUSB VGA text console, (C) 2005 Thomas Winischhofer.&quot;</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">bootlogo</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;(o_ //</span><span class="se">\\</span><span class="s"> V_/_&quot;</span><span class="p">;</span>

	<span class="cm">/* sisusb-&gt;lock is down */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">IOAddress</span> <span class="o">=</span> <span class="n">SISUSB_PCI_IOPORTBASE</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">;</span>
	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">sisusb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sisusb</span><span class="p">;</span>

	<span class="cm">/* Set mode 0x03 */</span>
	<span class="n">SiSUSBSetMode</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">myfont</span> <span class="o">=</span> <span class="n">find_font</span><span class="p">(</span><span class="s">&quot;VGA8x16&quot;</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tempbuf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="mi">8192</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tempbuf</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">32</span><span class="p">),</span> <span class="n">myfont</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/* Upload default font */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sisusbcon_do_font_op</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tempbuf</span><span class="p">,</span> <span class="mi">8192</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">tempbuf</span><span class="p">);</span>

	<span class="cm">/* Upload user font (and reset current slot) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">font_backup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusbcon_do_font_op</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">font_backup</span><span class="p">,</span>
				<span class="mi">8192</span><span class="p">,</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">font_backup_512</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">font_backup_height</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">sisusbcon_do_font_op</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">scrbuf</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">tempbuf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="mi">8192</span><span class="p">)))</span> <span class="p">{</span>

			<span class="n">i</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
			<span class="n">tempbufb</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">tempbuf</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
				<span class="o">*</span><span class="p">(</span><span class="n">tempbufb</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x0720</span><span class="p">;</span>

			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tempbufb</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">tempbuf</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">bootlogo</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">tempbufb</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x0700</span> <span class="o">|</span> <span class="n">bootlogo</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">))</span>
					<span class="n">tempbufb</span> <span class="o">+=</span> <span class="mi">76</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tempbufb</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">tempbuf</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">bootstring</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="o">*</span><span class="p">(</span><span class="n">tempbufb</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x0700</span> <span class="o">|</span> <span class="n">bootstring</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>

			<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_copy_memory</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">tempbuf</span><span class="p">,</span>
				<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vrambase</span><span class="p">,</span> <span class="mi">8192</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">written</span><span class="p">);</span>

			<span class="n">vfree</span><span class="p">(</span><span class="n">tempbuf</span><span class="p">);</span>

		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">scrbuf</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">sisusb_copy_memory</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">scrbuf</span><span class="p">,</span>
				<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vrambase</span><span class="p">,</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">scrbuf_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">written</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_cursor_size_from</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_cursor_size_to</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sisusb_setidxreg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span>
				<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_cursor_size_from</span><span class="p">);</span>
		<span class="n">sisusb_setidxregandor</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span>
				<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_cursor_size_to</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sisusb_setidxreg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">);</span>
		<span class="n">sisusb_setidxreg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">);</span>
		<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_cursor_size_to</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_cursor_loc</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_cursor_loc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">bad_cursor_pos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sisusb_set_cursor</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

	<span class="n">sisusb_setidxreg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">cur_start_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">sisusb_setidxreg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">SISCR</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">cur_start_addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">textmodedestroyed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* sisusb-&gt;lock is down */</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/* fops */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">subminor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">interface</span> <span class="o">=</span> <span class="n">usb_find_interface</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb_driver</span><span class="p">,</span> <span class="n">subminor</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisusb</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">isopen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">devinit</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span> <span class="o">||</span>
		    <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_SUPER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sisusb_init_gfxdevice</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device not attached to USB 2.0 hub</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Increment usage count for our sisusb */</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>

	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">isopen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">sisusb</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">sisusb_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span> <span class="o">=</span> <span class="n">to_sisusb_dev</span><span class="p">(</span><span class="n">kref</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="p">)</span>
		<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="p">);</span>

	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sisusb_free_buffers</span><span class="p">(</span><span class="n">sisusb</span><span class="p">);</span>
	<span class="n">sisusb_free_urbs</span><span class="p">(</span><span class="n">sisusb</span><span class="p">);</span>
<span class="cp">#ifdef INCL_SISUSB_CON</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sisusb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisusb</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Wait for all URBs to finish if device still present */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb_wait_all_out_complete</span><span class="p">(</span><span class="n">sisusb</span><span class="p">))</span>
			<span class="n">sisusb_kill_all_busy</span><span class="p">(</span><span class="n">sisusb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">isopen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* decrement the usage count on our device */</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">sisusb_delete</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">sisusb_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf8</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">buf16</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf32</span><span class="p">,</span> <span class="n">address</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisusb</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">SISUSB_PCI_PSEUDO_IOPORTBASE</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">&lt;</span>  <span class="n">SISUSB_PCI_PSEUDO_IOPORTBASE</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">-</span>
			<span class="n">SISUSB_PCI_PSEUDO_IOPORTBASE</span> <span class="o">+</span>
			<span class="n">SISUSB_PCI_IOPORTBASE</span><span class="p">;</span>

		<span class="cm">/* Read i/o ports</span>
<span class="cm">		 * Byte, word and long(32) can be read. As this</span>
<span class="cm">		 * emulates inX instructions, the data returned is</span>
<span class="cm">		 * in machine-endianness.</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">case</span> <span class="mi">1</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">sisusb_read_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
							<span class="n">SISUSB_TYPE_IO</span><span class="p">,</span>
							<span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf8</span><span class="p">))</span>
					<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">buf8</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">))</span>
					<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mi">2</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">sisusb_read_memio_word</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
							<span class="n">SISUSB_TYPE_IO</span><span class="p">,</span>
							<span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf16</span><span class="p">))</span>
					<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">buf16</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">))</span>
					<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mi">4</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">sisusb_read_memio_long</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
							<span class="n">SISUSB_TYPE_IO</span><span class="p">,</span>
							<span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf32</span><span class="p">))</span>
					<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">buf32</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">))</span>
					<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">SISUSB_PCI_PSEUDO_MEMBASE</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">&lt;</span>  <span class="n">SISUSB_PCI_PSEUDO_MEMBASE</span> <span class="o">+</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vramsize</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">-</span>
			<span class="n">SISUSB_PCI_PSEUDO_MEMBASE</span> <span class="o">+</span>
			<span class="n">SISUSB_PCI_MEMBASE</span><span class="p">;</span>

		<span class="cm">/* Read video ram</span>
<span class="cm">		 * Remember: Data delivered is never endian-corrected</span>
<span class="cm">		 */</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">sisusb_read_mem_bulk</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_read</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bytes_read</span><span class="p">)</span>
			<span class="n">errno</span> <span class="o">=</span> <span class="n">bytes_read</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span>  <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">SISUSB_PCI_PSEUDO_MMIOBASE</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">&lt;</span>  <span class="n">SISUSB_PCI_PSEUDO_MMIOBASE</span> <span class="o">+</span> <span class="n">SISUSB_PCI_MMIOSIZE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">-</span>
			<span class="n">SISUSB_PCI_PSEUDO_MMIOBASE</span> <span class="o">+</span>
			<span class="n">SISUSB_PCI_MMIOBASE</span><span class="p">;</span>

		<span class="cm">/* Read MMIO</span>
<span class="cm">		 * Remember: Data delivered is never endian-corrected</span>
<span class="cm">		 */</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">sisusb_read_mem_bulk</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_read</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bytes_read</span><span class="p">)</span>
			<span class="n">errno</span> <span class="o">=</span> <span class="n">bytes_read</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span>  <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">SISUSB_PCI_PSEUDO_PCIBASE</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">SISUSB_PCI_PSEUDO_PCIBASE</span> <span class="o">+</span> <span class="mh">0x5c</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">-</span> <span class="n">SISUSB_PCI_PSEUDO_PCIBASE</span><span class="p">;</span>

		<span class="cm">/* Read PCI config register</span>
<span class="cm">		 * Return value delivered in machine endianness.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sisusb_read_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf32</span><span class="p">))</span>
			<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">buf32</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">))</span>
			<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADFD</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">+=</span> <span class="n">bytes_read</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">errno</span> <span class="o">?</span> <span class="n">errno</span> <span class="o">:</span> <span class="n">bytes_read</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">sisusb_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
								<span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf8</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">buf16</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf32</span><span class="p">,</span> <span class="n">address</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisusb</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">SISUSB_PCI_PSEUDO_IOPORTBASE</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">&lt;</span>  <span class="n">SISUSB_PCI_PSEUDO_IOPORTBASE</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">-</span>
			<span class="n">SISUSB_PCI_PSEUDO_IOPORTBASE</span> <span class="o">+</span>
			<span class="n">SISUSB_PCI_IOPORTBASE</span><span class="p">;</span>

		<span class="cm">/* Write i/o ports</span>
<span class="cm">		 * Byte, word and long(32) can be written. As this</span>
<span class="cm">		 * emulates outX instructions, the data is expected</span>
<span class="cm">		 * in machine-endianness.</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">case</span> <span class="mi">1</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">buf8</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">))</span>
					<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sisusb_write_memio_byte</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
							<span class="n">SISUSB_TYPE_IO</span><span class="p">,</span>
							<span class="n">address</span><span class="p">,</span> <span class="n">buf8</span><span class="p">))</span>
					<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mi">2</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">buf16</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">))</span>
					<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sisusb_write_memio_word</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
							<span class="n">SISUSB_TYPE_IO</span><span class="p">,</span>
							<span class="n">address</span><span class="p">,</span> <span class="n">buf16</span><span class="p">))</span>
					<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mi">4</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">buf32</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">))</span>
					<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sisusb_write_memio_long</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span>
							<span class="n">SISUSB_TYPE_IO</span><span class="p">,</span>
							<span class="n">address</span><span class="p">,</span> <span class="n">buf32</span><span class="p">))</span>
					<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">SISUSB_PCI_PSEUDO_MEMBASE</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">&lt;</span>  <span class="n">SISUSB_PCI_PSEUDO_MEMBASE</span> <span class="o">+</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vramsize</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">-</span>
			<span class="n">SISUSB_PCI_PSEUDO_MEMBASE</span> <span class="o">+</span>
			<span class="n">SISUSB_PCI_MEMBASE</span><span class="p">;</span>

		<span class="cm">/* Write video ram.</span>
<span class="cm">		 * Buffer is copied 1:1, therefore, on big-endian</span>
<span class="cm">		 * machines, the data must be swapped by userland</span>
<span class="cm">		 * in advance (if applicable; no swapping in 8bpp</span>
<span class="cm">		 * mode or if YUV data is being transferred).</span>
<span class="cm">		 */</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">sisusb_write_mem_bulk</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					<span class="n">count</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_written</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bytes_written</span><span class="p">)</span>
			<span class="n">errno</span> <span class="o">=</span> <span class="n">bytes_written</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span>  <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">SISUSB_PCI_PSEUDO_MMIOBASE</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">&lt;</span>  <span class="n">SISUSB_PCI_PSEUDO_MMIOBASE</span> <span class="o">+</span> <span class="n">SISUSB_PCI_MMIOSIZE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">-</span>
			<span class="n">SISUSB_PCI_PSEUDO_MMIOBASE</span> <span class="o">+</span>
			<span class="n">SISUSB_PCI_MMIOBASE</span><span class="p">;</span>

		<span class="cm">/* Write MMIO.</span>
<span class="cm">		 * Buffer is copied 1:1, therefore, on big-endian</span>
<span class="cm">		 * machines, the data must be swapped by userland</span>
<span class="cm">		 * in advance.</span>
<span class="cm">		 */</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">sisusb_write_mem_bulk</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					<span class="n">count</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_written</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bytes_written</span><span class="p">)</span>
			<span class="n">errno</span> <span class="o">=</span> <span class="n">bytes_written</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span>  <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">SISUSB_PCI_PSEUDO_PCIBASE</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">SISUSB_PCI_PSEUDO_PCIBASE</span> <span class="o">+</span> <span class="n">SISUSB_PCI_PCONFSIZE</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">-</span> <span class="n">SISUSB_PCI_PSEUDO_PCIBASE</span><span class="p">;</span>

		<span class="cm">/* Write PCI config register.</span>
<span class="cm">		 * Given value expected in machine endianness.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">buf32</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">))</span>
			<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sisusb_write_pci_config</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">buf32</span><span class="p">))</span>
			<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>


	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* Error */</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADFD</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="o">+=</span> <span class="n">bytes_written</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">errno</span> <span class="o">?</span> <span class="n">errno</span> <span class="o">:</span> <span class="n">bytes_written</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">loff_t</span>
<span class="nf">sisusb_lseek</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">orig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisusb</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">orig</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">;</span>
			<span class="cm">/* never negative, no force_successful_syscall needed */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">;</span>
			<span class="cm">/* never negative, no force_successful_syscall needed */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* seeking relative to &quot;end of file&quot; is not supported */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sisusb_handle_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sisusb_command</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span>
							<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">retval</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">address</span><span class="p">;</span>

	<span class="cm">/* All our commands require the device</span>
<span class="cm">	 * to be initialized.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">devinit</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">y</span><span class="o">-&gt;</span><span class="n">data3</span> <span class="o">-</span>
		<span class="n">SISUSB_PCI_PSEUDO_IOPORTBASE</span> <span class="o">+</span>
		<span class="n">SISUSB_PCI_IOPORTBASE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SUCMD_GET</span>:
			<span class="n">retval</span> <span class="o">=</span> <span class="n">sisusb_getidxreg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
							 <span class="n">y</span><span class="o">-&gt;</span><span class="n">data0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">data1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">y</span><span class="p">)))</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SUCMD_SET</span>:
			<span class="n">retval</span> <span class="o">=</span> <span class="n">sisusb_setidxreg</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
						<span class="n">y</span><span class="o">-&gt;</span><span class="n">data0</span><span class="p">,</span> <span class="n">y</span><span class="o">-&gt;</span><span class="n">data1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SUCMD_SETOR</span>:
			<span class="n">retval</span> <span class="o">=</span> <span class="n">sisusb_setidxregor</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
						<span class="n">y</span><span class="o">-&gt;</span><span class="n">data0</span><span class="p">,</span> <span class="n">y</span><span class="o">-&gt;</span><span class="n">data1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SUCMD_SETAND</span>:
			<span class="n">retval</span> <span class="o">=</span> <span class="n">sisusb_setidxregand</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
						<span class="n">y</span><span class="o">-&gt;</span><span class="n">data0</span><span class="p">,</span> <span class="n">y</span><span class="o">-&gt;</span><span class="n">data1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SUCMD_SETANDOR</span>:
			<span class="n">retval</span> <span class="o">=</span> <span class="n">sisusb_setidxregandor</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
						<span class="n">y</span><span class="o">-&gt;</span><span class="n">data0</span><span class="p">,</span> <span class="n">y</span><span class="o">-&gt;</span><span class="n">data1</span><span class="p">,</span> <span class="n">y</span><span class="o">-&gt;</span><span class="n">data2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SUCMD_SETMASK</span>:
			<span class="n">retval</span> <span class="o">=</span> <span class="n">sisusb_setidxregmask</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
						<span class="n">y</span><span class="o">-&gt;</span><span class="n">data0</span><span class="p">,</span> <span class="n">y</span><span class="o">-&gt;</span><span class="n">data1</span><span class="p">,</span> <span class="n">y</span><span class="o">-&gt;</span><span class="n">data2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SUCMD_CLRSCR</span>:
			<span class="cm">/* Gfx core must be initialized */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">gfxinit</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

			<span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">data0</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">data1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">y</span><span class="o">-&gt;</span><span class="n">data2</span><span class="p">;</span>
			<span class="n">address</span> <span class="o">=</span> <span class="n">y</span><span class="o">-&gt;</span><span class="n">data3</span> <span class="o">-</span>
				<span class="n">SISUSB_PCI_PSEUDO_MEMBASE</span> <span class="o">+</span>
				<span class="n">SISUSB_PCI_MEMBASE</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">sisusb_clear_vram</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SUCMD_HANDLETEXTMODE</span>:
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef INCL_SISUSB_CON</span>
			<span class="cm">/* Gfx core must be initialized, SiS_Pr must exist */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">gfxinit</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">data0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">retval</span> <span class="o">=</span> <span class="n">sisusb_reset_text_mode</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">textmodedestroyed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef INCL_SISUSB_CON</span>
		<span class="k">case</span> <span class="n">SUCMD_SETMODE</span>:
			<span class="cm">/* Gfx core must be initialized, SiS_Pr must exist */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">gfxinit</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">IOAddress</span> <span class="o">=</span> <span class="n">SISUSB_PCI_IOPORTBASE</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">;</span>
			<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">sisusb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sisusb</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">SiSUSBSetMode</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">y</span><span class="o">-&gt;</span><span class="n">data3</span><span class="p">))</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SUCMD_SETVESAMODE</span>:
			<span class="cm">/* Gfx core must be initialized, SiS_Pr must exist */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">gfxinit</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">IOAddress</span> <span class="o">=</span> <span class="n">SISUSB_PCI_IOPORTBASE</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">;</span>
			<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="o">-&gt;</span><span class="n">sisusb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sisusb</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">SiSUSBSetVESAMode</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span><span class="p">,</span> <span class="n">y</span><span class="o">-&gt;</span><span class="n">data3</span><span class="p">))</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="nl">default:</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">sisusb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sisusb_info</span> <span class="n">x</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sisusb_command</span> <span class="n">y</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisusb</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">||</span> <span class="o">!</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">SISUSB_GET_CONFIG_SIZE</span>:

			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">argp</span><span class="p">))</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SISUSB_GET_CONFIG</span>:

			<span class="n">x</span><span class="p">.</span><span class="n">sisusb_id</span>	    <span class="o">=</span> <span class="n">SISUSB_ID</span><span class="p">;</span>
			<span class="n">x</span><span class="p">.</span><span class="n">sisusb_version</span>    <span class="o">=</span> <span class="n">SISUSB_VERSION</span><span class="p">;</span>
			<span class="n">x</span><span class="p">.</span><span class="n">sisusb_revision</span>   <span class="o">=</span> <span class="n">SISUSB_REVISION</span><span class="p">;</span>
			<span class="n">x</span><span class="p">.</span><span class="n">sisusb_patchlevel</span> <span class="o">=</span> <span class="n">SISUSB_PATCHLEVEL</span><span class="p">;</span>
			<span class="n">x</span><span class="p">.</span><span class="n">sisusb_gfxinit</span>    <span class="o">=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">gfxinit</span><span class="p">;</span>
			<span class="n">x</span><span class="p">.</span><span class="n">sisusb_vrambase</span>   <span class="o">=</span> <span class="n">SISUSB_PCI_PSEUDO_MEMBASE</span><span class="p">;</span>
			<span class="n">x</span><span class="p">.</span><span class="n">sisusb_mmiobase</span>   <span class="o">=</span> <span class="n">SISUSB_PCI_PSEUDO_MMIOBASE</span><span class="p">;</span>
			<span class="n">x</span><span class="p">.</span><span class="n">sisusb_iobase</span>     <span class="o">=</span> <span class="n">SISUSB_PCI_PSEUDO_IOPORTBASE</span><span class="p">;</span>
			<span class="n">x</span><span class="p">.</span><span class="n">sisusb_pcibase</span>    <span class="o">=</span> <span class="n">SISUSB_PCI_PSEUDO_PCIBASE</span><span class="p">;</span>
			<span class="n">x</span><span class="p">.</span><span class="n">sisusb_vramsize</span>   <span class="o">=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vramsize</span><span class="p">;</span>
			<span class="n">x</span><span class="p">.</span><span class="n">sisusb_minor</span>	    <span class="o">=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>
			<span class="n">x</span><span class="p">.</span><span class="n">sisusb_fbdevactive</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef INCL_SISUSB_CON</span>
			<span class="n">x</span><span class="p">.</span><span class="n">sisusb_conactive</span>  <span class="o">=</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">haveconsole</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">x</span><span class="p">.</span><span class="n">sisusb_conactive</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">sisusb_reserved</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">sisusb_reserved</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SISUSB_COMMAND</span>:

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">sisusb_handle_command</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err_out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef SISUSB_NEW_CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">long</span>
<span class="nf">sisusb_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SISUSB_GET_CONFIG_SIZE</span>:
		<span class="k">case</span> <span class="n">SISUSB_GET_CONFIG</span>:
		<span class="k">case</span> <span class="n">SISUSB_COMMAND</span>:
			<span class="n">retval</span> <span class="o">=</span> <span class="n">sisusb_ioctl</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">usb_sisusb_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">sisusb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">sisusb_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>		<span class="n">sisusb_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">sisusb_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">sisusb_lseek</span><span class="p">,</span>
<span class="cp">#ifdef SISUSB_NEW_CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span> <span class="n">sisusb_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">sisusb_ioctl</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_class_driver</span> <span class="n">usb_sisusb_class</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;sisusbvga%d&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span> <span class="o">=</span>		<span class="o">&amp;</span><span class="n">usb_sisusb_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">minor_base</span> <span class="o">=</span>	<span class="n">SISUSB_MINOR</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sisusb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB2VGA dongle found at address %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">);</span>

	<span class="cm">/* Allocate memory for our private */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisusb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sisusb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate memory for private data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">));</span>

	<span class="cm">/* Register device */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">usb_register_dev</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usb_sisusb_class</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to get a minor for device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">minor</span>      <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>
	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">vrambase</span>   <span class="o">=</span> <span class="n">SISUSB_PCI_MEMBASE</span><span class="p">;</span>
	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">mmiobase</span>   <span class="o">=</span> <span class="n">SISUSB_PCI_MMIOBASE</span><span class="p">;</span>
	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">mmiosize</span>   <span class="o">=</span> <span class="n">SISUSB_PCI_MMIOSIZE</span><span class="p">;</span>
	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">ioportbase</span> <span class="o">=</span> <span class="n">SISUSB_PCI_IOPORTBASE</span><span class="p">;</span>
	<span class="cm">/* Everything else is zero */</span>

	<span class="cm">/* Allocate buffers */</span>
	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">ibufsize</span> <span class="o">=</span> <span class="n">SISUSB_IBUF_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">ibuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">SISUSB_IBUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate memory for input buffer&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">numobufs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">obufsize</span> <span class="o">=</span> <span class="n">SISUSB_OBUF_SIZE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUMOBUFS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">obuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">SISUSB_OBUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate memory for output buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error_3</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">numobufs</span><span class="o">++</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/* Allocate URBs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisurbin</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate URBs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">completein</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">numobufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisurbout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate URBs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">urbout_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sisusb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sisusb</span><span class="p">;</span>
		<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">urbout_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urbindex</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">urbstatus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Allocated %d output buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">numobufs</span><span class="p">);</span>

<span class="cp">#ifdef INCL_SISUSB_CON</span>
	<span class="cm">/* Allocate our SiS_Pr */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">SiS_Pr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">SiS_Private</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate SiS_Pr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Do remaining init stuff */</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">sisusb</span><span class="p">);</span>

	<span class="n">usb_get_dev</span><span class="p">(</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="p">);</span>

	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_SUPER</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">initscreen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef INCL_SISUSB_CON</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sisusb_first_vc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sisusb_last_vc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sisusb_first_vc</span> <span class="o">&lt;=</span> <span class="n">sisusb_last_vc</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sisusb_last_vc</span> <span class="o">&lt;=</span> <span class="n">MAX_NR_CONSOLES</span><span class="p">)</span>
			<span class="n">initscreen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sisusb_init_gfxdevice</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">initscreen</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to early initialize device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Not attached to USB 2.0 hub, deferring init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef SISUSBENDIANTEST</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;*** RWTEST ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">sisusb_testreadwrite</span><span class="p">(</span><span class="n">sisusb</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">sisusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;*** RWTEST END ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef INCL_SISUSB_CON</span>
	<span class="n">sisusb_console_init</span><span class="p">(</span><span class="n">sisusb</span><span class="p">,</span> <span class="n">sisusb_first_vc</span><span class="p">,</span> <span class="n">sisusb_last_vc</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_4:</span>
	<span class="n">sisusb_free_urbs</span><span class="p">(</span><span class="n">sisusb</span><span class="p">);</span>
<span class="nl">error_3:</span>
	<span class="n">sisusb_free_buffers</span><span class="p">(</span><span class="n">sisusb</span><span class="p">);</span>
<span class="nl">error_2:</span>
	<span class="n">usb_deregister_dev</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usb_sisusb_class</span><span class="p">);</span>
<span class="nl">error_1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sisusb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sisusb_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sisusb_usb_data</span> <span class="o">*</span><span class="n">sisusb</span><span class="p">;</span>

	<span class="cm">/* This should *not* happen */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sisusb</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef INCL_SISUSB_CON</span>
	<span class="n">sisusb_console_exit</span><span class="p">(</span><span class="n">sisusb</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">usb_deregister_dev</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usb_sisusb_class</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Wait for all URBs to complete and kill them in case (MUST do) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sisusb_wait_all_out_complete</span><span class="p">(</span><span class="n">sisusb</span><span class="p">))</span>
		<span class="n">sisusb_kill_all_busy</span><span class="p">(</span><span class="n">sisusb</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* decrement our usage count */</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">sisusb_delete</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">sisusb_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0711</span><span class="p">,</span> <span class="mh">0x0550</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0711</span><span class="p">,</span> <span class="mh">0x0900</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0711</span><span class="p">,</span> <span class="mh">0x0901</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0711</span><span class="p">,</span> <span class="mh">0x0902</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0711</span><span class="p">,</span> <span class="mh">0x0903</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0711</span><span class="p">,</span> <span class="mh">0x0918</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0711</span><span class="p">,</span> <span class="mh">0x0920</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x182d</span><span class="p">,</span> <span class="mh">0x021c</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x182d</span><span class="p">,</span> <span class="mh">0x0269</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span> <span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">sisusb_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">sisusb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;sisusb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">sisusb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span>	<span class="n">sisusb_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">sisusb_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">usb_sisusb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

<span class="cp">#ifdef INCL_SISUSB_CON</span>
	<span class="n">sisusb_init_concode</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">usb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">usb_sisusb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sisusb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">usb_sisusb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">usb_sisusb_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Thomas Winischhofer &lt;thomas@winischhofer.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;sisusbvga - Driver for Net2280/SiS315-based USB2VGA dongles&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
