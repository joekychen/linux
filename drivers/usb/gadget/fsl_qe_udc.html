<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › gadget › fsl_qe_udc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fsl_qe_udc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * driver/usb/gadget/fsl_qe_udc.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2006-2008 Freescale Semiconductor, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * 	Xie Xiaobo &lt;X.Xie@freescale.com&gt;</span>
<span class="cm"> * 	Li Yang &lt;leoli@freescale.com&gt;</span>
<span class="cm"> * 	Based on bareboard code from Shlomi Gridish.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Freescle QE/CPM USB Pheripheral Controller Driver</span>
<span class="cm"> * The controller can be found on MPC8360, MPC8272, and etc.</span>
<span class="cm"> * MPC8360 Rev 1.1 may need QE mircocode update</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation;  either version 2 of the License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#undef USB_TRACE</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/of_address.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>
<span class="cp">#include &lt;linux/usb/otg.h&gt;</span>
<span class="cp">#include &lt;asm/qe.h&gt;</span>
<span class="cp">#include &lt;asm/cpm.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/reg.h&gt;</span>
<span class="cp">#include &quot;fsl_qe_udc.h&quot;</span>

<span class="cp">#define DRIVER_DESC     &quot;Freescale QE/CPM USB Device Controller driver&quot;</span>
<span class="cp">#define DRIVER_AUTHOR   &quot;Xie XiaoBo&quot;</span>
<span class="cp">#define DRIVER_VERSION  &quot;1.0&quot;</span>

<span class="cp">#define DMA_ADDR_INVALID        (~(dma_addr_t)0)</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;fsl_qe_udc&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="n">DRIVER_DESC</span><span class="p">;</span>

<span class="cm">/*ep name is important in gadget, it should obey the convention of ep_match()*/</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">ep_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;ep0-control&quot;</span><span class="p">,</span> <span class="cm">/* everyone has ep0 */</span>
	<span class="cm">/* 3 configurable endpoints */</span>
	<span class="s">&quot;ep1&quot;</span><span class="p">,</span>
	<span class="s">&quot;ep2&quot;</span><span class="p">,</span>
	<span class="s">&quot;ep3&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">qe_ep0_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span>		<span class="n">USB_ENDPOINT_XFER_CONTROL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span>	<span class="n">USB_MAX_CTRL_PAYLOAD</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/********************************************************************</span>
<span class="cm"> *      Internal Used Function Start</span>
<span class="cm">********************************************************************/</span>
<span class="cm">/*-----------------------------------------------------------------</span>
<span class="cm"> * done() - retire a request; caller blocked irqs</span>
<span class="cm"> *--------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">done</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">stopped</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">;</span>

	<span class="cm">/* the req-&gt;queue pointer is used by ep_queue() func, in which</span>
<span class="cm">	 * the request will be added into a udc_ep-&gt;queue &#39;d tail</span>
<span class="cm">	 * so here the req will be dropped from the ep-&gt;queue</span>
<span class="cm">	 */</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="cm">/* req.status should be set as -EINPROGRESS in ep_queue() */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
			<span class="n">ep_is_in</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span>
				<span class="o">?</span> <span class="n">DMA_TO_DEVICE</span>
				<span class="o">:</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
			<span class="n">ep_is_in</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span>
				<span class="o">?</span> <span class="n">DMA_TO_DEVICE</span>
				<span class="o">:</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">))</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;complete %s req %p stat %d len %u/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="cm">/* don&#39;t modify queue heads during completion callback */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* this complete() should a func implemented by gadget layer,</span>
<span class="cm">	 * eg fsg-&gt;bulk_in_complete() */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="n">stopped</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-----------------------------------------------------------------</span>
<span class="cm"> * nuke(): delete all requests related to this ep</span>
<span class="cm"> *--------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nuke</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Whether this eq has request linked */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qe_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------*</span>
<span class="cm"> * USB and Endpoint manipulate process, include parameter and register       *</span>
<span class="cm"> *---------------------------------------------------------------------------*/</span>
<span class="cm">/* @value: 1--set stall 0--clean stall */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_eprx_stall_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tem_usep</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">epnum</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>

	<span class="n">tem_usep</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usep</span><span class="p">[</span><span class="n">epnum</span><span class="p">]);</span>
	<span class="n">tem_usep</span> <span class="o">=</span> <span class="n">tem_usep</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">USB_RHS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">tem_usep</span> <span class="o">|=</span> <span class="n">USB_RHS_STALL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
		<span class="n">tem_usep</span> <span class="o">|=</span> <span class="n">USB_RHS_IGNORE_OUT</span><span class="p">;</span>

	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usep</span><span class="p">[</span><span class="n">epnum</span><span class="p">],</span> <span class="n">tem_usep</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_eptx_stall_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tem_usep</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">epnum</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>

	<span class="n">tem_usep</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usep</span><span class="p">[</span><span class="n">epnum</span><span class="p">]);</span>
	<span class="n">tem_usep</span> <span class="o">=</span> <span class="n">tem_usep</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">USB_THS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">tem_usep</span> <span class="o">|=</span> <span class="n">USB_THS_STALL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">USB_DIR_OUT</span><span class="p">)</span>
		<span class="n">tem_usep</span> <span class="o">|=</span> <span class="n">USB_THS_IGNORE_IN</span><span class="p">;</span>

	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usep</span><span class="p">[</span><span class="n">epnum</span><span class="p">],</span> <span class="n">tem_usep</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep0_stall</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qe_eptx_stall_change</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">qe_eprx_stall_change</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_eprx_nack</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">epnum</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set the ep&#39;s nack */</span>
		<span class="n">clrsetbits_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usep</span><span class="p">[</span><span class="n">epnum</span><span class="p">],</span>
				<span class="n">USB_RHS_MASK</span><span class="p">,</span> <span class="n">USB_RHS_NACK</span><span class="p">);</span>

		<span class="cm">/* Mask Rx and Busy interrupts */</span>
		<span class="n">clrbits16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usbmr</span><span class="p">,</span>
				<span class="p">(</span><span class="n">USB_E_RXB_MASK</span> <span class="o">|</span> <span class="n">USB_E_BSY_MASK</span><span class="p">));</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_NACK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_eprx_normal</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_NACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clrsetbits_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usep</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">],</span>
				<span class="n">USB_RTHS_MASK</span><span class="p">,</span> <span class="n">USB_THS_IGNORE_IN</span><span class="p">);</span>

		<span class="cm">/* Unmask RX interrupts */</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usber</span><span class="p">,</span>
				<span class="n">USB_E_BSY_MASK</span> <span class="o">|</span> <span class="n">USB_E_RXB_MASK</span><span class="p">);</span>
		<span class="n">setbits16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usbmr</span><span class="p">,</span>
				<span class="p">(</span><span class="n">USB_E_RXB_MASK</span> <span class="o">|</span> <span class="n">USB_E_BSY_MASK</span><span class="p">));</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_IDLE</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_cmd_stoptx</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">soc_type</span> <span class="o">==</span> <span class="n">PORT_CPM</span><span class="p">)</span>
		<span class="n">cpm_command</span><span class="p">(</span><span class="n">CPM_USB_STOP_TX</span> <span class="o">|</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">&lt;&lt;</span> <span class="n">CPM_USB_EP_SHIFT</span><span class="p">),</span>
				<span class="n">CPM_USB_STOP_TX_OPCODE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">qe_issue_cmd</span><span class="p">(</span><span class="n">QE_USB_STOP_TX</span><span class="p">,</span> <span class="n">QE_CR_SUBBLOCK_USB</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_cmd_restarttx</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">soc_type</span> <span class="o">==</span> <span class="n">PORT_CPM</span><span class="p">)</span>
		<span class="n">cpm_command</span><span class="p">(</span><span class="n">CPM_USB_RESTART_TX</span> <span class="o">|</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">&lt;&lt;</span>
				<span class="n">CPM_USB_EP_SHIFT</span><span class="p">),</span> <span class="n">CPM_USB_RESTART_TX_OPCODE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">qe_issue_cmd</span><span class="p">(</span><span class="n">QE_USB_RESTART_TX</span><span class="p">,</span> <span class="n">QE_CR_SUBBLOCK_USB</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_flushtxfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">;</span>

	<span class="n">qe_ep_cmd_stoptx</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_uscom</span><span class="p">,</span>
		<span class="n">USB_CMD_FLUSH_FIFO</span> <span class="o">|</span> <span class="p">(</span><span class="n">USB_CMD_EP_MASK</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">)));</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep_param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tbptr</span><span class="p">,</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep_param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tbase</span><span class="p">));</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep_param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tstate</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep_param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tbcnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">c_txbd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txbase</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_txbd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txbase</span><span class="p">;</span>
	<span class="n">qe_ep_cmd_restarttx</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_filltxfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>

	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_uscom</span><span class="p">,</span>
			<span class="n">USB_CMD_STR_FIFO</span> <span class="o">|</span> <span class="p">(</span><span class="n">USB_CMD_EP_MASK</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">)));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_epbds_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bdring_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">pipe_num</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">USB_DIR_OUT</span><span class="p">)</span>
		<span class="n">bdring_len</span> <span class="o">=</span> <span class="n">USB_BDRING_LEN_RX</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bdring_len</span> <span class="o">=</span> <span class="n">USB_BDRING_LEN</span><span class="p">;</span>

	<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">bdring_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="n">R_E</span> <span class="o">|</span> <span class="n">R_I</span><span class="p">);</span>
		<span class="n">bd</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="n">R_E</span> <span class="o">|</span> <span class="n">R_I</span> <span class="o">|</span> <span class="n">R_W</span><span class="p">);</span>

	<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txbase</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">USB_BDRING_LEN_TX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bd</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="n">T_W</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmpusep</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">pipe_num</span><span class="p">];</span>
	<span class="n">tmpusep</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usep</span><span class="p">[</span><span class="n">pipe_num</span><span class="p">]);</span>
	<span class="n">tmpusep</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_RTHS_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_DIR_BOTH</span>:
		<span class="n">qe_ep_flushtxfifo</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_DIR_OUT</span>:
		<span class="n">tmpusep</span> <span class="o">|=</span> <span class="n">USB_THS_IGNORE_IN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_DIR_IN</span>:
		<span class="n">qe_ep_flushtxfifo</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">tmpusep</span> <span class="o">|=</span> <span class="n">USB_RHS_IGNORE_OUT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usep</span><span class="p">[</span><span class="n">pipe_num</span><span class="p">],</span> <span class="n">tmpusep</span><span class="p">);</span>

	<span class="n">qe_epbds_reset</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_toggledata01</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">data01</span> <span class="o">^=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_bd_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pipe_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">pipe_num</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_ep_para</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">epparam</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bdring_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">USB_DIR_OUT</span><span class="p">)</span>
		<span class="n">bdring_len</span> <span class="o">=</span> <span class="n">USB_BDRING_LEN_RX</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bdring_len</span> <span class="o">=</span> <span class="n">USB_BDRING_LEN</span><span class="p">;</span>

	<span class="n">epparam</span> <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep_param</span><span class="p">[</span><span class="n">pipe_num</span><span class="p">];</span>
	<span class="cm">/* alloc multi-ram for BD rings and set the ep parameters */</span>
	<span class="n">tmp_addr</span> <span class="o">=</span> <span class="n">cpm_muram_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">bdring_len</span> <span class="o">+</span>
				<span class="n">USB_BDRING_LEN_TX</span><span class="p">),</span> <span class="n">QE_ALIGNMENT_OF_BD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">tmp_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epparam</span><span class="o">-&gt;</span><span class="n">rbase</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">tmp_addr</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epparam</span><span class="o">-&gt;</span><span class="n">tbase</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">tmp_addr</span> <span class="o">+</span>
				<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">)</span> <span class="o">*</span> <span class="n">bdring_len</span><span class="p">)));</span>

	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epparam</span><span class="o">-&gt;</span><span class="n">rbptr</span><span class="p">,</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epparam</span><span class="o">-&gt;</span><span class="n">rbase</span><span class="p">));</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epparam</span><span class="o">-&gt;</span><span class="n">tbptr</span><span class="p">,</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epparam</span><span class="o">-&gt;</span><span class="n">tbase</span><span class="p">));</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span> <span class="o">=</span> <span class="n">cpm_muram_addr</span><span class="p">(</span><span class="n">tmp_addr</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">txbase</span> <span class="o">=</span> <span class="n">cpm_muram_addr</span><span class="p">(</span><span class="n">tmp_addr</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_bd</span><span class="p">)</span>
				<span class="o">*</span> <span class="n">bdring_len</span><span class="p">));</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_rxbd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">e_rxbd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_txbd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txbase</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">c_txbd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txbase</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">data01</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* data0 */</span>

	<span class="cm">/* Init TX and RX bds */</span>
	<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bdring_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bd</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="n">R_W</span><span class="p">);</span>

	<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txbase</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">USB_BDRING_LEN_TX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bd</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="n">T_W</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_rxbd_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bdring_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxframe</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxframe</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxframe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;malloc rxframe failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qe_frame_init</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxframe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">USB_DIR_OUT</span><span class="p">)</span>
		<span class="n">bdring_len</span> <span class="o">=</span> <span class="n">USB_BDRING_LEN_RX</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bdring_len</span> <span class="o">=</span> <span class="n">USB_BDRING_LEN</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">+</span> <span class="n">USB_CRC_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">bdring_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;malloc rxbuffer failed,size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">size</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxframe</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuf_d</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuf_d</span> <span class="o">==</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuf_d</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuffer</span><span class="p">,</span>
					<span class="n">size</span><span class="p">,</span>
					<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbufmap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuf_d</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbufmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">+</span> <span class="n">USB_CRC_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuf_d</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bdring_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="p">(</span><span class="n">R_E</span> <span class="o">|</span> <span class="n">R_I</span><span class="p">));</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">bd</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="p">(</span><span class="n">R_E</span> <span class="o">|</span> <span class="n">R_I</span> <span class="o">|</span> <span class="n">R_W</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_register_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pipe_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">pipe_num</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">usb_ep_para</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">epparam</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">usep</span><span class="p">,</span> <span class="n">logepnum</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rtfcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">epparam</span> <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep_param</span><span class="p">[</span><span class="n">pipe_num</span><span class="p">];</span>

	<span class="n">usep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">logepnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">);</span>
	<span class="n">usep</span> <span class="o">|=</span> <span class="p">(</span><span class="n">logepnum</span> <span class="o">&lt;&lt;</span> <span class="n">USB_EPNUM_SHIFT</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>:
		<span class="n">usep</span> <span class="o">|=</span> <span class="n">USB_TRANS_BULK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>:
		<span class="n">usep</span> <span class="o">|=</span>  <span class="n">USB_TRANS_ISO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:
		<span class="n">usep</span> <span class="o">|=</span> <span class="n">USB_TRANS_INT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">usep</span> <span class="o">|=</span> <span class="n">USB_TRANS_CTR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_DIR_OUT</span>:
		<span class="n">usep</span> <span class="o">|=</span> <span class="n">USB_THS_IGNORE_IN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_DIR_IN</span>:
		<span class="n">usep</span> <span class="o">|=</span> <span class="n">USB_RHS_IGNORE_OUT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usep</span><span class="p">[</span><span class="n">pipe_num</span><span class="p">],</span> <span class="n">usep</span><span class="p">);</span>

	<span class="n">rtfcr</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epparam</span><span class="o">-&gt;</span><span class="n">rbmr</span><span class="p">,</span> <span class="n">rtfcr</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epparam</span><span class="o">-&gt;</span><span class="n">tbmr</span><span class="p">,</span> <span class="n">rtfcr</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">+</span> <span class="n">USB_CRC_SIZE</span><span class="p">);</span>
	<span class="cm">/* MRBLR must be divisble by 4 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epparam</span><span class="o">-&gt;</span><span class="n">mrblr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pipe_num</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">pipe_num</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">max</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="cm">/* check the max package size validate for this endpoint */</span>
	<span class="cm">/* Refer to USB2.0 spec table 9-13,</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe_num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_XFERTYPE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;-iso&quot;</span><span class="p">)</span>
					<span class="o">||</span> <span class="n">strstr</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;-int&quot;</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">en_done</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">max</span> <span class="o">==</span> <span class="mi">128</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">max</span> <span class="o">==</span> <span class="mi">256</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">max</span> <span class="o">==</span> <span class="mi">512</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">max</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">4</span>:
				<span class="k">case</span> <span class="mi">8</span>:
				<span class="k">case</span> <span class="mi">16</span>:
				<span class="k">case</span> <span class="mi">32</span>:
				<span class="k">case</span> <span class="mi">64</span>:
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
				<span class="k">case</span> <span class="n">USB_SPEED_LOW</span>:
					<span class="k">goto</span> <span class="n">en_done</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;-iso&quot;</span><span class="p">))</span>	<span class="cm">/* bulk is ok */</span>
				<span class="k">goto</span> <span class="n">en_done</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">1024</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_SPEED_FULL</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">en_done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;-bulk&quot;</span><span class="p">)</span>
				<span class="o">||</span> <span class="n">strstr</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;-int&quot;</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">en_done</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">1024</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_SPEED_FULL</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">1023</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">goto</span> <span class="n">en_done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;-iso&quot;</span><span class="p">)</span>
				<span class="o">||</span> <span class="n">strstr</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;-int&quot;</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">en_done</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
			<span class="k">case</span> <span class="n">USB_SPEED_FULL</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">max</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">1</span>:
				<span class="k">case</span> <span class="mi">2</span>:
				<span class="k">case</span> <span class="mi">4</span>:
				<span class="k">case</span> <span class="mi">8</span>:
				<span class="k">case</span> <span class="mi">16</span>:
				<span class="k">case</span> <span class="mi">32</span>:
				<span class="k">case</span> <span class="mi">64</span>:
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">goto</span> <span class="n">en_done</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="n">USB_SPEED_LOW</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">max</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">1</span>:
				<span class="k">case</span> <span class="mi">2</span>:
				<span class="k">case</span> <span class="mi">4</span>:
				<span class="k">case</span> <span class="mi">8</span>:
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">goto</span> <span class="n">en_done</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="nl">default:</span>
				<span class="k">goto</span> <span class="n">en_done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">en_done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="cm">/* if ep0*/</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* initialize ep structure */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tm</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_XFERTYPE_MASK</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">USB_DIR_BOTH</span><span class="p">;</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="n">USB_DIR_OUT</span><span class="p">;</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>	<span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_DIR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_DIR_OUT</span>:
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">USB_DIR_OUT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_DIR_IN</span>:
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* hardware special operation */</span>
	<span class="n">qe_ep_bd_init</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tm</span> <span class="o">==</span> <span class="n">USBP_TM_CTL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">USB_DIR_OUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reval</span> <span class="o">=</span> <span class="n">qe_ep_rxbd_update</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">en_done1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tm</span> <span class="o">==</span> <span class="n">USBP_TM_CTL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">USB_DIR_IN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;malloc txframe failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">en_done2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qe_frame_init</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qe_ep_register_init</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">);</span>

	<span class="cm">/* Now HW will be NAKing transfers to that EP,</span>
<span class="cm">	 * until a buffer is queued to it. */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">en_done2:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuffer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxframe</span><span class="p">);</span>
<span class="nl">en_done1:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">en_done:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to initialize %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qe_usb_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">setbits8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usmod</span><span class="p">,</span> <span class="n">USB_MODE_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qe_usb_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clrbits8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usmod</span><span class="p">,</span> <span class="n">USB_MODE_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------------*</span>
<span class="cm"> *		USB and EP basic manipulate function end		      *</span>
<span class="cm"> *----------------------------------------------------------------------------*/</span>


<span class="cm">/******************************************************************************</span>
<span class="cm">		UDC transmit and receive process</span>
<span class="cm"> ******************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">recycle_one_rxbd</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bdstatus</span><span class="p">;</span>

	<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">e_rxbd</span><span class="p">);</span>
	<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">R_I</span> <span class="o">|</span> <span class="n">R_E</span> <span class="o">|</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_W</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">e_rxbd</span><span class="p">,</span> <span class="n">bdstatus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_W</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">e_rxbd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">e_rxbd</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">recycle_rxbds</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">stopatnext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bdstatus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">,</span> <span class="o">*</span><span class="n">nextbd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nextbd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_rxbd</span><span class="p">;</span>
	<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">e_rxbd</span><span class="p">;</span>
	<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_E</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">BD_LENGTH_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">R_E</span> <span class="o">|</span> <span class="n">R_I</span> <span class="o">|</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_W</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="n">bdstatus</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_W</span><span class="p">)</span>
			<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bd</span><span class="o">++</span><span class="p">;</span>

		<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stopatnext</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bd</span> <span class="o">==</span> <span class="n">nextbd</span><span class="p">))</span>
			<span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">e_rxbd</span> <span class="o">=</span> <span class="n">bd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep_recycle_rxbds</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_rxbd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bdstatus</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">epnum</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>

	<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_E</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">BD_LENGTH_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span> <span class="o">+</span>
				<span class="p">((</span><span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep_param</span><span class="p">[</span><span class="n">epnum</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rbptr</span><span class="p">)</span> <span class="o">-</span>
				  <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep_param</span><span class="p">[</span><span class="n">epnum</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rbase</span><span class="p">))</span>
				 <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_W</span><span class="p">)</span>
			<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bd</span><span class="o">++</span><span class="p">;</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">e_rxbd</span> <span class="o">=</span> <span class="n">bd</span><span class="p">;</span>
		<span class="n">recycle_rxbds</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">e_rxbd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_rxbd</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">recycle_rxbds</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usber</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">USB_E_BSY_MASK</span><span class="p">)</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usber</span><span class="p">,</span> <span class="n">USB_E_BSY_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_data</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)))</span>
		<span class="n">qe_eprx_normal</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">localnack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">setup_received_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">setup</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qe_ep_rxframe_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ep0_req_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_req</span> <span class="o">*</span><span class="n">req</span><span class="p">);</span>
<span class="cm">/* when BD PID is setup, handle the packet */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep0_setup_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qe_frame</span> <span class="o">*</span><span class="n">pframe</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fsize</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>

	<span class="n">pframe</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxframe</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">frame_get_info</span><span class="p">(</span><span class="n">pframe</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PID_SETUP</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">==</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fsize</span> <span class="o">=</span> <span class="n">frame_get_length</span><span class="p">(</span><span class="n">pframe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">fsize</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">local_setup_buff</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">pframe</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fsize</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">data01</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* handle the usb command base on the usb_ctrlrequest */</span>
		<span class="n">setup_received_handle</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">local_setup_buff</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep0_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qe_frame</span> <span class="o">*</span><span class="n">pframe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bdstatus</span><span class="p">,</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vaddr</span><span class="p">;</span>

	<span class="n">pframe</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxframe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ep0 not a control endpoint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_rxbd</span><span class="p">;</span>
	<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">BD_LENGTH_MASK</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_E</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_F</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_L</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_ERROR</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="n">USB_CRC_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
				<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;receive a ZLP in status phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">qe_frame_clean</span><span class="p">(</span><span class="n">pframe</span><span class="p">);</span>
				<span class="n">vaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">phys_to_virt</span><span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">));</span>
				<span class="n">frame_set_data</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vaddr</span><span class="p">);</span>
				<span class="n">frame_set_length</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span>
						<span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">USB_CRC_SIZE</span><span class="p">));</span>
				<span class="n">frame_set_status</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span> <span class="n">FRAME_OK</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_PID</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">R_PID_SETUP</span>:
					<span class="n">frame_set_info</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span> <span class="n">PID_SETUP</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">R_PID_DATA1</span>:
					<span class="n">frame_set_info</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span> <span class="n">PID_DATA1</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">frame_set_info</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span> <span class="n">PID_DATA0</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_PID</span><span class="p">)</span> <span class="o">==</span> <span class="n">R_PID_SETUP</span><span class="p">)</span>
					<span class="n">ep0_setup_handle</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">qe_ep_rxframe_handle</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The receive frame with error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* note: don&#39;t clear the rxbd&#39;s buffer address */</span>
		<span class="n">recycle_one_rxbd</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

		<span class="cm">/* Get next BD */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_W</span><span class="p">)</span>
			<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bd</span><span class="o">++</span><span class="p">;</span>

		<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">BD_LENGTH_MASK</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_rxbd</span> <span class="o">=</span> <span class="n">bd</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_rxframe_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_frame</span> <span class="o">*</span><span class="n">pframe</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">framepid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fsize</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">pframe</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxframe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame_get_info</span><span class="p">(</span><span class="n">pframe</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PID_DATA1</span><span class="p">)</span>
		<span class="n">framepid</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">framepid</span> <span class="o">!=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">data01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;the data01 error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fsize</span> <span class="o">=</span> <span class="n">frame_get_length</span><span class="p">(</span><span class="n">pframe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;the %s have no requeue!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

		<span class="n">cp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">pframe</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fsize</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">fsize</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">fsize</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">&gt;=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">ep0_req_complete</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">qe_eprx_nack</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">qe_ep_toggledata01</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep_rx_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_frame</span> <span class="o">*</span><span class="n">pframe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bdstatus</span><span class="p">,</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vaddr</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">USB_MAX_ENDPOINTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">USB_DIR_IN</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">enable_tasklet</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;This is a transmit ep or disable tasklet!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pframe</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxframe</span><span class="p">;</span>
		<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_rxbd</span><span class="p">;</span>
		<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">BD_LENGTH_MASK</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_E</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">qe_eprx_nack</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;The rxep have noreq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_data</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_F</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_L</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_ERROR</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">qe_frame_clean</span><span class="p">(</span><span class="n">pframe</span><span class="p">);</span>
				<span class="n">vaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">phys_to_virt</span><span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">));</span>
				<span class="n">frame_set_data</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vaddr</span><span class="p">);</span>
				<span class="n">frame_set_length</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span>
						<span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">USB_CRC_SIZE</span><span class="p">));</span>
				<span class="n">frame_set_status</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span> <span class="n">FRAME_OK</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_PID</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">R_PID_DATA1</span>:
					<span class="n">frame_set_info</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span> <span class="n">PID_DATA1</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">R_PID_SETUP</span>:
					<span class="n">frame_set_info</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span> <span class="n">PID_SETUP</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">frame_set_info</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span> <span class="n">PID_DATA0</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* handle the rx frame */</span>
				<span class="n">qe_ep_rxframe_handle</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;error in received frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* note: don&#39;t clear the rxbd&#39;s buffer address */</span>
			<span class="cm">/*clear the length */</span>
			<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">BD_STATUS_MASK</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_data</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">localnack</span><span class="p">))</span>
				<span class="n">recycle_one_rxbd</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

			<span class="cm">/* Get next BD */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_W</span><span class="p">)</span>
				<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">bd</span><span class="o">++</span><span class="p">;</span>

			<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>
			<span class="n">length</span> <span class="o">=</span> <span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">BD_LENGTH_MASK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_rxbd</span> <span class="o">=</span> <span class="n">bd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">localnack</span><span class="p">)</span>
			<span class="n">ep_recycle_rxbds</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">enable_tasklet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* for i=1 */</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_frame</span> <span class="o">*</span><span class="n">pframe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">swoffs</span><span class="p">,</span> <span class="n">ucoffs</span><span class="p">,</span> <span class="n">emptybds</span><span class="p">;</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>
	<span class="n">pframe</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxframe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;transmit ep in rx function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_rxbd</span><span class="p">;</span>

	<span class="n">swoffs</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">bd</span> <span class="o">-</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span><span class="p">);</span>
	<span class="n">ucoffs</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)((</span><span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep_param</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rbptr</span><span class="p">)</span> <span class="o">-</span>
			<span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep_param</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rbase</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">swoffs</span> <span class="o">&lt;</span> <span class="n">ucoffs</span><span class="p">)</span>
		<span class="n">emptybds</span> <span class="o">=</span> <span class="n">USB_BDRING_LEN_RX</span> <span class="o">-</span> <span class="n">ucoffs</span> <span class="o">+</span> <span class="n">swoffs</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">emptybds</span> <span class="o">=</span> <span class="n">swoffs</span> <span class="o">-</span> <span class="n">ucoffs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emptybds</span> <span class="o">&lt;</span> <span class="n">MIN_EMPTY_BDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qe_eprx_nack</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">localnack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d empty bds, send NACK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">emptybds</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_data</span> <span class="o">=</span> <span class="n">USB_BDRING_LEN_RX</span> <span class="o">-</span> <span class="n">emptybds</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qe_eprx_nack</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The rxep have no req queued with %d BDs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">enable_tasklet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* send data from a frame, no matter what tx_req */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">saveusbmr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bdstatus</span><span class="p">,</span> <span class="n">pidmask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">paddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">USB_DIR_OUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;receive ep passed to tx function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable the Tx interrupt */</span>
	<span class="n">saveusbmr</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usbmr</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usbmr</span><span class="p">,</span>
			<span class="n">saveusbmr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">USB_E_TXB_MASK</span> <span class="o">|</span> <span class="n">USB_E_TXE_MASK</span><span class="p">));</span>

	<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_txbd</span><span class="p">;</span>
	<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">T_R</span> <span class="o">|</span> <span class="n">BD_LENGTH_MASK</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame_get_length</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">frame_set_data</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullbuf</span><span class="p">);</span>
			<span class="n">frame_set_length</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ZLP</span> <span class="o">|</span> <span class="n">NO_CRC</span><span class="p">);</span>
			<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;the frame size = 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">paddr</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">paddr</span><span class="p">);</span>
		<span class="n">bdstatus</span> <span class="o">=</span> <span class="p">(</span><span class="n">bdstatus</span><span class="o">&amp;</span><span class="n">T_W</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">frame_get_info</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NO_CRC</span><span class="p">))</span>
			<span class="n">bdstatus</span> <span class="o">|=</span> <span class="n">T_R</span> <span class="o">|</span> <span class="n">T_I</span> <span class="o">|</span> <span class="n">T_L</span> <span class="o">|</span> <span class="n">T_TC</span>
					<span class="o">|</span> <span class="n">frame_get_length</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bdstatus</span> <span class="o">|=</span> <span class="n">T_R</span> <span class="o">|</span> <span class="n">T_I</span> <span class="o">|</span> <span class="n">T_L</span> <span class="o">|</span> <span class="n">frame_get_length</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>

		<span class="cm">/* if the packet is a ZLP in status phase */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">==</span> <span class="n">DATA_STATE_NEED_ZLP</span><span class="p">))</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">data01</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">data01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pidmask</span> <span class="o">=</span> <span class="n">T_PID_DATA1</span><span class="p">;</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">|=</span> <span class="n">PID_DATA1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pidmask</span> <span class="o">=</span> <span class="n">T_PID_DATA0</span><span class="p">;</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">|=</span> <span class="n">PID_DATA0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bdstatus</span> <span class="o">|=</span> <span class="n">T_CNF</span><span class="p">;</span>
		<span class="n">bdstatus</span> <span class="o">|=</span> <span class="n">pidmask</span><span class="p">;</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="n">bdstatus</span><span class="p">);</span>
		<span class="n">qe_ep_filltxfifo</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

		<span class="cm">/* enable the TX interrupt */</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usbmr</span><span class="p">,</span> <span class="n">saveusbmr</span><span class="p">);</span>

		<span class="n">qe_ep_toggledata01</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">T_W</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_txbd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txbase</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_txbd</span><span class="o">++</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usbmr</span><span class="p">,</span> <span class="n">saveusbmr</span><span class="p">);</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The tx bd is not ready!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* when a bd was transmitted, the function can</span>
<span class="cm"> * handle the tx_req, not include ep0           */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">txcomplete</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">restart</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qe_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">zlp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">last_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">last_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">sent</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">asent</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">+=</span> <span class="n">asent</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">-=</span> <span class="n">asent</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* zlp needed when req-&gt;re.zero is set */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">last_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">zlp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">zlp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">zlp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* a request already were transmitted completely */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">sent</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">zlp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* we should gain a new tx_req fot this endpoint */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>	<span class="k">struct</span> <span class="n">qe_req</span><span class="p">,</span>
							<span class="n">queue</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* give a frame and a tx_req, send some data */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_usb_senddata</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">qe_frame_clean</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">sent</span><span class="p">),</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">sent</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">frame_set_data</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">frame_set_length</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">frame_set_status</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">FRAME_OK</span><span class="p">);</span>
		<span class="n">frame_set_info</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">qe_ep_tx</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* give a frame struct,send a ZLP */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sendnulldata</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span> <span class="n">uint</span> <span class="n">infor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">qe_frame_clean</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
	<span class="n">frame_set_data</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullbuf</span><span class="p">);</span>
	<span class="n">frame_set_length</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">frame_set_status</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">FRAME_OK</span><span class="p">);</span>
	<span class="n">frame_set_info</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">ZLP</span> <span class="o">|</span> <span class="n">NO_CRC</span> <span class="o">|</span> <span class="n">infor</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">qe_ep_tx</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">frame_create_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">sent</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">reval</span> <span class="o">=</span> <span class="n">qe_usb_senddata</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reval</span> <span class="o">=</span> <span class="n">sendnulldata</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">reval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* if direction is DIR_IN, the status is Device-&gt;Host</span>
<span class="cm"> * if direction is DIR_OUT, the status transaction is Device&lt;-Host</span>
<span class="cm"> * in status phase, udc create a request and gain status */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep0_prime_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">=</span> <span class="n">DATA_STATE_NEED_ZLP</span><span class="p">;</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span><span class="p">;</span>
		<span class="n">sendnulldata</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span><span class="p">,</span> <span class="n">SETUP_STATUS</span> <span class="o">|</span> <span class="n">NO_REQ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="n">USB_DIR_OUT</span><span class="p">;</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">=</span> <span class="n">WAIT_FOR_OUT_STATUS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* a request complete in ep0, whether gadget request or udc request */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep0_req_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="cm">/* because usb and ep&#39;s status already been set in ch9setaddress() */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DATA_STATE_XMIT</span>:
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* receive status phase */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep0_prime_status</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span><span class="p">))</span>
			<span class="n">qe_ep0_stall</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DATA_STATE_NEED_ZLP</span>:
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DATA_STATE_RECV</span>:
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* send status phase */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep0_prime_status</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">USB_DIR_IN</span><span class="p">))</span>
			<span class="n">qe_ep0_stall</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WAIT_FOR_OUT_STATUS</span>:
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WAIT_FOR_SETUP</span>:
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unexpected interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">qe_ep0_stall</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep0_txcomplete</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">restart</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_req</span> <span class="o">*</span><span class="n">tx_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_frame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">frame_get_info</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ZLP</span> <span class="o">|</span> <span class="n">NO_REQ</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">ZLP</span> <span class="o">|</span> <span class="n">NO_REQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">restart</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sendnulldata</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span><span class="p">,</span> <span class="n">SETUP_STATUS</span> <span class="o">|</span> <span class="n">NO_REQ</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_req</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_req</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">asent</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">+=</span> <span class="n">asent</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">-=</span> <span class="n">asent</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* a request already were transmitted completely */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">sent</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">sent</span><span class="p">;</span>
			<span class="n">ep0_req_complete</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;the ep0_controller have no req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep0_txframe_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* if have error, transmit again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame_get_status</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FRAME_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qe_ep_flushtxfifo</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The EP0 transmit data have error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame_get_info</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PID_DATA0</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">data01</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">data01</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ep0_txcomplete</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ep0_txcomplete</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">frame_create_tx</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep0_txconf</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_frame</span> <span class="o">*</span><span class="n">pframe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bdstatus</span><span class="p">;</span>

	<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">c_txbd</span><span class="p">;</span>
	<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">T_R</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">T_W</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pframe</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span><span class="p">;</span>

		<span class="cm">/* clear and recycle the BD */</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">T_W</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">T_W</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">c_txbd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txbase</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">c_txbd</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">c_txbd</span> <span class="o">==</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_txbd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">DEVICE_T_ERROR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">frame_set_status</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span> <span class="n">FRAME_ERROR</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">T_TO</span><span class="p">)</span>
					<span class="n">pframe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">TX_ER_TIMEOUT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">T_UN</span><span class="p">)</span>
					<span class="n">pframe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">TX_ER_UNDERUN</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ep0_txframe_handle</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">c_txbd</span><span class="p">;</span>
		<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_txframe_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame_get_status</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FRAME_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qe_ep_flushtxfifo</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The EP0 transmit data have error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame_get_info</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PID_DATA0</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">data01</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">data01</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">txcomplete</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">txcomplete</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">frame_create_tx</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span><span class="p">);</span> <span class="cm">/* send the data */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* confirm the already trainsmited bd */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_txconf</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_frame</span> <span class="o">*</span><span class="n">pframe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bdstatus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">breakonrxinterrupt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">c_txbd</span><span class="p">;</span>
	<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">T_R</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">T_W</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pframe</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">DEVICE_T_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">frame_set_status</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span> <span class="n">FRAME_ERROR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">T_TO</span><span class="p">)</span>
				<span class="n">pframe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">TX_ER_TIMEOUT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">T_UN</span><span class="p">)</span>
				<span class="n">pframe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">TX_ER_UNDERUN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* clear and recycle the BD */</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">T_W</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">T_W</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">c_txbd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txbase</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">c_txbd</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* handle the tx frame */</span>
		<span class="n">ep_txframe_handle</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">c_txbd</span><span class="p">;</span>
		<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">breakonrxinterrupt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Add a request in queue, and try to transmit a packet */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_req_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">txcomplete</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* can gain a new tx_req */</span>
		<span class="n">reval</span> <span class="o">=</span> <span class="n">frame_create_tx</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">reval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Maybe this is a good ideal */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_req_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_frame</span> <span class="o">*</span><span class="n">pframe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bdstatus</span><span class="p">,</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vaddr</span><span class="p">,</span> <span class="n">fsize</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">finish_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">framepid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;the req already finish!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pframe</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxframe</span><span class="p">;</span>

	<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_rxbd</span><span class="p">;</span>
	<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">BD_LENGTH_MASK</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_E</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">finish_req</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_F</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_L</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_ERROR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qe_frame_clean</span><span class="p">(</span><span class="n">pframe</span><span class="p">);</span>
			<span class="n">vaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">phys_to_virt</span><span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">));</span>
			<span class="n">frame_set_data</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vaddr</span><span class="p">);</span>
			<span class="n">frame_set_length</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">USB_CRC_SIZE</span><span class="p">));</span>
			<span class="n">frame_set_status</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span> <span class="n">FRAME_OK</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_PID</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">R_PID_DATA1</span>:
				<span class="n">frame_set_info</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span> <span class="n">PID_DATA1</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">frame_set_info</span><span class="p">(</span><span class="n">pframe</span><span class="p">,</span> <span class="n">PID_DATA0</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* handle the rx frame */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">frame_get_info</span><span class="p">(</span><span class="n">pframe</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PID_DATA1</span><span class="p">)</span>
				<span class="n">framepid</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">framepid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">framepid</span> <span class="o">!=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">data01</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;the data01 error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">fsize</span> <span class="o">=</span> <span class="n">frame_get_length</span><span class="p">(</span><span class="n">pframe</span><span class="p">);</span>

				<span class="n">cp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">pframe</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fsize</span><span class="p">);</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">fsize</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">fsize</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span>
						<span class="o">||</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">&gt;=</span>
							<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">finish_req</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
							<span class="n">qe_eprx_nack</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">qe_ep_toggledata01</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The receive frame with error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* note: don&#39;t clear the rxbd&#39;s buffer address *</span>
<span class="cm">		 * only Clear the length */</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">,</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">BD_STATUS_MASK</span><span class="p">));</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_data</span><span class="o">--</span><span class="p">;</span>

		<span class="cm">/* Get next BD */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">R_W</span><span class="p">)</span>
			<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bd</span><span class="o">++</span><span class="p">;</span>

		<span class="n">bdstatus</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">bdstatus</span> <span class="o">&amp;</span> <span class="n">BD_LENGTH_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_rxbd</span> <span class="o">=</span> <span class="n">bd</span><span class="p">;</span>
	<span class="n">ep_recycle_rxbds</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* only add the request in queue */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_req_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">EP_STATE_NACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_data</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Enable rx and unmask rx interrupt */</span>
			<span class="n">qe_eprx_normal</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Copy the exist BD data */</span>
			<span class="n">ep_req_rx</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************************</span>
<span class="cm">	Internal Used Function End</span>
<span class="cm">********************************************************************/</span>

<span class="cm">/*-----------------------------------------------------------------------</span>
<span class="cm">	Endpoint Management Functions For Gadget</span>
<span class="cm"> -----------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">epnum</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="cm">/* catch various bogus parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span> <span class="o">||</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">!=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="n">epnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">qe_ep_init</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">epnum</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpm_muram_free</span><span class="p">(</span><span class="n">cpm_muram_offset</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span><span class="p">));</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;enable ep%d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;enable ep%d successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s not enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span> <span class="o">?</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Nuke all pending requests (does flush) */</span>
	<span class="n">nuke</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">qe_ep_reset</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">cpm_muram_free</span><span class="p">(</span><span class="n">cpm_muram_offset</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">USB_DIR_OUT</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">+</span> <span class="n">USB_CRC_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span>
				<span class="p">(</span><span class="n">USB_BDRING_LEN_RX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">+</span> <span class="n">USB_CRC_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span>
				<span class="p">(</span><span class="n">USB_BDRING_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">!=</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxframe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbufmap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuf_d</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuf_d</span> <span class="o">=</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span>
					<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuf_d</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuffer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">!=</span> <span class="n">USB_DIR_OUT</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disabled %s OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="nf">qe_alloc_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span>	<span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qe_free_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_req</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_req</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__qe_ep_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qe_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_req</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reval</span><span class="p">;</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>
	<span class="cm">/* catch various bogus parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_req</span> <span class="o">||</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span> <span class="o">||</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad params</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep_index</span><span class="p">(</span><span class="n">ep</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad ep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>

	<span class="cm">/* map virtual address to hardware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">==</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
					<span class="n">ep_is_in</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span>
					<span class="o">?</span> <span class="n">DMA_TO_DEVICE</span> <span class="o">:</span>
					<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
					<span class="n">ep_is_in</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span>
					<span class="o">?</span> <span class="n">DMA_TO_DEVICE</span> <span class="o">:</span>
					<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gadget have request in %s! %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="cm">/* push the request to device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep_is_in</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span>
		<span class="n">reval</span> <span class="o">=</span> <span class="n">ep_req_send</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="cm">/* EP0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep_index</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep_is_in</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">=</span> <span class="n">DATA_STATE_XMIT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">=</span> <span class="n">DATA_STATE_RECV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">USB_DIR_OUT</span><span class="p">)</span>
		<span class="n">reval</span> <span class="o">=</span> <span class="n">ep_req_receive</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* queues (submits) an I/O request to an endpoint */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">,</span>
		       <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__qe_ep_queue</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="n">_req</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* dequeues (cancels, unlinks) an I/O request from an endpoint */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qe_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* make sure it&#39;s actually queued on this endpoint */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">==</span> <span class="n">_req</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">!=</span> <span class="n">_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-----------------------------------------------------------------</span>
<span class="cm"> * modify the endpoint halt feature</span>
<span class="cm"> * @ep: the non-isochronous endpoint being stalled</span>
<span class="cm"> * @value: 1--set halt  0--clear halt</span>
<span class="cm"> * Returns zero, or a negative error code.</span>
<span class="cm">*----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_ep_set_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>
	<span class="cm">/* Attempt to halt IN ep will fail if any transfer requests</span>
<span class="cm">	 * are still queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="n">ep_is_in</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">qe_eptx_stall_change</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">qe_eprx_stall_change</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set data toggle to DATA0 on clear halt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">data01</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s %s halt stat %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">value</span> <span class="o">?</span>  <span class="s">&quot;set&quot;</span> <span class="o">:</span> <span class="s">&quot;clear&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">qe_ep_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">qe_ep_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span> <span class="o">=</span> <span class="n">qe_ep_disable</span><span class="p">,</span>

	<span class="p">.</span><span class="n">alloc_request</span> <span class="o">=</span> <span class="n">qe_alloc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_request</span> <span class="o">=</span> <span class="n">qe_free_request</span><span class="p">,</span>

	<span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">qe_ep_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue</span> <span class="o">=</span> <span class="n">qe_ep_dequeue</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_halt</span> <span class="o">=</span> <span class="n">qe_ep_set_halt</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*------------------------------------------------------------------------</span>
<span class="cm">	Gadget Driver Layer Operations</span>
<span class="cm"> ------------------------------------------------------------------------*/</span>

<span class="cm">/* Get the current frame number */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_udc</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_param</span><span class="o">-&gt;</span><span class="n">frame_n</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x07ff</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fsl_qe_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fsl_qe_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>

<span class="cm">/* defined in usb_gadget.h */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_gadget_ops</span> <span class="n">qe_gadget_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_frame</span> <span class="o">=</span> <span class="n">qe_get_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_start</span> <span class="o">=</span> <span class="n">fsl_qe_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_stop</span> <span class="o">=</span> <span class="n">fsl_qe_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------</span>
<span class="cm">	USB ep0 Setup process in BUS Enumeration</span>
<span class="cm"> -------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udc_reset_ep_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>

	<span class="n">nuke</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reset_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pipe</span> <span class="o">&lt;</span> <span class="n">USB_MAX_ENDPOINTS</span><span class="p">;</span> <span class="n">pipe</span><span class="o">++</span><span class="p">)</span>
		<span class="n">udc_reset_ep_queue</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="cm">/* report disconnect; the driver is already quiesced */</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ch9setaddress</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Save the new address to device struct */</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">device_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">value</span><span class="p">;</span>
	<span class="cm">/* Update usb state */</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_state</span> <span class="o">=</span> <span class="n">USB_STATE_ADDRESS</span><span class="p">;</span>

	<span class="cm">/* Status phase , send a ZLP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep0_prime_status</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">USB_DIR_IN</span><span class="p">))</span>
		<span class="n">qe_ep0_stall</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ownercomplete</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_req</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ch9getstatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">request_type</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">usb_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">request_type</span> <span class="o">&amp;</span> <span class="n">USB_RECIP_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get device status */</span>
		<span class="n">usb_status</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DEVICE_SELF_POWERED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">request_type</span> <span class="o">&amp;</span> <span class="n">USB_RECIP_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get interface status */</span>
		<span class="cm">/* We don&#39;t have interface information in udc driver */</span>
		<span class="n">usb_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">request_type</span> <span class="o">&amp;</span> <span class="n">USB_RECIP_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">USB_RECIP_ENDPOINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get endpoint status */</span>
		<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">target_ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
		<span class="n">u16</span> <span class="n">usep</span><span class="p">;</span>

		<span class="cm">/* stall if endpoint doesn&#39;t exist */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>

		<span class="n">usep</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usep</span><span class="p">[</span><span class="n">pipe</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">target_ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">!=</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">usep</span> <span class="o">&amp;</span> <span class="n">USB_THS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">USB_THS_STALL</span><span class="p">)</span>
				<span class="n">usb_status</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_ENDPOINT_HALT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">target_ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">!=</span> <span class="n">USB_DIR_OUT</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">usep</span> <span class="o">&amp;</span> <span class="n">USB_RHS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">USB_RHS_STALL</span><span class="p">)</span>
				<span class="n">usb_status</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_ENDPOINT_HALT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">qe_alloc_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">),</span>
					<span class="k">struct</span> <span class="n">qe_req</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">statusbuf</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">usb_status</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span> <span class="o">=</span> <span class="n">ownercomplete</span><span class="p">;</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span><span class="p">;</span>

	<span class="cm">/* data phase */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">__qe_ep_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="nl">stall:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t respond to getstatus request </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">qe_ep0_stall</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* only handle the setup request, suppose the device in normal status */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_received_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">setup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Fix Endian (udc-&gt;local_setup_buff is cpu Endian now)*/</span>
	<span class="n">u16</span> <span class="n">wValue</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">wIndex</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">wLength</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">);</span>

	<span class="cm">/* clear the previous request in the ep0 */</span>
	<span class="n">udc_reset_ep_queue</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="n">USB_DIR_OUT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequest</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_REQ_GET_STATUS</span>:
		<span class="cm">/* Data+Status phase form udc */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_MASK</span><span class="p">))</span>
					<span class="o">!=</span> <span class="p">(</span><span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_STANDARD</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ch9getstatus</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span><span class="p">,</span> <span class="n">wValue</span><span class="p">,</span> <span class="n">wIndex</span><span class="p">,</span>
					<span class="n">wLength</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_REQ_SET_ADDRESS</span>:
		<span class="cm">/* Status phase from udc */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="p">(</span><span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_STANDARD</span> <span class="o">|</span>
						<span class="n">USB_RECIP_DEVICE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ch9setaddress</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">wValue</span><span class="p">,</span> <span class="n">wIndex</span><span class="p">,</span> <span class="n">wLength</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_REQ_CLEAR_FEATURE</span>:
	<span class="k">case</span> <span class="n">USB_REQ_SET_FEATURE</span>:
		<span class="cm">/* Requests with no data phase, status phase from udc */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_TYPE_MASK</span><span class="p">)</span>
					<span class="o">!=</span> <span class="n">USB_TYPE_STANDARD</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_RECIP_MASK</span><span class="p">)</span>
				<span class="o">==</span> <span class="n">USB_RECIP_ENDPOINT</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">wIndex</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">wValue</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">wLength</span> <span class="o">!=</span> <span class="mi">0</span>
				<span class="o">||</span> <span class="n">pipe</span> <span class="o">&gt;</span> <span class="n">USB_MAX_ENDPOINTS</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>

			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">qe_ep_set_halt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span>
					<span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequest</span> <span class="o">==</span> <span class="n">USB_REQ_SET_FEATURE</span><span class="p">)</span>
						<span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ep0_prime_status</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">USB_DIR_IN</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wLength</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Data phase from gadget, status phase from udc */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">=</span> <span class="n">DATA_STATE_XMIT</span><span class="p">;</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">=</span> <span class="n">DATA_STATE_RECV</span><span class="p">;</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="n">USB_DIR_OUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">local_setup_buff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">qe_ep0_stall</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* No data phase, IN status from gadget */</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">local_setup_buff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">qe_ep0_stall</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">=</span> <span class="n">DATA_STATE_NEED_ZLP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------</span>
<span class="cm">	USB Interrupt handlers</span>
<span class="cm"> -------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">suspend_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">resume_state</span> <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_state</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_state</span> <span class="o">=</span> <span class="n">USB_STATE_SUSPENDED</span><span class="p">;</span>

	<span class="cm">/* report suspend to the driver ,serial.c not support this*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">resume_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_state</span> <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">resume_state</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">resume_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* report resume to the driver , serial.c not support this*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">idle_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">usbs</span><span class="p">;</span>

	<span class="n">usbs</span> <span class="o">=</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usbs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbs</span> <span class="o">&amp;</span> <span class="n">USB_IDLE_STATUS_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">USB_STATE_SUSPENDED</span><span class="p">)</span>
			<span class="n">suspend_irq</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_state</span> <span class="o">==</span> <span class="n">USB_STATE_SUSPENDED</span><span class="p">)</span>
			<span class="n">resume_irq</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reset_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_state</span> <span class="o">==</span> <span class="n">USB_STATE_DEFAULT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qe_usb_disable</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usadr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">USB_MAX_ENDPOINTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">init</span><span class="p">)</span>
			<span class="n">qe_ep_reset</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">reset_queues</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_state</span> <span class="o">=</span> <span class="n">USB_STATE_DEFAULT</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="n">USB_DIR_OUT</span><span class="p">;</span>
	<span class="n">qe_usb_enable</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bsy_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">txe_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ep0 tx interrupt also in here */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_state</span> <span class="o">==</span> <span class="n">USB_STATE_ADDRESS</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usadr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usadr</span><span class="p">,</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">device_address</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">USB_MAX_ENDPOINTS</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">!=</span> <span class="n">USB_DIR_OUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">c_txbd</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">T_R</span><span class="p">)</span>
						<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)))</span> <span class="p">{</span>
				<span class="cm">/* confirm the transmitted bd */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">qe_ep0_txconf</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">qe_ep_txconf</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* setup packect&#39;s rx is handle in the function too */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_bd</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">USB_MAX_ENDPOINTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">!=</span> <span class="n">USB_DIR_IN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bd</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">n_rxbd</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">R_E</span><span class="p">)</span>
						<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">qe_ep0_rx</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/*non-setup package receive*/</span>
					<span class="n">qe_ep_rx</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">qe_udc_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="p">)</span><span class="n">_udc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">irq_src</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">irq_src</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usber</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usbmr</span><span class="p">);</span>
	<span class="cm">/* Clear notification bits */</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usber</span><span class="p">,</span> <span class="n">irq_src</span><span class="p">);</span>
	<span class="cm">/* USB Interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="n">USB_E_IDLE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idle_irq</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="n">irq_src</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_E_IDLE_MASK</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="n">USB_E_TXB_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_irq</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="n">irq_src</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_E_TXB_MASK</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="n">USB_E_RXB_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_irq</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="n">irq_src</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_E_RXB_MASK</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="n">USB_E_RESET_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset_irq</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="n">irq_src</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_E_RESET_MASK</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="n">USB_E_BSY_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bsy_irq</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="n">irq_src</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_E_BSY_MASK</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="n">USB_E_TXE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txe_irq</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="n">irq_src</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_E_TXE_MASK</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------</span>
<span class="cm">	Gadget driver probe and unregister.</span>
<span class="cm"> --------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsl_qe_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_udc</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="cm">/* lock is needed but whether should use this lock or another */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* hook up the driver */</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">max_speed</span><span class="p">;</span>

	<span class="cm">/* Enable IRQ reg and Set usbcmd reg EN bit */</span>
	<span class="n">qe_usb_enable</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>

	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usber</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="o">-&gt;</span><span class="n">usb_usbmr</span><span class="p">,</span> <span class="n">USB_E_DEFAULT_DEVICE</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_state</span> <span class="o">=</span> <span class="n">USB_STATE_ATTACHED</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="n">USB_DIR_OUT</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s bind to driver %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsl_qe_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">loop_ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_udc</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="cm">/* stop usb controller, disable intr */</span>
	<span class="n">qe_usb_disable</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>

	<span class="cm">/* in fact, no needed */</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_state</span> <span class="o">=</span> <span class="n">USB_STATE_ATTACHED</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* stand operation */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">nuke</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">loop_ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">)</span>
		<span class="n">nuke</span><span class="p">(</span><span class="n">loop_ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unregistered gadget driver &#39;%s&#39;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* udc structure&#39;s alloc and setup, include ep-param alloc */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">qe_udc</span> <span class="n">__devinit</span> <span class="o">*</span><span class="nf">qe_udc_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device_para</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">usbpram</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">udc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;malloc udc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* get default address of usb parameter in MURAM from device tree */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="o">*</span><span class="n">of_get_address</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_param</span> <span class="o">=</span> <span class="n">cpm_muram_addr</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">memset_io</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">usbpram</span> <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_param</span><span class="p">;</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbpram</span><span class="o">-&gt;</span><span class="n">frame_n</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbpram</span><span class="o">-&gt;</span><span class="n">rstate</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">tmp_addr</span> <span class="o">=</span> <span class="n">cpm_muram_alloc</span><span class="p">((</span><span class="n">USB_MAX_ENDPOINTS</span> <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep_para</span><span class="p">)),</span>
					   <span class="n">USB_EP_PARA_ALIGNMENT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">tmp_addr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">USB_MAX_ENDPOINTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbpram</span><span class="o">-&gt;</span><span class="n">epptr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">tmp_addr</span><span class="p">);</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep_param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpm_muram_addr</span><span class="p">(</span><span class="n">tmp_addr</span><span class="p">);</span>
		<span class="n">tmp_addr</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset_io</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep_param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">USB_MAX_ENDPOINTS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep_para</span><span class="p">));</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">resume_state</span> <span class="o">=</span> <span class="n">USB_STATE_NOTATTACHED</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_state</span> <span class="o">=</span> <span class="n">USB_STATE_POWERED</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">udc</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* USB Controller register init */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">qe_udc_reg_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_ctlr</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">qe_usbregs</span><span class="p">;</span>
	<span class="n">qe_usbregs</span> <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="p">;</span>

	<span class="cm">/* Spec says that we must enable the USB controller to change mode. */</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qe_usbregs</span><span class="o">-&gt;</span><span class="n">usb_usmod</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="cm">/* Mode changed, now disable it, since muram isn&#39;t initialized yet. */</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qe_usbregs</span><span class="o">-&gt;</span><span class="n">usb_usmod</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* Initialize the rest. */</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qe_usbregs</span><span class="o">-&gt;</span><span class="n">usb_usbmr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qe_usbregs</span><span class="o">-&gt;</span><span class="n">usb_uscom</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qe_usbregs</span><span class="o">-&gt;</span><span class="n">usb_usber</span><span class="p">,</span> <span class="n">USBER_ALL_CLEAR</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">qe_ep_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pipe_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">pipe_num</span><span class="p">];</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span> <span class="o">=</span> <span class="n">udc</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ep_name</span><span class="p">[</span><span class="n">pipe_num</span><span class="p">]);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ep_name</span><span class="p">[</span><span class="n">pipe_num</span><span class="p">];</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qe_ep_ops</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pipe_num</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxframe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">EP_STATE_IDLE</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* the queue lists any req for this ep */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="cm">/* gagdet.ep_list used for ep_autoconfig so no ep0*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe_num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">gadget</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-----------------------------------------------------------------------</span>
<span class="cm"> *	UDC device Driver operation functions				*</span>
<span class="cm"> *----------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qe_udc_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qe_udc</span><span class="p">,</span> <span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">complete</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
	<span class="n">cpm_muram_free</span><span class="p">(</span><span class="n">cpm_muram_offset</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep_param</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">USB_MAX_ENDPOINTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep_param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Driver probe functions */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">qe_udc_match</span><span class="p">[];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">qe_udc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">match</span> <span class="o">=</span> <span class="n">of_match_device</span><span class="p">(</span><span class="n">qe_udc_match</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;mode&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&quot;peripheral&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Initialize the udc structure including QH member and other member */</span>
	<span class="n">udc</span> <span class="o">=</span> <span class="n">qe_udc_config</span><span class="p">(</span><span class="n">ofdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to initialize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">soc_type</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize usb hw reg except for regs for EP,</span>
<span class="cm">	 * leave usbintr reg untouched*/</span>
	<span class="n">qe_udc_reg_init</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>

	<span class="cm">/* here comes the stand operations for probe</span>
<span class="cm">	 * set the qe_udc-&gt;gadget.xxx */</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qe_gadget_ops</span><span class="p">;</span>

	<span class="cm">/* gadget.ep0 is a pointer */</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="cm">/* modify in register gadget process */</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>

	<span class="cm">/* name: Identifies the controller hardware type. */</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">driver_name</span><span class="p">;</span>

	<span class="n">device_initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gadget&quot;</span><span class="p">);</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">qe_udc_release</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* initialize qe_ep struct */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">USB_MAX_ENDPOINTS</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* because the ep type isn&#39;t decide here so</span>
<span class="cm">		 * qe_ep_init() should be called in ep_enable() */</span>

		<span class="cm">/* setup the qe_ep struct and link ep.ep.list</span>
<span class="cm">		 * into gadget.ep_list */</span>
		<span class="n">qe_ep_config</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ep0 initialization in here */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qe_ep_init</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qe_ep0_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>

	<span class="cm">/* create a buf for ZLP send, need to remain zeroed */</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullbuf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot alloc nullbuf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* buffer for data of get_status request */</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">statusbuf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">statusbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullp</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullbuf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullp</span> <span class="o">==</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullp</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span>
					<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
					<span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullbuf</span><span class="p">,</span>
					<span class="mi">256</span><span class="p">,</span>
					<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullmap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
					<span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullp</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span>
					<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">,</span> <span class="n">ep_rx_tasklet</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">udc</span><span class="p">);</span>
	<span class="cm">/* request irq and disable DR  */</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_noirq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_irq</span><span class="p">,</span> <span class="n">qe_udc_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">driver_name</span><span class="p">,</span> <span class="n">udc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot request irq %d err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err6</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_add_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err7</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">udc</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s USB controller initialized as device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">soc_type</span> <span class="o">==</span> <span class="n">PORT_QE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;QE&quot;</span> <span class="o">:</span> <span class="s">&quot;CPM&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err7:</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err6:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_irq</span><span class="p">,</span> <span class="n">udc</span><span class="p">);</span>
<span class="nl">err5:</span>
	<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_irq</span><span class="p">);</span>
<span class="nl">err_noirq:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullp</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span>
				<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullp</span> <span class="o">=</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullp</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span>
				<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">statusbuf</span><span class="p">);</span>
<span class="nl">err4:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullbuf</span><span class="p">);</span>
<span class="nl">err3:</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">cpm_muram_free</span><span class="p">(</span><span class="n">cpm_muram_offset</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxframe</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuffer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span><span class="p">);</span>
<span class="nl">err2:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_udc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qe_udc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">qe_udc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qe_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qe_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">DECLARE_COMPLETION</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>

	<span class="n">usb_del_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">done</span><span class="p">;</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullp</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span>
				<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullp</span> <span class="o">=</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullp</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span>
				<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">statusbuf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">nullbuf</span><span class="p">);</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">cpm_muram_free</span><span class="p">(</span><span class="n">cpm_muram_offset</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbase</span><span class="p">));</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">+</span> <span class="n">USB_CRC_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">USB_BDRING_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxframe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbufmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuf_d</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuf_d</span> <span class="o">=</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuf_d</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rxbuffer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">txframe</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_irq</span><span class="p">,</span> <span class="n">udc</span><span class="p">);</span>
	<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_irq</span><span class="p">);</span>

	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">usb_regs</span><span class="p">);</span>

	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* wait for release() of gadget.dev to free udc */</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">done</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">qe_udc_match</span><span class="p">[]</span> <span class="n">__devinitconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,mpc8323-qe-usb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">PORT_QE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,mpc8360-qe-usb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">PORT_QE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,mpc8272-cpm-usb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">PORT_CPM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">qe_udc_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">udc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">driver_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">qe_udc_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>          <span class="o">=</span> <span class="n">qe_udc_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>         <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">qe_udc_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>        <span class="o">=</span> <span class="n">qe_udc_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>         <span class="o">=</span> <span class="n">qe_udc_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">udc_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
