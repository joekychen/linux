<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › gadget › dummy_hcd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dummy_hcd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * dummy_hcd.c -- Dummy/Loopback USB host and device emulator driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Maintainer: Alan Stern &lt;stern@rowland.harvard.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003 David Brownell</span>
<span class="cm"> * Copyright (C) 2003-2005 Alan Stern</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>


<span class="cm">/*</span>
<span class="cm"> * This exposes a device side &quot;USB gadget&quot; API, driven by requests to a</span>
<span class="cm"> * Linux-USB host controller driver.  USB traffic is simulated; there&#39;s</span>
<span class="cm"> * no need for USB hardware.  Use this with two other drivers:</span>
<span class="cm"> *</span>
<span class="cm"> *  - Gadget driver, responding to requests (slave);</span>
<span class="cm"> *  - Host-side device driver, as already familiar in Linux.</span>
<span class="cm"> *</span>
<span class="cm"> * Having this all in one kernel can help some stages of development,</span>
<span class="cm"> * bypassing some hardware (and driver) issues.  UML could help too.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>
<span class="cp">#include &lt;linux/usb/hcd.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>

<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#define DRIVER_DESC	&quot;USB Host+Gadget Emulator&quot;</span>
<span class="cp">#define DRIVER_VERSION	&quot;02 May 2005&quot;</span>

<span class="cp">#define POWER_BUDGET	500	</span><span class="cm">/* in mA; use 8 for low-power port testing */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>	<span class="n">driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;dummy_hcd&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>	<span class="n">driver_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;USB Host+Gadget Emulator&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>	<span class="n">gadget_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;dummy_udc&quot;</span><span class="p">;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;David Brownell&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">dummy_hcd_module_parameters</span> <span class="p">{</span>
	<span class="n">bool</span> <span class="n">is_super_speed</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_high_speed</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dummy_hcd_module_parameters</span> <span class="n">mod_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">is_super_speed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_high_speed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">is_super_speed</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">.</span><span class="n">is_super_speed</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">is_super_speed</span><span class="p">,</span> <span class="s">&quot;true to simulate SuperSpeed connection&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">is_high_speed</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">.</span><span class="n">is_high_speed</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">is_high_speed</span><span class="p">,</span> <span class="s">&quot;true to simulate HighSpeed connection&quot;</span><span class="p">);</span>
<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* gadget side driver data structres */</span>
<span class="k">struct</span> <span class="n">dummy_ep</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">queue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">last_io</span><span class="p">;</span>	<span class="cm">/* jiffies timestamp */</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span>		<span class="o">*</span><span class="n">gadget</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_ep</span>			<span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">halted</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">wedged</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">already_seen</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">setup_stage</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">stream_en</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dummy_request</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">queue</span><span class="p">;</span>		<span class="cm">/* ep&#39;s requests */</span>
	<span class="k">struct</span> <span class="n">usb_request</span>		<span class="n">req</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">dummy_ep</span> <span class="o">*</span><span class="nf">usb_ep_to_dummy_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dummy_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">dummy_request</span> <span class="o">*</span><span class="nf">usb_request_to_dummy_request</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dummy_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * Every device has ep0 for control requests, plus up to 30 more endpoints,</span>
<span class="cm"> * in one of two types:</span>
<span class="cm"> *</span>
<span class="cm"> *   - Configurable:  direction (in/out), type (bulk, iso, etc), and endpoint</span>
<span class="cm"> *     number can be changed.  Names like &quot;ep-a&quot; are used for this type.</span>
<span class="cm"> *</span>
<span class="cm"> *   - Fixed Function:  in other cases.  some characteristics may be mutable;</span>
<span class="cm"> *     that&#39;d be hardware-specific.  Names like &quot;ep12out-bulk&quot; are used.</span>
<span class="cm"> *</span>
<span class="cm"> * Gadget drivers are responsible for not setting up conflicting endpoint</span>
<span class="cm"> * configurations, illegal or unsupported packet lengths, and so on.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ep0name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;ep0&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">ep_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ep0name</span><span class="p">,</span>				<span class="cm">/* everyone has ep0 */</span>

	<span class="cm">/* act like a net2280: high speed, six configurable endpoints */</span>
	<span class="s">&quot;ep-a&quot;</span><span class="p">,</span> <span class="s">&quot;ep-b&quot;</span><span class="p">,</span> <span class="s">&quot;ep-c&quot;</span><span class="p">,</span> <span class="s">&quot;ep-d&quot;</span><span class="p">,</span> <span class="s">&quot;ep-e&quot;</span><span class="p">,</span> <span class="s">&quot;ep-f&quot;</span><span class="p">,</span>

	<span class="cm">/* or like pxa250: fifteen fixed function endpoints */</span>
	<span class="s">&quot;ep1in-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep2out-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep3in-iso&quot;</span><span class="p">,</span> <span class="s">&quot;ep4out-iso&quot;</span><span class="p">,</span> <span class="s">&quot;ep5in-int&quot;</span><span class="p">,</span>
	<span class="s">&quot;ep6in-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep7out-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep8in-iso&quot;</span><span class="p">,</span> <span class="s">&quot;ep9out-iso&quot;</span><span class="p">,</span> <span class="s">&quot;ep10in-int&quot;</span><span class="p">,</span>
	<span class="s">&quot;ep11in-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep12out-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep13in-iso&quot;</span><span class="p">,</span> <span class="s">&quot;ep14out-iso&quot;</span><span class="p">,</span>
		<span class="s">&quot;ep15in-int&quot;</span><span class="p">,</span>

	<span class="cm">/* or like sa1100: two fixed function endpoints */</span>
	<span class="s">&quot;ep1out-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep2in-bulk&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#define DUMMY_ENDPOINTS	ARRAY_SIZE(ep_name)</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#define FIFO_SIZE		64</span>

<span class="k">struct</span> <span class="n">urbp</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">urbp_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sg_mapping_iter</span>	<span class="n">miter</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">miter_started</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">enum</span> <span class="n">dummy_rh_state</span> <span class="p">{</span>
	<span class="n">DUMMY_RH_RESET</span><span class="p">,</span>
	<span class="n">DUMMY_RH_SUSPENDED</span><span class="p">,</span>
	<span class="n">DUMMY_RH_RUNNING</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy</span>			<span class="o">*</span><span class="n">dum</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dummy_rh_state</span>		<span class="n">rh_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>		<span class="n">timer</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">port_status</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">old_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">re_timeout</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">usb_device</span>		<span class="o">*</span><span class="n">udev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">urbp_list</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">stream_en_ep</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="n">num_stream</span><span class="p">[</span><span class="mi">30</span> <span class="o">/</span> <span class="mi">2</span><span class="p">];</span>

	<span class="kt">unsigned</span>			<span class="n">active</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">old_active</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">resuming</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dummy</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>			<span class="n">lock</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * SLAVE/GADGET side support</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">dummy_ep</span>			<span class="n">ep</span><span class="p">[</span><span class="n">DUMMY_ENDPOINTS</span><span class="p">];</span>
	<span class="kt">int</span>				<span class="n">address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span>		<span class="n">gadget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadget_driver</span>	<span class="o">*</span><span class="n">driver</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dummy_request</span>		<span class="n">fifo_req</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="n">fifo_buf</span><span class="p">[</span><span class="n">FIFO_SIZE</span><span class="p">];</span>
	<span class="n">u16</span>				<span class="n">devstatus</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">udc_suspended</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">pullup</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * MASTER/HOST side support</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span>		<span class="o">*</span><span class="n">hs_hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span>		<span class="o">*</span><span class="n">ss_hcd</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="nf">hcd_to_dummy_hcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">hcd_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="nf">dummy_hcd_to_hcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dum</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_hcd</span><span class="p">,</span> <span class="n">hcd_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="nf">dummy_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="nf">udc_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy</span> <span class="o">*</span><span class="n">dum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">dummy</span> <span class="o">*</span><span class="nf">ep_to_dummy</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="nf">gadget_to_dummy_hcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy</span> <span class="o">*</span><span class="n">dum</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_SUPER</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dum</span><span class="o">-&gt;</span><span class="n">ss_hcd</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">dum</span><span class="o">-&gt;</span><span class="n">hs_hcd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">dummy</span> <span class="o">*</span><span class="nf">gadget_dev_to_dummy</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dummy</span>			<span class="n">the_controller</span><span class="p">;</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* SLAVE/GADGET SIDE UTILITY ROUTINES */</span>

<span class="cm">/* called with spinlock held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nuke</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy</span> <span class="o">*</span><span class="n">dum</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dummy_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dummy_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dummy_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* caller must hold lock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_activity</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy</span> <span class="o">*</span><span class="n">dum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="cm">/* prevent any more requests */</span>
	<span class="n">dum</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* The timer is left running so that outstanding URBs can fail */</span>

	<span class="cm">/* nuke any pending requests first, so driver i/o is quiesced */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">)</span>
		<span class="n">nuke</span><span class="p">(</span><span class="n">dum</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="cm">/* driver now does any non-usb quiescing necessary */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * set_link_state_by_speed() - Sets the current state of the link according to</span>
<span class="cm"> *	the hcd speed</span>
<span class="cm"> * @dum_hcd: pointer to the dummy_hcd structure to update the link state for</span>
<span class="cm"> *</span>
<span class="cm"> * This function updates the port_status according to the link state and the</span>
<span class="cm"> * speed of the hcd.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_link_state_by_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy</span> <span class="o">*</span><span class="n">dum</span> <span class="o">=</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">HCD_USB3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">USB_SS_PORT_STAT_POWER</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">pullup</span> <span class="o">||</span> <span class="n">dum</span><span class="o">-&gt;</span><span class="n">udc_suspended</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* UDC suspend must cause a disconnect */</span>
			<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">USB_PORT_STAT_CONNECTION</span> <span class="o">|</span>
						<span class="n">USB_PORT_STAT_ENABLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">old_status</span> <span class="o">&amp;</span>
			     <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">|=</span>
					<span class="p">(</span><span class="n">USB_PORT_STAT_C_CONNECTION</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* device is connected and not suspended */</span>
			<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">|=</span> <span class="p">(</span><span class="n">USB_PORT_STAT_CONNECTION</span> <span class="o">|</span>
						 <span class="n">USB_PORT_STAT_SPEED_5GBPS</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">old_status</span> <span class="o">&amp;</span>
			     <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">|=</span>
					<span class="p">(</span><span class="n">USB_PORT_STAT_C_CONNECTION</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span>
			     <span class="n">USB_PORT_STAT_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span>
				 <span class="n">USB_SS_PORT_LS_U0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">!=</span> <span class="n">DUMMY_RH_SUSPENDED</span><span class="p">)</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_POWER</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">pullup</span> <span class="o">||</span> <span class="n">dum</span><span class="o">-&gt;</span><span class="n">udc_suspended</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* UDC suspend must cause a disconnect */</span>
			<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">USB_PORT_STAT_CONNECTION</span> <span class="o">|</span>
						<span class="n">USB_PORT_STAT_ENABLE</span> <span class="o">|</span>
						<span class="n">USB_PORT_STAT_LOW_SPEED</span> <span class="o">|</span>
						<span class="n">USB_PORT_STAT_HIGH_SPEED</span> <span class="o">|</span>
						<span class="n">USB_PORT_STAT_SUSPEND</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">old_status</span> <span class="o">&amp;</span>
			     <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">|=</span>
					<span class="p">(</span><span class="n">USB_PORT_STAT_C_CONNECTION</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">old_status</span> <span class="o">&amp;</span>
			     <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">|=</span>
					<span class="p">(</span><span class="n">USB_PORT_STAT_C_CONNECTION</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_PORT_STAT_SUSPEND</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span>
				  <span class="n">USB_PORT_STAT_SUSPEND</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
					<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">!=</span> <span class="n">DUMMY_RH_SUSPENDED</span><span class="p">)</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* caller must hold lock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_link_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy</span> <span class="o">*</span><span class="n">dum</span> <span class="o">=</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="p">;</span>

	<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">pullup</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">HCD_USB3</span> <span class="o">&amp;&amp;</span>
		     <span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_SUPER</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">HCD_USB3</span> <span class="o">&amp;&amp;</span>
		     <span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_SUPER</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

	<span class="n">set_link_state_by_speed</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	     <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">resuming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* if !connected or reset */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_RESET</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We&#39;re connected and not reset (reset occurred now),</span>
<span class="cm">		 * and driver attached - disconnect!</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">old_status</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">old_status</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_RESET</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stop_activity</span><span class="p">(</span><span class="n">dum</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">!=</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">old_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">old_active</span> <span class="o">&amp;&amp;</span> <span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">old_active</span> <span class="o">&amp;&amp;</span>  <span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">old_status</span> <span class="o">=</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span><span class="p">;</span>
	<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">old_active</span> <span class="o">=</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* SLAVE/GADGET SIDE DRIVER</span>
<span class="cm"> *</span>
<span class="cm"> * This only tracks gadget state.  All the work is done when the host</span>
<span class="cm"> * side tries some (emulated) i/o operation.  Real device controller</span>
<span class="cm"> * drivers would do real i/o using dma, fifos, irqs, timers, etc.</span>
<span class="cm"> */</span>

<span class="cp">#define is_enabled(dum) \</span>
<span class="cp">	(dum-&gt;port_status &amp; USB_PORT_STAT_ENABLE)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy</span>		<span class="o">*</span><span class="n">dum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span>	<span class="o">*</span><span class="n">dum_hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dummy_ep</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">usb_ep_to_dummy_ep</span><span class="p">(</span><span class="n">_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">||</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span>
			<span class="o">||</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">!=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dum</span> <span class="o">=</span> <span class="n">ep_to_dummy</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">gadget_to_dummy_hcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For HS/FS devices only bits 0..10 of the wMaxPacketSize represent the</span>
<span class="cm">	 * maximum packet size.</span>
<span class="cm">	 * For SS devices the wMaxPacketSize is limited by 1024.</span>
<span class="cm">	 */</span>
	<span class="n">max</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">;</span>

	<span class="cm">/* drivers must not request bad settings, since lower levels</span>
<span class="cm">	 * (hardware or its drivers) may not check.  some endpoints</span>
<span class="cm">	 * can&#39;t do iso, many have maxpacket limitations, etc.</span>
<span class="cm">	 *</span>
<span class="cm">	 * since this &quot;hardware&quot; driver is here to help debugging, we</span>
<span class="cm">	 * have some extra sanity checks.  (there could be more though,</span>
<span class="cm">	 * especially for &quot;ep9out&quot; style fixed function ones.)</span>
<span class="cm">	 */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">usb_endpoint_type</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;-iso&quot;</span><span class="p">)</span>
				<span class="o">||</span> <span class="n">strstr</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;-int&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_SPEED_SUPER</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">==</span> <span class="mi">1024</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">==</span> <span class="mi">512</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_SPEED_FULL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">||</span> <span class="n">max</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">||</span> <span class="n">max</span> <span class="o">==</span> <span class="mi">32</span> <span class="o">||</span> <span class="n">max</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span>
				<span class="cm">/* we&#39;ll fake any legal size */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* save a return statement */</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;-iso&quot;</span><span class="p">))</span> <span class="cm">/* bulk is ok */</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="cm">/* real hardware might not handle all packet sizes */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_SPEED_SUPER</span>:
		<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">1024</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* save a return statement */</span>
		<span class="k">case</span> <span class="n">USB_SPEED_FULL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* save a return statement */</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;-bulk&quot;</span><span class="p">)</span>
				<span class="o">||</span> <span class="n">strstr</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;-int&quot;</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="cm">/* real hardware might not handle all packet sizes */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_SPEED_SUPER</span>:
		<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">1024</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* save a return statement */</span>
		<span class="k">case</span> <span class="n">USB_SPEED_FULL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">1023</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* save a return statement */</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* few chips support control except on ep0 */</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">_ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_ss_max_streams</span><span class="p">(</span><span class="n">_ep</span><span class="o">-&gt;</span><span class="n">comp_desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_endpoint_xfer_bulk</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">udc_dev</span><span class="p">(</span><span class="n">dum</span><span class="p">),</span> <span class="s">&quot;Can&#39;t enable stream support on &quot;</span>
					<span class="s">&quot;non-bulk ep %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stream_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">udc_dev</span><span class="p">(</span><span class="n">dum</span><span class="p">),</span> <span class="s">&quot;enabled %s (ep%d%s-%s) maxpacket %d stream %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span>
		<span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">,</span>
		<span class="p">({</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
		 <span class="k">switch</span> <span class="p">(</span><span class="n">usb_endpoint_type</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
		 <span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>:
			 <span class="n">val</span> <span class="o">=</span> <span class="s">&quot;bulk&quot;</span><span class="p">;</span>
			 <span class="k">break</span><span class="p">;</span>
		 <span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>:
			 <span class="n">val</span> <span class="o">=</span> <span class="s">&quot;iso&quot;</span><span class="p">;</span>
			 <span class="k">break</span><span class="p">;</span>
		 <span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:
			 <span class="n">val</span> <span class="o">=</span> <span class="s">&quot;intr&quot;</span><span class="p">;</span>
			 <span class="k">break</span><span class="p">;</span>
		 <span class="nl">default:</span>
			 <span class="n">val</span> <span class="o">=</span> <span class="s">&quot;ctrl&quot;</span><span class="p">;</span>
			 <span class="k">break</span><span class="p">;</span>
		 <span class="p">};</span> <span class="n">val</span><span class="p">;</span> <span class="p">}),</span>
		<span class="n">max</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stream_en</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>

	<span class="cm">/* at this point real hardware should be NAKing transfers</span>
<span class="cm">	 * to that endpoint, until a buffer is queued to it.</span>
<span class="cm">	 */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">wedged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_ep</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dummy</span>		<span class="o">*</span><span class="n">dum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">usb_ep_to_dummy_ep</span><span class="p">(</span><span class="n">_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">||</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dum</span> <span class="o">=</span> <span class="n">ep_to_dummy</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stream_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nuke</span><span class="p">(</span><span class="n">dum</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">udc_dev</span><span class="p">(</span><span class="n">dum</span><span class="p">),</span> <span class="s">&quot;disabled %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="nf">dummy_alloc_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span>
		<span class="n">gfp_t</span> <span class="n">mem_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_ep</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dummy_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">usb_ep_to_dummy_ep</span><span class="p">(</span><span class="n">_ep</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">mem_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dummy_free_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">usb_request_to_dummy_request</span><span class="p">(</span><span class="n">_req</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fifo_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">,</span>
		<span class="n">gfp_t</span> <span class="n">mem_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_ep</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dummy_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dummy</span>		<span class="o">*</span><span class="n">dum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span>	<span class="o">*</span><span class="n">dum_hcd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">usb_request_to_dummy_request</span><span class="p">(</span><span class="n">_req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_req</span> <span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">usb_ep_to_dummy_ep</span><span class="p">(</span><span class="n">_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!=</span> <span class="n">ep0name</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dum</span> <span class="o">=</span> <span class="n">ep_to_dummy</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">gadget_to_dummy_hcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	dev_dbg(udc_dev(dum), &quot;ep %p queue req %p to %s, len %d buf %p\n&quot;,</span>
<span class="c">			ep, _req, _ep-&gt;name, _req-&gt;length, _req-&gt;buf);</span>
<span class="cp">#endif</span>
	<span class="n">_req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">_req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* implement an emulated single-request FIFO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">fifo_req</span><span class="p">.</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">_req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="n">FIFO_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">fifo_req</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="o">*</span><span class="n">_req</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">dum</span><span class="o">-&gt;</span><span class="n">fifo_buf</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">fifo_buf</span><span class="p">,</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">dum</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span> <span class="o">=</span> <span class="n">fifo_complete</span><span class="p">;</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">_req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">=</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="n">_req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">_req</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="n">_req</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>  <span class="k">else</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* real hardware would likely enable transfers here, in case</span>
<span class="cm">	 * it&#39;d been left NAKing.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_ep</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dummy</span>		<span class="o">*</span><span class="n">dum</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dummy_request</span>	<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">usb_ep_to_dummy_ep</span><span class="p">(</span><span class="n">_ep</span><span class="p">);</span>
	<span class="n">dum</span> <span class="o">=</span> <span class="n">ep_to_dummy</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">==</span> <span class="n">_req</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
			<span class="n">_req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">udc_dev</span><span class="p">(</span><span class="n">dum</span><span class="p">),</span>
				<span class="s">&quot;dequeued req %p from %s, len %d buf %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">req</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">_req</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="n">_req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dummy_set_halt_and_wedge</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wedged</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_ep</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dummy</span>		<span class="o">*</span><span class="n">dum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">usb_ep_to_dummy_ep</span><span class="p">(</span><span class="n">_ep</span><span class="p">);</span>
	<span class="n">dum</span> <span class="o">=</span> <span class="n">ep_to_dummy</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">wedged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wedged</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">wedged</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* FIXME clear emulated data toggle too */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dummy_set_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dummy_set_halt_and_wedge</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_set_wedge</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dummy_set_halt_and_wedge</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">dummy_ep_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">dummy_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">dummy_disable</span><span class="p">,</span>

	<span class="p">.</span><span class="n">alloc_request</span>	<span class="o">=</span> <span class="n">dummy_alloc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_request</span>	<span class="o">=</span> <span class="n">dummy_free_request</span><span class="p">,</span>

	<span class="p">.</span><span class="n">queue</span>		<span class="o">=</span> <span class="n">dummy_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue</span>	<span class="o">=</span> <span class="n">dummy_dequeue</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_halt</span>	<span class="o">=</span> <span class="n">dummy_set_halt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wedge</span>	<span class="o">=</span> <span class="n">dummy_set_wedge</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* there are both host and device side versions of this call ... */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_g_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timeval</span>	<span class="n">tv</span><span class="p">;</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span><span class="p">;</span>

	<span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">gadget_to_dummy_hcd</span><span class="p">(</span><span class="n">_gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">devstatus</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DEVICE_B_HNP_ENABLE</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DEVICE_REMOTE_WAKEUP</span><span class="p">))))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOLINK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_SUSPEND</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			 <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">!=</span> <span class="n">DUMMY_RH_SUSPENDED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* FIXME: What if the root hub is suspended but the port isn&#39;t? */</span>

	<span class="cm">/* hub notices our request, issues downstream resume, etc */</span>
	<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">resuming</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">re_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rh_timer</span><span class="p">,</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">re_timeout</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_set_selfpowered</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy</span>	<span class="o">*</span><span class="n">dum</span><span class="p">;</span>

	<span class="n">dum</span> <span class="o">=</span> <span class="n">gadget_to_dummy_hcd</span><span class="p">(</span><span class="n">_gadget</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dum</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">dum</span><span class="o">-&gt;</span><span class="n">devstatus</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DEVICE_SELF_POWERED</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dum</span><span class="o">-&gt;</span><span class="n">devstatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DEVICE_SELF_POWERED</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dummy_udc_update_ep0</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy</span> <span class="o">*</span><span class="n">dum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_SUPER</span><span class="p">)</span>
		<span class="n">dum</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dum</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_pullup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dummy</span>	<span class="o">*</span><span class="n">dum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">dum</span> <span class="o">=</span> <span class="n">gadget_dev_to_dummy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_gadget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mod_data</span><span class="p">.</span><span class="n">is_super_speed</span><span class="p">)</span>
			<span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">max_speed</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mod_data</span><span class="p">.</span><span class="n">is_high_speed</span><span class="p">)</span>
			<span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="n">USB_SPEED_HIGH</span><span class="p">,</span>
					<span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">max_speed</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
		<span class="n">dummy_udc_update_ep0</span><span class="p">(</span><span class="n">dum</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">max_speed</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">udc_dev</span><span class="p">(</span><span class="n">dum</span><span class="p">),</span> <span class="s">&quot;This device can perform faster&quot;</span>
				<span class="s">&quot; if you connect it to a %s port...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">usb_speed_string</span><span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">max_speed</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">gadget_to_dummy_hcd</span><span class="p">(</span><span class="n">_gadget</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dum</span><span class="o">-&gt;</span><span class="n">pullup</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_link_state</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">usb_hcd_poll_rh_status</span><span class="p">(</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dummy_udc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dummy_udc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_gadget_ops</span> <span class="n">dummy_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_frame</span>	<span class="o">=</span> <span class="n">dummy_g_get_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wakeup</span>		<span class="o">=</span> <span class="n">dummy_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_selfpowered</span> <span class="o">=</span> <span class="n">dummy_set_selfpowered</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pullup</span>		<span class="o">=</span> <span class="n">dummy_pullup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_start</span>	<span class="o">=</span> <span class="n">dummy_udc_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_stop</span>	<span class="o">=</span> <span class="n">dummy_udc_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* &quot;function&quot; sysfs attribute */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy</span>	<span class="o">*</span><span class="n">dum</span> <span class="o">=</span> <span class="n">gadget_dev_to_dummy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="o">!</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_function</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * Driver registration/unregistration.</span>
<span class="cm"> *</span>
<span class="cm"> * This is basically hardware-specific; there&#39;s usually only one real USB</span>
<span class="cm"> * device (not host) controller since that&#39;s how USB devices are intended</span>
<span class="cm"> * to work.  So most implementations of these api calls will rely on the</span>
<span class="cm"> * fact that only one driver will ever bind to the hardware.  But curious</span>
<span class="cm"> * hardware can be built with discrete components, so the gadget API doesn&#39;t</span>
<span class="cm"> * require that assumption.</span>
<span class="cm"> *</span>
<span class="cm"> * For this emulator, it might be convenient to create a usb slave device</span>
<span class="cm"> * for each driver that registers:  just add to a big root hub.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_udc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span>	<span class="o">*</span><span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">gadget_to_dummy_hcd</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dummy</span>		<span class="o">*</span><span class="n">dum</span> <span class="o">=</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">max_speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * SLAVE side init ... the layer above hardware, which</span>
<span class="cm">	 * can&#39;t enumerate without help from the driver we&#39;re binding.</span>
<span class="cm">	 */</span>

	<span class="n">dum</span><span class="o">-&gt;</span><span class="n">devstatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">udc_dev</span><span class="p">(</span><span class="n">dum</span><span class="p">),</span> <span class="s">&quot;binding gadget driver &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_udc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span>	<span class="o">*</span><span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">gadget_to_dummy_hcd</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dummy</span>		<span class="o">*</span><span class="n">dum</span> <span class="o">=</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">udc_dev</span><span class="p">(</span><span class="n">dum</span><span class="p">),</span> <span class="s">&quot;unregister gadget driver &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef is_enabled</span>

<span class="cm">/* The gadget structure is stored inside the hcd structure and will be</span>
<span class="cm"> * released along with it. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dummy_gadget_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_dummy_udc_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy</span> <span class="o">*</span><span class="n">dum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DUMMY_ENDPOINTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dummy_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep_name</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ep_name</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dummy_ep_ops</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">wedged</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">already_seen</span> <span class="o">=</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">setup_stage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">max_streams</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">last_io</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">gadget</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">fifo_req</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_USB_OTG</span>
	<span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">is_otg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_udc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy</span>	<span class="o">*</span><span class="n">dum</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">the_controller</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">rc</span><span class="p">;</span>

	<span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">gadget_name</span><span class="p">;</span>
	<span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dummy_ops</span><span class="p">;</span>
	<span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">max_speed</span> <span class="o">=</span> <span class="n">USB_SPEED_SUPER</span><span class="p">;</span>

	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gadget&quot;</span><span class="p">);</span>
	<span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">dummy_gadget_release</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_dummy_udc_hw</span><span class="p">(</span><span class="n">dum</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_add_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_udc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_function</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_dev</span><span class="p">;</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dum</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">err_dev:</span>
	<span class="n">usb_del_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
<span class="nl">err_udc:</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_udc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy</span>	<span class="o">*</span><span class="n">dum</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">usb_del_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_function</span><span class="p">);</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dummy_udc_pm</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy</span> <span class="o">*</span><span class="n">dum</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">suspend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dum</span><span class="o">-&gt;</span><span class="n">udc_suspended</span> <span class="o">=</span> <span class="n">suspend</span><span class="p">;</span>
	<span class="n">set_link_state</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_udc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy</span>		<span class="o">*</span><span class="n">dum</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span>	<span class="o">*</span><span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">gadget_to_dummy_hcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">dummy_udc_pm</span><span class="p">(</span><span class="n">dum</span><span class="p">,</span> <span class="n">dum_hcd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">usb_hcd_poll_rh_status</span><span class="p">(</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_udc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy</span>		<span class="o">*</span><span class="n">dum</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span>	<span class="o">*</span><span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">gadget_to_dummy_hcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">dummy_udc_pm</span><span class="p">(</span><span class="n">dum</span><span class="p">,</span> <span class="n">dum_hcd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">usb_hcd_poll_rh_status</span><span class="p">(</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">dummy_udc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">dummy_udc_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">dummy_udc_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">dummy_udc_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">dummy_udc_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">gadget_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dummy_get_ep_idx</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">usb_endpoint_num</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
		<span class="n">index</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* MASTER/HOST SIDE DRIVER</span>
<span class="cm"> *</span>
<span class="cm"> * this uses the hcd framework to hook up to host side drivers.</span>
<span class="cm"> * its root hub will only have one device, otherwise it acts like</span>
<span class="cm"> * a normal host controller.</span>
<span class="cm"> *</span>
<span class="cm"> * when urbs are queued, they&#39;re just stuck on a list that we</span>
<span class="cm"> * scan in a timer callback.  that callback connects writes from</span>
<span class="cm"> * the host with reads from the device, and so on, based on the</span>
<span class="cm"> * usb 2.0 rules.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_ep_stream_en</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_endpoint_xfer_bulk</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">dummy_get_ep_idx</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">stream_en_ep</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The max stream number is saved as a nibble so for the 30 possible endpoints</span>
<span class="cm"> * we only 15 bytes of memory. Therefore we are limited to max 16 streams (0</span>
<span class="cm"> * means we use only 1 stream). The maximum according to the spec is 16bit so</span>
<span class="cm"> * if the 16 stream limit is about to go, the array size should be incremented</span>
<span class="cm"> * to 30 elements of type u16.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_max_streams_for_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_streams</span><span class="p">;</span>

	<span class="n">max_streams</span> <span class="o">=</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">num_stream</span><span class="p">[</span><span class="n">usb_pipeendpoint</span><span class="p">(</span><span class="n">pipe</span><span class="p">)];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeout</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
		<span class="n">max_streams</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max_streams</span> <span class="o">&amp;=</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">max_streams</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">max_streams</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_max_streams_for_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">streams</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_streams</span><span class="p">;</span>

	<span class="n">streams</span><span class="o">--</span><span class="p">;</span>
	<span class="n">max_streams</span> <span class="o">=</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">num_stream</span><span class="p">[</span><span class="n">usb_pipeendpoint</span><span class="p">(</span><span class="n">pipe</span><span class="p">)];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeout</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">streams</span> <span class="o">&lt;&lt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">max_streams</span> <span class="o">&amp;=</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">max_streams</span> <span class="o">&amp;=</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">max_streams</span> <span class="o">|=</span> <span class="n">streams</span><span class="p">;</span>
	<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">num_stream</span><span class="p">[</span><span class="n">usb_pipeendpoint</span><span class="p">(</span><span class="n">pipe</span><span class="p">)]</span> <span class="o">=</span> <span class="n">max_streams</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_validate_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_streams</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enabled</span><span class="p">;</span>

	<span class="n">enabled</span> <span class="o">=</span> <span class="n">dummy_ep_stream_en</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">stream_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">max_streams</span> <span class="o">=</span> <span class="n">get_max_streams_for_pipe</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">,</span>
			<span class="n">usb_pipeendpoint</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">stream_id</span> <span class="o">&gt;</span> <span class="n">max_streams</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span> <span class="s">&quot;Stream id %d is out of range.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">stream_id</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_urb_enqueue</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>			<span class="o">*</span><span class="n">hcd</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">urb</span>			<span class="o">*</span><span class="n">urb</span><span class="p">,</span>
	<span class="n">gfp_t</span>				<span class="n">mem_flags</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urbp</span>	<span class="o">*</span><span class="n">urbp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">rc</span><span class="p">;</span>

	<span class="n">urbp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">urbp</span><span class="p">,</span> <span class="n">mem_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urbp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">urbp</span><span class="o">-&gt;</span><span class="n">urb</span> <span class="o">=</span> <span class="n">urb</span><span class="p">;</span>
	<span class="n">urbp</span><span class="o">-&gt;</span><span class="n">miter_started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">hcd_to_dummy_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dummy_validate_stream</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">urbp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_hcd_link_urb_to_ep</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">urbp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">usb_get_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">!=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span> <span class="s">&quot;usb_device address has changed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urbp</span><span class="o">-&gt;</span><span class="n">urbp_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">urbp_list</span><span class="p">);</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span> <span class="o">=</span> <span class="n">urbp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipetype</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">==</span> <span class="n">PIPE_CONTROL</span><span class="p">)</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">error_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* mark as a new urb */</span>

	<span class="cm">/* kick the scheduler, it&#39;ll do the rest */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

 <span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_urb_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* giveback happens automatically in timer callback,</span>
<span class="cm">	 * so make sure the callback happens */</span>
	<span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">hcd_to_dummy_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_hcd_check_unlink_urb</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">!=</span> <span class="n">DUMMY_RH_RUNNING</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">urbp_list</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_perform_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dummy_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span> <span class="o">*</span><span class="n">rbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urbp</span> <span class="o">*</span><span class="n">urbp</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">to_host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sg_mapping_iter</span> <span class="o">*</span><span class="n">miter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">urbp</span><span class="o">-&gt;</span><span class="n">miter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">trans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">this_sg</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">next_sg</span><span class="p">;</span>

	<span class="n">to_host</span> <span class="o">=</span> <span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">rbuf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">num_sgs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ubuf</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">+</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">to_host</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">rbuf</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urbp</span><span class="o">-&gt;</span><span class="n">miter_started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">SG_MITER_ATOMIC</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">to_host</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">SG_MITER_TO_SG</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">SG_MITER_FROM_SG</span><span class="p">;</span>

		<span class="n">sg_miter_start</span><span class="p">(</span><span class="n">miter</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">num_sgs</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">urbp</span><span class="o">-&gt;</span><span class="n">miter_started</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">next_sg</span> <span class="o">=</span> <span class="n">sg_miter_next</span><span class="p">(</span><span class="n">miter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">next_sg</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ubuf</span> <span class="o">=</span> <span class="n">miter</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">this_sg</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">miter</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">miter</span><span class="o">-&gt;</span><span class="n">consumed</span> <span class="o">=</span> <span class="n">this_sg</span><span class="p">;</span>
		<span class="n">trans</span> <span class="o">+=</span> <span class="n">this_sg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">to_host</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">this_sg</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">rbuf</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="n">this_sg</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">this_sg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">next_sg</span> <span class="o">=</span> <span class="n">sg_miter_next</span><span class="p">(</span><span class="n">miter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next_sg</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rbuf</span> <span class="o">+=</span> <span class="n">this_sg</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">sg_miter_stop</span><span class="p">(</span><span class="n">miter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">trans</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* transfer up to a frame&#39;s worth; caller must own lock */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dummy_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy</span>		<span class="o">*</span><span class="n">dum</span> <span class="o">=</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dummy_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

<span class="nl">top:</span>
	<span class="cm">/* if there&#39;s no request queued, the device is NAKing; return */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span>	<span class="n">host_len</span><span class="p">,</span> <span class="n">dev_len</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
		<span class="kt">int</span>		<span class="n">is_short</span><span class="p">,</span> <span class="n">to_host</span><span class="p">;</span>
		<span class="kt">int</span>		<span class="n">rescan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dummy_ep_stream_en</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">stream_id</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">stream_id</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* 1..N packets of ep-&gt;ep.maxpacket each ... the last one</span>
<span class="cm">		 * may be short (including zero length).</span>
<span class="cm">		 *</span>
<span class="cm">		 * writer can send a zlp explicitly (length 0) or implicitly</span>
<span class="cm">		 * (length mod maxpacket zero, and &#39;zero&#39; flag); they always</span>
<span class="cm">		 * terminate reads.</span>
<span class="cm">		 */</span>
		<span class="n">host_len</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">-</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
		<span class="n">dev_len</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">host_len</span><span class="p">,</span> <span class="n">dev_len</span><span class="p">);</span>

		<span class="cm">/* FIXME update emulated data toggle too */</span>

		<span class="n">to_host</span> <span class="o">=</span> <span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">is_short</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* not enough bandwidth left? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">&amp;&amp;</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* use an extra pass for the final short packet */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rescan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">len</span> <span class="o">-=</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">is_short</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">len</span> <span class="o">=</span> <span class="n">dummy_perform_transfer</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">last_io</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">limit</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* short packets terminate, maybe with overflow/underflow.</span>
<span class="cm">		 * it&#39;s only really an error to write too much.</span>
<span class="cm">		 *</span>
<span class="cm">		 * partially filling a buffer optionally blocks queue advances</span>
<span class="cm">		 * (so completion handlers can clean up the queue) but we don&#39;t</span>
<span class="cm">		 * need to emulate such data-in-flight.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_short</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host_len</span> <span class="o">==</span> <span class="n">dev_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">to_host</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev_len</span> <span class="o">&gt;</span> <span class="n">host_len</span><span class="p">)</span>
					<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">to_host</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">host_len</span> <span class="o">&gt;</span> <span class="n">dev_len</span><span class="p">)</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="cm">/* many requests terminate without a short packet */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span>
					<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span><span class="p">)</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">==</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span>
					<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span>
						<span class="o">&amp;</span> <span class="n">URB_ZERO_PACKET</span><span class="p">))</span>
				<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* device side completion --&gt; continuable */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

			<span class="cm">/* requests might have been unlinked... */</span>
			<span class="n">rescan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* host side completion --&gt; terminate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* rescan to continue with any other queued i/o */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rescan</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">top</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">limit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">periodic_bytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy</span> <span class="o">*</span><span class="n">dum</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dummy_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">limit</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">tmp</span><span class="p">;</span>

		<span class="cm">/* high bandwidth mode */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">*=</span> <span class="mi">8</span> <span class="cm">/* applies to entire frame */</span><span class="p">;</span>
		<span class="n">limit</span> <span class="o">+=</span> <span class="n">limit</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_SUPER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">usb_endpoint_type</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>:
			<span class="cm">/* Sec. 4.4.8.2 USB3.0 Spec */</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:
			<span class="cm">/* Sec. 4.4.7.2 USB3.0 Spec */</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>:
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">limit</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define is_active(dum_hcd)	((dum_hcd-&gt;port_status &amp; \</span>
<span class="cp">		(USB_PORT_STAT_CONNECTION | USB_PORT_STAT_ENABLE | \</span>
<span class="cp">			USB_PORT_STAT_SUSPEND)) \</span>
<span class="cp">		== (USB_PORT_STAT_CONNECTION | USB_PORT_STAT_ENABLE))</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dummy_ep</span> <span class="o">*</span><span class="nf">find_endpoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy</span> <span class="o">*</span><span class="n">dum</span><span class="p">,</span> <span class="n">u8</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_active</span><span class="p">((</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_SUPER</span> <span class="o">?</span>
			<span class="n">dum</span><span class="o">-&gt;</span><span class="n">ss_hcd</span> <span class="o">:</span> <span class="n">dum</span><span class="o">-&gt;</span><span class="n">hs_hcd</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">address</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DUMMY_ENDPOINTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dummy_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">==</span> <span class="n">address</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef is_active</span>

<span class="cp">#define Dev_Request	(USB_TYPE_STANDARD | USB_RECIP_DEVICE)</span>
<span class="cp">#define Dev_InRequest	(Dev_Request | USB_DIR_IN)</span>
<span class="cp">#define Intf_Request	(USB_TYPE_STANDARD | USB_RECIP_INTERFACE)</span>
<span class="cp">#define Intf_InRequest	(Intf_Request | USB_DIR_IN)</span>
<span class="cp">#define Ep_Request	(USB_TYPE_STANDARD | USB_RECIP_ENDPOINT)</span>
<span class="cp">#define Ep_InRequest	(Ep_Request | USB_DIR_IN)</span>


<span class="cm">/**</span>
<span class="cm"> * handle_control_request() - handles all control transfers</span>
<span class="cm"> * @dum: pointer to dummy (the_controller)</span>
<span class="cm"> * @urb: the urb request to handle</span>
<span class="cm"> * @setup: pointer to the setup data for a USB device control</span>
<span class="cm"> *	 request</span>
<span class="cm"> * @status: pointer to request handling status</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 - if the request was handled</span>
<span class="cm"> *	  1 - if the request wasn&#39;t handles</span>
<span class="cm"> *	  error code on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_control_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">setup</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_ep</span>		<span class="o">*</span><span class="n">ep2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dummy</span>		<span class="o">*</span><span class="n">dum</span> <span class="o">=</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">w_index</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">w_value</span><span class="p">;</span>

	<span class="n">w_index</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">);</span>
	<span class="n">w_value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequest</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_REQ_SET_ADDRESS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="n">Dev_Request</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dum</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">w_value</span><span class="p">;</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">udc_dev</span><span class="p">(</span><span class="n">dum</span><span class="p">),</span> <span class="s">&quot;set_address = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">w_value</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_REQ_SET_FEATURE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">==</span> <span class="n">Dev_Request</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">w_value</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">USB_DEVICE_REMOTE_WAKEUP</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_DEVICE_B_HNP_ENABLE</span>:
				<span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">b_hnp_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_DEVICE_A_HNP_SUPPORT</span>:
				<span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">a_hnp_support</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_DEVICE_A_ALT_HNP_SUPPORT</span>:
				<span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">a_alt_hnp_support</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_DEVICE_U1_ENABLE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span>
				    <span class="n">HCD_USB3</span><span class="p">)</span>
					<span class="n">w_value</span> <span class="o">=</span> <span class="n">USB_DEV_STAT_U1_ENABLED</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_DEVICE_U2_ENABLE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span>
				    <span class="n">HCD_USB3</span><span class="p">)</span>
					<span class="n">w_value</span> <span class="o">=</span> <span class="n">USB_DEV_STAT_U2_ENABLED</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_DEVICE_LTM_ENABLE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span>
				    <span class="n">HCD_USB3</span><span class="p">)</span>
					<span class="n">w_value</span> <span class="o">=</span> <span class="n">USB_DEV_STAT_LTM_ENABLED</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dum</span><span class="o">-&gt;</span><span class="n">devstatus</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">w_value</span><span class="p">);</span>
				<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">==</span> <span class="n">Ep_Request</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* endpoint halt */</span>
			<span class="n">ep2</span> <span class="o">=</span> <span class="n">find_endpoint</span><span class="p">(</span><span class="n">dum</span><span class="p">,</span> <span class="n">w_index</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep2</span> <span class="o">||</span> <span class="n">ep2</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ep2</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_REQ_CLEAR_FEATURE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">==</span> <span class="n">Dev_Request</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">w_value</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">USB_DEVICE_REMOTE_WAKEUP</span>:
				<span class="n">w_value</span> <span class="o">=</span> <span class="n">USB_DEVICE_REMOTE_WAKEUP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_DEVICE_U1_ENABLE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span>
				    <span class="n">HCD_USB3</span><span class="p">)</span>
					<span class="n">w_value</span> <span class="o">=</span> <span class="n">USB_DEV_STAT_U1_ENABLED</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_DEVICE_U2_ENABLE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span>
				    <span class="n">HCD_USB3</span><span class="p">)</span>
					<span class="n">w_value</span> <span class="o">=</span> <span class="n">USB_DEV_STAT_U2_ENABLED</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_DEVICE_LTM_ENABLE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span>
				    <span class="n">HCD_USB3</span><span class="p">)</span>
					<span class="n">w_value</span> <span class="o">=</span> <span class="n">USB_DEV_STAT_LTM_ENABLED</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dum</span><span class="o">-&gt;</span><span class="n">devstatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">w_value</span><span class="p">);</span>
				<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">==</span> <span class="n">Ep_Request</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* endpoint halt */</span>
			<span class="n">ep2</span> <span class="o">=</span> <span class="n">find_endpoint</span><span class="p">(</span><span class="n">dum</span><span class="p">,</span> <span class="n">w_index</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep2</span><span class="o">-&gt;</span><span class="n">wedged</span><span class="p">)</span>
				<span class="n">ep2</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_REQ_GET_STATUS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">==</span> <span class="n">Dev_InRequest</span>
				<span class="o">||</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">==</span> <span class="n">Intf_InRequest</span>
				<span class="o">||</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">==</span> <span class="n">Ep_InRequest</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * device: remote wakeup, selfpowered</span>
<span class="cm">			 * interface: nothing</span>
<span class="cm">			 * endpoint: halt</span>
<span class="cm">			 */</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">==</span> <span class="n">Ep_InRequest</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ep2</span> <span class="o">=</span> <span class="n">find_endpoint</span><span class="p">(</span><span class="n">dum</span><span class="p">,</span> <span class="n">w_index</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep2</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ep2</span><span class="o">-&gt;</span><span class="n">halted</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">==</span>
					   <span class="n">Dev_InRequest</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">devstatus</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">);</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* drive both sides of the transfers; looks like irq handlers to</span>
<span class="cm"> * both drivers except the callbacks aren&#39;t in_irq().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dummy_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_dum_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span>	<span class="o">*</span><span class="n">dum_hcd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="p">)</span> <span class="n">_dum_hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dummy</span>		<span class="o">*</span><span class="n">dum</span> <span class="o">=</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urbp</span>		<span class="o">*</span><span class="n">urbp</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">limit</span><span class="p">,</span> <span class="n">total</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>

	<span class="cm">/* simplistic model for one frame&#39;s bandwidth */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_SPEED_LOW</span>:
		<span class="n">total</span> <span class="o">=</span> <span class="mi">8</span><span class="cm">/*bytes*/</span> <span class="o">*</span> <span class="mi">12</span><span class="cm">/*packets*/</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_SPEED_FULL</span>:
		<span class="n">total</span> <span class="o">=</span> <span class="mi">64</span><span class="cm">/*bytes*/</span> <span class="o">*</span> <span class="mi">19</span><span class="cm">/*packets*/</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
		<span class="n">total</span> <span class="o">=</span> <span class="mi">512</span><span class="cm">/*bytes*/</span> <span class="o">*</span> <span class="mi">13</span><span class="cm">/*packets*/</span> <span class="o">*</span> <span class="mi">8</span><span class="cm">/*uframes*/</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_SPEED_SUPER</span>:
		<span class="cm">/* Bus speed is 500000 bytes/ms, so use a little less */</span>
		<span class="n">total</span> <span class="o">=</span> <span class="mi">490000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span> <span class="s">&quot;bogus device speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME if HZ != 1000 this will probably misbehave ... */</span>

	<span class="cm">/* look at each urb queued by the host side driver */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span>
				<span class="s">&quot;timer fired with no URBs pending?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DUMMY_ENDPOINTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep_name</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dum</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">already_seen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">restart:</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">urbp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">urbp_list</span><span class="p">,</span> <span class="n">urbp_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">urb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">dummy_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
		<span class="n">u8</span>			<span class="n">address</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">dummy_ep</span>		<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">int</span>			<span class="n">type</span><span class="p">;</span>
		<span class="kt">int</span>			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

		<span class="n">urb</span> <span class="o">=</span> <span class="n">urbp</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">unlinked</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">return_urb</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">!=</span> <span class="n">DUMMY_RH_RUNNING</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">usb_pipetype</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

		<span class="cm">/* used up this frame&#39;s non-periodic bandwidth?</span>
<span class="cm">		 * FIXME there&#39;s infinite bandwidth for control and</span>
<span class="cm">		 * periodic transfers ... unrealistic.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">PIPE_BULK</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* find the gadget&#39;s ep for this request (if configured) */</span>
		<span class="n">address</span> <span class="o">=</span> <span class="n">usb_pipeendpoint</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
			<span class="n">address</span> <span class="o">|=</span> <span class="n">USB_DIR_IN</span><span class="p">;</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">find_endpoint</span><span class="p">(</span><span class="n">dum</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* set_configuration() disagreement */</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span>
				<span class="s">&quot;no ep configured for urb %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">urb</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">return_urb</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">already_seen</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">already_seen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">error_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">setup_stage</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* a new urb */</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">setup_stage</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* NOTE: must not be iso! */</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span> <span class="s">&quot;ep %s halted, urb %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">return_urb</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* FIXME make sure both ends agree on maxpacket */</span>

		<span class="cm">/* handle control requests */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">setup_stage</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">usb_ctrlrequest</span>		<span class="n">setup</span><span class="p">;</span>
			<span class="kt">int</span>				<span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">setup</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">setup_packet</span><span class="p">;</span>
			<span class="cm">/* paranoia, in case of stale queued data */</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">udc_dev</span><span class="p">(</span><span class="n">dum</span><span class="p">),</span> <span class="s">&quot;stale req = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">req</span><span class="p">);</span>

				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">already_seen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* gadget driver never sees set_address or operations</span>
<span class="cm">			 * on standard feature flags.  some hardware doesn&#39;t</span>
<span class="cm">			 * even expose them.</span>
<span class="cm">			 */</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">last_io</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">setup_stage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">value</span> <span class="o">=</span> <span class="n">handle_control_request</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

			<span class="cm">/* gadget driver handles all other requests.  block</span>
<span class="cm">			 * until setup() returns; no reentrancy issues etc.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">setup</span><span class="p">);</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* no delays (max 64KB data stage) */</span>
					<span class="n">limit</span> <span class="o">=</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">treat_control_like_bulk</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* error, see below */</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="n">udc_dev</span><span class="p">(</span><span class="n">dum</span><span class="p">),</span>
						<span class="s">&quot;setup --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">value</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">goto</span> <span class="n">return_urb</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* non-control requests */</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">usb_pipetype</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PIPE_ISOCHRONOUS</span>:
			<span class="cm">/* FIXME is it urb-&gt;interval since the last xfer?</span>
<span class="cm">			 * use urb-&gt;iso_frame_desc[i].</span>
<span class="cm">			 * complete whether or not ep has requests queued.</span>
<span class="cm">			 * report random errors, to debug drivers.</span>
<span class="cm">			 */</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">periodic_bytes</span><span class="p">(</span><span class="n">dum</span><span class="p">,</span> <span class="n">ep</span><span class="p">));</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PIPE_INTERRUPT</span>:
			<span class="cm">/* FIXME is it urb-&gt;interval since the last xfer?</span>
<span class="cm">			 * this almost certainly polls too fast.</span>
<span class="cm">			 */</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">periodic_bytes</span><span class="p">(</span><span class="n">dum</span><span class="p">,</span> <span class="n">ep</span><span class="p">));</span>
			<span class="cm">/* FALLTHROUGH */</span>

		<span class="nl">default:</span>
<span class="nl">treat_control_like_bulk:</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">last_io</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">total</span> <span class="o">=</span> <span class="n">transfer</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* incomplete transfer? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

<span class="nl">return_urb:</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urbp</span><span class="o">-&gt;</span><span class="n">urbp_list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">urbp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">already_seen</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">setup_stage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">usb_hcd_unlink_urb_from_ep</span><span class="p">(</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span> <span class="n">urb</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">usb_hcd_giveback_urb</span><span class="p">(</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">urbp_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">);</span>
		<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">==</span> <span class="n">DUMMY_RH_RUNNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* want a 1 msec delay here */</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#define PORT_C_MASK \</span>
<span class="cp">	((USB_PORT_STAT_C_CONNECTION \</span>
<span class="cp">	| USB_PORT_STAT_C_ENABLE \</span>
<span class="cp">	| USB_PORT_STAT_C_SUSPEND \</span>
<span class="cp">	| USB_PORT_STAT_C_OVERCURRENT \</span>
<span class="cp">	| USB_PORT_STAT_C_RESET) &lt;&lt; 16)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_hub_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span>	<span class="o">*</span><span class="n">dum_hcd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">hcd_to_dummy_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HCD_HW_ACCESSIBLE</span><span class="p">(</span><span class="n">hcd</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">resuming</span> <span class="o">&amp;&amp;</span> <span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">re_timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">|=</span> <span class="p">(</span><span class="n">USB_PORT_STAT_C_SUSPEND</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_PORT_STAT_SUSPEND</span><span class="p">;</span>
		<span class="n">set_link_state</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">PORT_C_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span> <span class="s">&quot;port status 0x%08x has changes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">==</span> <span class="n">DUMMY_RH_SUSPENDED</span><span class="p">)</span>
			<span class="n">usb_hcd_resume_root_hub</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ss_hub_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hub_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="mh">0x2a</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescLength</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">wHubCharacteristics</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bNbrPorts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ss</span><span class="p">.</span><span class="n">bHubHdrDecLat</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* Worst case: 0.4 micro sec*/</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ss</span><span class="p">.</span><span class="n">DeviceRemovable</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hub_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hub_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescLength</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">wHubCharacteristics</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bNbrPorts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_hub_control</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>	<span class="o">*</span><span class="n">hcd</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">typeReq</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">wValue</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">wIndex</span><span class="p">,</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">wLength</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HCD_HW_ACCESSIBLE</span><span class="p">(</span><span class="n">hcd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">hcd_to_dummy_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">typeReq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ClearHubFeature</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ClearPortFeature</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_SUSPEND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">HCD_USB3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span>
					 <span class="s">&quot;USB_PORT_FEAT_SUSPEND req not &quot;</span>
					 <span class="s">&quot;supported for USB 3.0 roothub</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* 20msec resume signaling */</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">resuming</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">re_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
						<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_POWER</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">HCD_USB3</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_POWER</span><span class="p">)</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span>
						<span class="s">&quot;power-off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span>
							<span class="n">USB_SS_PORT_STAT_POWER</span><span class="p">)</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span>
						<span class="s">&quot;power-off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* FALLS THROUGH */</span>
		<span class="nl">default:</span>
			<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">wValue</span><span class="p">);</span>
			<span class="n">set_link_state</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetHubDescriptor</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">HCD_USB3</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">wLength</span> <span class="o">&lt;</span> <span class="n">USB_DT_SS_HUB_SIZE</span> <span class="o">||</span>
				 <span class="n">wValue</span> <span class="o">!=</span> <span class="p">(</span><span class="n">USB_DT_SS_HUB</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span>
				<span class="s">&quot;Wrong hub descriptor type for &quot;</span>
				<span class="s">&quot;USB 3.0 roothub.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">HCD_USB3</span><span class="p">)</span>
			<span class="n">ss_hub_descriptor</span><span class="p">((</span><span class="k">struct</span> <span class="n">usb_hub_descriptor</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">hub_descriptor</span><span class="p">((</span><span class="k">struct</span> <span class="n">usb_hub_descriptor</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetHubStatus</span>:
		<span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetPortStatus</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wIndex</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>

		<span class="cm">/* whoever resets or resumes must GetPortStatus to</span>
<span class="cm">		 * complete it!!</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">resuming</span> <span class="o">&amp;&amp;</span>
				<span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">re_timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">|=</span> <span class="p">(</span><span class="n">USB_PORT_STAT_C_SUSPEND</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_PORT_STAT_SUSPEND</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_RESET</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				<span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">re_timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">|=</span> <span class="p">(</span><span class="n">USB_PORT_STAT_C_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_PORT_STAT_RESET</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">pullup</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_ENABLE</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="n">HCD_USB3</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
						<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">|=</span>
						      <span class="n">USB_PORT_STAT_HIGH_SPEED</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">USB_SPEED_LOW</span>:
						<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span><span class="o">-&gt;</span>
							<span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
						<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">|=</span>
							<span class="n">USB_PORT_STAT_LOW_SPEED</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="nl">default:</span>
						<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span>
							<span class="n">USB_SPEED_FULL</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">set_link_state</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">);</span>
		<span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span><span class="p">);</span>
		<span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SetHubFeature</span>:
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SetPortFeature</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_LINK_STATE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">HCD_USB3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span>
					 <span class="s">&quot;USB_PORT_FEAT_LINK_STATE req not &quot;</span>
					 <span class="s">&quot;supported for USB 2.0 roothub</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * Since this is dummy we don&#39;t have an actual link so</span>
<span class="cm">			 * there is nothing to do for the SET_LINK_STATE cmd</span>
<span class="cm">			 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_U1_TIMEOUT</span>:
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_U2_TIMEOUT</span>:
			<span class="cm">/* TODO: add suspend/resume support! */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">HCD_USB3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span>
					 <span class="s">&quot;USB_PORT_FEAT_U1/2_TIMEOUT req not &quot;</span>
					 <span class="s">&quot;supported for USB 2.0 roothub</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_SUSPEND</span>:
			<span class="cm">/* Applicable only for USB2.0 hub */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">HCD_USB3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span>
					 <span class="s">&quot;USB_PORT_FEAT_SUSPEND req not &quot;</span>
					 <span class="s">&quot;supported for USB 3.0 roothub</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_SUSPEND</span><span class="p">;</span>

				<span class="cm">/* HNP would happen here; for now we</span>
<span class="cm">				 * assume b_bus_req is always true.</span>
<span class="cm">				 */</span>
				<span class="n">set_link_state</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DEVICE_B_HNP_ENABLE</span><span class="p">)</span>
						<span class="o">&amp;</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">devstatus</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span>
							<span class="s">&quot;no HNP yet!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_POWER</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">HCD_USB3</span><span class="p">)</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">|=</span> <span class="n">USB_SS_PORT_STAT_POWER</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_POWER</span><span class="p">;</span>
			<span class="n">set_link_state</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_BH_PORT_RESET</span>:
			<span class="cm">/* Applicable only for USB3.0 hub */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">HCD_USB3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span>
					 <span class="s">&quot;USB_PORT_FEAT_BH_PORT_RESET req not &quot;</span>
					 <span class="s">&quot;supported for USB 2.0 roothub</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* FALLS THROUGH */</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_RESET</span>:
			<span class="cm">/* if it&#39;s already enabled, disable */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">HCD_USB3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">USB_SS_PORT_STAT_POWER</span> <span class="o">|</span>
					 <span class="n">USB_PORT_STAT_CONNECTION</span> <span class="o">|</span>
					 <span class="n">USB_PORT_STAT_RESET</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">USB_PORT_STAT_ENABLE</span>
					<span class="o">|</span> <span class="n">USB_PORT_STAT_LOW_SPEED</span>
					<span class="o">|</span> <span class="n">USB_PORT_STAT_HIGH_SPEED</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * We want to reset device status. All but the</span>
<span class="cm">			 * Self powered feature</span>
<span class="cm">			 */</span>
			<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">devstatus</span> <span class="o">&amp;=</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DEVICE_SELF_POWERED</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * FIXME USB3.0: what is the correct reset signaling</span>
<span class="cm">			 * interval? Is it still 50msec as for HS?</span>
<span class="cm">			 */</span>
			<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">re_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="cm">/* FALLS THROUGH */</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">HCD_USB3</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span>
				     <span class="n">USB_SS_PORT_STAT_POWER</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">wValue</span><span class="p">);</span>
					<span class="n">set_link_state</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span>
				     <span class="n">USB_PORT_STAT_POWER</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">wValue</span><span class="p">);</span>
					<span class="n">set_link_state</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">);</span>
				<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetPortErrorCount</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">HCD_USB3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span>
				 <span class="s">&quot;GetPortErrorCount req not &quot;</span>
				 <span class="s">&quot;supported for USB 2.0 roothub</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* We&#39;ll always return 0 since this is a dummy hub */</span>
		<span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SetHubDepth</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">HCD_USB3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span>
				 <span class="s">&quot;SetHubDepth req not supported for &quot;</span>
				 <span class="s">&quot;USB 2.0 roothub</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span>
			<span class="s">&quot;hub control req%04x v%04x i%04x l%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">typeReq</span><span class="p">,</span> <span class="n">wValue</span><span class="p">,</span> <span class="n">wIndex</span><span class="p">,</span> <span class="n">wLength</span><span class="p">);</span>
<span class="nl">error:</span>
		<span class="cm">/* &quot;protocol stall&quot; on error */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">PORT_C_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">usb_hcd_poll_rh_status</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_bus_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">hcd_to_dummy_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">=</span> <span class="n">DUMMY_RH_SUSPENDED</span><span class="p">;</span>
	<span class="n">set_link_state</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">);</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_SUSPENDED</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_bus_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">hcd_to_dummy_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HCD_HW_ACCESSIBLE</span><span class="p">(</span><span class="n">hcd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">=</span> <span class="n">DUMMY_RH_RUNNING</span><span class="p">;</span>
		<span class="n">set_link_state</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">urbp_list</span><span class="p">))</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_RUNNING</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">ssize_t</span> <span class="nf">show_urb</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ep</span> <span class="o">=</span> <span class="n">usb_pipeendpoint</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
		<span class="s">&quot;urb/%p %s ep%d%s%s len %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">urb</span><span class="p">,</span>
		<span class="p">({</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_SPEED_LOW</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;ls&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_SPEED_FULL</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;fs&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;hs&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_SPEED_SUPER</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;ss&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;?&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		 <span class="p">};</span> <span class="n">s</span><span class="p">;</span> <span class="p">}),</span>
		<span class="n">ep</span><span class="p">,</span> <span class="n">ep</span> <span class="o">?</span> <span class="p">(</span><span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">({</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span> \
		<span class="k">switch</span> <span class="p">(</span><span class="n">usb_pipetype</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span> \
		<span class="k">case</span> <span class="n">PIPE_CONTROL</span>: \
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span> \
			<span class="k">break</span><span class="p">;</span> \
		<span class="k">case</span> <span class="n">PIPE_BULK</span>: \
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;-bulk&quot;</span><span class="p">;</span> \
			<span class="k">break</span><span class="p">;</span> \
		<span class="k">case</span> <span class="n">PIPE_INTERRUPT</span>: \
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;-int&quot;</span><span class="p">;</span> \
			<span class="k">break</span><span class="p">;</span> \
		<span class="nl">default:</span> \
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;-iso&quot;</span><span class="p">;</span> \
			<span class="k">break</span><span class="p">;</span> \
		<span class="p">};</span> <span class="n">s</span><span class="p">;</span> <span class="p">}),</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_urbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>		<span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span>	<span class="o">*</span><span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">hcd_to_dummy_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">urbp</span>		<span class="o">*</span><span class="n">urbp</span><span class="p">;</span>
	<span class="kt">size_t</span>			<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">urbp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">urbp_list</span><span class="p">,</span> <span class="n">urbp_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span>		<span class="n">temp</span><span class="p">;</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">show_urb</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span> <span class="n">urbp</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">urbs</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_urbs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_start_ss</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">dummy_timer</span><span class="p">;</span>
	<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dum_hcd</span><span class="p">;</span>
	<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">=</span> <span class="n">DUMMY_RH_RUNNING</span><span class="p">;</span>
	<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">stream_en_ep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">urbp_list</span><span class="p">);</span>
	<span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">power_budget</span> <span class="o">=</span> <span class="n">POWER_BUDGET</span><span class="p">;</span>
	<span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_RUNNING</span><span class="p">;</span>
	<span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">uses_new_polling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_USB_OTG</span>
	<span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">otg_port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* FIXME &#39;urbs&#39; should be a per-device thing, maybe in usbcore */</span>
	<span class="k">return</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev_attr_urbs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span>	<span class="o">*</span><span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">hcd_to_dummy_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * MASTER side init ... we emulate a root hub that&#39;ll only ever</span>
<span class="cm">	 * talk to one device (the slave side).  Also appears in sysfs,</span>
<span class="cm">	 * just like more familiar pci-based HCDs.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_hcd_is_primary_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">dummy_start_ss</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">dummy_timer</span><span class="p">;</span>
	<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dum_hcd</span><span class="p">;</span>
	<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">=</span> <span class="n">DUMMY_RH_RUNNING</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">urbp_list</span><span class="p">);</span>

	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">power_budget</span> <span class="o">=</span> <span class="n">POWER_BUDGET</span><span class="p">;</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_RUNNING</span><span class="p">;</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">uses_new_polling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_USB_OTG</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">otg_port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* FIXME &#39;urbs&#39; should be a per-device thing, maybe in usbcore */</span>
	<span class="k">return</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev_attr_urbs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dummy_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy</span>		<span class="o">*</span><span class="n">dum</span><span class="p">;</span>

	<span class="n">dum</span> <span class="o">=</span> <span class="n">hcd_to_dummy_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dum</span><span class="p">;</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">hcd_to_dummy_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">)),</span> <span class="o">&amp;</span><span class="n">dev_attr_urbs</span><span class="p">);</span>
	<span class="n">usb_gadget_unregister_driver</span><span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">hcd_to_dummy_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">)),</span> <span class="s">&quot;stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_h_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dummy_g_get_frame</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_hcd_is_primary_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">the_controller</span><span class="p">.</span><span class="n">hs_hcd</span> <span class="o">=</span> <span class="n">hcd_to_dummy_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
		<span class="n">the_controller</span><span class="p">.</span><span class="n">hs_hcd</span><span class="o">-&gt;</span><span class="n">dum</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">the_controller</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Mark the first roothub as being USB 2.0.</span>
<span class="cm">		 * The USB 3.0 roothub will be registered later by</span>
<span class="cm">		 * dummy_hcd_probe()</span>
<span class="cm">		 */</span>
		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">HCD_USB2</span><span class="p">;</span>
		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">the_controller</span><span class="p">.</span><span class="n">ss_hcd</span> <span class="o">=</span> <span class="n">hcd_to_dummy_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
		<span class="n">the_controller</span><span class="p">.</span><span class="n">ss_hcd</span><span class="o">-&gt;</span><span class="n">dum</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">the_controller</span><span class="p">;</span>
		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">HCD_USB3</span><span class="p">;</span>
		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_SUPER</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Change a group of bulk endpoints to support multiple stream IDs */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_alloc_streams</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">**</span><span class="n">eps</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_eps</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_streams</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">mem_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">hcd_to_dummy_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_stream</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret_streams</span> <span class="o">=</span> <span class="n">num_streams</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_eps</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_eps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">dummy_get_ep_idx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">stream_en_ep</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret_streams</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">max_stream</span> <span class="o">=</span> <span class="n">usb_ss_max_streams</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ss_ep_comp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_stream</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret_streams</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_stream</span> <span class="o">&lt;</span> <span class="n">ret_streams</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dummy_dev</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">),</span> <span class="s">&quot;Ep 0x%x only supports %u &quot;</span>
					<span class="s">&quot;stream IDs.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">eps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">,</span>
					<span class="n">max_stream</span><span class="p">);</span>
			<span class="n">ret_streams</span> <span class="o">=</span> <span class="n">max_stream</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_eps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">dummy_get_ep_idx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">stream_en_ep</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">;</span>
		<span class="n">set_max_streams_for_pipe</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">,</span>
				<span class="n">usb_endpoint_num</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">),</span> <span class="n">ret_streams</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_streams</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Reverts a group of bulk endpoints back to not using stream IDs. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_free_streams</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">**</span><span class="n">eps</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_eps</span><span class="p">,</span>
	<span class="n">gfp_t</span> <span class="n">mem_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span> <span class="o">*</span><span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">hcd_to_dummy_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_eps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">dummy_get_ep_idx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">stream_en_ep</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_eps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">dummy_get_ep_idx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">stream_en_ep</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">set_max_streams_for_pipe</span><span class="p">(</span><span class="n">dum_hcd</span><span class="p">,</span>
				<span class="n">usb_endpoint_num</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hc_driver</span> <span class="n">dummy_hcd</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span>		<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">driver_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">product_desc</span> <span class="o">=</span>		<span class="s">&quot;Dummy host controller&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hcd_priv_size</span> <span class="o">=</span>	<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dummy_hcd</span><span class="p">),</span>

	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span>		<span class="n">HCD_USB3</span> <span class="o">|</span> <span class="n">HCD_SHARED</span><span class="p">,</span>

	<span class="p">.</span><span class="n">reset</span> <span class="o">=</span>		<span class="n">dummy_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span>		<span class="n">dummy_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span>			<span class="n">dummy_stop</span><span class="p">,</span>

	<span class="p">.</span><span class="n">urb_enqueue</span> <span class="o">=</span>		<span class="n">dummy_urb_enqueue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">urb_dequeue</span> <span class="o">=</span>		<span class="n">dummy_urb_dequeue</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_frame_number</span> <span class="o">=</span>	<span class="n">dummy_h_get_frame</span><span class="p">,</span>

	<span class="p">.</span><span class="n">hub_status_data</span> <span class="o">=</span>	<span class="n">dummy_hub_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hub_control</span> <span class="o">=</span>		<span class="n">dummy_hub_control</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_suspend</span> <span class="o">=</span>		<span class="n">dummy_bus_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_resume</span> <span class="o">=</span>		<span class="n">dummy_bus_resume</span><span class="p">,</span>

	<span class="p">.</span><span class="n">alloc_streams</span> <span class="o">=</span>	<span class="n">dummy_alloc_streams</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_streams</span> <span class="o">=</span>		<span class="n">dummy_free_streams</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_hcd_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>		<span class="o">*</span><span class="n">hs_hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>		<span class="o">*</span><span class="n">ss_hcd</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s, driver &quot;</span> <span class="n">DRIVER_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_desc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mod_data</span><span class="p">.</span><span class="n">is_super_speed</span><span class="p">)</span>
		<span class="n">dummy_hcd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">HCD_USB2</span><span class="p">;</span>
	<span class="n">hs_hcd</span> <span class="o">=</span> <span class="n">usb_create_hcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dummy_hcd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hs_hcd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">hs_hcd</span><span class="o">-&gt;</span><span class="n">has_tt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_add_hcd</span><span class="p">(</span><span class="n">hs_hcd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">hs_hcd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mod_data</span><span class="p">.</span><span class="n">is_super_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ss_hcd</span> <span class="o">=</span> <span class="n">usb_create_shared_hcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dummy_hcd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">hs_hcd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ss_hcd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dealloc_usb2_hcd</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_add_hcd</span><span class="p">(</span><span class="n">ss_hcd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">put_usb3_hcd</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">put_usb3_hcd:</span>
	<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">ss_hcd</span><span class="p">);</span>
<span class="nl">dealloc_usb2_hcd:</span>
	<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">hs_hcd</span><span class="p">);</span>
	<span class="n">the_controller</span><span class="p">.</span><span class="n">hs_hcd</span> <span class="o">=</span> <span class="n">the_controller</span><span class="p">.</span><span class="n">ss_hcd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_hcd_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dummy</span>		<span class="o">*</span><span class="n">dum</span><span class="p">;</span>

	<span class="n">dum</span> <span class="o">=</span> <span class="n">hcd_to_dummy_hcd</span><span class="p">(</span><span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">dum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">ss_hcd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_remove_hcd</span><span class="p">(</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">ss_hcd</span><span class="p">));</span>
		<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">ss_hcd</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">usb_remove_hcd</span><span class="p">(</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">hs_hcd</span><span class="p">));</span>
	<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">dummy_hcd_to_hcd</span><span class="p">(</span><span class="n">dum</span><span class="o">-&gt;</span><span class="n">hs_hcd</span><span class="p">));</span>

	<span class="n">the_controller</span><span class="p">.</span><span class="n">hs_hcd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">the_controller</span><span class="p">.</span><span class="n">ss_hcd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_hcd_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>		<span class="o">*</span><span class="n">hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dummy_hcd</span>	<span class="o">*</span><span class="n">dum_hcd</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">hcd</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">dum_hcd</span> <span class="o">=</span> <span class="n">hcd_to_dummy_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dum_hcd</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">==</span> <span class="n">DUMMY_RH_RUNNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Root hub isn&#39;t suspended!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCD_FLAG_HW_ACCESSIBLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy_hcd_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>		<span class="o">*</span><span class="n">hcd</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">hcd</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">HCD_FLAG_HW_ACCESSIBLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">usb_hcd_poll_rh_status</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">dummy_hcd_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">dummy_hcd_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">dummy_hcd_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">dummy_hcd_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">dummy_hcd_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">driver_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">the_udc_pdev</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">the_hcd_pdev</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_disabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mod_data</span><span class="p">.</span><span class="n">is_high_speed</span> <span class="o">&amp;&amp;</span> <span class="n">mod_data</span><span class="p">.</span><span class="n">is_super_speed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">the_hcd_pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="n">driver_name</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">the_hcd_pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">the_udc_pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="n">gadget_name</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">the_udc_pdev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_alloc_udc</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dummy_hcd_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_register_hcd_driver</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dummy_udc_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_register_udc_driver</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">the_hcd_pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_add_hcd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">the_controller</span><span class="p">.</span><span class="n">hs_hcd</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">the_controller</span><span class="p">.</span><span class="n">ss_hcd</span> <span class="o">&amp;&amp;</span> <span class="n">mod_data</span><span class="p">.</span><span class="n">is_super_speed</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The hcd was added successfully but its probe function failed</span>
<span class="cm">		 * for some reason.</span>
<span class="cm">		 */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_add_udc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">the_udc_pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_add_udc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">the_udc_pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The udc was added successfully but its probe function failed</span>
<span class="cm">		 * for some reason.</span>
<span class="cm">		 */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_probe_udc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="nl">err_probe_udc:</span>
	<span class="n">platform_device_del</span><span class="p">(</span><span class="n">the_udc_pdev</span><span class="p">);</span>
<span class="nl">err_add_udc:</span>
	<span class="n">platform_device_del</span><span class="p">(</span><span class="n">the_hcd_pdev</span><span class="p">);</span>
<span class="nl">err_add_hcd:</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dummy_udc_driver</span><span class="p">);</span>
<span class="nl">err_register_udc_driver:</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dummy_hcd_driver</span><span class="p">);</span>
<span class="nl">err_register_hcd_driver:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">the_udc_pdev</span><span class="p">);</span>
<span class="nl">err_alloc_udc:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">the_hcd_pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">the_udc_pdev</span><span class="p">);</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">the_hcd_pdev</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dummy_udc_driver</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dummy_hcd_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
