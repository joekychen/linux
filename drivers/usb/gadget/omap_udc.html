<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › gadget › omap_udc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>omap_udc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * omap_udc.c -- for OMAP full speed udc; most chips support OTG.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004 Texas Instruments, Inc.</span>
<span class="cm"> * Copyright (C) 2004-2005 David Brownell</span>
<span class="cm"> *</span>
<span class="cm"> * OMAP2 &amp; DMA support by Kyungmin Park &lt;kyungmin.park@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#undef	DEBUG</span>
<span class="cp">#undef	VERBOSE</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>
<span class="cp">#include &lt;linux/usb/otg.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>

<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &lt;asm/mach-types.h&gt;</span>

<span class="cp">#include &lt;plat/dma.h&gt;</span>
<span class="cp">#include &lt;plat/usb.h&gt;</span>

<span class="cp">#include &quot;omap_udc.h&quot;</span>

<span class="cp">#undef	USB_TRACE</span>

<span class="cm">/* bulk DMA seems to be behaving for both IN and OUT */</span>
<span class="cp">#define	USE_DMA</span>

<span class="cm">/* ISO too */</span>
<span class="cp">#define	USE_ISO</span>

<span class="cp">#define	DRIVER_DESC	&quot;OMAP UDC driver&quot;</span>
<span class="cp">#define	DRIVER_VERSION	&quot;4 October 2004&quot;</span>

<span class="cp">#define	DMA_ADDR_INVALID	(~(dma_addr_t)0)</span>

<span class="cp">#define OMAP2_DMA_CH(ch)	(((ch) - 1) &lt;&lt; 1)</span>
<span class="cp">#define OMAP24XX_DMA(name, ch)	(OMAP24XX_DMA_##name + OMAP2_DMA_CH(ch))</span>

<span class="cm">/*</span>
<span class="cm"> * The OMAP UDC needs _very_ early endpoint setup:  before enabling the</span>
<span class="cm"> * D+ pullup to allow enumeration.  That&#39;s too early for the gadget</span>
<span class="cm"> * framework to use from usb_endpoint_enable(), which happens after</span>
<span class="cm"> * enumeration as part of activating an interface.  (But if we add an</span>
<span class="cm"> * optional new &quot;UDC not yet running&quot; state to the gadget driver model,</span>
<span class="cm"> * even just during driver binding, the endpoint autoconfig logic is the</span>
<span class="cm"> * natural spot to manufacture new endpoints.)</span>
<span class="cm"> *</span>
<span class="cm"> * So instead of using endpoint enable calls to control the hardware setup,</span>
<span class="cm"> * this driver defines a &quot;fifo mode&quot; parameter.  It&#39;s used during driver</span>
<span class="cm"> * initialization to choose among a set of pre-defined endpoint configs.</span>
<span class="cm"> * See omap_udc_setup() for available modes, or to add others.  That code</span>
<span class="cm"> * lives in an init section, so use this driver as a module if you need</span>
<span class="cm"> * to change the fifo mode after the kernel boots.</span>
<span class="cm"> *</span>
<span class="cm"> * Gadget drivers normally ignore endpoints they don&#39;t care about, and</span>
<span class="cm"> * won&#39;t include them in configuration descriptors.  That means only</span>
<span class="cm"> * misbehaving hosts would even notice they exist.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef	USE_ISO</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">fifo_mode</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">fifo_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/* &quot;modprobe omap_udc fifo_mode=42&quot;, or else as a kernel</span>
<span class="cm"> * boot parameter &quot;omap_udc:fifo_mode=42&quot;</span>
<span class="cm"> */</span>
<span class="n">module_param</span> <span class="p">(</span><span class="n">fifo_mode</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span> <span class="p">(</span><span class="n">fifo_mode</span><span class="p">,</span> <span class="s">&quot;endpoint configuration&quot;</span><span class="p">);</span>

<span class="cp">#ifdef	USE_DMA</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">use_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/* &quot;modprobe omap_udc use_dma=y&quot;, or else as a kernel</span>
<span class="cm"> * boot parameter &quot;omap_udc:use_dma=y&quot;</span>
<span class="cm"> */</span>
<span class="n">module_param</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">,</span> <span class="s">&quot;enable/disable DMA&quot;</span><span class="p">);</span>
<span class="cp">#else	</span><span class="cm">/* !USE_DMA */</span><span class="cp"></span>

<span class="cm">/* save a bit of code */</span>
<span class="cp">#define	use_dma		0</span>
<span class="cp">#endif	</span><span class="cm">/* !USE_DMA */</span><span class="cp"></span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_name</span> <span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;omap_udc&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_desc</span> <span class="p">[]</span> <span class="o">=</span> <span class="n">DRIVER_DESC</span><span class="p">;</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* there&#39;s a notion of &quot;current endpoint&quot; for modifying endpoint</span>
<span class="cm"> * state, and PIO access to its FIFO.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">use_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">u16</span> <span class="n">select</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">num</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
		<span class="n">num</span> <span class="o">|=</span> <span class="n">UDC_EP_DIR</span><span class="p">;</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">num</span> <span class="o">|</span> <span class="n">select</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
	<span class="cm">/* when select, MUST deselect later !! */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">deselect_ep</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_EP_NUM</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UDC_EP_SEL</span><span class="p">;</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
	<span class="cm">/* 6 wait states before TX will happen */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">dma_channel_claim</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">preferred</span><span class="p">);</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_ep_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_udc</span>	<span class="o">*</span><span class="n">udc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">maxp</span><span class="p">;</span>

	<span class="cm">/* catch various bogus parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span>
			<span class="o">||</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">!=</span> <span class="n">USB_DT_ENDPOINT</span>
			<span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">!=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span>
			<span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">&lt;</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s, bad ep or descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">maxp</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>
				<span class="o">&amp;&amp;</span> <span class="n">maxp</span> <span class="o">!=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">)</span>
			<span class="o">||</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s, bad %s maxpacket</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef	USE_ISO</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>
				<span class="o">&amp;&amp;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bInterval</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* hardware wants period = 1; USB allows 2^(Interval-1) */</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s, unsupported ISO period %dms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bInterval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EDOM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s, ISO nyet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EDOM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* xfer types must match, except that interrupt ~= bulk */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">!=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span>
			<span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">!=</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>
			<span class="o">&amp;&amp;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">!=</span> <span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s, %s type mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s, bogus device state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">maxp</span><span class="p">;</span>

	<span class="cm">/* set endpoint to initial state */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">use_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">UDC_EP_SEL</span><span class="p">);</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">clr_halt</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ackwait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">deselect_ep</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">)</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">);</span>

	<span class="cm">/* maybe assign a DMA channel to this endpoint */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">)</span>
		<span class="cm">/* FIXME ISO can dma, but prefers first channel */</span>
		<span class="n">dma_channel_claim</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* PIO OUT may RX packets */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">!=</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_dma</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_FIFO_EN</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ackwait</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">double_buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;%s enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">nuke</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_ep</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_ep_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s, %s not enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">_ep</span> <span class="o">?</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">nuke</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_HALT</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;%s disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span>
<span class="nf">omap_alloc_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_req</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">omap_free_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_req</span>	<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_req</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_req</span><span class="p">)</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">done</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>		<span class="n">stopped</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">;</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
				<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
					<span class="o">?</span> <span class="n">DMA_TO_DEVICE</span>
					<span class="o">:</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">;</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
				<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
					<span class="o">?</span> <span class="n">DMA_TO_DEVICE</span>
					<span class="o">:</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifndef	USB_TRACE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;complete %s req %p stat %d len %u/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="cm">/* don&#39;t modify queue heads during completion callback */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="n">stopped</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#define UDC_FIFO_FULL		(UDC_NON_ISO_FIFO_FULL | UDC_ISO_FIFO_FULL)</span>
<span class="cp">#define UDC_FIFO_UNWRITABLE	(UDC_EP_HALTED | UDC_FIFO_FULL)</span>

<span class="cp">#define FIFO_EMPTY	(UDC_NON_ISO_FIFO_EMPTY | UDC_ISO_FIFO_EMPTY)</span>
<span class="cp">#define FIFO_UNREADABLE (UDC_EP_HALTED | FIFO_EMPTY)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">write_packet</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>	<span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="o">*</span><span class="n">wp</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">max</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((((</span><span class="kt">int</span><span class="p">)</span><span class="n">buf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">max</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="o">*</span><span class="n">wp</span><span class="o">++</span><span class="p">,</span> <span class="n">UDC_DATA</span><span class="p">);</span>
			<span class="n">max</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">wp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">max</span><span class="o">--</span><span class="p">)</span>
		<span class="n">omap_writeb</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">,</span> <span class="n">UDC_DATA</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>FIXME change r/w fifo calling convention</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>return:  0 = still running, 1 = completed, negative = errno</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">write_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>		<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">is_last</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">ep_stat</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="cm">/* PIO-IN isn&#39;t double buffered except for iso */</span>
	<span class="n">ep_stat</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_STAT_FLG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep_stat</span> <span class="o">&amp;</span> <span class="n">UDC_FIFO_UNWRITABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">write_packet</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_FIFO_EN</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ackwait</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* last packet is often short (sometimes a zlp) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span>
		<span class="n">is_last</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span><span class="p">)</span>
		<span class="n">is_last</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">is_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* NOTE:  requests complete when all IN data is in a</span>
<span class="cm">	 * FIFO (or sometimes later, if a zlp was needed).</span>
<span class="cm">	 * Use usb_ep_fifo_status() where needed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_last</span><span class="p">)</span>
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">is_last</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">read_packet</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">avail</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>	<span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="o">*</span><span class="n">wp</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">avail</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">avail</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((((</span><span class="kt">int</span><span class="p">)</span><span class="n">buf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">avail</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">wp</span><span class="o">++</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_DATA</span><span class="p">);</span>
			<span class="n">avail</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">wp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">avail</span><span class="o">--</span><span class="p">)</span>
		<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">omap_readb</span><span class="p">(</span><span class="n">UDC_DATA</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>return:  0 = still running, 1 = queue empty, negative = errno</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">read_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>		<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">count</span><span class="p">,</span> <span class="n">avail</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">is_last</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">prefetchw</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">u16</span>	<span class="n">ep_stat</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_STAT_FLG</span><span class="p">);</span>

		<span class="n">is_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep_stat</span> <span class="o">&amp;</span> <span class="n">FIFO_EMPTY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">double_buf</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">fnf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep_stat</span> <span class="o">&amp;</span> <span class="n">UDC_EP_HALTED</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep_stat</span> <span class="o">&amp;</span> <span class="n">UDC_FIFO_FULL</span><span class="p">)</span>
			<span class="n">avail</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">;</span>
		<span class="k">else</span>  <span class="p">{</span>
			<span class="n">avail</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_RXFSTAT</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">fnf</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">double_buf</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">read_packet</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">avail</span><span class="p">);</span>

		<span class="cm">/* partial packet reads may not be errors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">is_last</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* overflowed this request?  flush extra data */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">avail</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
				<span class="n">avail</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">avail</span><span class="o">--</span><span class="p">)</span>
					<span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_DATA</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">)</span>
			<span class="n">is_last</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">is_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_last</span><span class="p">)</span>
			<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">is_last</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">dma_src_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span>	<span class="n">end</span><span class="p">;</span>

	<span class="cm">/* IN-DMA needs this on fault/cancel paths, so 15xx misreports</span>
<span class="cm">	 * the last transfer&#39;s bytecount by more than a FIFO&#39;s worth.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">end</span> <span class="o">=</span> <span class="n">omap_get_dma_src_pos</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">==</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_counter</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">end</span> <span class="o">|=</span> <span class="n">start</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xffff</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">)</span>
		<span class="n">end</span> <span class="o">+=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">dma_dest_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span>	<span class="n">end</span><span class="p">;</span>

	<span class="n">end</span> <span class="o">=</span> <span class="n">omap_get_dma_dst_pos</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">==</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_counter</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">end</span> <span class="o">|=</span> <span class="n">start</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xffff</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span>
		<span class="n">end</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">)</span>
		<span class="n">end</span> <span class="o">+=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Each USB transfer request using DMA maps to one or more DMA transfers.</span>
<span class="cm"> * When DMA completion isn&#39;t request completion, the UDC continues with</span>
<span class="cm"> * the next DMA transfer for that USB transfer.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">next_in_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>		<span class="n">txdma_ctrl</span><span class="p">,</span> <span class="n">w</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">length</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span>	<span class="n">sync_mode</span> <span class="o">=</span> <span class="n">cpu_is_omap15xx</span><span class="p">()</span>
				<span class="o">?</span> <span class="n">OMAP_DMA_SYNC_FRAME</span>
				<span class="o">:</span> <span class="n">OMAP_DMA_SYNC_ELEMENT</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">dma_trigger</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">())</span>
		<span class="n">dma_trigger</span> <span class="o">=</span> <span class="n">OMAP24XX_DMA</span><span class="p">(</span><span class="n">USB_W2FC_TX0</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span><span class="p">);</span>

	<span class="cm">/* measure length in either bytes or packets */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cpu_is_omap16xx</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="n">UDC_TXN_TSC</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">txdma_ctrl</span> <span class="o">=</span> <span class="n">UDC_TXN_EOT</span> <span class="o">|</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">omap_set_dma_transfer_params</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">,</span> <span class="n">OMAP_DMA_DATA_TYPE_S8</span><span class="p">,</span>
				<span class="n">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sync_mode</span><span class="p">,</span> <span class="n">dma_trigger</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">length</span> <span class="o">/</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">UDC_TXN_TSC</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">txdma_ctrl</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">omap_set_dma_transfer_params</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">,</span> <span class="n">OMAP_DMA_DATA_TYPE_S16</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">sync_mode</span><span class="p">,</span>
				<span class="n">dma_trigger</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">*=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">omap_set_dma_src_params</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">,</span> <span class="n">OMAP_DMA_PORT_EMIFF</span><span class="p">,</span>
		<span class="n">OMAP_DMA_AMODE_POST_INC</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">omap_start_dma</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_counter</span> <span class="o">=</span> <span class="n">omap_get_dma_src_pos</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_DMA_IRQ_EN</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">|=</span> <span class="n">UDC_TX_DONE_IE</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span><span class="p">);</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">UDC_DMA_IRQ_EN</span><span class="p">);</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_TXN_START</span> <span class="o">|</span> <span class="n">txdma_ctrl</span><span class="p">,</span> <span class="n">UDC_TXDMA</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">finish_in_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dma_bytes</span><span class="p">;</span>

		<span class="cm">/* return if this request needs to send data or zlp */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span>
				<span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">!=</span> <span class="mi">0</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">dma_src_len</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span>
							<span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">);</span>

	<span class="cm">/* tx completion */</span>
	<span class="n">omap_stop_dma</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_DMA_IRQ_EN</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UDC_TX_DONE_IE</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span><span class="p">);</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">UDC_DMA_IRQ_EN</span><span class="p">);</span>
	<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">next_out_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">packets</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_trigger</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">())</span>
		<span class="n">dma_trigger</span> <span class="o">=</span> <span class="n">OMAP24XX_DMA</span><span class="p">(</span><span class="n">USB_W2FC_RX0</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span><span class="p">);</span>

	<span class="cm">/* NOTE:  we filtered out &quot;short reads&quot; before, so we know</span>
<span class="cm">	 * the buffer has only whole numbers of packets.</span>
<span class="cm">	 * except MODE SELECT(6) sent the 24 bytes data in OMAP24XX DMA mode</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">packets</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_set_dma_transfer_params</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">,</span> <span class="n">OMAP_DMA_DATA_TYPE_S8</span><span class="p">,</span>
				<span class="n">packets</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">OMAP_DMA_SYNC_ELEMENT</span><span class="p">,</span>
				<span class="n">dma_trigger</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">=</span> <span class="n">packets</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* set up this DMA transfer, enable the fifo, start */</span>
		<span class="n">packets</span> <span class="o">/=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">;</span>
		<span class="n">packets</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">packets</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">UDC_RXN_TC</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">=</span> <span class="n">packets</span> <span class="o">*</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">;</span>
		<span class="n">omap_set_dma_transfer_params</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">,</span> <span class="n">OMAP_DMA_DATA_TYPE_S16</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">packets</span><span class="p">,</span>
				<span class="n">OMAP_DMA_SYNC_ELEMENT</span><span class="p">,</span>
				<span class="n">dma_trigger</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">omap_set_dma_dest_params</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">,</span> <span class="n">OMAP_DMA_PORT_EMIFF</span><span class="p">,</span>
		<span class="n">OMAP_DMA_AMODE_POST_INC</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_counter</span> <span class="o">=</span> <span class="n">omap_get_dma_dst_pos</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">);</span>

	<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_RXN_STOP</span> <span class="o">|</span> <span class="p">(</span><span class="n">packets</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">UDC_RXDMA</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span><span class="p">));</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_DMA_IRQ_EN</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">|=</span> <span class="n">UDC_RX_EOT_IE</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span><span class="p">);</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">UDC_DMA_IRQ_EN</span><span class="p">);</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_FIFO_EN</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>

	<span class="n">omap_start_dma</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">finish_out_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="kt">int</span> <span class="n">one</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">count</span><span class="p">,</span> <span class="n">w</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">dma_dest_len</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">+=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">one</span><span class="p">)</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">||</span> <span class="n">status</span><span class="p">)</span>
		<span class="n">omap_stop_dma</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">);</span>

	<span class="cm">/* if this wasn&#39;t short, request may need another transfer */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* rx completion */</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_DMA_IRQ_EN</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UDC_RX_EOT_IE</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span><span class="p">);</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">UDC_DMA_IRQ_EN</span><span class="p">);</span>
	<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">irq_src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>		<span class="n">dman_stat</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_DMAN_STAT</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_req</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="cm">/* IN dma: tx to host */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="n">UDC_TXN_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">16</span> <span class="o">+</span> <span class="n">UDC_DMA_TX_SRC</span><span class="p">(</span><span class="n">dman_stat</span><span class="p">)];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* can see TXN_DONE after dma abort */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">omap_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
			<span class="n">finish_in_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_TXN_DONE</span><span class="p">,</span> <span class="n">UDC_IRQ_SRC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">omap_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
			<span class="n">next_in_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* OUT dma: rx from host */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="n">UDC_RXN_EOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_DMA_RX_SRC</span><span class="p">(</span><span class="n">dman_stat</span><span class="p">)];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* can see RXN_EOT after dma abort */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">omap_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
			<span class="n">finish_out_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dman_stat</span> <span class="o">&amp;</span> <span class="n">UDC_DMA_RX_SB</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_RXN_EOT</span><span class="p">,</span> <span class="n">UDC_IRQ_SRC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">omap_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
			<span class="n">next_out_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="n">UDC_RXN_CNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_DMA_RX_SRC</span><span class="p">(</span><span class="n">dman_stat</span><span class="p">)];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* omap15xx does this unasked... */</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;%s, RX_CNT irq?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_RXN_CNT</span><span class="p">,</span> <span class="n">UDC_IRQ_SRC</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_error</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ch_status</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* if ch_status &amp; OMAP_DMA_DROP_IRQ ... */</span>
	<span class="cm">/* if ch_status &amp; OMAP1_DMA_TOUT_IRQ ... */</span>
	<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;%s dma error, lch %d status %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">lch</span><span class="p">,</span> <span class="n">ch_status</span><span class="p">);</span>

	<span class="cm">/* complete current transfer ... */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_channel_claim</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">status</span><span class="p">,</span> <span class="n">restart</span><span class="p">,</span> <span class="n">is_in</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">dma_channel</span><span class="p">;</span>

	<span class="n">is_in</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_in</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_TXDMA_CFG</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_RXDMA_CFG</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">UDC_DMA_REQ</span><span class="p">;</span>		<span class="cm">/* &quot;pulse&quot; activated */</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0f00</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">channel</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x00f0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">channel</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x000f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* preferred for ISO */</span>
			<span class="n">channel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMLINK</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">just_restart</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x0f</span> <span class="o">&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">())</span>
			<span class="n">dma_channel</span> <span class="o">=</span> <span class="n">OMAP24XX_DMA</span><span class="p">(</span><span class="n">USB_W2FC_TX0</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dma_channel</span> <span class="o">=</span> <span class="n">OMAP_DMA_USB_W2FC_TX0</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">channel</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">omap_request_dma</span><span class="p">(</span><span class="n">dma_channel</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dma_error</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">UDC_TXDMA_CFG</span><span class="p">);</span>
			<span class="cm">/* EMIFF or SDRC */</span>
			<span class="n">omap_set_dma_src_burst_mode</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">,</span>
						<span class="n">OMAP_DMA_DATA_BURST_4</span><span class="p">);</span>
			<span class="n">omap_set_dma_src_data_pack</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* TIPB */</span>
			<span class="n">omap_set_dma_dest_params</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">,</span>
				<span class="n">OMAP_DMA_PORT_TIPB</span><span class="p">,</span>
				<span class="n">OMAP_DMA_AMODE_CONSTANT</span><span class="p">,</span>
				<span class="n">UDC_DATA_DMA</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">())</span>
			<span class="n">dma_channel</span> <span class="o">=</span> <span class="n">OMAP24XX_DMA</span><span class="p">(</span><span class="n">USB_W2FC_RX0</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dma_channel</span> <span class="o">=</span> <span class="n">OMAP_DMA_USB_W2FC_RX0</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">channel</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">omap_request_dma</span><span class="p">(</span><span class="n">dma_channel</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dma_error</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">UDC_RXDMA_CFG</span><span class="p">);</span>
			<span class="cm">/* TIPB */</span>
			<span class="n">omap_set_dma_src_params</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">,</span>
				<span class="n">OMAP_DMA_PORT_TIPB</span><span class="p">,</span>
				<span class="n">OMAP_DMA_AMODE_CONSTANT</span><span class="p">,</span>
				<span class="n">UDC_DATA_DMA</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/* EMIFF or SDRC */</span>
			<span class="n">omap_set_dma_dest_burst_mode</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">,</span>
						<span class="n">OMAP_DMA_DATA_BURST_4</span><span class="p">);</span>
			<span class="n">omap_set_dma_dest_data_pack</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">omap_disable_dma_irq</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">,</span> <span class="n">OMAP_DMA_BLOCK_IRQ</span><span class="p">);</span>

		<span class="cm">/* channel type P: hw synch (fifo) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span>
			<span class="n">omap_set_dma_channel_mode</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">,</span> <span class="n">OMAP_DMA_LCH_P</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">just_restart:</span>
	<span class="cm">/* restart any queue, even if the claim failed  */</span>
	<span class="n">restart</span> <span class="o">=</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s no dma channel: %d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			<span class="n">restart</span> <span class="o">?</span> <span class="s">&quot; (restart)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s claimed %cxdma%d lch %d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">is_in</span> <span class="o">?</span> <span class="sc">&#39;t&#39;</span> <span class="o">:</span> <span class="sc">&#39;r&#39;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">,</span>
			<span class="n">restart</span> <span class="o">?</span> <span class="s">&quot; (restart)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_req</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_dma</span><span class="p">)</span>
			<span class="p">(</span><span class="n">is_in</span> <span class="o">?</span> <span class="n">next_in_dma</span> <span class="o">:</span> <span class="n">next_out_dma</span><span class="p">)(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">use_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">UDC_EP_SEL</span><span class="p">);</span>
			<span class="p">(</span><span class="n">is_in</span> <span class="o">?</span> <span class="n">write_fifo</span> <span class="o">:</span> <span class="n">read_fifo</span><span class="p">)(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="n">deselect_ep</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_in</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_FIFO_EN</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ackwait</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">double_buf</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* IN: 6 wait states before it&#39;ll tx */</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_channel_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">shift</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">u16</span>		<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x0f</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_req</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">active</span><span class="p">;</span>

	<span class="cm">/* abort any active usb transfer request */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">active</span> <span class="o">=</span> <span class="n">omap_get_dma_active_status</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s release %s %cxdma%d %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">active</span> <span class="o">?</span> <span class="s">&quot;active&quot;</span> <span class="o">:</span> <span class="s">&quot;idle&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;t&#39;</span> <span class="o">:</span> <span class="sc">&#39;r&#39;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="cm">/* NOTE: re-setting RX_REQ/TX_REQ because of a chip bug (before</span>
<span class="cm">	 * OMAP 1710 ES2.0) where reading the DMA_CFG can clear them.</span>
<span class="cm">	 */</span>

	<span class="cm">/* wait till current packet DMA finishes, and fifo empties */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_writew</span><span class="p">((</span><span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_TXDMA_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">UDC_DMA_REQ</span><span class="p">,</span>
					<span class="n">UDC_TXDMA_CFG</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">finish_in_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>

			<span class="cm">/* clear FIFO; hosts probably won&#39;t empty it */</span>
			<span class="n">use_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">UDC_EP_SEL</span><span class="p">);</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_CLR_EP</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
			<span class="n">deselect_ep</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_TXDMA_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">omap_writew</span><span class="p">((</span><span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_RXDMA_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">UDC_DMA_REQ</span><span class="p">,</span>
					<span class="n">UDC_RXDMA_CFG</span><span class="p">);</span>

		<span class="cm">/* dma empties the fifo */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_RXDMA_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span>
			<span class="n">finish_out_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">omap_free_dma</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* has_dma still set, till endpoint is fully quiesced */</span>
<span class="p">}</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">omap_ep_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_req</span>	<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_req</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_udc</span>	<span class="o">*</span><span class="n">udc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">is_iso</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* catch various bogus parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_req</span> <span class="o">||</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span> <span class="o">||</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s, bad params</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s, bad ep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
		<span class="n">is_iso</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* this isn&#39;t bogus, but OMAP DMA isn&#39;t the only hardware to</span>
<span class="cm">	 * have a hard time with partial packet reads...  reject it.</span>
<span class="cm">	 * Except OMAP2 can handle the small packets.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span>
			<span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_dma</span>
			<span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">!=</span> <span class="mi">0</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cpu_class_is_omap2</span><span class="p">()</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s, no partial packet OUT reads</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">==</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
				<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
					<span class="o">?</span> <span class="n">DMA_TO_DEVICE</span>
					<span class="o">:</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dma_sync_single_for_device</span><span class="p">(</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
				<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
					<span class="o">?</span> <span class="n">DMA_TO_DEVICE</span>
					<span class="o">:</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;%s queue req %p, len %d buf %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_req</span><span class="p">,</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* maybe kickstart non-iso i/o queues */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_iso</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>

		<span class="n">w</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_IRQ_EN</span><span class="p">);</span>
		<span class="n">w</span> <span class="o">|=</span> <span class="n">UDC_SOF_IE</span><span class="p">;</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">UDC_IRQ_EN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ackwait</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">is_in</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_pending</span> <span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EL2HLT</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* empty DATA stage? */</span>
			<span class="n">is_in</span> <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_in</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* chip became CONFIGURED or ADDRESSED</span>
<span class="cm">				 * earlier; drivers may already have queued</span>
<span class="cm">				 * requests to non-control endpoints</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_set_config</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u16</span>	<span class="n">irq_en</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_IRQ_EN</span><span class="p">);</span>

					<span class="n">irq_en</span> <span class="o">|=</span> <span class="n">UDC_DS_CHG_IE</span> <span class="o">|</span> <span class="n">UDC_EP0_IE</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_reset_config</span><span class="p">)</span>
						<span class="n">irq_en</span> <span class="o">|=</span> <span class="n">UDC_EPN_RX_IE</span>
							<span class="o">|</span> <span class="n">UDC_EPN_TX_IE</span><span class="p">;</span>
					<span class="n">omap_writew</span><span class="p">(</span><span class="n">irq_en</span><span class="p">,</span> <span class="n">UDC_IRQ_EN</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="cm">/* STATUS for zero length DATA stages is</span>
<span class="cm">				 * always an IN ... even for IN transfers,</span>
<span class="cm">				 * a weird case which seem to stall OMAP.</span>
<span class="cm">				 */</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP_SEL</span> <span class="o">|</span> <span class="n">UDC_EP_DIR</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_CLR_EP</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_FIFO_EN</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP_DIR</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>

				<span class="cm">/* cleanup */</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="cm">/* non-empty DATA stage */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_in</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP_SEL</span> <span class="o">|</span> <span class="n">UDC_EP_DIR</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_setup</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">irq_wait</span><span class="p">;</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP_SEL</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">is_in</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_dma</span><span class="p">)</span>
				<span class="n">use_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">UDC_EP_SEL</span><span class="p">);</span>
			<span class="cm">/* if ISO: SOF IRQs must be enabled/disabled! */</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_dma</span><span class="p">)</span>
			<span class="p">(</span><span class="n">is_in</span> <span class="o">?</span> <span class="n">next_in_dma</span> <span class="o">:</span> <span class="n">next_out_dma</span><span class="p">)(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">is_in</span> <span class="o">?</span> <span class="n">write_fifo</span> <span class="o">:</span> <span class="n">read_fifo</span><span class="p">)(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">deselect_ep</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_in</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_FIFO_EN</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ackwait</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">double_buf</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* IN: 6 wait states before it&#39;ll tx */</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">irq_wait:</span>
	<span class="cm">/* irq handler advances the queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_ep_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_req</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* make sure it&#39;s actually queued on this endpoint */</span>
	<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">==</span> <span class="n">_req</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">!=</span> <span class="n">_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span><span class="p">;</span>

		<span class="cm">/* releasing the channel cancels the request,</span>
<span class="cm">		 * reclaiming the channel restarts the queue</span>
<span class="cm">		 */</span>
		<span class="n">dma_channel_release</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">dma_channel_claim</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_ep_set_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* just use protocol stalls for ep0; real halts are annoying */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_pending</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_set_config</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARNING</span><span class="p">(</span><span class="s">&quot;error changing config?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_CLR_CFG</span><span class="p">,</span> <span class="n">UDC_SYSCON2</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_STALL_CMD</span><span class="p">,</span> <span class="n">UDC_SYSCON2</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="cm">/* NOP */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* otherwise, all active non-ISO endpoints can halt */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">!=</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* IN endpoints must already be idle */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span>	<span class="n">channel</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span>
					<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">channel</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span><span class="p">;</span>
				<span class="n">dma_channel_release</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">use_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">UDC_EP_SEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_STAT_FLG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UDC_NON_ISO_FIFO_EMPTY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_HALT</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="n">deselect_ep</span><span class="p">();</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span>
				<span class="n">dma_channel_claim</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">use_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">clr_halt</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ackwait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_FIFO_EN</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ackwait</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">double_buf</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;%s %s halt stat %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		<span class="n">value</span> <span class="o">?</span> <span class="s">&quot;set&quot;</span> <span class="o">:</span> <span class="s">&quot;clear&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">omap_ep_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">omap_ep_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">omap_ep_disable</span><span class="p">,</span>

	<span class="p">.</span><span class="n">alloc_request</span>	<span class="o">=</span> <span class="n">omap_alloc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_request</span>	<span class="o">=</span> <span class="n">omap_free_request</span><span class="p">,</span>

	<span class="p">.</span><span class="n">queue</span>		<span class="o">=</span> <span class="n">omap_ep_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue</span>	<span class="o">=</span> <span class="n">omap_ep_dequeue</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_halt</span>	<span class="o">=</span> <span class="n">omap_ep_set_halt</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>fifo<em>status ... report bytes in fifo
fifo</em>flush ... flush fifo</p></td><td class="code"><div class="highlight"><pre><span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">sof</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_SOF</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">sof</span> <span class="o">&amp;</span> <span class="n">UDC_TS_OK</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">sof</span> <span class="o">&amp;</span> <span class="n">UDC_TS</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="n">EL2NSYNC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_udc</span>	<span class="o">*</span><span class="n">udc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_udc</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">devstat</span> <span class="o">&amp;</span> <span class="n">UDC_SUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* NOTE:  OTG spec erratum says that OTG devices may</span>
<span class="cm">		 * issue wakeups without host enable.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">devstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UDC_B_HNP_ENABLE</span><span class="o">|</span><span class="n">UDC_R_WK_OK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;remote wakeup...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_RMT_WKP</span><span class="p">,</span> <span class="n">UDC_SYSCON2</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/* NOTE:  non-OTG systems may use SRP TOO... */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">devstat</span> <span class="o">&amp;</span> <span class="n">UDC_ATT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">otg_start_srp</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="o">-&gt;</span><span class="n">otg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">omap_set_selfpowered</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_selfpowered</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_udc</span>	<span class="o">*</span><span class="n">udc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">syscon1</span><span class="p">;</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_udc</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">syscon1</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_SYSCON1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_selfpowered</span><span class="p">)</span>
		<span class="n">syscon1</span> <span class="o">|=</span> <span class="n">UDC_SELF_PWR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">syscon1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UDC_SELF_PWR</span><span class="p">;</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">syscon1</span><span class="p">,</span> <span class="n">UDC_SYSCON1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">can_pullup</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">softconnect</span> <span class="o">&amp;&amp;</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus_active</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pullup_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_SYSCON1</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">|=</span> <span class="n">UDC_PULLUP_EN</span><span class="p">;</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">UDC_SYSCON1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gadget_is_otg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

		<span class="n">l</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="n">OTG_BSESSVLD</span><span class="p">;</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_DS_CHG_IE</span><span class="p">,</span> <span class="n">UDC_IRQ_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pullup_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gadget_is_otg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

		<span class="n">l</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OTG_BSESSVLD</span><span class="p">;</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_DS_CHG_IE</span><span class="p">,</span> <span class="n">UDC_IRQ_EN</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_SYSCON1</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UDC_PULLUP_EN</span><span class="p">;</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">UDC_SYSCON1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">omap_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_udc_enable_clock</span><span class="p">(</span><span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">dc_clk</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">hhc_clk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dc_clk</span><span class="p">);</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">hhc_clk</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">hhc_clk</span><span class="p">);</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dc_clk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by whatever detects VBUS sessions:  external transceiver</span>
<span class="cm"> * driver, or maybe GPIO0 VBUS IRQ.  May request 48 MHz clock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_vbus_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_udc</span>	<span class="o">*</span><span class="n">udc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_udc</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;VBUS %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">is_active</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus_active</span> <span class="o">=</span> <span class="p">(</span><span class="n">is_active</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="cm">/* &quot;software&quot; detect, ignored if !VBUS_MODE_1510 */</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">FUNC_MUX_CTRL_0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_active</span><span class="p">)</span>
			<span class="n">l</span> <span class="o">|=</span> <span class="n">VBUS_CTRL_1510</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VBUS_CTRL_1510</span><span class="p">;</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">FUNC_MUX_CTRL_0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dc_clk</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">is_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">clk_requested</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">omap_udc_enable_clock</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">clk_requested</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">can_pullup</span><span class="p">(</span><span class="n">udc</span><span class="p">))</span>
		<span class="n">pullup_enable</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pullup_disable</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dc_clk</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">clk_requested</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">omap_udc_enable_clock</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">clk_requested</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_vbus_draw</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">mA</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_udc</span>	<span class="o">*</span><span class="n">udc</span><span class="p">;</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_udc</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">usb_phy_set_power</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">,</span> <span class="n">mA</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_pullup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_udc</span>	<span class="o">*</span><span class="n">udc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_udc</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">softconnect</span> <span class="o">=</span> <span class="p">(</span><span class="n">is_on</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">can_pullup</span><span class="p">(</span><span class="n">udc</span><span class="p">))</span>
		<span class="n">pullup_enable</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pullup_disable</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">omap_udc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bind</span><span class="p">)(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="p">));</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">omap_udc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_gadget_ops</span> <span class="n">omap_gadget_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_frame</span>		<span class="o">=</span> <span class="n">omap_get_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wakeup</span>			<span class="o">=</span> <span class="n">omap_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_selfpowered</span>	<span class="o">=</span> <span class="n">omap_set_selfpowered</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vbus_session</span>		<span class="o">=</span> <span class="n">omap_vbus_session</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vbus_draw</span>		<span class="o">=</span> <span class="n">omap_vbus_draw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pullup</span>			<span class="o">=</span> <span class="n">omap_pullup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>			<span class="o">=</span> <span class="n">omap_udc_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>			<span class="o">=</span> <span class="n">omap_udc_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* dequeue ALL requests; caller holds udc-&gt;lock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nuke</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_req</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span><span class="p">)</span>
		<span class="n">dma_channel_release</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

	<span class="n">use_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_CLR_EP</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">!=</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">)</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_HALT</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* caller holds udc-&gt;lock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_quiesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">nuke</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">)</span>
		<span class="n">nuke</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_otg</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">devstat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gadget_is_otg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OTG_ID</span><span class="p">)</span>
		<span class="n">devstat</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_DEVSTAT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">devstat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">b_hnp_enable</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">devstat</span> <span class="o">&amp;</span> <span class="n">UDC_B_HNP_ENABLE</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">a_hnp_support</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">devstat</span> <span class="o">&amp;</span> <span class="n">UDC_A_HNP_SUPPORT</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">a_alt_hnp_support</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">devstat</span> <span class="o">&amp;</span> <span class="n">UDC_A_ALT_HNP_SUPPORT</span><span class="p">);</span>

	<span class="cm">/* Enable HNP early, avoiding races on suspend irq path.</span>
<span class="cm">	 * ASSUMES OTG state machine B_BUS_REQ input is true.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">b_hnp_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

		<span class="n">l</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="n">OTG_B_HNPEN</span> <span class="o">|</span> <span class="n">OTG_B_BUSREQ</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OTG_PULLUP</span><span class="p">;</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep0_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">irq_src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_ep</span>	<span class="o">*</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">omap_req</span>	<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ep0</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Clear any pending requests and then scrub any rx/tx state</span>
<span class="cm">	 * before starting to handle the SETUP request.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="n">UDC_SETUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span>	<span class="n">ack</span> <span class="o">=</span> <span class="n">irq_src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UDC_EP0_TX</span><span class="o">|</span><span class="n">UDC_EP0_RX</span><span class="p">);</span>

		<span class="n">nuke</span><span class="p">(</span><span class="n">ep0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ack</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">ack</span><span class="p">,</span> <span class="n">UDC_IRQ_SRC</span><span class="p">);</span>
			<span class="n">irq_src</span> <span class="o">=</span> <span class="n">UDC_SETUP</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* IN/OUT packets mean we&#39;re in the DATA or STATUS stage.</span>
<span class="cm">	 * This driver uses only uses protocol stalls (ep0 never halts),</span>
<span class="cm">	 * and if we got this far the gadget driver already had a</span>
<span class="cm">	 * chance to stall.  Tries to be forgiving of host oddities.</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE:  the last chance gadget drivers have to stall control</span>
<span class="cm">	 * requests is during their request completion callback.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="cm">/* IN == TX to host */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="n">UDC_EP0_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">stat</span><span class="p">;</span>

		<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP0_TX</span><span class="p">,</span> <span class="n">UDC_IRQ_SRC</span><span class="p">);</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP_SEL</span><span class="o">|</span><span class="n">UDC_EP_DIR</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_STAT_FLG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">UDC_ACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_in</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* write next IN packet from response,</span>
<span class="cm">				 * or set up the status stage.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span>
					<span class="n">stat</span> <span class="o">=</span> <span class="n">write_fifo</span><span class="p">(</span><span class="n">ep0</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP_DIR</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_pending</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP_SEL</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
					<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_CLR_EP</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
					<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_FIFO_EN</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
					<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
					<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span> <span class="cm">/* else:  6 wait states before it&#39;ll tx */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* ack status stage of OUT transfer */</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP_DIR</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span>
					<span class="n">done</span><span class="p">(</span><span class="n">ep0</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">UDC_STALL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_CLR_HALT</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP_DIR</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP_DIR</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* OUT == RX from host */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="n">UDC_EP0_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">stat</span><span class="p">;</span>

		<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP0_RX</span><span class="p">,</span> <span class="n">UDC_IRQ_SRC</span><span class="p">);</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP_SEL</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_STAT_FLG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">UDC_ACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_in</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* read next OUT packet of request, maybe</span>
<span class="cm">				 * reactiviting the fifo; stall on errors.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span> <span class="o">||</span> <span class="p">(</span><span class="n">stat</span> <span class="o">=</span> <span class="n">read_fifo</span><span class="p">(</span><span class="n">ep0</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_STALL_CMD</span><span class="p">,</span> <span class="n">UDC_SYSCON2</span><span class="p">);</span>
					<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_FIFO_EN</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>

				<span class="cm">/* activate status stage */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">done</span><span class="p">(</span><span class="n">ep0</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="cm">/* that may have STALLed ep0... */</span>
					<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP_SEL</span> <span class="o">|</span> <span class="n">UDC_EP_DIR</span><span class="p">,</span>
							<span class="n">UDC_EP_NUM</span><span class="p">);</span>
					<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_CLR_EP</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
					<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_FIFO_EN</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
					<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP_DIR</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
					<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* ack status stage of IN transfer */</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span>
					<span class="n">done</span><span class="p">(</span><span class="n">ep0</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">UDC_STALL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_CLR_HALT</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* SETUP starts all control transfers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="n">UDC_SETUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">u</span> <span class="p">{</span>
			<span class="n">u16</span>			<span class="n">word</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">usb_ctrlrequest</span>	<span class="n">r</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
		<span class="kt">int</span>			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">omap_ep</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>

		<span class="cm">/* read the (latest) SETUP message */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SETUP_SEL</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
			<span class="cm">/* two bytes at a time */</span>
			<span class="n">u</span><span class="p">.</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_DATA</span><span class="p">);</span>
			<span class="n">u</span><span class="p">.</span><span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_DATA</span><span class="p">);</span>
			<span class="n">u</span><span class="p">.</span><span class="n">word</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_DATA</span><span class="p">);</span>
			<span class="n">u</span><span class="p">.</span><span class="n">word</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_DATA</span><span class="p">);</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_IRQ_SRC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UDC_SETUP</span><span class="p">);</span>

<span class="cp">#define	w_value		le16_to_cpu(u.r.wValue)</span>
<span class="cp">#define	w_index		le16_to_cpu(u.r.wIndex)</span>
<span class="cp">#define	w_length	le16_to_cpu(u.r.wLength)</span>

		<span class="cm">/* Delegate almost all control requests to the gadget driver,</span>
<span class="cm">		 * except for a handful of ch9 status/feature requests that</span>
<span class="cm">		 * hardware doesn&#39;t autodecode _and_ the gadget API hides.</span>
<span class="cm">		 */</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_set_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ep0</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ep0</span><span class="o">-&gt;</span><span class="n">ackwait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequest</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_REQ_SET_CONFIGURATION</span>:
			<span class="cm">/* udc needs to know when ep != 0 is valid */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">delegate</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w_length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_set_config</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_reset_config</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;set config %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w_value</span><span class="p">);</span>

			<span class="cm">/* update udc NOW since gadget driver may start</span>
<span class="cm">			 * queueing requests immediately; clear config</span>
<span class="cm">			 * later if it fails the request.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_reset_config</span><span class="p">)</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_CLR_CFG</span><span class="p">,</span> <span class="n">UDC_SYSCON2</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_DEV_CFG</span><span class="p">,</span> <span class="n">UDC_SYSCON2</span><span class="p">);</span>
			<span class="n">update_otg</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">delegate</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_REQ_CLEAR_FEATURE</span>:
			<span class="cm">/* clear endpoint halt */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="n">USB_RECIP_ENDPOINT</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">delegate</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w_value</span> <span class="o">!=</span> <span class="n">USB_ENDPOINT_HALT</span>
					<span class="o">||</span> <span class="n">w_length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">w_index</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">!=</span> <span class="n">ep0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">w_index</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
					<span class="n">ep</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>
						<span class="o">||</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>
				<span class="n">use_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">clr_halt</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ackwait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_FIFO_EN</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ackwait</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">double_buf</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* NOTE:  assumes the host behaves sanely,</span>
<span class="cm">				 * only clearing real halts.  Else we may</span>
<span class="cm">				 * need to kill pending transfers and then</span>
<span class="cm">				 * restart the queue... very messy for DMA!</span>
<span class="cm">				 */</span>
			<span class="p">}</span>
			<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;%s halt cleared by host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">ep0out_status_stage</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_REQ_SET_FEATURE</span>:
			<span class="cm">/* set endpoint halt */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="n">USB_RECIP_ENDPOINT</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">delegate</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w_value</span> <span class="o">!=</span> <span class="n">USB_ENDPOINT_HALT</span>
					<span class="o">||</span> <span class="n">w_length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">w_index</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w_index</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
				<span class="n">ep</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>
					<span class="o">||</span> <span class="n">ep</span> <span class="o">==</span> <span class="n">ep0</span> <span class="o">||</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_dma</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* this has rude side-effects (aborts) and</span>
<span class="cm">				 * can&#39;t really work if DMA-IN is active</span>
<span class="cm">				 */</span>
				<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s host set_halt, NYET </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">use_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/* can&#39;t halt if fifo isn&#39;t empty... */</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_CLR_EP</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_HALT</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
			<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;%s halted by host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="nl">ep0out_status_stage:</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP_SEL</span><span class="o">|</span><span class="n">UDC_EP_DIR</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_CLR_EP</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_FIFO_EN</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP_DIR</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_REQ_GET_STATUS</span>:
			<span class="cm">/* USB_ENDPOINT_HALT status? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="p">(</span><span class="n">USB_DIR_IN</span><span class="o">|</span><span class="n">USB_RECIP_ENDPOINT</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">intf_status</span><span class="p">;</span>

			<span class="cm">/* ep0 never stalls */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">w_index</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">zero_status</span><span class="p">;</span>

			<span class="cm">/* only active endpoints count */</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">w_index</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w_index</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
				<span class="n">ep</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>

			<span class="cm">/* iso never stalls */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">zero_status</span><span class="p">;</span>

			<span class="cm">/* FIXME don&#39;t assume non-halted endpoints!! */</span>
			<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;%s status, can&#39;t report</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>

<span class="nl">intf_status:</span>
			<span class="cm">/* return interface status.  if we were pedantic,</span>
<span class="cm">			 * we&#39;d detect non-existent interfaces, and stall.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span>
					<span class="o">!=</span> <span class="p">(</span><span class="n">USB_DIR_IN</span><span class="o">|</span><span class="n">USB_RECIP_INTERFACE</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">delegate</span><span class="p">;</span>

<span class="nl">zero_status:</span>
			<span class="cm">/* return two zero bytes */</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP_SEL</span><span class="o">|</span><span class="n">UDC_EP_DIR</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UDC_DATA</span><span class="p">);</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_FIFO_EN</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EP_DIR</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;GET_STATUS, interface %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w_index</span><span class="p">);</span>
			<span class="cm">/* next, status stage */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
<span class="nl">delegate:</span>
			<span class="cm">/* activate the ep0out fifo right away */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_in</span> <span class="o">&amp;&amp;</span> <span class="n">w_length</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_FIFO_EN</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* gadget drivers see class/vendor specific requests,</span>
<span class="cm">			 * {SET,GET}_{INTERFACE,DESCRIPTOR,CONFIGURATION},</span>
<span class="cm">			 * and more</span>
<span class="cm">			 */</span>
			<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;SETUP %02x.%02x v%04x i%04x l%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequest</span><span class="p">,</span>
				<span class="n">w_value</span><span class="p">,</span> <span class="n">w_index</span><span class="p">,</span> <span class="n">w_length</span><span class="p">);</span>

<span class="cp">#undef	w_value</span>
<span class="cp">#undef	w_index</span>
<span class="cp">#undef	w_length</span>

			<span class="cm">/* The gadget driver may return an error here,</span>
<span class="cm">			 * causing an immediate protocol stall.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Else it must issue a response, either queueing a</span>
<span class="cm">			 * response buffer for the DATA stage, or halting ep0</span>
<span class="cm">			 * (causing a protocol stall, not a real halt).  A</span>
<span class="cm">			 * zero length buffer means no DATA stage.</span>
<span class="cm">			 *</span>
<span class="cm">			 * It&#39;s fine to issue that response after the setup()</span>
<span class="cm">			 * call returns, and this IRQ was handled.</span>
<span class="cm">			 */</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_setup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_setup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">do_stall:</span>
			<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;req %02x.%02x protocol STALL; stat %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequest</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_set_config</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_reset_config</span><span class="p">)</span>
					<span class="n">WARNING</span><span class="p">(</span><span class="s">&quot;error resetting config?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_CLR_CFG</span><span class="p">,</span> <span class="n">UDC_SYSCON2</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_STALL_CMD</span><span class="p">,</span> <span class="n">UDC_SYSCON2</span><span class="p">);</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#define OTG_FLAGS (UDC_B_HNP_ENABLE|UDC_A_HNP_SUPPORT|UDC_A_ALT_HNP_SUPPORT)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">devstate_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">irq_src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">devstat</span><span class="p">,</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">devstat</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_DEVSTAT</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">devstat</span> <span class="o">^</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">devstat</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">devstat</span> <span class="o">=</span> <span class="n">devstat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">change</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UDC_USB_RESET</span><span class="o">|</span><span class="n">UDC_ATT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udc_quiesce</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">change</span> <span class="o">&amp;</span> <span class="n">UDC_ATT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* driver for any external transceiver will</span>
<span class="cm">			 * have called omap_vbus_session() already</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devstat</span> <span class="o">&amp;</span> <span class="n">UDC_ATT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
				<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;connect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span>
					<span class="n">pullup_enable</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>if (driver->connect) call it</p></td><td class="code"><div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span>
					<span class="n">pullup_disable</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
				<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;disconnect, gadget %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
					<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
					<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">change</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UDC_ATT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">change</span> <span class="o">&amp;</span> <span class="n">UDC_USB_RESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devstat</span> <span class="o">&amp;</span> <span class="n">UDC_USB_RESET</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;RESET=1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
				<span class="n">INFO</span><span class="p">(</span><span class="s">&quot;USB reset done, gadget %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
				<span class="cm">/* ep0 traffic is legal from now on */</span>
				<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_DS_CHG_IE</span> <span class="o">|</span> <span class="n">UDC_EP0_IE</span><span class="p">,</span>
						<span class="n">UDC_IRQ_EN</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">change</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UDC_USB_RESET</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span> <span class="o">&amp;</span> <span class="n">UDC_SUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>FIXME tell isp1301 to suspend/resume (?)</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">devstat</span> <span class="o">&amp;</span> <span class="n">UDC_SUS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">update_otg</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
				<span class="cm">/* HNP could be under way already */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span>
						<span class="o">&amp;&amp;</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
					<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
					<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span>
					<span class="n">usb_phy_set_suspend</span><span class="p">(</span>
							<span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span>
					<span class="n">usb_phy_set_suspend</span><span class="p">(</span>
							<span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span>
						<span class="o">&amp;&amp;</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
					<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
					<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">change</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UDC_SUS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_is_omap15xx</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">change</span> <span class="o">&amp;</span> <span class="n">OTG_FLAGS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">update_otg</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="n">change</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OTG_FLAGS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">change</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UDC_CFG</span><span class="o">|</span><span class="n">UDC_DEF</span><span class="o">|</span><span class="n">UDC_ADD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;devstat %03x, ignore change %03x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">devstat</span><span class="p">,</span>  <span class="n">change</span><span class="p">);</span>

	<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_DS_CHG</span><span class="p">,</span> <span class="n">UDC_IRQ_SRC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">omap_udc_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_udc</span>	<span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">_udc</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">irq_src</span><span class="p">;</span>
	<span class="n">irqreturn_t</span>	<span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">irq_src</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_IRQ_SRC</span><span class="p">);</span>

	<span class="cm">/* Device state change (usb ch9 stuff) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="n">UDC_DS_CHG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devstate_irq</span><span class="p">(</span><span class="n">_udc</span><span class="p">,</span> <span class="n">irq_src</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="n">irq_src</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UDC_DS_CHG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* EP0 control transfers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UDC_EP0_RX</span><span class="o">|</span><span class="n">UDC_SETUP</span><span class="o">|</span><span class="n">UDC_EP0_TX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ep0_irq</span><span class="p">(</span><span class="n">_udc</span><span class="p">,</span> <span class="n">irq_src</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="n">irq_src</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UDC_EP0_RX</span><span class="o">|</span><span class="n">UDC_SETUP</span><span class="o">|</span><span class="n">UDC_EP0_TX</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* DMA transfer completion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UDC_TXN_DONE</span><span class="o">|</span><span class="n">UDC_RXN_CNT</span><span class="o">|</span><span class="n">UDC_RXN_EOT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dma_irq</span><span class="p">(</span><span class="n">_udc</span><span class="p">,</span> <span class="n">irq_src</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="n">irq_src</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UDC_TXN_DONE</span><span class="o">|</span><span class="n">UDC_RXN_CNT</span><span class="o">|</span><span class="n">UDC_RXN_EOT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">irq_src</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UDC_IRQ_SOF</span> <span class="o">|</span> <span class="n">UDC_EPN_TX</span><span class="o">|</span><span class="n">UDC_EPN_RX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span><span class="p">)</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;udc_irq, unhandled %03x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq_src</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* workaround for seemingly-lost IRQs for RX ACKs... */</span>
<span class="cp">#define PIO_OUT_TIMEOUT	(jiffies + HZ/3)</span>
<span class="cp">#define HALF_FULL(f)	(!((f)&amp;(UDC_NON_ISO_FIFO_FULL|UDC_NON_ISO_FIFO_EMPTY)))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pio_out_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">_ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">stat_flg</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ackwait</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">use_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">UDC_EP_SEL</span><span class="p">);</span>
		<span class="n">stat_flg</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_STAT_FLG</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">stat_flg</span> <span class="o">&amp;</span> <span class="n">UDC_ACK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">stat_flg</span> <span class="o">&amp;</span> <span class="n">UDC_FIFO_EN</span><span class="p">)</span>
				<span class="o">||</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">double_buf</span> <span class="o">&amp;&amp;</span> <span class="n">HALF_FULL</span><span class="p">(</span><span class="n">stat_flg</span><span class="p">))))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">omap_req</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

			<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;%s: lose, %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">stat_flg</span><span class="p">);</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">omap_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">read_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_FIFO_EN</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ackwait</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">double_buf</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">deselect_ep</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">PIO_OUT_TIMEOUT</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">omap_udc_pio_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>		<span class="n">epn_stat</span><span class="p">,</span> <span class="n">irq_src</span><span class="p">;</span>
	<span class="n">irqreturn_t</span>	<span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">epnum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_udc</span>	<span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_req</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">epn_stat</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_EPN_STAT</span><span class="p">);</span>
	<span class="n">irq_src</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_IRQ_SRC</span><span class="p">);</span>

	<span class="cm">/* handle OUT first, to avoid some wasteful NAKs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="n">UDC_EPN_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">epnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">epn_stat</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EPN_RX</span><span class="p">,</span> <span class="n">UDC_IRQ_SRC</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">epnum</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>

		<span class="n">omap_writew</span><span class="p">(</span><span class="n">epnum</span> <span class="o">|</span> <span class="n">UDC_EP_SEL</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">fnf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_STAT_FLG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UDC_ACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ackwait</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>
				<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">omap_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
				<span class="n">stat</span> <span class="o">=</span> <span class="n">read_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">double_buf</span><span class="p">)</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">fnf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* min 6 clock delay before clearing EP_SEL ... */</span>
		<span class="n">epn_stat</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_EPN_STAT</span><span class="p">);</span>
		<span class="n">epn_stat</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_EPN_STAT</span><span class="p">);</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">epnum</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>

		<span class="cm">/* enabling fifo _after_ clearing ACK, contrary to docs,</span>
<span class="cm">		 * reduces lossage; timer still needed though (sigh).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fnf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_FIFO_EN</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ackwait</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">double_buf</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">PIO_OUT_TIMEOUT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* then IN transfers */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">&amp;</span> <span class="n">UDC_EPN_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">epnum</span> <span class="o">=</span> <span class="n">epn_stat</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_EPN_TX</span><span class="p">,</span> <span class="n">UDC_IRQ_SRC</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">16</span> <span class="o">+</span> <span class="n">epnum</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>

		<span class="n">omap_writew</span><span class="p">(</span><span class="n">epnum</span> <span class="o">|</span> <span class="n">UDC_EP_DIR</span> <span class="o">|</span> <span class="n">UDC_EP_SEL</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_STAT_FLG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UDC_ACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ackwait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">omap_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
				<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">write_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* min 6 clock delay before clearing EP_SEL ... */</span>
		<span class="n">epn_stat</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_EPN_STAT</span><span class="p">);</span>
		<span class="n">epn_stat</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_EPN_STAT</span><span class="p">);</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">epnum</span> <span class="o">|</span> <span class="n">UDC_EP_DIR</span><span class="p">,</span> <span class="n">UDC_EP_NUM</span><span class="p">);</span>
		<span class="cm">/* then 6 clocks before it&#39;d tx */</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef	USE_ISO</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">omap_udc_iso_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_udc</span>	<span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* handle all non-DMA ISO transfers */</span>
	<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">,</span> <span class="n">iso</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span>		<span class="n">stat</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">omap_req</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_dma</span> <span class="o">||</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

		<span class="n">use_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">UDC_EP_SEL</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_STAT_FLG</span><span class="p">);</span>

		<span class="cm">/* NOTE: like the other controller drivers, this isn&#39;t</span>
<span class="cm">		 * currently reporting lost or damaged frames.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">UDC_MISS_IN</span><span class="p">)</span>
				<span class="cm">/* done(ep, req, -EPROTO) */</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">write_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span>	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">UDC_NO_RXPACKET</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">UDC_ISO_ERR</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">UDC_DATA_FLUSH</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSR</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="cm">/* done(ep, req, status) */</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">read_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">deselect_ep</span><span class="p">();</span>
		<span class="cm">/* 6 wait states before next EP */</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
			<span class="n">pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>

		<span class="n">w</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_IRQ_EN</span><span class="p">);</span>
		<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UDC_SOF_IE</span><span class="p">;</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">UDC_IRQ_EN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_IRQ_SOF</span><span class="p">,</span> <span class="n">UDC_IRQ_SRC</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">machine_without_vbus_sense</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">machine_is_omap_innovator</span><span class="p">()</span>
		<span class="o">||</span> <span class="n">machine_is_omap_osk</span><span class="p">()</span>
		<span class="o">||</span> <span class="n">machine_is_omap_apollon</span><span class="p">()</span>
<span class="cp">#ifndef CONFIG_MACH_OMAP_H4_OTG</span>
		<span class="o">||</span> <span class="n">machine_is_omap_h4</span><span class="p">()</span>
<span class="cp">#endif</span>
		<span class="o">||</span> <span class="n">machine_is_sx1</span><span class="p">()</span>
		<span class="o">||</span> <span class="n">cpu_is_omap7xx</span><span class="p">()</span> <span class="cm">/* No known omap7xx boards with vbus sense */</span>
		<span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_udc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bind</span><span class="p">)(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* basic sanity tests */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>FIXME if otg, check:  driver->is_otg</p></td><td class="code"><div class="highlight"><pre>			<span class="o">||</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">max_speed</span> <span class="o">&lt;</span> <span class="n">USB_SPEED_FULL</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">bind</span> <span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reset state */</span>
	<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">use_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_SET_HALT</span><span class="p">,</span> <span class="n">UDC_CTRL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">softconnect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* hook up the driver */</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dc_clk</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">omap_udc_enable_clock</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;bind to %s --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;bound to driver %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_IRQ_SRC_MASK</span><span class="p">,</span> <span class="n">UDC_IRQ_SRC</span><span class="p">);</span>

	<span class="cm">/* connect to bus through transceiver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">otg_set_peripheral</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="o">-&gt;</span><span class="n">otg</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;can&#39;t bind to transceiver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">driver</span><span class="o">-&gt;</span><span class="n">unbind</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">can_pullup</span><span class="p">(</span><span class="n">udc</span><span class="p">))</span>
			<span class="n">pullup_enable</span> <span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pullup_disable</span> <span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* boards that don&#39;t have VBUS sensing can&#39;t autogate 48MHz;</span>
<span class="cm">	 * can&#39;t enter deep sleep while a gadget driver is active.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_without_vbus_sense</span><span class="p">())</span>
		<span class="n">omap_vbus_session</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dc_clk</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">omap_udc_enable_clock</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_udc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span> <span class="o">||</span> <span class="n">driver</span> <span class="o">!=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dc_clk</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">omap_udc_enable_clock</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">machine_without_vbus_sense</span><span class="p">())</span>
		<span class="n">omap_vbus_session</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">otg_set_peripheral</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="o">-&gt;</span><span class="n">otg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pullup_disable</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">udc_quiesce</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dc_clk</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">omap_udc_enable_clock</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;unregistered driver &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#ifdef CONFIG_USB_GADGET_DEBUG_FILES</span>

<span class="cp">#include &lt;linux/seq_file.h&gt;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">proc_filename</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;driver/udc&quot;</span><span class="p">;</span>

<span class="cp">#define FOURBITS &quot;%s%s%s%s&quot;</span>
<span class="cp">#define EIGHTBITS FOURBITS FOURBITS</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">proc_ep_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>		<span class="n">stat_flg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_req</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>

	<span class="n">use_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">has_dma</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="s">&quot;(%cxdma%d lch%d) &quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;t&#39;</span> <span class="o">:</span> <span class="sc">&#39;r&#39;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">stat_flg</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_STAT_FLG</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
		<span class="s">&quot;</span><span class="se">\n</span><span class="s">%s %s%s%sirqs %ld stat %04x &quot;</span> <span class="n">EIGHTBITS</span> <span class="n">FOURBITS</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">double_buf</span> <span class="o">?</span> <span class="s">&quot;dbuf &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">({</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span> <span class="k">switch</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ackwait</span><span class="p">){</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;(ackw) &quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;(ackw2) &quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;(?) &quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">s</span><span class="p">;}),</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">,</span> <span class="n">stat_flg</span><span class="p">,</span>
		<span class="p">(</span><span class="n">stat_flg</span> <span class="o">&amp;</span> <span class="n">UDC_NO_RXPACKET</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;no_rxpacket &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">stat_flg</span> <span class="o">&amp;</span> <span class="n">UDC_MISS_IN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;miss_in &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">stat_flg</span> <span class="o">&amp;</span> <span class="n">UDC_DATA_FLUSH</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;data_flush &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">stat_flg</span> <span class="o">&amp;</span> <span class="n">UDC_ISO_ERR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;iso_err &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">stat_flg</span> <span class="o">&amp;</span> <span class="n">UDC_ISO_FIFO_EMPTY</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;iso_fifo_empty &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">stat_flg</span> <span class="o">&amp;</span> <span class="n">UDC_ISO_FIFO_FULL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;iso_fifo_full &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">stat_flg</span> <span class="o">&amp;</span> <span class="n">UDC_EP_HALTED</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;HALT &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">stat_flg</span> <span class="o">&amp;</span> <span class="n">UDC_STALL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;STALL &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">stat_flg</span> <span class="o">&amp;</span> <span class="n">UDC_NAK</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;NAK &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">stat_flg</span> <span class="o">&amp;</span> <span class="n">UDC_ACK</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ACK &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">stat_flg</span> <span class="o">&amp;</span> <span class="n">UDC_FIFO_EN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;fifo_en &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">stat_flg</span> <span class="o">&amp;</span> <span class="n">UDC_NON_ISO_FIFO_EMPTY</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;fifo_empty &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">stat_flg</span> <span class="o">&amp;</span> <span class="n">UDC_NON_ISO_FIFO_FULL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;fifo_full &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">(queue empty)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span>	<span class="n">length</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">length</span> <span class="o">+=</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
						<span class="o">?</span> <span class="n">dma_src_len</span> <span class="o">:</span> <span class="n">dma_dest_len</span><span class="p">)</span>
					<span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">+</span> <span class="n">length</span><span class="p">);</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">req %p len %d/%d buf %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">trx_mode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="k">return</span> <span class="n">enabled</span> <span class="o">?</span> <span class="s">&quot;*6wire&quot;</span> <span class="o">:</span> <span class="s">&quot;unused&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:		<span class="k">return</span> <span class="s">&quot;4wire&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:		<span class="k">return</span> <span class="s">&quot;3wire&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:		<span class="k">return</span> <span class="s">&quot;6wire&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_otg_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>		<span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">trans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">ctrl_name</span> <span class="o">=</span> <span class="s">&quot;(UNKNOWN)&quot;</span><span class="p">;</span>

	<span class="cm">/* XXX This needs major revision for OMAP2+ */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_REV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">ctrl_name</span> <span class="o">=</span> <span class="s">&quot;tranceiver_ctrl&quot;</span><span class="p">;</span>
		<span class="n">trans</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">USB_TRANSCEIVER_CTRL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">OTG rev %d.%d, %s %05x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">ctrl_name</span><span class="p">,</span> <span class="n">trans</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">OTG_SYSCON_1</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;otg_syscon1 %08x usb2 %s, usb1 %s, usb0 %s,&quot;</span>
			<span class="n">FOURBITS</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
		<span class="n">trx_mode</span><span class="p">(</span><span class="n">USB2_TRX_MODE</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">trans</span> <span class="o">&amp;</span> <span class="n">CONF_USB2_UNI_R</span><span class="p">),</span>
		<span class="n">trx_mode</span><span class="p">(</span><span class="n">USB1_TRX_MODE</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">trans</span> <span class="o">&amp;</span> <span class="n">CONF_USB1_UNI_R</span><span class="p">),</span>
		<span class="p">(</span><span class="n">USB0_TRX_MODE</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cpu_is_omap1710</span><span class="p">())</span>
			<span class="o">?</span> <span class="s">&quot;internal&quot;</span>
			<span class="o">:</span> <span class="n">trx_mode</span><span class="p">(</span><span class="n">USB0_TRX_MODE</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_IDLE_EN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; !otg&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">HST_IDLE_EN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; !host&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">DEV_IDLE_EN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; !dev&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_RESET_DONE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; reset_done&quot;</span> <span class="o">:</span> <span class="s">&quot; reset_active&quot;</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_SYSCON_2</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;otg_syscon2 %08x%s&quot;</span> <span class="n">EIGHTBITS</span>
			<span class="s">&quot; b_ase_brst=%d hmc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_EN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; otg_en&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">USBX_SYNCHRO</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; synchro&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>much more SRP stuff</p></td><td class="code"><div class="highlight"><pre>		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">SRP_DATA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; srp_data&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">SRP_VBUS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; srp_vbus&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_PADEN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; otg_paden&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">HMC_PADEN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; hmc_paden&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UHOST_EN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; uhost_en&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">HMC_TLLSPEED</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; tllspeed&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">HMC_TLLATTACH</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; tllattach&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">B_ASE_BRST</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span>
		<span class="n">OTG_HMC</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;otg_ctrl    %06x&quot;</span> <span class="n">EIGHTBITS</span> <span class="n">EIGHTBITS</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_ASESSVLD</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; asess&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_BSESSEND</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; bsess_end&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_BSESSVLD</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; bsess&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_VBUSVLD</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; vbus&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_ID</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; id&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_DRIVER_SEL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; DEVICE&quot;</span> <span class="o">:</span> <span class="s">&quot; HOST&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_A_SETB_HNPEN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; a_setb_hnpen&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_A_BUSREQ</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; a_bus&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_B_HNPEN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; b_hnpen&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_B_BUSREQ</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; b_bus&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_BUSDROP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; busdrop&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_PULLDOWN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; down&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_PULLUP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; up&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_DRV_VBUS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; drv&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_PD_VBUS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; pd_vb&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_PU_VBUS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; pu_vb&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">OTG_PU_ID</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; pu_id&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span>
		<span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">OTG_IRQ_EN</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;otg_irq_en  %04x&quot;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">OTG_IRQ_SRC</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;otg_irq_src %04x&quot;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">OTG_OUTCTRL</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;otg_outctrl %04x&quot;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">OTG_TEST</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;otg_test    %04x&quot;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_udc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>		<span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s, version: &quot;</span> <span class="n">DRIVER_VERSION</span>
<span class="cp">#ifdef	USE_ISO</span>
		<span class="s">&quot; (iso)&quot;</span>
<span class="cp">#endif</span>
		<span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">driver_desc</span><span class="p">,</span>
		<span class="n">use_dma</span> <span class="o">?</span>  <span class="s">&quot; (dma)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_REV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
		<span class="s">&quot;UDC rev %d.%d, fifo mode %d, gadget %s</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;hmc %d, transceiver %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span>
		<span class="n">fifo_mode</span><span class="p">,</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">?</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;(none)&quot;</span><span class="p">,</span>
		<span class="n">HMC</span><span class="p">,</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span>
			<span class="o">?</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="o">-&gt;</span><span class="n">label</span>
			<span class="o">:</span> <span class="p">((</span><span class="n">cpu_is_omap1710</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_omap24xx</span><span class="p">())</span>
				<span class="o">?</span> <span class="s">&quot;external&quot;</span> <span class="o">:</span> <span class="s">&quot;(none)&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;ULPD control %04x req %04x status %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">omap_readw</span><span class="p">(</span><span class="n">ULPD_CLOCK_CTRL</span><span class="p">),</span>
			<span class="n">omap_readw</span><span class="p">(</span><span class="n">ULPD_SOFT_REQ</span><span class="p">),</span>
			<span class="n">omap_readw</span><span class="p">(</span><span class="n">ULPD_STATUS_REQ</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* OTG controller registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span>
		<span class="n">proc_otg_show</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_SYSCON1</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">syscon1     %04x&quot;</span> <span class="n">EIGHTBITS</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_CFG_LOCK</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; cfg_lock&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_DATA_ENDIAN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; data_endian&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_DMA_ENDIAN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; dma_endian&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_NAK_EN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; nak&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_AUTODECODE_DIS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; autodecode_dis&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_SELF_PWR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; self_pwr&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_SOFF_DIS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; soff_dis&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_PULLUP_EN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; PULLUP&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>syscon2 is write-only</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* UDC controller registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_PULLUP_EN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;(suspended)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_DEVSTAT</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;devstat     %04x&quot;</span> <span class="n">EIGHTBITS</span> <span class="s">&quot;%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_B_HNP_ENABLE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; b_hnp&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_A_HNP_SUPPORT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; a_hnp&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_A_ALT_HNP_SUPPORT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; a_alt_hnp&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_R_WK_OK</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; r_wk_ok&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_USB_RESET</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; usb_reset&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_SUS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; SUS&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_CFG</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; CFG&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_ADD</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ADD&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_DEF</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; DEF&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_ATT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ATT&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;sof         %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_SOF</span><span class="p">));</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_IRQ_EN</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;irq_en      %04x&quot;</span> <span class="n">FOURBITS</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_SOF_IE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; sof&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_EPN_RX_IE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; epn_rx&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_EPN_TX_IE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; epn_tx&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_DS_CHG_IE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ds_chg&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_EP0_IE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ep0&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_IRQ_SRC</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;irq_src     %04x&quot;</span> <span class="n">EIGHTBITS</span> <span class="s">&quot;%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_TXN_DONE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; txn_done&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_RXN_CNT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; rxn_cnt&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_RXN_EOT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; rxn_eot&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_IRQ_SOF</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; sof&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_EPN_RX</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; epn_rx&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_EPN_TX</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; epn_tx&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_DS_CHG</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ds_chg&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_SETUP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; setup&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_EP0_RX</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ep0out&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_EP0_TX</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ep0in&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_DMA_IRQ_EN</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;dma_irq_en  %04x%s&quot;</span> <span class="n">EIGHTBITS</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_TX_DONE_IE</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; tx2_done&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_RX_CNT_IE</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; rx2_cnt&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_RX_EOT_IE</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; rx2_eot&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>

			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_TX_DONE_IE</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; tx1_done&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_RX_CNT_IE</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; rx1_cnt&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_RX_EOT_IE</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; rx1_eot&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>

			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_TX_DONE_IE</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; tx0_done&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_RX_CNT_IE</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; rx0_cnt&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_RX_EOT_IE</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; rx0_eot&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_RXDMA_CFG</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;rxdma_cfg   %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x0f</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;rxdma[%d]    %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						<span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_RXDMA</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)));</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_TXDMA_CFG</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;txdma_cfg   %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x0f</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))))</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;txdma[%d]    %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						<span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_TXDMA</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_DEVSTAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_ATT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">proc_ep_show</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_ADD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span>
					<span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span>
					<span class="n">proc_ep_show</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_udc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">proc_udc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">proc_udc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">create_proc_file</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">proc_create</span><span class="p">(</span><span class="n">proc_filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_proc_file</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">proc_filename</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">create_proc_file</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">remove_proc_file</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>

<span class="cp">#endif</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* Before this controller can enumerate, we need to pick an endpoint</span>
<span class="cm"> * configuration, or &quot;fifo_mode&quot;  That involves allocating 2KB of packet</span>
<span class="cm"> * buffer space among the endpoints we&#39;ll be operating.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: as of OMAP 1710 ES2.0, writing a new endpoint config when</span>
<span class="cm"> * UDC_SYSCON_1.CFG_LOCK is set can now work.  We won&#39;t use that</span>
<span class="cm"> * capability yet though.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">__init</span>
<span class="nf">omap_ep_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">maxp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">epn_rxtx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* OUT endpoints first, then IN */</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
		<span class="n">ep</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* in case of ep init table bugs */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* chip setup ... bit values are same for IN, OUT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">maxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:		<span class="n">epn_rxtx</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:	<span class="n">epn_rxtx</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:	<span class="n">epn_rxtx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">64</span>:	<span class="n">epn_rxtx</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">128</span>:	<span class="n">epn_rxtx</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">256</span>:	<span class="n">epn_rxtx</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">512</span>:	<span class="n">epn_rxtx</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">epn_rxtx</span> <span class="o">|=</span> <span class="n">UDC_EPN_RX_ISO</span><span class="p">;</span>
		<span class="n">dbuf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* double-buffering &quot;not supported&quot; on 15xx,</span>
<span class="cm">		 * and ignored for PIO-IN on newer chips</span>
<span class="cm">		 * (for more reliable behavior)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma</span> <span class="o">||</span> <span class="n">cpu_is_omap15xx</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_omap24xx</span><span class="p">())</span>
			<span class="n">dbuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">maxp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:		<span class="n">epn_rxtx</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:	<span class="n">epn_rxtx</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:	<span class="n">epn_rxtx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">64</span>:	<span class="n">epn_rxtx</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dbuf</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span><span class="p">)</span>
			<span class="n">epn_rxtx</span> <span class="o">|=</span> <span class="n">UDC_EPN_RX_DB</span><span class="p">;</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">pio_out_timer</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ep</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span>
		<span class="n">epn_rxtx</span> <span class="o">|=</span> <span class="n">UDC_EPN_RX_VALID</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="n">epn_rxtx</span> <span class="o">|=</span> <span class="n">buf</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s addr %02x rxtx %04x maxp %d%s buf %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">epn_rxtx</span><span class="p">,</span> <span class="n">maxp</span><span class="p">,</span> <span class="n">dbuf</span> <span class="o">?</span> <span class="s">&quot;x2&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">epn_rxtx</span><span class="p">,</span> <span class="n">UDC_EP_TX</span><span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">epn_rxtx</span><span class="p">,</span> <span class="n">UDC_EP_RX</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>

	<span class="cm">/* next endpoint&#39;s buffer starts after this one&#39;s */</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="n">maxp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbuf</span><span class="p">)</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">maxp</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">buf</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">);</span>

	<span class="cm">/* set up driver data structures */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="k">sizeof</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">double_buf</span> <span class="o">=</span> <span class="n">dbuf</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span> <span class="o">=</span> <span class="n">udc</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omap_ep_ops</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">maxp</span><span class="p">;</span>
	<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_udc_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">complete</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="n">udc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">omap_udc_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">odev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_phy</span> <span class="o">*</span><span class="n">xceiv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>	<span class="n">tmp</span><span class="p">,</span> <span class="n">buf</span><span class="p">;</span>

	<span class="cm">/* abolish any previous hardware state */</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UDC_SYSCON1</span><span class="p">);</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UDC_IRQ_EN</span><span class="p">);</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_IRQ_SRC_MASK</span><span class="p">,</span> <span class="n">UDC_IRQ_SRC</span><span class="p">);</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UDC_DMA_IRQ_EN</span><span class="p">);</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UDC_RXDMA_CFG</span><span class="p">);</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UDC_TXDMA_CFG</span><span class="p">);</span>

	<span class="cm">/* UDC_PULLUP_EN gates the chip clock */</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>OTG<em>SYSCON</em>1 |= DEV<em>IDLE</em>EN;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">udc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">udc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omap_gadget_ops</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">max_speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">driver_name</span><span class="p">;</span>

	<span class="n">device_initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gadget&quot;</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">omap_udc_release</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">odev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">)</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">odev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span><span class="p">;</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">xceiv</span><span class="p">;</span>

	<span class="cm">/* ep0 is special; put it right after the SETUP buffer */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">omap_ep_setup</span><span class="p">(</span><span class="s">&quot;ep0&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span><span class="p">,</span>
			<span class="mi">8</span> <span class="cm">/* after SETUP */</span><span class="p">,</span> <span class="mi">64</span> <span class="cm">/* maxpacket */</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="cm">/* initially disable all non-ep0 endpoints */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UDC_EP_RX</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UDC_EP_TX</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="p">}</span>

<span class="cp">#define OMAP_BULK_EP(name,addr) \</span>
<span class="cp">	buf = omap_ep_setup(name &quot;-bulk&quot;, addr, \</span>
<span class="cp">			USB_ENDPOINT_XFER_BULK, buf, 64, 1);</span>
<span class="cp">#define OMAP_INT_EP(name,addr, maxp) \</span>
<span class="cp">	buf = omap_ep_setup(name &quot;-int&quot;, addr, \</span>
<span class="cp">			USB_ENDPOINT_XFER_INT, buf, maxp, 0);</span>
<span class="cp">#define OMAP_ISO_EP(name,addr, maxp) \</span>
<span class="cp">	buf = omap_ep_setup(name &quot;-iso&quot;, addr, \</span>
<span class="cp">			USB_ENDPOINT_XFER_ISOC, buf, maxp, 1);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fifo_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep1in&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep2out&quot;</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">OMAP_INT_EP</span><span class="p">(</span><span class="s">&quot;ep3in&quot;</span><span class="p">,</span>   <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep1in&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep2out&quot;</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">OMAP_INT_EP</span><span class="p">(</span><span class="s">&quot;ep9in&quot;</span><span class="p">,</span>   <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep3in&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep4out&quot;</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">OMAP_INT_EP</span><span class="p">(</span><span class="s">&quot;ep10in&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep5in&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep5out&quot;</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">OMAP_INT_EP</span><span class="p">(</span><span class="s">&quot;ep11in&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep6in&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep6out&quot;</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">OMAP_INT_EP</span><span class="p">(</span><span class="s">&quot;ep12in&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep7in&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep7out&quot;</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">OMAP_INT_EP</span><span class="p">(</span><span class="s">&quot;ep13in&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">OMAP_INT_EP</span><span class="p">(</span><span class="s">&quot;ep13out&quot;</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep8in&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep8out&quot;</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">OMAP_INT_EP</span><span class="p">(</span><span class="s">&quot;ep14in&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">OMAP_INT_EP</span><span class="p">(</span><span class="s">&quot;ep14out&quot;</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep15in&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">15</span><span class="p">);</span>
		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep15out&quot;</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">15</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef	USE_ISO</span>
	<span class="k">case</span> <span class="mi">2</span>:			<span class="cm">/* mixed iso/bulk */</span>
		<span class="n">OMAP_ISO_EP</span><span class="p">(</span><span class="s">&quot;ep1in&quot;</span><span class="p">,</span>   <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
		<span class="n">OMAP_ISO_EP</span><span class="p">(</span><span class="s">&quot;ep2out&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
		<span class="n">OMAP_ISO_EP</span><span class="p">(</span><span class="s">&quot;ep3in&quot;</span><span class="p">,</span>   <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
		<span class="n">OMAP_ISO_EP</span><span class="p">(</span><span class="s">&quot;ep4out&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>

		<span class="n">OMAP_INT_EP</span><span class="p">(</span><span class="s">&quot;ep5in&quot;</span><span class="p">,</span>   <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep6in&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep7out&quot;</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">OMAP_INT_EP</span><span class="p">(</span><span class="s">&quot;ep8in&quot;</span><span class="p">,</span>   <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:			<span class="cm">/* mixed bulk/iso */</span>
		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep1in&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep2out&quot;</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">OMAP_INT_EP</span><span class="p">(</span><span class="s">&quot;ep3in&quot;</span><span class="p">,</span>   <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep4in&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">OMAP_BULK_EP</span><span class="p">(</span><span class="s">&quot;ep5out&quot;</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">OMAP_INT_EP</span><span class="p">(</span><span class="s">&quot;ep6in&quot;</span><span class="p">,</span>   <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">OMAP_ISO_EP</span><span class="p">(</span><span class="s">&quot;ep7in&quot;</span><span class="p">,</span>   <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
		<span class="n">OMAP_ISO_EP</span><span class="p">(</span><span class="s">&quot;ep8out&quot;</span><span class="p">,</span>  <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
		<span class="n">OMAP_INT_EP</span><span class="p">(</span><span class="s">&quot;ep9in&quot;</span><span class="p">,</span>   <span class="n">USB_DIR_IN</span>  <span class="o">|</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* add more modes as needed */</span>

	<span class="nl">default:</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;unsupported fifo_mode #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fifo_mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">UDC_CFG_LOCK</span><span class="o">|</span><span class="n">UDC_SELF_PWR</span><span class="p">,</span> <span class="n">UDC_SYSCON1</span><span class="p">);</span>
	<span class="n">INFO</span><span class="p">(</span><span class="s">&quot;fifo mode %d, %d bytes not used</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fifo_mode</span><span class="p">,</span> <span class="mi">2048</span> <span class="o">-</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omap_udc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">hmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_phy</span>		<span class="o">*</span><span class="n">xceiv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_usb_config</span>	<span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>		<span class="o">*</span><span class="n">dc_clk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>		<span class="o">*</span><span class="n">hhc_clk</span><span class="p">;</span>

	<span class="cm">/* NOTE:  &quot;knows&quot; the order of the resources! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">driver_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;request_mem_region failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap16xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">dc_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;usb_dc_ck&quot;</span><span class="p">);</span>
		<span class="n">hhc_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;usb_hhc_ck&quot;</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dc_clk</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">hhc_clk</span><span class="p">));</span>
		<span class="cm">/* can&#39;t use omap_udc_enable_clock yet */</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">dc_clk</span><span class="p">);</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">hhc_clk</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">dc_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;usb_fck&quot;</span><span class="p">);</span>
		<span class="n">hhc_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;usb_l4_ick&quot;</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dc_clk</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">hhc_clk</span><span class="p">));</span>
		<span class="cm">/* can&#39;t use omap_udc_enable_clock yet */</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">dc_clk</span><span class="p">);</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">hhc_clk</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap7xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">dc_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;usb_dc_ck&quot;</span><span class="p">);</span>
		<span class="n">hhc_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;l3_ocpi_ck&quot;</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dc_clk</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">hhc_clk</span><span class="p">));</span>
		<span class="cm">/* can&#39;t use omap_udc_enable_clock yet */</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">dc_clk</span><span class="p">);</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">hhc_clk</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">INFO</span><span class="p">(</span><span class="s">&quot;OMAP UDC rev %d.%d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_REV</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_REV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">otg</span> <span class="o">?</span> <span class="s">&quot;, Mini-AB&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="cm">/* use the mode given to us by board init code */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">hmc</span> <span class="o">=</span> <span class="n">HMC_1510</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;(unknown)&quot;</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">machine_without_vbus_sense</span><span class="p">())</span> <span class="p">{</span>
			<span class="cm">/* just set up software VBUS detect, and then</span>
<span class="cm">			 * later rig it so we always report VBUS.</span>
<span class="cm">			 * FIXME without really sensing VBUS, we can&#39;t</span>
<span class="cm">			 * know when to turn PULLUP_EN on/off; and that</span>
<span class="cm">			 * means we always &quot;need&quot; the 48MHz clock.</span>
<span class="cm">			 */</span>
			<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">FUNC_MUX_CTRL_0</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VBUS_CTRL_1510</span><span class="p">;</span>
			<span class="n">omap_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">FUNC_MUX_CTRL_0</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">VBUS_MODE_1510</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VBUS_CTRL_1510</span><span class="p">;</span>
			<span class="n">omap_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">FUNC_MUX_CTRL_0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* The transceiver may package some GPIO logic or handle</span>
<span class="cm">		 * loopback and/or transceiverless setup; if we find one,</span>
<span class="cm">		 * use it.  Except for OTG, we don&#39;t _need_ to talk to one;</span>
<span class="cm">		 * but not having one probably means no VBUS detection.</span>
<span class="cm">		 */</span>
		<span class="n">xceiv</span> <span class="o">=</span> <span class="n">usb_get_transceiver</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xceiv</span><span class="p">)</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">otg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;OTG requires external transceiver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">cleanup0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hmc</span> <span class="o">=</span> <span class="n">HMC_1610</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">())</span> <span class="p">{</span>
			<span class="cm">/* this could be transceiverless in one of the</span>
<span class="cm">			 * &quot;we don&#39;t need to know&quot; modes.</span>
<span class="cm">			 */</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;external&quot;</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">known</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">hmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:			<span class="cm">/* POWERUP DEFAULT == 0 */</span>
		<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">case</span> <span class="mi">12</span>:
		<span class="k">case</span> <span class="mi">20</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_is_omap1710</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;integrated&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* FALL THROUGH */</span>
		<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">case</span> <span class="mi">11</span>:
		<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">case</span> <span class="mi">19</span>:
		<span class="k">case</span> <span class="mi">25</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xceiv</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;external transceiver not registered!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">21</span>:			<span class="cm">/* internal loopback */</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;loopback&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">14</span>:			<span class="cm">/* transceiverless */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap1710</span><span class="p">())</span>
				<span class="k">goto</span> <span class="n">bad_on_1710</span><span class="p">;</span>
			<span class="cm">/* FALL THROUGH */</span>
		<span class="k">case</span> <span class="mi">13</span>:
		<span class="k">case</span> <span class="mi">15</span>:
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;no&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
<span class="nl">bad_on_1710:</span>
			<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;unrecognized UDC HMC mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hmc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">cleanup0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">known:</span>
	<span class="n">INFO</span><span class="p">(</span><span class="s">&quot;hmc mode %d, %s transceiver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hmc</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="cm">/* a &quot;gadget&quot; abstracts/virtualizes the controller */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">omap_udc_setup</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">xceiv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">cleanup0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xceiv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>"udc" is now valid</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pullup_disable</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
<span class="cp">#if	defined(CONFIG_USB_OHCI_HCD) || defined(CONFIG_USB_OHCI_HCD_MODULE)</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">is_otg</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">otg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* starting with omap1710 es2.0, clear toggle is a separate bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_REV</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x61</span><span class="p">)</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">clr_halt</span> <span class="o">=</span> <span class="n">UDC_RESET_EP</span> <span class="o">|</span> <span class="n">UDC_CLRDATA_TOGGLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">clr_halt</span> <span class="o">=</span> <span class="n">UDC_RESET_EP</span><span class="p">;</span>

	<span class="cm">/* USB general purpose IRQ:  ep0, state changes, dma, etc */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="n">omap_udc_irq</span><span class="p">,</span>
			<span class="n">IRQF_SAMPLE_RANDOM</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">udc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get irq %d, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* USB &quot;non-iso&quot; IRQ (PIO for all but ep0) */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="n">omap_udc_pio_irq</span><span class="p">,</span>
			<span class="n">IRQF_SAMPLE_RANDOM</span><span class="p">,</span> <span class="s">&quot;omap_udc pio&quot;</span><span class="p">,</span> <span class="n">udc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get irq %d, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef	USE_ISO</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="n">omap_udc_iso_irq</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="s">&quot;omap_udc iso&quot;</span><span class="p">,</span> <span class="n">udc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;can&#39;t get irq %d, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup3</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap16xx</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_omap7xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">dc_clk</span> <span class="o">=</span> <span class="n">dc_clk</span><span class="p">;</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">hhc_clk</span> <span class="o">=</span> <span class="n">hhc_clk</span><span class="p">;</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">hhc_clk</span><span class="p">);</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">dc_clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">dc_clk</span> <span class="o">=</span> <span class="n">dc_clk</span><span class="p">;</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">hhc_clk</span> <span class="o">=</span> <span class="n">hhc_clk</span><span class="p">;</span>
		<span class="cm">/* FIXME OMAP2 don&#39;t release hhc &amp; dc clock */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		clk_disable(hhc_clk);</span>
<span class="c">		clk_disable(dc_clk);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">create_proc_file</span><span class="p">();</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">device_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup4</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_add_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="cm">/* If fail, fall through */</span>
<span class="nl">cleanup4:</span>
	<span class="n">remove_proc_file</span><span class="p">();</span>

<span class="cp">#ifdef	USE_ISO</span>
<span class="nl">cleanup3:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="n">udc</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="nl">cleanup2:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="n">udc</span><span class="p">);</span>

<span class="nl">cleanup1:</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="n">udc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">cleanup0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xceiv</span><span class="p">)</span>
		<span class="n">usb_put_transceiver</span><span class="p">(</span><span class="n">xceiv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap16xx</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_omap24xx</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_omap7xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">hhc_clk</span><span class="p">);</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">dc_clk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">hhc_clk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">dc_clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">omap_udc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">usb_del_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">done</span><span class="p">;</span>

	<span class="n">pullup_disable</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_put_transceiver</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">);</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UDC_SYSCON1</span><span class="p">);</span>

	<span class="n">remove_proc_file</span><span class="p">();</span>

<span class="cp">#ifdef	USE_ISO</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="n">udc</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="n">udc</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="n">udc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dc_clk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">clk_requested</span><span class="p">)</span>
			<span class="n">omap_udc_enable_clock</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">hhc_clk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dc_clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">done</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* suspend/resume/wakeup from sysfs (echo &gt; power/state) or when the</span>
<span class="cm"> * system is forced into deep sleep</span>
<span class="cm"> *</span>
<span class="cm"> * REVISIT we should probably reject suspend requests when there&#39;s a host</span>
<span class="cm"> * session active, rather than disconnecting, at least on boards that can</span>
<span class="cm"> * report VBUS irqs (UDC_DEVSTAT.UDC_ATT).  And in any case, we need to</span>
<span class="cm"> * make host resumes and VBUS detection trigger OMAP wakeup events; that</span>
<span class="cm"> * may involve talking to an external transceiver (e.g. isp1301).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_udc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">devstat</span><span class="p">;</span>

	<span class="n">devstat</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">UDC_DEVSTAT</span><span class="p">);</span>

	<span class="cm">/* we&#39;re requesting 48 MHz clock if the pullup is enabled</span>
<span class="cm">	 * (== we&#39;re attached to the host) and we&#39;re not suspended,</span>
<span class="cm">	 * which would prevent entry to deep sleep...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">devstat</span> <span class="o">&amp;</span> <span class="n">UDC_ATT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devstat</span> <span class="o">&amp;</span> <span class="n">UDC_SUS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARNING</span><span class="p">(</span><span class="s">&quot;session active; suspend requires disconnect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">omap_pullup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_udc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;resume + wakeup/SRP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">omap_pullup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* maybe the host would enumerate us if we nudged it */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">omap_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">udc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">omap_udc_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">omap_udc_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">omap_udc_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">driver_name</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">udc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Disable DMA for omap7xx -- it doesn&#39;t work right. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap7xx</span><span class="p">())</span>
		<span class="n">use_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">INFO</span><span class="p">(</span><span class="s">&quot;%s, version: &quot;</span> <span class="n">DRIVER_VERSION</span>
<span class="cp">#ifdef	USE_ISO</span>
		<span class="s">&quot; (iso)&quot;</span>
<span class="cp">#endif</span>
		<span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_desc</span><span class="p">,</span>
		<span class="n">use_dma</span> <span class="o">?</span>  <span class="s">&quot; (dma)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_driver</span><span class="p">,</span> <span class="n">omap_udc_probe</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">udc_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">udc_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">udc_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:omap_udc&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
