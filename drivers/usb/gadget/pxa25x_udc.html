<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › gadget › pxa25x_udc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pxa25x_udc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Intel PXA25x and IXP4xx on-chip full speed USB device controllers</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2002 Intrinsyc, Inc. (Frank Becker)</span>
<span class="cm"> * Copyright (C) 2003 Robert Schwebel, Pengutronix</span>
<span class="cm"> * Copyright (C) 2003 Benedikt Spranger, Pengutronix</span>
<span class="cm"> * Copyright (C) 2003 David Brownell</span>
<span class="cm"> * Copyright (C) 2003 Joshua Wise</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cm">/* #define VERBOSE_DEBUG */</span>

<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>

<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/gpio.h&gt;</span>
<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>
<span class="cp">#include &lt;linux/usb/otg.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * This driver is PXA25x only.  Grab the right register definitions.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_ARCH_PXA</span>
<span class="cp">#include &lt;mach/pxa25x-udc.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_ARCH_LUBBOCK</span>
<span class="cp">#include &lt;mach/lubbock.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;asm/mach/udc_pxa2xx.h&gt;</span>


<span class="cm">/*</span>
<span class="cm"> * This driver handles the USB Device Controller (UDC) in Intel&#39;s PXA 25x</span>
<span class="cm"> * series processors.  The UDC for the IXP 4xx series is very similar.</span>
<span class="cm"> * There are fifteen endpoints, in addition to ep0.</span>
<span class="cm"> *</span>
<span class="cm"> * Such controller drivers work with a gadget driver.  The gadget driver</span>
<span class="cm"> * returns descriptors, implements configuration and data protocols used</span>
<span class="cm"> * by the host to interact with this device, and allocates endpoints to</span>
<span class="cm"> * the different protocol interfaces.  The controller driver virtualizes</span>
<span class="cm"> * usb hardware so that the gadget drivers will be more portable.</span>
<span class="cm"> *</span>
<span class="cm"> * This UDC hardware wants to implement a bit too much USB protocol, so</span>
<span class="cm"> * it constrains the sorts of USB configuration change events that work.</span>
<span class="cm"> * The errata for these chips are misleading; some &quot;fixed&quot; bugs from</span>
<span class="cm"> * pxa250 a0/a1 b0/b1/b2 sure act like they&#39;re still there.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that the UDC hardware supports DMA (except on IXP) but that&#39;s</span>
<span class="cm"> * not used here.  IN-DMA (to host) is simple enough, when the data is</span>
<span class="cm"> * suitably aligned (16 bytes) ... the network stack doesn&#39;t do that,</span>
<span class="cm"> * other software can.  OUT-DMA is buggy in most chip versions, as well</span>
<span class="cm"> * as poorly designed (data toggle not automatic).  So this driver won&#39;t</span>
<span class="cm"> * bother using DMA.  (Mostly-working IN-DMA support was available in</span>
<span class="cm"> * kernels before 2.6.23, but was never enabled or well tested.)</span>
<span class="cm"> */</span>

<span class="cp">#define	DRIVER_VERSION	&quot;30-June-2007&quot;</span>
<span class="cp">#define	DRIVER_DESC	&quot;PXA 25x USB Device Controller driver&quot;</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_name</span> <span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;pxa25x_udc&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ep0name</span> <span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;ep0&quot;</span><span class="p">;</span>


<span class="cp">#ifdef CONFIG_ARCH_IXP4XX</span>

<span class="cm">/* cpu-specific register addresses are compiled in to this code */</span>
<span class="cp">#ifdef CONFIG_ARCH_PXA</span>
<span class="cp">#error &quot;Can&#39;t configure both IXP and PXA&quot;</span>
<span class="cp">#endif</span>

<span class="cm">/* IXP doesn&#39;t yet support &lt;linux/clk.h&gt; */</span>
<span class="cp">#define clk_get(dev,name)	NULL</span>
<span class="cp">#define clk_enable(clk)		do { } while (0)</span>
<span class="cp">#define clk_disable(clk)	do { } while (0)</span>
<span class="cp">#define clk_put(clk)		do { } while (0)</span>

<span class="cp">#endif</span>

<span class="cp">#include &quot;pxa25x_udc.h&quot;</span>


<span class="cp">#ifdef	CONFIG_USB_PXA25X_SMALL</span>
<span class="cp">#define SIZE_STR	&quot; (small)&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define SIZE_STR	&quot;&quot;</span>
<span class="cp">#endif</span>

<span class="cm">/* ---------------------------------------------------------------------------</span>
<span class="cm"> *	endpoint related parts of the api to the usb controller hardware,</span>
<span class="cm"> *	used by gadget driver; and the inner talker-to-hardware core.</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">pxa25x_ep_fifo_flush</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nuke</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_ep</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">);</span>

<span class="cm">/* one GPIO should control a D+ pullup, so host sees this device (or not) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pullup_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa2xx_udc_mach_info</span>		<span class="o">*</span><span class="n">mach</span> <span class="o">=</span> <span class="n">the_controller</span><span class="o">-&gt;</span><span class="n">mach</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">off_level</span> <span class="o">=</span> <span class="n">mach</span><span class="o">-&gt;</span><span class="n">gpio_pullup_inverted</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">gpio_pullup</span><span class="p">))</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">gpio_pullup</span><span class="p">,</span> <span class="n">off_level</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">udc_command</span><span class="p">)</span>
		<span class="n">mach</span><span class="o">-&gt;</span><span class="n">udc_command</span><span class="p">(</span><span class="n">PXA2XX_UDC_CMD_DISCONNECT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pullup_on</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa2xx_udc_mach_info</span>		<span class="o">*</span><span class="n">mach</span> <span class="o">=</span> <span class="n">the_controller</span><span class="o">-&gt;</span><span class="n">mach</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">on_level</span> <span class="o">=</span> <span class="o">!</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">gpio_pullup_inverted</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">gpio_pullup</span><span class="p">))</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">gpio_pullup</span><span class="p">,</span> <span class="n">on_level</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">udc_command</span><span class="p">)</span>
		<span class="n">mach</span><span class="o">-&gt;</span><span class="n">udc_command</span><span class="p">(</span><span class="n">PXA2XX_UDC_CMD_CONNECT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pio_irq_enable</span><span class="p">(</span><span class="kt">int</span> <span class="n">bEndpointAddress</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">bEndpointAddress</span> <span class="o">&amp;=</span> <span class="mh">0xf</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bEndpointAddress</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
                <span class="n">UICR0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bEndpointAddress</span><span class="p">);</span>
        <span class="k">else</span> <span class="p">{</span>
                <span class="n">bEndpointAddress</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
                <span class="n">UICR1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bEndpointAddress</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pio_irq_disable</span><span class="p">(</span><span class="kt">int</span> <span class="n">bEndpointAddress</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">bEndpointAddress</span> <span class="o">&amp;=</span> <span class="mh">0xf</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bEndpointAddress</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
                <span class="n">UICR0</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bEndpointAddress</span><span class="p">;</span>
        <span class="k">else</span> <span class="p">{</span>
                <span class="n">bEndpointAddress</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
                <span class="n">UICR1</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bEndpointAddress</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* The UDCCR reg contains mask and interrupt status bits,</span>
<span class="cm"> * so using &#39;|=&#39; isn&#39;t safe as it may ack an interrupt.</span>
<span class="cm"> */</span>
<span class="cp">#define UDCCR_MASK_BITS         (UDCCR_REM | UDCCR_SRM | UDCCR_UDE)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">udc_set_mask_UDCCR</span><span class="p">(</span><span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UDCCR</span> <span class="o">=</span> <span class="p">(</span><span class="n">UDCCR</span> <span class="o">&amp;</span> <span class="n">UDCCR_MASK_BITS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">UDCCR_MASK_BITS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">udc_clear_mask_UDCCR</span><span class="p">(</span><span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UDCCR</span> <span class="o">=</span> <span class="p">(</span><span class="n">UDCCR</span> <span class="o">&amp;</span> <span class="n">UDCCR_MASK_BITS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">UDCCR_MASK_BITS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">udc_ack_int_UDCCR</span><span class="p">(</span><span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* udccr contains the bits we dont want to change */</span>
	<span class="n">__u32</span> <span class="n">udccr</span> <span class="o">=</span> <span class="n">UDCCR</span> <span class="o">&amp;</span> <span class="n">UDCCR_MASK_BITS</span><span class="p">;</span>

	<span class="n">UDCCR</span> <span class="o">=</span> <span class="n">udccr</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UDCCR_MASK_BITS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * endpoint enable/disable</span>
<span class="cm"> *</span>
<span class="cm"> * we need to verify the descriptors used to enable endpoints.  since pxa25x</span>
<span class="cm"> * endpoint configurations are fixed, and are pretty much always enabled,</span>
<span class="cm"> * there&#39;s not a lot to manage here.</span>
<span class="cm"> *</span>
<span class="cm"> * because pxa25x can&#39;t selectively initialize bulk (or interrupt) endpoints,</span>
<span class="cm"> * (resetting endpoint halt and toggle), SET_INTERFACE is unusable except</span>
<span class="cm"> * for a single interface (with only the default altsetting) and for gadget</span>
<span class="cm"> * drivers that don&#39;t halt endpoints (not reset by set_interface).  that also</span>
<span class="cm"> * means that if you use ISO, you must violate the USB spec rule that all</span>
<span class="cm"> * iso endpoints must be in non-default altsettings.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa25x_ep_enable</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_ep</span>        <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxa25x_udc</span>       <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span> <span class="o">||</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span>
			<span class="o">||</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">!=</span> <span class="n">USB_DT_ENDPOINT</span>
			<span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">!=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span>
			<span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">&lt;</span> <span class="n">usb_endpoint_maxp</span> <span class="p">(</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;%s, bad ep or descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* xfer types must match, except that interrupt ~= bulk */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">!=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span>
			<span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">!=</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>
			<span class="o">&amp;&amp;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">!=</span> <span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;%s, %s type mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* hardware _could_ do smaller, but driver doesn&#39;t */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>
				<span class="o">&amp;&amp;</span> <span class="n">usb_endpoint_maxp</span> <span class="p">(</span><span class="n">desc</span><span class="p">)</span>
						<span class="o">!=</span> <span class="n">BULK_FIFO_SIZE</span><span class="p">)</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;%s, bad %s maxpacket</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;%s, bogus device state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">pio_irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span> <span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="cm">/* flush fifo (mostly for OUT buffers) */</span>
	<span class="n">pxa25x_ep_fifo_flush</span> <span class="p">(</span><span class="n">_ep</span><span class="p">);</span>

	<span class="cm">/* ... reset halt state too, if we could ... */</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERBOSE</span><span class="p">,</span> <span class="s">&quot;enabled %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa25x_ep_disable</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;%s, %s not enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">_ep</span> <span class="o">?</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">nuke</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>

	<span class="cm">/* flush fifo (mostly for IN buffers) */</span>
	<span class="n">pxa25x_ep_fifo_flush</span> <span class="p">(</span><span class="n">_ep</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERBOSE</span><span class="p">,</span> <span class="s">&quot;%s disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* for the pxa25x, these can just wrap kmalloc/kfree.  gadget drivers</span>
<span class="cm"> * must still pass correctly initialized endpoints, since other controller</span>
<span class="cm"> * drivers may care about how it&#39;s currently set up (dma issues etc).</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *	pxa25x_ep_alloc_request - allocate a request data structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span>
<span class="nf">pxa25x_ep_alloc_request</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	pxa25x_ep_free_request - deallocate a request data structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pxa25x_ep_free_request</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> *	done - retire a request; caller blocked irqs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">done</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>		<span class="n">stopped</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">;</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">))</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERBOSE</span><span class="p">,</span> <span class="s">&quot;complete %s req %p stat %d len %u/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="cm">/* don&#39;t modify queue heads during completion callback */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="n">stopped</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ep0_idle</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_IDLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">write_packet</span><span class="p">(</span><span class="k">volatile</span> <span class="n">u32</span> <span class="o">*</span><span class="n">uddr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>		<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">length</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="cm">/* how big will this packet be? */</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">))</span>
		<span class="o">*</span><span class="n">uddr</span> <span class="o">=</span> <span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * write to an IN endpoint fifo, as many packets as possible.</span>
<span class="cm"> * irqs will use this to write the rest later.</span>
<span class="cm"> * caller guarantees at least one packet buffer is ready (or a zlp).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">write_fifo</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>		<span class="n">max</span><span class="p">;</span>

	<span class="n">max</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">unsigned</span>	<span class="n">count</span><span class="p">;</span>
		<span class="kt">int</span>		<span class="n">is_last</span><span class="p">,</span> <span class="n">is_short</span><span class="p">;</span>

		<span class="n">count</span> <span class="o">=</span> <span class="n">write_packet</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_uddr</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>

		<span class="cm">/* last packet is usually short (or a zlp) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">max</span><span class="p">))</span>
			<span class="n">is_last</span> <span class="o">=</span> <span class="n">is_short</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">)</span>
					<span class="o">||</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span><span class="p">)</span>
				<span class="n">is_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">is_last</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* interrupt/iso maxpacket may not fill the fifo */</span>
			<span class="n">is_short</span> <span class="o">=</span> <span class="n">unlikely</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_size</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERY_NOISY</span><span class="p">,</span> <span class="s">&quot;wrote %s %d bytes%s%s %d left %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
			<span class="n">is_last</span> <span class="o">?</span> <span class="s">&quot;/L&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">is_short</span> <span class="o">?</span> <span class="s">&quot;/S&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

		<span class="cm">/* let loose that packet. maybe try writing another one,</span>
<span class="cm">		 * double buffering might work.  TSP, TPC, and TFS</span>
<span class="cm">		 * bit values are the same for all normal IN endpoints.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_udccs</span> <span class="o">=</span> <span class="n">UDCCS_BI_TPC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_short</span><span class="p">)</span>
			<span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_udccs</span> <span class="o">=</span> <span class="n">UDCCS_BI_TSP</span><span class="p">;</span>

		<span class="cm">/* requests complete when all IN data is in the FIFO */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_last</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">done</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
				<span class="n">pio_irq_disable</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>TODO experiment: how robust can fifo mode tweaking be?
double buffering is off in the default fifo mode, which
prevents TFS from being set here.</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_udccs</span> <span class="o">&amp;</span> <span class="n">UDCCS_BI_TFS</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* caller asserts req-&gt;pending (ep0 irq status nyet cleared); starts</span>
<span class="cm"> * ep0 data stage.  these chips want very simple state transitions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">void</span> <span class="nf">ep0start</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UDCCS0</span> <span class="o">=</span> <span class="n">flags</span><span class="o">|</span><span class="n">UDCCS0_SA</span><span class="o">|</span><span class="n">UDCCS0_OPR</span><span class="p">;</span>
	<span class="n">USIR0</span> <span class="o">=</span> <span class="n">USIR0_IR0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERY_NOISY</span><span class="p">,</span> <span class="s">&quot;%s %s, %02x/%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">UDCCS0</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">write_ep0_fifo</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>	<span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">is_short</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">write_packet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">UDDR0</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">EP0_FIFO_SIZE</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* last packet &quot;must be&quot; short (or a zlp) */</span>
	<span class="n">is_short</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">EP0_FIFO_SIZE</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERY_NOISY</span><span class="p">,</span> <span class="s">&quot;ep0in %d bytes %d left %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="n">is_short</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_pending</span><span class="p">)</span>
			<span class="n">ep0start</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">UDCCS0_IPR</span><span class="p">,</span> <span class="s">&quot;short IN&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">UDCCS0</span> <span class="o">=</span> <span class="n">UDCCS0_IPR</span><span class="p">;</span>

		<span class="n">count</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="n">done</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ep0_idle</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifndef CONFIG_ARCH_IXP4XX</span>
<span class="cp">#if 1</span>
		<span class="cm">/* This seems to get rid of lost status irqs in some cases:</span>
<span class="cm">		 * host responds quickly, or next request involves config</span>
<span class="cm">		 * change automagic, or should have been hidden, or ...</span>
<span class="cm">		 *</span>
<span class="cm">		 * FIXME get rid of all udelays possible...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">EP0_FIFO_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">UDCCS0</span> <span class="o">&amp;</span> <span class="n">UDCCS0_OPR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* clear OPR, generate ack */</span>
					<span class="n">UDCCS0</span> <span class="o">=</span> <span class="n">UDCCS0_OPR</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">count</span><span class="o">--</span><span class="p">;</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_pending</span><span class="p">)</span>
		<span class="n">ep0start</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;IN&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">is_short</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * read_fifo -  unload packet(s) from the fifo we use for usb OUT</span>
<span class="cm"> * transfers and put them into the request.  caller should have made</span>
<span class="cm"> * sure there&#39;s at least one packet ready.</span>
<span class="cm"> *</span>
<span class="cm"> * returns true if the request completed because of short packet or the</span>
<span class="cm"> * request buffer having filled (and maybe overran till end-of-packet).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">read_fifo</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">u32</span>		<span class="n">udccs</span><span class="p">;</span>
		<span class="n">u8</span>		<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
		<span class="kt">unsigned</span>	<span class="n">bufferspace</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">is_short</span><span class="p">;</span>

		<span class="cm">/* make sure there&#39;s a packet in the FIFO.</span>
<span class="cm">		 * UDCCS_{BO,IO}_RPC are all the same bit value.</span>
<span class="cm">		 * UDCCS_{BO,IO}_RNE are all the same bit value.</span>
<span class="cm">		 */</span>
		<span class="n">udccs</span> <span class="o">=</span> <span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_udccs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">((</span><span class="n">udccs</span> <span class="o">&amp;</span> <span class="n">UDCCS_BO_RPC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
		<span class="n">prefetchw</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">bufferspace</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>

		<span class="cm">/* read all bytes from this packet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="n">udccs</span> <span class="o">&amp;</span> <span class="n">UDCCS_BO_RNE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x0ff</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_ubcr</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">min</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">bufferspace</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="cm">/* zlp */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">is_short</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERY_NOISY</span><span class="p">,</span> <span class="s">&quot;read %s %02x, %d bytes%s req %p %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">udccs</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
			<span class="n">is_short</span> <span class="o">?</span> <span class="s">&quot;/S&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span>	<span class="n">byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_uddr</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="n">bufferspace</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* this happens when the driver&#39;s buffer</span>
<span class="cm">				 * is smaller than what the host sent.</span>
<span class="cm">				 * discard the extra data.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">)</span>
					<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;%s overflow %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>
				<span class="n">bufferspace</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_udccs</span> <span class="o">=</span>  <span class="n">UDCCS_BO_RPC</span><span class="p">;</span>
		<span class="cm">/* RPC/RSP/RNE could now reflect the other packet buffer */</span>

		<span class="cm">/* iso is one request per packet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">udccs</span> <span class="o">&amp;</span> <span class="n">UDCCS_IO_ROF</span><span class="p">)</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>
			<span class="cm">/* more like &quot;is_done&quot; */</span>
			<span class="n">is_short</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* completion */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_short</span> <span class="o">||</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">done</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
				<span class="n">pio_irq_disable</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* finished that packet.  the next one may be waiting... */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * special ep0 version of the above.  no UBCR0 or double buffering; status</span>
<span class="cm"> * handshaking is magic.  most device protocols don&#39;t need control-OUT.</span>
<span class="cm"> * CDC vendor commands (and RNDIS), mass storage CB/CBI, and some other</span>
<span class="cm"> * protocols do use them.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">read_ep0_fifo</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>		<span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">byte</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">bufferspace</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">bufferspace</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">UDCCS0</span> <span class="o">&amp;</span> <span class="n">UDCCS0_RNE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">UDDR0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="n">bufferspace</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* this happens when the driver&#39;s buffer</span>
<span class="cm">			 * is smaller than what the host sent.</span>
<span class="cm">			 * discard the extra data.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">)</span>
				<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;%s overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="o">++</span><span class="p">;</span>
			<span class="n">bufferspace</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">UDCCS0</span> <span class="o">=</span> <span class="n">UDCCS0_OPR</span> <span class="o">|</span> <span class="n">UDCCS0_IPR</span><span class="p">;</span>

	<span class="cm">/* completion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">&gt;=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* finished that packet.  the next one may be waiting... */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pxa25x_ep_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxa25x_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxa25x_udc</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="o">!</span><span class="n">_req</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="o">-&gt;</span><span class="n">buf</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;%s, bad params</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">ep0name</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;%s, bad ep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span>
			<span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;%s, bogus device state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* iso is always one packet per request, that&#39;s the only way</span>
<span class="cm">	 * we can report per-packet status.  that also helps with dma.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>
			<span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_NOISY</span><span class="p">,</span> <span class="s">&quot;%s queue req %p, len %d buf %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">_req</span><span class="p">,</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">_req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">_req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* kickstart this i/o queue? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="cm">/* ep0 */</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span>	<span class="n">length</span> <span class="o">=</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">EP0_IN_DATA_PHASE</span>:
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">ops</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">write_ep0_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span>
					<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">EP0_OUT_DATA_PHASE</span>:
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">ops</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/* messy ... */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_config</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERBOSE</span><span class="p">,</span> <span class="s">&quot;ep0 config ack%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_cfr</span> <span class="o">?</span>  <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; raced&quot;</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_cfr</span><span class="p">)</span>
						<span class="n">UDCCFR</span> <span class="o">=</span> <span class="n">UDCCFR_AREN</span><span class="o">|</span><span class="n">UDCCFR_ACM</span>
							<span class="o">|</span><span class="n">UDCCFR_MB1</span><span class="p">;</span>
					<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_END_XFER</span><span class="p">;</span>
					<span class="n">local_irq_restore</span> <span class="p">(</span><span class="n">flags</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_pending</span><span class="p">)</span>
					<span class="n">ep0start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">UDCCS0_IPR</span><span class="p">,</span> <span class="s">&quot;OUT&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">((</span><span class="n">UDCCS0</span> <span class="o">&amp;</span> <span class="n">UDCCS0_RNE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
						<span class="o">&amp;&amp;</span> <span class="n">read_ep0_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">ep0_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;ep0 i/o, odd state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span><span class="p">);</span>
				<span class="n">local_irq_restore</span> <span class="p">(</span><span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EL2HLT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="cm">/* can the FIFO can satisfy the request immediately? */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_udccs</span> <span class="o">&amp;</span> <span class="n">UDCCS_BI_TFS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
					<span class="o">&amp;&amp;</span> <span class="n">write_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span>
				<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_udccs</span> <span class="o">&amp;</span> <span class="n">UDCCS_BO_RFS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
				<span class="o">&amp;&amp;</span> <span class="n">read_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">))</span>
			<span class="n">pio_irq_enable</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* pio or dma irq handler advances the queue. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	nuke - dequeue ALL requests</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nuke</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="cm">/* called with irqs blocked */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pxa25x_request</span><span class="p">,</span>
				<span class="n">queue</span><span class="p">);</span>
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span>
		<span class="n">pio_irq_disable</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* dequeue JUST ONE request */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa25x_ep_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxa25x_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* make sure it&#39;s actually queued on this endpoint */</span>
	<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">==</span> <span class="n">_req</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">!=</span> <span class="n">_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa25x_ep_set_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span>
			<span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">ep0name</span><span class="p">))</span>
			<span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;%s, bad ep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* this path (reset toggle+halt) is needed to implement</span>
<span class="cm">		 * SET_INTERFACE on normal hardware.  but it can&#39;t be</span>
<span class="cm">		 * done from software on the PXA UDC, and the hardware</span>
<span class="cm">		 * forgets to do it as part of SET_INTERFACE automagic.</span>
<span class="cm">		 */</span>
		<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;only host can clear %s halt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
			<span class="o">&amp;&amp;</span> <span class="p">((</span><span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_udccs</span> <span class="o">&amp;</span> <span class="n">UDCCS_BI_TFS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			   <span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FST bit is the same for control, bulk in, bulk out, interrupt in */</span>
	<span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_udccs</span> <span class="o">=</span> <span class="n">UDCCS_BI_FST</span><span class="o">|</span><span class="n">UDCCS_BI_FTF</span><span class="p">;</span>

	<span class="cm">/* ep0 needs special care */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start_watchdog</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_STALL</span><span class="p">;</span>

	<span class="cm">/* and bulk/intr endpoints like dropping stalls too */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_udccs</span> <span class="o">&amp;</span> <span class="n">UDCCS_BI_SST</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERBOSE</span><span class="p">,</span> <span class="s">&quot;%s halt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa25x_ep_fifo_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_ep</span>        <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;%s, bad ep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* pxa can&#39;t report unclaimed bytes from IN fifos */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span>
			<span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_udccs</span> <span class="o">&amp;</span> <span class="n">UDCCS_BO_RFS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_ubcr</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pxa25x_ep_fifo_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_ep</span>        <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span> <span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;%s, bad ep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* toggle and halt bits stay unchanged */</span>

	<span class="cm">/* for OUT, just read and discard the FIFO contents. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(((</span><span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_udccs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UDCCS_BO_RNE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_uddr</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* most IN status is the same, but ISO can&#39;t stall */</span>
	<span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_udccs</span> <span class="o">=</span> <span class="n">UDCCS_BI_TPC</span><span class="o">|</span><span class="n">UDCCS_BI_FTF</span><span class="o">|</span><span class="n">UDCCS_BI_TUR</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>
			<span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">UDCCS_BI_SST</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">pxa25x_ep_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">pxa25x_ep_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">pxa25x_ep_disable</span><span class="p">,</span>

	<span class="p">.</span><span class="n">alloc_request</span>	<span class="o">=</span> <span class="n">pxa25x_ep_alloc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_request</span>	<span class="o">=</span> <span class="n">pxa25x_ep_free_request</span><span class="p">,</span>

	<span class="p">.</span><span class="n">queue</span>		<span class="o">=</span> <span class="n">pxa25x_ep_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue</span>	<span class="o">=</span> <span class="n">pxa25x_ep_dequeue</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_halt</span>	<span class="o">=</span> <span class="n">pxa25x_ep_set_halt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_status</span>	<span class="o">=</span> <span class="n">pxa25x_ep_fifo_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_flush</span>	<span class="o">=</span> <span class="n">pxa25x_ep_fifo_flush</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* ---------------------------------------------------------------------------</span>
<span class="cm"> *	device-scoped parts of the api to the usb controller hardware</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa25x_udc_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">UFNRH</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">UFNRL</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa25x_udc_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* host may not have enabled remote wakeup */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">UDCCS0</span> <span class="o">&amp;</span> <span class="n">UDCCS0_DRWF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>
	<span class="n">udc_set_mask_UDCCR</span><span class="p">(</span><span class="n">UDCCR_RSM</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">stop_activity</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_udc</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">udc_enable</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_udc</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">udc_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_udc</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/* We disable the UDC -- and its 48 MHz clock -- whenever it&#39;s not</span>
<span class="cm"> * in active use.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pullup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">is_active</span> <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus</span> <span class="o">&amp;&amp;</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">pullup</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">;</span>
	<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">is_active</span> <span class="o">?</span> <span class="s">&quot;active&quot;</span> <span class="o">:</span> <span class="s">&quot;inactive&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* Enable clock for USB device */</span>
			<span class="n">clk_enable</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
			<span class="n">udc_enable</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;disconnect %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span>
					<span class="o">?</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span>
					<span class="o">:</span> <span class="s">&quot;(no driver)&quot;</span><span class="p">);</span>
				<span class="n">stop_activity</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">udc_disable</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
			<span class="cm">/* Disable clock for USB device */</span>
			<span class="n">clk_disable</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* VBUS reporting logically comes from a transceiver */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa25x_udc_vbus_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_udc</span>	<span class="o">*</span><span class="n">udc</span><span class="p">;</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_udc</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus</span> <span class="o">=</span> <span class="n">is_active</span><span class="p">;</span>
	<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;vbus %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">is_active</span> <span class="o">?</span> <span class="s">&quot;supplied&quot;</span> <span class="o">:</span> <span class="s">&quot;inactive&quot;</span><span class="p">);</span>
	<span class="n">pullup</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* drivers may have software control over D+ pullup */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa25x_udc_pullup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_udc</span>	<span class="o">*</span><span class="n">udc</span><span class="p">;</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_udc</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>

	<span class="cm">/* not all boards support pullup control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">gpio_pullup</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">udc_command</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">pullup</span> <span class="o">=</span> <span class="p">(</span><span class="n">is_active</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pullup</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* boards may consume current from VBUS, up to 100-500mA based on config.</span>
<span class="cm"> * the 500uA suspend ceiling means that exclusively vbus-powered PXA designs</span>
<span class="cm"> * violate USB specs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa25x_udc_vbus_draw</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">mA</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_udc</span>	<span class="o">*</span><span class="n">udc</span><span class="p">;</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_udc</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">usb_phy_set_power</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">,</span> <span class="n">mA</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pxa25x_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bind</span><span class="p">)(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="p">));</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pxa25x_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_gadget_ops</span> <span class="n">pxa25x_udc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_frame</span>	<span class="o">=</span> <span class="n">pxa25x_udc_get_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wakeup</span>		<span class="o">=</span> <span class="n">pxa25x_udc_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vbus_session</span>	<span class="o">=</span> <span class="n">pxa25x_udc_vbus_session</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pullup</span>		<span class="o">=</span> <span class="n">pxa25x_udc_pullup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vbus_draw</span>	<span class="o">=</span> <span class="n">pxa25x_udc_vbus_draw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="n">pxa25x_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>		<span class="o">=</span> <span class="n">pxa25x_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#ifdef CONFIG_USB_GADGET_DEBUG_FS</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">udc_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_udc</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">tmp</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* basic device status */</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">DRIVER_DESC</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;%s version: %s</span><span class="se">\n</span><span class="s">Gadget driver: %s</span><span class="se">\n</span><span class="s">Host %s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">driver_name</span><span class="p">,</span> <span class="n">DRIVER_VERSION</span> <span class="n">SIZE_STR</span> <span class="s">&quot;(pio)&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">?</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;(none)&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span> <span class="o">?</span> <span class="s">&quot;full speed&quot;</span> <span class="o">:</span> <span class="s">&quot;disconnected&quot;</span><span class="p">);</span>

	<span class="cm">/* registers for device and ep0 */</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
		<span class="s">&quot;uicr %02X.%02X, usir %02X.%02x, ufnr %02X.%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">UICR1</span><span class="p">,</span> <span class="n">UICR0</span><span class="p">,</span> <span class="n">USIR1</span><span class="p">,</span> <span class="n">USIR0</span><span class="p">,</span> <span class="n">UFNRH</span><span class="p">,</span> <span class="n">UFNRL</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">UDCCR</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
		<span class="s">&quot;udccr %02X =%s%s%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCR_REM</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; rem&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCR_RSTIR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; rstir&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCR_SRM</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; srm&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCR_SUSIR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; susir&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCR_RESIR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; resir&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCR_RSM</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; rsm&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCR_UDA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; uda&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCR_UDE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ude&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">UDCCS0</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
		<span class="s">&quot;udccs0 %02X =%s%s%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCS0_SA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; sa&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCS0_RNE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; rne&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCS0_FST</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; fst&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCS0_SST</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; sst&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCS0_DRWF</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; dwrf&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCS0_FTF</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ftf&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCS0_IPR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ipr&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCS0_OPR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; opr&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_cfr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">UDCCFR</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
			<span class="s">&quot;udccfr %02X =%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCFR_AREN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; aren&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDCCFR_ACM</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; acm&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_FULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;ep0 IN %lu/%lu, OUT %lu/%lu</span><span class="se">\n</span><span class="s">irqs %lu</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">irqs</span><span class="p">);</span>

	<span class="cm">/* dump endpoint queues */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PXA_UDC_NUM_ENDPOINTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pxa25x_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">pxa25x_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span>	<span class="o">*</span><span class="n">desc</span><span class="p">;</span>

			<span class="n">desc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_udccs</span><span class="p">;</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
				<span class="s">&quot;%s max %d %s udccs %02x irqs %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span>
				<span class="s">&quot;pio&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">pio_irqs</span><span class="p">);</span>
			<span class="cm">/* TODO translate all five groups of udccs bits! */</span>

		<span class="p">}</span> <span class="k">else</span> <span class="cm">/* ep0 should only have one transfer queued */</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;ep0 max 16 pio irqs %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">pio_irqs</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">(nothing queued)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
					<span class="s">&quot;</span><span class="se">\t</span><span class="s">req %p len %d/%d buf %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">udc_debugfs_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">udc_seq_show</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">debug_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">udc_debugfs_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define create_debug_files(dev) \</span>
<span class="cp">	do { \</span>
<span class="cp">		dev-&gt;debugfs_udc = debugfs_create_file(dev-&gt;gadget.name, \</span>
<span class="cp">			S_IRUGO, NULL, dev, &amp;debug_fops); \</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define remove_debug_files(dev) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (dev-&gt;debugfs_udc) \</span>
<span class="cp">			debugfs_remove(dev-&gt;debugfs_udc); \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#else	</span><span class="cm">/* !CONFIG_USB_GADGET_DEBUG_FILES */</span><span class="cp"></span>

<span class="cp">#define create_debug_files(dev) do {} while (0)</span>
<span class="cp">#define remove_debug_files(dev) do {} while (0)</span>

<span class="cp">#endif	</span><span class="cm">/* CONFIG_USB_GADGET_DEBUG_FILES */</span><span class="cp"></span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> *	udc_disable - disable USB device controller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* block all irqs */</span>
	<span class="n">udc_set_mask_UDCCR</span><span class="p">(</span><span class="n">UDCCR_SRM</span><span class="o">|</span><span class="n">UDCCR_REM</span><span class="p">);</span>
	<span class="n">UICR0</span> <span class="o">=</span> <span class="n">UICR1</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">UFNRH</span> <span class="o">=</span> <span class="n">UFNRH_SIM</span><span class="p">;</span>

	<span class="cm">/* if hardware supports it, disconnect from usb */</span>
	<span class="n">pullup_off</span><span class="p">();</span>

	<span class="n">udc_clear_mask_UDCCR</span><span class="p">(</span><span class="n">UDCCR_UDE</span><span class="p">);</span>

	<span class="n">ep0_idle</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	udc_reinit - initialize software state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_reinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">i</span><span class="p">;</span>

	<span class="cm">/* device/ep0 records init */</span>
	<span class="n">INIT_LIST_HEAD</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_IDLE</span><span class="p">;</span>

	<span class="cm">/* basic endpoint records init */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PXA_UDC_NUM_ENDPOINTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pxa25x_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">pio_irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the rest was statically initialized, and is read-only */</span>
<span class="p">}</span>

<span class="cm">/* until it&#39;s enabled, this UDC should be completely invisible</span>
<span class="cm"> * to any USB host.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_enable</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">udc_clear_mask_UDCCR</span><span class="p">(</span><span class="n">UDCCR_UDE</span><span class="p">);</span>

	<span class="cm">/* try to clear these bits before we enable the udc */</span>
	<span class="n">udc_ack_int_UDCCR</span><span class="p">(</span><span class="n">UDCCR_SUSIR</span><span class="o">|</span><span class="cm">/*UDCCR_RSTIR|*/</span><span class="n">UDCCR_RESIR</span><span class="p">);</span>

	<span class="n">ep0_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * sequence taken from chapter 12.5.10, PXA250 AppProcDevManual:</span>
<span class="cm">	 * - enable UDC</span>
<span class="cm">	 * - if RESET is already in progress, ack interrupt</span>
<span class="cm">	 * - unmask reset interrupt</span>
<span class="cm">	 */</span>
	<span class="n">udc_set_mask_UDCCR</span><span class="p">(</span><span class="n">UDCCR_UDE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">UDCCR</span> <span class="o">&amp;</span> <span class="n">UDCCR_UDA</span><span class="p">))</span>
		<span class="n">udc_ack_int_UDCCR</span><span class="p">(</span><span class="n">UDCCR_RSTIR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_cfr</span> <span class="cm">/* UDC_RES2 is defined */</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* pxa255 (a0+) can avoid a set_config race that could</span>
<span class="cm">		 * prevent gadget drivers from configuring correctly</span>
<span class="cm">		 */</span>
		<span class="n">UDCCFR</span> <span class="o">=</span> <span class="n">UDCCFR_ACM</span> <span class="o">|</span> <span class="n">UDCCFR_MB1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* &quot;USB test mode&quot; for pxa250 errata 40-42 (stepping a0, a1)</span>
<span class="cm">		 * which could result in missing packets and interrupts.</span>
<span class="cm">		 * supposedly one bit per endpoint, controlling whether it</span>
<span class="cm">		 * double buffers or not; ACM/AREN bits fit into the holes.</span>
<span class="cm">		 * zero bits (like USIR0_IRx) disable double buffering.</span>
<span class="cm">		 */</span>
		<span class="n">UDC_RES1</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">UDC_RES2</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enable suspend/resume and reset irqs */</span>
	<span class="n">udc_clear_mask_UDCCR</span><span class="p">(</span><span class="n">UDCCR_SRM</span> <span class="o">|</span> <span class="n">UDCCR_REM</span><span class="p">);</span>

	<span class="cm">/* enable ep0 irqs */</span>
	<span class="n">UICR0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UICR0_IM0</span><span class="p">;</span>

	<span class="cm">/* if hardware supports it, pullup D+ and wait for reset */</span>
	<span class="n">pullup_on</span><span class="p">();</span>
<span class="p">}</span>


<span class="cm">/* when a driver is successfully registered, it will receive</span>
<span class="cm"> * control requests including set_configuration(), which enables</span>
<span class="cm"> * non-control requests.  then usb traffic follows until a</span>
<span class="cm"> * disconnect is reported.  then a host may connect again, or</span>
<span class="cm"> * the driver might get unbound.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa25x_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bind</span><span class="p">)(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_udc</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">the_controller</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span>
			<span class="o">||</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">max_speed</span> <span class="o">&lt;</span> <span class="n">USB_SPEED_FULL</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">bind</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disconnect</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* first hook up the driver ... */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pullup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">device_add</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">fail:</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;bind to driver %s --&gt; error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="n">device_del</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ... then enable host detection and ep0; and we&#39;re ready</span>
<span class="cm">	 * for set_configuration as well as eventual disconnect.</span>
<span class="cm">	 */</span>
	<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;registered gadget driver &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* connect to bus through transceiver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">otg_set_peripheral</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="o">-&gt;</span><span class="n">otg</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;can&#39;t bind to transceiver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">)</span>
				<span class="n">driver</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bind_fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pullup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dump_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bind_fail:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">stop_activity</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* don&#39;t disconnect drivers more than once */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>

	<span class="cm">/* prevent new request submissions, kill any outstanding requests  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PXA_UDC_NUM_ENDPOINTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pxa25x_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nuke</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="cm">/* report disconnect; the driver is already quiesced */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="p">)</span>
		<span class="n">driver</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>

	<span class="cm">/* re-init driver-visible data structures */</span>
	<span class="n">udc_reinit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa25x_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_udc</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">the_controller</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span> <span class="o">||</span> <span class="n">driver</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pullup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pullup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">stop_activity</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">driver</span><span class="p">);</span>
	<span class="n">local_irq_enable</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">otg_set_peripheral</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="o">-&gt;</span><span class="n">otg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">device_del</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;unregistered gadget driver &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">dump_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#ifdef CONFIG_ARCH_LUBBOCK</span>

<span class="cm">/* Lubbock has separate connect and disconnect irqs.  More typical designs</span>
<span class="cm"> * use one GPIO as the VBUS IRQ, and another to control the D+ pullup.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">lubbock_vbus_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_udc</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">_dev</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">vbus</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LUBBOCK_USB_IRQ</span>:
		<span class="n">vbus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">LUBBOCK_USB_IRQ</span><span class="p">);</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">LUBBOCK_USB_DISC_IRQ</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LUBBOCK_USB_DISC_IRQ</span>:
		<span class="n">vbus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">LUBBOCK_USB_DISC_IRQ</span><span class="p">);</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">LUBBOCK_USB_IRQ</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pxa25x_udc_vbus_session</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="n">vbus</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">clear_ep_state</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* hardware SET_{CONFIGURATION,INTERFACE} automagic resets endpoint</span>
<span class="cm">	 * fifos, and pending transactions mustn&#39;t be continued in any case.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PXA_UDC_NUM_ENDPOINTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">nuke</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">-</span><span class="n">ECONNABORTED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_watchdog</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_udc</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">_dev</span><span class="p">;</span>

	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">==</span> <span class="n">EP0_STALL</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">UDCCS0</span> <span class="o">&amp;</span> <span class="n">UDCCS0_FST</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">UDCCS0</span> <span class="o">&amp;</span> <span class="n">UDCCS0_SST</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">UDCCS0</span> <span class="o">=</span> <span class="n">UDCCS0_FST</span><span class="o">|</span><span class="n">UDCCS0_FTF</span><span class="p">;</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERBOSE</span><span class="p">,</span> <span class="s">&quot;ep0 re-stall</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">start_watchdog</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">local_irq_enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_ep0</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>			<span class="n">udccs0</span> <span class="o">=</span> <span class="n">UDCCS0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxa25x_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pxa25x_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_ctrlrequest</span>	<span class="n">r</span><span class="p">;</span>
		<span class="n">u8</span>			<span class="n">raw</span> <span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="n">u32</span>			<span class="n">word</span> <span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa25x_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="cm">/* clear stall status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udccs0</span> <span class="o">&amp;</span> <span class="n">UDCCS0_SST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nuke</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">);</span>
		<span class="n">UDCCS0</span> <span class="o">=</span> <span class="n">UDCCS0_SST</span><span class="p">;</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">ep0_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* previous request unfinished?  non-error iff back-to-back ... */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">udccs0</span> <span class="o">&amp;</span> <span class="n">UDCCS0_SA</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">!=</span> <span class="n">EP0_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nuke</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">ep0_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EP0_IDLE</span>:
		<span class="cm">/* late-breaking status? */</span>
		<span class="n">udccs0</span> <span class="o">=</span> <span class="n">UDCCS0</span><span class="p">;</span>

		<span class="cm">/* start control request? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="n">udccs0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UDCCS0_OPR</span><span class="o">|</span><span class="n">UDCCS0_SA</span><span class="o">|</span><span class="n">UDCCS0_RNE</span><span class="p">))</span>
				<span class="o">==</span> <span class="p">(</span><span class="n">UDCCS0_OPR</span><span class="o">|</span><span class="n">UDCCS0_SA</span><span class="o">|</span><span class="n">UDCCS0_RNE</span><span class="p">)))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">nuke</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">);</span>

			<span class="cm">/* read SETUP packet */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">UDCCS0</span> <span class="o">&amp;</span> <span class="n">UDCCS0_RNE</span><span class="p">)))</span> <span class="p">{</span>
<span class="nl">bad_setup:</span>
					<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;SETUP %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">u</span><span class="p">.</span><span class="n">raw</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">UDDR0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">UDCCS0</span> <span class="o">&amp;</span> <span class="n">UDCCS0_RNE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">bad_setup</span><span class="p">;</span>

<span class="nl">got_setup:</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERBOSE</span><span class="p">,</span> <span class="s">&quot;SETUP %02x.%02x v%04x i%04x l%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequest</span><span class="p">,</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wValue</span><span class="p">),</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wIndex</span><span class="p">),</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wLength</span><span class="p">));</span>

			<span class="cm">/* cope with automagic for some standard requests. */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_std</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_TYPE_MASK</span><span class="p">)</span>
						<span class="o">==</span> <span class="n">USB_TYPE_STANDARD</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequest</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* hardware restricts gadget drivers here! */</span>
			<span class="k">case</span> <span class="n">USB_REQ_SET_CONFIGURATION</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">==</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* reflect hardware&#39;s automagic</span>
<span class="cm">					 * up to the gadget driver.</span>
<span class="cm">					 */</span>
<span class="nl">config_change:</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_config</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">clear_ep_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="cm">/* if !has_cfr, there&#39;s no synch</span>
<span class="cm">					 * else use AREN (later) not SA|OPR</span>
<span class="cm">					 * USIR0_IR0 acts edge sensitive</span>
<span class="cm">					 */</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* ... and here, even more ... */</span>
			<span class="k">case</span> <span class="n">USB_REQ_SET_INTERFACE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">==</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* udc hardware is broken by design:</span>
<span class="cm">					 *  - altsetting may only be zero;</span>
<span class="cm">					 *  - hw resets all interfaces&#39; eps;</span>
<span class="cm">					 *  - ep reset doesn&#39;t include halt(?).</span>
<span class="cm">					 */</span>
					<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;broken set_interface (%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wIndex</span><span class="p">),</span>
						<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wValue</span><span class="p">));</span>
					<span class="k">goto</span> <span class="n">config_change</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* hardware was supposed to hide this */</span>
			<span class="k">case</span> <span class="n">USB_REQ_SET_ADDRESS</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">==</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ep0start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;address&quot;</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_IN_DATA_PHASE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_OUT_DATA_PHASE</span><span class="p">;</span>

			<span class="n">i</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* hardware automagic preventing STALL... */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_config</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* hardware sometimes neglects to tell</span>
<span class="cm">					 * tell us about config change events,</span>
<span class="cm">					 * so later ones may fail...</span>
<span class="cm">					 */</span>
					<span class="n">WARNING</span><span class="p">(</span><span class="s">&quot;config change %02x fail %d?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequest</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
					<span class="cm">/* TODO experiment:  if has_cfr,</span>
<span class="cm">					 * hardware didn&#39;t ACK; maybe we</span>
<span class="cm">					 * could actually STALL!</span>
<span class="cm">					 */</span>
				<span class="p">}</span>
				<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERBOSE</span><span class="p">,</span> <span class="s">&quot;protocol STALL, &quot;</span>
					<span class="s">&quot;%02x err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">UDCCS0</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="nl">stall:</span>
				<span class="cm">/* the watchdog timer helps deal with cases</span>
<span class="cm">				 * where udc seems to clear FST wrongly, and</span>
<span class="cm">				 * then NAKs instead of STALLing.</span>
<span class="cm">				 */</span>
				<span class="n">ep0start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">UDCCS0_FST</span><span class="o">|</span><span class="n">UDCCS0_FTF</span><span class="p">,</span> <span class="s">&quot;stall&quot;</span><span class="p">);</span>
				<span class="n">start_watchdog</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_STALL</span><span class="p">;</span>

			<span class="cm">/* deferred i/o == no response yet */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_pending</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">==</span> <span class="n">EP0_IN_DATA_PHASE</span>
						<span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_std</span> <span class="o">||</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wLength</span><span class="p">))</span>
					<span class="n">ep0start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;defer&quot;</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">ep0start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">UDCCS0_IPR</span><span class="p">,</span> <span class="s">&quot;defer/IPR&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* expect at least one data or status stage irq */</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="n">udccs0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UDCCS0_OPR</span><span class="o">|</span><span class="n">UDCCS0_SA</span><span class="p">))</span>
				<span class="o">==</span> <span class="p">(</span><span class="n">UDCCS0_OPR</span><span class="o">|</span><span class="n">UDCCS0_SA</span><span class="p">)))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

			<span class="cm">/* pxa210/250 erratum 131 for B0/B1 says RNE lies.</span>
<span class="cm">			 * still observed on a pxa255 a0.</span>
<span class="cm">			 */</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERBOSE</span><span class="p">,</span> <span class="s">&quot;e131</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">nuke</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">);</span>

			<span class="cm">/* read SETUP data, but don&#39;t trust it too much */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">u</span><span class="p">.</span><span class="n">raw</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">UDDR0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_RECIP_MASK</span><span class="p">)</span>
					<span class="o">&gt;</span> <span class="n">USB_RECIP_OTHER</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">word</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">u</span><span class="p">.</span><span class="n">word</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">got_setup</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* some random early IRQ:</span>
<span class="cm">			 * - we acked FST</span>
<span class="cm">			 * - IPR cleared</span>
<span class="cm">			 * - OPR got set, without SA (likely status stage)</span>
<span class="cm">			 */</span>
			<span class="n">UDCCS0</span> <span class="o">=</span> <span class="n">udccs0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UDCCS0_SA</span><span class="o">|</span><span class="n">UDCCS0_OPR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EP0_IN_DATA_PHASE</span>:			<span class="cm">/* GET_DESCRIPTOR etc */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udccs0</span> <span class="o">&amp;</span> <span class="n">UDCCS0_OPR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">UDCCS0</span> <span class="o">=</span> <span class="n">UDCCS0_OPR</span><span class="o">|</span><span class="n">UDCCS0_FTF</span><span class="p">;</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERBOSE</span><span class="p">,</span> <span class="s">&quot;ep0in premature status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span>
				<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ep0_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="cm">/* irq was IPR clearing */</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* this IN packet might finish the request */</span>
				<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">write_ep0_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="p">}</span> <span class="cm">/* else IN token before response was written */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EP0_OUT_DATA_PHASE</span>:		<span class="cm">/* SET_DESCRIPTOR etc */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udccs0</span> <span class="o">&amp;</span> <span class="n">UDCCS0_OPR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* this OUT packet might finish the request */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">read_ep0_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span>
					<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="cm">/* else more OUT packets expected */</span>
			<span class="p">}</span> <span class="cm">/* else OUT token before read was issued */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="cm">/* irq was IPR clearing */</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERBOSE</span><span class="p">,</span> <span class="s">&quot;ep0out premature status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span>
				<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ep0_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EP0_END_XFER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span>
			<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* ack control-IN status (maybe in-zlp was skipped)</span>
<span class="cm">		 * also appears after some config change events.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udccs0</span> <span class="o">&amp;</span> <span class="n">UDCCS0_OPR</span><span class="p">)</span>
			<span class="n">UDCCS0</span> <span class="o">=</span> <span class="n">UDCCS0_OPR</span><span class="p">;</span>
		<span class="n">ep0_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EP0_STALL</span>:
		<span class="n">UDCCS0</span> <span class="o">=</span> <span class="n">UDCCS0_FST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">USIR0</span> <span class="o">=</span> <span class="n">USIR0_IR0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa25x_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">is_in</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">completed</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">udccs</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">completed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)))</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">pxa25x_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>TODO check FST handling</p></td><td class="code"><div class="highlight"><pre>		<span class="n">udccs</span> <span class="o">=</span> <span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_udccs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">is_in</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* irq from TPC, SST, or (ISO) TUR */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">UDCCS_BI_TUR</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">))</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">UDCCS_BI_SST</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">udccs</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
				<span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_udccs</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="n">likely</span> <span class="p">((</span><span class="n">udccs</span> <span class="o">&amp;</span> <span class="n">UDCCS_BI_TFS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">completed</span> <span class="o">=</span> <span class="n">write_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* irq from RPC (or for ISO, ROF) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">))</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">UDCCS_BO_SST</span> <span class="o">|</span> <span class="n">UDCCS_BO_DME</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">UDCCS_IO_ROF</span> <span class="o">|</span> <span class="n">UDCCS_IO_DME</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">udccs</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
				<span class="o">*</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_udccs</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

			<span class="cm">/* fifos can hold packets, ready for reading... */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">completed</span> <span class="o">=</span> <span class="n">read_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">pio_irq_disable</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">pio_irqs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">completed</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	pxa25x_udc_irq - interrupt handler</span>
<span class="cm"> *</span>
<span class="cm"> * avoid delays in ep0 processing. the control handshaking isn&#39;t always</span>
<span class="cm"> * under software control (pxa250c0 and the pxa255 are better), and delays</span>
<span class="cm"> * could cause usb protocol errors.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">pxa25x_udc_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_udc</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">_dev</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">handled</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">u32</span>		<span class="n">udccr</span> <span class="o">=</span> <span class="n">UDCCR</span><span class="p">;</span>

		<span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* SUSpend Interrupt Request */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">udccr</span> <span class="o">&amp;</span> <span class="n">UDCCR_SUSIR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">udc_ack_int_UDCCR</span><span class="p">(</span><span class="n">UDCCR_SUSIR</span><span class="p">);</span>
			<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERBOSE</span><span class="p">,</span> <span class="s">&quot;USB suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_UNKNOWN</span>
					<span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span>
					<span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
			<span class="n">ep0_idle</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* RESume Interrupt Request */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">udccr</span> <span class="o">&amp;</span> <span class="n">UDCCR_RESIR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">udc_ack_int_UDCCR</span><span class="p">(</span><span class="n">UDCCR_RESIR</span><span class="p">);</span>
			<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERBOSE</span><span class="p">,</span> <span class="s">&quot;USB resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_UNKNOWN</span>
					<span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span>
					<span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* ReSeT Interrupt Request - USB reset */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">udccr</span> <span class="o">&amp;</span> <span class="n">UDCCR_RSTIR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">udc_ack_int_UDCCR</span><span class="p">(</span><span class="n">UDCCR_RSTIR</span><span class="p">);</span>
			<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">UDCCR</span> <span class="o">&amp;</span> <span class="n">UDCCR_UDA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERBOSE</span><span class="p">,</span> <span class="s">&quot;USB reset start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="cm">/* reset driver and endpoints,</span>
<span class="cm">				 * in case that&#39;s not yet done</span>
<span class="cm">				 */</span>
				<span class="n">stop_activity</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERBOSE</span><span class="p">,</span> <span class="s">&quot;USB reset end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>
				<span class="cm">/* driver and endpoints are still reset */</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">usir0</span> <span class="o">=</span> <span class="n">USIR0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UICR0</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">usir1</span> <span class="o">=</span> <span class="n">USIR1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UICR1</span><span class="p">;</span>
			<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="o">!</span><span class="n">usir0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">usir1</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">DBG</span><span class="p">(</span><span class="n">DBG_VERY_NOISY</span><span class="p">,</span> <span class="s">&quot;irq %02x.%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usir1</span><span class="p">,</span> <span class="n">usir0</span><span class="p">);</span>

			<span class="cm">/* control traffic */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">usir0</span> <span class="o">&amp;</span> <span class="n">USIR0_IR0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pio_irqs</span><span class="o">++</span><span class="p">;</span>
				<span class="n">handle_ep0</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* endpoint data transfers */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span>	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">usir0</span> <span class="o">&amp;</span> <span class="n">tmp</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">handle_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
					<span class="n">USIR0</span> <span class="o">|=</span> <span class="n">tmp</span><span class="p">;</span>
					<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
<span class="cp">#ifndef	CONFIG_USB_PXA25X_SMALL</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">usir1</span> <span class="o">&amp;</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">handle_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]);</span>
					<span class="n">USIR1</span> <span class="o">|=</span> <span class="n">tmp</span><span class="p">;</span>
					<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* we could also ask for 1 msec SOF (SIR) interrupts */</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">handled</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nop_release</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DMSG</span><span class="p">(</span><span class="s">&quot;%s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* this uses load-time allocation and initialization (instead of</span>
<span class="cm"> * doing it at run-time) to save code, eliminate fault paths, and</span>
<span class="cm"> * be more obviously correct.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pxa25x_udc</span> <span class="n">memory</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gadget</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa25x_udc_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ep0</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">driver_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">init_name</span>	<span class="o">=</span> <span class="s">&quot;gadget&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">nop_release</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>

	<span class="cm">/* control endpoint */</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">ep0name</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa25x_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="n">EP0_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_udccs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDCCS0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_uddr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDDR0</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="cm">/* first group of endpoints */</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep1in-bulk&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa25x_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="n">BULK_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="n">BULK_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>	<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_udccs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDCCS1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_uddr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDDR1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep2out-bulk&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa25x_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="n">BULK_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="n">BULK_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>	<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_udccs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDCCS2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_ubcr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UBCR2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_uddr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDDR2</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#ifndef CONFIG_USB_PXA25X_SMALL</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep3in-iso&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa25x_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="n">ISO_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="n">ISO_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>	<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_udccs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDCCS3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_uddr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDDR3</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep4out-iso&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa25x_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="n">ISO_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="n">ISO_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>	<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_udccs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDCCS4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_ubcr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UBCR4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_uddr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDDR4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep5in-int&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa25x_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="n">INT_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="n">INT_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>	<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_udccs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDCCS5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_uddr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDDR5</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="cm">/* second group of endpoints */</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep6in-bulk&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa25x_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="n">BULK_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="n">BULK_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>	<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_udccs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDCCS6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_uddr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDDR6</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep7out-bulk&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa25x_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="n">BULK_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="n">BULK_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>	<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_udccs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDCCS7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_ubcr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UBCR7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_uddr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDDR7</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep8in-iso&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa25x_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="n">ISO_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="n">ISO_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>	<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_udccs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDCCS8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_uddr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDDR8</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep9out-iso&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa25x_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="n">ISO_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="n">ISO_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>	<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_udccs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDCCS9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_ubcr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UBCR9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_uddr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDDR9</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep10in-int&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa25x_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="n">INT_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="n">INT_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>	<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_udccs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDCCS10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_uddr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDDR10</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="cm">/* third group of endpoints */</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep11in-bulk&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa25x_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="n">BULK_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="n">BULK_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="mi">11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>	<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_udccs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDCCS11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_uddr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDDR11</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep12out-bulk&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa25x_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="n">BULK_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="n">BULK_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>	<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_udccs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDCCS12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_ubcr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UBCR12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_uddr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDDR12</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep13in-iso&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa25x_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="n">ISO_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="n">ISO_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="mi">13</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>	<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_udccs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDCCS13</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_uddr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDDR13</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep14out-iso&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa25x_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="n">ISO_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="n">ISO_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>	<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_udccs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDCCS14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_ubcr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UBCR14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_uddr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDDR14</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep15in-int&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa25x_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="n">INT_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifo_size</span>	<span class="o">=</span> <span class="n">INT_FIFO_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="mi">15</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>	<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_udccs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDCCS15</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_uddr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">UDDR15</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* !CONFIG_USB_PXA25X_SMALL */</span><span class="cp"></span>
<span class="p">};</span>

<span class="cp">#define CP15R0_VENDOR_MASK	0xffffe000</span>

<span class="cp">#if	defined(CONFIG_ARCH_PXA)</span>
<span class="cp">#define CP15R0_XSCALE_VALUE	0x69052000	</span><span class="cm">/* intel/arm/xscale */</span><span class="cp"></span>

<span class="cp">#elif	defined(CONFIG_ARCH_IXP4XX)</span>
<span class="cp">#define CP15R0_XSCALE_VALUE	0x69054000	</span><span class="cm">/* intel/arm/ixp4xx */</span><span class="cp"></span>

<span class="cp">#endif</span>

<span class="cp">#define CP15R0_PROD_MASK	0x000003f0</span>
<span class="cp">#define PXA25x			0x00000100	</span><span class="cm">/* and PXA26x */</span><span class="cp"></span>
<span class="cp">#define PXA210			0x00000120</span>

<span class="cp">#define CP15R0_REV_MASK		0x0000000f</span>

<span class="cp">#define CP15R0_PRODREV_MASK	(CP15R0_PROD_MASK | CP15R0_REV_MASK)</span>

<span class="cp">#define PXA255_A0		0x00000106	</span><span class="cm">/* or PXA260_B1 */</span><span class="cp"></span>
<span class="cp">#define PXA250_C0		0x00000105	</span><span class="cm">/* or PXA26x_B0 */</span><span class="cp"></span>
<span class="cp">#define PXA250_B2		0x00000104</span>
<span class="cp">#define PXA250_B1		0x00000103	</span><span class="cm">/* or PXA260_A0 */</span><span class="cp"></span>
<span class="cp">#define PXA250_B0		0x00000102</span>
<span class="cp">#define PXA250_A1		0x00000101</span>
<span class="cp">#define PXA250_A0		0x00000100</span>

<span class="cp">#define PXA210_C0		0x00000125</span>
<span class="cp">#define PXA210_B2		0x00000124</span>
<span class="cp">#define PXA210_B1		0x00000123</span>
<span class="cp">#define PXA210_B0		0x00000122</span>
<span class="cp">#define IXP425_A0		0x000001c1</span>
<span class="cp">#define IXP425_B0		0x000001f1</span>
<span class="cp">#define IXP465_AD		0x00000200</span>

<span class="cm">/*</span>
<span class="cm"> *	probe - binds to the platform device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pxa25x_udc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_udc</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chiprev</span><span class="p">;</span>

	<span class="cm">/* insist on Intel/ARM/XScale */</span>
	<span class="n">asm</span><span class="p">(</span><span class="s">&quot;mrc%? p15, 0, %0, c0, c0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">chiprev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chiprev</span> <span class="o">&amp;</span> <span class="n">CP15R0_VENDOR_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CP15R0_XSCALE_VALUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: not XScale!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* trigger chiprev-specific logic */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">chiprev</span> <span class="o">&amp;</span> <span class="n">CP15R0_PRODREV_MASK</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if	defined(CONFIG_ARCH_PXA)</span>
	<span class="k">case</span> <span class="n">PXA255_A0</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_cfr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PXA250_A0</span>:
	<span class="k">case</span> <span class="n">PXA250_A1</span>:
		<span class="cm">/* A0/A1 &quot;not released&quot;; ep 13, 15 unusable */</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">PXA250_B2</span>: <span class="k">case</span> <span class="n">PXA210_B2</span>:
	<span class="k">case</span> <span class="n">PXA250_B1</span>: <span class="k">case</span> <span class="n">PXA210_B1</span>:
	<span class="k">case</span> <span class="n">PXA250_B0</span>: <span class="k">case</span> <span class="n">PXA210_B0</span>:
		<span class="cm">/* OUT-DMA is broken ... */</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">PXA250_C0</span>: <span class="k">case</span> <span class="n">PXA210_C0</span>:
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#elif	defined(CONFIG_ARCH_IXP4XX)</span>
	<span class="k">case</span> <span class="n">IXP425_A0</span>:
	<span class="k">case</span> <span class="n">IXP425_B0</span>:
	<span class="k">case</span> <span class="n">IXP465_AD</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_cfr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: unrecognized processor: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">driver_name</span><span class="p">,</span> <span class="n">chiprev</span><span class="p">);</span>
		<span class="cm">/* iop3xx, ixp4xx, ... */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_clk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: IRQ %d%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_cfr</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; (!cfr)&quot;</span><span class="p">,</span>
		<span class="n">SIZE_STR</span> <span class="s">&quot;(pio)&quot;</span>
		<span class="p">);</span>

	<span class="cm">/* other non-static parts of init */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mach</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">usb_get_transceiver</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">gpio_pullup</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">gpio_pullup</span><span class="p">,</span>
				<span class="s">&quot;pca25x_udc GPIO PULLUP&quot;</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;can&#39;t get pullup gpio %d, err: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">gpio_pullup</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_gpio_pullup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">gpio_pullup</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">udc_watchdog</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">device_initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span><span class="p">;</span>

	<span class="n">the_controller</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">udc_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">udc_reinit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* irq setup after old hardware state is cleaned up */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">pxa25x_udc_irq</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t get irq %d, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">driver_name</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_irq1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">got_irq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ARCH_LUBBOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_lubbock</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">LUBBOCK_USB_DISC_IRQ</span><span class="p">,</span>
				<span class="n">lubbock_vbus_irq</span><span class="p">,</span>
				<span class="n">IRQF_SAMPLE_RANDOM</span><span class="p">,</span>
				<span class="n">driver_name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t get irq %i, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">driver_name</span><span class="p">,</span> <span class="n">LUBBOCK_USB_DISC_IRQ</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_irq_lub</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">LUBBOCK_USB_IRQ</span><span class="p">,</span>
				<span class="n">lubbock_vbus_irq</span><span class="p">,</span>
				<span class="n">IRQF_SAMPLE_RANDOM</span><span class="p">,</span>
				<span class="n">driver_name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t get irq %i, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">driver_name</span><span class="p">,</span> <span class="n">LUBBOCK_USB_IRQ</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">lubbock_fail0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="n">create_debug_files</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_add_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">remove_debug_files</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef	CONFIG_ARCH_LUBBOCK</span>
<span class="nl">lubbock_fail0:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">LUBBOCK_USB_DISC_IRQ</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
 <span class="nl">err_irq_lub:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>
 <span class="nl">err_irq1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">gpio_pullup</span><span class="p">))</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">gpio_pullup</span><span class="p">);</span>
 <span class="nl">err_gpio_pullup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_put_transceiver</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
 <span class="nl">err_clk:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pxa25x_udc_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pullup_off</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">pxa25x_udc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_udc</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">usb_del_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pullup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pullup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">remove_debug_files</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">got_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">got_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_ARCH_LUBBOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_lubbock</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">LUBBOCK_USB_DISC_IRQ</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">LUBBOCK_USB_IRQ</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">gpio_pullup</span><span class="p">))</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">gpio_pullup</span><span class="p">);</span>

	<span class="n">clk_put</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_put_transceiver</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">the_controller</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#ifdef	CONFIG_PM</span>

<span class="cm">/* USB suspend (controlled by the host) and system suspend (controlled</span>
<span class="cm"> * by the PXA) don&#39;t necessarily work well together.  If USB is active,</span>
<span class="cm"> * the 48 MHz clock is required; so the system can&#39;t enter 33 MHz idle</span>
<span class="cm"> * mode, or any deeper PM saving state.</span>
<span class="cm"> *</span>
<span class="cm"> * For now, we punt and forcibly disconnect from the USB host when PXA</span>
<span class="cm"> * enters any suspend state.  While we&#39;re disconnected, we always disable</span>
<span class="cm"> * the 48MHz USB clock ... allowing PXA sleep and/or 33 MHz idle states.</span>
<span class="cm"> * Boards without software pullup control shouldn&#39;t use those states.</span>
<span class="cm"> * VBUS IRQs should probably be ignored so that the PXA device just acts</span>
<span class="cm"> * &quot;dead&quot; to USB hosts until system resume.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa25x_udc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_udc</span>	<span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">gpio_pullup</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">mach</span><span class="o">-&gt;</span><span class="n">udc_command</span><span class="p">)</span>
		<span class="n">WARNING</span><span class="p">(</span><span class="s">&quot;USB host won&#39;t detect disconnect!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">pullup</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa25x_udc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa25x_udc</span>	<span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">pullup</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define	pxa25x_udc_suspend	NULL</span>
<span class="cp">#define	pxa25x_udc_resume	NULL</span>
<span class="cp">#endif</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">udc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">pxa25x_udc_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">pxa25x_udc_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">pxa25x_udc_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">pxa25x_udc_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;pxa25x-udc&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">udc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">DRIVER_VERSION</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_driver</span><span class="p">,</span> <span class="n">pxa25x_udc_probe</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">udc_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">udc_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">udc_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Frank Becker, Robert Schwebel, David Brownell&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:pxa25x-udc&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
