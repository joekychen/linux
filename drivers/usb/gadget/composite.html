<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › gadget › composite.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>composite.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * composite.c - infrastructure for Composite USB Gadgets</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006-2008 David Brownell</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cm">/* #define VERBOSE_DEBUG */</span>

<span class="cp">#include &lt;linux/kallsyms.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/utsname.h&gt;</span>

<span class="cp">#include &lt;linux/usb/composite.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * The code in this file is utility code, used to build a gadget driver</span>
<span class="cm"> * from one or more &quot;function&quot; drivers, one or more &quot;configuration&quot;</span>
<span class="cm"> * objects, and a &quot;usb_composite_driver&quot; by gluing them together along</span>
<span class="cm"> * with the relevant device-wide data.</span>
<span class="cm"> */</span>

<span class="cm">/* big enough to hold our biggest descriptor */</span>
<span class="cp">#define USB_BUFSIZ	1024</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_composite_driver</span> <span class="o">*</span><span class="n">composite</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">composite_gadget_bind</span><span class="p">)(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">);</span>

<span class="cm">/* Some systems will need runtime overrides for the  product identifiers</span>
<span class="cm"> * published in the device descriptor, either numbers or strings or both.</span>
<span class="cm"> * String parameters are in UTF-8 (superset of ASCII&#39;s 7 bit characters).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">ushort</span> <span class="n">idVendor</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">idVendor</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">idVendor</span><span class="p">,</span> <span class="s">&quot;USB Vendor ID&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">ushort</span> <span class="n">idProduct</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">idProduct</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">idProduct</span><span class="p">,</span> <span class="s">&quot;USB Product ID&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">ushort</span> <span class="n">bcdDevice</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">bcdDevice</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bcdDevice</span><span class="p">,</span> <span class="s">&quot;USB Device version (BCD)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">iManufacturer</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">iManufacturer</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">iManufacturer</span><span class="p">,</span> <span class="s">&quot;USB Manufacturer string&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">iProduct</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">iProduct</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">iProduct</span><span class="p">,</span> <span class="s">&quot;USB Product string&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">iSerialNumber</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">iSerialNumber</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">iSerialNumber</span><span class="p">,</span> <span class="s">&quot;SerialNumber string&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">composite_manufacturer</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>
<span class="cm">/**</span>
<span class="cm"> * next_ep_desc() - advance to the next EP descriptor</span>
<span class="cm"> * @t: currect pointer within descriptor array</span>
<span class="cm"> *</span>
<span class="cm"> * Return: next EP descriptor or NULL</span>
<span class="cm"> *</span>
<span class="cm"> * Iterate over @t until either EP descriptor found or</span>
<span class="cm"> * NULL (that indicates end of list) encountered</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_descriptor_header</span><span class="o">**</span>
<span class="nf">next_ep_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">**</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">==</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">t</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * for_each_ep_desc()- iterate over endpoint descriptors in the</span>
<span class="cm"> *		descriptors list</span>
<span class="cm"> * @start:	pointer within descriptor array.</span>
<span class="cm"> * @ep_desc:	endpoint descriptor to use as the loop cursor</span>
<span class="cm"> */</span>
<span class="cp">#define for_each_ep_desc(start, ep_desc) \</span>
<span class="cp">	for (ep_desc = next_ep_desc(start); \</span>
<span class="cp">	      ep_desc; ep_desc = next_ep_desc(ep_desc+1))</span>

<span class="cm">/**</span>
<span class="cm"> * config_ep_by_speed() - configures the given endpoint</span>
<span class="cm"> * according to gadget speed.</span>
<span class="cm"> * @g: pointer to the gadget</span>
<span class="cm"> * @f: usb function</span>
<span class="cm"> * @_ep: the endpoint to configure</span>
<span class="cm"> *</span>
<span class="cm"> * Return: error code, 0 on success</span>
<span class="cm"> *</span>
<span class="cm"> * This function chooses the right descriptors for a given</span>
<span class="cm"> * endpoint according to gadget speed and saves it in the</span>
<span class="cm"> * endpoint desc field. If the endpoint already has a descriptor</span>
<span class="cm"> * assigned to it - overwrites it with currently corresponding</span>
<span class="cm"> * descriptor. The endpoint maxpacket field is updated according</span>
<span class="cm"> * to the chosen descriptor.</span>
<span class="cm"> * Note: the supplied function should hold all the descriptors</span>
<span class="cm"> * for supported speeds</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">config_ep_by_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">chosen_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">**</span><span class="n">speed_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">usb_ss_ep_comp_descriptor</span> <span class="o">*</span><span class="n">comp_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">want_comp_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">**</span><span class="n">d_spd</span><span class="p">;</span> <span class="cm">/* cursor for speed desc */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g</span> <span class="o">||</span> <span class="o">!</span><span class="n">f</span> <span class="o">||</span> <span class="o">!</span><span class="n">_ep</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* select desired speed */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_SPEED_SUPER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">gadget_is_superspeed</span><span class="p">(</span><span class="n">g</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">speed_desc</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">ss_descriptors</span><span class="p">;</span>
			<span class="n">want_comp_desc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* else: Fall trough */</span>
	<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">gadget_is_dualspeed</span><span class="p">(</span><span class="n">g</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">speed_desc</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">hs_descriptors</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* else: fall through */</span>
	<span class="nl">default:</span>
		<span class="n">speed_desc</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">descriptors</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* find descriptors */</span>
	<span class="n">for_each_ep_desc</span><span class="p">(</span><span class="n">speed_desc</span><span class="p">,</span> <span class="n">d_spd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chosen_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">d_spd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chosen_desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">==</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ep_found</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">ep_found:</span>
	<span class="cm">/* commit results */</span>
	<span class="n">_ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">chosen_desc</span><span class="p">);</span>
	<span class="n">_ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">chosen_desc</span><span class="p">;</span>
	<span class="n">_ep</span><span class="o">-&gt;</span><span class="n">comp_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">_ep</span><span class="o">-&gt;</span><span class="n">maxburst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">_ep</span><span class="o">-&gt;</span><span class="n">mult</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">want_comp_desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Companion descriptor should follow EP descriptor</span>
<span class="cm">	 * USB 3.0 spec, #9.6.7</span>
<span class="cm">	 */</span>
	<span class="n">comp_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ss_ep_comp_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">++</span><span class="n">d_spd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">comp_desc</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">comp_desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">!=</span> <span class="n">USB_DT_SS_ENDPOINT_COMP</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">_ep</span><span class="o">-&gt;</span><span class="n">comp_desc</span> <span class="o">=</span> <span class="n">comp_desc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_SUPER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">usb_endpoint_type</span><span class="p">(</span><span class="n">_ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>:
			<span class="cm">/* mult: bits 1:0 of bmAttributes */</span>
			<span class="n">_ep</span><span class="o">-&gt;</span><span class="n">mult</span> <span class="o">=</span> <span class="n">comp_desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>:
		<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:
			<span class="n">_ep</span><span class="o">-&gt;</span><span class="n">maxburst</span> <span class="o">=</span> <span class="n">comp_desc</span><span class="o">-&gt;</span><span class="n">bMaxBurst</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* Do nothing for control endpoints */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * usb_add_function() - add a function to a configuration</span>
<span class="cm"> * @config: the configuration</span>
<span class="cm"> * @function: the function being added</span>
<span class="cm"> * Context: single threaded during gadget setup</span>
<span class="cm"> *</span>
<span class="cm"> * After initialization, each configuration must have one or more</span>
<span class="cm"> * functions added to it.  Adding a function involves calling its @bind()</span>
<span class="cm"> * method to allocate resources such as interface and string identifiers</span>
<span class="cm"> * and endpoints.</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns the value of the function&#39;s bind(), which is</span>
<span class="cm"> * zero for success else a negative errno value.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usb_add_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;adding &#39;%s&#39;/%p to config &#39;%s&#39;/%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">function</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">function</span><span class="o">-&gt;</span><span class="n">set_alt</span> <span class="o">||</span> <span class="o">!</span><span class="n">function</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">function</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">function</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">);</span>

	<span class="cm">/* REVISIT *require* function-&gt;bind? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">function</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">function</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">function</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">function</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We allow configurations that don&#39;t work at both speeds.</span>
<span class="cm">	 * If we run into a lowspeed Linux system, treat it the same</span>
<span class="cm">	 * as full speed ... it&#39;s the function drivers that will need</span>
<span class="cm">	 * to avoid bulk and ISO transfers.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">fullspeed</span> <span class="o">&amp;&amp;</span> <span class="n">function</span><span class="o">-&gt;</span><span class="n">descriptors</span><span class="p">)</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">fullspeed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">highspeed</span> <span class="o">&amp;&amp;</span> <span class="n">function</span><span class="o">-&gt;</span><span class="n">hs_descriptors</span><span class="p">)</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">highspeed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">superspeed</span> <span class="o">&amp;&amp;</span> <span class="n">function</span><span class="o">-&gt;</span><span class="n">ss_descriptors</span><span class="p">)</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">superspeed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;adding &#39;%s&#39;/%p --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">function</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * usb_function_deactivate - prevent function and gadget enumeration</span>
<span class="cm"> * @function: the function that isn&#39;t yet ready to respond</span>
<span class="cm"> *</span>
<span class="cm"> * Blocks response of the gadget driver to host enumeration by</span>
<span class="cm"> * preventing the data line pullup from being activated.  This is</span>
<span class="cm"> * normally called during @bind() processing to change from the</span>
<span class="cm"> * initial &quot;ready to respond&quot; state, or when a required resource</span>
<span class="cm"> * becomes available.</span>
<span class="cm"> *</span>
<span class="cm"> * For example, drivers that serve as a passthrough to a userspace</span>
<span class="cm"> * daemon can block enumeration unless that daemon (such as an OBEX,</span>
<span class="cm"> * MTP, or print server) is ready to handle host requests.</span>
<span class="cm"> *</span>
<span class="cm"> * Not all systems support software control of their USB peripheral</span>
<span class="cm"> * data pullups.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success, else negative errno.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usb_function_deactivate</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span>	<span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">function</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">deactivations</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_gadget_disconnect</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">deactivations</span><span class="o">++</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * usb_function_activate - allow function and gadget enumeration</span>
<span class="cm"> * @function: function on which usb_function_activate() was called</span>
<span class="cm"> *</span>
<span class="cm"> * Reverses effect of usb_function_deactivate().  If no more functions</span>
<span class="cm"> * are delaying their activation, the gadget driver will respond to</span>
<span class="cm"> * host enumeration procedures.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success, else negative errno.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usb_function_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span>	<span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">function</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">deactivations</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">deactivations</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">deactivations</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">usb_gadget_connect</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * usb_interface_id() - allocate an unused interface ID</span>
<span class="cm"> * @config: configuration associated with the interface</span>
<span class="cm"> * @function: function handling the interface</span>
<span class="cm"> * Context: single threaded during gadget setup</span>
<span class="cm"> *</span>
<span class="cm"> * usb_interface_id() is called from usb_function.bind() callbacks to</span>
<span class="cm"> * allocate new interface IDs.  The function driver will then store that</span>
<span class="cm"> * ID in interface, association, CDC union, and other descriptors.  It</span>
<span class="cm"> * will also handle any control requests targeted at that interface,</span>
<span class="cm"> * particularly changing its altsetting via set_alt().  There may</span>
<span class="cm"> * also be class-specific or vendor-specific requests to handle.</span>
<span class="cm"> *</span>
<span class="cm"> * All interface identifier should be allocated using this routine, to</span>
<span class="cm"> * ensure that for example different functions don&#39;t wrongly assign</span>
<span class="cm"> * different meanings to the same identifier.  Note that since interface</span>
<span class="cm"> * identifiers are configuration-specific, functions used in more than</span>
<span class="cm"> * one configuration (or more than once in a given configuration) need</span>
<span class="cm"> * multiple versions of the relevant descriptors.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the interface ID which was allocated; or -ENODEV if no</span>
<span class="cm"> * more interface IDs can be allocated.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usb_interface_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">id</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">next_interface_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">MAX_CONFIG_INTERFACES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">function</span><span class="p">;</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">next_interface_id</span> <span class="o">=</span> <span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">config_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">usb_device_speed</span> <span class="n">speed</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_config_descriptor</span>	<span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">void</span>				<span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">USB_DT_CONFIG_SIZE</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">len</span> <span class="o">=</span> <span class="n">USB_BUFSIZ</span> <span class="o">-</span> <span class="n">USB_DT_CONFIG_SIZE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_function</span>		<span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">status</span><span class="p">;</span>

	<span class="cm">/* write the config descriptor */</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">bLength</span> <span class="o">=</span> <span class="n">USB_DT_CONFIG_SIZE</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="cm">/* wTotalLength is written later */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">bNumInterfaces</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">next_interface_id</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">bConfigurationValue</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">bConfigurationValue</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">iConfiguration</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">iConfiguration</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="n">USB_CONFIG_ATT_ONE</span> <span class="o">|</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">bmAttributes</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">bMaxPower</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">bMaxPower</span> <span class="o">?</span> <span class="o">:</span> <span class="p">(</span><span class="n">CONFIG_USB_GADGET_VBUS_DRAW</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* There may be e.g. OTG descriptors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">descriptors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_descriptor_fillbuf</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				<span class="n">config</span><span class="o">-&gt;</span><span class="n">descriptors</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* add each function&#39;s descriptors */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">**</span><span class="n">descriptors</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_SPEED_SUPER</span>:
			<span class="n">descriptors</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">ss_descriptors</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
			<span class="n">descriptors</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">hs_descriptors</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">descriptors</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">descriptors</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">descriptors</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_descriptor_fillbuf</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			<span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">**</span><span class="p">)</span> <span class="n">descriptors</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">next</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">wTotalLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">config_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">w_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span>		<span class="o">*</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_configuration</span>	<span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="n">type</span> <span class="o">=</span> <span class="n">w_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">usb_device_speed</span>		<span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_SUPER</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">gadget</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gadget_is_dualspeed</span><span class="p">(</span><span class="n">gadget</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">hs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span>
			<span class="n">hs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_DT_OTHER_SPEED_CONFIG</span><span class="p">)</span>
			<span class="n">hs</span> <span class="o">=</span> <span class="o">!</span><span class="n">hs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hs</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/* This is a lookup by config *INDEX* */</span>
	<span class="n">w_value</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">configs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ignore configs that won&#39;t work at this speed */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_SPEED_SUPER</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">superspeed</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">highspeed</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">fullspeed</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">w_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">config_buf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="n">w_value</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">count_configs</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span>		<span class="o">*</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_configuration</span>	<span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">hs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">ss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gadget_is_dualspeed</span><span class="p">(</span><span class="n">gadget</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span>
			<span class="n">hs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_SUPER</span><span class="p">)</span>
			<span class="n">ss</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_DT_DEVICE_QUALIFIER</span><span class="p">)</span>
			<span class="n">hs</span> <span class="o">=</span> <span class="o">!</span><span class="n">hs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">configs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ignore configs that won&#39;t work at this speed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">superspeed</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hs</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">highspeed</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">fullspeed</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bos_desc() - prepares the BOS descriptor.</span>
<span class="cm"> * @cdev: pointer to usb_composite device to generate the bos</span>
<span class="cm"> *	descriptor for</span>
<span class="cm"> *</span>
<span class="cm"> * This function generates the BOS (Binary Device Object)</span>
<span class="cm"> * descriptor and its device capabilities descriptors. The BOS</span>
<span class="cm"> * descriptor should be supported by a SuperSpeed device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bos_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_ext_cap_descriptor</span>	<span class="o">*</span><span class="n">usb_ext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_ss_cap_descriptor</span>	<span class="o">*</span><span class="n">ss_cap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_dcd_config_params</span>	<span class="n">dcd_config_params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_bos_descriptor</span>	<span class="o">*</span><span class="n">bos</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">bos</span><span class="o">-&gt;</span><span class="n">bLength</span> <span class="o">=</span> <span class="n">USB_DT_BOS_SIZE</span><span class="p">;</span>
	<span class="n">bos</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_BOS</span><span class="p">;</span>

	<span class="n">bos</span><span class="o">-&gt;</span><span class="n">wTotalLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">USB_DT_BOS_SIZE</span><span class="p">);</span>
	<span class="n">bos</span><span class="o">-&gt;</span><span class="n">bNumDeviceCaps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * A SuperSpeed device shall include the USB2.0 extension descriptor</span>
<span class="cm">	 * and shall support LPM when operating in USB2.0 HS mode.</span>
<span class="cm">	 */</span>
	<span class="n">usb_ext</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bos</span><span class="o">-&gt;</span><span class="n">wTotalLength</span><span class="p">);</span>
	<span class="n">bos</span><span class="o">-&gt;</span><span class="n">bNumDeviceCaps</span><span class="o">++</span><span class="p">;</span>
	<span class="n">le16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bos</span><span class="o">-&gt;</span><span class="n">wTotalLength</span><span class="p">,</span> <span class="n">USB_DT_USB_EXT_CAP_SIZE</span><span class="p">);</span>
	<span class="n">usb_ext</span><span class="o">-&gt;</span><span class="n">bLength</span> <span class="o">=</span> <span class="n">USB_DT_USB_EXT_CAP_SIZE</span><span class="p">;</span>
	<span class="n">usb_ext</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_DEVICE_CAPABILITY</span><span class="p">;</span>
	<span class="n">usb_ext</span><span class="o">-&gt;</span><span class="n">bDevCapabilityType</span> <span class="o">=</span> <span class="n">USB_CAP_TYPE_EXT</span><span class="p">;</span>
	<span class="n">usb_ext</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">USB_LPM_SUPPORT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The Superspeed USB Capability descriptor shall be implemented by all</span>
<span class="cm">	 * SuperSpeed devices.</span>
<span class="cm">	 */</span>
	<span class="n">ss_cap</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bos</span><span class="o">-&gt;</span><span class="n">wTotalLength</span><span class="p">);</span>
	<span class="n">bos</span><span class="o">-&gt;</span><span class="n">bNumDeviceCaps</span><span class="o">++</span><span class="p">;</span>
	<span class="n">le16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bos</span><span class="o">-&gt;</span><span class="n">wTotalLength</span><span class="p">,</span> <span class="n">USB_DT_USB_SS_CAP_SIZE</span><span class="p">);</span>
	<span class="n">ss_cap</span><span class="o">-&gt;</span><span class="n">bLength</span> <span class="o">=</span> <span class="n">USB_DT_USB_SS_CAP_SIZE</span><span class="p">;</span>
	<span class="n">ss_cap</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_DEVICE_CAPABILITY</span><span class="p">;</span>
	<span class="n">ss_cap</span><span class="o">-&gt;</span><span class="n">bDevCapabilityType</span> <span class="o">=</span> <span class="n">USB_SS_CAP_TYPE</span><span class="p">;</span>
	<span class="n">ss_cap</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* LTM is not supported yet */</span>
	<span class="n">ss_cap</span><span class="o">-&gt;</span><span class="n">wSpeedSupported</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">USB_LOW_SPEED_OPERATION</span> <span class="o">|</span>
				<span class="n">USB_FULL_SPEED_OPERATION</span> <span class="o">|</span>
				<span class="n">USB_HIGH_SPEED_OPERATION</span> <span class="o">|</span>
				<span class="n">USB_5GBPS_OPERATION</span><span class="p">);</span>
	<span class="n">ss_cap</span><span class="o">-&gt;</span><span class="n">bFunctionalitySupport</span> <span class="o">=</span> <span class="n">USB_LOW_SPEED_OPERATION</span><span class="p">;</span>

	<span class="cm">/* Get Controller configuration */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_config_params</span><span class="p">)</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_config_params</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcd_config_params</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dcd_config_params</span><span class="p">.</span><span class="n">bU1devExitLat</span> <span class="o">=</span> <span class="n">USB_DEFAULT_U1_DEV_EXIT_LAT</span><span class="p">;</span>
		<span class="n">dcd_config_params</span><span class="p">.</span><span class="n">bU2DevExitLat</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">USB_DEFAULT_U2_DEV_EXIT_LAT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ss_cap</span><span class="o">-&gt;</span><span class="n">bU1devExitLat</span> <span class="o">=</span> <span class="n">dcd_config_params</span><span class="p">.</span><span class="n">bU1devExitLat</span><span class="p">;</span>
	<span class="n">ss_cap</span><span class="o">-&gt;</span><span class="n">bU2DevExitLat</span> <span class="o">=</span> <span class="n">dcd_config_params</span><span class="p">.</span><span class="n">bU2DevExitLat</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bos</span><span class="o">-&gt;</span><span class="n">wTotalLength</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_qual</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_qualifier_descriptor</span>	<span class="o">*</span><span class="n">qual</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">qual</span><span class="o">-&gt;</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">qual</span><span class="p">);</span>
	<span class="n">qual</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_DEVICE_QUALIFIER</span><span class="p">;</span>
	<span class="cm">/* POLICY: same bcdUSB and device type info at both speeds */</span>
	<span class="n">qual</span><span class="o">-&gt;</span><span class="n">bcdUSB</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bcdUSB</span><span class="p">;</span>
	<span class="n">qual</span><span class="o">-&gt;</span><span class="n">bDeviceClass</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bDeviceClass</span><span class="p">;</span>
	<span class="n">qual</span><span class="o">-&gt;</span><span class="n">bDeviceSubClass</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bDeviceSubClass</span><span class="p">;</span>
	<span class="n">qual</span><span class="o">-&gt;</span><span class="n">bDeviceProtocol</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bDeviceProtocol</span><span class="p">;</span>
	<span class="cm">/* ASSUME same EP0 fifo size at both speeds */</span>
	<span class="n">qual</span><span class="o">-&gt;</span><span class="n">bMaxPacketSize0</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>
	<span class="n">qual</span><span class="o">-&gt;</span><span class="n">bNumConfigurations</span> <span class="o">=</span> <span class="n">count_configs</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">USB_DT_DEVICE_QUALIFIER</span><span class="p">);</span>
	<span class="n">qual</span><span class="o">-&gt;</span><span class="n">bRESERVED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_function</span>		<span class="o">*</span><span class="n">f</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;reset config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">)</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

		<span class="n">bitmap_zero</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">endpoints</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span>	<span class="o">*</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">power</span> <span class="o">=</span> <span class="n">gadget_is_otg</span><span class="p">(</span><span class="n">gadget</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">100</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">configs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bConfigurationValue</span> <span class="o">==</span> <span class="n">number</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * We disable the FDs of the previous</span>
<span class="cm">				 * configuration only if the new configuration</span>
<span class="cm">				 * is a valid one</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span>
					<span class="n">reset_config</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
				<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Zero configuration value - need to reset the config */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span>
			<span class="n">reset_config</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INFO</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;%s config #%d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">usb_speed_string</span><span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">),</span>
	     <span class="n">number</span><span class="p">,</span> <span class="n">c</span> <span class="o">?</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">label</span> <span class="o">:</span> <span class="s">&quot;unconfigured&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>

	<span class="cm">/* Initialize all interfaces by setting them to altsetting zero. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">MAX_CONFIG_INTERFACES</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_function</span>	<span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">[</span><span class="n">tmp</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">**</span><span class="n">descriptors</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Record which endpoints are used by the function. This is used</span>
<span class="cm">		 * to dispatch control requests targeted at that endpoint to the</span>
<span class="cm">		 * function&#39;s setup callback instead of the current</span>
<span class="cm">		 * configuration&#39;s setup callback.</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_SPEED_SUPER</span>:
			<span class="n">descriptors</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">ss_descriptors</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
			<span class="n">descriptors</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">hs_descriptors</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">descriptors</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">descriptors</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">descriptors</span><span class="p">;</span> <span class="o">++</span><span class="n">descriptors</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">descriptors</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">!=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ep</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">descriptors</span><span class="p">;</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span>
			     <span class="o">|</span>  <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">endpoints</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">set_alt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;interface %d (%s/%p) alt 0 --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">tmp</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

			<span class="n">reset_config</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">USB_GADGET_DELAYED_STATUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span>
			 <span class="s">&quot;%s: interface %d (%s) requested delayed status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">delayed_status</span><span class="o">++</span><span class="p">;</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;delayed_status count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">delayed_status</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* when we return, be sure our power usage is valid */</span>
	<span class="n">power</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bMaxPower</span> <span class="o">?</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bMaxPower</span><span class="p">)</span> <span class="o">:</span> <span class="n">CONFIG_USB_GADGET_VBUS_DRAW</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">usb_gadget_vbus_draw</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">delayed_status</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">USB_GADGET_DELAYED_STATUS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * usb_add_config() - add a configuration to a device.</span>
<span class="cm"> * @cdev: wraps the USB gadget</span>
<span class="cm"> * @config: the configuration, with bConfigurationValue assigned</span>
<span class="cm"> * @bind: the configuration&#39;s bind function</span>
<span class="cm"> * Context: single threaded during gadget setup</span>
<span class="cm"> *</span>
<span class="cm"> * One of the main tasks of a composite @bind() routine is to</span>
<span class="cm"> * add each of the configurations it supports, using this routine.</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns the value of the configuration&#39;s @bind(), which</span>
<span class="cm"> * is zero for success else a negative errno value.  Binding configurations</span>
<span class="cm"> * assigns global resources including string IDs, and per-configuration</span>
<span class="cm"> * resources such as interface IDs and endpoints.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usb_add_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bind</span><span class="p">)(</span><span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span>				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_configuration</span>	<span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;adding config #%u &#39;%s&#39;/%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">bConfigurationValue</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">bConfigurationValue</span> <span class="o">||</span> <span class="o">!</span><span class="n">bind</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* Prevent duplicate configuration identifiers */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">configs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bConfigurationValue</span> <span class="o">==</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">bConfigurationValue</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">config</span><span class="o">-&gt;</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">cdev</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">configs</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">);</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">next_interface_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">usb_function</span>		<span class="o">*</span><span class="n">f</span><span class="p">;</span>

			<span class="n">f</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">usb_function</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;unbind function &#39;%s&#39;/%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">f</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
				<span class="cm">/* may free memory for &quot;f&quot; */</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">cdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span>	<span class="n">i</span><span class="p">;</span>

		<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;cfg %d/%p speeds:%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">bConfigurationValue</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">superspeed</span> <span class="o">?</span> <span class="s">&quot; super&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">highspeed</span> <span class="o">?</span> <span class="s">&quot; high&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">fullspeed</span>
				<span class="o">?</span> <span class="p">(</span><span class="n">gadget_is_dualspeed</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">)</span>
					<span class="o">?</span> <span class="s">&quot; full&quot;</span>
					<span class="o">:</span> <span class="s">&quot; full/low&quot;</span><span class="p">)</span>
				<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CONFIG_INTERFACES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">usb_function</span>	<span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;  interface %d = %s/%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* set_alt(), or next bind(), sets up</span>
<span class="cm">	 * ep-&gt;driver_data as needed.</span>
<span class="cm">	 */</span>
	<span class="n">usb_ep_autoconfig_reset</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;added config &#39;%s&#39;/%u --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span>
				<span class="n">config</span><span class="o">-&gt;</span><span class="n">bConfigurationValue</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_function</span>		<span class="o">*</span><span class="n">f</span><span class="p">;</span>

		<span class="n">f</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">usb_function</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;unbind function &#39;%s&#39;/%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
			<span class="cm">/* may free memory for &quot;f&quot; */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;unbind config &#39;%s&#39;/%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
			<span class="cm">/* may free memory for &quot;c&quot; */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * usb_remove_config() - remove a configuration from a device.</span>
<span class="cm"> * @cdev: wraps the USB gadget</span>
<span class="cm"> * @config: the configuration</span>
<span class="cm"> *</span>
<span class="cm"> * Drivers must call usb_gadget_disconnect before calling this function</span>
<span class="cm"> * to disconnect the device from the host and make sure the host will not</span>
<span class="cm"> * try to enumerate the device while we are changing the config list.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">usb_remove_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">==</span> <span class="n">config</span><span class="p">)</span>
		<span class="n">reset_config</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">remove_config</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* We support strings in multiple languages ... string descriptor zero</span>
<span class="cm"> * says which languages are supported.  The typical case will be that</span>
<span class="cm"> * only one language (probably English) is used, with I18N handled on</span>
<span class="cm"> * the host side.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">collect_langs</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_strings</span> <span class="o">**</span><span class="n">sp</span><span class="p">,</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_gadget_strings</span>	<span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="n">__le16</span>				<span class="n">language</span><span class="p">;</span>
	<span class="n">__le16</span>				<span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
		<span class="n">language</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">language</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">126</span><span class="p">];</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">language</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">tmp</span><span class="o">++</span> <span class="o">=</span> <span class="n">language</span><span class="p">;</span>
<span class="nl">repeat:</span>
		<span class="n">sp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lookup_string</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">usb_gadget_strings</span>	<span class="o">**</span><span class="n">sp</span><span class="p">,</span>
	<span class="kt">void</span>				<span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="n">u16</span>				<span class="n">language</span><span class="p">,</span>
	<span class="kt">int</span>				<span class="n">id</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_gadget_strings</span>	<span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">value</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="o">*</span><span class="n">sp</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">language</span> <span class="o">!=</span> <span class="n">language</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">usb_gadget_get_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u16</span> <span class="n">language</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_configuration</span>	<span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_function</span>		<span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">len</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>			<span class="o">*</span><span class="n">str</span><span class="p">;</span>

	<span class="cm">/* Yes, not only is USB&#39;s I18N support probably more than most</span>
<span class="cm">	 * folk will ever care about ... also, it&#39;s all supported here.</span>
<span class="cm">	 * (Except for UTF8 support for Unicode&#39;s &quot;Astral Planes&quot;.)</span>
<span class="cm">	 */</span>

	<span class="cm">/* 0 == report all available language codes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_string_descriptor</span>	<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">usb_gadget_strings</span>	<span class="o">**</span><span class="n">sp</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_STRING</span><span class="p">;</span>

		<span class="n">sp</span> <span class="o">=</span> <span class="n">composite</span><span class="o">-&gt;</span><span class="n">strings</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span>
			<span class="n">collect_langs</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">wData</span><span class="p">);</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">configs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sp</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">strings</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span>
				<span class="n">collect_langs</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">wData</span><span class="p">);</span>

			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sp</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">strings</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span>
					<span class="n">collect_langs</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">wData</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">126</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">wData</span><span class="p">[</span><span class="n">len</span><span class="p">];</span> <span class="n">len</span><span class="o">++</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">bLength</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">bLength</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Otherwise, look up and return a specified string.  First</span>
<span class="cm">	 * check if the string has not been overridden.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">manufacturer_override</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">iManufacturer</span> <span class="o">?:</span> <span class="n">composite</span><span class="o">-&gt;</span><span class="n">iManufacturer</span> <span class="o">?:</span>
			<span class="n">composite_manufacturer</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">product_override</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">iProduct</span> <span class="o">?:</span> <span class="n">composite</span><span class="o">-&gt;</span><span class="n">iProduct</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">serial_override</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">iSerialNumber</span> <span class="o">?:</span> <span class="n">composite</span><span class="o">-&gt;</span><span class="n">iSerialNumber</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_gadget_strings</span> <span class="n">strings</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">language</span><span class="p">,</span>
			<span class="p">.</span><span class="n">strings</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_string</span><span class="p">)</span> <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">str</span> <span class="p">}</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">usb_gadget_get_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">strings</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* String IDs are device-scoped, so we look up each string</span>
<span class="cm">	 * table we&#39;re told about.  These lookups are infrequent;</span>
<span class="cm">	 * simpler-is-better here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">composite</span><span class="o">-&gt;</span><span class="n">strings</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">lookup_string</span><span class="p">(</span><span class="n">composite</span><span class="o">-&gt;</span><span class="n">strings</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">configs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">strings</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">lookup_string</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">strings</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">strings</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">lookup_string</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">strings</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * usb_string_id() - allocate an unused string ID</span>
<span class="cm"> * @cdev: the device whose string descriptor IDs are being allocated</span>
<span class="cm"> * Context: single threaded during gadget setup</span>
<span class="cm"> *</span>
<span class="cm"> * @usb_string_id() is called from bind() callbacks to allocate</span>
<span class="cm"> * string IDs.  Drivers for functions, configurations, or gadgets will</span>
<span class="cm"> * then store that ID in the appropriate descriptors and string table.</span>
<span class="cm"> *</span>
<span class="cm"> * All string identifier should be allocated using this,</span>
<span class="cm"> * @usb_string_ids_tab() or @usb_string_ids_n() routine, to ensure</span>
<span class="cm"> * that for example different functions don&#39;t wrongly assign different</span>
<span class="cm"> * meanings to the same identifier.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usb_string_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">next_string_id</span> <span class="o">&lt;</span> <span class="mi">254</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* string id 0 is reserved by USB spec for list of</span>
<span class="cm">		 * supported languages */</span>
		<span class="cm">/* 255 reserved as well? -- mina86 */</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">next_string_id</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">next_string_id</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * usb_string_ids() - allocate unused string IDs in batch</span>
<span class="cm"> * @cdev: the device whose string descriptor IDs are being allocated</span>
<span class="cm"> * @str: an array of usb_string objects to assign numbers to</span>
<span class="cm"> * Context: single threaded during gadget setup</span>
<span class="cm"> *</span>
<span class="cm"> * @usb_string_ids() is called from bind() callbacks to allocate</span>
<span class="cm"> * string IDs.  Drivers for functions, configurations, or gadgets will</span>
<span class="cm"> * then copy IDs from the string table to the appropriate descriptors</span>
<span class="cm"> * and string table for other languages.</span>
<span class="cm"> *</span>
<span class="cm"> * All string identifier should be allocated using this,</span>
<span class="cm"> * @usb_string_id() or @usb_string_ids_n() routine, to ensure that for</span>
<span class="cm"> * example different functions don&#39;t wrongly assign different meanings</span>
<span class="cm"> * to the same identifier.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usb_string_ids_tab</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_string</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">next</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">next_string_id</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">str</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">;</span> <span class="o">++</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">next</span> <span class="o">&gt;=</span> <span class="mi">254</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">str</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="o">++</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">next_string_id</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * usb_string_ids_n() - allocate unused string IDs in batch</span>
<span class="cm"> * @c: the device whose string descriptor IDs are being allocated</span>
<span class="cm"> * @n: number of string IDs to allocate</span>
<span class="cm"> * Context: single threaded during gadget setup</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the first requested ID.  This ID and next @n-1 IDs are now</span>
<span class="cm"> * valid IDs.  At least provided that @n is non-zero because if it</span>
<span class="cm"> * is, returns last requested ID which is now very useful information.</span>
<span class="cm"> *</span>
<span class="cm"> * @usb_string_ids_n() is called from bind() callbacks to allocate</span>
<span class="cm"> * string IDs.  Drivers for functions, configurations, or gadgets will</span>
<span class="cm"> * then store that ID in the appropriate descriptors and string table.</span>
<span class="cm"> *</span>
<span class="cm"> * All string identifier should be allocated using this,</span>
<span class="cm"> * @usb_string_id() or @usb_string_ids_n() routine, to ensure that for</span>
<span class="cm"> * example different functions don&#39;t wrongly assign different meanings</span>
<span class="cm"> * to the same identifier.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usb_string_ids_n</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">next</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">next_string_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">254</span> <span class="o">||</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">next</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">254</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">next_string_id</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">next</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">composite_setup_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">||</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
		<span class="n">DBG</span><span class="p">((</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">,</span>
				<span class="s">&quot;setup complete --&gt; %d, %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The setup() callback implements all the ep0 functionality that&#39;s</span>
<span class="cm"> * not handled lower down, in hardware or the hardware driver(like</span>
<span class="cm"> * device and endpoint feature flags, and their status).  It&#39;s all</span>
<span class="cm"> * housekeeping for the gadget function we&#39;re implementing.  Most of</span>
<span class="cm"> * the work is in config and function specific setup.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">composite_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span>	<span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">get_gadget_data</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_request</span>		<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>				<span class="n">w_index</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">);</span>
	<span class="n">u8</span>				<span class="n">intf</span> <span class="o">=</span> <span class="n">w_index</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">u16</span>				<span class="n">w_value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">);</span>
	<span class="n">u16</span>				<span class="n">w_length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_function</span>		<span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="n">endp</span><span class="p">;</span>

	<span class="cm">/* partial re-init of the response message; the function or the</span>
<span class="cm">	 * gadget might need to intercept e.g. a control-OUT completion</span>
<span class="cm">	 * when we delegate to it.</span>
<span class="cm">	 */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">composite_setup_complete</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">cdev</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequest</span><span class="p">)</span> <span class="p">{</span>

	<span class="cm">/* we handle all standard USB descriptors */</span>
	<span class="k">case</span> <span class="n">USB_REQ_GET_DESCRIPTOR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">w_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">USB_DT_DEVICE</span>:
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumConfigurations</span> <span class="o">=</span>
				<span class="n">count_configs</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">USB_DT_DEVICE</span><span class="p">);</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bMaxPacketSize0</span> <span class="o">=</span>
				<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gadget_is_superspeed</span><span class="p">(</span><span class="n">gadget</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&gt;=</span> <span class="n">USB_SPEED_SUPER</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bcdUSB</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0300</span><span class="p">);</span>
					<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bMaxPacketSize0</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bcdUSB</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0210</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">value</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">w_length</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="k">sizeof</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_DT_DEVICE_QUALIFIER</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gadget_is_dualspeed</span><span class="p">(</span><span class="n">gadget</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">gadget</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&gt;=</span> <span class="n">USB_SPEED_SUPER</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">device_qual</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">w_length</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_qualifier_descriptor</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_DT_OTHER_SPEED_CONFIG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gadget_is_dualspeed</span><span class="p">(</span><span class="n">gadget</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">gadget</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&gt;=</span> <span class="n">USB_SPEED_SUPER</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* FALLTHROUGH */</span>
		<span class="k">case</span> <span class="n">USB_DT_CONFIG</span>:
			<span class="n">value</span> <span class="o">=</span> <span class="n">config_desc</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">w_value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">w_length</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_DT_STRING</span>:
			<span class="n">value</span> <span class="o">=</span> <span class="n">get_string</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span>
					<span class="n">w_index</span><span class="p">,</span> <span class="n">w_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">w_length</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_DT_BOS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">gadget_is_superspeed</span><span class="p">(</span><span class="n">gadget</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">bos_desc</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">w_length</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* any number of configs can work */</span>
	<span class="k">case</span> <span class="n">USB_REQ_SET_CONFIGURATION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gadget_is_otg</span><span class="p">(</span><span class="n">gadget</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">a_hnp_support</span><span class="p">)</span>
				<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;HNP available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">a_alt_hnp_support</span><span class="p">)</span>
				<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;HNP on another port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">VDBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;HNP inactive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">set_config</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">w_value</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_REQ_GET_CONFIGURATION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">bConfigurationValue</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">w_length</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* function drivers must handle get/set altsetting; if there&#39;s</span>
<span class="cm">	 * no get() method, we know only altsetting zero works.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">USB_REQ_SET_INTERFACE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">||</span> <span class="n">intf</span> <span class="o">&gt;=</span> <span class="n">MAX_CONFIG_INTERFACES</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">[</span><span class="n">intf</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w_value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">set_alt</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">set_alt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">w_index</span><span class="p">,</span> <span class="n">w_value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">USB_GADGET_DELAYED_STATUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span>
			 <span class="s">&quot;%s: interface %d (%s) requested delayed status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">delayed_status</span><span class="o">++</span><span class="p">;</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;delayed_status count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">delayed_status</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_REQ_GET_INTERFACE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="p">(</span><span class="n">USB_DIR_IN</span><span class="o">|</span><span class="n">USB_RECIP_INTERFACE</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">||</span> <span class="n">intf</span> <span class="o">&gt;=</span> <span class="n">MAX_CONFIG_INTERFACES</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">[</span><span class="n">intf</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* lots of interfaces only need altsetting zero... */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_alt</span> <span class="o">?</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_alt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">w_index</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">w_length</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * USB 3.0 additions:</span>
<span class="cm">	 * Function driver should handle get_status request. If such cb</span>
<span class="cm">	 * wasn&#39;t supplied we respond with default value = 0</span>
<span class="cm">	 * Note: function driver should supply such cb only for the first</span>
<span class="cm">	 * interface of the function</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">USB_REQ_GET_STATUS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gadget_is_superspeed</span><span class="p">(</span><span class="n">gadget</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="p">(</span><span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* This is the length of the get_status reply */</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">||</span> <span class="n">intf</span> <span class="o">&gt;=</span> <span class="n">MAX_CONFIG_INTERFACES</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">[</span><span class="n">intf</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_status</span> <span class="o">?</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">get_status</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">put_unaligned_le16</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Function drivers should handle SetFeature/ClearFeature</span>
<span class="cm">	 * (FUNCTION_SUSPEND) request. function_suspend cb should be supplied</span>
<span class="cm">	 * only for the first interface of the function</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">USB_REQ_CLEAR_FEATURE</span>:
	<span class="k">case</span> <span class="n">USB_REQ_SET_FEATURE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gadget_is_superspeed</span><span class="p">(</span><span class="n">gadget</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="p">(</span><span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">w_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_INTRF_FUNC_SUSPEND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">||</span> <span class="n">intf</span> <span class="o">&gt;=</span> <span class="n">MAX_CONFIG_INTERFACES</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">f</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">[</span><span class="n">intf</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">func_suspend</span><span class="p">)</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">func_suspend</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">w_index</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ERROR</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span>
				      <span class="s">&quot;func_suspend() returned error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">value</span><span class="p">);</span>
				<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
<span class="nl">unknown:</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span>
			<span class="s">&quot;non-core control req%02x.%02x v%04x i%04x l%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequest</span><span class="p">,</span>
			<span class="n">w_value</span><span class="p">,</span> <span class="n">w_index</span><span class="p">,</span> <span class="n">w_length</span><span class="p">);</span>

		<span class="cm">/* functions always handle their interfaces and endpoints...</span>
<span class="cm">		 * punt other recipients (other, WUSB, ...) to the current</span>
<span class="cm">		 * configuration code.</span>
<span class="cm">		 *</span>
<span class="cm">		 * REVISIT it could make sense to let the composite device</span>
<span class="cm">		 * take such requests too, if that&#39;s ever needed:  to work</span>
<span class="cm">		 * in config 0, etc.</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_RECIP_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_RECIP_INTERFACE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">||</span> <span class="n">intf</span> <span class="o">&gt;=</span> <span class="n">MAX_CONFIG_INTERFACES</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">f</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">[</span><span class="n">intf</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">USB_RECIP_ENDPOINT</span>:
			<span class="n">endp</span> <span class="o">=</span> <span class="p">((</span><span class="n">w_index</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">w_index</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">endp</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">endpoints</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">list</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">)</span>
				<span class="n">f</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&amp;&amp;</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">usb_configuration</span>	<span class="o">*</span><span class="n">c</span><span class="p">;</span>

			<span class="n">c</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">)</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* respond with data transfer before status phase? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">USB_GADGET_DELAYED_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">zero</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">w_length</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;ep_queue --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">composite_setup_complete</span><span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">USB_GADGET_DELAYED_STATUS</span> <span class="o">&amp;&amp;</span> <span class="n">w_length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span>
			<span class="s">&quot;%s: Delayed status not supported for w_length != 0&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="cm">/* device either stalls (value &lt; 0) or reports success */</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">composite_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span>	<span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">get_gadget_data</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* REVISIT:  should we have config and device level</span>
<span class="cm">	 * disconnect callbacks?</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span>
		<span class="n">reset_config</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">composite</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">)</span>
		<span class="n">composite</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">composite_show_suspended</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">dev_to_usb_gadget</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">get_gadget_data</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">suspended</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">composite_show_suspended</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">composite_unbind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span>	<span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">get_gadget_data</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>

	<span class="cm">/* composite_disconnect() must already have been called</span>
<span class="cm">	 * by the underlying peripheral controller driver!</span>
<span class="cm">	 * so there&#39;s no i/o concurrency that could affect the</span>
<span class="cm">	 * state protected by cdev-&gt;lock.</span>
<span class="cm">	 */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">configs</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_configuration</span>	<span class="o">*</span><span class="n">c</span><span class="p">;</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">configs</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">usb_configuration</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">remove_config</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">composite</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">)</span>
		<span class="n">composite</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_suspended</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="n">set_gadget_data</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">composite</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">override_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">usb_string_id</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">WARNING</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;failed to override string ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">composite_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span>	<span class="o">*</span><span class="n">cdev</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">gadget</span><span class="p">;</span>
	<span class="n">set_gadget_data</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">configs</span><span class="p">);</span>

	<span class="cm">/* preallocate control response and buffer */</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="n">usb_ep_alloc_request</span><span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">USB_BUFSIZ</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">composite_setup_complete</span><span class="p">;</span>
	<span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">cdev</span><span class="p">;</span>

	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">bufsiz</span> <span class="o">=</span> <span class="n">USB_BUFSIZ</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">composite</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * As per USB compliance update, a device that is actively drawing</span>
<span class="cm">	 * more than 100mA from USB must report itself as bus-powered in</span>
<span class="cm">	 * the GetStatus(DEVICE) call.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CONFIG_USB_GADGET_VBUS_DRAW</span> <span class="o">&lt;=</span> <span class="n">USB_SELF_POWER_VBUS_MAX_DRAW</span><span class="p">)</span>
		<span class="n">usb_gadget_set_selfpowered</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>

	<span class="cm">/* interface and string IDs start at zero via kzalloc.</span>
<span class="cm">	 * we force endpoints to start unassigned; few controller</span>
<span class="cm">	 * drivers will zero ep-&gt;driver_data.</span>
<span class="cm">	 */</span>
	<span class="n">usb_ep_autoconfig_reset</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>

	<span class="cm">/* composite gadget needs to assign strings for whole device (like</span>
<span class="cm">	 * serial number), register function drivers, potentially update</span>
<span class="cm">	 * power state and consumption, etc</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">composite_gadget_bind</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="o">*</span><span class="n">composite</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* standardized runtime overrides for device ID data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idVendor</span><span class="p">)</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">idVendor</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">idVendor</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">idVendor</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">idVendor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idProduct</span><span class="p">)</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">idProduct</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">idProduct</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">idProduct</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">idProduct</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcdDevice</span><span class="p">)</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bcdDevice</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bcdDevice</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bcdDevice</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bcdDevice</span><span class="p">);</span>

	<span class="cm">/* string overrides */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iManufacturer</span> <span class="o">||</span> <span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">iManufacturer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iManufacturer</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">composite</span><span class="o">-&gt;</span><span class="n">iManufacturer</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!*</span><span class="n">composite_manufacturer</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">composite_manufacturer</span><span class="p">,</span>
				 <span class="k">sizeof</span> <span class="n">composite_manufacturer</span><span class="p">,</span>
				 <span class="s">&quot;%s %s with %s&quot;</span><span class="p">,</span>
				 <span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">sysname</span><span class="p">,</span>
				 <span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">,</span>
				 <span class="n">gadget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">manufacturer_override</span> <span class="o">=</span>
			<span class="n">override_id</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">iManufacturer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iProduct</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">iProduct</span> <span class="o">&amp;&amp;</span> <span class="n">composite</span><span class="o">-&gt;</span><span class="n">iProduct</span><span class="p">))</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">product_override</span> <span class="o">=</span>
			<span class="n">override_id</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">iProduct</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iSerialNumber</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">iSerialNumber</span> <span class="o">&amp;&amp;</span> <span class="n">composite</span><span class="o">-&gt;</span><span class="n">iSerialNumber</span><span class="p">))</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">serial_override</span> <span class="o">=</span>
			<span class="n">override_id</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">iSerialNumber</span><span class="p">);</span>

	<span class="cm">/* has userspace failed to provide a serial number? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">composite</span><span class="o">-&gt;</span><span class="n">needs_serial</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">iSerialNumber</span><span class="p">)</span>
		<span class="n">WARNING</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;userspace failed to provide iSerialNumber</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* finish up */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_suspended</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">INFO</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;%s ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">composite</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">composite_unbind</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">composite_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span>	<span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">get_gadget_data</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_function</span>		<span class="o">*</span><span class="n">f</span><span class="p">;</span>

	<span class="cm">/* REVISIT:  should we have config level</span>
<span class="cm">	 * suspend/resume callbacks?</span>
<span class="cm">	 */</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">composite</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
		<span class="n">composite</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>

	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">usb_gadget_vbus_draw</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">composite_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span>	<span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">get_gadget_data</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_function</span>		<span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="n">maxpower</span><span class="p">;</span>

	<span class="cm">/* REVISIT:  should we have config level</span>
<span class="cm">	 * suspend/resume callbacks?</span>
<span class="cm">	 */</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">composite</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
		<span class="n">composite</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">maxpower</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">bMaxPower</span><span class="p">;</span>

		<span class="n">usb_gadget_vbus_draw</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="n">maxpower</span> <span class="o">?</span>
			<span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">maxpower</span><span class="p">)</span> <span class="o">:</span> <span class="n">CONFIG_USB_GADGET_VBUS_DRAW</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="n">composite_driver</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_USB_GADGET_SUPERSPEED</span>
	<span class="p">.</span><span class="n">max_speed</span>	<span class="o">=</span> <span class="n">USB_SPEED_SUPER</span><span class="p">,</span>
<span class="cp">#else</span>
	<span class="p">.</span><span class="n">max_speed</span>	<span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">,</span>
<span class="cp">#endif</span>

	<span class="p">.</span><span class="n">unbind</span>		<span class="o">=</span> <span class="n">composite_unbind</span><span class="p">,</span>

	<span class="p">.</span><span class="n">setup</span>		<span class="o">=</span> <span class="n">composite_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">composite_disconnect</span><span class="p">,</span>

	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">composite_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">composite_resume</span><span class="p">,</span>

	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * usb_composite_probe() - register a composite driver</span>
<span class="cm"> * @driver: the driver to register</span>
<span class="cm"> * @bind: the callback used to allocate resources that are shared across the</span>
<span class="cm"> *	whole device, such as string IDs, and add its configurations using</span>
<span class="cm"> *	@usb_add_config().  This may fail by returning a negative errno</span>
<span class="cm"> *	value; it should return zero on successful initialization.</span>
<span class="cm"> * Context: single threaded during gadget setup</span>
<span class="cm"> *</span>
<span class="cm"> * This function is used to register drivers using the composite driver</span>
<span class="cm"> * framework.  The return value is zero, or a negative errno value.</span>
<span class="cm"> * Those values normally come from the driver&#39;s @bind method, which does</span>
<span class="cm"> * all the work of setting up the driver to match the hardware.</span>
<span class="cm"> *</span>
<span class="cm"> * On successful return, the gadget is ready to respond to requests from</span>
<span class="cm"> * the host, unless one of its components invokes usb_gadget_disconnect()</span>
<span class="cm"> * while it was binding.  That would usually be done in order to wait for</span>
<span class="cm"> * some userspace participation.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usb_composite_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bind</span><span class="p">)(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span> <span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">bind</span> <span class="o">||</span> <span class="n">composite</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;composite&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">iProduct</span><span class="p">)</span>
		<span class="n">driver</span><span class="o">-&gt;</span><span class="n">iProduct</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">composite_driver</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span>  <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">composite_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">composite_driver</span><span class="p">.</span><span class="n">max_speed</span> <span class="o">=</span>
		<span class="n">min_t</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="n">composite_driver</span><span class="p">.</span><span class="n">max_speed</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">max_speed</span><span class="p">);</span>
	<span class="n">composite</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="n">composite_gadget_bind</span> <span class="o">=</span> <span class="n">bind</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">usb_gadget_probe_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">composite_driver</span><span class="p">,</span> <span class="n">composite_bind</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * usb_composite_unregister() - unregister a composite driver</span>
<span class="cm"> * @driver: the driver to unregister</span>
<span class="cm"> *</span>
<span class="cm"> * This function is used to unregister drivers using the composite</span>
<span class="cm"> * driver framework.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">usb_composite_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">composite</span> <span class="o">!=</span> <span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">usb_gadget_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">composite_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * usb_composite_setup_continue() - Continue with the control transfer</span>
<span class="cm"> * @cdev: the composite device who&#39;s control transfer was kept waiting</span>
<span class="cm"> *</span>
<span class="cm"> * This function must be called by the USB function driver to continue</span>
<span class="cm"> * with the control transfer&#39;s data/status stage in case it had requested to</span>
<span class="cm"> * delay the data/status stages. A USB function&#39;s setup handler (e.g. set_alt())</span>
<span class="cm"> * can request the composite framework to delay the setup request&#39;s data/status</span>
<span class="cm"> * stages by returning USB_GADGET_DELAYED_STATUS.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">usb_composite_setup_continue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_request</span>	<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">delayed_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;%s: Unexpected call</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">delayed_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;%s: Completing delayed status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="s">&quot;ep_queue --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">composite_setup_complete</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
