<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › gadget › fusb300_udc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fusb300_udc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Fusb300 UDC (USB gadget)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Faraday Technology Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * Author : Yuan-hsin Chen &lt;yhchen@faraday-tech.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>

<span class="cp">#include &quot;fusb300_udc.h&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;FUSB300  USB gadget driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Yuan Hsin Chen &lt;yhchen@faraday-tech.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:fusb300_udc&quot;</span><span class="p">);</span>

<span class="cp">#define DRIVER_VERSION	&quot;20 October 2010&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">udc_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;fusb300_udc&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">fusb300_ep_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;ep0&quot;</span><span class="p">,</span> <span class="s">&quot;ep1&quot;</span><span class="p">,</span> <span class="s">&quot;ep2&quot;</span><span class="p">,</span> <span class="s">&quot;ep3&quot;</span><span class="p">,</span> <span class="s">&quot;ep4&quot;</span><span class="p">,</span> <span class="s">&quot;ep5&quot;</span><span class="p">,</span> <span class="s">&quot;ep6&quot;</span><span class="p">,</span> <span class="s">&quot;ep7&quot;</span><span class="p">,</span> <span class="s">&quot;ep8&quot;</span><span class="p">,</span> <span class="s">&quot;ep9&quot;</span><span class="p">,</span>
	<span class="s">&quot;ep10&quot;</span><span class="p">,</span> <span class="s">&quot;ep11&quot;</span><span class="p">,</span> <span class="s">&quot;ep12&quot;</span><span class="p">,</span> <span class="s">&quot;ep13&quot;</span><span class="p">,</span> <span class="s">&quot;ep14&quot;</span><span class="p">,</span> <span class="s">&quot;ep15&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">done</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fusb300_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">status</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_enable_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">|=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_disable_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">value</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_ep_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">fusb300_ep_info</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">epnum</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fusb300_ep_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">wedged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_set_fifo_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET1</span><span class="p">(</span><span class="n">ep</span><span class="p">));</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FUSB300_EPSET1_FIFOENTRY_MSK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">FUSB300_EPSET1_FIFOENTRY</span><span class="p">(</span><span class="n">FUSB300_FIFO_ENTRY_NUM</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET1</span><span class="p">(</span><span class="n">ep</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_set_start_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET1</span><span class="p">(</span><span class="n">ep</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">start_entry</span> <span class="o">=</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">fifo_entry_num</span> <span class="o">*</span> <span class="n">FUSB300_FIFO_ENTRY_NUM</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FUSB300_EPSET1_START_ENTRY_MSK</span>	<span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">FUSB300_EPSET1_START_ENTRY</span><span class="p">(</span><span class="n">start_entry</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET1</span><span class="p">(</span><span class="n">ep</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">fifo_entry_num</span> <span class="o">==</span> <span class="n">FUSB300_MAX_FIFO_ENTRY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">fifo_entry_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">addrofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;fifo entry is over the maximum number!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">fifo_entry_num</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set fusb300_set_start_entry first before fusb300_set_epaddrofs */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_set_epaddrofs</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">fusb300_ep_info</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET2</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">epnum</span><span class="p">));</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FUSB300_EPSET2_ADDROFS_MSK</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">FUSB300_EPSET2_ADDROFS</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">addrofs</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET2</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">epnum</span><span class="p">));</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">addrofs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">FUSB300_FIFO_ENTRY_NUM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep_fifo_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">fusb300_ep_info</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fusb300_set_fifo_entry</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">epnum</span><span class="p">);</span>
	<span class="n">fusb300_set_start_entry</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">epnum</span><span class="p">);</span>
	<span class="n">fusb300_set_epaddrofs</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_set_eptype</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">fusb300_ep_info</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET1</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">epnum</span><span class="p">));</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FUSB300_EPSET1_TYPE_MSK</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">FUSB300_EPSET1_TYPE</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET1</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">epnum</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_set_epdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fusb300_ep_info</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">.</span><span class="n">dir_in</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET1</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">epnum</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FUSB300_EPSET1_DIR_MSK</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">FUSB300_EPSET1_DIRIN</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET1</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">epnum</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_set_ep_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET1</span><span class="p">(</span><span class="n">ep</span><span class="p">));</span>

	<span class="n">reg</span> <span class="o">|=</span> <span class="n">FUSB300_EPSET1_ACTEN</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET1</span><span class="p">(</span><span class="n">ep</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_set_epmps</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fusb300_ep_info</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET2</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">epnum</span><span class="p">));</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FUSB300_EPSET2_MPS_MSK</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">FUSB300_EPSET2_MPS</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET2</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">epnum</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_set_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">fusb300_ep_info</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET1</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">epnum</span><span class="p">));</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FUSB300_EPSET1_INTERVAL</span><span class="p">(</span><span class="mh">0x7</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">FUSB300_EPSET1_INTERVAL</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">interval</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET1</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">epnum</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_set_bwnum</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fusb300_ep_info</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET1</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">epnum</span><span class="p">));</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FUSB300_EPSET1_BWNUM</span><span class="p">(</span><span class="mh">0x3</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">FUSB300_EPSET1_BWNUM</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">bw_num</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET1</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">epnum</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_ep_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">fusb300_ep_info</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fusb300_set_eptype</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">fusb300_set_epdir</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">fusb300_set_epmps</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">interval</span><span class="p">)</span>
		<span class="n">fusb300_set_interval</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">bw_num</span><span class="p">)</span>
		<span class="n">fusb300_set_bwnum</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">fusb300_set_ep_active</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">epnum</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">config_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
		     <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusb300_ep_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>

	<span class="n">info</span><span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">addrofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">bw_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_XFERTYPE_MASK</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">dir_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_DIR_MASK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">epnum</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">)</span>
			<span class="n">info</span><span class="p">.</span><span class="n">bw_num</span> <span class="o">=</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span> <span class="o">&amp;</span> <span class="mh">0x1800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ep_fifo_setting</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">set_ep_reg</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">fusb300_ep_setting</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">info</span><span class="p">.</span><span class="n">epnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fusb300_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fusb300_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reenum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">fifo_entry_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">addrofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reenum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">config_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fusb300_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusb300_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fusb300_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fusb300_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">fusb300_ep_release</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="nf">fusb300_alloc_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span>
						<span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300_request</span><span class="p">),</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_free_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fusb300_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enable_fifo_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_enable_bit</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGER0</span><span class="p">,</span>
			<span class="n">FUSB300_IGER0_EEPn_FIFO_INT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;can&#39;t enable_fifo_int ep0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">disable_fifo_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_disable_bit</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGER0</span><span class="p">,</span>
			<span class="n">FUSB300_IGER0_EEPn_FIFO_INT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;can&#39;t disable_fifo_int ep0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_set_cxlen</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">u32</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_CSR</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FUSB300_CSR_LEN_MSK</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">FUSB300_CSR_LEN</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_CSR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* write data to cx fifo */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_wrcxf</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">fusb300_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">SS_CTL_MAX_PACKET_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_set_cxlen</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">SS_CTL_MAX_PACKET_SIZE</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">SS_CTL_MAX_PACKET_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
				<span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_CXPORT</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">SS_CTL_MAX_PACKET_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* length is less than max packet size */</span>
		<span class="n">fusb300_set_cxlen</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
				<span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;    0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_CXPORT</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">length</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;    0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_CXPORT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;    0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_CXPORT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;    0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_CXPORT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_set_epnstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fusb300_enable_bit</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_EPSET0</span><span class="p">(</span><span class="n">ep</span><span class="p">),</span>
		<span class="n">FUSB300_EPSET0_STL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_clear_epnstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET0</span><span class="p">(</span><span class="n">ep</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">FUSB300_EPSET0_STL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;EP%d stall... Clear!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FUSB300_EPSET0_STL</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET0</span><span class="p">(</span><span class="n">ep</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep0_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fusb300_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep0_dir</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* if IN */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fusb300_wrcxf</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s : req-&gt;req.length = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">))</span>
			<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* OUT */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
			<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">fusb300_enable_bit</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGER1</span><span class="p">,</span>
				<span class="n">FUSB300_IGER1_CX_OUT_INT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fusb300_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">,</span>
			 <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusb300_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">request</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fusb300_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fusb300_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">request</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="cm">/* ep0 */</span>
		<span class="n">ep0_queue</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stall</span><span class="p">)</span>
		<span class="n">enable_fifo_int</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fusb300_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusb300_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fusb300_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fusb300_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fusb300_set_halt_and_wedge</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wedge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fusb300_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="n">fusb300</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_set_epnstall</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wedge</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">wedged</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fusb300_clear_epnstall</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">wedged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fusb300_set_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fusb300_set_halt_and_wedge</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fusb300_set_wedge</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fusb300_set_halt_and_wedge</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_fifo_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">fusb300_ep_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">fusb300_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">fusb300_disable</span><span class="p">,</span>

	<span class="p">.</span><span class="n">alloc_request</span>	<span class="o">=</span> <span class="n">fusb300_alloc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_request</span>	<span class="o">=</span> <span class="n">fusb300_free_request</span><span class="p">,</span>

	<span class="p">.</span><span class="n">queue</span>		<span class="o">=</span> <span class="n">fusb300_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue</span>	<span class="o">=</span> <span class="n">fusb300_dequeue</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_halt</span>	<span class="o">=</span> <span class="n">fusb300_set_halt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_flush</span>	<span class="o">=</span> <span class="n">fusb300_fifo_flush</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wedge</span>	<span class="o">=</span> <span class="n">fusb300_set_wedge</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_clear_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
		       <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_reset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_set_cxstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fusb300_enable_bit</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_CSR</span><span class="p">,</span>
			   <span class="n">FUSB300_CSR_STL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_set_cxdone</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fusb300_enable_bit</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_CSR</span><span class="p">,</span>
			   <span class="n">FUSB300_CSR_DONE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* read data from cx fifo */</span>
<span class="kt">void</span> <span class="nf">fusb300_rdcxf</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span>
		   <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">u32</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_CXPORT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;    0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">length</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_CXPORT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;    0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_CXPORT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;    0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_CXPORT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;    0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_rdfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">fusb300_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			  <span class="n">u32</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">&gt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;req-&gt;req.actual &gt; req-&gt;req.length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span>
			<span class="n">FUSB300_OFFSET_EPPORT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">));</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">length</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span>
			<span class="n">FUSB300_OFFSET_EPPORT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">));</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span>
			<span class="n">FUSB300_OFFSET_EPPORT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">));</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span>
			<span class="n">FUSB300_OFFSET_EPPORT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">));</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="n">FUSB300_IGR1_SYNF0_EMPTY_INT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sync fifo is not empty!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">fusb300_get_epnstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPSET0</span><span class="p">(</span><span class="n">ep</span><span class="p">));</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">FUSB300_EPSET0_STL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">fusb300_get_cxstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_CSR</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">FUSB300_CSR_STL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">request_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fusb300_set_cxstall</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;request error!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ep</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">w_index</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_RECIP_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_RECIP_DEVICE</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DEVICE_SELF_POWERED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_RECIP_INTERFACE</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_RECIP_ENDPOINT</span>:
		<span class="n">ep</span> <span class="o">=</span> <span class="n">w_index</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fusb300_get_epnstall</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">ep</span><span class="p">))</span>
				<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_ENDPOINT_HALT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fusb300_get_cxstall</span><span class="p">(</span><span class="n">fusb300</span><span class="p">))</span>
				<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">request_error</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* exit */</span>
	<span class="p">}</span>

	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep0_data</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep0_req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep0_data</span><span class="p">;</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep0_req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">fusb300_queue</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep0_req</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_feature</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ep</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_RECIP_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_RECIP_DEVICE</span>:
		<span class="n">fusb300_set_cxdone</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_RECIP_INTERFACE</span>:
		<span class="n">fusb300_set_cxdone</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_RECIP_ENDPOINT</span>: <span class="p">{</span>
		<span class="n">u16</span> <span class="n">w_index</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">);</span>

		<span class="n">ep</span> <span class="o">=</span> <span class="n">w_index</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="p">)</span>
			<span class="n">fusb300_set_epnstall</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">fusb300_set_cxstall</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
		<span class="n">fusb300_set_cxdone</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">request_error</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_clear_seqnum</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fusb300_enable_bit</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_EPSET0</span><span class="p">(</span><span class="n">ep</span><span class="p">),</span>
			    <span class="n">FUSB300_EPSET0_CLRSEQNUM</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_feature</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span>
		<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wIndex</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_RECIP_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_RECIP_DEVICE</span>:
		<span class="n">fusb300_set_cxdone</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_RECIP_INTERFACE</span>:
		<span class="n">fusb300_set_cxdone</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_RECIP_ENDPOINT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wIndex</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wedged</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fusb300_set_cxdone</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stall</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">fusb300_clear_seqnum</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">);</span>
				<span class="n">fusb300_clear_epnstall</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
					<span class="n">enable_fifo_int</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">fusb300_set_cxdone</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">request_error</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_set_dev_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_DAR</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FUSB300_DAR_DRVADDR_MSK</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">FUSB300_DAR_DRVADDR</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_DAR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wValue</span> <span class="o">&gt;=</span> <span class="mh">0x0100</span><span class="p">)</span>
		<span class="n">request_error</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">fusb300_set_dev_addr</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">);</span>
		<span class="n">fusb300_set_cxdone</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define UVC_COPY_DESCRIPTORS(mem, src) \</span>
<span class="cp">	do { \</span>
<span class="cp">		const struct usb_descriptor_header * const *__src; \</span>
<span class="cp">		for (__src = src; *__src; ++__src) { \</span>
<span class="cp">			memcpy(mem, *__src, (*__src)-&gt;bLength); \</span>
<span class="cp">			mem += (*__src)-&gt;bLength; \</span>
<span class="cp">		} \</span>
<span class="cp">	} while (0)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fusb300_rdcxf</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">;</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep0_length</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">;</span>

	<span class="cm">/* check request */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_TYPE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">USB_TYPE_STANDARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequest</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_REQ_GET_STATUS</span>:
			<span class="n">get_status</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_REQ_CLEAR_FEATURE</span>:
			<span class="n">clear_feature</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_REQ_SET_FEATURE</span>:
			<span class="n">set_feature</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_REQ_SET_ADDRESS</span>:
			<span class="n">set_address</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_REQ_SET_CONFIGURATION</span>:
			<span class="n">fusb300_enable_bit</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_DAR</span><span class="p">,</span>
					   <span class="n">FUSB300_DAR_SETCONFG</span><span class="p">);</span>
			<span class="cm">/* clear sequence number */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">FUSB300_MAX_NUM_EP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">fusb300_clear_seqnum</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reenum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">done</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fusb300_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="cm">/* don&#39;t modify queue heads during completion callback */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">disable_fifo_int</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
			<span class="n">enable_fifo_int</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">fusb300_set_cxdone</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_fill_idma_prdtbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">d</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* wait SW owner */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span>
			<span class="n">FUSB300_OFFSET_EPPRD_W0</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">));</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="n">FUSB300_EPPRD0_H</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPPRD_W1</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">));</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">FUSB300_EPPRD0_BTC</span><span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="o">|</span> <span class="n">FUSB300_EPPRD0_H</span> <span class="o">|</span>
		<span class="n">FUSB300_EPPRD0_F</span> <span class="o">|</span> <span class="n">FUSB300_EPPRD0_L</span> <span class="o">|</span> <span class="n">FUSB300_EPPRD0_I</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPPRD_W0</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">));</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPPRD_W2</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">));</span>

	<span class="n">fusb300_enable_bit</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_EPPRDRDY</span><span class="p">,</span>
		<span class="n">FUSB300_EPPRDR_EP_PRD_RDY</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_wait_idma_finished</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_VBUS_CHG_INT</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_WARM_RST_INT</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_HOT_RST_INT</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_USBRST_INT</span><span class="p">)</span>
		<span class="p">)</span>
			<span class="k">goto</span> <span class="n">IDMA_RESET</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_IGR0</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="n">FUSB300_IGR0_EPn_PRD_INT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">reg</span><span class="p">);</span>

	<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR0</span><span class="p">,</span>
		<span class="n">FUSB300_IGR0_EPn_PRD_INT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">));</span>
<span class="nl">IDMA_RESET:</span>
	<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGER0</span><span class="p">,</span>
		<span class="n">FUSB300_IGER0_EEPn_PRD_INT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>  <span class="nf">fusb300_set_idma</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fusb300_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">d</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;dma_mapping_error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">fusb300_enable_bit</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGER0</span><span class="p">,</span>
		<span class="n">FUSB300_IGER0_EEPn_PRD_INT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">));</span>

	<span class="n">fusb300_fill_idma_prdtbl</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="cm">/* check idma is done */</span>
	<span class="n">fusb300_wait_idma_finished</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">in_ep_fifo_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fusb300_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
		<span class="n">fusb300_set_idma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">out_ep_fifo_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusb300_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">fusb300_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_EPFFR</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">length</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">FUSB300_FFR_BYCNT</span><span class="p">;</span>

	<span class="n">fusb300_rdfifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="cm">/* finish out transfer */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">))</span>
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_device_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_GCR</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">FUSB300_GCR_DEVEN_MSK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FUSB300_GCR_DEVEN_SS</span>:
		<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_SUPER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FUSB300_GCR_DEVEN_HS</span>:
		<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FUSB300_GCR_DEVEN_FS</span>:
		<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;dev_mode = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">FUSB300_GCR_DEVEN_MSK</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_ep0out</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fusb300_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

		<span class="n">req</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fusb300_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
			<span class="n">fusb300_rdcxf</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_IGER1</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FUSB300_IGER1_CX_OUT_INT</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_IGER1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s : empty queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_ep0in</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep0_dir</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fusb300_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
			<span class="n">fusb300_wrcxf</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span>
			<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">fusb300_set_cxdone</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_grp2_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_grp3_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_grp4_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_grp5_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">fusb300_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_fusb300</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span> <span class="o">=</span> <span class="n">_fusb300</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_grp1</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">int_grp1_en</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_IGER1</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">int_grp0</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_IGR0</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">int_grp0_en</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_IGER0</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">in</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">int_grp1</span> <span class="o">&amp;=</span> <span class="n">int_grp1_en</span><span class="p">;</span>
	<span class="n">int_grp0</span> <span class="o">&amp;=</span> <span class="n">int_grp0_en</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_WARM_RST_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_WARM_RST_INT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;fusb300_warmreset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fusb300_reset</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_HOT_RST_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_HOT_RST_INT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;fusb300_hotreset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fusb300_reset</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_USBRST_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_USBRST_INT</span><span class="p">);</span>
		<span class="n">fusb300_reset</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="cm">/* COMABT_INT has a highest priority */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_CX_COMABT_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_CX_COMABT_INT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;fusb300_ep0abt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_VBUS_CHG_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_VBUS_CHG_INT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;fusb300_vbus_change</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_U3_EXIT_FAIL_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_U3_EXIT_FAIL_INT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_U2_EXIT_FAIL_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_U2_EXIT_FAIL_INT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_U1_EXIT_FAIL_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_U1_EXIT_FAIL_INT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_U2_ENTRY_FAIL_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_U2_ENTRY_FAIL_INT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_U1_ENTRY_FAIL_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_U1_ENTRY_FAIL_INT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_U3_EXIT_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_U3_EXIT_INT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FUSB300_IGR1_U3_EXIT_INT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_U2_EXIT_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_U2_EXIT_INT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FUSB300_IGR1_U2_EXIT_INT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_U1_EXIT_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_U1_EXIT_INT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FUSB300_IGR1_U1_EXIT_INT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_U3_ENTRY_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_U3_ENTRY_INT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FUSB300_IGR1_U3_ENTRY_INT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fusb300_enable_bit</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_SSCR1</span><span class="p">,</span>
				   <span class="n">FUSB300_SSCR1_GO_U3_DONE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_U2_ENTRY_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_U2_ENTRY_INT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FUSB300_IGR1_U2_ENTRY_INT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_U1_ENTRY_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_U1_ENTRY_INT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FUSB300_IGR1_U1_ENTRY_INT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_RESM_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_RESM_INT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fusb300_resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_SUSP_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_SUSP_INT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fusb300_suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_HS_LPM_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_HS_LPM_INT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fusb300_HS_LPM_INT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_DEV_MODE_CHG_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_clear_int</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="n">FUSB300_OFFSET_IGR1</span><span class="p">,</span>
				  <span class="n">FUSB300_IGR1_DEV_MODE_CHG_INT</span><span class="p">);</span>
		<span class="n">check_device_mode</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_CX_COMFAIL_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fusb300_set_cxstall</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fusb300_ep0fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_CX_SETUP_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fusb300_ep0setup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setup_packet</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">fusb300_set_cxstall</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_CX_CMDEND_INT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fusb300_cmdend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_CX_OUT_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fusb300_cxout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fusb300_ep0out</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_CX_IN_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fusb300_cxin</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fusb300_ep0in</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_INTGRP5</span><span class="p">)</span>
		<span class="n">fusb300_grp5_handler</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_INTGRP4</span><span class="p">)</span>
		<span class="n">fusb300_grp4_handler</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_INTGRP3</span><span class="p">)</span>
		<span class="n">fusb300_grp3_handler</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp1</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR1_INTGRP2</span><span class="p">)</span>
		<span class="n">fusb300_grp2_handler</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_grp0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FUSB300_MAX_NUM_EP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">int_grp0</span> <span class="o">&amp;</span> <span class="n">FUSB300_IGR0_EPn_FIFO_INT</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span>
					<span class="n">FUSB300_OFFSET_EPSET1</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
				<span class="n">in</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">FUSB300_EPSET1_DIRIN</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="p">)</span>
					<span class="n">in_ep_fifo_handler</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="k">else</span>
					<span class="n">out_ep_fifo_handler</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_set_u2_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_TT</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">FUSB300_SSCR2_U2TIMEOUT</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_TT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fusb300_set_u1_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_TT</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">FUSB300_SSCR2_U1TIMEOUT</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_TT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* split on */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">val</span> <span class="o">=</span> <span class="n">FUSB300_AHBBCR_S0_SPLIT_ON</span> <span class="o">|</span> <span class="n">FUSB300_AHBBCR_S1_SPLIT_ON</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_AHBCR</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_AHBCR</span><span class="p">);</span>

	<span class="cm">/* enable high-speed LPM */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">val</span> <span class="o">=</span> <span class="n">FUSB300_HSCR_HS_LPM_PERMIT</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_HSCR</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_HSCR</span><span class="p">);</span>

	<span class="cm">/*set u1 u2 timmer*/</span>
	<span class="n">fusb300_set_u2_timeout</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">fusb300_set_u1_timeout</span><span class="p">(</span><span class="n">fusb300</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* enable all grp1 interrupt */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0xcfffff9f</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">FUSB300_OFFSET_IGER1</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">the_controller</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fusb300_udc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bind</span><span class="p">)(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span> <span class="o">=</span> <span class="n">the_controller</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span>
			<span class="o">||</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">max_speed</span> <span class="o">&lt;</span> <span class="n">USB_SPEED_FULL</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">bind</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fusb300</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* hook up the driver */</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">device_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;device_add error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;bind to driver error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="n">device_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fusb300_udc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span> <span class="o">=</span> <span class="n">the_controller</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span> <span class="o">!=</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">init_controller</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
	<span class="n">device_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fusb300_udc_pullup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_gadget_ops</span> <span class="n">fusb300_gadget_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pullup</span>		<span class="o">=</span> <span class="n">fusb300_udc_pullup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="n">fusb300_udc_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>		<span class="o">=</span> <span class="n">fusb300_udc_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">fusb300_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">usb_del_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">fusb300</span><span class="p">);</span>

	<span class="n">fusb300_free_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep0_req</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fusb300_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="o">*</span><span class="n">ires</span><span class="p">,</span> <span class="o">*</span><span class="n">ires1</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusb300</span> <span class="o">*</span><span class="n">fusb300</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">[</span><span class="n">FUSB300_MAX_NUM_EP</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;platform_get_resource error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ires</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ires</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;platform_get_resource IORESOURCE_IRQ error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ires1</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ires1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;platform_get_resource IORESOURCE_IRQ 1 error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ioremap error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize udc */</span>
	<span class="n">fusb300</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fusb300</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;kzalloc error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FUSB300_MAX_NUM_EP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_ep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fusb300_ep</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_ep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;_ep kzalloc error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fusb300</span><span class="p">);</span>

	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fusb300_gadget_ops</span><span class="p">;</span>

	<span class="n">device_initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gadget&quot;</span><span class="p">);</span>

	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">max_speed</span> <span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">;</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span><span class="p">;</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">udc_name</span><span class="p">;</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">ires</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">fusb300_irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			  <span class="n">udc_name</span><span class="p">,</span> <span class="n">fusb300</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;request_irq error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">ires1</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">fusb300_irq</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">udc_name</span><span class="p">,</span> <span class="n">fusb300</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;request_irq1 error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FUSB300_MAX_NUM_EP</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fusb300_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">fusb300</span> <span class="o">=</span> <span class="n">fusb300</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">fusb300_ep_name</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fusb300_ep_ops</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">HS_BULK_MAX_PACKET_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">HS_CTL_MAX_PACKET_SIZE</span><span class="p">;</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="n">the_controller</span> <span class="o">=</span> <span class="n">fusb300</span><span class="p">;</span>

	<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep0_req</span> <span class="o">=</span> <span class="n">fusb300_alloc_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep0_req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">clean_up3</span><span class="p">;</span>

	<span class="n">init_controller</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_add_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_add_udc</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_VERSION</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_add_udc:</span>
	<span class="n">fusb300_free_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep0_req</span><span class="p">);</span>

<span class="nl">clean_up3:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ires</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">fusb300</span><span class="p">);</span>

<span class="nl">clean_up:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fusb300</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep0_req</span><span class="p">)</span>
			<span class="n">fusb300_free_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span>
				<span class="n">fusb300</span><span class="o">-&gt;</span><span class="n">ep0_req</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fusb300</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">fusb300_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>	<span class="n">__exit_p</span><span class="p">(</span><span class="n">fusb300_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>	<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">udc_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fusb300_udc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300_driver</span><span class="p">,</span> <span class="n">fusb300_probe</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">fusb300_udc_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">fusb300_udc_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fusb300_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">fusb300_udc_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
