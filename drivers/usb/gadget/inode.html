<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › gadget › inode.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>inode.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * inode.c -- user mode filesystem api for usb gadget controllers</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003-2004 David Brownell</span>
<span class="cm"> * Copyright (C) 2003 Agilent Technologies</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>


<span class="cm">/* #define VERBOSE_DEBUG */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/uts.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>

<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>

<span class="cp">#include &lt;linux/usb/gadgetfs.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>


<span class="cm">/*</span>
<span class="cm"> * The gadgetfs API maps each endpoint to a file descriptor so that you</span>
<span class="cm"> * can use standard synchronous read/write calls for I/O.  There&#39;s some</span>
<span class="cm"> * O_NONBLOCK and O_ASYNC/FASYNC style i/o support.  Example usermode</span>
<span class="cm"> * drivers show how this works in practice.  You can also use AIO to</span>
<span class="cm"> * eliminate I/O gaps between requests, to help when streaming data.</span>
<span class="cm"> *</span>
<span class="cm"> * Key parts that must be USB-specific are protocols defining how the</span>
<span class="cm"> * read/write operations relate to the hardware state machines.  There</span>
<span class="cm"> * are two types of files.  One type is for the device, implementing ep0.</span>
<span class="cm"> * The other type is for each IN or OUT endpoint.  In both cases, the</span>
<span class="cm"> * user mode driver must configure the hardware before using it.</span>
<span class="cm"> *</span>
<span class="cm"> * - First, dev_config() is called when /dev/gadget/$CHIP is configured</span>
<span class="cm"> *   (by writing configuration and device descriptors).  Afterwards it</span>
<span class="cm"> *   may serve as a source of device events, used to handle all control</span>
<span class="cm"> *   requests other than basic enumeration.</span>
<span class="cm"> *</span>
<span class="cm"> * - Then, after a SET_CONFIGURATION control request, ep_config() is</span>
<span class="cm"> *   called when each /dev/gadget/ep* file is configured (by writing</span>
<span class="cm"> *   endpoint descriptors).  Afterwards these files are used to write()</span>
<span class="cm"> *   IN data or to read() OUT data.  To halt the endpoint, a &quot;wrong</span>
<span class="cm"> *   direction&quot; request is issued (like reading an IN endpoint).</span>
<span class="cm"> *</span>
<span class="cm"> * Unlike &quot;usbfs&quot; the only ioctl()s are for things that are rare, and maybe</span>
<span class="cm"> * not possible on all hardware.  For example, precise fault handling with</span>
<span class="cm"> * respect to data left in endpoint fifos after aborted operations; or</span>
<span class="cm"> * selective clearing of endpoint halts, to implement SET_INTERFACE.</span>
<span class="cm"> */</span>

<span class="cp">#define	DRIVER_DESC	&quot;USB Gadget filesystem&quot;</span>
<span class="cp">#define	DRIVER_VERSION	&quot;24 Aug 2004&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_desc</span> <span class="p">[]</span> <span class="o">=</span> <span class="n">DRIVER_DESC</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">shortname</span> <span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;gadgetfs&quot;</span><span class="p">;</span>

<span class="n">MODULE_DESCRIPTION</span> <span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span> <span class="p">(</span><span class="s">&quot;David Brownell&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span> <span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>


<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cp">#define GADGETFS_MAGIC		0xaee71ee7</span>
<span class="cp">#define DMA_ADDR_INVALID	(~(dma_addr_t)0)</span>

<span class="cm">/* /dev/gadget/$CHIP represents ep0 and the whole device */</span>
<span class="k">enum</span> <span class="n">ep0_state</span> <span class="p">{</span>
	<span class="cm">/* DISBLED is the initial state.</span>
<span class="cm">	 */</span>
	<span class="n">STATE_DEV_DISABLED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

	<span class="cm">/* Only one open() of /dev/gadget/$CHIP; only one file tracks</span>
<span class="cm">	 * ep0/device i/o modes and binding to the controller.  Driver</span>
<span class="cm">	 * must always write descriptors to initialize the device, then</span>
<span class="cm">	 * the device becomes UNCONNECTED until enumeration.</span>
<span class="cm">	 */</span>
	<span class="n">STATE_DEV_OPENED</span><span class="p">,</span>

	<span class="cm">/* From then on, ep0 fd is in either of two basic modes:</span>
<span class="cm">	 * - (UN)CONNECTED: read usb_gadgetfs_event(s) from it</span>
<span class="cm">	 * - SETUP: read/write will transfer control data and succeed;</span>
<span class="cm">	 *   or if &quot;wrong direction&quot;, performs protocol stall</span>
<span class="cm">	 */</span>
	<span class="n">STATE_DEV_UNCONNECTED</span><span class="p">,</span>
	<span class="n">STATE_DEV_CONNECTED</span><span class="p">,</span>
	<span class="n">STATE_DEV_SETUP</span><span class="p">,</span>

	<span class="cm">/* UNBOUND means the driver closed ep0, so the device won&#39;t be</span>
<span class="cm">	 * accessible again (DEV_DISABLED) until all fds are closed.</span>
<span class="cm">	 */</span>
	<span class="n">STATE_DEV_UNBOUND</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* enough for the whole queue: most events invalidate others */</span>
<span class="cp">#define	N_EVENT			5</span>

<span class="k">struct</span> <span class="n">dev_data</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>			<span class="n">lock</span><span class="p">;</span>
	<span class="n">atomic_t</span>			<span class="n">count</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ep0_state</span>			<span class="n">state</span><span class="p">;</span>		<span class="cm">/* P: lock */</span>
	<span class="k">struct</span> <span class="n">usb_gadgetfs_event</span>	<span class="n">event</span> <span class="p">[</span><span class="n">N_EVENT</span><span class="p">];</span>
	<span class="kt">unsigned</span>			<span class="n">ev_next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fasync_struct</span>		<span class="o">*</span><span class="n">fasync</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="n">current_config</span><span class="p">;</span>

	<span class="cm">/* drivers reading ep0 MUST handle control requests (SETUP)</span>
<span class="cm">	 * reported that way; else the host will time out.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span>			<span class="n">usermode_setup</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
					<span class="n">setup_in</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
					<span class="n">setup_can_stall</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
					<span class="n">setup_out_ready</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
					<span class="n">setup_out_error</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
					<span class="n">setup_abort</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">setup_wLength</span><span class="p">;</span>

	<span class="cm">/* the rest is basically write-once */</span>
	<span class="k">struct</span> <span class="n">usb_config_descriptor</span>	<span class="o">*</span><span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">hs_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device_descriptor</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_request</span>		<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span>		<span class="o">*</span><span class="n">gadget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">epfiles</span><span class="p">;</span>
	<span class="kt">void</span>				<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>		<span class="n">wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span>		<span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span>			<span class="o">*</span><span class="n">dentry</span><span class="p">;</span>

	<span class="cm">/* except this scratch i/o buffer for ep0 */</span>
	<span class="n">u8</span>				<span class="n">rbuf</span> <span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">get_dev</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dev_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_dev</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dev_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* needs no more cleanup */</span>
	<span class="n">BUG_ON</span> <span class="p">(</span><span class="n">waitqueue_active</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">));</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dev_data</span> <span class="o">*</span><span class="nf">dev_new</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_data</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DEV_DISABLED</span><span class="p">;</span>
	<span class="n">atomic_set</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_lock_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">epfiles</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/* other /dev/gadget/$ENDPOINT files represent endpoints */</span>
<span class="k">enum</span> <span class="n">ep_state</span> <span class="p">{</span>
	<span class="n">STATE_EP_DISABLED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">STATE_EP_READY</span><span class="p">,</span>
	<span class="n">STATE_EP_ENABLED</span><span class="p">,</span>
	<span class="n">STATE_EP_UNBOUND</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ep_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mutex</span>			<span class="n">lock</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ep_state</span>			<span class="n">state</span><span class="p">;</span>
	<span class="n">atomic_t</span>			<span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dev_data</span>			<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="cm">/* must hold dev-&gt;lock before accessing ep or req */</span>
	<span class="k">struct</span> <span class="n">usb_ep</span>			<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_request</span>		<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">ssize_t</span>				<span class="n">status</span><span class="p">;</span>
	<span class="kt">char</span>				<span class="n">name</span> <span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span>	<span class="n">desc</span><span class="p">,</span> <span class="n">hs_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">epfiles</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>		<span class="n">wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span>			<span class="o">*</span><span class="n">dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span>			<span class="o">*</span><span class="n">inode</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">get_ep</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ep_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_ep</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ep_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">put_dev</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* needs no more cleanup */</span>
	<span class="n">BUG_ON</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">epfiles</span><span class="p">));</span>
	<span class="n">BUG_ON</span> <span class="p">(</span><span class="n">waitqueue_active</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">));</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/* most &quot;how to use the hardware&quot; policy choices are in userspace:</span>
<span class="cm"> * mapping endpoint roles (which the driver needs) to the capabilities</span>
<span class="cm"> * which the usb controller has.  most of those capabilities are exposed</span>
<span class="cm"> * implicitly, starting with the driver name and then endpoint names.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">CHIP</span><span class="p">;</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/* NOTE:  don&#39;t use dev_printk calls before binding to the gadget</span>
<span class="cm"> * at the end of ep0 configuration, or after unbind.</span>
<span class="cm"> */</span>

<span class="cm">/* too wordy: dev_printk(level , &amp;(d)-&gt;gadget-&gt;dev , fmt , ## args) */</span>
<span class="cp">#define xprintk(d,level,fmt,args...) \</span>
<span class="cp">	printk(level &quot;%s: &quot; fmt , shortname , ## args)</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define DBG(dev,fmt,args...) \</span>
<span class="cp">	xprintk(dev , KERN_DEBUG , fmt , ## args)</span>
<span class="cp">#else</span>
<span class="cp">#define DBG(dev,fmt,args...) \</span>
<span class="cp">	do { } while (0)</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG */</span><span class="cp"></span>

<span class="cp">#ifdef VERBOSE_DEBUG</span>
<span class="cp">#define VDEBUG	DBG</span>
<span class="cp">#else</span>
<span class="cp">#define VDEBUG(dev,fmt,args...) \</span>
<span class="cp">	do { } while (0)</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG */</span><span class="cp"></span>

<span class="cp">#define ERROR(dev,fmt,args...) \</span>
<span class="cp">	xprintk(dev , KERN_ERR , fmt , ## args)</span>
<span class="cp">#define INFO(dev,fmt,args...) \</span>
<span class="cp">	xprintk(dev , KERN_INFO , fmt , ## args)</span>


<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/* SYNCHRONOUS ENDPOINT OPERATIONS (bulk/intr/iso)</span>
<span class="cm"> *</span>
<span class="cm"> * After opening, configure non-control endpoints.  Then use normal</span>
<span class="cm"> * stream read() and write() requests; and maybe ioctl() to get more</span>
<span class="cm"> * precise FIFO status when recovering from cancellation.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">epio_complete</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep_data</span>	<span class="o">*</span><span class="n">epdata</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="n">epdata</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">epdata</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">complete</span> <span class="p">((</span><span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* tasklock endpoint, returning when it&#39;s connected.</span>
<span class="cm"> * still need dev-&gt;lock to use epdata-&gt;ep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">get_ready_ep</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">f_flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ep_data</span> <span class="o">*</span><span class="n">epdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nonblock</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">STATE_EP_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="nl">nonblock:</span>
			<span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STATE_EP_ENABLED</span>:
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>case STATE<em>EP</em>DISABLED:        /* "can't happen" <em>/
case STATE_EP_READY:            /</em> "can't happen" */</p></td><td class="code"><div class="highlight"><pre>	<span class="nl">default:</span>				<span class="cm">/* error! */</span>
		<span class="n">pr_debug</span> <span class="p">(</span><span class="s">&quot;%s: ep %p not available, state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">shortname</span><span class="p">,</span> <span class="n">epdata</span><span class="p">,</span> <span class="n">epdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>FALLTHROUGH</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">STATE_EP_UNBOUND</span>:			<span class="cm">/* clean disconnect */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ep_io</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ep_data</span> <span class="o">*</span><span class="n">epdata</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span> <span class="p">(</span><span class="n">done</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_request</span>	<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">epdata</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">done</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">epio_complete</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">usb_ep_queue</span> <span class="p">(</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span> <span class="p">(</span><span class="n">done</span><span class="p">.</span><span class="n">wait</span><span class="p">,</span> <span class="n">done</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DBG</span> <span class="p">(</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s i/o interrupted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">epdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">usb_ep_dequeue</span> <span class="p">(</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">epdata</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
				<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

				<span class="n">wait_event</span> <span class="p">(</span><span class="n">done</span><span class="p">.</span><span class="n">wait</span><span class="p">,</span> <span class="n">done</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">)</span>
					<span class="n">epdata</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

				<span class="n">DBG</span> <span class="p">(</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;endpoint gone</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">epdata</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">epdata</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* handle a synchronous OUT bulk/intr/iso transfer */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ep_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep_data</span>		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">kbuf</span><span class="p">;</span>
	<span class="kt">ssize_t</span>			<span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">=</span> <span class="n">get_ready_ep</span> <span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">f_flags</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/* halt any endpoint by doing a &quot;wrong direction&quot; i/o call */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DBG</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s halt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="n">usb_ep_set_halt</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME readahead for O_NONBLOCK and poll(); careful with ZLPs */</span>

	<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">kbuf</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="o">!</span><span class="n">kbuf</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free1</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">ep_io</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">kbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">VDEBUG</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s read %zu OUT, status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">kbuf</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="nl">free1:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">kbuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* handle a synchronous IN bulk/intr/iso transfer */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ep_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep_data</span>		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">kbuf</span><span class="p">;</span>
	<span class="kt">ssize_t</span>			<span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">=</span> <span class="n">get_ready_ep</span> <span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">f_flags</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/* halt any endpoint by doing a &quot;wrong direction&quot; i/o call */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DBG</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s halt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="n">usb_ep_set_halt</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME writebehind for O_NONBLOCK and poll(), qlen = 1 */</span>

	<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">kbuf</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kbuf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span> <span class="p">(</span><span class="n">kbuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">ep_io</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">kbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">VDEBUG</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s write %zu IN, status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
<span class="nl">free1:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">kbuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ep_release</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep_data</span>		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/* clean up if this can be reopened */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">STATE_EP_UNBOUND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_EP_DISABLED</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">hs_desc</span><span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">usb_ep_disable</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">put_ep</span> <span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">ep_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">code</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep_data</span>		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">get_ready_ep</span> <span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">f_flags</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GADGETFS_FIFO_STATUS</span>:
			<span class="n">status</span> <span class="o">=</span> <span class="n">usb_ep_fifo_status</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GADGETFS_FIFO_FLUSH</span>:
			<span class="n">usb_ep_fifo_flush</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GADGETFS_CLEAR_HALT</span>:
			<span class="n">status</span> <span class="o">=</span> <span class="n">usb_ep_clear_halt</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/* ASYNCHRONOUS ENDPOINT I/O OPERATIONS (bulk/intr/iso) */</span>

<span class="k">struct</span> <span class="n">kiocb_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ep_data</span>		<span class="o">*</span><span class="n">epdata</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span>	<span class="o">*</span><span class="n">iv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">nr_segs</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">actual</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_aio_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">io_event</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kiocb_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ep_data</span>		<span class="o">*</span><span class="n">epdata</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">value</span><span class="p">;</span>

	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="n">epdata</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">epdata</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>spin_lock(&amp;epdata->dev->lock);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">kiocbSetCancelled</span><span class="p">(</span><span class="n">iocb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">epdata</span> <span class="o">&amp;&amp;</span> <span class="n">epdata</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">))</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">usb_ep_dequeue</span> <span class="p">(</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>spin_unlock(&amp;epdata->dev->lock);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">local_irq_enable</span><span class="p">();</span>

	<span class="n">aio_put_req</span><span class="p">(</span><span class="n">iocb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ep_aio_read_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kiocb_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">ssize_t</span>			<span class="n">len</span><span class="p">,</span> <span class="n">total</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">to_copy</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>

	<span class="cm">/* we &quot;retry&quot; to get the right mm context for this: */</span>

	<span class="cm">/* copy stuff into user buffers */</span>
	<span class="n">total</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">to_copy</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr_segs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">ssize_t</span> <span class="n">this</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">ssize_t</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">),</span> <span class="n">total</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span> <span class="n">to_copy</span><span class="p">,</span> <span class="n">this</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">total</span> <span class="o">-=</span> <span class="n">this</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">this</span><span class="p">;</span>
		<span class="n">to_copy</span> <span class="o">+=</span> <span class="n">this</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep_aio_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kiocb</span>		<span class="o">*</span><span class="n">iocb</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kiocb_priv</span>	<span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ep_data</span>		<span class="o">*</span><span class="n">epdata</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">epdata</span><span class="p">;</span>

	<span class="cm">/* lock against disconnect (and ideally, cancel) */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">epdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* if this was a write or a read returning no data then we</span>
<span class="cm">	 * don&#39;t need to copy anything to userspace, so we can</span>
<span class="cm">	 * complete the aio request immediately.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iv</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">iocb</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="cm">/* aio_complete() reports bytes-transferred _and_ faults */</span>
		<span class="n">aio_complete</span><span class="p">(</span><span class="n">iocb</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">?</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">:</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* retry() won&#39;t report both; so we hide some faults */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s fault %d len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">;</span>
		<span class="n">kick_iocb</span><span class="p">(</span><span class="n">iocb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">put_ep</span><span class="p">(</span><span class="n">epdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ep_aio_rwtail</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">kiocb</span>	<span class="o">*</span><span class="n">iocb</span><span class="p">,</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="kt">size_t</span>		<span class="n">len</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ep_data</span>	<span class="o">*</span><span class="n">epdata</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iv</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">nr_segs</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kiocb_priv</span>	<span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">ssize_t</span>			<span class="n">value</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="nl">fail:</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iocb</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">iv</span> <span class="o">=</span> <span class="n">iv</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr_segs</span> <span class="o">=</span> <span class="n">nr_segs</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">get_ready_ep</span><span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_filp</span><span class="o">-&gt;</span><span class="n">f_flags</span><span class="p">,</span> <span class="n">epdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_cancel</span> <span class="o">=</span> <span class="n">ep_aio_cancel</span><span class="p">;</span>
	<span class="n">get_ep</span><span class="p">(</span><span class="n">epdata</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">epdata</span> <span class="o">=</span> <span class="n">epdata</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* each kiocb is coupled to one usb_request, but we can&#39;t</span>
<span class="cm">	 * allocate or submit those if the host disconnected.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">usb_ep_alloc_request</span><span class="p">(</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">ep_aio_complete</span><span class="p">;</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">iocb</span><span class="p">;</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">value</span><span class="p">))</span>
				<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">put_ep</span><span class="p">(</span><span class="n">epdata</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">iv</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIOCBRETRY</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIOCBQUEUED</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ep_aio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_segs</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep_data</span>		<span class="o">*</span><span class="n">epdata</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_left</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_retry</span> <span class="o">=</span> <span class="n">ep_aio_read_retry</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ep_aio_rwtail</span><span class="p">(</span><span class="n">iocb</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_left</span><span class="p">,</span> <span class="n">epdata</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span> <span class="n">nr_segs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ep_aio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_segs</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep_data</span>		<span class="o">*</span><span class="n">epdata</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">size_t</span>			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epdata</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_left</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_segs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">],</span> <span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span>
				<span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ep_aio_rwtail</span><span class="p">(</span><span class="n">iocb</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">epdata</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/* used after endpoint configuration */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ep_io_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">no_llseek</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>		<span class="n">ep_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">ep_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">ep_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">ep_release</span><span class="p">,</span>

	<span class="p">.</span><span class="n">aio_read</span> <span class="o">=</span>	<span class="n">ep_aio_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">aio_write</span> <span class="o">=</span>	<span class="n">ep_aio_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ENDPOINT INITIALIZATION</span>
<span class="cm"> *</span>
<span class="cm"> *     fd = open (&quot;/dev/gadget/$ENDPOINT&quot;, O_RDWR)</span>
<span class="cm"> *     status = write (fd, descriptors, sizeof descriptors)</span>
<span class="cm"> *</span>
<span class="cm"> * That write establishes the endpoint configuration, configuring</span>
<span class="cm"> * the controller to process bulk, interrupt, or isochronous transfers</span>
<span class="cm"> * at the right maxpacket size, and so on.</span>
<span class="cm"> *</span>
<span class="cm"> * The descriptors are message type 1, identified by a host order u32</span>
<span class="cm"> * at the beginning of what&#39;s written.  Descriptor order is: full/low</span>
<span class="cm"> * speed descriptor, then optional high speed descriptor.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ep_config</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep_data</span>		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_ep</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">tag</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">value</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">STATE_EP_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EL2HLT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">USB_DT_ENDPOINT_SIZE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>

	<span class="cm">/* we might need to change message format someday */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tag</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;config %s, bad tag %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* NOTE:  audio endpoint extensions not accepted here;</span>
<span class="cm">	 * just don&#39;t include the extra bytes.</span>
<span class="cm">	 */</span>

	<span class="cm">/* full/low speed descriptor, then high speed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bLength</span> <span class="o">!=</span> <span class="n">USB_DT_ENDPOINT_SIZE</span>
			<span class="o">||</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">!=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hs_desc</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
					<span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hs_desc</span><span class="p">.</span><span class="n">bLength</span> <span class="o">!=</span> <span class="n">USB_DT_ENDPOINT_SIZE</span>
				<span class="o">||</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hs_desc</span><span class="p">.</span><span class="n">bDescriptorType</span>
					<span class="o">!=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;config %s, bad hs length or type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_DEV_UNBOUND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">gone</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ep</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">gone</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_SPEED_LOW</span>:
	<span class="k">case</span> <span class="n">USB_SPEED_FULL</span>:
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">usb_ep_enable</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_EP_ENABLED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef	CONFIG_USB_GADGET_DUALSPEED</span>
	<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
		<span class="cm">/* fails if caller didn&#39;t provide that descriptor... */</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hs_desc</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">usb_ep_enable</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_EP_ENABLED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unconnected, %s init abandoned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fd</span><span class="o">-&gt;</span><span class="n">f_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep_io_operations</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">gone:</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">fail:</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">hs_desc</span><span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="nl">fail0:</span>
	<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
<span class="nl">fail1:</span>
	<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ep_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ep_data</span>		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_DEV_UNBOUND</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_EP_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_EP_READY</span><span class="p">;</span>
		<span class="n">get_ep</span> <span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">VDEBUG</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">DBG</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* used before endpoint configuration */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ep_config_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">no_llseek</span><span class="p">,</span>

	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">ep_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">ep_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">ep_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/* EP0 IMPLEMENTATION can be partly in userspace.</span>
<span class="cm"> *</span>
<span class="cm"> * Drivers that use this facility receive various events, including</span>
<span class="cm"> * control requests the kernel doesn&#39;t handle.  Drivers that don&#39;t</span>
<span class="cm"> * use this facility may be too simple-minded for real applications.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ep0_readable</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dev_data</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wake_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">kill_fasync</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fasync</span><span class="p">,</span> <span class="n">SIGIO</span><span class="p">,</span> <span class="n">POLL_IN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clean_req</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_data</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">epio_complete</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_out_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep0_complete</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_data</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">free</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* for control OUT, data must still get to userspace */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_out_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_out_error</span><span class="p">)</span>
			<span class="n">free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_out_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ep0_readable</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* clean up as appropriate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">free</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">)</span>
		<span class="n">clean_req</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">epio_complete</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_req</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_data</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_out_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ep0 request busy!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">))</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">ep0_complete</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ep0_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_data</span>			<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">ssize_t</span>				<span class="n">retval</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ep0_state</span>			<span class="n">state</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* report fd mode change before acting on it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_abort</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_abort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIDRM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* control DATA stage */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">state</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">STATE_DEV_SETUP</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_in</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* stall IN */</span>
			<span class="n">VDEBUG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ep0in stall</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">usb_ep_set_halt</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EL2HLT</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DEV_CONNECTED</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* ack SET_CONFIGURATION etc */</span>
			<span class="k">struct</span> <span class="n">usb_ep</span>		<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">usb_request</span>	<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">setup_req</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_ep_queue</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DEV_CONNECTED</span><span class="p">;</span>

			<span class="cm">/* assume that was SET_CONFIGURATION */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_config</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="n">power</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">gadget_is_dualspeed</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">)</span>
						<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">speed</span>
							<span class="o">==</span> <span class="n">USB_SPEED_HIGH</span><span class="p">))</span>
					<span class="n">power</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hs_config</span><span class="o">-&gt;</span><span class="n">bMaxPower</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">power</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">bMaxPower</span><span class="p">;</span>
				<span class="n">usb_gadget_vbus_draw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">power</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>			<span class="cm">/* collect OUT data */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
					<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_out_ready</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_out_ready</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* FIXME state could change from under us */</span>
			<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">STATE_DEV_SETUP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DEV_CONNECTED</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_out_error</span><span class="p">)</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">min</span> <span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>FIXME don't call this with the spinlock held ...</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
				<span class="n">clean_req</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
				<span class="cm">/* NOTE userspace can&#39;t yet choose to stall */</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* else normal: return event data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="n">len</span> <span class="o">%</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadgetfs_event</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usermode_setup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">scan:</span>
	<span class="cm">/* return queued events right away */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ev_next</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span>		<span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

		<span class="n">n</span> <span class="o">=</span> <span class="n">len</span> <span class="o">/</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadgetfs_event</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ev_next</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ev_next</span><span class="p">;</span>

		<span class="cm">/* ep0 i/o has special semantics during STATE_DEV_SETUP */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">GADGETFS_SETUP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DEV_SETUP</span><span class="p">;</span>
				<span class="n">n</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadgetfs_event</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* NOTE this doesn&#39;t guard against broken drivers;</span>
<span class="cm">			 * concurrent ep0 readers may lose events.</span>
<span class="cm">			 */</span>
			<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ev_next</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
					<span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadgetfs_event</span><span class="p">)</span>
						<span class="o">*</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ev_next</span> <span class="o">-</span> <span class="n">n</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ev_next</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">DBG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fail %s, state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STATE_DEV_UNCONNECTED</span>:
	<span class="k">case</span> <span class="n">STATE_DEV_CONNECTED</span>:
		<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">DBG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s wait</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="cm">/* wait for events */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ev_next</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">scan</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_gadgetfs_event</span> <span class="o">*</span>
<span class="nf">next_event</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dev_data</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">usb_gadgetfs_event_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_gadgetfs_event</span>	<span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* these events purge the queue */</span>
	<span class="k">case</span> <span class="n">GADGETFS_DISCONNECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_DEV_SETUP</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_abort</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>FALL THROUGH</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">GADGETFS_CONNECT</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ev_next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GADGETFS_SETUP</span>:		<span class="cm">/* previous request timed out */</span>
	<span class="k">case</span> <span class="n">GADGETFS_SUSPEND</span>:		<span class="cm">/* same effect */</span>
		<span class="cm">/* these events can&#39;t be repeated */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ev_next</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;discard old event[%d] %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ev_next</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ev_next</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* indices start at zero, for simplicity */</span>
			<span class="n">memmove</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
				<span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadgetfs_event</span><span class="p">)</span>
					<span class="o">*</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ev_next</span> <span class="o">-</span> <span class="n">i</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span> <span class="p">();</span>
	<span class="p">}</span>
	<span class="n">VDEBUG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;event[%d] = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ev_next</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">event</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ev_next</span><span class="o">++</span><span class="p">];</span>
	<span class="n">BUG_ON</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ev_next</span> <span class="o">&gt;</span> <span class="n">N_EVENT</span><span class="p">);</span>
	<span class="n">memset</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">event</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ep0_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_data</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">ssize_t</span>			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* report fd mode change before acting on it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_abort</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_abort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIDRM</span><span class="p">;</span>

	<span class="cm">/* data and/or status stage for control request */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_DEV_SETUP</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* IN DATA+STATUS caller makes len &lt;= wLength */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">setup_req</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DEV_CONNECTED</span><span class="p">;</span>
				<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_wLength</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">zero</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_ep_queue</span> <span class="p">(</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span>
						<span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
					<span class="n">clean_req</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
					<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

				<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="cm">/* can stall some OUT transfers */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_can_stall</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">VDEBUG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ep0out stall</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">usb_ep_set_halt</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EL2HLT</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DEV_CONNECTED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bogus ep0out stall!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">DBG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fail %s, state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ep0_fasync</span> <span class="p">(</span><span class="kt">int</span> <span class="n">f</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_data</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>caller must F_SETOWN before signal delivery happens</p></td><td class="code"><div class="highlight"><pre>	<span class="n">VDEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">on</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fasync_helper</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">on</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fasync</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="n">gadgetfs_driver</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dev_release</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_data</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* closing ep0 === shutdown all */</span>

	<span class="n">usb_gadget_unregister_driver</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">gadgetfs_driver</span><span class="p">);</span>

	<span class="cm">/* at this point &quot;good&quot; hardware has disconnected the</span>
<span class="cm">	 * device from USB; the host won&#39;t see it any more.</span>
<span class="cm">	 * alternatively, all host requests will time out.</span>
<span class="cm">	 */</span>

	<span class="n">kfree</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">put_dev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* other endpoints were all decoupled from this device */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DEV_DISABLED</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">ep0_poll</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
       <span class="k">struct</span> <span class="n">dev_data</span>         <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
       <span class="kt">int</span>                     <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

       <span class="n">poll_wait</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

       <span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

       <span class="cm">/* report fd mode change before acting on it */</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_abort</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_abort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
               <span class="n">mask</span> <span class="o">=</span> <span class="n">POLLHUP</span><span class="p">;</span>
               <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
       <span class="p">}</span>

       <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_DEV_SETUP</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_in</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_can_stall</span><span class="p">)</span>
                       <span class="n">mask</span> <span class="o">=</span> <span class="n">POLLOUT</span><span class="p">;</span>
       <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ev_next</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                       <span class="n">mask</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
       <span class="p">}</span>
<span class="nl">out:</span>
       <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
       <span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">dev_ioctl</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">code</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_data</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span>	<span class="o">*</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ioctl</span> <span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* used after device configuration */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ep0_io_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">no_llseek</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>		<span class="n">ep0_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">ep0_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fasync</span> <span class="o">=</span>	<span class="n">ep0_fasync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span>		<span class="n">ep0_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span>	<span class="n">dev_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">dev_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/* The in-kernel gadget driver handles most ep0 issues, in particular</span>
<span class="cm"> * enumerating the single configuration (as provided from user space).</span>
<span class="cm"> *</span>
<span class="cm"> * Unrecognized ep0 requests may be handled in user space.</span>
<span class="cm"> */</span>

<span class="cp">#ifdef	CONFIG_USB_GADGET_DUALSPEED</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">make_qualifier</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dev_data</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_qualifier_descriptor</span>		<span class="n">qual</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device_descriptor</span>		<span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">qual</span><span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">qual</span><span class="p">;</span>
	<span class="n">qual</span><span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_DEVICE_QUALIFIER</span><span class="p">;</span>
	<span class="n">qual</span><span class="p">.</span><span class="n">bcdUSB</span> <span class="o">=</span> <span class="n">cpu_to_le16</span> <span class="p">(</span><span class="mh">0x0200</span><span class="p">);</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">qual</span><span class="p">.</span><span class="n">bDeviceClass</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDeviceClass</span><span class="p">;</span>
	<span class="n">qual</span><span class="p">.</span><span class="n">bDeviceSubClass</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDeviceSubClass</span><span class="p">;</span>
	<span class="n">qual</span><span class="p">.</span><span class="n">bDeviceProtocol</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDeviceProtocol</span><span class="p">;</span>

	<span class="cm">/* assumes ep0 uses the same value for both speeds ... */</span>
	<span class="n">qual</span><span class="p">.</span><span class="n">bMaxPacketSize0</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>

	<span class="n">qual</span><span class="p">.</span><span class="n">bNumConfigurations</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qual</span><span class="p">.</span><span class="n">bRESERVED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qual</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">qual</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">config_buf</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dev_data</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">hs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* only one configuration */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gadget_is_dualspeed</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hs</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_DT_OTHER_SPEED_CONFIG</span><span class="p">)</span>
			<span class="n">hs</span> <span class="o">=</span> <span class="o">!</span><span class="n">hs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hs_config</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hs_config</span><span class="o">-&gt;</span><span class="n">wTotalLength</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">wTotalLength</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">gadgetfs_setup</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_data</span>			<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">get_gadget_data</span> <span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_request</span>		<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadgetfs_event</span>	<span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="n">u16</span>				<span class="n">w_value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">);</span>
	<span class="n">u16</span>				<span class="n">w_length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">);</span>

	<span class="n">spin_lock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_abort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_DEV_UNCONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gadget_is_dualspeed</span><span class="p">(</span><span class="n">gadget</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="n">gadget</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span>
				<span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hs_config</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">ERROR</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no high speed config??</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DEV_CONNECTED</span><span class="p">;</span>

		<span class="n">INFO</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">next_event</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GADGETFS_CONNECT</span><span class="p">);</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">gadget</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
		<span class="n">ep0_readable</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* host may have given up waiting for response.  we can miss control</span>
<span class="cm">	 * requests handled lower down (device/endpoint status and features);</span>
<span class="cm">	 * then ep0_{read,write} will report the wrong status. controller</span>
<span class="cm">	 * driver will have aborted pending i/o.</span>
<span class="cm">	 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_DEV_SETUP</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_abort</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequest</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">USB_REQ_GET_DESCRIPTOR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unrecognized</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">w_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">USB_DT_DEVICE</span>:
			<span class="n">value</span> <span class="o">=</span> <span class="n">min</span> <span class="p">(</span><span class="n">w_length</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bMaxPacketSize0</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef	CONFIG_USB_GADGET_DUALSPEED</span>
		<span class="k">case</span> <span class="n">USB_DT_DEVICE_QUALIFIER</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hs_config</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">min</span> <span class="p">(</span><span class="n">w_length</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span>
				<span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_qualifier_descriptor</span><span class="p">));</span>
			<span class="n">make_qualifier</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_DT_OTHER_SPEED_CONFIG</span>:</pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>FALLTHROUGH</p></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span>
		<span class="k">case</span> <span class="n">USB_DT_CONFIG</span>:
			<span class="n">value</span> <span class="o">=</span> <span class="n">config_buf</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">w_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
					<span class="n">w_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">min</span> <span class="p">(</span><span class="n">w_length</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_DT_STRING</span>:
			<span class="k">goto</span> <span class="n">unrecognized</span><span class="p">;</span>

		<span class="nl">default:</span>		<span class="c1">// all others are errors</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* currently one config, two speeds */</span>
	<span class="k">case</span> <span class="n">USB_REQ_SET_CONFIGURATION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unrecognized</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">w_value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">usb_gadget_vbus_draw</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="mi">8</span> <span class="cm">/* mA */</span> <span class="p">);</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>user mode expected to disable endpoints</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u8</span>	<span class="n">config</span><span class="p">,</span> <span class="n">power</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">gadget_is_dualspeed</span><span class="p">(</span><span class="n">gadget</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="n">gadget</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">config</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hs_config</span><span class="o">-&gt;</span><span class="n">bConfigurationValue</span><span class="p">;</span>
				<span class="n">power</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hs_config</span><span class="o">-&gt;</span><span class="n">bMaxPower</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">config</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">bConfigurationValue</span><span class="p">;</span>
				<span class="n">power</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">bMaxPower</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">config</span> <span class="o">==</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">w_value</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
				<span class="n">usb_gadget_vbus_draw</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">power</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* report SET_CONFIGURATION like any other control request,</span>
<span class="cm">		 * except that usermode may not stall this.  the next</span>
<span class="cm">		 * request mustn&#39;t be allowed start until this finishes:</span>
<span class="cm">		 * endpoints and threads set up, etc.</span>
<span class="cm">		 *</span>
<span class="cm">		 * NOTE:  older PXA hardware (before PXA 255: without UDCCFR)</span>
<span class="cm">		 * has bad/racey automagic that prevents synchronizing here.</span>
<span class="cm">		 * even kernel mode drivers often miss them.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">INFO</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;configuration #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_config</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usermode_setup</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_can_stall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">delegate</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifndef	CONFIG_USB_GADGET_PXA25X</span>
	<span class="cm">/* PXA automagically handles this request too */</span>
	<span class="k">case</span> <span class="n">USB_REQ_GET_CONFIGURATION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unrecognized</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_config</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">min</span> <span class="p">(</span><span class="n">w_length</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="nl">default:</span>
<span class="nl">unrecognized:</span>
		<span class="n">VDEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s req%02x.%02x v%04x i%04x l%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usermode_setup</span> <span class="o">?</span> <span class="s">&quot;delegate&quot;</span> <span class="o">:</span> <span class="s">&quot;fail&quot;</span><span class="p">,</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequest</span><span class="p">,</span>
			<span class="n">w_value</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">),</span> <span class="n">w_length</span><span class="p">);</span>

		<span class="cm">/* if there&#39;s an ep0 reader, don&#39;t stall */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usermode_setup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_can_stall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">delegate:</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
						<span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_wLength</span> <span class="o">=</span> <span class="n">w_length</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_out_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_out_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* read DATA stage for OUT right away */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_in</span> <span class="o">&amp;&amp;</span> <span class="n">w_length</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">setup_req</span> <span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span>
							<span class="n">w_length</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">usb_ep_queue</span> <span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span>
							<span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">clean_req</span> <span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* we can&#39;t currently stall these */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">setup_can_stall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* state changes when reader collects event */</span>
			<span class="n">event</span> <span class="o">=</span> <span class="n">next_event</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GADGETFS_SETUP</span><span class="p">);</span>
			<span class="n">event</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
			<span class="n">ep0_readable</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">spin_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* proceed with data transfer and status phases? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">STATE_DEV_SETUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">zero</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">w_length</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">usb_ep_queue</span> <span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ep_queue --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* device stalls when value &lt; 0 */</span>
	<span class="n">spin_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy_ep_files</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dev_data</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/* dev-&gt;state must prevent interference */</span>
	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">epfiles</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ep_data</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">inode</span>	<span class="o">*</span><span class="n">parent</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">dentry</span>	<span class="o">*</span><span class="n">dentry</span><span class="p">;</span>

		<span class="cm">/* break link to FS */</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">list_first_entry</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">epfiles</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ep_data</span><span class="p">,</span> <span class="n">epfiles</span><span class="p">);</span>
		<span class="n">list_del_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epfiles</span><span class="p">);</span>
		<span class="n">dentry</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>

		<span class="cm">/* break link to controller */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_EP_ENABLED</span><span class="p">)</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">usb_ep_disable</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_EP_UNBOUND</span><span class="p">;</span>
		<span class="n">usb_ep_free_request</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">wake_up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">put_ep</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>

		<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="cm">/* break link to dcache */</span>
		<span class="n">mutex_lock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
		<span class="n">d_delete</span> <span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
		<span class="n">dput</span> <span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
		<span class="n">mutex_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>

		<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span>
<span class="n">gadgetfs_create_file</span> <span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="o">*</span><span class="n">fops</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dentry</span> <span class="o">**</span><span class="n">dentry_p</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">activate_ep_files</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dev_data</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ep_data</span>	<span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">gadget_for_each_ep</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">enomem0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_EP_DISABLED</span><span class="p">;</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">init_waitqueue_head</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>

		<span class="n">strncpy</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">atomic_set</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">get_dev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="n">usb_ep_alloc_request</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">enomem1</span><span class="p">;</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">inode</span> <span class="o">=</span> <span class="n">gadgetfs_create_file</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sb</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep_config_operations</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">enomem2</span><span class="p">;</span>
		<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">epfiles</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">epfiles</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">enomem2:</span>
	<span class="n">usb_ep_free_request</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
<span class="nl">enomem1:</span>
	<span class="n">put_dev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="nl">enomem0:</span>
	<span class="n">DBG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s enomem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">destroy_ep_files</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gadgetfs_unbind</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_data</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">get_gadget_data</span> <span class="p">(</span><span class="n">gadget</span><span class="p">);</span>

	<span class="n">DBG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DEV_UNBOUND</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">destroy_ep_files</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">set_gadget_data</span> <span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* we&#39;ve already been disconnected ... no i/o is active */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">)</span>
		<span class="n">usb_ep_free_request</span> <span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="n">DBG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">put_dev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dev_data</span>		<span class="o">*</span><span class="n">the_device</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">gadgetfs_bind</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_data</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">the_device</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">strcmp</span> <span class="p">(</span><span class="n">CHIP</span><span class="p">,</span> <span class="n">gadget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s expected %s controller not %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">shortname</span><span class="p">,</span> <span class="n">CHIP</span><span class="p">,</span> <span class="n">gadget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_gadget_data</span> <span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">gadget</span><span class="p">;</span>
	<span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* preallocate control response and buffer */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="n">usb_ep_alloc_request</span> <span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">enomem</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">epio_complete</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">activate_ep_files</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">enomem</span><span class="p">;</span>

	<span class="n">INFO</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bound to %s driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gadget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DEV_UNCONNECTED</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">get_dev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">enomem:</span>
	<span class="n">gadgetfs_unbind</span> <span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gadgetfs_disconnect</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_data</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">get_gadget_data</span> <span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_DEV_UNCONNECTED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DEV_UNCONNECTED</span><span class="p">;</span>

	<span class="n">INFO</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">next_event</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GADGETFS_DISCONNECT</span><span class="p">);</span>
	<span class="n">ep0_readable</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gadgetfs_suspend</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_data</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">get_gadget_data</span> <span class="p">(</span><span class="n">gadget</span><span class="p">);</span>

	<span class="n">INFO</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;suspended from state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">spin_lock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STATE_DEV_SETUP</span>:		<span class="c1">// VERY odd... host died??</span>
	<span class="k">case</span> <span class="n">STATE_DEV_CONNECTED</span>:
	<span class="k">case</span> <span class="n">STATE_DEV_UNCONNECTED</span>:
		<span class="n">next_event</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GADGETFS_SUSPEND</span><span class="p">);</span>
		<span class="n">ep0_readable</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* FALLTHROUGH */</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="n">gadgetfs_driver</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef	CONFIG_USB_GADGET_DUALSPEED</span>
	<span class="p">.</span><span class="n">max_speed</span>	<span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">,</span>
<span class="cp">#else</span>
	<span class="p">.</span><span class="n">max_speed</span>	<span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">function</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">driver_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind</span>		<span class="o">=</span> <span class="n">gadgetfs_unbind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>		<span class="o">=</span> <span class="n">gadgetfs_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">gadgetfs_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">gadgetfs_suspend</span><span class="p">,</span>

	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">shortname</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gadgetfs_nop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gadgetfs_probe</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CHIP</span> <span class="o">=</span> <span class="n">gadget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EISNAM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="n">probe_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">max_speed</span>	<span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind</span>		<span class="o">=</span> <span class="n">gadgetfs_nop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">gadgetfs_nop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">gadgetfs_nop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;nop&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>


<span class="cm">/* DEVICE INITIALIZATION</span>
<span class="cm"> *</span>
<span class="cm"> *     fd = open (&quot;/dev/gadget/$CHIP&quot;, O_RDWR)</span>
<span class="cm"> *     status = write (fd, descriptors, sizeof descriptors)</span>
<span class="cm"> *</span>
<span class="cm"> * That write establishes the device configuration, so the kernel can</span>
<span class="cm"> * bind to the controller ... guaranteeing it can handle enumeration</span>
<span class="cm"> * at all necessary speeds.  Descriptor order is:</span>
<span class="cm"> *</span>
<span class="cm"> * . message tag (u32, host order) ... for now, must be zero; it</span>
<span class="cm"> *	would change to support features like multi-config devices</span>
<span class="cm"> * . full/low speed config ... all wTotalLength bytes (with interface,</span>
<span class="cm"> *	class, altsetting, endpoint, and other descriptors)</span>
<span class="cm"> * . high speed config ... all descriptors, for high speed operation;</span>
<span class="cm"> *	this one&#39;s optional except for high-speed hardware</span>
<span class="cm"> * . device descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * Endpoints are not yet enabled. Drivers must wait until device</span>
<span class="cm"> * configuration and interface altsetting changes create</span>
<span class="cm"> * the need to configure (or unconfigure) them.</span>
<span class="cm"> *</span>
<span class="cm"> * After initialization, the device stays active for as long as that</span>
<span class="cm"> * $CHIP file is open.  Events must then be read from that descriptor,</span>
<span class="cm"> * such as configuration notifications.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_valid_config</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_config_descriptor</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">==</span> <span class="n">USB_DT_CONFIG</span>
		<span class="o">&amp;&amp;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">bLength</span> <span class="o">==</span> <span class="n">USB_DT_CONFIG_SIZE</span>
		<span class="o">&amp;&amp;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">bConfigurationValue</span> <span class="o">!=</span> <span class="mi">0</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="n">USB_CONFIG_ATT_ONE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="n">USB_CONFIG_ATT_WAKEUP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* FIXME if gadget-&gt;is_otg, _must_ include an otg descriptor */</span>
	<span class="cm">/* FIXME check lengths: walk to end */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dev_config</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_data</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">ssize_t</span>			<span class="n">value</span> <span class="o">=</span> <span class="n">len</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">total</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">tag</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">kbuf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">USB_DT_CONFIG_SIZE</span> <span class="o">+</span> <span class="n">USB_DT_DEVICE_SIZE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* we might need to change message format someday */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tag</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">length</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">kbuf</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">kbuf</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">kbuf</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kbuf</span><span class="p">;</span>

	<span class="cm">/* full or low speed config */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">kbuf</span><span class="p">;</span>
	<span class="n">total</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">wTotalLength</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_config</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span> <span class="o">||</span> <span class="n">total</span> <span class="o">&gt;=</span> <span class="n">length</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">kbuf</span> <span class="o">+=</span> <span class="n">total</span><span class="p">;</span>
	<span class="n">length</span> <span class="o">-=</span> <span class="n">total</span><span class="p">;</span>

	<span class="cm">/* optional high speed config */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kbuf</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">USB_DT_CONFIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hs_config</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">kbuf</span><span class="p">;</span>
		<span class="n">total</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hs_config</span><span class="o">-&gt;</span><span class="n">wTotalLength</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_config</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hs_config</span><span class="p">)</span> <span class="o">||</span> <span class="n">total</span> <span class="o">&gt;=</span> <span class="n">length</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="n">kbuf</span> <span class="o">+=</span> <span class="n">total</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">total</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* could support multiple configs, using another encoding! */</span>

	<span class="cm">/* device descriptor (tweaked for paranoia) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">!=</span> <span class="n">USB_DT_DEVICE_SIZE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">kbuf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bLength</span> <span class="o">!=</span> <span class="n">USB_DT_DEVICE_SIZE</span>
			<span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">!=</span> <span class="n">USB_DT_DEVICE</span>
			<span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bNumConfigurations</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bNumConfigurations</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bcdUSB</span> <span class="o">=</span> <span class="n">cpu_to_le16</span> <span class="p">(</span><span class="mh">0x0200</span><span class="p">);</span>

	<span class="cm">/* triggers gadgetfs_bind(); then we can enumerate. */</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">usb_gadget_probe_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gadgetfs_driver</span><span class="p">,</span> <span class="n">gadgetfs_bind</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* at this point &quot;good&quot; hardware has for the first time</span>
<span class="cm">		 * let the USB the host see us.  alternatively, if users</span>
<span class="cm">		 * unplug/replug that will clear all the error state.</span>
<span class="cm">		 *</span>
<span class="cm">		 * note:  everything running before here was guaranteed</span>
<span class="cm">		 * to choke driver model style diagnostics.  from here</span>
<span class="cm">		 * on, they can work ... except in cleanup paths that</span>
<span class="cm">		 * kick in after the ep0 descriptor is closed.</span>
<span class="cm">		 */</span>
		<span class="n">fd</span><span class="o">-&gt;</span><span class="n">f_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep0_io_operations</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">pr_debug</span> <span class="p">(</span><span class="s">&quot;%s: %s fail %Zd, %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">shortname</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dev_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_data</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_DEV_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ev_next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DEV_OPENED</span><span class="p">;</span>
		<span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">get_dev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dev_init_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">no_llseek</span><span class="p">,</span>

	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">dev_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">dev_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fasync</span> <span class="o">=</span>	<span class="n">ep0_fasync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">dev_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">dev_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/* FILESYSTEM AND SUPERBLOCK OPERATIONS</span>
<span class="cm"> *</span>
<span class="cm"> * Mounting the filesystem creates a controller file, used first for</span>
<span class="cm"> * device configuration then later for event monitoring.</span>
<span class="cm"> */</span>


<span class="cm">/* FIXME PAM etc could set this security policy without mount options</span>
<span class="cm"> * if epfiles inherited ownership and permissons from ep0 ...</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">default_uid</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">default_gid</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">default_perm</span> <span class="o">=</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>

<span class="n">module_param</span> <span class="p">(</span><span class="n">default_uid</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span> <span class="p">(</span><span class="n">default_gid</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span> <span class="p">(</span><span class="n">default_perm</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span>
<span class="nf">gadgetfs_make_inode</span> <span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="o">*</span><span class="n">fops</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">new_inode</span> <span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">=</span> <span class="n">get_next_ino</span><span class="p">();</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_uid</span> <span class="o">=</span> <span class="n">default_uid</span><span class="p">;</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_gid</span> <span class="o">=</span> <span class="n">default_gid</span><span class="p">;</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_atime</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span>
				<span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_fop</span> <span class="o">=</span> <span class="n">fops</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* creates in fs root directory, so non-renamable and non-linkable.</span>
<span class="cm"> * so inode and dentry are paired, until device reconfig.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span>
<span class="nf">gadgetfs_create_file</span> <span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="o">*</span><span class="n">fops</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dentry</span> <span class="o">**</span><span class="n">dentry_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span>	<span class="o">*</span><span class="n">dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span>	<span class="o">*</span><span class="n">inode</span><span class="p">;</span>

	<span class="n">dentry</span> <span class="o">=</span> <span class="n">d_alloc_name</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dentry</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">inode</span> <span class="o">=</span> <span class="n">gadgetfs_make_inode</span> <span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fops</span><span class="p">,</span>
			<span class="n">S_IFREG</span> <span class="o">|</span> <span class="p">(</span><span class="n">default_perm</span> <span class="o">&amp;</span> <span class="n">S_IRWXUGO</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">d_add</span> <span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
	<span class="o">*</span><span class="n">dentry_p</span> <span class="o">=</span> <span class="n">dentry</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">super_operations</span> <span class="n">gadget_fs_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">statfs</span> <span class="o">=</span>	<span class="n">simple_statfs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drop_inode</span> <span class="o">=</span>	<span class="n">generic_delete_inode</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">gadgetfs_fill_super</span> <span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">opts</span><span class="p">,</span> <span class="kt">int</span> <span class="n">silent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span>	<span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dev_data</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">the_device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>

	<span class="cm">/* fake probe to determine $CHIP */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">usb_gadget_probe_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">probe_driver</span><span class="p">,</span> <span class="n">gadgetfs_probe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* superblock */</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">=</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span> <span class="o">=</span> <span class="n">PAGE_CACHE_SHIFT</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_magic</span> <span class="o">=</span> <span class="n">GADGETFS_MAGIC</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gadget_fs_operations</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_time_gran</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* root inode */</span>
	<span class="n">inode</span> <span class="o">=</span> <span class="n">gadgetfs_make_inode</span> <span class="p">(</span><span class="n">sb</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">simple_dir_operations</span><span class="p">,</span>
			<span class="n">S_IFDIR</span> <span class="o">|</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IXUGO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inode</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">simple_dir_inode_operations</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span> <span class="o">=</span> <span class="n">d_make_root</span> <span class="p">(</span><span class="n">inode</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>

	<span class="cm">/* the ep0 file is named after the controller we expect;</span>
<span class="cm">	 * user mode code can use it for sanity checks, like we do.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_new</span> <span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sb</span> <span class="o">=</span> <span class="n">sb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gadgetfs_create_file</span> <span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">CHIP</span><span class="p">,</span>
				<span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_init_operations</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">put_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* other endpoint files are available after hardware setup,</span>
<span class="cm">	 * from binding to a controller.</span>
<span class="cm">	 */</span>
	<span class="n">the_device</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">Enomem:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* &quot;mount -t gadgetfs path /dev/gadget&quot; ends up here */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span>
<span class="nf">gadgetfs_mount</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">opts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mount_single</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">gadgetfs_fill_super</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gadgetfs_kill_sb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kill_litter_super</span> <span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">the_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_dev</span> <span class="p">(</span><span class="n">the_device</span><span class="p">);</span>
		<span class="n">the_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">file_system_type</span> <span class="n">gadgetfs_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">shortname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mount</span>		<span class="o">=</span> <span class="n">gadgetfs_mount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kill_sb</span>	<span class="o">=</span> <span class="n">gadgetfs_kill_sb</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">register_filesystem</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">gadgetfs_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_info</span> <span class="p">(</span><span class="s">&quot;%s: %s, version &quot;</span> <span class="n">DRIVER_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">shortname</span><span class="p">,</span> <span class="n">driver_desc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span> <span class="p">(</span><span class="n">init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span> <span class="p">(</span><span class="s">&quot;unregister %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">shortname</span><span class="p">);</span>
	<span class="n">unregister_filesystem</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">gadgetfs_type</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span> <span class="p">(</span><span class="n">cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
