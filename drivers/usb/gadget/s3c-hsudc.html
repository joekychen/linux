<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › gadget › s3c-hsudc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>s3c-hsudc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* linux/drivers/usb/gadget/s3c-hsudc.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2010 Samsung Electronics Co., Ltd.</span>
<span class="cm"> *		http://www.samsung.com/</span>
<span class="cm"> *</span>
<span class="cm"> * S3C24XX USB 2.0 High-speed USB controller gadget driver</span>
<span class="cm"> *</span>
<span class="cm"> * The S3C24XX USB 2.0 high-speed USB controller supports upto 9 endpoints.</span>
<span class="cm"> * Each endpoint can be configured as either in or out endpoint. Endpoints</span>
<span class="cm"> * can be configured for Bulk or Interrupt transfer mode.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>
<span class="cp">#include &lt;linux/usb/otg.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;linux/platform_data/s3c-hsudc.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>

<span class="cp">#include &lt;mach/regs-s3c2443-clock.h&gt;</span>

<span class="cp">#define S3C_HSUDC_REG(x)	(x)</span>

<span class="cm">/* Non-Indexed Registers */</span>
<span class="cp">#define S3C_IR				S3C_HSUDC_REG(0x00) </span><span class="cm">/* Index Register */</span><span class="cp"></span>
<span class="cp">#define S3C_EIR				S3C_HSUDC_REG(0x04) </span><span class="cm">/* EP Intr Status */</span><span class="cp"></span>
<span class="cp">#define S3C_EIR_EP0			(1&lt;&lt;0)</span>
<span class="cp">#define S3C_EIER			S3C_HSUDC_REG(0x08) </span><span class="cm">/* EP Intr Enable */</span><span class="cp"></span>
<span class="cp">#define S3C_FAR				S3C_HSUDC_REG(0x0c) </span><span class="cm">/* Gadget Address */</span><span class="cp"></span>
<span class="cp">#define S3C_FNR				S3C_HSUDC_REG(0x10) </span><span class="cm">/* Frame Number */</span><span class="cp"></span>
<span class="cp">#define S3C_EDR				S3C_HSUDC_REG(0x14) </span><span class="cm">/* EP Direction */</span><span class="cp"></span>
<span class="cp">#define S3C_TR				S3C_HSUDC_REG(0x18) </span><span class="cm">/* Test Register */</span><span class="cp"></span>
<span class="cp">#define S3C_SSR				S3C_HSUDC_REG(0x1c) </span><span class="cm">/* System Status */</span><span class="cp"></span>
<span class="cp">#define S3C_SSR_DTZIEN_EN		(0xff8f)</span>
<span class="cp">#define S3C_SSR_ERR			(0xff80)</span>
<span class="cp">#define S3C_SSR_VBUSON			(1 &lt;&lt; 8)</span>
<span class="cp">#define S3C_SSR_HSP			(1 &lt;&lt; 4)</span>
<span class="cp">#define S3C_SSR_SDE			(1 &lt;&lt; 3)</span>
<span class="cp">#define S3C_SSR_RESUME			(1 &lt;&lt; 2)</span>
<span class="cp">#define S3C_SSR_SUSPEND			(1 &lt;&lt; 1)</span>
<span class="cp">#define S3C_SSR_RESET			(1 &lt;&lt; 0)</span>
<span class="cp">#define S3C_SCR				S3C_HSUDC_REG(0x20) </span><span class="cm">/* System Control */</span><span class="cp"></span>
<span class="cp">#define S3C_SCR_DTZIEN_EN		(1 &lt;&lt; 14)</span>
<span class="cp">#define S3C_SCR_RRD_EN			(1 &lt;&lt; 5)</span>
<span class="cp">#define S3C_SCR_SUS_EN			(1 &lt;&lt; 1)</span>
<span class="cp">#define S3C_SCR_RST_EN			(1 &lt;&lt; 0)</span>
<span class="cp">#define S3C_EP0SR			S3C_HSUDC_REG(0x24) </span><span class="cm">/* EP0 Status */</span><span class="cp"></span>
<span class="cp">#define S3C_EP0SR_EP0_LWO		(1 &lt;&lt; 6)</span>
<span class="cp">#define S3C_EP0SR_STALL			(1 &lt;&lt; 4)</span>
<span class="cp">#define S3C_EP0SR_TX_SUCCESS		(1 &lt;&lt; 1)</span>
<span class="cp">#define S3C_EP0SR_RX_SUCCESS		(1 &lt;&lt; 0)</span>
<span class="cp">#define S3C_EP0CR			S3C_HSUDC_REG(0x28) </span><span class="cm">/* EP0 Control */</span><span class="cp"></span>
<span class="cp">#define S3C_BR(_x)			S3C_HSUDC_REG(0x60 + (_x * 4))</span>

<span class="cm">/* Indexed Registers */</span>
<span class="cp">#define S3C_ESR				S3C_HSUDC_REG(0x2c) </span><span class="cm">/* EPn Status */</span><span class="cp"></span>
<span class="cp">#define S3C_ESR_FLUSH			(1 &lt;&lt; 6)</span>
<span class="cp">#define S3C_ESR_STALL			(1 &lt;&lt; 5)</span>
<span class="cp">#define S3C_ESR_LWO			(1 &lt;&lt; 4)</span>
<span class="cp">#define S3C_ESR_PSIF_ONE		(1 &lt;&lt; 2)</span>
<span class="cp">#define S3C_ESR_PSIF_TWO		(2 &lt;&lt; 2)</span>
<span class="cp">#define S3C_ESR_TX_SUCCESS		(1 &lt;&lt; 1)</span>
<span class="cp">#define S3C_ESR_RX_SUCCESS		(1 &lt;&lt; 0)</span>
<span class="cp">#define S3C_ECR				S3C_HSUDC_REG(0x30) </span><span class="cm">/* EPn Control */</span><span class="cp"></span>
<span class="cp">#define S3C_ECR_DUEN			(1 &lt;&lt; 7)</span>
<span class="cp">#define S3C_ECR_FLUSH			(1 &lt;&lt; 6)</span>
<span class="cp">#define S3C_ECR_STALL			(1 &lt;&lt; 1)</span>
<span class="cp">#define S3C_ECR_IEMS			(1 &lt;&lt; 0)</span>
<span class="cp">#define S3C_BRCR			S3C_HSUDC_REG(0x34) </span><span class="cm">/* Read Count */</span><span class="cp"></span>
<span class="cp">#define S3C_BWCR			S3C_HSUDC_REG(0x38) </span><span class="cm">/* Write Count */</span><span class="cp"></span>
<span class="cp">#define S3C_MPR				S3C_HSUDC_REG(0x3c) </span><span class="cm">/* Max Pkt Size */</span><span class="cp"></span>

<span class="cp">#define WAIT_FOR_SETUP			(0)</span>
<span class="cp">#define DATA_STATE_XMIT			(1)</span>
<span class="cp">#define DATA_STATE_RECV			(2)</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">s3c_hsudc_supply_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;vdda&quot;</span><span class="p">,</span>		<span class="cm">/* analog phy supply, 3.3V */</span>
	<span class="s">&quot;vddi&quot;</span><span class="p">,</span>		<span class="cm">/* digital phy supply, 1.2V */</span>
	<span class="s">&quot;vddosc&quot;</span><span class="p">,</span>	<span class="cm">/* oscillator supply, 1.8V - 3.3V */</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct s3c_hsudc_ep - Endpoint representation used by driver.</span>
<span class="cm"> * @ep: USB gadget layer representation of device endpoint.</span>
<span class="cm"> * @name: Endpoint name (as required by ep autoconfiguration).</span>
<span class="cm"> * @dev: Reference to the device controller to which this EP belongs.</span>
<span class="cm"> * @desc: Endpoint descriptor obtained from the gadget driver.</span>
<span class="cm"> * @queue: Transfer request queue for the endpoint.</span>
<span class="cm"> * @stopped: Maintains state of endpoint, set if EP is halted.</span>
<span class="cm"> * @bEndpointAddress: EP address (including direction bit).</span>
<span class="cm"> * @fifo: Base address of EP FIFO.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_ep</span> <span class="n">ep</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">queue</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">stopped</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wedge</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bEndpointAddress</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fifo</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct s3c_hsudc_req - Driver encapsulation of USB gadget transfer request.</span>
<span class="cm"> * @req: Reference to USB gadget transfer request.</span>
<span class="cm"> * @queue: Used for inserting this request to the endpoint request queue.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s3c_hsudc_req</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_request</span> <span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">queue</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct s3c_hsudc - Driver&#39;s abstraction of the device controller.</span>
<span class="cm"> * @gadget: Instance of usb_gadget which is referenced by gadget driver.</span>
<span class="cm"> * @driver: Reference to currenty active gadget driver.</span>
<span class="cm"> * @dev: The device reference used by probe function.</span>
<span class="cm"> * @lock: Lock to synchronize the usage of Endpoints (EP&#39;s are indexed).</span>
<span class="cm"> * @regs: Remapped base address of controller&#39;s register space.</span>
<span class="cm"> * @mem_rsrc: Device memory resource used for remapping device register space.</span>
<span class="cm"> * irq: IRQ number used by the controller.</span>
<span class="cm"> * uclk: Reference to the controller clock.</span>
<span class="cm"> * ep0state: Current state of EP0.</span>
<span class="cm"> * ep: List of endpoints supported by the controller.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span> <span class="n">gadget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c24xx_hsudc_platdata</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_phy</span> <span class="o">*</span><span class="n">transceiver</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator_bulk_data</span> <span class="n">supplies</span><span class="p">[</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s3c_hsudc_supply_names</span><span class="p">)];</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">mem_rsrc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">uclk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ep0state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="n">ep</span><span class="p">[];</span>
<span class="p">};</span>

<span class="cp">#define ep_maxpacket(_ep)	((_ep)-&gt;ep.maxpacket)</span>
<span class="cp">#define ep_is_in(_ep)		((_ep)-&gt;bEndpointAddress &amp; USB_DIR_IN)</span>
<span class="cp">#define ep_index(_ep)		((_ep)-&gt;bEndpointAddress &amp; \</span>
<span class="cp">					USB_ENDPOINT_NUMBER_MASK)</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;s3c-udc&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ep0name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;ep0-control&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">s3c_hsudc_req</span> <span class="o">*</span><span class="nf">our_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c_hsudc_req</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="nf">our_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c_hsudc_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="nf">to_hsudc</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c_hsudc</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ep_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ep_addr</span> <span class="o">&amp;=</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ep_addr</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_IR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__orr32</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsudc_init_phy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">S3C2443_PWRCFG</span><span class="p">)</span> <span class="o">|</span> <span class="n">S3C2443_PWRCFG_USBPHY</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">S3C2443_PWRCFG</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">S3C2443_URSTCON</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">S3C2443_URSTCON_FUNCRST</span> <span class="o">|</span> <span class="n">S3C2443_URSTCON_PHYRST</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">S3C2443_URSTCON</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">S3C2443_URSTCON</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">S3C2443_URSTCON_FUNCRST</span> <span class="o">|</span> <span class="n">S3C2443_URSTCON_PHYRST</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">S3C2443_URSTCON</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">S3C2443_PHYCTRL</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">S3C2443_PHYCTRL_CLKSEL</span> <span class="o">|</span> <span class="n">S3C2443_PHYCTRL_DSPORT</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">S3C2443_PHYCTRL_EXTCLK</span> <span class="o">|</span> <span class="n">S3C2443_PHYCTRL_PLLSEL</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">S3C2443_PHYCTRL</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">S3C2443_PHYPWR</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">S3C2443_PHYPWR_FSUSPEND</span> <span class="o">|</span> <span class="n">S3C2443_PHYPWR_PLL_PWRDN</span> <span class="o">|</span>
		<span class="n">S3C2443_PHYPWR_XO_ON</span> <span class="o">|</span> <span class="n">S3C2443_PHYPWR_PLL_REFCLK</span> <span class="o">|</span>
		<span class="n">S3C2443_PHYPWR_ANALOG_PD</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">S3C2443_PHYPWR_COMMON_ON</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">S3C2443_PHYPWR</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">S3C2443_UCLKCON</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">S3C2443_UCLKCON_DETECT_VBUS</span> <span class="o">|</span> <span class="n">S3C2443_UCLKCON_FUNC_CLKEN</span> <span class="o">|</span>
		<span class="n">S3C2443_UCLKCON_TCLKEN</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">S3C2443_UCLKCON</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsudc_uninit_phy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">S3C2443_PWRCFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">S3C2443_PWRCFG_USBPHY</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">S3C2443_PWRCFG</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">S3C2443_PHYPWR_FSUSPEND</span><span class="p">,</span> <span class="n">S3C2443_PHYPWR</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">S3C2443_UCLKCON</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">S3C2443_UCLKCON_FUNC_CLKEN</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">S3C2443_UCLKCON</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_complete_request - Complete a transfer request.</span>
<span class="cm"> * @hsep: Endpoint to which the request belongs.</span>
<span class="cm"> * @hsreq: Transfer request to be completed.</span>
<span class="cm"> * @status: Transfer completion status for the transfer request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsudc_complete_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s3c_hsudc_req</span> <span class="o">*</span><span class="n">hsreq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stopped</span> <span class="o">=</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span> <span class="o">=</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep_index</span><span class="p">(</span><span class="n">hsep</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
		<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_DIR_IN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="n">stopped</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_nuke_ep - Terminate all requests queued for a endpoint.</span>
<span class="cm"> * @hsep: Endpoint for which queued requests have to be terminated.</span>
<span class="cm"> * @status: Transfer completion status for the transfer request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsudc_nuke_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_req</span> <span class="o">*</span><span class="n">hsreq</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hsreq</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s3c_hsudc_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="n">s3c_hsudc_complete_request</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="n">hsreq</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_stop_activity - Stop activity on all endpoints.</span>
<span class="cm"> * @hsudc: Device controller for which EP activity is to be stopped.</span>
<span class="cm"> * @driver: Reference to the gadget driver which is currently active.</span>
<span class="cm"> *</span>
<span class="cm"> * All the endpoints are stopped and any pending transfer requests if any on</span>
<span class="cm"> * the endpoint are terminated.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsudc_stop_activity</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">epnum</span><span class="p">;</span>

	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">epnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">epnum</span> <span class="o">&lt;</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">;</span> <span class="n">epnum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hsep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">epnum</span><span class="p">];</span>
		<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s3c_hsudc_nuke_ep</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_read_setup_pkt - Read the received setup packet from EP0 fifo.</span>
<span class="cm"> * @hsudc: Device controller from which setup packet is to be read.</span>
<span class="cm"> * @buf: The buffer into which the setup packet is read.</span>
<span class="cm"> *</span>
<span class="cm"> * The setup packet received in the EP0 fifo is read and stored into a</span>
<span class="cm"> * given buffer address.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsudc_read_setup_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_BRCR</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span>
		<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_BR</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">S3C_EP0SR_RX_SUCCESS</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_EP0SR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_write_fifo - Write next chunk of transfer data to EP fifo.</span>
<span class="cm"> * @hsep: Endpoint to which the data is to be written.</span>
<span class="cm"> * @hsreq: Transfer request from which the next chunk of data is written.</span>
<span class="cm"> *</span>
<span class="cm"> * Write the next chunk of data from a transfer request to the endpoint FIFO.</span>
<span class="cm"> * If the transfer request completes, 1 is returned, otherwise 0 is returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsudc_write_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s3c_hsudc_req</span> <span class="o">*</span><span class="n">hsreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max</span> <span class="o">=</span> <span class="n">ep_maxpacket</span><span class="p">(</span><span class="n">hsep</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">,</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_last</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
	<span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_BWCR</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">count</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">is_last</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">||</span> <span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span><span class="p">)</span>
			<span class="n">is_last</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">is_last</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_last</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s3c_hsudc_complete_request</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="n">hsreq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_read_fifo - Read the next chunk of data from EP fifo.</span>
<span class="cm"> * @hsep: Endpoint from which the data is to be read.</span>
<span class="cm"> * @hsreq: Transfer request to which the next chunk of data read is written.</span>
<span class="cm"> *</span>
<span class="cm"> * Read the next chunk of data from the endpoint FIFO and a write it to the</span>
<span class="cm"> * transfer request buffer. If the transfer request completes, 1 is returned,</span>
<span class="cm"> * otherwise 0 is returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsudc_read_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s3c_hsudc_req</span> <span class="o">*</span><span class="n">hsreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span> <span class="o">=</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csr</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">word</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">rcnt</span><span class="p">,</span> <span class="n">rlen</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">is_short</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep_index</span><span class="p">(</span><span class="n">hsep</span><span class="p">))</span> <span class="o">?</span> <span class="n">S3C_ESR</span> <span class="o">:</span> <span class="n">S3C_EP0SR</span><span class="p">;</span>
	<span class="n">csr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">S3C_ESR_RX_SUCCESS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">prefetchw</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">buflen</span> <span class="o">=</span> <span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>

	<span class="n">rcnt</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_BRCR</span><span class="p">);</span>
	<span class="n">rlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">S3C_ESR_LWO</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">rcnt</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">rcnt</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">min</span><span class="p">(</span><span class="n">rlen</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="n">is_short</span> <span class="o">=</span> <span class="p">(</span><span class="n">rlen</span> <span class="o">&lt;</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rcnt</span><span class="o">--</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">word</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">fifo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">word</span><span class="p">;</span>
			<span class="n">buflen</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">S3C_ESR_RX_SUCCESS</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_short</span> <span class="o">||</span> <span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">==</span> <span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s3c_hsudc_complete_request</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="n">hsreq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_epin_intr - Handle in-endpoint interrupt.</span>
<span class="cm"> * @hsudc - Device controller for which the interrupt is to be handled.</span>
<span class="cm"> * @ep_idx - Endpoint number on which an interrupt is pending.</span>
<span class="cm"> *</span>
<span class="cm"> * Handles interrupt for a in-endpoint. The interrupts that are handled are</span>
<span class="cm"> * stall and data transmit complete interrupt.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsudc_epin_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ep_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">ep_idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_req</span> <span class="o">*</span><span class="n">hsreq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csr</span><span class="p">;</span>

	<span class="n">csr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_ESR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">S3C_ESR_STALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">S3C_ESR_STALL</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_ESR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">S3C_ESR_TX_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">S3C_ESR_TX_SUCCESS</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_ESR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">hsreq</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s3c_hsudc_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">s3c_hsudc_write_fifo</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="n">hsreq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">S3C_ESR_PSIF_TWO</span><span class="p">))</span>
			<span class="n">s3c_hsudc_write_fifo</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="n">hsreq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_epout_intr - Handle out-endpoint interrupt.</span>
<span class="cm"> * @hsudc - Device controller for which the interrupt is to be handled.</span>
<span class="cm"> * @ep_idx - Endpoint number on which an interrupt is pending.</span>
<span class="cm"> *</span>
<span class="cm"> * Handles interrupt for a out-endpoint. The interrupts that are handled are</span>
<span class="cm"> * stall, flush and data ready interrupt.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsudc_epout_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ep_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">ep_idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_req</span> <span class="o">*</span><span class="n">hsreq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csr</span><span class="p">;</span>

	<span class="n">csr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_ESR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">S3C_ESR_STALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">S3C_ESR_STALL</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_ESR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">S3C_ESR_FLUSH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__orr32</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_ECR</span><span class="p">,</span> <span class="n">S3C_ECR_FLUSH</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">S3C_ESR_RX_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">hsreq</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s3c_hsudc_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">s3c_hsudc_read_fifo</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="n">hsreq</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">S3C_ESR_PSIF_TWO</span><span class="p">))</span>
			<span class="n">s3c_hsudc_read_fifo</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="n">hsreq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/** s3c_hsudc_set_halt - Set or clear a endpoint halt.</span>
<span class="cm"> * @_ep: Endpoint on which halt has to be set or cleared.</span>
<span class="cm"> * @value: 1 for setting halt on endpoint, 0 to clear halt.</span>
<span class="cm"> *</span>
<span class="cm"> * Set or clear endpoint halt. If halt is set, the endpoint is stopped.</span>
<span class="cm"> * If halt is cleared, for in-endpoints, if there are any pending</span>
<span class="cm"> * transfer requests, transfers are started.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsudc_set_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span> <span class="o">=</span> <span class="n">our_ep</span><span class="p">(</span><span class="n">_ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span> <span class="o">=</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_req</span> <span class="o">*</span><span class="n">hsreq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ecr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="n">ep_is_in</span><span class="p">(</span><span class="n">hsep</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
	<span class="n">set_index</span><span class="p">(</span><span class="n">hsudc</span><span class="p">,</span> <span class="n">ep_index</span><span class="p">(</span><span class="n">hsep</span><span class="p">));</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep_index</span><span class="p">(</span><span class="n">hsep</span><span class="p">))</span> <span class="o">?</span> <span class="n">S3C_ECR</span> <span class="o">:</span> <span class="n">S3C_EP0CR</span><span class="p">;</span>
	<span class="n">ecr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecr</span> <span class="o">|=</span> <span class="n">S3C_ECR_STALL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep_index</span><span class="p">(</span><span class="n">hsep</span><span class="p">))</span>
			<span class="n">ecr</span> <span class="o">|=</span> <span class="n">S3C_ECR_FLUSH</span><span class="p">;</span>
		<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ecr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S3C_ECR_STALL</span><span class="p">;</span>
		<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">wedge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ecr</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep_is_in</span><span class="p">(</span><span class="n">hsep</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hsreq</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">s3c_hsudc_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hsreq</span><span class="p">)</span>
			<span class="n">s3c_hsudc_write_fifo</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="n">hsreq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** s3c_hsudc_set_wedge - Sets the halt feature with the clear requests ignored</span>
<span class="cm"> * @_ep: Endpoint on which wedge has to be set.</span>
<span class="cm"> *</span>
<span class="cm"> * Sets the halt feature with the clear requests ignored.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsudc_set_wedge</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span> <span class="o">=</span> <span class="n">our_ep</span><span class="p">(</span><span class="n">_ep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsep</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">wedge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">usb_ep_set_halt</span><span class="p">(</span><span class="n">_ep</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** s3c_hsudc_handle_reqfeat - Handle set feature or clear feature requests.</span>
<span class="cm"> * @_ep: Device controller on which the set/clear feature needs to be handled.</span>
<span class="cm"> * @ctrl: Control request as received on the endpoint 0.</span>
<span class="cm"> *</span>
<span class="cm"> * Handle set feature or clear feature control requests on the control endpoint.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsudc_handle_reqfeat</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">set</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequest</span> <span class="o">==</span> <span class="n">USB_REQ_SET_FEATURE</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ep_num</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wIndex</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">==</span> <span class="n">USB_RECIP_ENDPOINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hsep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">ep_num</span><span class="p">];</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_ENDPOINT_HALT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">set</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">wedge</span><span class="p">))</span>
				<span class="n">s3c_hsudc_set_halt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_process_req_status - Handle get status control request.</span>
<span class="cm"> * @hsudc: Device controller on which get status request has be handled.</span>
<span class="cm"> * @ctrl: Control request as received on the endpoint 0.</span>
<span class="cm"> *</span>
<span class="cm"> * Handle get status control request received on control endpoint.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsudc_process_req_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_req</span> <span class="n">hsreq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">reply</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">epnum</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_RECIP_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_RECIP_DEVICE</span>:
		<span class="n">reply</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_RECIP_INTERFACE</span>:
		<span class="n">reply</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_RECIP_ENDPOINT</span>:
		<span class="n">epnum</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">;</span>
		<span class="n">hsep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">epnum</span><span class="p">];</span>
		<span class="n">reply</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsreq</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">hsreq</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">hsreq</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">;</span>
	<span class="n">hsreq</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hsreq</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">s3c_hsudc_write_fifo</span><span class="p">(</span><span class="n">hsep0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hsreq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_process_setup - Process control request received on endpoint 0.</span>
<span class="cm"> * @hsudc: Device controller on which control request has been received.</span>
<span class="cm"> *</span>
<span class="cm"> * Read the control request received on endpoint 0, decode it and handle</span>
<span class="cm"> * the request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsudc_process_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">s3c_hsudc_nuke_ep</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">);</span>
	<span class="n">s3c_hsudc_read_setup_pkt</span><span class="p">(</span><span class="n">hsudc</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">|=</span> <span class="n">USB_DIR_IN</span><span class="p">;</span>
		<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">DATA_STATE_XMIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_DIR_IN</span><span class="p">;</span>
		<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">DATA_STATE_RECV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">.</span><span class="n">bRequest</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_REQ_SET_ADDRESS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="p">(</span><span class="n">USB_TYPE_STANDARD</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_REQ_GET_STATUS</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">ctrl</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_TYPE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">USB_TYPE_STANDARD</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">s3c_hsudc_process_req_status</span><span class="p">(</span><span class="n">hsudc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_REQ_SET_FEATURE</span>:
	<span class="k">case</span> <span class="n">USB_REQ_CLEAR_FEATURE</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">ctrl</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_TYPE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">USB_TYPE_STANDARD</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">s3c_hsudc_handle_reqfeat</span><span class="p">(</span><span class="n">hsudc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
		<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">==</span> <span class="n">USB_REQ_SET_CONFIGURATION</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_DIR_IN</span><span class="p">;</span>
			<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setup failed, returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ret</span><span class="p">);</span>
			<span class="n">s3c_hsudc_set_halt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
			<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_DIR_IN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/** s3c_hsudc_handle_ep0_intr - Handle endpoint 0 interrupt.</span>
<span class="cm"> * @hsudc: Device controller on which endpoint 0 interrupt has occured.</span>
<span class="cm"> *</span>
<span class="cm"> * Handle endpoint 0 interrupt when it occurs. EP0 interrupt could occur</span>
<span class="cm"> * when a stall handshake is sent to host or data is sent/received on</span>
<span class="cm"> * endpoint 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsudc_handle_ep0_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_req</span> <span class="o">*</span><span class="n">hsreq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_EP0SR</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ecr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">S3C_EP0SR_STALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_EP0CR</span><span class="p">);</span>
		<span class="n">ecr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">S3C_ECR_STALL</span> <span class="o">|</span> <span class="n">S3C_ECR_FLUSH</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ecr</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_EP0CR</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">S3C_EP0SR_STALL</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_EP0SR</span><span class="p">);</span>
		<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">s3c_hsudc_nuke_ep</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNABORTED</span><span class="p">);</span>
		<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
		<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_DIR_IN</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">S3C_EP0SR_TX_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">S3C_EP0SR_TX_SUCCESS</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_EP0SR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep_is_in</span><span class="p">(</span><span class="n">hsep</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="n">hsreq</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">s3c_hsudc_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
			<span class="n">s3c_hsudc_write_fifo</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="n">hsreq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">S3C_EP0SR_RX_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">==</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">)</span>
			<span class="n">s3c_hsudc_process_setup</span><span class="p">(</span><span class="n">hsudc</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep_is_in</span><span class="p">(</span><span class="n">hsep</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="n">hsreq</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">s3c_hsudc_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
				<span class="n">s3c_hsudc_read_fifo</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="n">hsreq</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_ep_enable - Enable a endpoint.</span>
<span class="cm"> * @_ep: The endpoint to be enabled.</span>
<span class="cm"> * @desc: Endpoint descriptor.</span>
<span class="cm"> *</span>
<span class="cm"> * Enables a endpoint when called from the gadget driver. Endpoint stall if</span>
<span class="cm"> * any is cleared, transfer type is configured and endpoint interrupt is</span>
<span class="cm"> * enabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsudc_ep_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ecr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hsep</span> <span class="o">=</span> <span class="n">our_ep</span><span class="p">(</span><span class="n">_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span> <span class="o">||</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span>
		<span class="o">||</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">!=</span> <span class="n">USB_DT_ENDPOINT</span>
		<span class="o">||</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">!=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span>
		<span class="o">||</span> <span class="n">ep_maxpacket</span><span class="p">(</span><span class="n">hsep</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>
		<span class="o">&amp;&amp;</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ep_maxpacket</span><span class="p">(</span><span class="n">hsep</span><span class="p">))</span>
		<span class="o">||</span> <span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

	<span class="n">hsudc</span> <span class="o">=</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">set_index</span><span class="p">(</span><span class="n">hsudc</span><span class="p">,</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>
	<span class="n">ecr</span> <span class="o">|=</span> <span class="p">((</span><span class="n">usb_endpoint_xfer_int</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span> <span class="o">?</span> <span class="n">S3C_ECR_IEMS</span> <span class="o">:</span> <span class="n">S3C_ECR_DUEN</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ecr</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_ECR</span><span class="p">);</span>

	<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">wedge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="n">s3c_hsudc_set_halt</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">ep_index</span><span class="p">(</span><span class="n">hsep</span><span class="p">),</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_EIER</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_ep_disable - Disable a endpoint.</span>
<span class="cm"> * @_ep: The endpoint to be disabled.</span>
<span class="cm"> * @desc: Endpoint descriptor.</span>
<span class="cm"> *</span>
<span class="cm"> * Disables a endpoint when called from the gadget driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsudc_ep_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span> <span class="o">=</span> <span class="n">our_ep</span><span class="p">(</span><span class="n">_ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span> <span class="o">=</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">set_index</span><span class="p">(</span><span class="n">hsudc</span><span class="p">,</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">ep_index</span><span class="p">(</span><span class="n">hsep</span><span class="p">),</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_EIER</span><span class="p">);</span>

	<span class="n">s3c_hsudc_nuke_ep</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>

	<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_alloc_request - Allocate a new request.</span>
<span class="cm"> * @_ep: Endpoint for which request is allocated (not used).</span>
<span class="cm"> * @gfp_flags: Flags used for the allocation.</span>
<span class="cm"> *</span>
<span class="cm"> * Allocates a single transfer request structure when called from gadget driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="nf">s3c_hsudc_alloc_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span>
						<span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_req</span> <span class="o">*</span><span class="n">hsreq</span><span class="p">;</span>

	<span class="n">hsreq</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">hsreq</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsreq</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_free_request - Deallocate a request.</span>
<span class="cm"> * @ep: Endpoint for which request is deallocated (not used).</span>
<span class="cm"> * @_req: Request to be deallocated.</span>
<span class="cm"> *</span>
<span class="cm"> * Allocates a single transfer request structure when called from gadget driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsudc_free_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_req</span> <span class="o">*</span><span class="n">hsreq</span><span class="p">;</span>

	<span class="n">hsreq</span> <span class="o">=</span> <span class="n">our_req</span><span class="p">(</span><span class="n">_req</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hsreq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_queue - Queue a transfer request for the endpoint.</span>
<span class="cm"> * @_ep: Endpoint for which the request is queued.</span>
<span class="cm"> * @_req: Request to be queued.</span>
<span class="cm"> * @gfp_flags: Not used.</span>
<span class="cm"> *</span>
<span class="cm"> * Start or enqueue a request for a endpoint when called from gadget driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsudc_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">,</span>
			<span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_req</span> <span class="o">*</span><span class="n">hsreq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csr</span><span class="p">;</span>

	<span class="n">hsreq</span> <span class="o">=</span> <span class="n">our_req</span><span class="p">(</span><span class="n">_req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">_req</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">||</span>
		<span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">hsep</span> <span class="o">=</span> <span class="n">our_ep</span><span class="p">(</span><span class="n">_ep</span><span class="p">);</span>
	<span class="n">hsudc</span> <span class="o">=</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">set_index</span><span class="p">(</span><span class="n">hsudc</span><span class="p">,</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>

	<span class="n">_req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">_req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep_index</span><span class="p">(</span><span class="n">hsep</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
		<span class="n">s3c_hsudc_complete_request</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="n">hsreq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep_index</span><span class="p">(</span><span class="n">hsep</span><span class="p">))</span> <span class="o">?</span> <span class="n">S3C_ESR</span> <span class="o">:</span> <span class="n">S3C_EP0SR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep_is_in</span><span class="p">(</span><span class="n">hsep</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">csr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">S3C_ESR_TX_SUCCESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">s3c_hsudc_write_fifo</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="n">hsreq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
				<span class="n">hsreq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">csr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">S3C_ESR_RX_SUCCESS</span><span class="p">)</span>
				   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s3c_hsudc_read_fifo</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="n">hsreq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
				<span class="n">hsreq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hsreq</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_dequeue - Dequeue a transfer request from an endpoint.</span>
<span class="cm"> * @_ep: Endpoint from which the request is dequeued.</span>
<span class="cm"> * @_req: Request to be dequeued.</span>
<span class="cm"> *</span>
<span class="cm"> * Dequeue a request from a endpoint when called from gadget driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsudc_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span> <span class="o">=</span> <span class="n">our_ep</span><span class="p">(</span><span class="n">_ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span> <span class="o">=</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_req</span> <span class="o">*</span><span class="n">hsreq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">hsep</span> <span class="o">=</span> <span class="n">our_ep</span><span class="p">(</span><span class="n">_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">hsreq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">==</span> <span class="n">_req</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hsreq</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">!=</span> <span class="n">_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_index</span><span class="p">(</span><span class="n">hsudc</span><span class="p">,</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>
	<span class="n">s3c_hsudc_complete_request</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="n">hsreq</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">s3c_hsudc_ep_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">s3c_hsudc_ep_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span> <span class="o">=</span> <span class="n">s3c_hsudc_ep_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_request</span> <span class="o">=</span> <span class="n">s3c_hsudc_alloc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_request</span> <span class="o">=</span> <span class="n">s3c_hsudc_free_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">s3c_hsudc_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue</span> <span class="o">=</span> <span class="n">s3c_hsudc_dequeue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_halt</span> <span class="o">=</span> <span class="n">s3c_hsudc_set_halt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wedge</span> <span class="o">=</span> <span class="n">s3c_hsudc_set_wedge</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_initep - Initialize a endpoint to default state.</span>
<span class="cm"> * @hsudc - Reference to the device controller.</span>
<span class="cm"> * @hsep - Endpoint to be initialized.</span>
<span class="cm"> * @epnum - Address to be assigned to the endpoint.</span>
<span class="cm"> *</span>
<span class="cm"> * Initialize a endpoint with default configuration.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsudc_initep</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">epnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">epnum</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="s">&quot;out&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="s">&quot;in&quot;</span><span class="p">;</span>
		<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">|=</span> <span class="n">epnum</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epnum</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;ep%d%s&quot;</span><span class="p">,</span> <span class="n">epnum</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">ep0name</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epnum</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hsudc</span><span class="p">;</span>
	<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">hsep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">epnum</span> <span class="o">?</span> <span class="mi">512</span> <span class="o">:</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_hsudc_ep_ops</span><span class="p">;</span>
	<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_BR</span><span class="p">(</span><span class="n">epnum</span><span class="p">);</span>
	<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">wedge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">set_index</span><span class="p">(</span><span class="n">hsudc</span><span class="p">,</span> <span class="n">epnum</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">hsep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_MPR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_setup_ep - Configure all endpoints to default state.</span>
<span class="cm"> * @hsudc: Reference to device controller.</span>
<span class="cm"> *</span>
<span class="cm"> * Configures all endpoints to default state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsudc_setup_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">epnum</span><span class="p">;</span>

	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">epnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">epnum</span> <span class="o">&lt;</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">;</span> <span class="n">epnum</span><span class="o">++</span><span class="p">)</span>
		<span class="n">s3c_hsudc_initep</span><span class="p">(</span><span class="n">hsudc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">epnum</span><span class="p">],</span> <span class="n">epnum</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_reconfig - Reconfigure the device controller to default state.</span>
<span class="cm"> * @hsudc: Reference to device controller.</span>
<span class="cm"> *</span>
<span class="cm"> * Reconfigures the device controller registers to a default state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsudc_reconfig</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xAA</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_EDR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_EIER</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_TR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">S3C_SCR_DTZIEN_EN</span> <span class="o">|</span> <span class="n">S3C_SCR_RRD_EN</span> <span class="o">|</span> <span class="n">S3C_SCR_SUS_EN</span> <span class="o">|</span>
			<span class="n">S3C_SCR_RST_EN</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_SCR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_EP0CR</span><span class="p">);</span>

	<span class="n">s3c_hsudc_setup_ep</span><span class="p">(</span><span class="n">hsudc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsudc_irq - Interrupt handler for device controller.</span>
<span class="cm"> * @irq: Not used.</span>
<span class="cm"> * @_dev: Reference to the device controller.</span>
<span class="cm"> *</span>
<span class="cm"> * Interrupt handler for the device controller. This handler handles controller</span>
<span class="cm"> * interrupts and endpoint interrupts.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">s3c_hsudc_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span> <span class="o">=</span> <span class="n">_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc_ep</span> <span class="o">*</span><span class="n">hsep</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ep_intr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sys_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ep_idx</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">sys_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_SSR</span><span class="p">);</span>
	<span class="n">ep_intr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_EIR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep_intr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">sys_status</span> <span class="o">&amp;</span> <span class="n">S3C_SSR_DTZIEN_EN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sys_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sys_status</span> <span class="o">&amp;</span> <span class="n">S3C_SSR_VBUSON</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">S3C_SSR_VBUSON</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_SSR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sys_status</span> <span class="o">&amp;</span> <span class="n">S3C_SSR_ERR</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">S3C_SSR_ERR</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_SSR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sys_status</span> <span class="o">&amp;</span> <span class="n">S3C_SSR_SDE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">S3C_SSR_SDE</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_SSR</span><span class="p">);</span>
			<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">sys_status</span> <span class="o">&amp;</span> <span class="n">S3C_SSR_HSP</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">USB_SPEED_HIGH</span> <span class="o">:</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sys_status</span> <span class="o">&amp;</span> <span class="n">S3C_SSR_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">S3C_SSR_SUSPEND</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_SSR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_UNKNOWN</span>
				<span class="o">&amp;&amp;</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
				<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sys_status</span> <span class="o">&amp;</span> <span class="n">S3C_SSR_RESUME</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">S3C_SSR_RESUME</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_SSR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_UNKNOWN</span>
				<span class="o">&amp;&amp;</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
				<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sys_status</span> <span class="o">&amp;</span> <span class="n">S3C_SSR_RESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">S3C_SSR_RESET</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_SSR</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">ep_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ep_idx</span> <span class="o">&lt;</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">;</span> <span class="n">ep_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hsep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">ep_idx</span><span class="p">];</span>
				<span class="n">hsep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">s3c_hsudc_nuke_ep</span><span class="p">(</span><span class="n">hsep</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">s3c_hsudc_reconfig</span><span class="p">(</span><span class="n">hsudc</span><span class="p">);</span>
			<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">WAIT_FOR_SETUP</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep_intr</span> <span class="o">&amp;</span> <span class="n">S3C_EIR_EP0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">S3C_EIR_EP0</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_EIR</span><span class="p">);</span>
		<span class="n">set_index</span><span class="p">(</span><span class="n">hsudc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">s3c_hsudc_handle_ep0_intr</span><span class="p">(</span><span class="n">hsudc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ep_intr</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ep_idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ep_intr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep_intr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>  <span class="p">{</span>
			<span class="n">hsep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">ep_idx</span><span class="p">];</span>
			<span class="n">set_index</span><span class="p">(</span><span class="n">hsudc</span><span class="p">,</span> <span class="n">ep_idx</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ep_idx</span><span class="p">,</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_EIR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep_is_in</span><span class="p">(</span><span class="n">hsep</span><span class="p">))</span>
				<span class="n">s3c_hsudc_epin_intr</span><span class="p">(</span><span class="n">hsudc</span><span class="p">,</span> <span class="n">ep_idx</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">s3c_hsudc_epout_intr</span><span class="p">(</span><span class="n">hsudc</span><span class="p">,</span> <span class="n">ep_idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ep_intr</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ep_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsudc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span> <span class="o">=</span> <span class="n">to_hsudc</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span>
		<span class="o">||</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">max_speed</span> <span class="o">&lt;</span> <span class="n">USB_SPEED_FULL</span>
		<span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsudc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_bulk_enable</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span>
				    <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to enable supplies: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_supplies</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* connect to bus through transceiver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">otg_set_peripheral</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="o">-&gt;</span><span class="n">otg</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: can&#39;t bind to transceiver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_otg</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">enable_irq</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bound driver %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="n">s3c_hsudc_reconfig</span><span class="p">(</span><span class="n">hsudc</span><span class="p">);</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">s3c_hsudc_init_phy</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">gpio_init</span><span class="p">)</span>
		<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">gpio_init</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_otg:</span>
	<span class="n">regulator_bulk_disable</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
<span class="nl">err_supplies:</span>
	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsudc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span> <span class="o">=</span> <span class="n">to_hsudc</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsudc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span> <span class="o">||</span> <span class="n">driver</span> <span class="o">!=</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">s3c_hsudc_uninit_phy</span><span class="p">();</span>

	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">gpio_uninit</span><span class="p">)</span>
		<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">gpio_uninit</span><span class="p">();</span>
	<span class="n">s3c_hsudc_stop_activity</span><span class="p">(</span><span class="n">hsudc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">otg_set_peripheral</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="o">-&gt;</span><span class="n">otg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">regulator_bulk_disable</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unregistered gadget driver &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">s3c_hsudc_read_frameno</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">S3C_FNR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsudc_gadget_getframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">s3c_hsudc_read_frameno</span><span class="p">(</span><span class="n">to_hsudc</span><span class="p">(</span><span class="n">gadget</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsudc_vbus_draw</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">mA</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span> <span class="o">=</span> <span class="n">to_hsudc</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsudc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">usb_phy_set_power</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">,</span> <span class="n">mA</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_gadget_ops</span> <span class="n">s3c_hsudc_gadget_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_frame</span>	<span class="o">=</span> <span class="n">s3c_hsudc_gadget_getframe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_start</span>	<span class="o">=</span> <span class="n">s3c_hsudc_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_stop</span>	<span class="o">=</span> <span class="n">s3c_hsudc_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vbus_draw</span>	<span class="o">=</span> <span class="n">s3c_hsudc_vbus_draw</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">s3c_hsudc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsudc</span> <span class="o">*</span><span class="n">hsudc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c24xx_hsudc_platdata</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">hsudc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsudc_ep</span><span class="p">)</span> <span class="o">*</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsudc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">pd</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">usb_get_transceiver</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">supply</span> <span class="o">=</span> <span class="n">s3c_hsudc_supply_names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_bulk_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span>
				 <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request supplies: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_supplies</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to obtain driver resource data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">mem_rsrc</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
				<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">mem_rsrc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to reserve register area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error mapping device register area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_remap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gadget&quot;</span><span class="p">);</span>

	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">max_speed</span> <span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">;</span>
	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_hsudc_gadget_ops</span><span class="p">;</span>
	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">is_otg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">is_a_peripheral</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>

	<span class="n">s3c_hsudc_setup_ep</span><span class="p">(</span><span class="n">hsudc</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to obtain IRQ number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">s3c_hsudc_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">hsudc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">uclk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;usb-device&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">uclk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to find usb-device clock source</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">uclk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_clk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">uclk</span><span class="p">);</span>

	<span class="n">local_irq_disable</span><span class="p">();</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">local_irq_enable</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_add_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_add_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_add_udc</span><span class="p">;</span>

	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_add_udc:</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_add_device:</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">uclk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">uclk</span><span class="p">);</span>
<span class="nl">err_clk:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hsudc</span><span class="p">);</span>
<span class="nl">err_irq:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

<span class="nl">err_remap:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
<span class="nl">err_res:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span>
		<span class="n">usb_put_transceiver</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">);</span>

	<span class="n">regulator_bulk_free</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span> <span class="n">hsudc</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
<span class="nl">err_supplies:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hsudc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">s3c_hsudc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;s3c-hsudc&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">s3c_hsudc_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">s3c_hsudc_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Samsung S3C24XX USB high-speed controller driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Thomas Abraham &lt;thomas.ab@samsung.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:s3c-hsudc&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
