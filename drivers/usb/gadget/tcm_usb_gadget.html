<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › gadget › tcm_usb_gadget.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tcm_usb_gadget.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Target based USB-Gadget</span>
<span class="cm"> *</span>
<span class="cm"> * UAS protocol handling, target callbacks, configfs handling,</span>
<span class="cm"> * BBB (USB Mass Storage Class Bulk-Only (BBB) and Transport protocol handling.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Sebastian Andrzej Siewior &lt;bigeasy at linutronix dot de&gt;</span>
<span class="cm"> * License: GPLv2 as published by FSF.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/configfs.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/composite.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>
<span class="cp">#include &lt;linux/usb/storage.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;target/target_core_base.h&gt;</span>
<span class="cp">#include &lt;target/target_core_fabric.h&gt;</span>
<span class="cp">#include &lt;target/target_core_fabric_configfs.h&gt;</span>
<span class="cp">#include &lt;target/target_core_configfs.h&gt;</span>
<span class="cp">#include &lt;target/configfs_macros.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &quot;usbstring.c&quot;</span>
<span class="cp">#include &quot;epautoconf.c&quot;</span>
<span class="cp">#include &quot;config.c&quot;</span>
<span class="cp">#include &quot;composite.c&quot;</span>

<span class="cp">#include &quot;tcm_usb_gadget.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">target_fabric_configfs</span> <span class="o">*</span><span class="n">usbg_fabric_configfs</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="nf">to_f_uas</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="k">struct</span> <span class="n">f_uas</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">usbg_cmd_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">usbg_cleanup_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">,</span> <span class="n">usbg_cmd_release</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Start bot.c code */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bot_enqueue_cmd_cbw</span><span class="p">(</span><span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USBG_BOT_CMD_PEND</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">USBG_BOT_CMD_PEND</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bot_status_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="p">;</span>

	<span class="n">usbg_cleanup_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ERR %s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* CSW completed, wait for next CBW */</span>
	<span class="n">bot_enqueue_cmd_cbw</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bot_enqueue_sense_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bulk_cs_wrap</span> <span class="o">*</span><span class="n">csw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_status</span><span class="p">.</span><span class="n">csw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">csw_stat</span><span class="p">;</span>

	<span class="n">csw_stat</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">csw_code</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can&#39;t send SENSE as a response. So we take ASC &amp; ASCQ from our</span>
<span class="cm">	 * sense buffer and queue it and hope the host sends a REQUEST_SENSE</span>
<span class="cm">	 * command where it learns why we failed.</span>
<span class="cm">	 */</span>
	<span class="n">sense</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_iu</span><span class="p">.</span><span class="n">sense</span><span class="p">;</span>

	<span class="n">csw</span><span class="o">-&gt;</span><span class="n">Tag</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bot_tag</span><span class="p">;</span>
	<span class="n">csw</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">=</span> <span class="n">csw_stat</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_status</span><span class="p">.</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_status</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s(%d) ERR: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bot_err_compl</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ERR %s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">-=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bot_enqueue_sense_code</span><span class="p">(</span><span class="n">fu</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bot_send_bad_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bulk_cs_wrap</span> <span class="o">*</span><span class="n">csw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_status</span><span class="p">.</span><span class="n">csw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">csw</span><span class="o">-&gt;</span><span class="n">Residue</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">is_read</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">;</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_in</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">;</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">-=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">bot_err_compl</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bot_enqueue_sense_code</span><span class="p">(</span><span class="n">fu</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bot_send_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">bool</span> <span class="n">moved_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bulk_cs_wrap</span> <span class="o">*</span><span class="n">csw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_status</span><span class="p">.</span><span class="n">csw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">.</span><span class="n">scsi_status</span> <span class="o">==</span> <span class="n">SAM_STAT_GOOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">moved_data</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * the host wants to move data, we don&#39;t. Fill / empty</span>
<span class="cm">			 * the pipe and then send the csw with reside set.</span>
<span class="cm">			 */</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">csw_code</span> <span class="o">=</span> <span class="n">US_BULK_STAT_OK</span><span class="p">;</span>
			<span class="n">bot_send_bad_status</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">csw</span><span class="o">-&gt;</span><span class="n">Tag</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bot_tag</span><span class="p">;</span>
		<span class="n">csw</span><span class="o">-&gt;</span><span class="n">Residue</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">csw</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">=</span> <span class="n">US_BULK_STAT_OK</span><span class="p">;</span>
		<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_status</span><span class="p">.</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_status</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s(%d) ERR: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">csw_code</span> <span class="o">=</span> <span class="n">US_BULK_STAT_FAIL</span><span class="p">;</span>
		<span class="n">bot_send_bad_status</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called after command (no data transfer) or after the write (to device)</span>
<span class="cm"> * operation is completed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bot_send_status_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">moved_data</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">is_read</span><span class="p">)</span>
		<span class="n">moved_data</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bot_send_status</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">moved_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read request completed, now we have to send the CSW */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bot_read_compl</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ERR %s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">bot_send_status</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bot_send_read_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">fuas_to_gadget</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">csw_code</span> <span class="o">=</span> <span class="n">US_BULK_STAT_PHASE</span><span class="p">;</span>
		<span class="n">bot_send_bad_status</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">sg_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">sg_copy_to_buffer</span><span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_data_sg</span><span class="p">,</span>
				<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_data_nents</span><span class="p">,</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span><span class="p">,</span>
				<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>

		<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_in</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_in</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_in</span><span class="o">-&gt;</span><span class="n">num_sgs</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_data_nents</span><span class="p">;</span>
		<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_in</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_data_sg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_in</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">bot_read_compl</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_in</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_in</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_in</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">usbg_data_write_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">usbg_prepare_w_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bot_send_write_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">fuas_to_gadget</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">write_complete</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span> <span class="o">=</span> <span class="n">fu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">csw_code</span> <span class="o">=</span> <span class="n">US_BULK_STAT_PHASE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">sg_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_out</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_out</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_out</span><span class="o">-&gt;</span><span class="n">num_sgs</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_data_nents</span><span class="p">;</span>
		<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_out</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_data_sg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_out</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">usbg_data_write_cmpl</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_out</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_out</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbg_prepare_w_request</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_out</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">write_complete</span><span class="p">);</span>
	<span class="n">transport_generic_process_write</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">);</span>
<span class="nl">cleanup:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">bot_submit_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bot_cmd_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USBG_BOT_CMD_PEND</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">bot_submit_command</span><span class="p">(</span><span class="n">fu</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s(%d): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bot_prepare_reqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_in</span> <span class="o">=</span> <span class="n">usb_ep_alloc_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_in</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_out</span> <span class="o">=</span> <span class="n">usb_ep_alloc_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_out</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span> <span class="o">=</span> <span class="n">usb_ep_alloc_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_cmd</span><span class="p">;</span>

	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_status</span><span class="p">.</span><span class="n">req</span> <span class="o">=</span> <span class="n">usb_ep_alloc_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_status</span><span class="p">.</span><span class="n">req</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_sts</span><span class="p">;</span>

	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_status</span><span class="p">.</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_status</span><span class="p">.</span><span class="n">csw</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_status</span><span class="p">.</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">US_BULK_CS_WRAP_LEN</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_status</span><span class="p">.</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">bot_status_complete</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_status</span><span class="p">.</span><span class="n">csw</span><span class="p">.</span><span class="n">Signature</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">US_BULK_CS_SIGN</span><span class="p">);</span>

	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_buf</span><span class="p">;</span>

	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">bot_cmd_complete</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">fu</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">bot_enqueue_cmd_cbw</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_queue</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_queue:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err_buf:</span>
	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_status</span><span class="p">.</span><span class="n">req</span><span class="p">);</span>
<span class="nl">err_sts:</span>
	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">);</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err_cmd:</span>
	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_out</span><span class="p">);</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err_out:</span>
	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_in</span><span class="p">);</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;BOT: endpoint setup failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bot_cleanup_old_alt</span><span class="p">(</span><span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USBG_ENABLED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">usb_ep_disable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">);</span>
	<span class="n">usb_ep_disable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_in</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_in</span><span class="p">);</span>
	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_out</span><span class="p">);</span>
	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">);</span>
	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_status</span><span class="p">.</span><span class="n">req</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_req_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">bot_status</span><span class="p">.</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bot_set_alt</span><span class="p">(</span><span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">USBG_IS_BOT</span><span class="p">;</span>

	<span class="n">config_ep_by_speed</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_enable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_b_in</span><span class="p">;</span>

	<span class="n">config_ep_by_speed</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_enable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_b_out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">bot_prepare_reqs</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_wq</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">USBG_ENABLED</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Using the BOT protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">err_wq:</span>
	<span class="n">usb_ep_disable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">);</span>
<span class="nl">err_b_out:</span>
	<span class="n">usb_ep_disable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">);</span>
<span class="nl">err_b_in:</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">USBG_IS_BOT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_bot_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">to_f_uas</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">w_value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">w_length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">luns</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ret_lun</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequest</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">US_BULK_GET_MAX_LUN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="p">(</span><span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span>
					<span class="n">USB_RECIP_INTERFACE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">w_length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w_value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">luns</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_port_count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">luns</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No LUNs configured?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * If 4 LUNs are present we return 3 i.e. LUN 0..3 can be</span>
<span class="cm">		 * accessed. The upper limit is 0xf</span>
<span class="cm">		 */</span>
		<span class="n">luns</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">luns</span> <span class="o">&gt;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info_once</span><span class="p">(</span><span class="s">&quot;Limiting the number of luns to 16</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">luns</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret_lun</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ret_lun</span> <span class="o">=</span> <span class="n">luns</span><span class="p">;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">US_BULK_RESET_REQUEST</span>:
		<span class="cm">/* XXX maybe we should remove previous requests for IN + OUT */</span>
		<span class="n">bot_enqueue_cmd_cbw</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Start uas.c code */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uasp_cleanup_one_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uas_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We have either all three allocated or none */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="p">);</span>
	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="p">);</span>
	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_status</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="p">);</span>

	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uasp_free_cmdreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_cmd</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uasp_cleanup_old_alt</span><span class="p">(</span><span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USBG_ENABLED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">usb_ep_disable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">);</span>
	<span class="n">usb_ep_disable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">);</span>
	<span class="n">usb_ep_disable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_status</span><span class="p">);</span>
	<span class="n">usb_ep_disable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_cmd</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UASP_SS_EP_COMP_NUM_STREAMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">uasp_cleanup_one_stream</span><span class="p">(</span><span class="n">fu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">uasp_free_cmdreq</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">uasp_status_data_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uasp_prepare_r_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">fuas_to_gadget</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">uas_stream</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">sg_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">sg_copy_to_buffer</span><span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_data_sg</span><span class="p">,</span>
				<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_data_nents</span><span class="p">,</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span><span class="p">,</span>
				<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>

		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">-&gt;</span><span class="n">num_sgs</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_data_nents</span><span class="p">;</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_data_sg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">uasp_status_data_cmpl</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">UASP_SEND_STATUS</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uasp_prepare_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sense_iu</span> <span class="o">*</span><span class="n">iu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_iu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uas_stream</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">UASP_QUEUE_COMMAND</span><span class="p">;</span>
	<span class="n">iu</span><span class="o">-&gt;</span><span class="n">iu_id</span> <span class="o">=</span> <span class="n">IU_ID_STATUS</span><span class="p">;</span>
	<span class="n">iu</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * iu-&gt;status_qual = cpu_to_be16(STATUS QUALIFIER SAM-4. Where R U?);</span>
<span class="cm">	 */</span>
	<span class="n">iu</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_length</span><span class="p">);</span>
	<span class="n">iu</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">scsi_status</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_length</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">iu</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">uasp_status_data_cmpl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uasp_status_data_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uas_stream</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UASP_SEND_DATA</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uasp_prepare_r_request</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s(%d) =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UASP_RECEIVE_DATA</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usbg_prepare_w_request</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s(%d) =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UASP_SEND_STATUS</span>:
		<span class="n">uasp_prepare_status</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_status</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="p">,</span>
				<span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s(%d) =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UASP_QUEUE_COMMAND</span>:
		<span class="n">usbg_cleanup_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_cmd</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">};</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="n">usbg_cleanup_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uasp_send_status_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uas_stream</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sense_iu</span> <span class="o">*</span><span class="n">iu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_iu</span><span class="p">;</span>

	<span class="n">iu</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">uasp_status_data_cmpl</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span> <span class="o">=</span> <span class="n">fu</span><span class="p">;</span>
	<span class="n">uasp_prepare_status</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_status</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uasp_send_read_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uas_stream</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sense_iu</span> <span class="o">*</span><span class="n">iu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_iu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span> <span class="o">=</span> <span class="n">fu</span><span class="p">;</span>

	<span class="n">iu</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USBG_USE_STREAMS</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">uasp_prepare_r_request</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s(%d) =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">iu</span><span class="o">-&gt;</span><span class="n">iu_id</span> <span class="o">=</span> <span class="n">IU_ID_READ_READY</span><span class="p">;</span>
		<span class="n">iu</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">uasp_status_data_cmpl</span><span class="p">;</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">UASP_SEND_DATA</span><span class="p">;</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">iu</span><span class="p">;</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iu</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_status</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="p">,</span>
				<span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s(%d) =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uasp_send_write_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uas_stream</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sense_iu</span> <span class="o">*</span><span class="n">iu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_iu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">write_complete</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span> <span class="o">=</span> <span class="n">fu</span><span class="p">;</span>

	<span class="n">iu</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USBG_USE_STREAMS</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">usbg_prepare_w_request</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">iu</span><span class="o">-&gt;</span><span class="n">iu_id</span> <span class="o">=</span> <span class="n">IU_ID_WRITE_READY</span><span class="p">;</span>
		<span class="n">iu</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">uasp_status_data_cmpl</span><span class="p">;</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">UASP_RECEIVE_DATA</span><span class="p">;</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">iu</span><span class="p">;</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iu</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_status</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="p">,</span>
				<span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">write_complete</span><span class="p">);</span>
	<span class="n">transport_generic_process_write</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">);</span>
<span class="nl">cleanup:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">usbg_submit_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uasp_cmd_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbg_submit_command</span><span class="p">(</span><span class="n">fu</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Once we tune for performance enqueue the command req here again so</span>
<span class="cm">	 * we can receive a second command while we processing this one. Pay</span>
<span class="cm">	 * attention to properly sync STAUS endpoint with DATA IN + OUT so you</span>
<span class="cm">	 * don&#39;t break HS.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_cmd</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uasp_alloc_stream_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uas_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">=</span> <span class="n">usb_ep_alloc_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_out</span> <span class="o">=</span> <span class="n">usb_ep_alloc_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span> <span class="o">=</span> <span class="n">usb_ep_alloc_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_status</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_sts</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_sts:</span>
	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_status</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="p">);</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_status</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err_out:</span>
	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="p">);</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">req_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uasp_alloc_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span> <span class="o">=</span> <span class="n">usb_ep_alloc_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_cmd</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_cmd</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_buf</span><span class="p">;</span>

	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">uasp_cmd_complete</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_cmd</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">fu</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_buf:</span>
	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_cmd</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uasp_setup_stream_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_streams</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_streams</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">uas_stream</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">-&gt;</span><span class="n">stream_id</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="o">-&gt;</span><span class="n">stream_id</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">req_status</span><span class="o">-&gt;</span><span class="n">stream_id</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uasp_prepare_reqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_streams</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USBG_USE_STREAMS</span><span class="p">)</span>
		<span class="n">max_streams</span> <span class="o">=</span> <span class="n">UASP_SS_EP_COMP_NUM_STREAMS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max_streams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_streams</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uasp_alloc_stream_res</span><span class="p">(</span><span class="n">fu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uasp_alloc_cmd</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_stream</span><span class="p">;</span>
	<span class="n">uasp_setup_stream_res</span><span class="p">(</span><span class="n">fu</span><span class="p">,</span> <span class="n">max_streams</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_cmd</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_stream</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_stream:</span>
	<span class="n">uasp_free_cmdreq</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>

<span class="nl">err_cleanup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">uasp_cleanup_one_stream</span><span class="p">(</span><span class="n">fu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
			<span class="n">i</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;UASP: endpoint setup failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uasp_set_alt</span><span class="p">(</span><span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">USBG_IS_UAS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_SUPER</span><span class="p">)</span>
		<span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">USBG_USE_STREAMS</span><span class="p">;</span>

	<span class="n">config_ep_by_speed</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_enable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_b_in</span><span class="p">;</span>

	<span class="n">config_ep_by_speed</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_enable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_b_out</span><span class="p">;</span>

	<span class="n">config_ep_by_speed</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_cmd</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_enable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_cmd</span><span class="p">;</span>
	<span class="n">config_ep_by_speed</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_status</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_ep_enable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_status</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uasp_prepare_reqs</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_wq</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">USBG_ENABLED</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Using the UAS protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">err_wq:</span>
	<span class="n">usb_ep_disable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_status</span><span class="p">);</span>
<span class="nl">err_status:</span>
	<span class="n">usb_ep_disable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_cmd</span><span class="p">);</span>
<span class="nl">err_cmd:</span>
	<span class="n">usb_ep_disable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">);</span>
<span class="nl">err_b_out:</span>
	<span class="n">usb_ep_disable</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">);</span>
<span class="nl">err_b_in:</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_cmd_dir</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cdb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">READ_6</span>:
	<span class="k">case</span> <span class="n">READ_10</span>:
	<span class="k">case</span> <span class="n">READ_12</span>:
	<span class="k">case</span> <span class="n">READ_16</span>:
	<span class="k">case</span> <span class="n">INQUIRY</span>:
	<span class="k">case</span> <span class="n">MODE_SENSE</span>:
	<span class="k">case</span> <span class="n">MODE_SENSE_10</span>:
	<span class="k">case</span> <span class="n">SERVICE_ACTION_IN</span>:
	<span class="k">case</span> <span class="n">MAINTENANCE_IN</span>:
	<span class="k">case</span> <span class="n">PERSISTENT_RESERVE_IN</span>:
	<span class="k">case</span> <span class="n">SECURITY_PROTOCOL_IN</span>:
	<span class="k">case</span> <span class="n">ACCESS_CONTROL_IN</span>:
	<span class="k">case</span> <span class="n">REPORT_LUNS</span>:
	<span class="k">case</span> <span class="n">READ_BLOCK_LIMITS</span>:
	<span class="k">case</span> <span class="n">READ_POSITION</span>:
	<span class="k">case</span> <span class="n">READ_CAPACITY</span>:
	<span class="k">case</span> <span class="n">READ_TOC</span>:
	<span class="k">case</span> <span class="n">READ_FORMAT_CAPACITIES</span>:
	<span class="k">case</span> <span class="n">REQUEST_SENSE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WRITE_6</span>:
	<span class="k">case</span> <span class="n">WRITE_10</span>:
	<span class="k">case</span> <span class="n">WRITE_12</span>:
	<span class="k">case</span> <span class="n">WRITE_16</span>:
	<span class="k">case</span> <span class="n">MODE_SELECT</span>:
	<span class="k">case</span> <span class="n">MODE_SELECT_10</span>:
	<span class="k">case</span> <span class="n">WRITE_VERIFY</span>:
	<span class="k">case</span> <span class="n">WRITE_VERIFY_12</span>:
	<span class="k">case</span> <span class="n">PERSISTENT_RESERVE_OUT</span>:
	<span class="k">case</span> <span class="n">MAINTENANCE_OUT</span>:
	<span class="k">case</span> <span class="n">SECURITY_PROTOCOL_OUT</span>:
	<span class="k">case</span> <span class="n">ACCESS_CONTROL_OUT</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALLOW_MEDIUM_REMOVAL</span>:
	<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
	<span class="k">case</span> <span class="n">SYNCHRONIZE_CACHE</span>:
	<span class="k">case</span> <span class="n">START_STOP</span>:
	<span class="k">case</span> <span class="n">ERASE</span>:
	<span class="k">case</span> <span class="n">REZERO_UNIT</span>:
	<span class="k">case</span> <span class="n">SEEK_10</span>:
	<span class="k">case</span> <span class="n">SPACE</span>:
	<span class="k">case</span> <span class="n">VERIFY</span>:
	<span class="k">case</span> <span class="n">WRITE_FILEMARKS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">DMA_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;target: Unknown data direction for SCSI Opcode &quot;</span>
				<span class="s">&quot;0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbg_data_write_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s() state %d transfer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">num_sgs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_copy_from_buffer</span><span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_data_sg</span><span class="p">,</span>
				<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_data_nents</span><span class="p">,</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span><span class="p">,</span>
				<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">write_complete</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="n">usbg_cleanup_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_prepare_w_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">fuas_to_gadget</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">sg_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_sgs</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_data_nents</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">t_data_sg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">usbg_data_write_cmpl</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_send_status_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_cmd</span><span class="p">,</span>
			<span class="n">se_cmd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USBG_IS_BOT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bot_send_status_response</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">uasp_send_status_response</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_send_write_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_cmd</span><span class="p">,</span>
			<span class="n">se_cmd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USBG_IS_BOT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bot_send_write_request</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">uasp_send_write_request</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_send_read_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_cmd</span><span class="p">,</span>
			<span class="n">se_cmd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USBG_IS_BOT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bot_send_read_response</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">uasp_send_read_response</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbg_cmd_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_cmd</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcm_usbg_nexus</span> <span class="o">*</span><span class="n">tv_nexus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir</span><span class="p">;</span>

	<span class="n">se_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">;</span>
	<span class="n">tpg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">tpg</span><span class="p">;</span>
	<span class="n">tv_nexus</span> <span class="o">=</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_nexus</span><span class="p">;</span>
	<span class="n">dir</span> <span class="o">=</span> <span class="n">get_cmd_dir</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">transport_init_se_cmd</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">,</span>
				<span class="n">tv_nexus</span><span class="o">-&gt;</span><span class="n">tvn_se_sess</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="p">,</span>
				<span class="n">tv_nexus</span><span class="o">-&gt;</span><span class="n">tvn_se_sess</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">prio_attr</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_iu</span><span class="p">.</span><span class="n">sense</span><span class="p">);</span>

		<span class="n">transport_send_check_condition_and_sense</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">,</span>
				<span class="n">TCM_UNSUPPORTED_SCSI_OPCODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">usbg_cleanup_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">target_submit_cmd</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">,</span> <span class="n">tv_nexus</span><span class="o">-&gt;</span><span class="n">tvn_se_sess</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_iu</span><span class="p">.</span><span class="n">sense</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">unpacked_lun</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">prio_attr</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">TARGET_SCF_UNKNOWN_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_submit_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">cmdbuf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">command_iu</span> <span class="o">*</span><span class="n">cmd_iu</span> <span class="o">=</span> <span class="n">cmdbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcm_usbg_nexus</span> <span class="o">*</span><span class="n">tv_nexus</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_iu</span><span class="o">-&gt;</span><span class="n">iu_id</span> <span class="o">!=</span> <span class="n">IU_ID_COMMAND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unsupported type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd_iu</span><span class="o">-&gt;</span><span class="n">iu_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span> <span class="o">=</span> <span class="n">fu</span><span class="p">;</span>

	<span class="cm">/* XXX until I figure out why I can&#39;t free in on complete */</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>

	<span class="n">tpg</span> <span class="o">=</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">tpg</span><span class="p">;</span>
	<span class="n">cmd_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd_iu</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_len</span> <span class="o">&gt;</span> <span class="n">USBG_MAX_CMD</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">,</span> <span class="n">cmd_iu</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">cmd_len</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">be16_to_cpup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_iu</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USBG_USE_STREAMS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">&gt;</span> <span class="n">UASP_SS_EP_COMP_NUM_STREAMS</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">tv_nexus</span> <span class="o">=</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_nexus</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tv_nexus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing nexus, ignoring command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd_iu</span><span class="o">-&gt;</span><span class="n">prio_attr</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UAS_HEAD_TAG</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">prio_attr</span> <span class="o">=</span> <span class="n">MSG_HEAD_TAG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UAS_ORDERED_TAG</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">prio_attr</span> <span class="o">=</span> <span class="n">MSG_ORDERED_TAG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UAS_ACA</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">prio_attr</span> <span class="o">=</span> <span class="n">MSG_ACA_TAG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_debug_once</span><span class="p">(</span><span class="s">&quot;Unsupported prio_attr: %02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cmd_iu</span><span class="o">-&gt;</span><span class="n">prio_attr</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">UAS_SIMPLE_TAG</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">prio_attr</span> <span class="o">=</span> <span class="n">MSG_SIMPLE_TAG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">se_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">unpacked_lun</span> <span class="o">=</span> <span class="n">scsilun_to_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_iu</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">usbg_cmd_work</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">queue_work</span><span class="p">(</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bot_cmd_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_cmd</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcm_usbg_nexus</span> <span class="o">*</span><span class="n">tv_nexus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir</span><span class="p">;</span>

	<span class="n">se_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">;</span>
	<span class="n">tpg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">tpg</span><span class="p">;</span>
	<span class="n">tv_nexus</span> <span class="o">=</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_nexus</span><span class="p">;</span>
	<span class="n">dir</span> <span class="o">=</span> <span class="n">get_cmd_dir</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">transport_init_se_cmd</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">,</span>
				<span class="n">tv_nexus</span><span class="o">-&gt;</span><span class="n">tvn_se_sess</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="p">,</span>
				<span class="n">tv_nexus</span><span class="o">-&gt;</span><span class="n">tvn_se_sess</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">prio_attr</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_iu</span><span class="p">.</span><span class="n">sense</span><span class="p">);</span>

		<span class="n">transport_send_check_condition_and_sense</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">,</span>
				<span class="n">TCM_UNSUPPORTED_SCSI_OPCODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">usbg_cleanup_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">target_submit_cmd</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">,</span> <span class="n">tv_nexus</span><span class="o">-&gt;</span><span class="n">tvn_se_sess</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_iu</span><span class="p">.</span><span class="n">sense</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">unpacked_lun</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">prio_attr</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bot_submit_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">cmdbuf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bulk_cb_wrap</span> <span class="o">*</span><span class="n">cbw</span> <span class="o">=</span> <span class="n">cmdbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcm_usbg_nexus</span> <span class="o">*</span><span class="n">tv_nexus</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cbw</span><span class="o">-&gt;</span><span class="n">Signature</span> <span class="o">!=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">US_BULK_CB_SIGN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Wrong signature on CBW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">31</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Wrong length for CBW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd_len</span> <span class="o">=</span> <span class="n">cbw</span><span class="o">-&gt;</span><span class="n">Length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_len</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">cmd_len</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span> <span class="o">=</span> <span class="n">fu</span><span class="p">;</span>

	<span class="cm">/* XXX until I figure out why I can&#39;t free in on complete */</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>

	<span class="n">tpg</span> <span class="o">=</span> <span class="n">fu</span><span class="o">-&gt;</span><span class="n">tpg</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">,</span> <span class="n">cbw</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">,</span> <span class="n">cmd_len</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bot_tag</span> <span class="o">=</span> <span class="n">cbw</span><span class="o">-&gt;</span><span class="n">Tag</span><span class="p">;</span>

	<span class="n">tv_nexus</span> <span class="o">=</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_nexus</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tv_nexus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing nexus, ignoring command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">prio_attr</span> <span class="o">=</span> <span class="n">MSG_SIMPLE_TAG</span><span class="p">;</span>
	<span class="n">se_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">unpacked_lun</span> <span class="o">=</span> <span class="n">cbw</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">is_read</span> <span class="o">=</span> <span class="n">cbw</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">US_BULK_FLAG_IN</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cbw</span><span class="o">-&gt;</span><span class="n">DataTransferLength</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">bot_cmd_work</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">queue_work</span><span class="p">(</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Start fabric.c code */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_check_true</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_check_false</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">usbg_get_fabric_name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="s">&quot;usb_gadget&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">usbg_get_fabric_proto_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">usbg_tpg</span><span class="p">,</span> <span class="n">se_tpg</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbg_tport</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">proto_id</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tport_proto_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCSI_PROTOCOL_SAS</span>:
	<span class="nl">default:</span>
		<span class="n">proto_id</span> <span class="o">=</span> <span class="n">sas_get_fabric_proto_ident</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">proto_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">usbg_get_fabric_wwn</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">usbg_tpg</span><span class="p">,</span> <span class="n">se_tpg</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbg_tport</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tport_name</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">usbg_get_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">usbg_tpg</span><span class="p">,</span> <span class="n">se_tpg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tport_tpgt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">usbg_get_default_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">usbg_get_pr_transport_id</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">se_nacl</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">format_code</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">usbg_tpg</span><span class="p">,</span> <span class="n">se_tpg</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbg_tport</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tport_proto_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCSI_PROTOCOL_SAS</span>:
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sas_get_pr_transport_id</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span> <span class="n">se_nacl</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">,</span>
					<span class="n">format_code</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">usbg_get_pr_transport_id_len</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">se_nacl</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">t10_pr_registration</span> <span class="o">*</span><span class="n">pr_reg</span><span class="p">,</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">format_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">usbg_tpg</span><span class="p">,</span> <span class="n">se_tpg</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbg_tport</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tport_proto_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCSI_PROTOCOL_SAS</span>:
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sas_get_pr_transport_id_len</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span> <span class="n">se_nacl</span><span class="p">,</span> <span class="n">pr_reg</span><span class="p">,</span>
					<span class="n">format_code</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">usbg_parse_pr_out_transport_id</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">out_tid_len</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">port_nexus_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">usbg_tpg</span><span class="p">,</span> <span class="n">se_tpg</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbg_tport</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tport_proto_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCSI_PROTOCOL_SAS</span>:
	<span class="nl">default:</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="n">sas_parse_pr_out_transport_id</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">out_tid_len</span><span class="p">,</span>
					<span class="n">port_nexus_ptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">tid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="nf">usbg_alloc_fabric_acl</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_nacl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">;</span>

	<span class="n">nacl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_nacl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nacl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unable to alocate struct usbg_nacl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbg_release_fabric_acl</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">se_nacl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_nacl</span> <span class="o">*</span><span class="n">nacl</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_nacl</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">usbg_nacl</span><span class="p">,</span> <span class="n">se_node_acl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">nacl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">usbg_tpg_get_inst_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_new_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_cmd</span><span class="p">,</span>
			<span class="n">se_cmd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">target_setup_cmd_from_cdb</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">transport_generic_map_mem_to_cmd</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbg_cmd_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_cmd</span><span class="p">,</span>
			<span class="n">ref</span><span class="p">);</span>

	<span class="n">transport_generic_free_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">se_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbg_release_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_cmd</span><span class="p">,</span>
			<span class="n">se_cmd</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_shutdown_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">se_sess</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbg_close_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">se_sess</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">usbg_sess_get_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">se_sess</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * XXX Error recovery: return != 0 if we expect writes. Dunno when that could be</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_write_pending_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbg_set_default_node_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">usbg_get_task_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_cmd</span><span class="p">,</span>
			<span class="n">se_cmd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USBG_IS_BOT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bot_tag</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_get_cmd_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_queue_tm_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">usbg_set_fabric_sense_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sense_length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">usbg_get_fabric_sense_len</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">usbg_check_wwn</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;naa.&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">USBG_NAMELEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="nf">usbg_make_nodeacl</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">se_nacl</span><span class="p">,</span> <span class="o">*</span><span class="n">se_nacl_new</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbg_nacl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">wwpn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nexus_depth</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">wnn_name</span><span class="p">;</span>

	<span class="n">wnn_name</span> <span class="o">=</span> <span class="n">usbg_check_wwn</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wnn_name</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="n">se_nacl_new</span> <span class="o">=</span> <span class="n">usbg_alloc_fabric_acl</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">se_nacl_new</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">nexus_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * se_nacl_new may be released by core_tpg_add_initiator_node_acl()</span>
<span class="cm">	 * when converting a NodeACL from demo mode -&gt; explict</span>
<span class="cm">	 */</span>
	<span class="n">se_nacl</span> <span class="o">=</span> <span class="n">core_tpg_add_initiator_node_acl</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span> <span class="n">se_nacl_new</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="n">nexus_depth</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">se_nacl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usbg_release_fabric_acl</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span> <span class="n">se_nacl_new</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">se_nacl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Locate our struct usbg_nacl and set the FC Nport WWPN</span>
<span class="cm">	 */</span>
	<span class="n">nacl</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_nacl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_nacl</span><span class="p">,</span> <span class="n">se_node_acl</span><span class="p">);</span>
	<span class="n">nacl</span><span class="o">-&gt;</span><span class="n">iport_wwpn</span> <span class="o">=</span> <span class="n">wwpn</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">iport_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">iport_name</span><span class="p">),</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">se_nacl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbg_drop_nodeacl</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">se_acl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_nacl</span> <span class="o">*</span><span class="n">nacl</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_acl</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">usbg_nacl</span><span class="p">,</span> <span class="n">se_node_acl</span><span class="p">);</span>
	<span class="n">core_tpg_del_initiator_node_acl</span><span class="p">(</span><span class="n">se_acl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">,</span> <span class="n">se_acl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">nacl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">the_only_tpg_I_currently_have</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="nf">usbg_make_tpg</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_wwn</span> <span class="o">*</span><span class="n">wwn</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_tport</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wwn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_tport</span><span class="p">,</span>
			<span class="n">tport_wwn</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tpgt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;tpgt_&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoul</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpgt</span><span class="p">)</span> <span class="o">||</span> <span class="n">tpgt</span> <span class="o">&gt;</span> <span class="n">UINT_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">the_only_tpg_I_currently_have</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Until the gadget framework can&#39;t handle multiple</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;gadgets, you can&#39;t do this here.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tpg</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_tpg</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unable to allocate struct usbg_tpg&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_mutex</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_port_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;tcm_usb_gadget&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tpg</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tport</span> <span class="o">=</span> <span class="n">tport</span><span class="p">;</span>
	<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tport_tpgt</span> <span class="o">=</span> <span class="n">tpgt</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">core_tpg_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbg_fabric_configfs</span><span class="o">-&gt;</span><span class="n">tf_ops</span><span class="p">,</span> <span class="n">wwn</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">,</span> <span class="n">tpg</span><span class="p">,</span>
				<span class="n">TRANSPORT_TPG_TYPE_NORMAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tpg</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">the_only_tpg_I_currently_have</span> <span class="o">=</span> <span class="n">tpg</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbg_drop_tpg</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">usbg_tpg</span><span class="p">,</span> <span class="n">se_tpg</span><span class="p">);</span>

	<span class="n">core_tpg_deregister</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tpg</span><span class="p">);</span>
	<span class="n">the_only_tpg_I_currently_have</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">se_wwn</span> <span class="o">*</span><span class="nf">usbg_make_tport</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">target_fabric_configfs</span> <span class="o">*</span><span class="n">tf</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">config_group</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_tport</span> <span class="o">*</span><span class="n">tport</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">wnn_name</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">wwpn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wnn_name</span> <span class="o">=</span> <span class="n">usbg_check_wwn</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wnn_name</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">tport</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_tport</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tport</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unable to allocate struct usbg_tport&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tport</span><span class="o">-&gt;</span><span class="n">tport_wwpn</span> <span class="o">=</span> <span class="n">wwpn</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tport_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tport_name</span><span class="p">),</span> <span class="n">wnn_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">tport</span><span class="o">-&gt;</span><span class="n">tport_wwn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbg_drop_tport</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_wwn</span> <span class="o">*</span><span class="n">wwn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_tport</span> <span class="o">*</span><span class="n">tport</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wwn</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">usbg_tport</span><span class="p">,</span> <span class="n">tport_wwn</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tport</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If somebody feels like dropping the version property, go ahead.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">usbg_wwn_show_attr_version</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">target_fabric_configfs</span> <span class="o">*</span><span class="n">tf</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;usb-gadget fabric module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">TF_WWN_ATTR_RO</span><span class="p">(</span><span class="n">usbg</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_attribute</span> <span class="o">*</span><span class="n">usbg_wwn_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">usbg_wwn_version</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tcm_usbg_tpg_show_enable</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span>  <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_tpg</span><span class="p">,</span> <span class="n">se_tpg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">gadget_connect</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">usbg_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">usbg_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tcm_usbg_tpg_store_enable</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span>  <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_tpg</span><span class="p">,</span> <span class="n">se_tpg</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">op</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&amp;&amp;</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">gadget_connect</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">gadget_connect</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usbg_attach</span><span class="p">(</span><span class="n">tpg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">usbg_detach</span><span class="p">(</span><span class="n">tpg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">gadget_connect</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">TF_TPG_BASE_ATTR</span><span class="p">(</span><span class="n">tcm_usbg</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tcm_usbg_tpg_show_nexus</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_tpg</span><span class="p">,</span> <span class="n">se_tpg</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tcm_usbg_nexus</span> <span class="o">*</span><span class="n">tv_nexus</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_mutex</span><span class="p">);</span>
	<span class="n">tv_nexus</span> <span class="o">=</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_nexus</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tv_nexus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tv_nexus</span><span class="o">-&gt;</span><span class="n">tvn_se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcm_usbg_make_nexus</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcm_usbg_nexus</span> <span class="o">*</span><span class="n">tv_nexus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_nexus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;tpg-&gt;tpg_nexus already exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">se_tpg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">tv_nexus</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tv_nexus</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tv_nexus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate struct tcm_vhost_nexus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tv_nexus</span><span class="o">-&gt;</span><span class="n">tvn_se_sess</span> <span class="o">=</span> <span class="n">transport_init_session</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tv_nexus</span><span class="o">-&gt;</span><span class="n">tvn_se_sess</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since we are running in &#39;demo mode&#39; this call with generate a</span>
<span class="cm">	 * struct se_node_acl for the tcm_vhost struct se_portal_group with</span>
<span class="cm">	 * the SCSI Initiator port name of the passed configfs group &#39;name&#39;.</span>
<span class="cm">	 */</span>
	<span class="n">tv_nexus</span><span class="o">-&gt;</span><span class="n">tvn_se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span> <span class="o">=</span> <span class="n">core_tpg_check_initiator_node_acl</span><span class="p">(</span>
			<span class="n">se_tpg</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tv_nexus</span><span class="o">-&gt;</span><span class="n">tvn_se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;core_tpg_check_initiator_node_acl() failed&quot;</span>
				<span class="s">&quot; for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_session</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Now register the TCM vHost virtual I_T Nexus as active with the</span>
<span class="cm">	 * call to __transport_register_session()</span>
<span class="cm">	 */</span>
	<span class="n">__transport_register_session</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span> <span class="n">tv_nexus</span><span class="o">-&gt;</span><span class="n">tvn_se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="p">,</span>
			<span class="n">tv_nexus</span><span class="o">-&gt;</span><span class="n">tvn_se_sess</span><span class="p">,</span> <span class="n">tv_nexus</span><span class="p">);</span>
	<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_nexus</span> <span class="o">=</span> <span class="n">tv_nexus</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_session:</span>
	<span class="n">transport_free_session</span><span class="p">(</span><span class="n">tv_nexus</span><span class="o">-&gt;</span><span class="n">tvn_se_sess</span><span class="p">);</span>
<span class="nl">err_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tv_nexus</span><span class="p">);</span>
<span class="nl">err_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tcm_usbg_drop_nexus</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcm_usbg_nexus</span> <span class="o">*</span><span class="n">tv_nexus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_mutex</span><span class="p">);</span>
	<span class="n">tv_nexus</span> <span class="o">=</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_nexus</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tv_nexus</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">se_sess</span> <span class="o">=</span> <span class="n">tv_nexus</span><span class="o">-&gt;</span><span class="n">tvn_se_sess</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">se_sess</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_port_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to remove Host I_T Nexus with&quot;</span>
				<span class="s">&quot; active TPG port count: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_port_count</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Removing I_T Nexus to Initiator Port: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tv_nexus</span><span class="o">-&gt;</span><span class="n">tvn_se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Release the SCSI I_T Nexus to the emulated vHost Target Port</span>
<span class="cm">	 */</span>
	<span class="n">transport_deregister_session</span><span class="p">(</span><span class="n">tv_nexus</span><span class="o">-&gt;</span><span class="n">tvn_se_sess</span><span class="p">);</span>
	<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_nexus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">tv_nexus</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tcm_usbg_tpg_store_nexus</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_tpg</span><span class="p">,</span> <span class="n">se_tpg</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i_port</span><span class="p">[</span><span class="n">USBG_NAMELEN</span><span class="p">],</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;NULL&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tcm_usbg_drop_nexus</span><span class="p">(</span><span class="n">tpg</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="o">?</span> <span class="n">count</span> <span class="o">:</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">USBG_NAMELEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Emulated NAA Sas Address: %s, exceeds&quot;</span>
				<span class="s">&quot; max: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">USBG_NAMELEN</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">i_port</span><span class="p">,</span> <span class="n">USBG_NAMELEN</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">i_port</span><span class="p">,</span> <span class="s">&quot;naa.&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing &#39;naa.&#39; prefix</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i_port</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">i_port</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">i_port</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">i_port</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tcm_usbg_make_nexus</span><span class="p">(</span><span class="n">tpg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i_port</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">TF_TPG_BASE_ATTR</span><span class="p">(</span><span class="n">tcm_usbg</span><span class="p">,</span> <span class="n">nexus</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">configfs_attribute</span> <span class="o">*</span><span class="n">usbg_base_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">tcm_usbg_tpg_enable</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">tcm_usbg_tpg_nexus</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_port_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_tpg</span><span class="p">,</span> <span class="n">se_tpg</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_port_count</span><span class="p">);</span>
	<span class="n">smp_mb__after_atomic_inc</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbg_port_unlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">se_tpg</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">se_lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_tpg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_tpg</span><span class="p">,</span> <span class="n">se_tpg</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_port_count</span><span class="p">);</span>
	<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_check_stop_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbg_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbg_cmd</span><span class="p">,</span>
			<span class="n">se_cmd</span><span class="p">);</span>

	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">,</span> <span class="n">usbg_cmd_release</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">target_core_fabric_ops</span> <span class="n">usbg_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_fabric_name</span>		<span class="o">=</span> <span class="n">usbg_get_fabric_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fabric_proto_ident</span>		<span class="o">=</span> <span class="n">usbg_get_fabric_proto_ident</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tpg_get_wwn</span>			<span class="o">=</span> <span class="n">usbg_get_fabric_wwn</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tpg_get_tag</span>			<span class="o">=</span> <span class="n">usbg_get_tag</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tpg_get_default_depth</span>		<span class="o">=</span> <span class="n">usbg_get_default_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tpg_get_pr_transport_id</span>	<span class="o">=</span> <span class="n">usbg_get_pr_transport_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tpg_get_pr_transport_id_len</span>	<span class="o">=</span> <span class="n">usbg_get_pr_transport_id_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tpg_parse_pr_out_transport_id</span>	<span class="o">=</span> <span class="n">usbg_parse_pr_out_transport_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tpg_check_demo_mode</span>		<span class="o">=</span> <span class="n">usbg_check_true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tpg_check_demo_mode_cache</span>	<span class="o">=</span> <span class="n">usbg_check_false</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tpg_check_demo_mode_write_protect</span> <span class="o">=</span> <span class="n">usbg_check_false</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tpg_check_prod_mode_write_protect</span> <span class="o">=</span> <span class="n">usbg_check_false</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tpg_alloc_fabric_acl</span>		<span class="o">=</span> <span class="n">usbg_alloc_fabric_acl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tpg_release_fabric_acl</span>		<span class="o">=</span> <span class="n">usbg_release_fabric_acl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tpg_get_inst_index</span>		<span class="o">=</span> <span class="n">usbg_tpg_get_inst_index</span><span class="p">,</span>
	<span class="p">.</span><span class="n">new_cmd_map</span>			<span class="o">=</span> <span class="n">usbg_new_cmd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_cmd</span>			<span class="o">=</span> <span class="n">usbg_release_cmd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown_session</span>		<span class="o">=</span> <span class="n">usbg_shutdown_session</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close_session</span>			<span class="o">=</span> <span class="n">usbg_close_session</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sess_get_index</span>			<span class="o">=</span> <span class="n">usbg_sess_get_index</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sess_get_initiator_sid</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_pending</span>			<span class="o">=</span> <span class="n">usbg_send_write_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_pending_status</span>		<span class="o">=</span> <span class="n">usbg_write_pending_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_default_node_attributes</span>	<span class="o">=</span> <span class="n">usbg_set_default_node_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_task_tag</span>			<span class="o">=</span> <span class="n">usbg_get_task_tag</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_cmd_state</span>			<span class="o">=</span> <span class="n">usbg_get_cmd_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queue_data_in</span>			<span class="o">=</span> <span class="n">usbg_send_read_response</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queue_status</span>			<span class="o">=</span> <span class="n">usbg_send_status_response</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queue_tm_rsp</span>			<span class="o">=</span> <span class="n">usbg_queue_tm_rsp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fabric_sense_len</span>		<span class="o">=</span> <span class="n">usbg_get_fabric_sense_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fabric_sense_len</span>		<span class="o">=</span> <span class="n">usbg_set_fabric_sense_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_stop_free</span>		<span class="o">=</span> <span class="n">usbg_check_stop_free</span><span class="p">,</span>

	<span class="p">.</span><span class="n">fabric_make_wwn</span>		<span class="o">=</span> <span class="n">usbg_make_tport</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_drop_wwn</span>		<span class="o">=</span> <span class="n">usbg_drop_tport</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_make_tpg</span>		<span class="o">=</span> <span class="n">usbg_make_tpg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_drop_tpg</span>		<span class="o">=</span> <span class="n">usbg_drop_tpg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_post_link</span>		<span class="o">=</span> <span class="n">usbg_port_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_pre_unlink</span>		<span class="o">=</span> <span class="n">usbg_port_unlink</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_make_np</span>			<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_drop_np</span>			<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_make_nodeacl</span>		<span class="o">=</span> <span class="n">usbg_make_nodeacl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fabric_drop_nodeacl</span>		<span class="o">=</span> <span class="n">usbg_drop_nodeacl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_register_configfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">target_fabric_configfs</span> <span class="o">*</span><span class="n">fabric</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fabric</span> <span class="o">=</span> <span class="n">target_fabric_configfs_init</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="s">&quot;usb_gadget&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fabric</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;target_fabric_configfs_init() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fabric</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fabric</span><span class="o">-&gt;</span><span class="n">tf_ops</span> <span class="o">=</span> <span class="n">usbg_ops</span><span class="p">;</span>
	<span class="n">TF_CIT_TMPL</span><span class="p">(</span><span class="n">fabric</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tfc_wwn_cit</span><span class="p">.</span><span class="n">ct_attrs</span> <span class="o">=</span> <span class="n">usbg_wwn_attrs</span><span class="p">;</span>
	<span class="n">TF_CIT_TMPL</span><span class="p">(</span><span class="n">fabric</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tfc_tpg_base_cit</span><span class="p">.</span><span class="n">ct_attrs</span> <span class="o">=</span> <span class="n">usbg_base_attrs</span><span class="p">;</span>
	<span class="n">TF_CIT_TMPL</span><span class="p">(</span><span class="n">fabric</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tfc_tpg_attrib_cit</span><span class="p">.</span><span class="n">ct_attrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TF_CIT_TMPL</span><span class="p">(</span><span class="n">fabric</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tfc_tpg_param_cit</span><span class="p">.</span><span class="n">ct_attrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TF_CIT_TMPL</span><span class="p">(</span><span class="n">fabric</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tfc_tpg_np_base_cit</span><span class="p">.</span><span class="n">ct_attrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TF_CIT_TMPL</span><span class="p">(</span><span class="n">fabric</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tfc_tpg_nacl_base_cit</span><span class="p">.</span><span class="n">ct_attrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TF_CIT_TMPL</span><span class="p">(</span><span class="n">fabric</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tfc_tpg_nacl_attrib_cit</span><span class="p">.</span><span class="n">ct_attrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TF_CIT_TMPL</span><span class="p">(</span><span class="n">fabric</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tfc_tpg_nacl_auth_cit</span><span class="p">.</span><span class="n">ct_attrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TF_CIT_TMPL</span><span class="p">(</span><span class="n">fabric</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tfc_tpg_nacl_param_cit</span><span class="p">.</span><span class="n">ct_attrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">target_fabric_configfs_register</span><span class="p">(</span><span class="n">fabric</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;target_fabric_configfs_register() failed&quot;</span>
				<span class="s">&quot; for usb-gadget</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usbg_fabric_configfs</span> <span class="o">=</span> <span class="n">fabric</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbg_deregister_configfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">usbg_fabric_configfs</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">target_fabric_configfs_deregister</span><span class="p">(</span><span class="n">usbg_fabric_configfs</span><span class="p">);</span>
	<span class="n">usbg_fabric_configfs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Start gadget.c code */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_interface_descriptor</span> <span class="n">bot_intf_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>              <span class="k">sizeof</span><span class="p">(</span><span class="n">bot_intf_desc</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>      <span class="n">USB_DT_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bAlternateSetting</span> <span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bNumEndpoints</span> <span class="o">=</span>        <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bAlternateSetting</span> <span class="o">=</span>	<span class="n">USB_G_ALT_INT_BBB</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceClass</span> <span class="o">=</span>      <span class="n">USB_CLASS_MASS_STORAGE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceSubClass</span> <span class="o">=</span>   <span class="n">USB_SC_SCSI</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceProtocol</span> <span class="o">=</span>   <span class="n">USB_PR_BULK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iInterface</span> <span class="o">=</span>           <span class="n">USB_G_STR_INT_UAS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_interface_descriptor</span> <span class="n">uasp_intf_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="k">sizeof</span><span class="p">(</span><span class="n">uasp_intf_desc</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bNumEndpoints</span> <span class="o">=</span>	<span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bAlternateSetting</span> <span class="o">=</span>	<span class="n">USB_G_ALT_INT_UAS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceClass</span> <span class="o">=</span>	<span class="n">USB_CLASS_MASS_STORAGE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceSubClass</span> <span class="o">=</span>	<span class="n">USB_SC_SCSI</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceProtocol</span> <span class="o">=</span>	<span class="n">USB_PR_UAS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iInterface</span> <span class="o">=</span>		<span class="n">USB_G_STR_INT_BBB</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">uasp_bi_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span>	<span class="n">USB_DIR_IN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span>		<span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span>	<span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">uasp_fs_bi_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span>	<span class="n">USB_DIR_IN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span>		<span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_pipe_usage_descriptor</span> <span class="n">uasp_bi_pipe_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="k">sizeof</span><span class="p">(</span><span class="n">uasp_bi_pipe_desc</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_PIPE_USAGE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bPipeID</span> <span class="o">=</span>		<span class="n">DATA_IN_PIPE_ID</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">uasp_ss_bi_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span>	<span class="n">USB_DIR_IN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span>		<span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span>	<span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_ss_ep_comp_descriptor</span> <span class="n">uasp_bi_ep_comp_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="k">sizeof</span><span class="p">(</span><span class="n">uasp_bi_ep_comp_desc</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_SS_ENDPOINT_COMP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bMaxBurst</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span>		<span class="n">UASP_SS_EP_COMP_LOG_STREAMS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wBytesPerInterval</span> <span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_ss_ep_comp_descriptor</span> <span class="n">bot_bi_ep_comp_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="k">sizeof</span><span class="p">(</span><span class="n">bot_bi_ep_comp_desc</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_SS_ENDPOINT_COMP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bMaxBurst</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">uasp_bo_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span>	<span class="n">USB_DIR_OUT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span>		<span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span>	<span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">uasp_fs_bo_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span>	<span class="n">USB_DIR_OUT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span>		<span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_pipe_usage_descriptor</span> <span class="n">uasp_bo_pipe_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="k">sizeof</span><span class="p">(</span><span class="n">uasp_bo_pipe_desc</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_PIPE_USAGE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bPipeID</span> <span class="o">=</span>		<span class="n">DATA_OUT_PIPE_ID</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">uasp_ss_bo_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span>	<span class="n">USB_DIR_OUT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span>		<span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span>	<span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x400</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_ss_ep_comp_descriptor</span> <span class="n">uasp_bo_ep_comp_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="k">sizeof</span><span class="p">(</span><span class="n">uasp_bo_ep_comp_desc</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_SS_ENDPOINT_COMP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span>		<span class="n">UASP_SS_EP_COMP_LOG_STREAMS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_ss_ep_comp_descriptor</span> <span class="n">bot_bo_ep_comp_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="k">sizeof</span><span class="p">(</span><span class="n">bot_bo_ep_comp_desc</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_SS_ENDPOINT_COMP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">uasp_status_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span>	<span class="n">USB_DIR_IN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span>		<span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span>	<span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">uasp_fs_status_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span>	<span class="n">USB_DIR_IN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span>		<span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_pipe_usage_descriptor</span> <span class="n">uasp_status_pipe_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="k">sizeof</span><span class="p">(</span><span class="n">uasp_status_pipe_desc</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_PIPE_USAGE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bPipeID</span> <span class="o">=</span>		<span class="n">STATUS_PIPE_ID</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">uasp_ss_status_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span>	<span class="n">USB_DIR_IN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span>		<span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span>	<span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_ss_ep_comp_descriptor</span> <span class="n">uasp_status_in_ep_comp_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="k">sizeof</span><span class="p">(</span><span class="n">uasp_status_in_ep_comp_desc</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_SS_ENDPOINT_COMP</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span>		<span class="n">UASP_SS_EP_COMP_LOG_STREAMS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">uasp_cmd_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span>	<span class="n">USB_DIR_OUT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span>		<span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span>	<span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">uasp_fs_cmd_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span>	<span class="n">USB_DIR_OUT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span>		<span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_pipe_usage_descriptor</span> <span class="n">uasp_cmd_pipe_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="k">sizeof</span><span class="p">(</span><span class="n">uasp_cmd_pipe_desc</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_PIPE_USAGE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bPipeID</span> <span class="o">=</span>		<span class="n">CMD_PIPE_ID</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">uasp_ss_cmd_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span>	<span class="n">USB_DIR_OUT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span>		<span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span>	<span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_ss_ep_comp_descriptor</span> <span class="n">uasp_cmd_comp_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="k">sizeof</span><span class="p">(</span><span class="n">uasp_cmd_comp_desc</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_SS_ENDPOINT_COMP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="n">uasp_fs_function_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bot_intf_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_fs_bi_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_fs_bo_desc</span><span class="p">,</span>

	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_intf_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_fs_bi_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_bi_pipe_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_fs_bo_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_bo_pipe_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_fs_status_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_status_pipe_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_fs_cmd_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_cmd_pipe_desc</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="n">uasp_hs_function_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bot_intf_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_bi_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_bo_desc</span><span class="p">,</span>

	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_intf_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_bi_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_bi_pipe_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_bo_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_bo_pipe_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_status_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_status_pipe_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_cmd_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_cmd_pipe_desc</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="n">uasp_ss_function_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bot_intf_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_ss_bi_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bot_bi_ep_comp_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_ss_bo_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bot_bo_ep_comp_desc</span><span class="p">,</span>

	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_intf_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_ss_bi_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_bi_ep_comp_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_bi_pipe_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_ss_bo_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_bo_ep_comp_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_bo_pipe_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_ss_status_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_status_in_ep_comp_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_status_pipe_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_ss_cmd_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_cmd_comp_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uasp_cmd_pipe_desc</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define UAS_VENDOR_ID	0x0525	</span><span class="cm">/* NetChip */</span><span class="cp"></span>
<span class="cp">#define UAS_PRODUCT_ID	0xa4a5	</span><span class="cm">/* Linux-USB File-backed Storage Gadget */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_descriptor</span> <span class="n">usbg_device_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span>		<span class="k">sizeof</span><span class="p">(</span><span class="n">usbg_device_desc</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span>	<span class="n">USB_DT_DEVICE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bcdUSB</span> <span class="o">=</span>		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0200</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bDeviceClass</span> <span class="o">=</span>		<span class="n">USB_CLASS_PER_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idVendor</span> <span class="o">=</span>		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">UAS_VENDOR_ID</span><span class="p">),</span>
	<span class="p">.</span><span class="n">idProduct</span> <span class="o">=</span>		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">UAS_PRODUCT_ID</span><span class="p">),</span>
	<span class="p">.</span><span class="n">iManufacturer</span> <span class="o">=</span>	<span class="n">USB_G_STR_MANUFACTOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iProduct</span> <span class="o">=</span>		<span class="n">USB_G_STR_PRODUCT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iSerialNumber</span> <span class="o">=</span>	<span class="n">USB_G_STR_SERIAL</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bNumConfigurations</span> <span class="o">=</span>   <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_string</span>	<span class="n">usbg_us_strings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_G_STR_MANUFACTOR</span><span class="p">,</span>	<span class="s">&quot;Target Manufactor&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_G_STR_PRODUCT</span><span class="p">,</span>	<span class="s">&quot;Target Product&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_G_STR_SERIAL</span><span class="p">,</span>	<span class="s">&quot;000000000001&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_G_STR_CONFIG</span><span class="p">,</span>	<span class="s">&quot;default config&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_G_STR_INT_UAS</span><span class="p">,</span>	<span class="s">&quot;USB Attached SCSI&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_G_STR_INT_BBB</span><span class="p">,</span>	<span class="s">&quot;Bulk Only Transport&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_gadget_strings</span> <span class="n">usbg_stringtab</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">language</span> <span class="o">=</span> <span class="mh">0x0409</span><span class="p">,</span>
	<span class="p">.</span><span class="n">strings</span> <span class="o">=</span> <span class="n">usbg_us_strings</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_gadget_strings</span> <span class="o">*</span><span class="n">usbg_strings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">usbg_stringtab</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">guas_unbind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_configuration</span> <span class="n">usbg_config_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">label</span>                  <span class="o">=</span> <span class="s">&quot;Linux Target&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bConfigurationValue</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iConfiguration</span>		<span class="o">=</span> <span class="n">USB_G_STR_CONFIG</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span>           <span class="o">=</span> <span class="n">USB_CONFIG_ATT_SELFPOWER</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">give_back_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">**</span><span class="n">pep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">*</span><span class="n">pep</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">f_uas</span>		<span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">to_f_uas</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span>	<span class="o">*</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_ep</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">iface</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">usb_interface_id</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iface</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">iface</span><span class="p">;</span>

	<span class="n">bot_intf_desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span> <span class="o">=</span> <span class="n">iface</span><span class="p">;</span>
	<span class="n">uasp_intf_desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span> <span class="o">=</span> <span class="n">iface</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">iface</span> <span class="o">=</span> <span class="n">iface</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">usb_ep_autoconfig_ss</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uasp_ss_bi_desc</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">uasp_bi_ep_comp_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ep_fail</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">fu</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">usb_ep_autoconfig_ss</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uasp_ss_bo_desc</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">uasp_bo_ep_comp_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ep_fail</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">fu</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">usb_ep_autoconfig_ss</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uasp_ss_status_desc</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">uasp_status_in_ep_comp_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ep_fail</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">fu</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_status</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">usb_ep_autoconfig_ss</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uasp_ss_cmd_desc</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">uasp_cmd_comp_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ep_fail</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">fu</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_cmd</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>

	<span class="cm">/* Assume endpoint addresses are the same for both speeds */</span>
	<span class="n">uasp_bi_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span>	<span class="n">uasp_ss_bi_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">;</span>
	<span class="n">uasp_bo_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">uasp_ss_bo_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">;</span>
	<span class="n">uasp_status_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span>
		<span class="n">uasp_ss_status_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">;</span>
	<span class="n">uasp_cmd_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">uasp_ss_cmd_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">;</span>

	<span class="n">uasp_fs_bi_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">uasp_ss_bi_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">;</span>
	<span class="n">uasp_fs_bo_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">uasp_ss_bo_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">;</span>
	<span class="n">uasp_fs_status_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span>
		<span class="n">uasp_ss_status_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">;</span>
	<span class="n">uasp_fs_cmd_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">uasp_ss_cmd_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">ep_fail:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Can&#39;t claim all required eps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">give_back_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">);</span>
	<span class="n">give_back_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_out</span><span class="p">);</span>
	<span class="n">give_back_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_status</span><span class="p">);</span>
	<span class="n">give_back_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">ep_cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbg_unbind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">to_f_uas</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">guas_setup_wq</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">alt</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbg_delayed_set_alt</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">wq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">guas_setup_wq</span> <span class="o">*</span><span class="n">work</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">guas_setup_wq</span><span class="p">,</span>
			<span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">fu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">alt</span> <span class="o">=</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USBG_IS_BOT</span><span class="p">)</span>
		<span class="n">bot_cleanup_old_alt</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USBG_IS_UAS</span><span class="p">)</span>
		<span class="n">uasp_cleanup_old_alt</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alt</span> <span class="o">==</span> <span class="n">USB_G_ALT_INT_BBB</span><span class="p">)</span>
		<span class="n">bot_set_alt</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">alt</span> <span class="o">==</span> <span class="n">USB_G_ALT_INT_UAS</span><span class="p">)</span>
		<span class="n">uasp_set_alt</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>
	<span class="n">usb_composite_setup_continue</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">.</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_set_alt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">intf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">alt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">to_f_uas</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">alt</span> <span class="o">==</span> <span class="n">USB_G_ALT_INT_BBB</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">alt</span> <span class="o">==</span> <span class="n">USB_G_ALT_INT_UAS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">guas_setup_wq</span> <span class="o">*</span><span class="n">work</span><span class="p">;</span>

		<span class="n">work</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">work</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">work</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">usbg_delayed_set_alt</span><span class="p">);</span>
		<span class="n">work</span><span class="o">-&gt;</span><span class="n">fu</span> <span class="o">=</span> <span class="n">fu</span><span class="p">;</span>
		<span class="n">work</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">=</span> <span class="n">alt</span><span class="p">;</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">USB_GADGET_DELAYED_STATUS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbg_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">to_f_uas</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USBG_IS_UAS</span><span class="p">)</span>
		<span class="n">uasp_cleanup_old_alt</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USBG_IS_BOT</span><span class="p">)</span>
		<span class="n">bot_cleanup_old_alt</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span> <span class="o">=</span> <span class="n">to_f_uas</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USBG_IS_BOT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">usbg_bot_setup</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_cfg_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">f_uas</span> <span class="o">*</span><span class="n">fu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fu</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fu</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fu</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Target Function&quot;</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">.</span><span class="n">descriptors</span> <span class="o">=</span> <span class="n">uasp_fs_function_desc</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">.</span><span class="n">hs_descriptors</span> <span class="o">=</span> <span class="n">uasp_hs_function_desc</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">.</span><span class="n">ss_descriptors</span> <span class="o">=</span> <span class="n">uasp_ss_function_desc</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">usbg_bind</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">.</span><span class="n">unbind</span> <span class="o">=</span> <span class="n">usbg_unbind</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">.</span><span class="n">set_alt</span> <span class="o">=</span> <span class="n">usbg_set_alt</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">usbg_setup</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">.</span><span class="n">disable</span> <span class="o">=</span> <span class="n">usbg_disable</span><span class="p">;</span>
	<span class="n">fu</span><span class="o">-&gt;</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">the_only_tpg_I_currently_have</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_add_function</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fu</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fu</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usb_target_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_add_config</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usbg_config_driver</span><span class="p">,</span>
			<span class="n">usbg_cfg_bind</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_composite_driver</span> <span class="n">usbg_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;g_target&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>            <span class="o">=</span> <span class="o">&amp;</span><span class="n">usbg_device_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">strings</span>        <span class="o">=</span> <span class="n">usbg_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_speed</span>      <span class="o">=</span> <span class="n">USB_SPEED_SUPER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind</span>         <span class="o">=</span> <span class="n">guas_unbind</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbg_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">usb_composite_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbg_driver</span><span class="p">,</span> <span class="n">usb_target_bind</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbg_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbg_tpg</span> <span class="o">*</span><span class="n">tpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_composite_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbg_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">usb_target_gadget_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbg_register_configfs</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">usb_target_gadget_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">usb_target_gadget_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usbg_deregister_configfs</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">usb_target_gadget_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Sebastian Andrzej Siewior &lt;bigeasy@linutronix.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;usb-gadget fabric&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
