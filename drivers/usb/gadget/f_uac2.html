<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › gadget › f_uac2.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>f_uac2.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * f_uac2.c -- USB Audio Class 2.0 Function</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011</span>
<span class="cm"> *    Yadwinder Singh (yadi.brar01@gmail.com)</span>
<span class="cm"> *    Jaswinder Singh (jaswinder.singh@linaro.org)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/usb/audio.h&gt;</span>
<span class="cp">#include &lt;linux/usb/audio-v2.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>

<span class="cm">/* Playback(USB-IN) Default Stereo - Fl/Fr */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">p_chmask</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">p_chmask</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">p_chmask</span><span class="p">,</span> <span class="s">&quot;Playback Channel Mask&quot;</span><span class="p">);</span>

<span class="cm">/* Playback Default 48 KHz */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">p_srate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">p_srate</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">p_srate</span><span class="p">,</span> <span class="s">&quot;Playback Sampling Rate&quot;</span><span class="p">);</span>

<span class="cm">/* Playback Default 16bits/sample */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">p_ssize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">p_ssize</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">p_ssize</span><span class="p">,</span> <span class="s">&quot;Playback Sample Size(bytes)&quot;</span><span class="p">);</span>

<span class="cm">/* Capture(USB-OUT) Default Stereo - Fl/Fr */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">c_chmask</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">c_chmask</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">c_chmask</span><span class="p">,</span> <span class="s">&quot;Capture Channel Mask&quot;</span><span class="p">);</span>

<span class="cm">/* Capture Default 64 KHz */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">c_srate</span> <span class="o">=</span> <span class="mi">64000</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">c_srate</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">c_srate</span><span class="p">,</span> <span class="s">&quot;Capture Sampling Rate&quot;</span><span class="p">);</span>

<span class="cm">/* Capture Default 16bits/sample */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">c_ssize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">c_ssize</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">c_ssize</span><span class="p">,</span> <span class="s">&quot;Capture Sample Size(bytes)&quot;</span><span class="p">);</span>

<span class="cp">#define DMA_ADDR_INVALID	(~(dma_addr_t)0)</span>

<span class="cp">#define ALT_SET(x, a)	do {(x) &amp;= ~0xff; (x) |= (a); } while (0)</span>
<span class="cp">#define ALT_GET(x)	((x) &amp; 0xff)</span>
<span class="cp">#define INTF_SET(x, i)	do {(x) &amp;= 0xff; (x) |= ((i) &lt;&lt; 8); } while (0)</span>
<span class="cp">#define INTF_GET(x)	((x &gt;&gt; 8) &amp; 0xff)</span>

<span class="cm">/* Keep everyone on toes */</span>
<span class="cp">#define USB_XFERS	2</span>

<span class="cm">/*</span>
<span class="cm"> * The driver implements a simple UAC_2 topology.</span>
<span class="cm"> * USB-OUT -&gt; IT_1 -&gt; OT_3 -&gt; ALSA_Capture</span>
<span class="cm"> * ALSA_Playback -&gt; IT_2 -&gt; OT_4 -&gt; USB-IN</span>
<span class="cm"> * Capture and Playback sampling rates are independently</span>
<span class="cm"> *  controlled by two clock sources :</span>
<span class="cm"> *    CLK_5 := c_srate, and CLK_6 := p_srate</span>
<span class="cm"> */</span>
<span class="cp">#define USB_OUT_IT_ID	1</span>
<span class="cp">#define IO_IN_IT_ID	2</span>
<span class="cp">#define IO_OUT_OT_ID	3</span>
<span class="cp">#define USB_IN_OT_ID	4</span>
<span class="cp">#define USB_OUT_CLK_ID	5</span>
<span class="cp">#define USB_IN_CLK_ID	6</span>

<span class="cp">#define CONTROL_ABSENT	0</span>
<span class="cp">#define CONTROL_RDONLY	1</span>
<span class="cp">#define CONTROL_RDWR	3</span>

<span class="cp">#define CLK_FREQ_CTRL	0</span>
<span class="cp">#define CLK_VLD_CTRL	2</span>

<span class="cp">#define COPY_CTRL	0</span>
<span class="cp">#define CONN_CTRL	2</span>
<span class="cp">#define OVRLD_CTRL	4</span>
<span class="cp">#define CLSTR_CTRL	6</span>
<span class="cp">#define UNFLW_CTRL	8</span>
<span class="cp">#define OVFLW_CTRL	10</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uac2_name</span> <span class="o">=</span> <span class="s">&quot;snd_uac2&quot;</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">uac2_req</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">uac2_rtd_params</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span> <span class="cm">/* parent param */</span>
	<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">uac2_rtd_params</span> <span class="p">{</span>
	<span class="n">bool</span> <span class="n">ep_enabled</span><span class="p">;</span> <span class="cm">/* if the ep is enabled */</span>
	<span class="cm">/* Size of the ring buffer */</span>
	<span class="kt">size_t</span> <span class="n">dma_bytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dma_area</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">ss</span><span class="p">;</span>

	<span class="cm">/* Ring buffer */</span>
	<span class="kt">ssize_t</span> <span class="n">hw_ptr</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">rbuf</span><span class="p">;</span>

	<span class="kt">size_t</span> <span class="n">period_size</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="n">max_psize</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uac2_req</span> <span class="n">ureq</span><span class="p">[</span><span class="n">USB_XFERS</span><span class="p">];</span>

	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">pdrv</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">uac2_rtd_params</span> <span class="n">p_prm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uac2_rtd_params</span> <span class="n">c_prm</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define BUFF_SIZE_MAX	(PAGE_SIZE * 16)</span>
<span class="cp">#define PRD_SIZE_MAX	PAGE_SIZE</span>
<span class="cp">#define MIN_PERIODS	4</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">uac2_pcm_hardware</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span>
		 <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span>
		 <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_RESUME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_CONTINUOUS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span> <span class="n">BUFF_SIZE_MAX</span> <span class="o">/</span> <span class="n">PRD_SIZE_MAX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="n">BUFF_SIZE_MAX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="n">PRD_SIZE_MAX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span> <span class="n">MIN_PERIODS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">audio_dev</span> <span class="p">{</span>
	<span class="cm">/* Currently active {Interface[15:8] | AltSettings[7:0]} */</span>
	<span class="n">__u16</span> <span class="n">ac_alt</span><span class="p">,</span> <span class="n">as_out_alt</span><span class="p">,</span> <span class="n">as_in_alt</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">in_ep</span><span class="p">,</span> <span class="o">*</span><span class="n">out_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_function</span> <span class="n">func</span><span class="p">;</span>

	<span class="cm">/* The ALSA Sound Card it represents on the USB-Client side */</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="n">uac2</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">audio_dev</span> <span class="o">*</span><span class="n">agdev_g</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="k">struct</span> <span class="n">audio_dev</span> <span class="o">*</span><span class="nf">func_to_agdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="k">struct</span> <span class="n">audio_dev</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="k">struct</span> <span class="n">audio_dev</span> <span class="o">*</span><span class="nf">uac2_to_agdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="k">struct</span> <span class="n">audio_dev</span><span class="p">,</span> <span class="n">uac2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="nf">pdev_to_uac2</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_uac2_chip</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="nf">prm_to_uac2</span><span class="p">(</span><span class="k">struct</span> <span class="n">uac2_rtd_params</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">r</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_uac2_chip</span><span class="p">,</span> <span class="n">c_prm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">c_prm</span> <span class="o">!=</span> <span class="n">r</span><span class="p">)</span>
		<span class="n">uac2</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_uac2_chip</span><span class="p">,</span> <span class="n">p_prm</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">uac2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="n">uint</span> <span class="nf">num_channels</span><span class="p">(</span><span class="n">uint</span> <span class="n">chanmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">chanmask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num</span> <span class="o">+=</span> <span class="p">(</span><span class="n">chanmask</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">chanmask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">agdev_iso_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">pending</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">update_alsa</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uac2_req</span> <span class="o">*</span><span class="n">ur</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uac2_rtd_params</span> <span class="o">*</span><span class="n">prm</span> <span class="o">=</span> <span class="n">ur</span><span class="o">-&gt;</span><span class="n">pp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="n">prm_to_uac2</span><span class="p">(</span><span class="n">prm</span><span class="p">);</span>

	<span class="cm">/* i/f shutting down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">ep_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can&#39;t really do much about bad xfers.</span>
<span class="cm">	 * Afterall, the ISOCH xfers could fail legitimately.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: iso_complete status(%d) %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="n">substream</span> <span class="o">=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">ss</span><span class="p">;</span>

	<span class="cm">/* Do nothing if ALSA isn&#39;t active */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">substream</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">+</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">hw_ptr</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">+</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">hw_ptr</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pending</span> <span class="o">=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">hw_ptr</span> <span class="o">%</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
	<span class="n">pending</span> <span class="o">+=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&gt;=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">)</span>
		<span class="n">update_alsa</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">hw_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">hw_ptr</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">)</span> <span class="o">%</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">dma_bytes</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Pack USB load in ALSA ring buffer */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">update_alsa</span><span class="p">)</span>
		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">uac2_pcm_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">audio_dev</span> <span class="o">*</span><span class="n">agdev</span> <span class="o">=</span> <span class="n">uac2_to_agdev</span><span class="p">(</span><span class="n">uac2</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">uac2_rtd_params</span> <span class="o">*</span><span class="n">prm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">agdev</span><span class="o">-&gt;</span><span class="n">in_ep</span><span class="p">;</span>
		<span class="n">prm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">p_prm</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">agdev</span><span class="o">-&gt;</span><span class="n">out_ep</span><span class="p">;</span>
		<span class="n">prm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">c_prm</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Reset */</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">hw_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="n">prm</span><span class="o">-&gt;</span><span class="n">ss</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">prm</span><span class="o">-&gt;</span><span class="n">ss</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Clear buffer after Play stops */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">ss</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">max_psize</span> <span class="o">*</span> <span class="n">USB_XFERS</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">uac2_pcm_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">uac2_rtd_params</span> <span class="o">*</span><span class="n">prm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">prm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">p_prm</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">prm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">c_prm</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">hw_ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uac2_pcm_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">uac2_rtd_params</span> <span class="o">*</span><span class="n">prm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">prm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">p_prm</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">prm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">c_prm</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span>
					<span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prm</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span><span class="p">;</span>
		<span class="n">prm</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">;</span>
		<span class="n">prm</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">=</span> <span class="n">params_period_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uac2_pcm_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">uac2_rtd_params</span> <span class="o">*</span><span class="n">prm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">prm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">p_prm</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">prm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">c_prm</span><span class="p">;</span>

	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uac2_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">uac2_pcm_hardware</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">p_prm</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">p_srate</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">;</span> <span class="cm">/* ! p_ssize ! */</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="n">num_channels</span><span class="p">(</span><span class="n">p_chmask</span><span class="p">);</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">uac2</span><span class="o">-&gt;</span><span class="n">p_prm</span><span class="p">.</span><span class="n">max_psize</span>
						<span class="o">/</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">periods_min</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">c_prm</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">c_srate</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">;</span> <span class="cm">/* ! c_ssize ! */</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="n">num_channels</span><span class="p">(</span><span class="n">c_chmask</span><span class="p">);</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">uac2</span><span class="o">-&gt;</span><span class="n">c_prm</span><span class="p">.</span><span class="n">max_psize</span>
						<span class="o">/</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">periods_min</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_min</span><span class="p">;</span>

	<span class="n">snd_pcm_hw_constraint_integer</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ALSA cries without these function pointers */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uac2_pcm_null</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">uac2_pcm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">uac2_pcm_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">uac2_pcm_null</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">uac2_pcm_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span> <span class="n">uac2_pcm_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">uac2_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">uac2_pcm_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">uac2_pcm_null</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_uac2_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="n">pdev_to_uac2</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Choose any slot, with no id */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">uac2</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Create first PCM device</span>
<span class="cm">	 * Create a substream only for non-zero channel streams</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;UAC2 PCM&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">p_chmask</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c_chmask</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">snd_fail</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;UAC2 PCM&quot;</span><span class="p">);</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">uac2</span><span class="p">;</span>

	<span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uac2_pcm_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uac2_pcm_ops</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;UAC2_Gadget&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;UAC2_Gadget&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;UAC2_Gadget %i&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_CONTINUOUS</span><span class="p">,</span>
		<span class="n">snd_dma_continuous_data</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BUFF_SIZE_MAX</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">snd_fail:</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">uac2</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">snd_uac2_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alsa_uac2_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">audio_dev</span> <span class="o">*</span><span class="n">agdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">uac2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdrv</span><span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_uac2_probe</span><span class="p">;</span>
	<span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdrv</span><span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">snd_uac2_remove</span><span class="p">;</span>
	<span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdrv</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">uac2_name</span><span class="p">;</span>

	<span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">uac2_name</span><span class="p">;</span>

	<span class="cm">/* Register snd_uac2 driver */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdrv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Register snd_uac2 device */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdrv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alsa_uac2_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">audio_dev</span> <span class="o">*</span><span class="n">agdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">uac2</span><span class="p">;</span>

	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdrv</span><span class="p">);</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* --------- USB Function Interface ------------- */</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">STR_ASSOC</span><span class="p">,</span>
	<span class="n">STR_IF_CTRL</span><span class="p">,</span>
	<span class="n">STR_CLKSRC_IN</span><span class="p">,</span>
	<span class="n">STR_CLKSRC_OUT</span><span class="p">,</span>
	<span class="n">STR_USB_IT</span><span class="p">,</span>
	<span class="n">STR_IO_IT</span><span class="p">,</span>
	<span class="n">STR_USB_OT</span><span class="p">,</span>
	<span class="n">STR_IO_OT</span><span class="p">,</span>
	<span class="n">STR_AS_OUT_ALT0</span><span class="p">,</span>
	<span class="n">STR_AS_OUT_ALT1</span><span class="p">,</span>
	<span class="n">STR_AS_IN_ALT0</span><span class="p">,</span>
	<span class="n">STR_AS_IN_ALT1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ifassoc</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Source/Sink&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ifctrl</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Topology Control&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">clksrc_in</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">clksrc_out</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">usb_it</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;USBH Out&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">io_it</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;USBD Out&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">usb_ot</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;USBH In&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">io_ot</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;USBD In&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">out_alt0</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Playback Inactive&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">out_alt1</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Playback Active&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">in_alt0</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Capture Inactive&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">in_alt1</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Capture Active&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_string</span> <span class="n">strings_fn</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">STR_ASSOC</span><span class="p">].</span><span class="n">s</span> <span class="o">=</span> <span class="n">ifassoc</span><span class="p">,</span>
	<span class="p">[</span><span class="n">STR_IF_CTRL</span><span class="p">].</span><span class="n">s</span> <span class="o">=</span> <span class="n">ifctrl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">STR_CLKSRC_IN</span><span class="p">].</span><span class="n">s</span> <span class="o">=</span> <span class="n">clksrc_in</span><span class="p">,</span>
	<span class="p">[</span><span class="n">STR_CLKSRC_OUT</span><span class="p">].</span><span class="n">s</span> <span class="o">=</span> <span class="n">clksrc_out</span><span class="p">,</span>
	<span class="p">[</span><span class="n">STR_USB_IT</span><span class="p">].</span><span class="n">s</span> <span class="o">=</span> <span class="n">usb_it</span><span class="p">,</span>
	<span class="p">[</span><span class="n">STR_IO_IT</span><span class="p">].</span><span class="n">s</span> <span class="o">=</span> <span class="n">io_it</span><span class="p">,</span>
	<span class="p">[</span><span class="n">STR_USB_OT</span><span class="p">].</span><span class="n">s</span> <span class="o">=</span> <span class="n">usb_ot</span><span class="p">,</span>
	<span class="p">[</span><span class="n">STR_IO_OT</span><span class="p">].</span><span class="n">s</span> <span class="o">=</span> <span class="n">io_ot</span><span class="p">,</span>
	<span class="p">[</span><span class="n">STR_AS_OUT_ALT0</span><span class="p">].</span><span class="n">s</span> <span class="o">=</span> <span class="n">out_alt0</span><span class="p">,</span>
	<span class="p">[</span><span class="n">STR_AS_OUT_ALT1</span><span class="p">].</span><span class="n">s</span> <span class="o">=</span> <span class="n">out_alt1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">STR_AS_IN_ALT0</span><span class="p">].</span><span class="n">s</span> <span class="o">=</span> <span class="n">in_alt0</span><span class="p">,</span>
	<span class="p">[</span><span class="n">STR_AS_IN_ALT1</span><span class="p">].</span><span class="n">s</span> <span class="o">=</span> <span class="n">in_alt1</span><span class="p">,</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_gadget_strings</span> <span class="n">str_fn</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">language</span> <span class="o">=</span> <span class="mh">0x0409</span><span class="p">,</span>	<span class="cm">/* en-us */</span>
	<span class="p">.</span><span class="n">strings</span> <span class="o">=</span> <span class="n">strings_fn</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_gadget_strings</span> <span class="o">*</span><span class="n">fn_strings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">str_fn</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_qualifier_descriptor</span> <span class="n">devqual_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">devqual_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_DEVICE_QUALIFIER</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bcdUSB</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x200</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bDeviceClass</span> <span class="o">=</span> <span class="n">USB_CLASS_MISC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDeviceSubClass</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDeviceProtocol</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bNumConfigurations</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bRESERVED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_interface_assoc_descriptor</span> <span class="n">iad_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">iad_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_INTERFACE_ASSOCIATION</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bFirstInterface</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceCount</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bFunctionClass</span> <span class="o">=</span> <span class="n">USB_CLASS_AUDIO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bFunctionSubClass</span> <span class="o">=</span> <span class="n">UAC2_FUNCTION_SUBCLASS_UNDEFINED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bFunctionProtocol</span> <span class="o">=</span> <span class="n">UAC_VERSION_2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Audio Control Interface */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_interface_descriptor</span> <span class="n">std_ac_if_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">std_ac_if_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_INTERFACE</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bAlternateSetting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bNumEndpoints</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceClass</span> <span class="o">=</span> <span class="n">USB_CLASS_AUDIO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceSubClass</span> <span class="o">=</span> <span class="n">USB_SUBCLASS_AUDIOCONTROL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceProtocol</span> <span class="o">=</span> <span class="n">UAC_VERSION_2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Clock source for IN traffic */</span>
<span class="k">struct</span> <span class="n">uac_clock_source_descriptor</span> <span class="n">in_clk_src_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">in_clk_src_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bDescriptorSubtype</span> <span class="o">=</span> <span class="n">UAC2_CLOCK_SOURCE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bClockID</span> <span class="o">=</span> <span class="n">USB_IN_CLK_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="n">UAC_CLOCK_SOURCE_TYPE_INT_FIXED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmControls</span> <span class="o">=</span> <span class="p">(</span><span class="n">CONTROL_RDONLY</span> <span class="o">&lt;&lt;</span> <span class="n">CLK_FREQ_CTRL</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bAssocTerminal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Clock source for OUT traffic */</span>
<span class="k">struct</span> <span class="n">uac_clock_source_descriptor</span> <span class="n">out_clk_src_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">out_clk_src_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bDescriptorSubtype</span> <span class="o">=</span> <span class="n">UAC2_CLOCK_SOURCE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bClockID</span> <span class="o">=</span> <span class="n">USB_OUT_CLK_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="n">UAC_CLOCK_SOURCE_TYPE_INT_FIXED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmControls</span> <span class="o">=</span> <span class="p">(</span><span class="n">CONTROL_RDONLY</span> <span class="o">&lt;&lt;</span> <span class="n">CLK_FREQ_CTRL</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bAssocTerminal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Input Terminal for USB_OUT */</span>
<span class="k">struct</span> <span class="n">uac2_input_terminal_descriptor</span> <span class="n">usb_out_it_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">usb_out_it_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bDescriptorSubtype</span> <span class="o">=</span> <span class="n">UAC_INPUT_TERMINAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bTerminalID</span> <span class="o">=</span> <span class="n">USB_OUT_IT_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wTerminalType</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">UAC_TERMINAL_STREAMING</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bAssocTerminal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bCSourceID</span> <span class="o">=</span> <span class="n">USB_OUT_CLK_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iChannelNames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmControls</span> <span class="o">=</span> <span class="p">(</span><span class="n">CONTROL_RDWR</span> <span class="o">&lt;&lt;</span> <span class="n">COPY_CTRL</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Input Terminal for I/O-In */</span>
<span class="k">struct</span> <span class="n">uac2_input_terminal_descriptor</span> <span class="n">io_in_it_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">io_in_it_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bDescriptorSubtype</span> <span class="o">=</span> <span class="n">UAC_INPUT_TERMINAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bTerminalID</span> <span class="o">=</span> <span class="n">IO_IN_IT_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wTerminalType</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">UAC_INPUT_TERMINAL_UNDEFINED</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bAssocTerminal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bCSourceID</span> <span class="o">=</span> <span class="n">USB_IN_CLK_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iChannelNames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmControls</span> <span class="o">=</span> <span class="p">(</span><span class="n">CONTROL_RDWR</span> <span class="o">&lt;&lt;</span> <span class="n">COPY_CTRL</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Ouput Terminal for USB_IN */</span>
<span class="k">struct</span> <span class="n">uac2_output_terminal_descriptor</span> <span class="n">usb_in_ot_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">usb_in_ot_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bDescriptorSubtype</span> <span class="o">=</span> <span class="n">UAC_OUTPUT_TERMINAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bTerminalID</span> <span class="o">=</span> <span class="n">USB_IN_OT_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wTerminalType</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">UAC_TERMINAL_STREAMING</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bAssocTerminal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bSourceID</span> <span class="o">=</span> <span class="n">IO_IN_IT_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bCSourceID</span> <span class="o">=</span> <span class="n">USB_IN_CLK_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmControls</span> <span class="o">=</span> <span class="p">(</span><span class="n">CONTROL_RDWR</span> <span class="o">&lt;&lt;</span> <span class="n">COPY_CTRL</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Ouput Terminal for I/O-Out */</span>
<span class="k">struct</span> <span class="n">uac2_output_terminal_descriptor</span> <span class="n">io_out_ot_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">io_out_ot_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bDescriptorSubtype</span> <span class="o">=</span> <span class="n">UAC_OUTPUT_TERMINAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bTerminalID</span> <span class="o">=</span> <span class="n">IO_OUT_OT_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wTerminalType</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">UAC_OUTPUT_TERMINAL_UNDEFINED</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bAssocTerminal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bSourceID</span> <span class="o">=</span> <span class="n">USB_OUT_IT_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bCSourceID</span> <span class="o">=</span> <span class="n">USB_OUT_CLK_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmControls</span> <span class="o">=</span> <span class="p">(</span><span class="n">CONTROL_RDWR</span> <span class="o">&lt;&lt;</span> <span class="n">COPY_CTRL</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">uac2_ac_header_descriptor</span> <span class="n">ac_hdr_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">ac_hdr_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bDescriptorSubtype</span> <span class="o">=</span> <span class="n">UAC_MS_HEADER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bcdADC</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x200</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bCategory</span> <span class="o">=</span> <span class="n">UAC2_FUNCTION_IO_BOX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wTotalLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">in_clk_src_desc</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="n">out_clk_src_desc</span>
			 <span class="o">+</span> <span class="k">sizeof</span> <span class="n">usb_out_it_desc</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="n">io_in_it_desc</span>
			<span class="o">+</span> <span class="k">sizeof</span> <span class="n">usb_in_ot_desc</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="n">io_out_ot_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmControls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Audio Streaming OUT Interface - Alt0 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_interface_descriptor</span> <span class="n">std_as_out_if0_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">std_as_out_if0_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_INTERFACE</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bAlternateSetting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bNumEndpoints</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceClass</span> <span class="o">=</span> <span class="n">USB_CLASS_AUDIO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceSubClass</span> <span class="o">=</span> <span class="n">USB_SUBCLASS_AUDIOSTREAMING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceProtocol</span> <span class="o">=</span> <span class="n">UAC_VERSION_2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Audio Streaming OUT Interface - Alt1 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_interface_descriptor</span> <span class="n">std_as_out_if1_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">std_as_out_if1_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_INTERFACE</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bAlternateSetting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bNumEndpoints</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceClass</span> <span class="o">=</span> <span class="n">USB_CLASS_AUDIO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceSubClass</span> <span class="o">=</span> <span class="n">USB_SUBCLASS_AUDIOSTREAMING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceProtocol</span> <span class="o">=</span> <span class="n">UAC_VERSION_2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Audio Stream OUT Intface Desc */</span>
<span class="k">struct</span> <span class="n">uac2_as_header_descriptor</span> <span class="n">as_out_hdr_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">as_out_hdr_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bDescriptorSubtype</span> <span class="o">=</span> <span class="n">UAC_AS_GENERAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bTerminalLink</span> <span class="o">=</span> <span class="n">USB_OUT_IT_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmControls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bFormatType</span> <span class="o">=</span> <span class="n">UAC_FORMAT_TYPE_I</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmFormats</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">UAC_FORMAT_TYPE_I_PCM</span><span class="p">),</span>
	<span class="p">.</span><span class="n">iChannelNames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Audio USB_OUT Format */</span>
<span class="k">struct</span> <span class="n">uac2_format_type_i_descriptor</span> <span class="n">as_out_fmt1_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">as_out_fmt1_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorSubtype</span> <span class="o">=</span> <span class="n">UAC_FORMAT_TYPE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bFormatType</span> <span class="o">=</span> <span class="n">UAC_FORMAT_TYPE_I</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* STD AS ISO OUT Endpoint */</span>
<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">fs_epout_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">USB_DIR_OUT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span> <span class="o">|</span> <span class="n">USB_ENDPOINT_SYNC_ASYNC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">hs_epout_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span> <span class="o">|</span> <span class="n">USB_ENDPOINT_SYNC_ASYNC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterval</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* CS AS ISO OUT Endpoint */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">uac2_iso_endpoint_descriptor</span> <span class="n">as_iso_out_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">as_iso_out_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_CS_ENDPOINT</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bDescriptorSubtype</span> <span class="o">=</span> <span class="n">UAC_EP_GENERAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmControls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bLockDelayUnits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wLockDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Audio Streaming IN Interface - Alt0 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_interface_descriptor</span> <span class="n">std_as_in_if0_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">std_as_in_if0_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_INTERFACE</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bAlternateSetting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bNumEndpoints</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceClass</span> <span class="o">=</span> <span class="n">USB_CLASS_AUDIO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceSubClass</span> <span class="o">=</span> <span class="n">USB_SUBCLASS_AUDIOSTREAMING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceProtocol</span> <span class="o">=</span> <span class="n">UAC_VERSION_2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Audio Streaming IN Interface - Alt1 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_interface_descriptor</span> <span class="n">std_as_in_if1_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">std_as_in_if1_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_INTERFACE</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bAlternateSetting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bNumEndpoints</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceClass</span> <span class="o">=</span> <span class="n">USB_CLASS_AUDIO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceSubClass</span> <span class="o">=</span> <span class="n">USB_SUBCLASS_AUDIOSTREAMING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterfaceProtocol</span> <span class="o">=</span> <span class="n">UAC_VERSION_2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Audio Stream IN Intface Desc */</span>
<span class="k">struct</span> <span class="n">uac2_as_header_descriptor</span> <span class="n">as_in_hdr_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">as_in_hdr_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bDescriptorSubtype</span> <span class="o">=</span> <span class="n">UAC_AS_GENERAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bTerminalLink</span> <span class="o">=</span> <span class="n">USB_IN_OT_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmControls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bFormatType</span> <span class="o">=</span> <span class="n">UAC_FORMAT_TYPE_I</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmFormats</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">UAC_FORMAT_TYPE_I_PCM</span><span class="p">),</span>
	<span class="p">.</span><span class="n">iChannelNames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Audio USB_IN Format */</span>
<span class="k">struct</span> <span class="n">uac2_format_type_i_descriptor</span> <span class="n">as_in_fmt1_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">as_in_fmt1_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorSubtype</span> <span class="o">=</span> <span class="n">UAC_FORMAT_TYPE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bFormatType</span> <span class="o">=</span> <span class="n">UAC_FORMAT_TYPE_I</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* STD AS ISO IN Endpoint */</span>
<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">fs_epin_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span> <span class="o">|</span> <span class="n">USB_ENDPOINT_SYNC_ASYNC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">hs_epin_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span> <span class="o">|</span> <span class="n">USB_ENDPOINT_SYNC_ASYNC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bInterval</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* CS AS ISO IN Endpoint */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">uac2_iso_endpoint_descriptor</span> <span class="n">as_iso_in_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">as_iso_in_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_CS_ENDPOINT</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bDescriptorSubtype</span> <span class="o">=</span> <span class="n">UAC_EP_GENERAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmControls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bLockDelayUnits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wLockDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="n">fs_audio_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">iad_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std_ac_if_desc</span><span class="p">,</span>

	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ac_hdr_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">in_clk_src_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">out_clk_src_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">usb_out_it_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">io_in_it_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">usb_in_ot_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">io_out_ot_desc</span><span class="p">,</span>

	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std_as_out_if0_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std_as_out_if1_desc</span><span class="p">,</span>

	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">as_out_hdr_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">as_out_fmt1_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fs_epout_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">as_iso_out_desc</span><span class="p">,</span>

	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std_as_in_if0_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std_as_in_if1_desc</span><span class="p">,</span>

	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">as_in_hdr_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">as_in_fmt1_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fs_epin_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">as_iso_in_desc</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="n">hs_audio_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">iad_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std_ac_if_desc</span><span class="p">,</span>

	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ac_hdr_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">in_clk_src_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">out_clk_src_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">usb_out_it_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">io_in_it_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">usb_in_ot_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">io_out_ot_desc</span><span class="p">,</span>

	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std_as_out_if0_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std_as_out_if1_desc</span><span class="p">,</span>

	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">as_out_hdr_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">as_out_fmt1_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hs_epout_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">as_iso_out_desc</span><span class="p">,</span>

	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std_as_in_if0_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std_as_in_if1_desc</span><span class="p">,</span>

	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">as_in_hdr_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">as_in_fmt1_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hs_epin_desc</span><span class="p">,</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">as_iso_in_desc</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cntrl_cur_lay3</span> <span class="p">{</span>
	<span class="n">__u32</span>	<span class="n">dCUR</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cntrl_range_lay3</span> <span class="p">{</span>
	<span class="n">__u16</span>	<span class="n">wNumSubRanges</span><span class="p">;</span>
	<span class="n">__u32</span>	<span class="n">dMIN</span><span class="p">;</span>
	<span class="n">__u32</span>	<span class="n">dMAX</span><span class="p">;</span>
	<span class="n">__u32</span>	<span class="n">dRES</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">free_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">uac2_rtd_params</span> <span class="o">*</span><span class="n">prm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="n">prm_to_uac2</span><span class="p">(</span><span class="n">prm</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">ep_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">USB_XFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">ureq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usb_ep_dequeue</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">ureq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req</span><span class="p">);</span>
			<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">ureq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req</span><span class="p">);</span>
			<span class="n">prm</span><span class="o">-&gt;</span><span class="n">ureq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_ep_disable</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s:%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">afunc_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">fn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_dev</span> <span class="o">*</span><span class="n">agdev</span> <span class="o">=</span> <span class="n">func_to_agdev</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">uac2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uac2_rtd_params</span> <span class="o">*</span><span class="n">prm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_interface_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s:%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">std_ac_if_desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ALT_SET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">ac_alt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">INTF_SET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">ac_alt</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_interface_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s:%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">std_as_out_if0_desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">std_as_out_if1_desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ALT_SET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">as_out_alt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">INTF_SET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">as_out_alt</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_interface_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s:%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">std_as_in_if0_desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">std_as_in_if1_desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ALT_SET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">as_in_alt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">INTF_SET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">as_in_alt</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">agdev</span><span class="o">-&gt;</span><span class="n">out_ep</span> <span class="o">=</span> <span class="n">usb_ep_autoconfig</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fs_epout_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">out_ep</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s:%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">agdev</span><span class="o">-&gt;</span><span class="n">out_ep</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">agdev</span><span class="p">;</span>

	<span class="n">agdev</span><span class="o">-&gt;</span><span class="n">in_ep</span> <span class="o">=</span> <span class="n">usb_ep_autoconfig</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fs_epin_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">in_ep</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s:%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">agdev</span><span class="o">-&gt;</span><span class="n">in_ep</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">agdev</span><span class="p">;</span>

	<span class="n">hs_epout_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">fs_epout_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">;</span>
	<span class="n">hs_epout_desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span> <span class="n">fs_epout_desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">;</span>
	<span class="n">hs_epin_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">fs_epin_desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">;</span>
	<span class="n">hs_epin_desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span> <span class="n">fs_epin_desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">;</span>

	<span class="n">fn</span><span class="o">-&gt;</span><span class="n">descriptors</span> <span class="o">=</span> <span class="n">usb_copy_descriptors</span><span class="p">(</span><span class="n">fs_audio_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gadget_is_dualspeed</span><span class="p">(</span><span class="n">gadget</span><span class="p">))</span>
		<span class="n">fn</span><span class="o">-&gt;</span><span class="n">hs_descriptors</span> <span class="o">=</span> <span class="n">usb_copy_descriptors</span><span class="p">(</span><span class="n">hs_audio_desc</span><span class="p">);</span>

	<span class="n">prm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">uac2</span><span class="p">.</span><span class="n">c_prm</span><span class="p">;</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">max_psize</span> <span class="o">=</span> <span class="n">hs_epout_desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">;</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">rbuf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">max_psize</span> <span class="o">*</span> <span class="n">USB_XFERS</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prm</span><span class="o">-&gt;</span><span class="n">max_psize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s:%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">prm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">uac2</span><span class="p">.</span><span class="n">p_prm</span><span class="p">;</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">max_psize</span> <span class="o">=</span> <span class="n">hs_epin_desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">;</span>
	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">rbuf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">max_psize</span> <span class="o">*</span> <span class="n">USB_XFERS</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prm</span><span class="o">-&gt;</span><span class="n">max_psize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s:%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">alsa_uac2_init</span><span class="p">(</span><span class="n">agdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">afunc_unbind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">fn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_dev</span> <span class="o">*</span><span class="n">agdev</span> <span class="o">=</span> <span class="n">func_to_agdev</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uac2_rtd_params</span> <span class="o">*</span><span class="n">prm</span><span class="p">;</span>

	<span class="n">alsa_uac2_exit</span><span class="p">(</span><span class="n">agdev</span><span class="p">);</span>

	<span class="n">prm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">uac2</span><span class="p">.</span><span class="n">p_prm</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">);</span>

	<span class="n">prm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">uac2</span><span class="p">.</span><span class="n">c_prm</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gadget_is_dualspeed</span><span class="p">(</span><span class="n">gadget</span><span class="p">))</span>
		<span class="n">usb_free_descriptors</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">hs_descriptors</span><span class="p">);</span>
	<span class="n">usb_free_descriptors</span><span class="p">(</span><span class="n">fn</span><span class="o">-&gt;</span><span class="n">descriptors</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">in_ep</span><span class="p">)</span>
		<span class="n">agdev</span><span class="o">-&gt;</span><span class="n">in_ep</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">out_ep</span><span class="p">)</span>
		<span class="n">agdev</span><span class="o">-&gt;</span><span class="n">out_ep</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">afunc_set_alt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">intf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">alt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audio_dev</span> <span class="o">*</span><span class="n">agdev</span> <span class="o">=</span> <span class="n">func_to_agdev</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">uac2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uac2_rtd_params</span> <span class="o">*</span><span class="n">prm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* No i/f has more than 2 alt settings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s:%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intf</span> <span class="o">==</span> <span class="n">INTF_GET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">ac_alt</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Control I/f has only 1 AltSetting - 0 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s:%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intf</span> <span class="o">==</span> <span class="n">INTF_GET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">as_out_alt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">agdev</span><span class="o">-&gt;</span><span class="n">out_ep</span><span class="p">;</span>
		<span class="n">prm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">c_prm</span><span class="p">;</span>
		<span class="n">config_ep_by_speed</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="n">ALT_SET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">as_out_alt</span><span class="p">,</span> <span class="n">alt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intf</span> <span class="o">==</span> <span class="n">INTF_GET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">as_in_alt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">agdev</span><span class="o">-&gt;</span><span class="n">in_ep</span><span class="p">;</span>
		<span class="n">prm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">p_prm</span><span class="p">;</span>
		<span class="n">config_ep_by_speed</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="n">ALT_SET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">as_in_alt</span><span class="p">,</span> <span class="n">alt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s:%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_ep</span><span class="p">(</span><span class="n">prm</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prm</span><span class="o">-&gt;</span><span class="n">ep_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">usb_ep_enable</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">USB_XFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">ureq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">ureq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">req</span> <span class="o">=</span> <span class="n">usb_ep_alloc_request</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s:%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">prm</span><span class="o">-&gt;</span><span class="n">ureq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
		<span class="n">prm</span><span class="o">-&gt;</span><span class="n">ureq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pp</span> <span class="o">=</span> <span class="n">prm</span><span class="p">;</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">prm</span><span class="o">-&gt;</span><span class="n">ureq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">max_psize</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span>	<span class="n">agdev_iso_complete</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">prm</span><span class="o">-&gt;</span><span class="n">rbuf</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">afunc_get_alt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_dev</span> <span class="o">*</span><span class="n">agdev</span> <span class="o">=</span> <span class="n">func_to_agdev</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">uac2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intf</span> <span class="o">==</span> <span class="n">INTF_GET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">ac_alt</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ALT_GET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">ac_alt</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intf</span> <span class="o">==</span> <span class="n">INTF_GET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">as_out_alt</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ALT_GET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">as_out_alt</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intf</span> <span class="o">==</span> <span class="n">INTF_GET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">as_in_alt</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ALT_GET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">as_in_alt</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s:%d Invalid Interface %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">intf</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">afunc_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">fn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_dev</span> <span class="o">*</span><span class="n">agdev</span> <span class="o">=</span> <span class="n">func_to_agdev</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">uac2</span><span class="p">;</span>

	<span class="n">free_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">p_prm</span><span class="p">,</span> <span class="n">agdev</span><span class="o">-&gt;</span><span class="n">in_ep</span><span class="p">);</span>
	<span class="n">ALT_SET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">as_in_alt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">free_ep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">c_prm</span><span class="p">,</span> <span class="n">agdev</span><span class="o">-&gt;</span><span class="n">out_ep</span><span class="p">);</span>
	<span class="n">ALT_SET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">as_out_alt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">in_rq_cur</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">cr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audio_dev</span> <span class="o">*</span><span class="n">agdev</span> <span class="o">=</span> <span class="n">func_to_agdev</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">uac2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">w_length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cr</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">w_index</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cr</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">w_value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cr</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">entity_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_index</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">control_selector</span> <span class="o">=</span> <span class="n">w_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">control_selector</span> <span class="o">==</span> <span class="n">UAC2_CS_CONTROL_SAM_FREQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cntrl_cur_lay3</span> <span class="n">c</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">entity_id</span> <span class="o">==</span> <span class="n">USB_IN_CLK_ID</span><span class="p">)</span>
			<span class="n">c</span><span class="p">.</span><span class="n">dCUR</span> <span class="o">=</span> <span class="n">p_srate</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">entity_id</span> <span class="o">==</span> <span class="n">USB_OUT_CLK_ID</span><span class="p">)</span>
			<span class="n">c</span><span class="p">.</span><span class="n">dCUR</span> <span class="o">=</span> <span class="n">c_srate</span><span class="p">;</span>

		<span class="n">value</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="n">w_length</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">c</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">control_selector</span> <span class="o">==</span> <span class="n">UAC2_CS_CONTROL_CLOCK_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="n">w_length</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s:%d control_selector=%d TODO!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">control_selector</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">in_rq_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">cr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audio_dev</span> <span class="o">*</span><span class="n">agdev</span> <span class="o">=</span> <span class="n">func_to_agdev</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">uac2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">w_length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cr</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">w_index</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cr</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">w_value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cr</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">entity_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_index</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">control_selector</span> <span class="o">=</span> <span class="n">w_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cntrl_range_lay3</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">control_selector</span> <span class="o">==</span> <span class="n">UAC2_CS_CONTROL_SAM_FREQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entity_id</span> <span class="o">==</span> <span class="n">USB_IN_CLK_ID</span><span class="p">)</span>
			<span class="n">r</span><span class="p">.</span><span class="n">dMIN</span> <span class="o">=</span> <span class="n">p_srate</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">entity_id</span> <span class="o">==</span> <span class="n">USB_OUT_CLK_ID</span><span class="p">)</span>
			<span class="n">r</span><span class="p">.</span><span class="n">dMIN</span> <span class="o">=</span> <span class="n">c_srate</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

		<span class="n">r</span><span class="p">.</span><span class="n">dMAX</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">dMIN</span><span class="p">;</span>
		<span class="n">r</span><span class="p">.</span><span class="n">dRES</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">r</span><span class="p">.</span><span class="n">wNumSubRanges</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">value</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="n">w_length</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">r</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s:%d control_selector=%d TODO!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">control_selector</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ac_rq_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">cr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cr</span><span class="o">-&gt;</span><span class="n">bRequest</span> <span class="o">==</span> <span class="n">UAC2_CS_CUR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">in_rq_cur</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">cr</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cr</span><span class="o">-&gt;</span><span class="n">bRequest</span> <span class="o">==</span> <span class="n">UAC2_CS_RANGE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">in_rq_range</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">cr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">out_rq_cur</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">cr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">w_length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cr</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">w_value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cr</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">control_selector</span> <span class="o">=</span> <span class="n">w_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">control_selector</span> <span class="o">==</span> <span class="n">UAC2_CS_CONTROL_SAM_FREQ</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">w_length</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">setup_rq_inf</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">cr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_dev</span> <span class="o">*</span><span class="n">agdev</span> <span class="o">=</span> <span class="n">func_to_agdev</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">uac2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">w_index</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cr</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">intf</span> <span class="o">=</span> <span class="n">w_index</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intf</span> <span class="o">!=</span> <span class="n">INTF_GET</span><span class="p">(</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">ac_alt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s:%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cr</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ac_rq_in</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">cr</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cr</span><span class="o">-&gt;</span><span class="n">bRequest</span> <span class="o">==</span> <span class="n">UAC2_CS_CUR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">out_rq_cur</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">cr</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">afunc_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_function</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">cr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">fn</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audio_dev</span> <span class="o">*</span><span class="n">agdev</span> <span class="o">=</span> <span class="n">func_to_agdev</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_uac2_chip</span> <span class="o">*</span><span class="n">uac2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">agdev</span><span class="o">-&gt;</span><span class="n">uac2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">w_length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cr</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="cm">/* Only Class specific requests are supposed to reach here */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cr</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_TYPE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">USB_TYPE_CLASS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cr</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_RECIP_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">setup_rq_inf</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">cr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">zero</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">w_length</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uac2</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s:%d Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">audio_bind_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">agdev_g</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">agdev_g</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">agdev_g</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unable to allocate audio gadget</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">usb_string_id</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">strings_fn</span><span class="p">[</span><span class="n">STR_ASSOC</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">iad_desc</span><span class="p">.</span><span class="n">iFunction</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">usb_string_id</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">strings_fn</span><span class="p">[</span><span class="n">STR_IF_CTRL</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">std_ac_if_desc</span><span class="p">.</span><span class="n">iInterface</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">usb_string_id</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">strings_fn</span><span class="p">[</span><span class="n">STR_CLKSRC_IN</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">in_clk_src_desc</span><span class="p">.</span><span class="n">iClockSource</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">usb_string_id</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">strings_fn</span><span class="p">[</span><span class="n">STR_CLKSRC_OUT</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">out_clk_src_desc</span><span class="p">.</span><span class="n">iClockSource</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">usb_string_id</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">strings_fn</span><span class="p">[</span><span class="n">STR_USB_IT</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">usb_out_it_desc</span><span class="p">.</span><span class="n">iTerminal</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">usb_string_id</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">strings_fn</span><span class="p">[</span><span class="n">STR_IO_IT</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">io_in_it_desc</span><span class="p">.</span><span class="n">iTerminal</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">usb_string_id</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">strings_fn</span><span class="p">[</span><span class="n">STR_USB_OT</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">usb_in_ot_desc</span><span class="p">.</span><span class="n">iTerminal</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">usb_string_id</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">strings_fn</span><span class="p">[</span><span class="n">STR_IO_OT</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">io_out_ot_desc</span><span class="p">.</span><span class="n">iTerminal</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">usb_string_id</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">strings_fn</span><span class="p">[</span><span class="n">STR_AS_OUT_ALT0</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">std_as_out_if0_desc</span><span class="p">.</span><span class="n">iInterface</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">usb_string_id</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">strings_fn</span><span class="p">[</span><span class="n">STR_AS_OUT_ALT1</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">std_as_out_if1_desc</span><span class="p">.</span><span class="n">iInterface</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">usb_string_id</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">strings_fn</span><span class="p">[</span><span class="n">STR_AS_IN_ALT0</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">std_as_in_if0_desc</span><span class="p">.</span><span class="n">iInterface</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">usb_string_id</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">strings_fn</span><span class="p">[</span><span class="n">STR_AS_IN_ALT1</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">std_as_in_if1_desc</span><span class="p">.</span><span class="n">iInterface</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">agdev_g</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;uac2_func&quot;</span><span class="p">;</span>
	<span class="n">agdev_g</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">strings</span> <span class="o">=</span> <span class="n">fn_strings</span><span class="p">;</span>
	<span class="n">agdev_g</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">afunc_bind</span><span class="p">;</span>
	<span class="n">agdev_g</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">unbind</span> <span class="o">=</span> <span class="n">afunc_unbind</span><span class="p">;</span>
	<span class="n">agdev_g</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">set_alt</span> <span class="o">=</span> <span class="n">afunc_set_alt</span><span class="p">;</span>
	<span class="n">agdev_g</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">get_alt</span> <span class="o">=</span> <span class="n">afunc_get_alt</span><span class="p">;</span>
	<span class="n">agdev_g</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">disable</span> <span class="o">=</span> <span class="n">afunc_disable</span><span class="p">;</span>
	<span class="n">agdev_g</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">afunc_setup</span><span class="p">;</span>

	<span class="cm">/* Initialize the configurable parameters */</span>
	<span class="n">usb_out_it_desc</span><span class="p">.</span><span class="n">bNrChannels</span> <span class="o">=</span> <span class="n">num_channels</span><span class="p">(</span><span class="n">c_chmask</span><span class="p">);</span>
	<span class="n">usb_out_it_desc</span><span class="p">.</span><span class="n">bmChannelConfig</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c_chmask</span><span class="p">);</span>
	<span class="n">io_in_it_desc</span><span class="p">.</span><span class="n">bNrChannels</span> <span class="o">=</span> <span class="n">num_channels</span><span class="p">(</span><span class="n">p_chmask</span><span class="p">);</span>
	<span class="n">io_in_it_desc</span><span class="p">.</span><span class="n">bmChannelConfig</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">p_chmask</span><span class="p">);</span>
	<span class="n">as_out_hdr_desc</span><span class="p">.</span><span class="n">bNrChannels</span> <span class="o">=</span> <span class="n">num_channels</span><span class="p">(</span><span class="n">c_chmask</span><span class="p">);</span>
	<span class="n">as_out_hdr_desc</span><span class="p">.</span><span class="n">bmChannelConfig</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c_chmask</span><span class="p">);</span>
	<span class="n">as_in_hdr_desc</span><span class="p">.</span><span class="n">bNrChannels</span> <span class="o">=</span> <span class="n">num_channels</span><span class="p">(</span><span class="n">p_chmask</span><span class="p">);</span>
	<span class="n">as_in_hdr_desc</span><span class="p">.</span><span class="n">bmChannelConfig</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">p_chmask</span><span class="p">);</span>
	<span class="n">as_out_fmt1_desc</span><span class="p">.</span><span class="n">bSubslotSize</span> <span class="o">=</span> <span class="n">c_ssize</span><span class="p">;</span>
	<span class="n">as_out_fmt1_desc</span><span class="p">.</span><span class="n">bBitResolution</span> <span class="o">=</span> <span class="n">c_ssize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">as_in_fmt1_desc</span><span class="p">.</span><span class="n">bSubslotSize</span> <span class="o">=</span> <span class="n">p_ssize</span><span class="p">;</span>
	<span class="n">as_in_fmt1_desc</span><span class="p">.</span><span class="n">bBitResolution</span> <span class="o">=</span> <span class="n">p_ssize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">clksrc_in</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clksrc_in</span><span class="p">),</span> <span class="s">&quot;%uHz&quot;</span><span class="p">,</span> <span class="n">p_srate</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">clksrc_out</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clksrc_out</span><span class="p">),</span> <span class="s">&quot;%uHz&quot;</span><span class="p">,</span> <span class="n">c_srate</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">usb_add_function</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">agdev_g</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">agdev_g</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">uac2_unbind_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">agdev_g</span><span class="p">);</span>
	<span class="n">agdev_g</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
