<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › gadget › at91_udc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>at91_udc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * at91_udc -- driver for at91-series USB peripheral controller</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004 by Thomas Rathbone</span>
<span class="cm"> * Copyright (C) 2005 by HP Labs</span>
<span class="cm"> * Copyright (C) 2005 by David Brownell</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#undef	VERBOSE_DEBUG</span>
<span class="cp">#undef	PACKET_TRACE</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_gpio.h&gt;</span>

<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/gpio.h&gt;</span>

<span class="cp">#include &lt;mach/board.h&gt;</span>
<span class="cp">#include &lt;mach/cpu.h&gt;</span>
<span class="cp">#include &lt;mach/at91sam9261_matrix.h&gt;</span>
<span class="cp">#include &lt;mach/at91_matrix.h&gt;</span>

<span class="cp">#include &quot;at91_udc.h&quot;</span>


<span class="cm">/*</span>
<span class="cm"> * This controller is simple and PIO-only.  It&#39;s used in many AT91-series</span>
<span class="cm"> * full speed USB controllers, including the at91rm9200 (arm920T, with MMU),</span>
<span class="cm"> * at91sam926x (arm926ejs, with MMU), and several no-mmu versions.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver expects the board has been wired with two GPIOs suppporting</span>
<span class="cm"> * a VBUS sensing IRQ, and a D+ pullup.  (They may be omitted, but the</span>
<span class="cm"> * testing hasn&#39;t covered such cases.)</span>
<span class="cm"> *</span>
<span class="cm"> * The pullup is most important (so it&#39;s integrated on sam926x parts).  It</span>
<span class="cm"> * provides software control over whether the host enumerates the device.</span>
<span class="cm"> *</span>
<span class="cm"> * The VBUS sensing helps during enumeration, and allows both USB clocks</span>
<span class="cm"> * (and the transceiver) to stay gated off until they&#39;re necessary, saving</span>
<span class="cm"> * power.  During USB suspend, the 48 MHz clock is gated off in hardware;</span>
<span class="cm"> * it may also be gated off by software during some Linux sleep states.</span>
<span class="cm"> */</span>

<span class="cp">#define	DRIVER_VERSION	&quot;3 May 2006&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_name</span> <span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;at91_udc&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ep0name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;ep0&quot;</span><span class="p">;</span>

<span class="cp">#define VBUS_POLL_TIMEOUT	msecs_to_jiffies(1000)</span>

<span class="cp">#define at91_udp_read(udc, reg) \</span>
<span class="cp">	__raw_readl((udc)-&gt;udp_baseaddr + (reg))</span>
<span class="cp">#define at91_udp_write(udc, reg, val) \</span>
<span class="cp">	__raw_writel((val), (udc)-&gt;udp_baseaddr + (reg))</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#ifdef CONFIG_USB_GADGET_DEBUG_FILES</span>

<span class="cp">#include &lt;linux/seq_file.h&gt;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">debug_filename</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;driver/udc&quot;</span><span class="p">;</span>

<span class="cp">#define FOURBITS &quot;%s%s%s%s&quot;</span>
<span class="cp">#define EIGHTBITS FOURBITS FOURBITS</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">proc_ep_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">types</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;out-iso&quot;</span><span class="p">,</span> <span class="s">&quot;out-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;out-int&quot;</span><span class="p">,</span>
		<span class="s">&quot;BOGUS&quot;</span><span class="p">,</span>   <span class="s">&quot;in-iso&quot;</span><span class="p">,</span>  <span class="s">&quot;in-bulk&quot;</span><span class="p">,</span>  <span class="s">&quot;in-int&quot;</span><span class="p">};</span>

	<span class="n">u32</span>			<span class="n">csr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at91_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at91_udc</span>	<span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">csr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span><span class="p">);</span>

	<span class="cm">/* NOTE:  not collecting per-endpoint irq statistics... */</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s, maxpacket %d %s%s %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_iso</span> <span class="o">?</span> <span class="s">&quot; iso&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_pingpong</span>
				<span class="o">?</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_bank</span> <span class="o">?</span> <span class="s">&quot;pong&quot;</span> <span class="o">:</span> <span class="s">&quot;ping&quot;</span><span class="p">)</span>
				<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">?</span> <span class="s">&quot; stopped&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;csr %08x rxbytes=%d %s %s %s&quot;</span> <span class="n">EIGHTBITS</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csr</span><span class="p">,</span>
		<span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="mh">0x07ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;DATA1&quot;</span> <span class="o">:</span> <span class="s">&quot;DATA0&quot;</span><span class="p">,</span>
		<span class="n">types</span><span class="p">[(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="mh">0x700</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">],</span>

		<span class="cm">/* iff type is control then print current direction */</span>
		<span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="mh">0x700</span><span class="p">))</span>
			<span class="o">?</span> <span class="p">((</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; IN&quot;</span> <span class="o">:</span> <span class="s">&quot; OUT&quot;</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; rxdatabk1&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; forcestall&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; txpktrdy&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>

		<span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; stallsent&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; rxsetup&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; rxdatabk0&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; txcomp&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">(queue empty)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">else</span> <span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span>	<span class="n">length</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">req %p len %d/%d buf %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">proc_irq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s %04x:%s%s&quot;</span> <span class="n">FOURBITS</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; wakeup&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; endbusres&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>

		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; sofint&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; extrsm&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; rxrsm&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; rxsusp&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; ep%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_udc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_udc</span>	<span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at91_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">tmp</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s: version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">DRIVER_VERSION</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;vbus %s, pullup %s, %s powered%s, gadget %s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus</span> <span class="o">?</span> <span class="s">&quot;present&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">enabled</span>
			<span class="o">?</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus</span> <span class="o">?</span> <span class="s">&quot;active&quot;</span> <span class="o">:</span> <span class="s">&quot;enabled&quot;</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">selfpowered</span> <span class="o">?</span> <span class="s">&quot;self&quot;</span> <span class="o">:</span> <span class="s">&quot;VBUS&quot;</span><span class="p">,</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">?</span> <span class="s">&quot;, suspended&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">?</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;(none)&quot;</span><span class="p">);</span>

	<span class="cm">/* don&#39;t access registers when interface isn&#39;t clocked */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">clocked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;(not clocked)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">at91_udp_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_FRM_NUM</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;frame %05x:%s%s frame=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_FRM_OK</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ok&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_FRM_ERR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; err&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_NUM</span><span class="p">));</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">at91_udp_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_GLB_STAT</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;glbstate %02x:%s&quot;</span> <span class="n">FOURBITS</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_RMWUPE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; rmwupe&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_RSMINPR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; rsminpr&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_ESR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; esr&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_CONFG</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; confg&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_FADDEN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; fadden&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">at91_udp_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_FADDR</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;faddr   %03x:%s fadd=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_FEN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; fen&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_FADD</span><span class="p">));</span>

	<span class="n">proc_irq_show</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;imr   &quot;</span><span class="p">,</span> <span class="n">at91_udp_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_IMR</span><span class="p">));</span>
	<span class="n">proc_irq_show</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;isr   &quot;</span><span class="p">,</span> <span class="n">at91_udp_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_ISR</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">proc_ep_show</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span>
				<span class="n">proc_ep_show</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_udc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">proc_udc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">proc_udc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">create_debug_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">pde</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="n">debug_filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_ops</span><span class="p">,</span> <span class="n">udc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_debug_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">pde</span><span class="p">)</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">debug_filename</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">create_debug_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span> <span class="p">{}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">remove_debug_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span> <span class="p">{}</span>

<span class="cp">#endif</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">done</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>	<span class="n">stopped</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at91_udc</span>	<span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;%s done %p, status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="n">stopped</span><span class="p">;</span>

	<span class="cm">/* ep0 is always ready; other endpoints need a non-empty queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">int_mask</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_IDR</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">int_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* bits indicating OUT fifo has data ready */</span>
<span class="cp">#define	RX_DATA_READY	(AT91_UDP_RX_DATA_BK0 | AT91_UDP_RX_DATA_BK1)</span>

<span class="cm">/*</span>
<span class="cm"> * Endpoint FIFO CSR bits have a mix of bits, making it unsafe to just write</span>
<span class="cm"> * back most of the value you just read (because of side effects, including</span>
<span class="cm"> * bits that may change after reading and before writing).</span>
<span class="cm"> *</span>
<span class="cm"> * Except when changing a specific bit, always write values which:</span>
<span class="cm"> *  - clear SET_FX bits (setting them could change something)</span>
<span class="cm"> *  - set CLR_FX bits (clearing them could change something)</span>
<span class="cm"> *</span>
<span class="cm"> * There are also state bits like FORCESTALL, EPEDS, DIR, and EPTYPE</span>
<span class="cm"> * that shouldn&#39;t normally be changed.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE at91sam9260 docs mention synch between UDPCK and MCK clock domains,</span>
<span class="cm"> * implying a need to wait for one write to complete (test relevant bits)</span>
<span class="cm"> * before starting the next write.  This shouldn&#39;t be an issue given how</span>
<span class="cm"> * infrequently we write, except maybe for write-then-read idioms.</span>
<span class="cm"> */</span>
<span class="cp">#define	SET_FX	(AT91_UDP_TXPKTRDY)</span>
<span class="cp">#define	CLR_FX	(RX_DATA_READY | AT91_UDP_RXSETUP \</span>
<span class="cp">		| AT91_UDP_STALLSENT | AT91_UDP_TXCOMP)</span>

<span class="cm">/* pull OUT packet data from the endpoint&#39;s fifo */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_fifo</span> <span class="p">(</span><span class="k">struct</span> <span class="n">at91_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">creg</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">dreg</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span> <span class="o">+</span> <span class="p">(</span><span class="n">AT91_UDP_FDR</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">AT91_UDP_CSR</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">u32</span>		<span class="n">csr</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">count</span><span class="p">,</span> <span class="n">bufferspace</span><span class="p">,</span> <span class="n">is_done</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">bufferspace</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * there might be nothing to read if ep_queue() calls us,</span>
<span class="cm">	 * or if we already emptied both pingpong buffers</span>
<span class="cm">	 */</span>
<span class="nl">rescan:</span>
	<span class="n">csr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">creg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">RX_DATA_READY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_RXBYTECNT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">bufferspace</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s buffer overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">bufferspace</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__raw_readsb</span><span class="p">(</span><span class="n">dreg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="cm">/* release and swap pingpong mem bank */</span>
	<span class="n">csr</span> <span class="o">|=</span> <span class="n">CLR_FX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_pingpong</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_bank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SET_FX</span> <span class="o">|</span> <span class="n">AT91_UDP_RX_DATA_BK0</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_bank</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SET_FX</span> <span class="o">|</span> <span class="n">AT91_UDP_RX_DATA_BK1</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SET_FX</span> <span class="o">|</span> <span class="n">AT91_UDP_RX_DATA_BK0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">is_done</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">bufferspace</span><span class="p">)</span>
		<span class="n">is_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">PACKET</span><span class="p">(</span><span class="s">&quot;%s %p out/%d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
			<span class="n">is_done</span> <span class="o">?</span> <span class="s">&quot; (done)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * avoid extra trips through IRQ logic for packets already in</span>
<span class="cm">	 * the fifo ... maybe preventing an extra (expensive) OUT-NAK</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_done</span><span class="p">)</span>
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_pingpong</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * One dummy read to delay the code because of a HW glitch:</span>
<span class="cm">		 * CSR returns bad RXCOUNT when read too soon after updating</span>
<span class="cm">		 * RX_DATA_BK flags.</span>
<span class="cm">		 */</span>
		<span class="n">csr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">creg</span><span class="p">);</span>

		<span class="n">bufferspace</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rescan</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">is_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* load fifo for an IN packet */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">creg</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">csr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">creg</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">dreg</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span> <span class="o">+</span> <span class="p">(</span><span class="n">AT91_UDP_FDR</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">AT91_UDP_CSR</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="kt">unsigned</span>	<span class="n">total</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">is_last</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO: allow for writing two packets to the fifo ... that&#39;ll</span>
<span class="cm">	 * reduce the amount of IN-NAKing, but probably won&#39;t affect</span>
<span class="cm">	 * throughput much.  (Unlike preventing OUT-NAKing!)</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * If ep_queue() calls us, the queue is empty and possibly in</span>
<span class="cm">	 * odd states like TXCOMP not yet cleared (we do it, saving at</span>
<span class="cm">	 * least one IRQ) or the fifo not yet being free.  Those aren&#39;t</span>
<span class="cm">	 * issues normally (IRQ handler fast path).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AT91_UDP_TXCOMP</span> <span class="o">|</span> <span class="n">AT91_UDP_TXPKTRDY</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_TXCOMP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">csr</span> <span class="o">|=</span> <span class="n">CLR_FX</span><span class="p">;</span>
			<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SET_FX</span> <span class="o">|</span> <span class="n">AT91_UDP_TXCOMP</span><span class="p">);</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>
			<span class="n">csr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">creg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_TXPKTRDY</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">total</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">&lt;</span> <span class="n">total</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">;</span>
		<span class="n">is_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>
		<span class="n">is_last</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Write the packet, maybe it&#39;s a ZLP.</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE:  incrementing req-&gt;actual before we receive the ACK means</span>
<span class="cm">	 * gadget driver IN bytecounts can be wrong in fault cases.  That&#39;s</span>
<span class="cm">	 * fixable with PIO drivers like this one (save &quot;count&quot; here, and</span>
<span class="cm">	 * do the increment later on TX irq), but not for most DMA hardware.</span>
<span class="cm">	 *</span>
<span class="cm">	 * So all gadget drivers must accept that potential error.  Some</span>
<span class="cm">	 * hardware supports precise fifo status reporting, letting them</span>
<span class="cm">	 * recover when the actual bytecount matters (e.g. for USB Test</span>
<span class="cm">	 * and Measurement Class devices).</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writesb</span><span class="p">(</span><span class="n">dreg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SET_FX</span><span class="p">;</span>
	<span class="n">csr</span> <span class="o">|=</span> <span class="n">CLR_FX</span> <span class="o">|</span> <span class="n">AT91_UDP_TXPKTRDY</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">PACKET</span><span class="p">(</span><span class="s">&quot;%s %p in/%d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
			<span class="n">is_last</span> <span class="o">?</span> <span class="s">&quot; (done)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_last</span><span class="p">)</span>
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">is_last</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nuke</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="cm">/* terminate any request in the queue */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;%s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at91_ep_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">at91_udc</span>	<span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">maxpacket</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">ep</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">desc</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span>
			<span class="o">||</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span>
			<span class="o">||</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">!=</span> <span class="n">USB_DT_ENDPOINT</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="n">maxpacket</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;bad ep or descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;bogus device state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">usb_endpoint_type</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;only one control endpoint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">maxpacket</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bogus_max</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">maxpacket</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">case</span> <span class="mi">32</span>:
		<span class="k">case</span> <span class="mi">64</span>:
			<span class="k">goto</span> <span class="n">ok</span><span class="p">;</span>
		<span class="p">}</span>
<span class="nl">bogus_max:</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;bogus maxpacket %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">maxpacket</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_pingpong</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;iso requires double buffering</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">ok:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* initialize endpoint to match this descriptor */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">=</span> <span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_iso</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AT91_UDP_EPEDS</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">maxpacket</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * reset/init endpoint fifo.  NOTE:  leaves fifo_bank alone,</span>
<span class="cm">	 * since endpoint resets don&#39;t reset hw pingpong state.</span>
<span class="cm">	 */</span>
	<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_RST_EP</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">int_mask</span><span class="p">);</span>
	<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_RST_EP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at91_ep_disable</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span> <span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">at91_udc</span>	<span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">nuke</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>

	<span class="cm">/* restore the endpoint&#39;s pristine config */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>

	<span class="cm">/* reset fifos and endpoint */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">clocked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_RST_EP</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">int_mask</span><span class="p">);</span>
		<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_RST_EP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * this is a PIO-only driver, so there&#39;s nothing</span>
<span class="cm"> * interesting for request or buffer allocation.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span>
<span class="nf">at91_ep_alloc_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">at91_request</span><span class="p">),</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at91_ep_free_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at91_ep_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at91_ep</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at91_udc</span>		<span class="o">*</span><span class="n">udc</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_req</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="o">-&gt;</span><span class="n">complete</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;invalid request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">ep0name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;invalid ep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span> <span class="o">||</span> <span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;invalid device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">_req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">_req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* try to kickstart any empty and idle queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">is_ep0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If this control request has a non-empty DATA stage, this</span>
<span class="cm">		 * will start that stage.  It works just like a non-control</span>
<span class="cm">		 * request (until the status stage starts, maybe early).</span>
<span class="cm">		 *</span>
<span class="cm">		 * If the data stage is empty, then this starts a successful</span>
<span class="cm">		 * IN/STATUS stage.  (Unsuccessful ones use set_halt.)</span>
<span class="cm">		 */</span>
		<span class="n">is_ep0</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_ep0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">tmp</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">req_pending</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * defer changing CONFG until after the gadget driver</span>
<span class="cm">			 * reconfigures the endpoints.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">wait_for_config_ack</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">at91_udp_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_GLB_STAT</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">^=</span> <span class="n">AT91_UDP_CONFG</span><span class="p">;</span>
				<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;toggle config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_GLB_STAT</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">ep0_in_status:</span>
				<span class="n">PACKET</span><span class="p">(</span><span class="s">&quot;ep0 in/status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SET_FX</span><span class="p">;</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">CLR_FX</span> <span class="o">|</span> <span class="n">AT91_UDP_TXPKTRDY</span><span class="p">;</span>
				<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span><span class="p">);</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">req_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">write_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">read_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

			<span class="cm">/* IN/STATUS stage is otherwise triggered by irq */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">is_ep0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">ep0_in_status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_IER</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">int_mask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">status</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at91_ep_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_ep</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at91_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at91_udc</span>		<span class="o">*</span><span class="n">udc</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* make sure it&#39;s actually queued on this endpoint */</span>
	<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">==</span> <span class="n">_req</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">!=</span> <span class="n">_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at91_ep_set_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">at91_udc</span>	<span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">creg</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">csr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_iso</span> <span class="o">||</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">clocked</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">creg</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">csr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">creg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * fail with still-busy IN endpoints, ensuring correct sequencing</span>
<span class="cm">	 * of data tx then stall.  note that the fifo rx bytecount isn&#39;t</span>
<span class="cm">	 * completely accurate as a tx bytecount.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">csr</span> <span class="o">|=</span> <span class="n">CLR_FX</span><span class="p">;</span>
		<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SET_FX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">csr</span> <span class="o">|=</span> <span class="n">AT91_UDP_FORCESTALL</span><span class="p">;</span>
			<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;halt %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_RST_EP</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">int_mask</span><span class="p">);</span>
			<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_RST_EP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AT91_UDP_FORCESTALL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">at91_ep_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">at91_ep_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">at91_ep_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_request</span>	<span class="o">=</span> <span class="n">at91_ep_alloc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_request</span>	<span class="o">=</span> <span class="n">at91_ep_free_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queue</span>		<span class="o">=</span> <span class="n">at91_ep_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue</span>	<span class="o">=</span> <span class="n">at91_ep_dequeue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_halt</span>	<span class="o">=</span> <span class="n">at91_ep_set_halt</span><span class="p">,</span>
	<span class="cm">/* there&#39;s only imprecise fifo status reporting */</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at91_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">to_udc</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">to_udc</span><span class="p">(</span><span class="n">gadget</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">clocked</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">at91_udp_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_FRM_NUM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_NUM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at91_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_udc</span>	<span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">to_udc</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="n">u32</span>		<span class="n">glbstate</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">clocked</span> <span class="o">||</span> <span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* NOTE:  some &quot;early versions&quot; handle ESR differently ... */</span>

	<span class="n">glbstate</span> <span class="o">=</span> <span class="n">at91_udp_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_GLB_STAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">glbstate</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_ESR</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">glbstate</span> <span class="o">|=</span> <span class="n">AT91_UDP_ESR</span><span class="p">;</span>
	<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_GLB_STAT</span><span class="p">,</span> <span class="n">glbstate</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* reinit == restore initial software state */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_reinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_ENDPOINTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">at91_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">udp_baseaddr</span> <span class="o">+</span> <span class="n">AT91_UDP_CSR</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="cm">/* initialize one queue per endpoint */</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_activity</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span> <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_ENDPOINTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">at91_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nuke</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">driver</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">udc_reinit</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clk_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">clocked</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">clocked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">fclk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clk_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">clocked</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">clocked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">fclk</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * activate/deactivate link with host; minimize power usage for</span>
<span class="cm"> * inactive links by cutting clocks and transceiver power.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pullup</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">active</span> <span class="o">=</span> <span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">pullup_active_low</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">||</span> <span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus</span><span class="p">)</span>
		<span class="n">is_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%sactive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">is_on</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;in&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk_on</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_ICR</span><span class="p">,</span> <span class="n">AT91_UDP_RXRSM</span><span class="p">);</span>
		<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_TXVC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_at91rm9200</span><span class="p">())</span>
			<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">pullup_pin</span><span class="p">,</span> <span class="n">active</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_at91sam9260</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_at91sam9263</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_at91sam9g20</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">txvc</span> <span class="o">=</span> <span class="n">at91_udp_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_TXVC</span><span class="p">);</span>

			<span class="n">txvc</span> <span class="o">|=</span> <span class="n">AT91_UDP_TXVC_PUON</span><span class="p">;</span>
			<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_TXVC</span><span class="p">,</span> <span class="n">txvc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_at91sam9261</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_at91sam9g10</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">usbpucr</span><span class="p">;</span>

			<span class="n">usbpucr</span> <span class="o">=</span> <span class="n">at91_matrix_read</span><span class="p">(</span><span class="n">AT91_MATRIX_USBPUCR</span><span class="p">);</span>
			<span class="n">usbpucr</span> <span class="o">|=</span> <span class="n">AT91_MATRIX_USBPUCR_PUON</span><span class="p">;</span>
			<span class="n">at91_matrix_write</span><span class="p">(</span><span class="n">AT91_MATRIX_USBPUCR</span><span class="p">,</span> <span class="n">usbpucr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">stop_activity</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_IDR</span><span class="p">,</span> <span class="n">AT91_UDP_RXRSM</span><span class="p">);</span>
		<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_TXVC</span><span class="p">,</span> <span class="n">AT91_UDP_TXVC_TXVDIS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_at91rm9200</span><span class="p">())</span>
			<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">pullup_pin</span><span class="p">,</span> <span class="o">!</span><span class="n">active</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_at91sam9260</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_at91sam9263</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_at91sam9g20</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">txvc</span> <span class="o">=</span> <span class="n">at91_udp_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_TXVC</span><span class="p">);</span>

			<span class="n">txvc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AT91_UDP_TXVC_PUON</span><span class="p">;</span>
			<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_TXVC</span><span class="p">,</span> <span class="n">txvc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_at91sam9261</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_at91sam9g10</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">usbpucr</span><span class="p">;</span>

			<span class="n">usbpucr</span> <span class="o">=</span> <span class="n">at91_matrix_read</span><span class="p">(</span><span class="n">AT91_MATRIX_USBPUCR</span><span class="p">);</span>
			<span class="n">usbpucr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AT91_MATRIX_USBPUCR_PUON</span><span class="p">;</span>
			<span class="n">at91_matrix_write</span><span class="p">(</span><span class="n">AT91_MATRIX_USBPUCR</span><span class="p">,</span> <span class="n">usbpucr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">clk_off</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* vbus is here!  turn everything on that&#39;s ready */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">at91_vbus_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_udc</span>	<span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">to_udc</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* VDBG(&quot;vbus %s\n&quot;, is_active ? &quot;on&quot; : &quot;off&quot;); */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus</span> <span class="o">=</span> <span class="p">(</span><span class="n">is_active</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="n">pullup</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">is_active</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pullup</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at91_pullup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_udc</span>	<span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">to_udc</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">is_on</span> <span class="o">=</span> <span class="o">!!</span><span class="n">is_on</span><span class="p">;</span>
	<span class="n">pullup</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">is_on</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at91_set_selfpowered</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_udc</span>	<span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">to_udc</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">selfpowered</span> <span class="o">=</span> <span class="p">(</span><span class="n">is_on</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">at91_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">at91_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_gadget_ops</span> <span class="n">at91_udc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_frame</span>		<span class="o">=</span> <span class="n">at91_get_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wakeup</span>			<span class="o">=</span> <span class="n">at91_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_selfpowered</span>	<span class="o">=</span> <span class="n">at91_set_selfpowered</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vbus_session</span>		<span class="o">=</span> <span class="n">at91_vbus_session</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pullup</span>			<span class="o">=</span> <span class="n">at91_pullup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_start</span>		<span class="o">=</span> <span class="n">at91_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_stop</span>		<span class="o">=</span> <span class="n">at91_stop</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * VBUS-powered devices may also also want to support bigger</span>
<span class="cm">	 * power budgets after an appropriate SET_CONFIGURATION.</span>
<span class="cm">	 */</span>
	<span class="cm">/* .vbus_power		= at91_vbus_power, */</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">creg</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">csr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">creg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">at91_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AT91_UDP_STALLSENT</span> <span class="o">|</span> <span class="n">AT91_UDP_TXCOMP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">csr</span> <span class="o">|=</span> <span class="n">CLR_FX</span><span class="p">;</span>
			<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SET_FX</span> <span class="o">|</span> <span class="n">AT91_UDP_STALLSENT</span> <span class="o">|</span> <span class="n">AT91_UDP_TXCOMP</span><span class="p">);</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">write_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_STALLSENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* STALLSENT bit == ISOERR */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_iso</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="p">)</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
			<span class="n">csr</span> <span class="o">|=</span> <span class="n">CLR_FX</span><span class="p">;</span>
			<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SET_FX</span> <span class="o">|</span> <span class="n">AT91_UDP_STALLSENT</span><span class="p">);</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>
			<span class="n">csr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">creg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">RX_DATA_READY</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">read_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">union</span> <span class="n">setup</span> <span class="p">{</span>
	<span class="n">u8</span>			<span class="n">raw</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">usb_ctrlrequest</span>	<span class="n">r</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">u32</span> <span class="n">csr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">creg</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">dreg</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span> <span class="o">+</span> <span class="p">(</span><span class="n">AT91_UDP_FDR</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">AT91_UDP_CSR</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="kt">unsigned</span>	<span class="n">rxcount</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">tmp</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">setup</span>	<span class="n">pkt</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* read and ack SETUP; hard-fail for bogus packets */</span>
	<span class="n">rxcount</span> <span class="o">=</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_RXBYTECNT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">rxcount</span> <span class="o">==</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">rxcount</span><span class="o">--</span><span class="p">)</span>
			<span class="n">pkt</span><span class="p">.</span><span class="n">raw</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readb</span><span class="p">(</span><span class="n">dreg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">csr</span> <span class="o">|=</span> <span class="n">AT91_UDP_DIR</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AT91_UDP_DIR</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* REVISIT this happens sometimes under load; why?? */</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;SETUP len %d, csr %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rxcount</span><span class="p">,</span> <span class="n">csr</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">csr</span> <span class="o">|=</span> <span class="n">CLR_FX</span><span class="p">;</span>
	<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SET_FX</span> <span class="o">|</span> <span class="n">AT91_UDP_RXSETUP</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">wait_for_addr_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">wait_for_config_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>

<span class="cp">#define w_index		le16_to_cpu(pkt.r.wIndex)</span>
<span class="cp">#define w_value		le16_to_cpu(pkt.r.wValue)</span>
<span class="cp">#define w_length	le16_to_cpu(pkt.r.wLength)</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;SETUP %02x.%02x v%04x i%04x l%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pkt</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span><span class="p">,</span> <span class="n">pkt</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequest</span><span class="p">,</span>
			<span class="n">w_value</span><span class="p">,</span> <span class="n">w_index</span><span class="p">,</span> <span class="n">w_length</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * A few standard requests get handled here, ones that touch</span>
<span class="cm">	 * hardware ... notably for device and endpoint features.</span>
<span class="cm">	 */</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">req_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">csr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">creg</span><span class="p">);</span>
	<span class="n">csr</span> <span class="o">|=</span> <span class="n">CLR_FX</span><span class="p">;</span>
	<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SET_FX</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">pkt</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequest</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="p">((</span><span class="n">USB_TYPE_STANDARD</span><span class="o">|</span><span class="n">USB_RECIP_DEVICE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">USB_REQ_SET_ADDRESS</span><span class="o">:</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">csr</span> <span class="o">|</span> <span class="n">AT91_UDP_TXPKTRDY</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">w_value</span><span class="p">;</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">wait_for_addr_ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">req_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* FADDR is set later, when we ack host STATUS */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="p">((</span><span class="n">USB_TYPE_STANDARD</span><span class="o">|</span><span class="n">USB_RECIP_DEVICE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">USB_REQ_SET_CONFIGURATION</span><span class="o">:</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">at91_udp_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_GLB_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_CONFG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wValue</span><span class="p">)</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">wait_for_config_ack</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">wait_for_config_ack</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">wait_for_config_ack</span><span class="p">)</span>
			<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;wait for config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* CONFG is toggled later, if gadget driver succeeds */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Hosts may set or clear remote wakeup status, and</span>
<span class="cm">	 * devices may report they&#39;re VBUS powered.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="p">((</span><span class="n">USB_DIR_IN</span><span class="o">|</span><span class="n">USB_TYPE_STANDARD</span><span class="o">|</span><span class="n">USB_RECIP_DEVICE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">USB_REQ_GET_STATUS</span><span class="o">:</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">selfpowered</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DEVICE_SELF_POWERED</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">at91_udp_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_GLB_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_ESR</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DEVICE_REMOTE_WAKEUP</span><span class="p">);</span>
		<span class="n">PACKET</span><span class="p">(</span><span class="s">&quot;get device status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">dreg</span><span class="p">);</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dreg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">write_in</span><span class="p">;</span>
		<span class="cm">/* then STATUS starts later, automatically */</span>
	<span class="k">case</span> <span class="p">((</span><span class="n">USB_TYPE_STANDARD</span><span class="o">|</span><span class="n">USB_RECIP_DEVICE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">USB_REQ_SET_FEATURE</span><span class="o">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w_value</span> <span class="o">!=</span> <span class="n">USB_DEVICE_REMOTE_WAKEUP</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">at91_udp_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_GLB_STAT</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AT91_UDP_ESR</span><span class="p">;</span>
		<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_GLB_STAT</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">succeed</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">((</span><span class="n">USB_TYPE_STANDARD</span><span class="o">|</span><span class="n">USB_RECIP_DEVICE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">USB_REQ_CLEAR_FEATURE</span><span class="o">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w_value</span> <span class="o">!=</span> <span class="n">USB_DEVICE_REMOTE_WAKEUP</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">at91_udp_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_GLB_STAT</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AT91_UDP_ESR</span><span class="p">;</span>
		<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_GLB_STAT</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">succeed</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Interfaces have no feature settings; this is pretty useless.</span>
<span class="cm">	 * we won&#39;t even insist the interface exists...</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="p">((</span><span class="n">USB_DIR_IN</span><span class="o">|</span><span class="n">USB_TYPE_STANDARD</span><span class="o">|</span><span class="n">USB_RECIP_INTERFACE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">USB_REQ_GET_STATUS</span><span class="o">:</span>
		<span class="n">PACKET</span><span class="p">(</span><span class="s">&quot;get interface status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dreg</span><span class="p">);</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dreg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">write_in</span><span class="p">;</span>
		<span class="cm">/* then STATUS starts later, automatically */</span>
	<span class="k">case</span> <span class="p">((</span><span class="n">USB_TYPE_STANDARD</span><span class="o">|</span><span class="n">USB_RECIP_INTERFACE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">USB_REQ_SET_FEATURE</span><span class="o">:</span>
	<span class="k">case</span> <span class="p">((</span><span class="n">USB_TYPE_STANDARD</span><span class="o">|</span><span class="n">USB_RECIP_INTERFACE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">USB_REQ_CLEAR_FEATURE</span><span class="o">:</span>
		<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Hosts may clear bulk/intr endpoint halt after the gadget</span>
<span class="cm">	 * driver sets it (not widely used); or set it (for testing)</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="p">((</span><span class="n">USB_DIR_IN</span><span class="o">|</span><span class="n">USB_TYPE_STANDARD</span><span class="o">|</span><span class="n">USB_RECIP_ENDPOINT</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">USB_REQ_GET_STATUS</span><span class="o">:</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">w_index</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">;</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;=</span> <span class="n">NUM_ENDPOINTS</span> <span class="o">||</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">w_index</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">PACKET</span><span class="p">(</span><span class="s">&quot;get %s status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_FORCESTALL</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_ENDPOINT_HALT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">dreg</span><span class="p">);</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dreg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">write_in</span><span class="p">;</span>
		<span class="cm">/* then STATUS starts later, automatically */</span>
	<span class="k">case</span> <span class="p">((</span><span class="n">USB_TYPE_STANDARD</span><span class="o">|</span><span class="n">USB_RECIP_ENDPOINT</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">USB_REQ_SET_FEATURE</span><span class="o">:</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">w_index</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">;</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w_value</span> <span class="o">!=</span> <span class="n">USB_ENDPOINT_HALT</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">&gt;=</span> <span class="n">NUM_ENDPOINTS</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_iso</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">w_index</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SET_FX</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">CLR_FX</span> <span class="o">|</span> <span class="n">AT91_UDP_FORCESTALL</span><span class="p">;</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">succeed</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">((</span><span class="n">USB_TYPE_STANDARD</span><span class="o">|</span><span class="n">USB_RECIP_ENDPOINT</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">USB_REQ_CLEAR_FEATURE</span><span class="o">:</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">w_index</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">;</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w_value</span> <span class="o">!=</span> <span class="n">USB_ENDPOINT_HALT</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">&gt;=</span> <span class="n">NUM_ENDPOINTS</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">succeed</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_iso</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">w_index</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>

		<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_RST_EP</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">int_mask</span><span class="p">);</span>
		<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_RST_EP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">CLR_FX</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SET_FX</span> <span class="o">|</span> <span class="n">AT91_UDP_FORCESTALL</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">creg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
			<span class="n">handle_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">succeed</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#undef w_value</span>
<span class="cp">#undef w_index</span>
<span class="cp">#undef w_length</span>

	<span class="cm">/* pass request up to the gadget driver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">.</span><span class="n">r</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">stall:</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;req %02x.%02x protocol STALL; stat %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pkt</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span><span class="p">,</span> <span class="n">pkt</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequest</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">csr</span> <span class="o">|=</span> <span class="n">AT91_UDP_FORCESTALL</span><span class="p">;</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">req_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">succeed:</span>
	<span class="cm">/* immediate successful (IN) STATUS after zero length DATA */</span>
	<span class="n">PACKET</span><span class="p">(</span><span class="s">&quot;ep0 in/status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">write_in:</span>
	<span class="n">csr</span> <span class="o">|=</span> <span class="n">AT91_UDP_TXPKTRDY</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">req_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_ep0</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_ep</span>		<span class="o">*</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">creg</span> <span class="o">=</span> <span class="n">ep0</span><span class="o">-&gt;</span><span class="n">creg</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">csr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">creg</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">at91_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_STALLSENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nuke</span><span class="p">(</span><span class="n">ep0</span><span class="p">,</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">);</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">req_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">csr</span> <span class="o">|=</span> <span class="n">CLR_FX</span><span class="p">;</span>
		<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SET_FX</span> <span class="o">|</span> <span class="n">AT91_UDP_STALLSENT</span> <span class="o">|</span> <span class="n">AT91_UDP_FORCESTALL</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;ep0 stalled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">csr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">creg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_RXSETUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nuke</span><span class="p">(</span><span class="n">ep0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">req_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">handle_setup</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">ep0</span><span class="p">,</span> <span class="n">csr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="cm">/* host ACKed an IN packet that we sent */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_TXCOMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">csr</span> <span class="o">|=</span> <span class="n">CLR_FX</span><span class="p">;</span>
		<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SET_FX</span> <span class="o">|</span> <span class="n">AT91_UDP_TXCOMP</span><span class="p">);</span>

		<span class="cm">/* write more IN DATA? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="n">ep0</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">handle_ep</span><span class="p">(</span><span class="n">ep0</span><span class="p">))</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">req_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Ack after:</span>
<span class="cm">		 *  - last IN DATA packet (including GET_STATUS)</span>
<span class="cm">		 *  - IN/STATUS for OUT DATA</span>
<span class="cm">		 *  - IN/STATUS for any zero-length DATA stage</span>
<span class="cm">		 * except for the IN DATA case, the host should send</span>
<span class="cm">		 * an OUT status later, which we&#39;ll ack.</span>
<span class="cm">		 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">req_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * SET_ADDRESS takes effect only after the STATUS</span>
<span class="cm">			 * (to the original address) gets acked.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">wait_for_addr_ack</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span>	<span class="n">tmp</span><span class="p">;</span>

				<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_FADDR</span><span class="p">,</span>
						<span class="n">AT91_UDP_FEN</span> <span class="o">|</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">at91_udp_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_GLB_STAT</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AT91_UDP_FADDEN</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
					<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AT91_UDP_FADDEN</span><span class="p">;</span>
				<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_GLB_STAT</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">wait_for_addr_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;address %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* OUT packet arrived ... */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_RX_DATA_BK0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">csr</span> <span class="o">|=</span> <span class="n">CLR_FX</span><span class="p">;</span>
		<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SET_FX</span> <span class="o">|</span> <span class="n">AT91_UDP_RX_DATA_BK0</span><span class="p">);</span>

		<span class="cm">/* OUT DATA stage */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">handle_ep</span><span class="p">(</span><span class="n">ep0</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* send IN/STATUS */</span>
					<span class="n">PACKET</span><span class="p">(</span><span class="s">&quot;ep0 in/status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">csr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">creg</span><span class="p">);</span>
					<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SET_FX</span><span class="p">;</span>
					<span class="n">csr</span> <span class="o">|=</span> <span class="n">CLR_FX</span> <span class="o">|</span> <span class="n">AT91_UDP_TXPKTRDY</span><span class="p">;</span>
					<span class="n">__raw_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>
					<span class="n">udc</span><span class="o">-&gt;</span><span class="n">req_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">req_pending</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * AT91 hardware has a hard time with this</span>
<span class="cm">				 * &quot;deferred response&quot; mode for control-OUT</span>
<span class="cm">				 * transfers.  (For control-IN it&#39;s fine.)</span>
<span class="cm">				 *</span>
<span class="cm">				 * The normal solution leaves OUT data in the</span>
<span class="cm">				 * fifo until the gadget driver is ready.</span>
<span class="cm">				 * We couldn&#39;t do that here without disabling</span>
<span class="cm">				 * the IRQ that tells about SETUP packets,</span>
<span class="cm">				 * e.g. when the host gets impatient...</span>
<span class="cm">				 *</span>
<span class="cm">				 * Working around it by copying into a buffer</span>
<span class="cm">				 * would almost be a non-deferred response,</span>
<span class="cm">				 * except that it wouldn&#39;t permit reliable</span>
<span class="cm">				 * stalling of the request.  Instead, demand</span>
<span class="cm">				 * that gadget drivers not use this mode.</span>
<span class="cm">				 */</span>
				<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;no control-OUT deferred responses!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">__raw_writel</span><span class="p">(</span><span class="n">csr</span> <span class="o">|</span> <span class="n">AT91_UDP_FORCESTALL</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">req_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="cm">/* STATUS stage for control-IN; ack.  */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">PACKET</span><span class="p">(</span><span class="s">&quot;ep0 out/status ACK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">creg</span><span class="p">);</span>

			<span class="cm">/* &quot;early&quot; status stage */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span>
				<span class="n">done</span><span class="p">(</span><span class="n">ep0</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">at91_udc_irq</span> <span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_udc</span>		<span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">_udc</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">rescans</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">disable_clock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">clocked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk_on</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="n">disable_clock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rescans</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">at91_udp_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_ISR</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="n">at91_udp_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_IMR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* USB reset irq:  not maskable */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_ENDBUSRES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_IDR</span><span class="p">,</span> <span class="o">~</span><span class="n">MINIMUS_INTERRUPTUS</span><span class="p">);</span>
			<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_IER</span><span class="p">,</span> <span class="n">MINIMUS_INTERRUPTUS</span><span class="p">);</span>
			<span class="cm">/* Atmel code clears this irq twice */</span>
			<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_ICR</span><span class="p">,</span> <span class="n">AT91_UDP_ENDBUSRES</span><span class="p">);</span>
			<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_ICR</span><span class="p">,</span> <span class="n">AT91_UDP_ENDBUSRES</span><span class="p">);</span>
			<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;end bus reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">stop_activity</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>

			<span class="cm">/* enable ep0 */</span>
			<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_CSR</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
					<span class="n">AT91_UDP_EPEDS</span> <span class="o">|</span> <span class="n">AT91_UDP_EPTYPE_CTRL</span><span class="p">);</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_IER</span><span class="p">,</span> <span class="n">AT91_UDP_EP</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

			<span class="cm">/*</span>
<span class="cm">			 * NOTE:  this driver keeps clocks off unless the</span>
<span class="cm">			 * USB host is present.  That saves power, but for</span>
<span class="cm">			 * boards that don&#39;t support VBUS detection, both</span>
<span class="cm">			 * clocks need to be active most of the time.</span>
<span class="cm">			 */</span>

		<span class="cm">/* host initiated suspend (3+ms bus idle) */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_RXSUSP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_IDR</span><span class="p">,</span> <span class="n">AT91_UDP_RXSUSP</span><span class="p">);</span>
			<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_IER</span><span class="p">,</span> <span class="n">AT91_UDP_RXRSM</span><span class="p">);</span>
			<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_ICR</span><span class="p">,</span> <span class="n">AT91_UDP_RXSUSP</span><span class="p">);</span>
			<span class="cm">/* VDBG(&quot;bus suspend\n&quot;); */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * NOTE:  when suspending a VBUS-powered device, the</span>
<span class="cm">			 * gadget driver should switch into slow clock mode</span>
<span class="cm">			 * and then into standby to avoid drawing more than</span>
<span class="cm">			 * 500uA power (2500uA for some high-power configs).</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="cm">/* host initiated resume */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AT91_UDP_RXRSM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_IDR</span><span class="p">,</span> <span class="n">AT91_UDP_RXRSM</span><span class="p">);</span>
			<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_IER</span><span class="p">,</span> <span class="n">AT91_UDP_RXSUSP</span><span class="p">);</span>
			<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_ICR</span><span class="p">,</span> <span class="n">AT91_UDP_RXRSM</span><span class="p">);</span>
			<span class="cm">/* VDBG(&quot;bus resume\n&quot;); */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * NOTE:  for a VBUS-powered device, the gadget driver</span>
<span class="cm">			 * would normally want to switch out of slow clock</span>
<span class="cm">			 * mode into normal mode.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="cm">/* endpoint IRQs are cleared by handling them */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
			<span class="kt">unsigned</span>	<span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">at91_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
				<span class="n">handle_ep0</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_ENDPOINTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
					<span class="n">handle_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable_clock</span><span class="p">)</span>
		<span class="n">clk_off</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nop_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* nothing to free */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">at91_udc</span> <span class="n">controller</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gadget</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">at91_udc_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ep0</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">controller</span><span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">driver_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">init_name</span> <span class="o">=</span> <span class="s">&quot;gadget&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">nop_release</span><span class="p">,</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">ep0name</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">at91_ep_ops</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">udc</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">controller</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">int_mask</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ep1&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">at91_ep_ops</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">udc</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">controller</span><span class="p">,</span>
		<span class="p">.</span><span class="n">is_pingpong</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">int_mask</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ep2&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">at91_ep_ops</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">udc</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">controller</span><span class="p">,</span>
		<span class="p">.</span><span class="n">is_pingpong</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">int_mask</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="cm">/* could actually do bulk too */</span>
			<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ep3-int&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">at91_ep_ops</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">udc</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">controller</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">int_mask</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ep4&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">at91_ep_ops</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">udc</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">controller</span><span class="p">,</span>
		<span class="p">.</span><span class="n">is_pingpong</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">int_mask</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ep</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ep5&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">at91_ep_ops</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">udc</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">controller</span><span class="p">,</span>
		<span class="p">.</span><span class="n">is_pingpong</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">int_mask</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* ep6 and ep7 are also reserved (custom silicon might use them) */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at91_vbus_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">value</span> <span class="o">^=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_active_low</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus</span><span class="p">)</span>
		<span class="n">at91_vbus_session</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">at91_vbus_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_udc</span>	<span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">_udc</span><span class="p">;</span>

	<span class="cm">/* vbus needs at least brief debouncing */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">at91_vbus_update</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">gpio_get_value</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at91_vbus_timer_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_udc</span><span class="p">,</span>
					    <span class="n">vbus_timer_work</span><span class="p">);</span>

	<span class="n">at91_vbus_update</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">gpio_get_value_cansleep</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus_timer</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">VBUS_POLL_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at91_vbus_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are polling vbus it is likely that the gpio is on an</span>
<span class="cm">	 * bus such as i2c or spi which may sleep, so schedule some work</span>
<span class="cm">	 * to read the vbus gpio</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus_timer_work</span><span class="p">))</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus_timer_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at91_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_udc</span>	<span class="o">*</span><span class="n">udc</span><span class="p">;</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_udc</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">selfpowered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;bound to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at91_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_udc</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_IDR</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;unbound from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at91udc_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* force disconnect on reboot */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pullup</span><span class="p">(</span><span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">at91udc_of_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_udc_data</span> <span class="o">*</span><span class="n">board</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">of_gpio_flags</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">of_property_read_u32</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;atmel,vbus-polled&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">board</span><span class="o">-&gt;</span><span class="n">vbus_polled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">board</span><span class="o">-&gt;</span><span class="n">vbus_pin</span> <span class="o">=</span> <span class="n">of_get_named_gpio_flags</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;atmel,vbus-gpio&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">vbus_active_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OF_GPIO_ACTIVE_LOW</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">board</span><span class="o">-&gt;</span><span class="n">pullup_pin</span> <span class="o">=</span> <span class="n">of_get_named_gpio_flags</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;atmel,pullup-gpio&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">board</span><span class="o">-&gt;</span><span class="n">pullup_active_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OF_GPIO_ACTIVE_LOW</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">at91udc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at91_udc</span>	<span class="o">*</span><span class="n">udc</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>	<span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* small (so we copy it) but critical! */</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;missing platform_data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">num_resources</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;invalid num_resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">!=</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">!=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;invalid resource type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">driver_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;someone&#39;s using UDC memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* init software state */</span>
	<span class="n">udc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">controller</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">)</span>
		<span class="n">at91udc_of_init</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_udc_data</span><span class="p">));</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* rm9200 needs manual D+ pullup; off by default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_at91rm9200</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">pullup_pin</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;no D+ pullup?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">pullup_pin</span><span class="p">,</span> <span class="s">&quot;udc_pullup&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;D+ pullup is busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">pullup_pin</span><span class="p">,</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">pullup_active_low</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* newer chips have more FIFO memory than rm9200 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_at91sam9260</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_at91sam9g20</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_at91sam9261</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_at91sam9g10</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_at91sam9263</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">udp_baseaddr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">udp_baseaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail0a</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">udc_reinit</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>

	<span class="cm">/* get interface and function clocks */</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">iclk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;udc_clk&quot;</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">fclk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;udpck&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">fclk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;clocks missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="cm">/* NOTE: we &quot;know&quot; here that refcounts on these are NOPs */</span>
		<span class="k">goto</span> <span class="n">fail0b</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail0b</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* don&#39;t do anything until we have both gadget driver and VBUS */</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>
	<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_TXVC</span><span class="p">,</span> <span class="n">AT91_UDP_TXVC_TXVDIS</span><span class="p">);</span>
	<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_IDR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="cm">/* Clear all pending interrupts - UDP may be used by bootloader. */</span>
	<span class="n">at91_udp_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">AT91_UDP_ICR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>

	<span class="cm">/* request UDC and maybe VBUS irqs */</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">udp_irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">udp_irq</span><span class="p">,</span> <span class="n">at91_udc_irq</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">udc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;request irq %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">udp_irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">,</span> <span class="s">&quot;udc_vbus&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;request vbus pin failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Get the initial state of VBUS - we cannot expect</span>
<span class="cm">		 * a pending interrupt.</span>
<span class="cm">		 */</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus</span> <span class="o">=</span> <span class="n">gpio_get_value_cansleep</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">)</span> <span class="o">^</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_active_low</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_polled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus_timer_work</span><span class="p">,</span> <span class="n">at91_vbus_timer_work</span><span class="p">);</span>
			<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus_timer</span><span class="p">,</span> <span class="n">at91_vbus_timer</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">udc</span><span class="p">);</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus_timer</span><span class="p">,</span>
				  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">VBUS_POLL_TIMEOUT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">),</span>
					<span class="n">at91_vbus_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">udc</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;request vbus irq %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;no VBUS detection, assuming always-on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_add_gadget_udc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail4</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">udc</span><span class="p">);</span>
	<span class="n">device_init_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">create_debug_file</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>

	<span class="n">INFO</span><span class="p">(</span><span class="s">&quot;%s version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">DRIVER_VERSION</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail4:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_polled</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">),</span> <span class="n">udc</span><span class="p">);</span>
<span class="nl">fail3:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">))</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">);</span>
<span class="nl">fail2:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">udp_irq</span><span class="p">,</span> <span class="n">udc</span><span class="p">);</span>
<span class="nl">fail1:</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">fail0b:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">udp_baseaddr</span><span class="p">);</span>
<span class="nl">fail0a:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_at91rm9200</span><span class="p">())</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">pullup_pin</span><span class="p">);</span>
<span class="nl">fail0:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s probe failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">at91udc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">usb_del_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pullup</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">device_init_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">remove_debug_file</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">),</span> <span class="n">udc</span><span class="p">);</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">udp_irq</span><span class="p">,</span> <span class="n">udc</span><span class="p">);</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">udp_baseaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_at91rm9200</span><span class="p">())</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">pullup_pin</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>

	<span class="n">clk_put</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">fclk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">at91udc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">wake</span> <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">device_may_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Unless we can act normally to the host (letting it wake us up</span>
<span class="cm">	 * whenever it has work for us) force disconnect.  Wakeup requires</span>
<span class="cm">	 * PLLB for USB events (signaling for reset, wakeup, or incoming</span>
<span class="cm">	 * tokens) and VBUS irqs (on systems which support them).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">&amp;&amp;</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">wake</span>
			<span class="o">||</span> <span class="n">at91_suspend_entering_slow_clock</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pullup</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">wake</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">enable_irq_wake</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">udp_irq</span><span class="p">);</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">active_suspend</span> <span class="o">=</span> <span class="n">wake</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_polled</span> <span class="o">&amp;&amp;</span> <span class="n">wake</span><span class="p">)</span>
		<span class="n">enable_irq_wake</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at91udc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at91_udc</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_polled</span> <span class="o">&amp;&amp;</span>
	    <span class="n">udc</span><span class="o">-&gt;</span><span class="n">active_suspend</span><span class="p">)</span>
		<span class="n">disable_irq_wake</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">.</span><span class="n">vbus_pin</span><span class="p">);</span>

	<span class="cm">/* maybe reconnect to host; if so, clocks on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">active_suspend</span><span class="p">)</span>
		<span class="n">disable_irq_wake</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">udp_irq</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pullup</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define	at91udc_suspend	NULL</span>
<span class="cp">#define	at91udc_resume	NULL</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_OF)</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">at91_udc_dt_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;atmel,at91rm9200-udc&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* sentinel */</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">at91_udc_dt_ids</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">at91_udc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">at91udc_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">at91udc_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">at91udc_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">at91udc_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">driver_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span>	<span class="o">=</span> <span class="n">of_match_ptr</span><span class="p">(</span><span class="n">at91_udc_dt_ids</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">udc_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91_udc_driver</span><span class="p">,</span> <span class="n">at91udc_probe</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">udc_init_module</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">udc_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91_udc_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">udc_exit_module</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;AT91 udc driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Thomas Rathbone, David Brownell&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:at91_udc&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
