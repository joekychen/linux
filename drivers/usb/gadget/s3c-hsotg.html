<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › gadget › s3c-hsotg.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>s3c-hsotg.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * linux/drivers/usb/gadget/s3c-hsotg.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2011 Samsung Electronics Co., Ltd.</span>
<span class="cm"> *		http://www.samsung.com</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2008 Openmoko, Inc.</span>
<span class="cm"> * Copyright 2008 Simtec Electronics</span>
<span class="cm"> *      Ben Dooks &lt;ben@simtec.co.uk&gt;</span>
<span class="cm"> *      http://armlinux.simtec.co.uk/</span>
<span class="cm"> *</span>
<span class="cm"> * S3C USB2.0 High-speed / OtG driver</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>

<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>
<span class="cp">#include &lt;linux/platform_data/s3c-hsotg.h&gt;</span>

<span class="cp">#include &lt;mach/map.h&gt;</span>

<span class="cp">#include &quot;s3c-hsotg.h&quot;</span>

<span class="cp">#define DMA_ADDR_INVALID (~((dma_addr_t)0))</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">s3c_hsotg_supply_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;vusb_d&quot;</span><span class="p">,</span>		<span class="cm">/* digital USB supply, 1.2V */</span>
	<span class="s">&quot;vusb_a&quot;</span><span class="p">,</span>		<span class="cm">/* analog USB supply, 1.1V */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * EP0_MPS_LIMIT</span>
<span class="cm"> *</span>
<span class="cm"> * Unfortunately there seems to be a limit of the amount of data that can</span>
<span class="cm"> * be transferred by IN transactions on EP0. This is either 127 bytes or 3</span>
<span class="cm"> * packets (which practically means 1 packet and 63 bytes of data) when the</span>
<span class="cm"> * MPS is set to 64.</span>
<span class="cm"> *</span>
<span class="cm"> * This means if we are wanting to move &gt;127 bytes of data, we need to</span>
<span class="cm"> * split the transactions up, but just doing one packet at a time does</span>
<span class="cm"> * not work (this may be an implicit DATA0 PID on first packet of the</span>
<span class="cm"> * transaction) and doing 2 packets is outside the controller&#39;s limits.</span>
<span class="cm"> *</span>
<span class="cm"> * If we try to lower the MPS size for EP0, then no transfers work properly</span>
<span class="cm"> * for EP0, and the system will fail basic enumeration. As no cause for this</span>
<span class="cm"> * has currently been found, we cannot support any large IN transfers for</span>
<span class="cm"> * EP0.</span>
<span class="cm"> */</span>
<span class="cp">#define EP0_MPS_LIMIT	64</span>

<span class="k">struct</span> <span class="n">s3c_hsotg</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">s3c_hsotg_req</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * struct s3c_hsotg_ep - driver endpoint definition.</span>
<span class="cm"> * @ep: The gadget layer representation of the endpoint.</span>
<span class="cm"> * @name: The driver generated name for the endpoint.</span>
<span class="cm"> * @queue: Queue of requests for this endpoint.</span>
<span class="cm"> * @parent: Reference back to the parent device structure.</span>
<span class="cm"> * @req: The current request that the endpoint is processing. This is</span>
<span class="cm"> *       used to indicate an request has been loaded onto the endpoint</span>
<span class="cm"> *       and has yet to be completed (maybe due to data move, or simply</span>
<span class="cm"> *	 awaiting an ack from the core all the data has been completed).</span>
<span class="cm"> * @debugfs: File entry for debugfs file for this endpoint.</span>
<span class="cm"> * @lock: State lock to protect contents of endpoint.</span>
<span class="cm"> * @dir_in: Set to true if this endpoint is of the IN direction, which</span>
<span class="cm"> *	    means that it is sending data to the Host.</span>
<span class="cm"> * @index: The index for the endpoint registers.</span>
<span class="cm"> * @name: The name array passed to the USB core.</span>
<span class="cm"> * @halted: Set if the endpoint has been halted.</span>
<span class="cm"> * @periodic: Set if this is a periodic ep, such as Interrupt</span>
<span class="cm"> * @sent_zlp: Set if we&#39;ve sent a zero-length packet.</span>
<span class="cm"> * @total_data: The total number of data bytes done.</span>
<span class="cm"> * @fifo_size: The size of the FIFO (for periodic IN endpoints)</span>
<span class="cm"> * @fifo_load: The amount of data loaded into the FIFO (periodic IN)</span>
<span class="cm"> * @last_load: The offset of data for the last start of request.</span>
<span class="cm"> * @size_loaded: The last loaded size for DxEPTSIZE for periodic IN</span>
<span class="cm"> *</span>
<span class="cm"> * This is the driver&#39;s state for each registered enpoint, allowing it</span>
<span class="cm"> * to keep track of transactions that need doing. Each endpoint has a</span>
<span class="cm"> * lock to protect the state, to try and avoid using an overall lock</span>
<span class="cm"> * for the host controller as much as possible.</span>
<span class="cm"> *</span>
<span class="cm"> * For periodic IN endpoints, we have fifo_size and fifo_load to try</span>
<span class="cm"> * and keep track of the amount of data in the periodic FIFO for each</span>
<span class="cm"> * of these as we don&#39;t have a status register that tells us how much</span>
<span class="cm"> * is in each of them. (note, this may actually be useless information</span>
<span class="cm"> * as in shared-fifo mode periodic in acts like a single-frame packet</span>
<span class="cm"> * buffer than a fifo)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_ep</span>		<span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg</span>	<span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_req</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">debugfs</span><span class="p">;</span>

	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">total_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">size_loaded</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">last_load</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">fifo_load</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>		<span class="n">fifo_size</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">dir_in</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">index</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">halted</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">periodic</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">sent_zlp</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="kt">char</span>			<span class="n">name</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct s3c_hsotg - driver state.</span>
<span class="cm"> * @dev: The parent device supplied to the probe function</span>
<span class="cm"> * @driver: USB gadget driver</span>
<span class="cm"> * @plat: The platform specific configuration data.</span>
<span class="cm"> * @regs: The memory area mapped for accessing registers.</span>
<span class="cm"> * @regs_res: The resource that was allocated when claiming register space.</span>
<span class="cm"> * @irq: The IRQ number we are using</span>
<span class="cm"> * @supplies: Definition of USB power supplies</span>
<span class="cm"> * @dedicated_fifos: Set if the hardware has dedicated IN-EP fifos.</span>
<span class="cm"> * @num_of_eps: Number of available EPs (excluding EP0)</span>
<span class="cm"> * @debug_root: root directrory for debugfs.</span>
<span class="cm"> * @debug_file: main status file for debugfs.</span>
<span class="cm"> * @debug_fifo: FIFO status file for debugfs.</span>
<span class="cm"> * @ep0_reply: Request used for ep0 reply.</span>
<span class="cm"> * @ep0_buff: Buffer for EP0 reply data, if needed.</span>
<span class="cm"> * @ctrl_buff: Buffer for EP0 control requests.</span>
<span class="cm"> * @ctrl_req: Request for EP0 control packets.</span>
<span class="cm"> * @setup: NAK management for EP0 SETUP</span>
<span class="cm"> * @last_rst: Time of last reset</span>
<span class="cm"> * @eps: The endpoints being supplied to the gadget framework</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span>		 <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_plat</span>	 <span class="o">*</span><span class="n">plat</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>		<span class="o">*</span><span class="n">regs_res</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>		<span class="o">*</span><span class="n">clk</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">regulator_bulk_data</span> <span class="n">supplies</span><span class="p">[</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s3c_hsotg_supply_names</span><span class="p">)];</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">dedicated_fifos</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>           <span class="n">num_of_eps</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">debug_root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">debug_file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">debug_fifo</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">usb_request</span>	<span class="o">*</span><span class="n">ep0_reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_request</span>	<span class="o">*</span><span class="n">ctrl_req</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">ep0_buff</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u8</span>			<span class="n">ctrl_buff</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">usb_gadget</span>	<span class="n">gadget</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">setup</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>           <span class="n">last_rst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span>	<span class="o">*</span><span class="n">eps</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct s3c_hsotg_req - data transfer request</span>
<span class="cm"> * @req: The USB gadget request</span>
<span class="cm"> * @queue: The list of requests for the endpoint this is queued for.</span>
<span class="cm"> * @in_progress: Has already had size/packets written to core</span>
<span class="cm"> * @mapped: DMA buffer for this request has been mapped via dma_map_single().</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_request</span>	<span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">queue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">in_progress</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">mapped</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* conversion functions */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="nf">our_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c_hsotg_req</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="nf">our_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c_hsotg_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="nf">to_hsotg</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c_hsotg</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__orr32</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__bic32</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">val</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* forward decleration of functions */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">s3c_hsotg_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * using_dma - return the DMA status of the driver.</span>
<span class="cm"> * @hsotg: The driver state.</span>
<span class="cm"> *</span>
<span class="cm"> * Return true if we&#39;re using DMA.</span>
<span class="cm"> *</span>
<span class="cm"> * Currently, we have the DMA support code worked into everywhere</span>
<span class="cm"> * that needs it, but the AMBA DMA implementation in the hardware can</span>
<span class="cm"> * only DMA from 32bit aligned addresses. This means that gadgets such</span>
<span class="cm"> * as the CDC Ethernet cannot work as they often pass packets which are</span>
<span class="cm"> * not 32bit aligned.</span>
<span class="cm"> *</span>
<span class="cm"> * Unfortunately the choice to use DMA or not is global to the controller</span>
<span class="cm"> * and seems to be only settable when the controller is being put through</span>
<span class="cm"> * a core reset. This means we either need to fix the gadgets to take</span>
<span class="cm"> * account of DMA alignment, or add bounce buffers (yuerk).</span>
<span class="cm"> *</span>
<span class="cm"> * Until this issue is sorted out, we always return &#39;false&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">using_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* support is not complete */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_en_gsint - enable one or more of the general interrupt</span>
<span class="cm"> * @hsotg: The device state</span>
<span class="cm"> * @ints: A bitmask of the interrupts to enable</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_en_gsint</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gsintmsk</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTMSK</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">new_gsintmsk</span><span class="p">;</span>

	<span class="n">new_gsintmsk</span> <span class="o">=</span> <span class="n">gsintmsk</span> <span class="o">|</span> <span class="n">ints</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_gsintmsk</span> <span class="o">!=</span> <span class="n">gsintmsk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gsintmsk now 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new_gsintmsk</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">new_gsintmsk</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTMSK</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_disable_gsint - disable one or more of the general interrupt</span>
<span class="cm"> * @hsotg: The device state</span>
<span class="cm"> * @ints: A bitmask of the interrupts to enable</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_disable_gsint</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gsintmsk</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTMSK</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">new_gsintmsk</span><span class="p">;</span>

	<span class="n">new_gsintmsk</span> <span class="o">=</span> <span class="n">gsintmsk</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ints</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_gsintmsk</span> <span class="o">!=</span> <span class="n">gsintmsk</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">new_gsintmsk</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTMSK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_ctrl_epint - enable/disable an endpoint irq</span>
<span class="cm"> * @hsotg: The device state</span>
<span class="cm"> * @ep: The endpoint index</span>
<span class="cm"> * @dir_in: True if direction is in.</span>
<span class="cm"> * @en: The enable value, true to enable</span>
<span class="cm"> *</span>
<span class="cm"> * Set or clear the mask for an individual endpoint&#39;s interrupt</span>
<span class="cm"> * request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_ctrl_epint</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ep</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dir_in</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">en</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ep</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">daint</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir_in</span><span class="p">)</span>
		<span class="n">bit</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">daint</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DAINTMSK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">en</span><span class="p">)</span>
		<span class="n">daint</span> <span class="o">|=</span> <span class="n">bit</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">daint</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">daint</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DAINTMSK</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_init_fifo - initialise non-periodic FIFOs</span>
<span class="cm"> * @hsotg: The device instance.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_init_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* set FIFO sizes to 2048/1024 */</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">2048</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GRXFSIZ</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">GNPTXFSIZ_NPTxFStAddr</span><span class="p">(</span><span class="mi">2048</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">GNPTXFSIZ_NPTxFDep</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
	       <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GNPTXFSIZ</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * arange all the rest of the TX FIFOs, as some versions of this</span>
<span class="cm">	 * block have overlapping default addresses. This also ensures</span>
<span class="cm">	 * that if the settings have been changed, then they are set to</span>
<span class="cm">	 * known values.</span>
<span class="cm">	 */</span>

	<span class="cm">/* start at the end of the GNPTXFSIZ, rounded up */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="mi">2048</span> <span class="o">+</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="mi">768</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * currently we allocate TX FIFOs for all possible endpoints,</span>
<span class="cm">	 * and assume that they are all the same size.</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ep</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">ep</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">size</span> <span class="o">&lt;&lt;</span> <span class="n">DPTXFSIZn_DPTxFSize_SHIFT</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DPTXFSIZn</span><span class="p">(</span><span class="n">ep</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * according to p428 of the design guide, we need to ensure that</span>
<span class="cm">	 * all fifos are flushed before continuing</span>
<span class="cm">	 */</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">GRSTCTL_TxFNum</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">|</span> <span class="n">GRSTCTL_TxFFlsh</span> <span class="o">|</span>
	       <span class="n">GRSTCTL_RxFFlsh</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GRSTCTL</span><span class="p">);</span>

	<span class="cm">/* wait until the fifos are both flushed */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GRSTCTL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GRSTCTL_TxFFlsh</span> <span class="o">|</span> <span class="n">GRSTCTL_RxFFlsh</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: timeout flushing fifos (GRSTCTL=%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FIFOs reset, timeout at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @ep: USB endpoint to allocate request for.</span>
<span class="cm"> * @flags: Allocation flags</span>
<span class="cm"> *</span>
<span class="cm"> * Allocate a new USB request structure appropriate for the specified endpoint</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="nf">s3c_hsotg_ep_alloc_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
						      <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg_req</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * is_ep_periodic - return true if the endpoint is in periodic mode.</span>
<span class="cm"> * @hs_ep: The endpoint to query.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if the endpoint is in periodic mode, meaning it is being</span>
<span class="cm"> * used for an Interrupt or ISO transfer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_ep_periodic</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">periodic</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_unmap_dma - unmap the DMA memory being used for the request</span>
<span class="cm"> * @hsotg: The device state.</span>
<span class="cm"> * @hs_ep: The endpoint for the request</span>
<span class="cm"> * @hs_req: The request being processed.</span>
<span class="cm"> *</span>
<span class="cm"> * This is the reverse of s3c_hsotg_map_dma(), called for the completion</span>
<span class="cm"> * of a request to ensure the buffer is ready for access by the caller.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_unmap_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">hs_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">;</span>

	<span class="n">dir</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">dir_in</span> <span class="o">?</span> <span class="n">DMA_TO_DEVICE</span> <span class="o">:</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>

	<span class="cm">/* ignore this if we&#39;re not moving any data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we mapped this, so unmap and remove the dma */</span>

		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">;</span>
		<span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_write_fifo - write packet Data to the TxFIFO</span>
<span class="cm"> * @hsotg: The controller state.</span>
<span class="cm"> * @hs_ep: The endpoint we&#39;re going to write for.</span>
<span class="cm"> * @hs_req: The request to write data for.</span>
<span class="cm"> *</span>
<span class="cm"> * This is called when the TxFIFO has some space in it to hold a new</span>
<span class="cm"> * transmission and we have something to give it. The actual setup of</span>
<span class="cm"> * the data size is done elsewhere, so all we have to do is to actually</span>
<span class="cm"> * write the data.</span>
<span class="cm"> *</span>
<span class="cm"> * The return value is zero if there is more space (or nothing was done)</span>
<span class="cm"> * otherwise -ENOSPC is returned if the FIFO space was used up.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is only needed for PIO</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsotg_write_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">hs_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">periodic</span> <span class="o">=</span> <span class="n">is_ep_periodic</span><span class="p">(</span><span class="n">hs_ep</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">gnptxsts</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GNPTXSTS</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">buf_pos</span> <span class="o">=</span> <span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">to_write</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">size_loaded</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">can_write</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pkt_round</span><span class="p">;</span>

	<span class="n">to_write</span> <span class="o">-=</span> <span class="p">(</span><span class="n">buf_pos</span> <span class="o">-</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">last_load</span><span class="p">);</span>

	<span class="cm">/* if there&#39;s nothing to write, get out early */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">to_write</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">periodic</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dedicated_fifos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">epsize</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPTSIZ</span><span class="p">(</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">));</span>
		<span class="kt">int</span> <span class="n">size_left</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">size_done</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * work out how much data was loaded so we can calculate</span>
<span class="cm">		 * how much data is left in the fifo.</span>
<span class="cm">		 */</span>

		<span class="n">size_left</span> <span class="o">=</span> <span class="n">DxEPTSIZ_XferSize_GET</span><span class="p">(</span><span class="n">epsize</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * if shared fifo, we cannot write anything until the</span>
<span class="cm">		 * previous data has been completely sent.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">fifo_load</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s3c_hsotg_en_gsint</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">GINTSTS_PTxFEmp</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: left=%d, load=%d, fifo=%d, size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">size_left</span><span class="p">,</span>
			<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">size_loaded</span><span class="p">,</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">fifo_load</span><span class="p">,</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">fifo_size</span><span class="p">);</span>

		<span class="cm">/* how much of the data has moved */</span>
		<span class="n">size_done</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">size_loaded</span> <span class="o">-</span> <span class="n">size_left</span><span class="p">;</span>

		<span class="cm">/* how much data is left in the fifo */</span>
		<span class="n">can_write</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">fifo_load</span> <span class="o">-</span> <span class="n">size_done</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: =&gt; can_write1=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">can_write</span><span class="p">);</span>

		<span class="n">can_write</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">-</span> <span class="n">can_write</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: =&gt; can_write2=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">can_write</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">can_write</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s3c_hsotg_en_gsint</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">GINTSTS_PTxFEmp</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dedicated_fifos</span> <span class="o">&amp;&amp;</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">can_write</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DTXFSTS</span><span class="p">(</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">));</span>

		<span class="n">can_write</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">can_write</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GNPTXSTS_NPTxQSpcAvail_GET</span><span class="p">(</span><span class="n">gnptxsts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: no queue slots available (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">gnptxsts</span><span class="p">);</span>

			<span class="n">s3c_hsotg_en_gsint</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">GINTSTS_NPTxFEmp</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">can_write</span> <span class="o">=</span> <span class="n">GNPTXSTS_NPTxFSpcAvail_GET</span><span class="p">(</span><span class="n">gnptxsts</span><span class="p">);</span>
		<span class="n">can_write</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* fifo size is in 32bit quantities. */</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: GNPTXSTS=%08x, can=%d, to=%d, mps %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="n">gnptxsts</span><span class="p">,</span> <span class="n">can_write</span><span class="p">,</span> <span class="n">to_write</span><span class="p">,</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * limit to 512 bytes of data, it seems at least on the non-periodic</span>
<span class="cm">	 * FIFO, requests of &gt;512 cause the endpoint to get stuck with a</span>
<span class="cm">	 * fragment of the end of the transfer in it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">can_write</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">can_write</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * limit the write to one max-packet size worth of data, but allow</span>
<span class="cm">	 * the transfer to return that it did not run out of fifo space</span>
<span class="cm">	 * doing it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">to_write</span> <span class="o">&gt;</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">to_write</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">;</span>

		<span class="n">s3c_hsotg_en_gsint</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span>
				   <span class="n">periodic</span> <span class="o">?</span> <span class="n">GINTSTS_PTxFEmp</span> <span class="o">:</span>
				   <span class="n">GINTSTS_NPTxFEmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* see if we can write data */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">to_write</span> <span class="o">&gt;</span> <span class="n">can_write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">to_write</span> <span class="o">=</span> <span class="n">can_write</span><span class="p">;</span>
		<span class="n">pkt_round</span> <span class="o">=</span> <span class="n">to_write</span> <span class="o">%</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Round the write down to an</span>
<span class="cm">		 * exact number of packets.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Note, we do not currently check to see if we can ever</span>
<span class="cm">		 * write a full packet or not to the FIFO.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_round</span><span class="p">)</span>
			<span class="n">to_write</span> <span class="o">-=</span> <span class="n">pkt_round</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * enable correct FIFO interrupt to alert us when there</span>
<span class="cm">		 * is more room left.</span>
<span class="cm">		 */</span>

		<span class="n">s3c_hsotg_en_gsint</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span>
				   <span class="n">periodic</span> <span class="o">?</span> <span class="n">GINTSTS_PTxFEmp</span> <span class="o">:</span>
				   <span class="n">GINTSTS_NPTxFEmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;write %d/%d, can_write %d, done %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">to_write</span><span class="p">,</span> <span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">can_write</span><span class="p">,</span> <span class="n">buf_pos</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">to_write</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">buf_pos</span> <span class="o">+</span> <span class="n">to_write</span><span class="p">;</span>
	<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">total_data</span> <span class="o">+=</span> <span class="n">to_write</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">periodic</span><span class="p">)</span>
		<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">fifo_load</span> <span class="o">+=</span> <span class="n">to_write</span><span class="p">;</span>

	<span class="n">to_write</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">to_write</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">buf_pos</span><span class="p">;</span>

	<span class="n">writesl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">EPFIFO</span><span class="p">(</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">to_write</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">to_write</span> <span class="o">&gt;=</span> <span class="n">can_write</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENOSPC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * get_ep_limit - get the maximum data legnth for this endpoint</span>
<span class="cm"> * @hs_ep: The endpoint</span>
<span class="cm"> *</span>
<span class="cm"> * Return the maximum data that can be queued in one go on a given endpoint</span>
<span class="cm"> * so that transfers that are too long can be split.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">get_ep_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">maxsize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">maxpkt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">maxsize</span> <span class="o">=</span> <span class="n">DxEPTSIZ_XferSize_LIMIT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">maxpkt</span> <span class="o">=</span> <span class="n">DxEPTSIZ_PktCnt_LIMIT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">maxsize</span> <span class="o">=</span> <span class="mi">64</span><span class="o">+</span><span class="mi">64</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">dir_in</span><span class="p">)</span>
			<span class="n">maxpkt</span> <span class="o">=</span> <span class="n">DIEPTSIZ0_PktCnt_LIMIT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">maxpkt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we made the constant loading easier above by using +1 */</span>
	<span class="n">maxpkt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">maxsize</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * constrain by packet count if maxpkts*pktsize is greater</span>
<span class="cm">	 * than the length register size.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">maxpkt</span> <span class="o">*</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maxsize</span><span class="p">)</span>
		<span class="n">maxsize</span> <span class="o">=</span> <span class="n">maxpkt</span> <span class="o">*</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">maxsize</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_start_req - start a USB request from an endpoint&#39;s queue</span>
<span class="cm"> * @hsotg: The controller state.</span>
<span class="cm"> * @hs_ep: The endpoint to process a request for</span>
<span class="cm"> * @hs_req: The request to start.</span>
<span class="cm"> * @continuing: True if we are doing more for the current request.</span>
<span class="cm"> *</span>
<span class="cm"> * Start the given request running by setting the endpoint registers</span>
<span class="cm"> * appropriately, and writing any data to the FIFOs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_start_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">hs_req</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">continuing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">ureq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir_in</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">dir_in</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">epctrl_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">epsize_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">epsize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">packets</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">maxreq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">continuing</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: active request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">!=</span> <span class="n">hs_req</span> <span class="o">&amp;&amp;</span> <span class="n">continuing</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: continue different req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">epctrl_reg</span> <span class="o">=</span> <span class="n">dir_in</span> <span class="o">?</span> <span class="n">DIEPCTL</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">:</span> <span class="n">DOEPCTL</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="n">epsize_reg</span> <span class="o">=</span> <span class="n">dir_in</span> <span class="o">?</span> <span class="n">DIEPTSIZ</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">:</span> <span class="n">DOEPTSIZ</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: DxEPCTL=0x%08x, ep %d, dir %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epctrl_reg</span><span class="p">),</span> <span class="n">index</span><span class="p">,</span>
		<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">dir_in</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">);</span>

	<span class="cm">/* If endpoint is stalled, we will restart request later */</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epctrl_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">DxEPCTL_Stall</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ep%d is stalled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">ureq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">ureq</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ureq-&gt;length:%d ureq-&gt;actual:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ureq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">ureq</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;REQ buf %p len %d dma 0x%08x noi=%d zp=%d snok=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ureq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">ureq</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
			<span class="n">ureq</span><span class="o">-&gt;</span><span class="n">no_interrupt</span><span class="p">,</span> <span class="n">ureq</span><span class="o">-&gt;</span><span class="n">zero</span><span class="p">,</span> <span class="n">ureq</span><span class="o">-&gt;</span><span class="n">short_not_ok</span><span class="p">);</span>

	<span class="n">maxreq</span> <span class="o">=</span> <span class="n">get_ep_limit</span><span class="p">(</span><span class="n">hs_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">maxreq</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">round</span> <span class="o">=</span> <span class="n">maxreq</span> <span class="o">%</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: length %d, max-req %d, r %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">maxreq</span><span class="p">,</span> <span class="n">round</span><span class="p">);</span>

		<span class="cm">/* round down to multiple of packets */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">round</span><span class="p">)</span>
			<span class="n">maxreq</span> <span class="o">-=</span> <span class="n">round</span><span class="p">;</span>

		<span class="n">length</span> <span class="o">=</span> <span class="n">maxreq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span>
		<span class="n">packets</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">packets</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* send one packet if length is zero. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir_in</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">epsize</span> <span class="o">=</span> <span class="n">DxEPTSIZ_MC</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">epsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ureq</span><span class="o">-&gt;</span><span class="n">zero</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * test for the packets being exactly right for the</span>
<span class="cm">		 * transfer</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="p">(</span><span class="n">packets</span> <span class="o">*</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">))</span>
			<span class="n">packets</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">epsize</span> <span class="o">|=</span> <span class="n">DxEPTSIZ_PktCnt</span><span class="p">(</span><span class="n">packets</span><span class="p">);</span>
	<span class="n">epsize</span> <span class="o">|=</span> <span class="n">DxEPTSIZ_XferSize</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %d@%d/%d, 0x%08x =&gt; 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">packets</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">ureq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">epsize</span><span class="p">,</span> <span class="n">epsize_reg</span><span class="p">);</span>

	<span class="cm">/* store the request as the current one we&#39;re doing */</span>
	<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="n">hs_req</span><span class="p">;</span>

	<span class="cm">/* write size / packets */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">epsize</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epsize_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">using_dma</span><span class="p">(</span><span class="n">hsotg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">continuing</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_reg</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * write DMA address to control register, buffer already</span>
<span class="cm">		 * synced by s3c_hsotg_ep_queue().</span>
<span class="cm">		 */</span>

		<span class="n">dma_reg</span> <span class="o">=</span> <span class="n">dir_in</span> <span class="o">?</span> <span class="n">DIEPDMA</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">:</span> <span class="n">DOEPDMA</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ureq</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">dma_reg</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: 0x%08x =&gt; 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ureq</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">dma_reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_EPEna</span><span class="p">;</span>	<span class="cm">/* ensure ep enabled */</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_USBActEp</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setup req:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">);</span>

	<span class="cm">/* For Setup request do not clear NAK */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_CNAK</span><span class="p">;</span>	<span class="cm">/* clear NAK set by core */</span>


	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: DxEPCTL=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epctrl_reg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set these, it seems that DMA support increments past the end</span>
<span class="cm">	 * of the packet buffer so we need to calculate the length from</span>
<span class="cm">	 * this information.</span>
<span class="cm">	 */</span>
	<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">size_loaded</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">last_load</span> <span class="o">=</span> <span class="n">ureq</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir_in</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">using_dma</span><span class="p">(</span><span class="n">hsotg</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* set these anyway, we may need them for non-periodic in */</span>
		<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">fifo_load</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">s3c_hsotg_write_fifo</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">hs_ep</span><span class="p">,</span> <span class="n">hs_req</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * clear the INTknTXFEmpMsk when we start request, more as a aide</span>
<span class="cm">	 * to debugging to see what is going on.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir_in</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">DIEPMSK_INTknTXFEmpMsk</span><span class="p">,</span>
		       <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPINT</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note, trying to clear the NAK here causes problems with transmit</span>
<span class="cm">	 * on the S3C6400 ending up with the TXFIFO becoming full.</span>
<span class="cm">	 */</span>

	<span class="cm">/* check ep is enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epctrl_reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DxEPCTL_EPEna</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;ep%d: failed to become enabled (DxEPCTL=0x%08x)?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">index</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epctrl_reg</span><span class="p">));</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: DxEPCTL=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epctrl_reg</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_map_dma - map the DMA memory being used for the request</span>
<span class="cm"> * @hsotg: The device state.</span>
<span class="cm"> * @hs_ep: The endpoint the request is on.</span>
<span class="cm"> * @req: The request being processed.</span>
<span class="cm"> *</span>
<span class="cm"> * We&#39;ve been asked to queue a request, so ensure that the memory buffer</span>
<span class="cm"> * is correctly setup for DMA. If we&#39;ve been passed an extant DMA address</span>
<span class="cm"> * then ensure the buffer has been synced to memory. If our buffer has no</span>
<span class="cm"> * DMA memory, then we map the memory and mark our request to allow us to</span>
<span class="cm"> * cleanup on completion.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsotg_map_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">hs_req</span> <span class="o">=</span> <span class="n">our_req</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">dir</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">dir_in</span> <span class="o">?</span> <span class="n">DMA_TO_DEVICE</span> <span class="o">:</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>

	<span class="cm">/* if the length is zero, ignore the DMA data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">==</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">;</span>

		<span class="n">dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">dma_error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: unaligned dma buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>

			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
		<span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">dma_error:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: failed to map buffer %p, %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsotg_ep_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			      <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">hs_req</span> <span class="o">=</span> <span class="n">our_req</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span> <span class="o">=</span> <span class="n">our_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hs</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">first</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: req %p: %d@%p, noi=%d, zero=%d, snok=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">no_interrupt</span><span class="p">,</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">zero</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">short_not_ok</span><span class="p">);</span>

	<span class="cm">/* initialise status of the request */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="cm">/* if we&#39;re using DMA, sync the buffers as necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">using_dma</span><span class="p">(</span><span class="n">hs</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">s3c_hsotg_map_dma</span><span class="p">(</span><span class="n">hs</span><span class="p">,</span> <span class="n">hs_ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>

	<span class="n">first</span> <span class="o">=</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span>
		<span class="n">s3c_hsotg_start_req</span><span class="p">(</span><span class="n">hs</span><span class="p">,</span> <span class="n">hs_ep</span><span class="p">,</span> <span class="n">hs_req</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_ep_free_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">hs_req</span> <span class="o">=</span> <span class="n">our_req</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">hs_req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_complete_oursetup - setup completion callback</span>
<span class="cm"> * @ep: The endpoint the request was on.</span>
<span class="cm"> * @req: The request completed.</span>
<span class="cm"> *</span>
<span class="cm"> * Called on completion of any requests the driver itself</span>
<span class="cm"> * submitted that need cleaning up.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_complete_oursetup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span> <span class="o">=</span> <span class="n">our_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ep %p, req %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="n">s3c_hsotg_ep_free_request</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep_from_windex - convert control wIndex value to endpoint</span>
<span class="cm"> * @hsotg: The driver state.</span>
<span class="cm"> * @windex: The control request wIndex field (in host order).</span>
<span class="cm"> *</span>
<span class="cm"> * Convert the given wIndex into a pointer to an driver endpoint</span>
<span class="cm"> * structure, or return NULL if it is not a valid endpoint.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="nf">ep_from_windex</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
					   <span class="n">u32</span> <span class="n">windex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">windex</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">windex</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">windex</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">windex</span> <span class="o">&gt;=</span> <span class="mh">0x100</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">num_of_eps</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir_in</span> <span class="o">!=</span> <span class="n">dir</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_send_reply - send reply to control request</span>
<span class="cm"> * @hsotg: The device state</span>
<span class="cm"> * @ep: Endpoint 0</span>
<span class="cm"> * @buff: Buffer for request</span>
<span class="cm"> * @length: Length of reply.</span>
<span class="cm"> *</span>
<span class="cm"> * Create a request and queue it on the given endpoint. This is useful as</span>
<span class="cm"> * an internal method of sending replies to certain control requests, etc.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsotg_send_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: buff %p, len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">s3c_hsotg_ep_alloc_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">ep0_reply</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: cannot alloc req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">ep0_buff</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">zero</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* always do zero-length final transfer */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">s3c_hsotg_complete_oursetup</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">sent_zlp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s3c_hsotg_ep_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: cannot queue req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_process_req_status - process request GET_STATUS</span>
<span class="cm"> * @hsotg: The device state</span>
<span class="cm"> * @ctrl: USB control request</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsotg_process_req_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">reply</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: USB_REQ_GET_STATUS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">dir_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: direction out?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_RECIP_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_RECIP_DEVICE</span>:
		<span class="n">reply</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* bit 0 =&gt; self powered,</span>
<span class="cm">					 * bit 1 =&gt; remote wakeup */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_RECIP_INTERFACE</span>:
		<span class="cm">/* currently, the data result should be zero */</span>
		<span class="n">reply</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_RECIP_ENDPOINT</span>:
		<span class="n">ep</span> <span class="o">=</span> <span class="n">ep_from_windex</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

		<span class="n">reply</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s3c_hsotg_send_reply</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">ep0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: failed to send reply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">s3c_hsotg_ep_sethalt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * get_ep_head - return the first request on the endpoint</span>
<span class="cm"> * @hs_ep: The controller endpoint to get</span>
<span class="cm"> *</span>
<span class="cm"> * Get the first request on the endpoint.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="nf">get_ep_head</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c_hsotg_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_process_req_featire - process request {SET,CLEAR}_FEATURE</span>
<span class="cm"> * @hsotg: The device state</span>
<span class="cm"> * @ctrl: USB control request</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsotg_process_req_feature</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">hs_req</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">restart</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">set</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequest</span> <span class="o">==</span> <span class="n">USB_REQ_SET_FEATURE</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %s_FEATURE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">set</span> <span class="o">?</span> <span class="s">&quot;SET&quot;</span> <span class="o">:</span> <span class="s">&quot;CLEAR&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">==</span> <span class="n">USB_RECIP_ENDPOINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">ep_from_windex</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: no endpoint for 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_ENDPOINT_HALT</span>:
			<span class="n">s3c_hsotg_ep_sethalt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">s3c_hsotg_send_reply</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">ep0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s: failed to send reply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * If we have request in progress,</span>
<span class="cm">				 * then complete it</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hs_req</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
					<span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span>
							     <span class="o">&amp;</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="cm">/* If we have pending request, then start it */</span>
				<span class="n">restart</span> <span class="o">=</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hs_req</span> <span class="o">=</span> <span class="n">get_ep_head</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
					<span class="n">s3c_hsotg_start_req</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
							    <span class="n">hs_req</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>  <span class="cm">/* currently only deal with endpoint */</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_process_control - process a control request</span>
<span class="cm"> * @hsotg: The device state</span>
<span class="cm"> * @ctrl: The control request received</span>
<span class="cm"> *</span>
<span class="cm"> * The controller has received the SETUP phase of a control request, and</span>
<span class="cm"> * needs to work out what to do next (and whether to pass it on to the</span>
<span class="cm"> * gadget driver).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_process_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dcfg</span><span class="p">;</span>

	<span class="n">ep0</span><span class="o">-&gt;</span><span class="n">sent_zlp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ctrl Req=%02x, Type=%02x, V=%04x, L=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequest</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span><span class="p">,</span>
		 <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * record the direction of the request, for later use when enquing</span>
<span class="cm">	 * packets onto EP0.</span>
<span class="cm">	 */</span>

	<span class="n">ep0</span><span class="o">-&gt;</span><span class="n">dir_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ctrl: dir_in=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep0</span><span class="o">-&gt;</span><span class="n">dir_in</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * if we&#39;ve no data with this request, then the last part of the</span>
<span class="cm">	 * transaction is going to implicitly be IN.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ep0</span><span class="o">-&gt;</span><span class="n">dir_in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_TYPE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">USB_TYPE_STANDARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bRequest</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_REQ_SET_ADDRESS</span>:
			<span class="n">dcfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCFG</span><span class="p">);</span>
			<span class="n">dcfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DCFG_DevAddr_MASK</span><span class="p">;</span>
			<span class="n">dcfg</span> <span class="o">|=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wValue</span> <span class="o">&lt;&lt;</span> <span class="n">DCFG_DevAddr_SHIFT</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">dcfg</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCFG</span><span class="p">);</span>

			<span class="n">dev_info</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;new address %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">s3c_hsotg_send_reply</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">ep0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">USB_REQ_GET_STATUS</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s3c_hsotg_process_req_status</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">USB_REQ_CLEAR_FEATURE</span>:
		<span class="k">case</span> <span class="n">USB_REQ_SET_FEATURE</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s3c_hsotg_process_req_feature</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* as a fallback, try delivering it to the driver to deal with */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;driver-&gt;setup() ret %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * the request is either unhandlable, or is not formatted correctly</span>
<span class="cm">	 * so respond with a STALL for the status stage to indicate failure.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ep0 stall (dir=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep0</span><span class="o">-&gt;</span><span class="n">dir_in</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">dir_in</span><span class="p">)</span> <span class="o">?</span> <span class="n">DIEPCTL0</span> <span class="o">:</span> <span class="n">DOEPCTL0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * DxEPCTL_Stall will be cleared by EP once it has</span>
<span class="cm">		 * taken effect, so no need to clear later.</span>
<span class="cm">		 */</span>

		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_Stall</span><span class="p">;</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_CNAK</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;written DxEPCTL=0x%08x to %08x (DxEPCTL=0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ctrl</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">reg</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * don&#39;t believe we need to anything more to get the EP</span>
<span class="cm">		 * to reply with a STALL packet</span>
<span class="cm">		 */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">s3c_hsotg_enqueue_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_complete_setup - completion of a setup transfer</span>
<span class="cm"> * @ep: The endpoint the request was on.</span>
<span class="cm"> * @req: The request completed.</span>
<span class="cm"> *</span>
<span class="cm"> * Called on completion of any requests the driver itself submitted for</span>
<span class="cm"> * EP0 setup packets</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_complete_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span> <span class="o">=</span> <span class="n">our_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">s3c_hsotg_enqueue_setup</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">s3c_hsotg_process_control</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_enqueue_setup - start a request for EP0 packets</span>
<span class="cm"> * @hsotg: The device state.</span>
<span class="cm"> *</span>
<span class="cm"> * Enqueue a request on EP0 if necessary to received any SETUP packets</span>
<span class="cm"> * received from the host.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_enqueue_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">ctrl_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">hs_req</span> <span class="o">=</span> <span class="n">our_req</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: queueing setup request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">ctrl_buff</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">s3c_hsotg_complete_setup</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s already queued???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dir_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s3c_hsotg_ep_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: failed queue (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t think there&#39;s much we can do other than watch the</span>
<span class="cm">		 * driver fail.</span>
<span class="cm">		 */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_complete_request - complete a request given to us</span>
<span class="cm"> * @hsotg: The device state.</span>
<span class="cm"> * @hs_ep: The endpoint the request was on.</span>
<span class="cm"> * @hs_req: The request to complete.</span>
<span class="cm"> * @result: The result code (0 =&gt; Ok, otherwise errno)</span>
<span class="cm"> *</span>
<span class="cm"> * The given request has finished, so call the necessary completion</span>
<span class="cm"> * if it has one and then look to see if we can start a new request</span>
<span class="cm"> * on the endpoint.</span>
<span class="cm"> *</span>
<span class="cm"> * Note, expects the ep to already be locked as appropriate.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_complete_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">hs_req</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">restart</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hs_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: nothing to complete?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;complete: ep %p %s, req %p, %d =&gt; %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hs_ep</span><span class="p">,</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">hs_req</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * only replace the status if we&#39;ve not already set an error</span>
<span class="cm">	 * from a previous transaction</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
		<span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">using_dma</span><span class="p">(</span><span class="n">hsotg</span><span class="p">))</span>
		<span class="n">s3c_hsotg_unmap_dma</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">hs_ep</span><span class="p">,</span> <span class="n">hs_req</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * call the complete request with the locks off, just in case the</span>
<span class="cm">	 * request tries to queue more work for this endpoint.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Look to see if there is anything else to do. Note, the completion</span>
<span class="cm">	 * of the previous request may have caused a new request to be started</span>
<span class="cm">	 * so be careful when doing this.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">restart</span> <span class="o">=</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hs_req</span> <span class="o">=</span> <span class="n">get_ep_head</span><span class="p">(</span><span class="n">hs_ep</span><span class="p">);</span>
			<span class="n">s3c_hsotg_start_req</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">hs_ep</span><span class="p">,</span> <span class="n">hs_req</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_complete_request_lock - complete a request given to us (locked)</span>
<span class="cm"> * @hsotg: The device state.</span>
<span class="cm"> * @hs_ep: The endpoint the request was on.</span>
<span class="cm"> * @hs_req: The request to complete.</span>
<span class="cm"> * @result: The result code (0 =&gt; Ok, otherwise errno)</span>
<span class="cm"> *</span>
<span class="cm"> * See s3c_hsotg_complete_request(), but called with the endpoint&#39;s</span>
<span class="cm"> * lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_complete_request_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">hs_req</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">s3c_hsotg_complete_request</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">hs_ep</span><span class="p">,</span> <span class="n">hs_req</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_rx_data - receive data from the FIFO for an endpoint</span>
<span class="cm"> * @hsotg: The device state.</span>
<span class="cm"> * @ep_idx: The endpoint index for the data</span>
<span class="cm"> * @size: The size of data in the fifo, in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * The FIFO status shows there is data to read from the FIFO for a given</span>
<span class="cm"> * endpoint, so sort out whether we need to read the data into a request</span>
<span class="cm"> * that has been made for that endpoint.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_rx_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ep_idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">ep_idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">hs_req</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">EPFIFO</span><span class="p">(</span><span class="n">ep_idx</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">to_read</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">read_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hs_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">epctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPCTL</span><span class="p">(</span><span class="n">ep_idx</span><span class="p">));</span>
		<span class="kt">int</span> <span class="n">ptr</span><span class="p">;</span>

		<span class="n">dev_warn</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%s: FIFO %d bytes on ep%d but no req (DxEPCTl=0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ep_idx</span><span class="p">,</span> <span class="n">epctl</span><span class="p">);</span>

		<span class="cm">/* dump the data from the FIFO, we&#39;ve nothing we can do */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">fifo</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">to_read</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">read_ptr</span> <span class="o">=</span> <span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">max_req</span> <span class="o">=</span> <span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">read_ptr</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: read %d/%d, done %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">to_read</span><span class="p">,</span> <span class="n">max_req</span><span class="p">,</span> <span class="n">read_ptr</span><span class="p">,</span> <span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">to_read</span> <span class="o">&gt;</span> <span class="n">max_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * more data appeared than we where willing</span>
<span class="cm">		 * to deal with in this request.</span>
<span class="cm">		 */</span>

		<span class="cm">/* currently we don&#39;t deal this */</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">total_data</span> <span class="o">+=</span> <span class="n">to_read</span><span class="p">;</span>
	<span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">to_read</span><span class="p">;</span>
	<span class="n">to_read</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">to_read</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * note, we might over-write the buffer end by 3 bytes depending on</span>
<span class="cm">	 * alignment of the data.</span>
<span class="cm">	 */</span>
	<span class="n">readsl</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">read_ptr</span><span class="p">,</span> <span class="n">to_read</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_send_zlp - send zero-length packet on control endpoint</span>
<span class="cm"> * @hsotg: The device instance</span>
<span class="cm"> * @req: The request currently on this endpoint</span>
<span class="cm"> *</span>
<span class="cm"> * Generate a zero-length IN packet request for terminating a SETUP</span>
<span class="cm"> * transaction.</span>
<span class="cm"> *</span>
<span class="cm"> * Note, since we don&#39;t write any data to the TxFIFO, then it is</span>
<span class="cm"> * currently believed that we do not need to wait for any space in</span>
<span class="cm"> * the TxFIFO.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_send_zlp</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: no request?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sent_zlp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s3c_hsotg_enqueue_setup</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dir_in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sent_zlp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sending zero-length packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* issue a zero-sized packet to terminate this */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">DxEPTSIZ_MC</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">DxEPTSIZ_PktCnt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">DxEPTSIZ_XferSize</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPTSIZ</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPCTL0</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_CNAK</span><span class="p">;</span>  <span class="cm">/* clear NAK set by core */</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_EPEna</span><span class="p">;</span> <span class="cm">/* ensure ep enabled */</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_USBActEp</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPCTL0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_handle_outdone - handle receiving OutDone/SetupDone from RXFIFO</span>
<span class="cm"> * @hsotg: The device instance</span>
<span class="cm"> * @epnum: The endpoint received from</span>
<span class="cm"> * @was_setup: Set if processing a SetupDone event.</span>
<span class="cm"> *</span>
<span class="cm"> * The RXFIFO has delivered an OutDone event, which means that the data</span>
<span class="cm"> * transfer for an OUT endpoint has been completed, either by a short</span>
<span class="cm"> * packet or by the finish of a transfer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_handle_outdone</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">epnum</span><span class="p">,</span> <span class="n">bool</span> <span class="n">was_setup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">epsize</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPTSIZ</span><span class="p">(</span><span class="n">epnum</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">epnum</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">hs_req</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">size_left</span> <span class="o">=</span> <span class="n">DxEPTSIZ_XferSize_GET</span><span class="p">(</span><span class="n">epsize</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hs_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: no request active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">using_dma</span><span class="p">(</span><span class="n">hsotg</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">size_done</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Calculate the size of the transfer by checking how much</span>
<span class="cm">		 * is left in the endpoint size register and then working it</span>
<span class="cm">		 * out from the amount we loaded for the transfer.</span>
<span class="cm">		 *</span>
<span class="cm">		 * We need to do this as DMA pointers are always 32bit aligned</span>
<span class="cm">		 * so may overshoot/undershoot the transfer.</span>
<span class="cm">		 */</span>

		<span class="n">size_done</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">size_loaded</span> <span class="o">-</span> <span class="n">size_left</span><span class="p">;</span>
		<span class="n">size_done</span> <span class="o">+=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">last_load</span><span class="p">;</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">=</span> <span class="n">size_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if there is more request to do, schedule new transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">size_left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s3c_hsotg_start_req</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">hs_ep</span><span class="p">,</span> <span class="n">hs_req</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">epnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * After was_setup = 1 =&gt;</span>
<span class="cm">		 * set CNAK for non Setup requests</span>
<span class="cm">		 */</span>
		<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="o">=</span> <span class="n">was_setup</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">short_not_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: got %d/%d (short not ok) =&gt; error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * todo - what should we return here? there&#39;s no one else</span>
<span class="cm">		 * even bothering to check the status.</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">epnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Condition req-&gt;complete != s3c_hsotg_complete_setup says:</span>
<span class="cm">		 * send ZLP when we have an asynchronous request from gadget</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">was_setup</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">!=</span> <span class="n">s3c_hsotg_complete_setup</span><span class="p">)</span>
			<span class="n">s3c_hsotg_send_zlp</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">hs_req</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">s3c_hsotg_complete_request_lock</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">hs_ep</span><span class="p">,</span> <span class="n">hs_req</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_read_frameno - read current frame number</span>
<span class="cm"> * @hsotg: The device instance</span>
<span class="cm"> *</span>
<span class="cm"> * Return the current frame number</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">s3c_hsotg_read_frameno</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dsts</span><span class="p">;</span>

	<span class="n">dsts</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DSTS</span><span class="p">);</span>
	<span class="n">dsts</span> <span class="o">&amp;=</span> <span class="n">DSTS_SOFFN_MASK</span><span class="p">;</span>
	<span class="n">dsts</span> <span class="o">&gt;&gt;=</span> <span class="n">DSTS_SOFFN_SHIFT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dsts</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_handle_rx - RX FIFO has data</span>
<span class="cm"> * @hsotg: The device instance</span>
<span class="cm"> *</span>
<span class="cm"> * The IRQ handler has detected that the RX FIFO has some data in it</span>
<span class="cm"> * that requires processing, so find out what is in there and do the</span>
<span class="cm"> * appropriate read.</span>
<span class="cm"> *</span>
<span class="cm"> * The RXFIFO is a true FIFO, the packets coming out are still in packet</span>
<span class="cm"> * chunks, so if you have x packets received on an endpoint you&#39;ll get x</span>
<span class="cm"> * FIFO events delivered, each with a packet&#39;s worth of data in it.</span>
<span class="cm"> *</span>
<span class="cm"> * When using DMA, we should not be processing events from the RXFIFO</span>
<span class="cm"> * as the actual data should be sent to the memory directly and we turn</span>
<span class="cm"> * on the completion interrupts to get notifications of transfer completion.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_handle_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">grxstsr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GRXSTSP</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">epnum</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">using_dma</span><span class="p">(</span><span class="n">hsotg</span><span class="p">));</span>

	<span class="n">epnum</span> <span class="o">=</span> <span class="n">grxstsr</span> <span class="o">&amp;</span> <span class="n">GRXSTS_EPNum_MASK</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">grxstsr</span> <span class="o">&amp;</span> <span class="n">GRXSTS_PktSts_MASK</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">grxstsr</span> <span class="o">&amp;</span> <span class="n">GRXSTS_ByteCnt_MASK</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="n">GRXSTS_ByteCnt_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: GRXSTSP=0x%08x (%d@%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">grxstsr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">epnum</span><span class="p">);</span>

<span class="cp">#define __status(x) ((x) &gt;&gt; GRXSTS_PktSts_SHIFT)</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="n">GRXSTS_PktSts_SHIFT</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">__status</span><span class="p">(</span><span class="n">GRXSTS_PktSts_GlobalOutNAK</span><span class="p">)</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GlobalOutNAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">__status</span><span class="p">(</span><span class="n">GRXSTS_PktSts_OutDone</span><span class="p">)</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OutDone (Frame=0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">s3c_hsotg_read_frameno</span><span class="p">(</span><span class="n">hsotg</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">using_dma</span><span class="p">(</span><span class="n">hsotg</span><span class="p">))</span>
			<span class="n">s3c_hsotg_handle_outdone</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">epnum</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">__status</span><span class="p">(</span><span class="n">GRXSTS_PktSts_SetupDone</span><span class="p">)</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;SetupDone (Frame=0x%08x, DOPEPCTL=0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">s3c_hsotg_read_frameno</span><span class="p">(</span><span class="n">hsotg</span><span class="p">),</span>
			<span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPCTL</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>

		<span class="n">s3c_hsotg_handle_outdone</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">epnum</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">__status</span><span class="p">(</span><span class="n">GRXSTS_PktSts_OutRX</span><span class="p">)</span>:
		<span class="n">s3c_hsotg_rx_data</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">epnum</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">__status</span><span class="p">(</span><span class="n">GRXSTS_PktSts_SetupRX</span><span class="p">)</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;SetupRX (Frame=0x%08x, DOPEPCTL=0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">s3c_hsotg_read_frameno</span><span class="p">(</span><span class="n">hsotg</span><span class="p">),</span>
			<span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPCTL</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>

		<span class="n">s3c_hsotg_rx_data</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">epnum</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: unknown status %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">grxstsr</span><span class="p">);</span>

		<span class="n">s3c_hsotg_dump</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_ep0_mps - turn max packet size into register setting</span>
<span class="cm"> * @mps: The maximum packet size in bytes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">s3c_hsotg_ep0_mps</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mps</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">64</span>:
		<span class="k">return</span> <span class="n">D0EPCTL_MPS_64</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="k">return</span> <span class="n">D0EPCTL_MPS_32</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">return</span> <span class="n">D0EPCTL_MPS_16</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">return</span> <span class="n">D0EPCTL_MPS_8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* bad max packet size, warn and return invalid result */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_set_ep_maxpacket - set endpoint&#39;s max-packet field</span>
<span class="cm"> * @hsotg: The driver state.</span>
<span class="cm"> * @ep: The index number of the endpoint</span>
<span class="cm"> * @mps: The maximum packet size in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Configure the maximum packet size for the given endpoint, updating</span>
<span class="cm"> * the hardware control registers to reflect this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_set_ep_maxpacket</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ep</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">ep</span><span class="p">];</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mpsval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* EP0 is a special case */</span>
		<span class="n">mpsval</span> <span class="o">=</span> <span class="n">s3c_hsotg_ep0_mps</span><span class="p">(</span><span class="n">mps</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpsval</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad_mps</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mps</span> <span class="o">&gt;=</span> <span class="n">DxEPCTL_MPS_LIMIT</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad_mps</span><span class="p">;</span>

		<span class="n">mpsval</span> <span class="o">=</span> <span class="n">mps</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">mps</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * update both the in and out endpoint controldir_ registers, even</span>
<span class="cm">	 * if one of the directions may not be in use.</span>
<span class="cm">	 */</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPCTL</span><span class="p">(</span><span class="n">ep</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DxEPCTL_MPS_MASK</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">mpsval</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPCTL</span><span class="p">(</span><span class="n">ep</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPCTL</span><span class="p">(</span><span class="n">ep</span><span class="p">));</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DxEPCTL_MPS_MASK</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">mpsval</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPCTL</span><span class="p">(</span><span class="n">ep</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">bad_mps:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ep%d: bad mps of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">mps</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_txfifo_flush - flush Tx FIFO</span>
<span class="cm"> * @hsotg: The driver state</span>
<span class="cm"> * @idx: The index for the endpoint (0..15)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_txfifo_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">GRSTCTL_TxFNum</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">|</span> <span class="n">GRSTCTL_TxFFlsh</span><span class="p">,</span>
		<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GRSTCTL</span><span class="p">);</span>

	<span class="cm">/* wait until the fifo is flushed */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GRSTCTL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GRSTCTL_TxFFlsh</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: timeout flushing fifo (GRSTCTL=%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_trytx - check to see if anything needs transmitting</span>
<span class="cm"> * @hsotg: The driver state</span>
<span class="cm"> * @hs_ep: The driver endpoint to check.</span>
<span class="cm"> *</span>
<span class="cm"> * Check to see if there is a request that has data to send, and if so</span>
<span class="cm"> * make an attempt to write data into the FIFO.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsotg_trytx</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">hs_req</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">dir_in</span> <span class="o">||</span> <span class="o">!</span><span class="n">hs_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">&lt;</span> <span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;trying to write more for ep%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">s3c_hsotg_write_fifo</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">hs_ep</span><span class="p">,</span> <span class="n">hs_req</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_complete_in - complete IN transfer</span>
<span class="cm"> * @hsotg: The device state.</span>
<span class="cm"> * @hs_ep: The endpoint that has just completed.</span>
<span class="cm"> *</span>
<span class="cm"> * An IN transfer has been completed, update the transfer&#39;s state and then</span>
<span class="cm"> * call the relevant completion routines.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_complete_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">hs_req</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">epsize</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPTSIZ</span><span class="p">(</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">size_left</span><span class="p">,</span> <span class="n">size_done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hs_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;XferCompl but no req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Finish ZLP handling for IN EP0 transactions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sent_zlp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;zlp packet received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">s3c_hsotg_complete_request_lock</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">hs_ep</span><span class="p">,</span> <span class="n">hs_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Calculate the size of the transfer by checking how much is left</span>
<span class="cm">	 * in the endpoint size register and then working it out from</span>
<span class="cm">	 * the amount we loaded for the transfer.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We do this even for DMA, as the transfer may have incremented</span>
<span class="cm">	 * past the end of the buffer (DMA transfers are always 32bit</span>
<span class="cm">	 * aligned).</span>
<span class="cm">	 */</span>

	<span class="n">size_left</span> <span class="o">=</span> <span class="n">DxEPTSIZ_XferSize_GET</span><span class="p">(</span><span class="n">epsize</span><span class="p">);</span>

	<span class="n">size_done</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">size_loaded</span> <span class="o">-</span> <span class="n">size_left</span><span class="p">;</span>
	<span class="n">size_done</span> <span class="o">+=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">last_load</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">!=</span> <span class="n">size_done</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: adjusting size done %d =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">size_done</span><span class="p">);</span>

	<span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">size_done</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;req-&gt;length:%d req-&gt;actual:%d req-&gt;zero:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if dealing with Maximum Packet Size(MPS) IN transfer at EP0</span>
<span class="cm">	 * When sent data is a multiple MPS size (e.g. 64B ,128B ,192B</span>
<span class="cm">	 * ,256B ... ), after last MPS sized packet send IN ZLP packet to</span>
<span class="cm">	 * inform the host that no more data is available.</span>
<span class="cm">	 * The state of req.zero member is checked to be sure that the value to</span>
<span class="cm">	 * send is smaller than wValue expected from host.</span>
<span class="cm">	 * Check req.length to NOT send another ZLP when the current one is</span>
<span class="cm">	 * under completion (the one for which this completion has been called).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">%</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ep0 zlp IN packet sent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">s3c_hsotg_send_zlp</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">hs_req</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size_left</span> <span class="o">&amp;&amp;</span> <span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">&lt;</span> <span class="n">hs_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s trying more for req...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">s3c_hsotg_start_req</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">hs_ep</span><span class="p">,</span> <span class="n">hs_req</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">s3c_hsotg_complete_request_lock</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">hs_ep</span><span class="p">,</span> <span class="n">hs_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_epint - handle an in/out endpoint interrupt</span>
<span class="cm"> * @hsotg: The driver state</span>
<span class="cm"> * @idx: The index for the endpoint (0..15)</span>
<span class="cm"> * @dir_in: Set if this is an IN endpoint</span>
<span class="cm"> *</span>
<span class="cm"> * Process and clear any interrupt pending for an individual endpoint</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_epint</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">dir_in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">epint_reg</span> <span class="o">=</span> <span class="n">dir_in</span> <span class="o">?</span> <span class="n">DIEPINT</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">:</span> <span class="n">DOEPINT</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">epctl_reg</span> <span class="o">=</span> <span class="n">dir_in</span> <span class="o">?</span> <span class="n">DIEPCTL</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">:</span> <span class="n">DOEPCTL</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">epsiz_reg</span> <span class="o">=</span> <span class="n">dir_in</span> <span class="o">?</span> <span class="n">DIEPTSIZ</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">:</span> <span class="n">DOEPTSIZ</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ints</span><span class="p">;</span>

	<span class="n">ints</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epint_reg</span><span class="p">);</span>

	<span class="cm">/* Clear endpoint interrupts */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ints</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epint_reg</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ep%d(%s) DxEPINT=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">dir_in</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">,</span> <span class="n">ints</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ints</span> <span class="o">&amp;</span> <span class="n">DxEPINT_XferCompl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: XferCompl: DxEPCTL=0x%08x, DxEPTSIZ=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epctl_reg</span><span class="p">),</span>
			<span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epsiz_reg</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * we get OutDone from the FIFO, so we only need to look</span>
<span class="cm">		 * at completing IN requests here</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dir_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s3c_hsotg_complete_in</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">hs_ep</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">)</span>
				<span class="n">s3c_hsotg_enqueue_setup</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">using_dma</span><span class="p">(</span><span class="n">hsotg</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We&#39;re using DMA, we need to fire an OutDone here</span>
<span class="cm">			 * as we ignore the RXFIFO.</span>
<span class="cm">			 */</span>

			<span class="n">s3c_hsotg_handle_outdone</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ints</span> <span class="o">&amp;</span> <span class="n">DxEPINT_EPDisbld</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: EPDisbld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dir_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">epctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epctl_reg</span><span class="p">);</span>

			<span class="n">s3c_hsotg_txfifo_flush</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">epctl</span> <span class="o">&amp;</span> <span class="n">DxEPCTL_Stall</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">epctl</span> <span class="o">&amp;</span> <span class="n">DxEPCTL_EPType_Bulk</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">dctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCTL</span><span class="p">);</span>

				<span class="n">dctl</span> <span class="o">|=</span> <span class="n">DCTL_CGNPInNAK</span><span class="p">;</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">dctl</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCTL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ints</span> <span class="o">&amp;</span> <span class="n">DxEPINT_AHBErr</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: AHBErr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ints</span> <span class="o">&amp;</span> <span class="n">DxEPINT_Setup</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* Setup or Timeout */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Setup/Timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">__func__</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">using_dma</span><span class="p">(</span><span class="n">hsotg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * this is the notification we&#39;ve received a</span>
<span class="cm">			 * setup packet. In non-DMA mode we&#39;d get this</span>
<span class="cm">			 * from the RXFIFO, instead we need to process</span>
<span class="cm">			 * the setup here.</span>
<span class="cm">			 */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dir_in</span><span class="p">)</span>
				<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">s3c_hsotg_handle_outdone</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ints</span> <span class="o">&amp;</span> <span class="n">DxEPINT_Back2BackSetup</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: B2BSetup/INEPNakEff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* not sure if this is important, but we&#39;ll clear it anyway */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ints</span> <span class="o">&amp;</span> <span class="n">DIEPMSK_INTknTXFEmpMsk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ep%d: INTknTXFEmpMsk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* this probably means something bad is happening */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ints</span> <span class="o">&amp;</span> <span class="n">DIEPMSK_INTknEPMisMsk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ep%d: INTknEP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* FIFO has space or is empty (see GAHBCFG) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dedicated_fifos</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ints</span> <span class="o">&amp;</span> <span class="n">DIEPMSK_TxFIFOEmpty</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ep%d: TxFIFOEmpty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">using_dma</span><span class="p">(</span><span class="n">hsotg</span><span class="p">))</span>
				<span class="n">s3c_hsotg_trytx</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">hs_ep</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_irq_enumdone - Handle EnumDone interrupt (enumeration done)</span>
<span class="cm"> * @hsotg: The device state.</span>
<span class="cm"> *</span>
<span class="cm"> * Handle updating the device settings after the enumeration phase has</span>
<span class="cm"> * been completed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_irq_enumdone</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dsts</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DSTS</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ep0_mps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ep_mps</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This should signal the finish of the enumeration phase</span>
<span class="cm">	 * of the USB handshaking, so we should now know what rate</span>
<span class="cm">	 * we connected at.</span>
<span class="cm">	 */</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;EnumDone (DSTS=0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dsts</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * note, since we&#39;re limited by the size of transfer on EP0, and</span>
<span class="cm">	 * it seems IN transfers must be a even number of packets we do</span>
<span class="cm">	 * not advertise a 64byte MPS on EP0.</span>
<span class="cm">	 */</span>

	<span class="cm">/* catch both EnumSpd_FS and EnumSpd_FS48 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dsts</span> <span class="o">&amp;</span> <span class="n">DSTS_EnumSpd_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DSTS_EnumSpd_FS</span>:
	<span class="k">case</span> <span class="n">DSTS_EnumSpd_FS48</span>:
		<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
		<span class="n">ep0_mps</span> <span class="o">=</span> <span class="n">EP0_MPS_LIMIT</span><span class="p">;</span>
		<span class="n">ep_mps</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSTS_EnumSpd_HS</span>:
		<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">;</span>
		<span class="n">ep0_mps</span> <span class="o">=</span> <span class="n">EP0_MPS_LIMIT</span><span class="p">;</span>
		<span class="n">ep_mps</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSTS_EnumSpd_LS</span>:
		<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_LOW</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * note, we don&#39;t actually support LS in this driver at the</span>
<span class="cm">		 * moment, and the documentation seems to imply that it isn&#39;t</span>
<span class="cm">		 * supported by the PHYs on some of the devices.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;new device is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">usb_speed_string</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * we should now know the maximum packet size for an</span>
<span class="cm">	 * endpoint, so set the endpoints to a default value.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep0_mps</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">s3c_hsotg_set_ep_maxpacket</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ep0_mps</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">num_of_eps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">s3c_hsotg_set_ep_maxpacket</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ep_mps</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ensure after enumeration our EP0 is active */</span>

	<span class="n">s3c_hsotg_enqueue_setup</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;EP0: DIEPCTL0=0x%08x, DOEPCTL0=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPCTL0</span><span class="p">),</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPCTL0</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * kill_all_requests - remove all requests from the endpoint&#39;s queue</span>
<span class="cm"> * @hsotg: The device state.</span>
<span class="cm"> * @ep: The endpoint the requests may be on.</span>
<span class="cm"> * @result: The result code to use.</span>
<span class="cm"> * @force: Force removal of any current requests</span>
<span class="cm"> *</span>
<span class="cm"> * Go through the requests on the given endpoint and mark them</span>
<span class="cm"> * completed with the given result code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">kill_all_requests</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="o">*</span><span class="n">treq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">treq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * currently, we can&#39;t do much about an already</span>
<span class="cm">		 * running request on an in endpoint</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">==</span> <span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir_in</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">force</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">s3c_hsotg_complete_request</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
					   <span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define call_gadget(_hs, _entry) \</span>
<span class="cp">	if ((_hs)-&gt;gadget.speed != USB_SPEED_UNKNOWN &amp;&amp;	\</span>
<span class="cp">	    (_hs)-&gt;driver &amp;&amp; (_hs)-&gt;driver-&gt;_entry)	\</span>
<span class="cp">		(_hs)-&gt;driver-&gt;_entry(&amp;(_hs)-&gt;gadget);</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_disconnect - disconnect service</span>
<span class="cm"> * @hsotg: The device state.</span>
<span class="cm"> *</span>
<span class="cm"> * The device has been disconnected. Remove all current</span>
<span class="cm"> * transactions and signal the gadget driver that this</span>
<span class="cm"> * has happened.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">ep</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ep</span> <span class="o">&lt;</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">num_of_eps</span><span class="p">;</span> <span class="n">ep</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kill_all_requests</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">ep</span><span class="p">],</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">call_gadget</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">disconnect</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_irq_fifoempty - TX FIFO empty interrupt handler</span>
<span class="cm"> * @hsotg: The device state:</span>
<span class="cm"> * @periodic: True if this is a periodic FIFO interrupt</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_irq_fifoempty</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">bool</span> <span class="n">periodic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">epno</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* look through for any more data to transmit */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">epno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">epno</span> <span class="o">&lt;</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">num_of_eps</span><span class="p">;</span> <span class="n">epno</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">epno</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir_in</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">periodic</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">periodic</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">periodic</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">periodic</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">s3c_hsotg_trytx</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* IRQ flags which will trigger a retry around the IRQ loop */</span>
<span class="cp">#define IRQ_RETRY_MASK (GINTSTS_NPTxFEmp | \</span>
<span class="cp">			GINTSTS_PTxFEmp |  \</span>
<span class="cp">			GINTSTS_RxFLvl)</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_corereset - issue softreset to the core</span>
<span class="cm"> * @hsotg: The device state</span>
<span class="cm"> *</span>
<span class="cm"> * Issue a soft reset to the core, and await the core finishing it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsotg_corereset</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">grstctl</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resetting core</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* issue soft reset */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">GRSTCTL_CSftRst</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GRSTCTL</span><span class="p">);</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">grstctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GRSTCTL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">grstctl</span> <span class="o">&amp;</span> <span class="n">GRSTCTL_CSftRst</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">grstctl</span> <span class="o">&amp;</span> <span class="n">GRSTCTL_CSftRst</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to get CSftRst asserted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">grstctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GRSTCTL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;%s: reset failed, GRSTCTL=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">grstctl</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">grstctl</span> <span class="o">&amp;</span> <span class="n">GRSTCTL_AHBIdle</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>		<span class="cm">/* reset done */</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reset successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_core_init - issue softreset to the core</span>
<span class="cm"> * @hsotg: The device state</span>
<span class="cm"> *</span>
<span class="cm"> * Issue a soft reset to the core, and await the core finishing it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_core_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s3c_hsotg_corereset</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * we must now enable ep0 ready for host detection and then</span>
<span class="cm">	 * set configuration.</span>
<span class="cm">	 */</span>

	<span class="cm">/* set the PLL on, remove the HNP/SRP and set the PHY */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">GUSBCFG_PHYIf16</span> <span class="o">|</span> <span class="n">GUSBCFG_TOutCal</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">),</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GUSBCFG</span><span class="p">);</span>

	<span class="n">s3c_hsotg_init_fifo</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>

	<span class="n">__orr32</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCTL</span><span class="p">,</span> <span class="n">DCTL_SftDiscon</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span> <span class="o">|</span> <span class="n">DCFG_DevSpd_HS</span><span class="p">,</span>  <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCFG</span><span class="p">);</span>

	<span class="cm">/* Clear any pending OTG interrupts */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GOTGINT</span><span class="p">);</span>

	<span class="cm">/* Clear any pending interrupts */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTSTS</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">GINTSTS_ErlySusp</span> <span class="o">|</span> <span class="n">GINTSTS_SessReqInt</span> <span class="o">|</span>
	       <span class="n">GINTSTS_GOUTNakEff</span> <span class="o">|</span> <span class="n">GINTSTS_GINNakEff</span> <span class="o">|</span>
	       <span class="n">GINTSTS_ConIDStsChng</span> <span class="o">|</span> <span class="n">GINTSTS_USBRst</span> <span class="o">|</span>
	       <span class="n">GINTSTS_EnumDone</span> <span class="o">|</span> <span class="n">GINTSTS_OTGInt</span> <span class="o">|</span>
	       <span class="n">GINTSTS_USBSusp</span> <span class="o">|</span> <span class="n">GINTSTS_WkUpInt</span><span class="p">,</span>
	       <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTMSK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">using_dma</span><span class="p">(</span><span class="n">hsotg</span><span class="p">))</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">GAHBCFG_GlblIntrEn</span> <span class="o">|</span> <span class="n">GAHBCFG_DMAEn</span> <span class="o">|</span>
		       <span class="n">GAHBCFG_HBstLen_Incr4</span><span class="p">,</span>
		       <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GAHBCFG</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">GAHBCFG_GlblIntrEn</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GAHBCFG</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enabling INTknTXFEmpMsk here seems to be a big mistake, we end</span>
<span class="cm">	 * up being flooded with interrupts if the host is polling the</span>
<span class="cm">	 * endpoint to try and read data.</span>
<span class="cm">	 */</span>

	<span class="n">writel</span><span class="p">(((</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dedicated_fifos</span><span class="p">)</span> <span class="o">?</span> <span class="n">DIEPMSK_TxFIFOEmpty</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">DIEPMSK_EPDisbldMsk</span> <span class="o">|</span> <span class="n">DIEPMSK_XferComplMsk</span> <span class="o">|</span>
	       <span class="n">DIEPMSK_TimeOUTMsk</span> <span class="o">|</span> <span class="n">DIEPMSK_AHBErrMsk</span> <span class="o">|</span>
	       <span class="n">DIEPMSK_INTknEPMisMsk</span><span class="p">,</span>
	       <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPMSK</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * don&#39;t need XferCompl, we get that from RXFIFO in slave mode. In</span>
<span class="cm">	 * DMA mode we may need this.</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">using_dma</span><span class="p">(</span><span class="n">hsotg</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">DIEPMSK_XferComplMsk</span> <span class="o">|</span>
				    <span class="n">DIEPMSK_TimeOUTMsk</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">DOEPMSK_EPDisbldMsk</span> <span class="o">|</span> <span class="n">DOEPMSK_AHBErrMsk</span> <span class="o">|</span>
	       <span class="n">DOEPMSK_SetupMsk</span><span class="p">,</span>
	       <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPMSK</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DAINTMSK</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;EP0: DIEPCTL0=0x%08x, DOEPCTL0=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPCTL0</span><span class="p">),</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPCTL0</span><span class="p">));</span>

	<span class="cm">/* enable in and out endpoint interrupts */</span>
	<span class="n">s3c_hsotg_en_gsint</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">GINTSTS_OEPInt</span> <span class="o">|</span> <span class="n">GINTSTS_IEPInt</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable the RXFIFO when in slave mode, as this is how we collect</span>
<span class="cm">	 * the data. In DMA mode, we get events from the FIFO but also</span>
<span class="cm">	 * things we cannot process, so do not use it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">using_dma</span><span class="p">(</span><span class="n">hsotg</span><span class="p">))</span>
		<span class="n">s3c_hsotg_en_gsint</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">GINTSTS_RxFLvl</span><span class="p">);</span>

	<span class="cm">/* Enable interrupts for EP0 in and out */</span>
	<span class="n">s3c_hsotg_ctrl_epint</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">s3c_hsotg_ctrl_epint</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">__orr32</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCTL</span><span class="p">,</span> <span class="n">DCTL_PWROnPrgDone</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>  <span class="cm">/* see openiboot */</span>
	<span class="n">__bic32</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCTL</span><span class="p">,</span> <span class="n">DCTL_PWROnPrgDone</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DCTL=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCTL</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * DxEPCTL_USBActEp says RO in manual, but seems to be set by</span>
<span class="cm">	 * writing to the EPCTL register..</span>
<span class="cm">	 */</span>

	<span class="cm">/* set to read 1 8byte packet */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">DxEPTSIZ_MC</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">DxEPTSIZ_PktCnt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">DxEPTSIZ_XferSize</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPTSIZ0</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">s3c_hsotg_ep0_mps</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">DxEPCTL_CNAK</span> <span class="o">|</span> <span class="n">DxEPCTL_EPEna</span> <span class="o">|</span>
	       <span class="n">DxEPCTL_USBActEp</span><span class="p">,</span>
	       <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPCTL0</span><span class="p">);</span>

	<span class="cm">/* enable, but don&#39;t activate EP0in */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">s3c_hsotg_ep0_mps</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">DxEPCTL_USBActEp</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPCTL0</span><span class="p">);</span>

	<span class="n">s3c_hsotg_enqueue_setup</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;EP0: DIEPCTL0=0x%08x, DOEPCTL0=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPCTL0</span><span class="p">),</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPCTL0</span><span class="p">));</span>

	<span class="cm">/* clear global NAKs */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">DCTL_CGOUTNak</span> <span class="o">|</span> <span class="n">DCTL_CGNPInNAK</span><span class="p">,</span>
	       <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCTL</span><span class="p">);</span>

	<span class="cm">/* must be at-least 3ms to allow bus to see disconnect */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* remove the soft-disconnect and let&#39;s go */</span>
	<span class="n">__bic32</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCTL</span><span class="p">,</span> <span class="n">DCTL_SftDiscon</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_irq - handle device interrupt</span>
<span class="cm"> * @irq: The IRQ number triggered</span>
<span class="cm"> * @pw: The pw value when registered the handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">s3c_hsotg_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span> <span class="o">=</span> <span class="n">pw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gintsts</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gintmsk</span><span class="p">;</span>

<span class="nl">irq_retry:</span>
	<span class="n">gintsts</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTSTS</span><span class="p">);</span>
	<span class="n">gintmsk</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTMSK</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %08x %08x (%08x) retry %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">gintsts</span><span class="p">,</span> <span class="n">gintsts</span> <span class="o">&amp;</span> <span class="n">gintmsk</span><span class="p">,</span> <span class="n">gintmsk</span><span class="p">,</span> <span class="n">retry_count</span><span class="p">);</span>

	<span class="n">gintsts</span> <span class="o">&amp;=</span> <span class="n">gintmsk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gintsts</span> <span class="o">&amp;</span> <span class="n">GINTSTS_OTGInt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">otgint</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GOTGINT</span><span class="p">);</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OTGInt: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">otgint</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">otgint</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GOTGINT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gintsts</span> <span class="o">&amp;</span> <span class="n">GINTSTS_SessReqInt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: SessReqInt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">GINTSTS_SessReqInt</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTSTS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gintsts</span> <span class="o">&amp;</span> <span class="n">GINTSTS_EnumDone</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">GINTSTS_EnumDone</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTSTS</span><span class="p">);</span>

		<span class="n">s3c_hsotg_irq_enumdone</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gintsts</span> <span class="o">&amp;</span> <span class="n">GINTSTS_ConIDStsChng</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ConIDStsChg (DSTS=0x%08x, GOTCTL=%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DSTS</span><span class="p">),</span>
			<span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GOTGCTL</span><span class="p">));</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">GINTSTS_ConIDStsChng</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTSTS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gintsts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GINTSTS_OEPInt</span> <span class="o">|</span> <span class="n">GINTSTS_IEPInt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">daint</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DAINT</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">daint_out</span> <span class="o">=</span> <span class="n">daint</span> <span class="o">&gt;&gt;</span> <span class="n">DAINT_OutEP_SHIFT</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">daint_in</span> <span class="o">=</span> <span class="n">daint</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">daint_out</span> <span class="o">&lt;&lt;</span> <span class="n">DAINT_OutEP_SHIFT</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">ep</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: daint=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">daint</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ep</span> <span class="o">&lt;</span> <span class="mi">15</span> <span class="o">&amp;&amp;</span> <span class="n">daint_out</span><span class="p">;</span> <span class="n">ep</span><span class="o">++</span><span class="p">,</span> <span class="n">daint_out</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">daint_out</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">s3c_hsotg_epint</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ep</span> <span class="o">&lt;</span> <span class="mi">15</span> <span class="o">&amp;&amp;</span> <span class="n">daint_in</span><span class="p">;</span> <span class="n">ep</span><span class="o">++</span><span class="p">,</span> <span class="n">daint_in</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">daint_in</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">s3c_hsotg_epint</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gintsts</span> <span class="o">&amp;</span> <span class="n">GINTSTS_USBRst</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">u32</span> <span class="n">usb_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GOTGCTL</span><span class="p">);</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: USBRst</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GNPTXSTS=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GNPTXSTS</span><span class="p">));</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">GINTSTS_USBRst</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTSTS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">usb_status</span> <span class="o">&amp;</span> <span class="n">GOTGCTL_BSESVLD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">last_rst</span> <span class="o">+</span>
				       <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">200</span><span class="p">)))</span> <span class="p">{</span>

				<span class="n">kill_all_requests</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
							  <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

				<span class="n">s3c_hsotg_core_init</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
				<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">last_rst</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* check both FIFOs */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gintsts</span> <span class="o">&amp;</span> <span class="n">GINTSTS_NPTxFEmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NPTxFEmp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Disable the interrupt to stop it happening again</span>
<span class="cm">		 * unless one of these endpoint routines decides that</span>
<span class="cm">		 * it needs re-enabling</span>
<span class="cm">		 */</span>

		<span class="n">s3c_hsotg_disable_gsint</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">GINTSTS_NPTxFEmp</span><span class="p">);</span>
		<span class="n">s3c_hsotg_irq_fifoempty</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gintsts</span> <span class="o">&amp;</span> <span class="n">GINTSTS_PTxFEmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PTxFEmp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* See note in GINTSTS_NPTxFEmp */</span>

		<span class="n">s3c_hsotg_disable_gsint</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">GINTSTS_PTxFEmp</span><span class="p">);</span>
		<span class="n">s3c_hsotg_irq_fifoempty</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gintsts</span> <span class="o">&amp;</span> <span class="n">GINTSTS_RxFLvl</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * note, since GINTSTS_RxFLvl doubles as FIFO-not-empty,</span>
<span class="cm">		 * we need to retry s3c_hsotg_handle_rx if this is still</span>
<span class="cm">		 * set.</span>
<span class="cm">		 */</span>

		<span class="n">s3c_hsotg_handle_rx</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gintsts</span> <span class="o">&amp;</span> <span class="n">GINTSTS_ModeMis</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;warning, mode mismatch triggered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">GINTSTS_ModeMis</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTSTS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gintsts</span> <span class="o">&amp;</span> <span class="n">GINTSTS_USBSusp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GINTSTS_USBSusp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">GINTSTS_USBSusp</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTSTS</span><span class="p">);</span>

		<span class="n">call_gadget</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">suspend</span><span class="p">);</span>
		<span class="n">s3c_hsotg_disconnect</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gintsts</span> <span class="o">&amp;</span> <span class="n">GINTSTS_WkUpInt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GINTSTS_WkUpIn</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">GINTSTS_WkUpInt</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTSTS</span><span class="p">);</span>

		<span class="n">call_gadget</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">resume</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gintsts</span> <span class="o">&amp;</span> <span class="n">GINTSTS_ErlySusp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GINTSTS_ErlySusp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">GINTSTS_ErlySusp</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTSTS</span><span class="p">);</span>

		<span class="n">s3c_hsotg_disconnect</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * these next two seem to crop-up occasionally causing the core</span>
<span class="cm">	 * to shutdown the USB transfer, so try clearing them and logging</span>
<span class="cm">	 * the occurrence.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gintsts</span> <span class="o">&amp;</span> <span class="n">GINTSTS_GOUTNakEff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GOUTNakEff triggered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">DCTL_CGOUTNak</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCTL</span><span class="p">);</span>

		<span class="n">s3c_hsotg_dump</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gintsts</span> <span class="o">&amp;</span> <span class="n">GINTSTS_GINNakEff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GINNakEff triggered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">DCTL_CGNPInNAK</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCTL</span><span class="p">);</span>

		<span class="n">s3c_hsotg_dump</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * if we&#39;ve had fifo events, we should try and go around the</span>
<span class="cm">	 * loop again to see if there&#39;s any point in returning yet.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gintsts</span> <span class="o">&amp;</span> <span class="n">IRQ_RETRY_MASK</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">retry_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">irq_retry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_ep_enable - enable the given endpoint</span>
<span class="cm"> * @ep: The USB endpint to configure</span>
<span class="cm"> * @desc: The USB endpoint descriptor to configure with.</span>
<span class="cm"> *</span>
<span class="cm"> * This is called from the USB gadget code&#39;s usb_ep_enable().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsotg_ep_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span> <span class="o">=</span> <span class="n">our_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">epctrl_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">epctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir_in</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s: ep %s: a 0x%02x, attr 0x%02x, mps 0x%04x, intr %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span><span class="p">,</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>

	<span class="cm">/* not to be called for EP0 */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dir_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_DIR_MASK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir_in</span> <span class="o">!=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">dir_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: direction mismatch!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mps</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="cm">/* note, we handle this here instead of s3c_hsotg_set_ep_maxpacket */</span>

	<span class="n">epctrl_reg</span> <span class="o">=</span> <span class="n">dir_in</span> <span class="o">?</span> <span class="n">DIEPCTL</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">:</span> <span class="n">DOEPCTL</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="n">epctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epctrl_reg</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: read DxEPCTL=0x%08x from 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">epctrl</span><span class="p">,</span> <span class="n">epctrl_reg</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">epctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DxEPCTL_EPType_MASK</span> <span class="o">|</span> <span class="n">DxEPCTL_MPS_MASK</span><span class="p">);</span>
	<span class="n">epctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_MPS</span><span class="p">(</span><span class="n">mps</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * mark the endpoint as active, otherwise the core may ignore</span>
<span class="cm">	 * transactions entirely for this endpoint</span>
<span class="cm">	 */</span>
	<span class="n">epctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_USBActEp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set the NAK status on the endpoint, otherwise we might try and</span>
<span class="cm">	 * do something with data that we&#39;ve yet got a request to process</span>
<span class="cm">	 * since the RXFIFO will take data for an endpoint even if the</span>
<span class="cm">	 * size register hasn&#39;t been set.</span>
<span class="cm">	 */</span>

	<span class="n">epctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_SNAK</span><span class="p">;</span>

	<span class="cm">/* update the endpoint state */</span>
	<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">mps</span><span class="p">;</span>

	<span class="cm">/* default, set to non-periodic */</span>
	<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">periodic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_XFERTYPE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no current ISOC support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>:
		<span class="n">epctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_EPType_Bulk</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dir_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Allocate our TxFNum by simply using the index</span>
<span class="cm">			 * of the endpoint for the moment. We could do</span>
<span class="cm">			 * something better if the host indicates how</span>
<span class="cm">			 * many FIFOs we are expecting to use.</span>
<span class="cm">			 */</span>

			<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">periodic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">epctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_TxFNum</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">epctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_EPType_Intterupt</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span>:
		<span class="n">epctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_EPType_Control</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * if the hardware has dedicated fifos, we must give each IN EP</span>
<span class="cm">	 * a unique tx-fifo even if it is non-periodic.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir_in</span> <span class="o">&amp;&amp;</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dedicated_fifos</span><span class="p">)</span>
		<span class="n">epctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_TxFNum</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>

	<span class="cm">/* for non control endpoints, set PID to D0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span>
		<span class="n">epctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_SetD0PID</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: write DxEPCTL=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">epctrl</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">epctrl</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epctrl_reg</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: read DxEPCTL=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epctrl_reg</span><span class="p">));</span>

	<span class="cm">/* enable the endpoint interrupt */</span>
	<span class="n">s3c_hsotg_ctrl_epint</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">dir_in</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_ep_disable - disable given endpoint</span>
<span class="cm"> * @ep: The endpoint to disable.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsotg_ep_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span> <span class="o">=</span> <span class="n">our_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir_in</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">dir_in</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">epctrl_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(ep %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: called for ep0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">epctrl_reg</span> <span class="o">=</span> <span class="n">dir_in</span> <span class="o">?</span> <span class="n">DIEPCTL</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">:</span> <span class="n">DOEPCTL</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>

	<span class="cm">/* terminate all requests with shutdown */</span>
	<span class="n">kill_all_requests</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">hs_ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epctrl_reg</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DxEPCTL_EPEna</span><span class="p">;</span>
	<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DxEPCTL_USBActEp</span><span class="p">;</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DxEPCTL_SNAK</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: DxEPCTL=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epctrl_reg</span><span class="p">);</span>

	<span class="cm">/* disable endpoint interrupts */</span>
	<span class="n">s3c_hsotg_ctrl_epint</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">dir_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * on_list - check request is on the given endpoint</span>
<span class="cm"> * @ep: The endpoint to check.</span>
<span class="cm"> * @test: The request to test if it is on the endpoint.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">on_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="o">*</span><span class="n">treq</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">treq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">test</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_ep_dequeue - dequeue given endpoint</span>
<span class="cm"> * @ep: The endpoint to dequeue.</span>
<span class="cm"> * @req: The request to be removed from a queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsotg_ep_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">hs_req</span> <span class="o">=</span> <span class="n">our_req</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span> <span class="o">=</span> <span class="n">our_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hs</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">hs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ep_dequeue(%p,%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">on_list</span><span class="p">(</span><span class="n">hs_ep</span><span class="p">,</span> <span class="n">hs_req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s3c_hsotg_complete_request</span><span class="p">(</span><span class="n">hs</span><span class="p">,</span> <span class="n">hs_ep</span><span class="p">,</span> <span class="n">hs_req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_ep_sethalt - set halt on a given endpoint</span>
<span class="cm"> * @ep: The endpoint to set halt.</span>
<span class="cm"> * @value: Set or unset the halt.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsotg_ep_sethalt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span> <span class="o">=</span> <span class="n">our_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hs</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">epreg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">epctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xfertype</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">hs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(ep %p %s, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>

	<span class="cm">/* write both IN and OUT control registers */</span>

	<span class="n">epreg</span> <span class="o">=</span> <span class="n">DIEPCTL</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="n">epctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hs</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epreg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">epctl</span> <span class="o">|=</span> <span class="n">DxEPCTL_Stall</span> <span class="o">+</span> <span class="n">DxEPCTL_SNAK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">epctl</span> <span class="o">&amp;</span> <span class="n">DxEPCTL_EPEna</span><span class="p">)</span>
			<span class="n">epctl</span> <span class="o">|=</span> <span class="n">DxEPCTL_EPDis</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">epctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DxEPCTL_Stall</span><span class="p">;</span>
		<span class="n">xfertype</span> <span class="o">=</span> <span class="n">epctl</span> <span class="o">&amp;</span> <span class="n">DxEPCTL_EPType_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xfertype</span> <span class="o">==</span> <span class="n">DxEPCTL_EPType_Bulk</span> <span class="o">||</span>
			<span class="n">xfertype</span> <span class="o">==</span> <span class="n">DxEPCTL_EPType_Intterupt</span><span class="p">)</span>
				<span class="n">epctl</span> <span class="o">|=</span> <span class="n">DxEPCTL_SetD0PID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">epctl</span><span class="p">,</span> <span class="n">hs</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epreg</span><span class="p">);</span>

	<span class="n">epreg</span> <span class="o">=</span> <span class="n">DOEPCTL</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="n">epctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hs</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epreg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">epctl</span> <span class="o">|=</span> <span class="n">DxEPCTL_Stall</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">epctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DxEPCTL_Stall</span><span class="p">;</span>
		<span class="n">xfertype</span> <span class="o">=</span> <span class="n">epctl</span> <span class="o">&amp;</span> <span class="n">DxEPCTL_EPType_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xfertype</span> <span class="o">==</span> <span class="n">DxEPCTL_EPType_Bulk</span> <span class="o">||</span>
			<span class="n">xfertype</span> <span class="o">==</span> <span class="n">DxEPCTL_EPType_Intterupt</span><span class="p">)</span>
				<span class="n">epctl</span> <span class="o">|=</span> <span class="n">DxEPCTL_SetD0PID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">epctl</span><span class="p">,</span> <span class="n">hs</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">epreg</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">s3c_hsotg_ep_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">s3c_hsotg_ep_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">s3c_hsotg_ep_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_request</span>	<span class="o">=</span> <span class="n">s3c_hsotg_ep_alloc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_request</span>	<span class="o">=</span> <span class="n">s3c_hsotg_ep_free_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queue</span>		<span class="o">=</span> <span class="n">s3c_hsotg_ep_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue</span>	<span class="o">=</span> <span class="n">s3c_hsotg_ep_dequeue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_halt</span>	<span class="o">=</span> <span class="n">s3c_hsotg_ep_sethalt</span><span class="p">,</span>
	<span class="cm">/* note, don&#39;t believe we have any call for the fifo routines */</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_phy_enable - enable platform phy dev</span>
<span class="cm"> * @hsotg: The driver state</span>
<span class="cm"> *</span>
<span class="cm"> * A wrapper for platform code responsible for controlling</span>
<span class="cm"> * low-level USB code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_phy_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pdev 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">phy_init</span><span class="p">)</span>
		<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">phy_init</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_phy_disable - disable platform phy dev</span>
<span class="cm"> * @hsotg: The driver state</span>
<span class="cm"> *</span>
<span class="cm"> * A wrapper for platform code responsible for controlling</span>
<span class="cm"> * low-level USB code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_phy_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">phy_exit</span><span class="p">)</span>
		<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">phy_exit</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_init - initalize the usb core</span>
<span class="cm"> * @hsotg: The driver state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* unmask subset of endpoint interrupts */</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">DIEPMSK_TimeOUTMsk</span> <span class="o">|</span> <span class="n">DIEPMSK_AHBErrMsk</span> <span class="o">|</span>
	       <span class="n">DIEPMSK_EPDisbldMsk</span> <span class="o">|</span> <span class="n">DIEPMSK_XferComplMsk</span><span class="p">,</span>
	       <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPMSK</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">DOEPMSK_SetupMsk</span> <span class="o">|</span> <span class="n">DOEPMSK_AHBErrMsk</span> <span class="o">|</span>
	       <span class="n">DOEPMSK_EPDisbldMsk</span> <span class="o">|</span> <span class="n">DOEPMSK_XferComplMsk</span><span class="p">,</span>
	       <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPMSK</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DAINTMSK</span><span class="p">);</span>

	<span class="cm">/* Be in disconnected state until gadget is registered */</span>
	<span class="n">__orr32</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCTL</span><span class="p">,</span> <span class="n">DCTL_SftDiscon</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* post global nak until we&#39;re ready */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">DCTL_SGNPInNAK</span> <span class="o">|</span> <span class="n">DCTL_SGOUTNak</span><span class="p">,</span>
		       <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCTL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* setup fifos */</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GRXFSIZ=0x%08x, GNPTXFSIZ=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GRXFSIZ</span><span class="p">),</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GNPTXFSIZ</span><span class="p">));</span>

	<span class="n">s3c_hsotg_init_fifo</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>

	<span class="cm">/* set the PLL on, remove the HNP/SRP and set the PHY */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">GUSBCFG_PHYIf16</span> <span class="o">|</span> <span class="n">GUSBCFG_TOutCal</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">),</span>
	       <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GUSBCFG</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">using_dma</span><span class="p">(</span><span class="n">hsotg</span><span class="p">)</span> <span class="o">?</span> <span class="n">GAHBCFG_DMAEn</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">,</span>
	       <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GAHBCFG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_udc_start - prepare the udc for work</span>
<span class="cm"> * @gadget: The usb gadget state</span>
<span class="cm"> * @driver: The usb gadget driver</span>
<span class="cm"> *</span>
<span class="cm"> * Perform initialization to prepare udc device and driver</span>
<span class="cm"> * to work.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsotg_udc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span> <span class="o">=</span> <span class="n">to_hsotg</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsotg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: called with no device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: no driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">max_speed</span> <span class="o">&lt;</span> <span class="n">USB_SPEED_FULL</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: bad speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: missing entry points</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>

	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_bulk_enable</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span>
				    <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to enable supplies: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s3c_hsotg_phy_enable</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>

	<span class="n">s3c_hsotg_core_init</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">last_rst</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bound driver %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_udc_stop - stop the udc</span>
<span class="cm"> * @gadget: The usb gadget state</span>
<span class="cm"> * @driver: The usb gadget driver</span>
<span class="cm"> *</span>
<span class="cm"> * Stop udc hw block and stay tunned for future transmissions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsotg_udc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span> <span class="o">=</span> <span class="n">to_hsotg</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ep</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsotg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span> <span class="o">||</span> <span class="n">driver</span> <span class="o">!=</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* all endpoints should be shutdown */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ep</span> <span class="o">&lt;</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">num_of_eps</span><span class="p">;</span> <span class="n">ep</span><span class="o">++</span><span class="p">)</span>
		<span class="n">s3c_hsotg_ep_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">ep</span><span class="p">].</span><span class="n">ep</span><span class="p">);</span>

	<span class="n">s3c_hsotg_phy_disable</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
	<span class="n">regulator_bulk_disable</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>

	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unregistered gadget driver &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_gadget_getframe - read the frame number</span>
<span class="cm"> * @gadget: The usb gadget state</span>
<span class="cm"> *</span>
<span class="cm"> * Read the {micro} frame number</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c_hsotg_gadget_getframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">s3c_hsotg_read_frameno</span><span class="p">(</span><span class="n">to_hsotg</span><span class="p">(</span><span class="n">gadget</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_gadget_ops</span> <span class="n">s3c_hsotg_gadget_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_frame</span>	<span class="o">=</span> <span class="n">s3c_hsotg_gadget_getframe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_start</span>		<span class="o">=</span> <span class="n">s3c_hsotg_udc_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_stop</span>		<span class="o">=</span> <span class="n">s3c_hsotg_udc_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_initep - initialise a single endpoint</span>
<span class="cm"> * @hsotg: The device state.</span>
<span class="cm"> * @hs_ep: The endpoint to be initialised.</span>
<span class="cm"> * @epnum: The endpoint number</span>
<span class="cm"> *</span>
<span class="cm"> * Initialise the given endpoint (as part of the probe and device state</span>
<span class="cm"> * creation) to give to the gadget driver. Setup the endpoint name, any</span>
<span class="cm"> * direction information and other state that may be required.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">s3c_hsotg_initep</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">hs_ep</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">epnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ptxfifo</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">epnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">epnum</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="s">&quot;out&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="s">&quot;in&quot;</span><span class="p">;</span>
		<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">dir_in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">epnum</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;ep%d%s&quot;</span><span class="p">,</span> <span class="n">epnum</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* add to the list of endpoints known by the gadget driver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epnum</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">hsotg</span><span class="p">;</span>
	<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">epnum</span> <span class="o">?</span> <span class="mi">512</span> <span class="o">:</span> <span class="n">EP0_MPS_LIMIT</span><span class="p">;</span>
	<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_hsotg_ep_ops</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read the FIFO size for the Periodic TX FIFO, even if we&#39;re</span>
<span class="cm">	 * an OUT endpoint, we may as well do this if in future the</span>
<span class="cm">	 * code is changed to make each endpoint&#39;s direction changeable.</span>
<span class="cm">	 */</span>

	<span class="n">ptxfifo</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DPTXFSIZn</span><span class="p">(</span><span class="n">epnum</span><span class="p">));</span>
	<span class="n">hs_ep</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">DPTXFSIZn_DPTxFSize_GET</span><span class="p">(</span><span class="n">ptxfifo</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if we&#39;re using dma, we need to set the next-endpoint pointer</span>
<span class="cm">	 * to be something valid.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">using_dma</span><span class="p">(</span><span class="n">hsotg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">next</span> <span class="o">=</span> <span class="n">DxEPCTL_NextEp</span><span class="p">((</span><span class="n">epnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">15</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPCTL</span><span class="p">(</span><span class="n">epnum</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPCTL</span><span class="p">(</span><span class="n">epnum</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_hw_cfg - read HW configuration registers</span>
<span class="cm"> * @param: The device state</span>
<span class="cm"> *</span>
<span class="cm"> * Read the USB core HW configuration registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_hw_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg2</span><span class="p">,</span> <span class="n">cfg4</span><span class="p">;</span>
	<span class="cm">/* check hardware configuration */</span>

	<span class="n">cfg2</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="mh">0x48</span><span class="p">);</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">num_of_eps</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg2</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;EPs:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">num_of_eps</span><span class="p">);</span>

	<span class="n">cfg4</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="mh">0x50</span><span class="p">);</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dedicated_fifos</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg4</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s fifos</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dedicated_fifos</span> <span class="o">?</span> <span class="s">&quot;dedicated&quot;</span> <span class="o">:</span> <span class="s">&quot;shared&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_dump - dump state of the udc</span>
<span class="cm"> * @param: The device state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DCFG=0x%08x, DCTL=0x%08x, DIEPMSK=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCFG</span><span class="p">),</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCTL</span><span class="p">),</span>
		 <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPMSK</span><span class="p">));</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GAHBCFG=0x%08x, 0x44=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GAHBCFG</span><span class="p">),</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="mh">0x44</span><span class="p">));</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GRXFSIZ=0x%08x, GNPTXFSIZ=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GRXFSIZ</span><span class="p">),</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GNPTXFSIZ</span><span class="p">));</span>

	<span class="cm">/* show periodic fifo settings */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DPTXFSIZn</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DPTx[%d] FSize=%d, StAddr=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
			 <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">DPTXFSIZn_DPTxFSize_SHIFT</span><span class="p">,</span>
			 <span class="n">val</span> <span class="o">&amp;</span> <span class="n">DPTXFSIZn_DPTxFStAddr_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;ep%d-in: EPCTL=0x%08x, SIZ=0x%08x, DMA=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
			 <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPCTL</span><span class="p">(</span><span class="n">idx</span><span class="p">)),</span>
			 <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPTSIZ</span><span class="p">(</span><span class="n">idx</span><span class="p">)),</span>
			 <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPDMA</span><span class="p">(</span><span class="n">idx</span><span class="p">)));</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPCTL</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;ep%d-out: EPCTL=0x%08x, SIZ=0x%08x, DMA=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">idx</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPCTL</span><span class="p">(</span><span class="n">idx</span><span class="p">)),</span>
			 <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPTSIZ</span><span class="p">(</span><span class="n">idx</span><span class="p">)),</span>
			 <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPDMA</span><span class="p">(</span><span class="n">idx</span><span class="p">)));</span>

	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DVBUSDIS=0x%08x, DVBUSPULSE=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DVBUSDIS</span><span class="p">),</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DVBUSPULSE</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * state_show - debugfs: show overall driver and device state.</span>
<span class="cm"> * @seq: The seq file to write to.</span>
<span class="cm"> * @v: Unused parameter.</span>
<span class="cm"> *</span>
<span class="cm"> * This debugfs entry shows the overall state of the hardware and</span>
<span class="cm"> * some general information about each of the endpoints available</span>
<span class="cm"> * to the system.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">state_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;DCFG=0x%08x, DCTL=0x%08x, DSTS=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCFG</span><span class="p">),</span>
		 <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DCTL</span><span class="p">),</span>
		 <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DSTS</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;DIEPMSK=0x%08x, DOEPMASK=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPMSK</span><span class="p">),</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPMSK</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;GINTMSK=0x%08x, GINTSTS=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTMSK</span><span class="p">),</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GINTSTS</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;DAINTMSK=0x%08x, DAINT=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DAINTMSK</span><span class="p">),</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DAINT</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;GNPTXSTS=0x%08x, GRXSTSR=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GNPTXSTS</span><span class="p">),</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GRXSTSR</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Endpoint status:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">in</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPCTL</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>
		<span class="n">out</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPCTL</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ep%d: DIEPCTL=0x%08x, DOEPCTL=0x%08x&quot;</span><span class="p">,</span>
			   <span class="n">idx</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>

		<span class="n">in</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPTSIZ</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>
		<span class="n">out</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPTSIZ</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;, DIEPTSIZ=0x%08x, DOEPTSIZ=0x%08x&quot;</span><span class="p">,</span>
			   <span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">state_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">state_show</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">state_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">state_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * fifo_show - debugfs: show the fifo information</span>
<span class="cm"> * @seq: The seq_file to write data to.</span>
<span class="cm"> * @v: Unused parameter.</span>
<span class="cm"> *</span>
<span class="cm"> * Show the FIFO information for the overall fifo and all the</span>
<span class="cm"> * periodic transmission FIFOs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fifo_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Non-periodic FIFOs:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;RXFIFO: Size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GRXFSIZ</span><span class="p">));</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GNPTXFSIZ</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;NPTXFIFO: Size %d, Start 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">GNPTXFSIZ_NPTxFDep_SHIFT</span><span class="p">,</span>
		   <span class="n">val</span> <span class="o">&amp;</span> <span class="n">GNPTXFSIZ_NPTxFStAddr_MASK</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Periodic TXFIFOs:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DPTXFSIZn</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DPTXFIFO%2d: Size %d, Start 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
			   <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">DPTXFSIZn_DPTxFSize_SHIFT</span><span class="p">,</span>
			   <span class="n">val</span> <span class="o">&amp;</span> <span class="n">DPTXFSIZn_DPTxFStAddr_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fifo_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fifo_show</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fifo_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">fifo_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">decode_direction</span><span class="p">(</span><span class="kt">int</span> <span class="n">is_in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">is_in</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep_show - debugfs: show the state of an endpoint.</span>
<span class="cm"> * @seq: The seq_file to write data to.</span>
<span class="cm"> * @v: Unused parameter.</span>
<span class="cm"> *</span>
<span class="cm"> * This debugfs entry shows the state of the given endpoint (one is</span>
<span class="cm"> * registered for each available).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">show_limit</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Endpoint index %d, named %s,  dir %s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ep</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">decode_direction</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir_in</span><span class="p">));</span>

	<span class="cm">/* first show the register state */</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DIEPCTL=0x%08x, DOEPCTL=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPCTL</span><span class="p">(</span><span class="n">index</span><span class="p">)),</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPCTL</span><span class="p">(</span><span class="n">index</span><span class="p">)));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DIEPDMA=0x%08x, DOEPDMA=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPDMA</span><span class="p">(</span><span class="n">index</span><span class="p">)),</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPDMA</span><span class="p">(</span><span class="n">index</span><span class="p">)));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DIEPINT=0x%08x, DOEPINT=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPINT</span><span class="p">(</span><span class="n">index</span><span class="p">)),</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPINT</span><span class="p">(</span><span class="n">index</span><span class="p">)));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">DIEPTSIZ=0x%08x, DOEPTSIZ=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DIEPTSIZ</span><span class="p">(</span><span class="n">index</span><span class="p">)),</span>
		   <span class="n">readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">DOEPTSIZ</span><span class="p">(</span><span class="n">index</span><span class="p">)));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;mps %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;total_data=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">total_data</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;request list (%p,%p):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">show_limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;not showing more requests...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%c req %p: %d bytes @%p, &quot;</span><span class="p">,</span>
			   <span class="n">req</span> <span class="o">==</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">?</span> <span class="sc">&#39;*&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
			   <span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%d done, res %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ep_show</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ep_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ep_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_create_debug - create debugfs directory and files</span>
<span class="cm"> * @hsotg: The driver state</span>
<span class="cm"> *</span>
<span class="cm"> * Create the debugfs files to allow the user to get information</span>
<span class="cm"> * about the state of the system. The directory name is created</span>
<span class="cm"> * with the same name as the device itself, in case we end up</span>
<span class="cm"> * with multiple blocks in future systems.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">s3c_hsotg_create_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">epidx</span><span class="p">;</span>

	<span class="n">root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">debug_root</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">root</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot create debug root</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create general state file */</span>

	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">debug_file</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;state&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span>
						<span class="n">hsotg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state_fops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">debug_file</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: failed to create state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">debug_fifo</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;fifo&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span>
						<span class="n">hsotg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fifo_fops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">debug_fifo</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: failed to create fifo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* create one file for each endpoint */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">epidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">epidx</span> <span class="o">&lt;</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">num_of_eps</span><span class="p">;</span> <span class="n">epidx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">epidx</span><span class="p">];</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">debugfs</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span>
						  <span class="n">root</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep_fops</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create %s debug file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_delete_debug - cleanup debugfs entries</span>
<span class="cm"> * @hsotg: The driver state</span>
<span class="cm"> *</span>
<span class="cm"> * Cleanup (remove) the debugfs files for use on module exit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">s3c_hsotg_delete_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">epidx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">epidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">epidx</span> <span class="o">&lt;</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">num_of_eps</span><span class="p">;</span> <span class="n">epidx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">epidx</span><span class="p">];</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">debug_file</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">debug_fifo</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">debug_root</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_release - release callback for hsotg device</span>
<span class="cm"> * @dev: Device to for which release is called</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_hsotg_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_probe - probe function for hsotg driver</span>
<span class="cm"> * @pdev: The platform information for the driver</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">s3c_hsotg_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_plat</span> <span class="o">*</span><span class="n">plat</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg_ep</span> <span class="o">*</span><span class="n">eps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">epnum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">plat</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no platform data defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hsotg</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsotg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot get memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">plat</span> <span class="o">=</span> <span class="n">plat</span><span class="p">;</span>

	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;otg&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot get otg clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hsotg</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot find register resource 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_clk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs_res</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
					     <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs_res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot reserve registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_clk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot map registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_regs_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot find IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_regs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">s3c_hsotg_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">hsotg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot claim IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_regs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;regs %p, irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">device_initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gadget&quot;</span><span class="p">);</span>

	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">max_speed</span> <span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">;</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c_hsotg_gadget_ops</span><span class="p">;</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">s3c_hsotg_release</span><span class="p">;</span>

	<span class="cm">/* reset the system */</span>

	<span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="cm">/* regulators */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">supply</span> <span class="o">=</span> <span class="n">s3c_hsotg_supply_names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_bulk_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span>
				 <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request supplies: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_bulk_enable</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span>
				    <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to enable supplies: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_supplies</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* usb phy enable */</span>
	<span class="n">s3c_hsotg_phy_enable</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>

	<span class="n">s3c_hsotg_corereset</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
	<span class="n">s3c_hsotg_init</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
	<span class="n">s3c_hsotg_hw_cfg</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>

	<span class="cm">/* hsotg-&gt;num_of_eps holds number of EPs other than ep0 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">num_of_eps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wrong number of EPs (zero)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_supplies</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">eps</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">num_of_eps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_hsotg_ep</span><span class="p">),</span>
		      <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot get memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_supplies</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span><span class="p">;</span>

	<span class="cm">/* setup endpoint information */</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">;</span>

	<span class="cm">/* allocate EP0 request */</span>

	<span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">ctrl_req</span> <span class="o">=</span> <span class="n">s3c_hsotg_ep_alloc_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">,</span>
						     <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">ctrl_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate ctrl req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_ep_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialise the endpoints now the core has been initialised */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">epnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">epnum</span> <span class="o">&lt;</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">num_of_eps</span><span class="p">;</span> <span class="n">epnum</span><span class="o">++</span><span class="p">)</span>
		<span class="n">s3c_hsotg_initep</span><span class="p">(</span><span class="n">hsotg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">epnum</span><span class="p">],</span> <span class="n">epnum</span><span class="p">);</span>

	<span class="cm">/* disable power and clock */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_bulk_disable</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span>
				    <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to disable supplies: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_ep_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s3c_hsotg_phy_disable</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_ep_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_add_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_ep_mem</span><span class="p">;</span>

	<span class="n">s3c_hsotg_create_debug</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>

	<span class="n">s3c_hsotg_dump</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_ep_mem:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">eps</span><span class="p">);</span>
<span class="nl">err_supplies:</span>
	<span class="n">s3c_hsotg_phy_disable</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
	<span class="n">regulator_bulk_free</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
<span class="nl">err_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hsotg</span><span class="p">);</span>
<span class="nl">err_regs:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

<span class="nl">err_regs_res:</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs_res</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs_res</span><span class="p">);</span>
<span class="nl">err_clk:</span>
	<span class="n">clk_disable_unprepare</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="nl">err_mem:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_hsotg_remove - remove function for hsotg driver</span>
<span class="cm"> * @pdev: The platform information for the driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">s3c_hsotg_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_hsotg</span> <span class="o">*</span><span class="n">hsotg</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">usb_del_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>

	<span class="n">s3c_hsotg_delete_debug</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* should have been done already by driver model core */</span>
		<span class="n">usb_gadget_unregister_driver</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hsotg</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">release_resource</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs_res</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">regs_res</span><span class="p">);</span>

	<span class="n">s3c_hsotg_phy_disable</span><span class="p">(</span><span class="n">hsotg</span><span class="p">);</span>
	<span class="n">regulator_bulk_free</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">),</span> <span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>

	<span class="n">clk_disable_unprepare</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hsotg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 1</span>
<span class="cp">#define s3c_hsotg_suspend NULL</span>
<span class="cp">#define s3c_hsotg_resume NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">s3c_hsotg_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;s3c-hsotg&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">s3c_hsotg_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">s3c_hsotg_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">s3c_hsotg_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">s3c_hsotg_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">s3c_hsotg_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Samsung S3C USB High-speed/OtG device&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ben Dooks &lt;ben@simtec.co.uk&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:s3c-hsotg&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
