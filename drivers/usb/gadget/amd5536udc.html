<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › gadget › amd5536udc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>amd5536udc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * amd5536.c -- AMD 5536 UDC high/full speed USB device controller</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2007 AMD (http://www.amd.com)</span>
<span class="cm"> * Author: Thomas Dahlmann</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The AMD5536 UDC is part of the x86 southbridge AMD Geode CS5536.</span>
<span class="cm"> * It is a USB Highspeed DMA capable USB device controller. Beside ep0 it</span>
<span class="cm"> * provides 4 IN and 4 OUT endpoints (bulk or interrupt type).</span>
<span class="cm"> *</span>
<span class="cm"> * Make sure that UDC is assigned to port 4 by BIOS settings (port can also</span>
<span class="cm"> * be used as host port) and UOC bits PAD_EN and APU are set (should be done</span>
<span class="cm"> * by BIOS init).</span>
<span class="cm"> *</span>
<span class="cm"> * UDC DMA requires 32-bit aligned buffers so DMA with gadget ether does not</span>
<span class="cm"> * work without updating NET_IP_ALIGN. Or PIO mode (module param &quot;use_dma=0&quot;)</span>
<span class="cm"> * can be used with gadget ether.</span>
<span class="cm"> */</span>

<span class="cm">/* debug control */</span>
<span class="cm">/* #define UDC_VERBOSE */</span>

<span class="cm">/* Driver strings */</span>
<span class="cp">#define UDC_MOD_DESCRIPTION		&quot;AMD 5536 UDC - USB Device Controller&quot;</span>
<span class="cp">#define UDC_DRIVER_VERSION_STRING	&quot;01.00.0206&quot;</span>

<span class="cm">/* system */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/dmapool.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>

<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cm">/* gadget stack */</span>
<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>

<span class="cm">/* udc specific */</span>
<span class="cp">#include &quot;amd5536udc.h&quot;</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">udc_tasklet_disconnect</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">empty_req_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">udc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">udc_basic_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">udc_setup_endpoints</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">udc_soft_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">udc_request</span> <span class="o">*</span><span class="n">udc_alloc_bna_dummy</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">udc_free_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">usbep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">usbreq</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">udc_free_dma_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">udc_create_dma_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">udc_remote_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">udc_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">udc_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>

<span class="cm">/* description */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">mod_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="n">UDC_MOD_DESCRIPTION</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;amd5536udc&quot;</span><span class="p">;</span>

<span class="cm">/* structure to hold endpoint function pointers */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">udc_ep_ops</span><span class="p">;</span>

<span class="cm">/* received setup data */</span>
<span class="k">static</span> <span class="k">union</span> <span class="n">udc_setup_data</span> <span class="n">setup_data</span><span class="p">;</span>

<span class="cm">/* pointer to device object */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">udc</span><span class="p">;</span>

<span class="cm">/* irq spin lock for soft reset */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">udc_irq_spinlock</span><span class="p">);</span>
<span class="cm">/* stall spin lock */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">udc_stall_spinlock</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">* slave mode: pending bytes in rx fifo after nyet,</span>
<span class="cm">* used if EPIN irq came but no req was available</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">udc_rxfifo_pending</span><span class="p">;</span>

<span class="cm">/* count soft resets after suspend to avoid loop */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">soft_reset_occured</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">soft_reset_after_usbreset_occured</span><span class="p">;</span>

<span class="cm">/* timer */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">udc_timer</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">stop_timer</span><span class="p">;</span>

<span class="cm">/* set_rde -- Is used to control enabling of RX DMA. Problem is</span>
<span class="cm"> * that UDC has only one bit (RDE) to enable/disable RX DMA for</span>
<span class="cm"> * all OUT endpoints. So we have to handle race conditions like</span>
<span class="cm"> * when OUT data reaches the fifo but no request was queued yet.</span>
<span class="cm"> * This cannot be solved by letting the RX DMA disabled until a</span>
<span class="cm"> * request gets queued because there may be other OUT packets</span>
<span class="cm"> * in the FIFO (important for not blocking control traffic).</span>
<span class="cm"> * The value of set_rde controls the correspondig timer.</span>
<span class="cm"> *</span>
<span class="cm"> * set_rde -1 == not used, means it is alloed to be set to 0 or 1</span>
<span class="cm"> * set_rde  0 == do not touch RDE, do no start the RDE timer</span>
<span class="cm"> * set_rde  1 == timer function will look whether FIFO has data</span>
<span class="cm"> * set_rde  2 == set by timer function to enable RX DMA on next call</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_rde</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DECLARE_COMPLETION</span><span class="p">(</span><span class="n">on_exit</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">udc_pollstall_timer</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">stop_pollstall_timer</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DECLARE_COMPLETION</span><span class="p">(</span><span class="n">on_pollstall_exit</span><span class="p">);</span>

<span class="cm">/* tasklet for usb disconnect */</span>
<span class="k">static</span> <span class="n">DECLARE_TASKLET</span><span class="p">(</span><span class="n">disconnect_tasklet</span><span class="p">,</span> <span class="n">udc_tasklet_disconnect</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">udc</span><span class="p">);</span>


<span class="cm">/* endpoint names used for print */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ep0_string</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;ep0in&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">ep_string</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ep0_string</span><span class="p">,</span>
	<span class="s">&quot;ep1in-int&quot;</span><span class="p">,</span> <span class="s">&quot;ep2in-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep3in-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep4in-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep5in-bulk&quot;</span><span class="p">,</span>
	<span class="s">&quot;ep6in-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep7in-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep8in-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep9in-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep10in-bulk&quot;</span><span class="p">,</span>
	<span class="s">&quot;ep11in-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep12in-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep13in-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep14in-bulk&quot;</span><span class="p">,</span>
	<span class="s">&quot;ep15in-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep0out&quot;</span><span class="p">,</span> <span class="s">&quot;ep1out-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep2out-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep3out-bulk&quot;</span><span class="p">,</span>
	<span class="s">&quot;ep4out-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep5out-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep6out-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep7out-bulk&quot;</span><span class="p">,</span>
	<span class="s">&quot;ep8out-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep9out-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep10out-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep11out-bulk&quot;</span><span class="p">,</span>
	<span class="s">&quot;ep12out-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep13out-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep14out-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep15out-bulk&quot;</span>
<span class="p">};</span>

<span class="cm">/* DMA usage flag */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">use_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cm">/* packet per buffer dma */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">use_dma_ppb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cm">/* with per descr. update */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">use_dma_ppb_du</span><span class="p">;</span>
<span class="cm">/* buffer fill mode */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">use_dma_bufferfill_mode</span><span class="p">;</span>
<span class="cm">/* full speed only mode */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">use_fullspeed</span><span class="p">;</span>
<span class="cm">/* tx buffer size for high speed */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hs_tx_buf</span> <span class="o">=</span> <span class="n">UDC_EPIN_BUFF_SIZE</span><span class="p">;</span>

<span class="cm">/* module parameters */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">use_dma</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_dma</span><span class="p">,</span> <span class="s">&quot;true for DMA&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">use_dma_ppb</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_dma_ppb</span><span class="p">,</span> <span class="s">&quot;true for DMA in packet per buffer mode&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">use_dma_ppb_du</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_dma_ppb_du</span><span class="p">,</span>
	<span class="s">&quot;true for DMA in packet per buffer mode with descriptor update&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">use_fullspeed</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_fullspeed</span><span class="p">,</span> <span class="s">&quot;true for fullspeed only&quot;</span><span class="p">);</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/* Prints UDC device registers and endpoint irq registers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;------- Device registers -------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dev config     = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">));</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dev control    = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">));</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dev status     = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">));</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dev int&#39;s      = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqsts</span><span class="p">));</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dev intmask    = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqmsk</span><span class="p">));</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dev ep int&#39;s   = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqsts</span><span class="p">));</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dev ep intmask = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqmsk</span><span class="p">));</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USE DMA        = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">use_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">use_dma_ppb</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">use_dma_ppb_du</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA mode       = PPBNDU (packet per buffer &quot;</span>
			<span class="s">&quot;WITHOUT desc. update)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA mode (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;PPBNDU&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">use_dma_ppb</span> <span class="o">&amp;&amp;</span> <span class="n">use_dma_ppb_du</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA mode       = PPBDU (packet per buffer &quot;</span>
			<span class="s">&quot;WITH desc. update)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA mode (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;PPBDU&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">use_dma_bufferfill_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA mode       = BF (buffer fill mode)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA mode (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;BF&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FIFO mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Masks unused interrupts */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udc_mask_unused_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* mask all dev interrupts */</span>
	<span class="n">tmp</span> <span class="o">=</span>	<span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_SVC</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_ENUM</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_US</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_UR</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_ES</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_SI</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_SOF</span><span class="p">)</span><span class="o">|</span>
		<span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_SC</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqmsk</span><span class="p">);</span>

	<span class="cm">/* mask all ep interrupts */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">UDC_EPINT_MSK_DISABLE_ALL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqmsk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Enables endpoint 0 interrupts */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udc_enable_ep0_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;udc_enable_ep0_interrupts()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* read irq mask */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqmsk</span><span class="p">);</span>
	<span class="cm">/* enable ep0 irq&#39;s */</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">AMD_UNMASK_BIT</span><span class="p">(</span><span class="n">UDC_EPINT_IN_EP0</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="n">AMD_UNMASK_BIT</span><span class="p">(</span><span class="n">UDC_EPINT_OUT_EP0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqmsk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Enables device interrupts for SET_INTF and SET_CONFIG */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udc_enable_dev_setup_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;enable device interrupts for setup data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* read irq mask */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqmsk</span><span class="p">);</span>

	<span class="cm">/* enable SET_INTERFACE, SET_CONFIG and other needed irq&#39;s */</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">AMD_UNMASK_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_SI</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="n">AMD_UNMASK_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_SC</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="n">AMD_UNMASK_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_UR</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="n">AMD_UNMASK_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_SVC</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="n">AMD_UNMASK_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_ENUM</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqmsk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Calculates fifo start of endpoint based on preceding endpoints */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udc_set_txfifo_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">txfifo</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">;</span>

	<span class="cm">/* traverse ep&#39;s */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* read fifo size */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">bufin_framenum</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_GETBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_EPIN_BUFF_SIZE</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">txfifo</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* CNAK pending field: bit0 = ep0in, bit16 = ep0out */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">cnak_pending</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">UDC_QUEUE_CNAK</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_NAK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NAK could not be cleared for ep%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="n">cnak_pending</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">num</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">naking</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cnak_pending</span> <span class="o">=</span> <span class="n">cnak_pending</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">num</span><span class="p">)));</span>
<span class="p">}</span>


<span class="cm">/* Enables endpoint, is called by gadget driver */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">udc_ep_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">usbep</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc_ep</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">iflags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">udc_csr_epix</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">maxpacket</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbep</span>
			<span class="o">||</span> <span class="n">usbep</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0_string</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">desc</span>
			<span class="o">||</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">!=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">usbep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;udc_ep_enable() ep %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set traffic type */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span><span class="p">,</span> <span class="n">UDC_EPCTL_ET</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>

	<span class="cm">/* set max packet size */</span>
	<span class="n">maxpacket</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">bufout_maxpkt</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">maxpacket</span><span class="p">,</span> <span class="n">UDC_EP_MAX_PKT_SIZE</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">maxpacket</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">bufout_maxpkt</span><span class="p">);</span>

	<span class="cm">/* IN ep */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* ep ix in UDC CSR register space */</span>
		<span class="n">udc_csr_epix</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>

		<span class="cm">/* set buffer size (tx fifo entries) */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">bufin_framenum</span><span class="p">);</span>
		<span class="cm">/* double buffering: fifo size = 2 x max packet size */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span>
				<span class="n">tmp</span><span class="p">,</span>
				<span class="n">maxpacket</span> <span class="o">*</span> <span class="n">UDC_EPIN_BUFF_SIZE_MULT</span>
					  <span class="o">/</span> <span class="n">UDC_DWORD_BYTES</span><span class="p">,</span>
				<span class="n">UDC_EPIN_BUFF_SIZE</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">bufin_framenum</span><span class="p">);</span>

		<span class="cm">/* calc. tx fifo base addr */</span>
		<span class="n">udc_set_txfifo_addr</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

		<span class="cm">/* flush fifo */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_F</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>

	<span class="cm">/* OUT ep */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* ep ix in UDC CSR register space */</span>
		<span class="n">udc_csr_epix</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">-</span> <span class="n">UDC_CSR_EP_OUT_IX_OFS</span><span class="p">;</span>

		<span class="cm">/* set max packet size UDC CSR	*/</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">ne</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">-</span> <span class="n">UDC_CSR_EP_OUT_IX_OFS</span><span class="p">]);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">maxpacket</span><span class="p">,</span>
					<span class="n">UDC_CSR_NE_MAX_PKT</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">ne</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">-</span> <span class="n">UDC_CSR_EP_OUT_IX_OFS</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* alloc and init BNA dummy request */</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_dummy_req</span> <span class="o">=</span> <span class="n">udc_alloc_bna_dummy</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_occurred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="n">UDC_EP0OUT_IX</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_ep_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set ep values */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">ne</span><span class="p">[</span><span class="n">udc_csr_epix</span><span class="p">]);</span>
	<span class="cm">/* max packet */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">maxpacket</span><span class="p">,</span> <span class="n">UDC_CSR_NE_MAX_PKT</span><span class="p">);</span>
	<span class="cm">/* ep number */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">,</span> <span class="n">UDC_CSR_NE_NUM</span><span class="p">);</span>
	<span class="cm">/* ep direction */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">,</span> <span class="n">UDC_CSR_NE_DIR</span><span class="p">);</span>
	<span class="cm">/* ep type */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span><span class="p">,</span> <span class="n">UDC_CSR_NE_TYPE</span><span class="p">);</span>
	<span class="cm">/* ep config */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cur_config</span><span class="p">,</span> <span class="n">UDC_CSR_NE_CFG</span><span class="p">);</span>
	<span class="cm">/* ep interface */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cur_intf</span><span class="p">,</span> <span class="n">UDC_CSR_NE_INTF</span><span class="p">);</span>
	<span class="cm">/* ep alt */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cur_alt</span><span class="p">,</span> <span class="n">UDC_CSR_NE_ALT</span><span class="p">);</span>
	<span class="cm">/* write reg */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">ne</span><span class="p">[</span><span class="n">udc_csr_epix</span><span class="p">]);</span>

	<span class="cm">/* enable ep irq */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqmsk</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">AMD_UNMASK_BIT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqmsk</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * clear NAK by writing CNAK</span>
<span class="cm">	 * avoid BNA for OUT DMA, don&#39;t clear NAK until DMA desc. written</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_CNAK</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">naking</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">UDC_QUEUE_CNAK</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usbep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Resets endpoint */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>		<span class="n">tmp</span><span class="p">;</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ep-%d reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc_ep_ops</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* set NAK */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_SNAK</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">naking</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* disable interrupt */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqmsk</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqmsk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unset P and IN bit of potential former DMA */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">AMD_UNMASK_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_P</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_IN</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>

		<span class="cm">/* flush the fifo */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_F</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="cm">/* reset desc pointer */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">desptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Disables endpoint, is called by gadget driver */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udc_ep_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">usbep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">iflags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbep</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">usbep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbep</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0_string</span> <span class="o">||</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Disable ep-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="n">udc_free_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_dummy_req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="n">empty_req_queue</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">ep_init</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Allocates request packet, called by gadget driver */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span>
<span class="nf">udc_alloc_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">usbep</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_data_dma</span>	<span class="o">*</span><span class="n">dma_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbep</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">usbep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;udc_alloc_req(): ep%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_request</span><span class="p">),</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_DONT_USE</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ep0 in requests are allocated from data pool here */</span>
		<span class="n">dma_desc</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_requests</span><span class="p">,</span> <span class="n">gfp</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_phys</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;udc_alloc_req: req = %p dma_desc = %p, &quot;</span>
				<span class="s">&quot;td_phys = %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">req</span><span class="p">,</span> <span class="n">dma_desc</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_phys</span><span class="p">);</span>
		<span class="cm">/* prevent from using desc. - set HOST BUSY */</span>
		<span class="n">dma_desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">dma_desc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
						<span class="n">UDC_DMA_STP_STS_BS_HOST_BUSY</span><span class="p">,</span>
						<span class="n">UDC_DMA_STP_STS_BS</span><span class="p">);</span>
		<span class="n">dma_desc</span><span class="o">-&gt;</span><span class="n">bufptr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">DMA_DONT_USE</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span> <span class="o">=</span> <span class="n">dma_desc</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data_last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">chain_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Frees request packet, called by gadget driver */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">udc_free_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">usbep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">usbreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbep</span> <span class="o">||</span> <span class="o">!</span><span class="n">usbreq</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">usbep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">usbreq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;free_req req=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;req-&gt;td_data=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="p">);</span>

		<span class="cm">/* free dma chain if created */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">chain_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">udc_free_dma_chain</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_requests</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="p">,</span>
							<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_phys</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Init BNA dummy descriptor for HOST BUSY and pointing to itself */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_init_bna_dummy</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set last bit */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DMA_IN_STS_L</span><span class="p">);</span>
		<span class="cm">/* set next pointer to itself */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_phys</span><span class="p">;</span>
		<span class="cm">/* set HOST BUSY */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span>
			<span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
					<span class="n">UDC_DMA_STP_STS_BS_DMA_DONE</span><span class="p">,</span>
					<span class="n">UDC_DMA_STP_STS_BS</span><span class="p">);</span>
<span class="cp">#ifdef UDC_VERBOSE</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;bna desc = %p, sts = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Allocate BNA dummy descriptor */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">udc_request</span> <span class="o">*</span><span class="nf">udc_alloc_bna_dummy</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* alloc the dummy request */</span>
	<span class="n">_req</span> <span class="o">=</span> <span class="n">udc_alloc_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_dummy_req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
		<span class="n">udc_init_bna_dummy</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write data to TX fifo for IN packets */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">udc_txfifo_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>			<span class="o">*</span><span class="n">req_buf</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">remaining</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span> <span class="o">||</span> <span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">req_buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">req_buf</span><span class="p">);</span>
	<span class="n">remaining</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">req_buf</span><span class="p">;</span>

	<span class="n">bytes</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="n">remaining</span><span class="p">)</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">remaining</span><span class="p">;</span>

	<span class="cm">/* dwords first */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bytes</span> <span class="o">/</span> <span class="n">UDC_DWORD_BYTES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">);</span>

	<span class="cm">/* remaining bytes must be written by byte access */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bytes</span> <span class="o">%</span> <span class="n">UDC_DWORD_BYTES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">((</span><span class="n">u8</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="n">UDC_BITS_PER_BYTE_SHIFT</span><span class="p">)),</span>
							<span class="n">ep</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* dummy write confirm */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">confirm</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read dwords from RX fifo for OUT transfers */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udc_rxfifo_read_dwords</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dwords</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;udc_read_dwords(): %d dwords</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dwords</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dwords</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxfifo</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read bytes from RX fifo for OUT transfers */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udc_rxfifo_read_bytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;udc_read_bytes(): %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

	<span class="cm">/* dwords first */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bytes</span> <span class="o">/</span> <span class="n">UDC_DWORD_BYTES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)))</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxfifo</span><span class="p">);</span>

	<span class="cm">/* remaining bytes must be read by byte access */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">%</span> <span class="n">UDC_DWORD_BYTES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxfifo</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bytes</span> <span class="o">%</span> <span class="n">UDC_DWORD_BYTES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">UDC_BYTE_MASK</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="n">UDC_BITS_PER_BYTE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read data from RX fifo for OUT transfers */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">udc_rxfifo_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">buf_space</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">finished</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* received number bytes */</span>
	<span class="n">bytes</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
	<span class="n">bytes</span> <span class="o">=</span> <span class="n">AMD_GETBITS</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">UDC_EPSTS_RX_PKT_SIZE</span><span class="p">);</span>

	<span class="n">buf_space</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="n">buf_space</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buf_space</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: rx %d bytes, rx-buf space = %d bytesn</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">buf_space</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">buf_space</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>

	<span class="cm">/* last packet ? */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">bytes</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">bytes</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span><span class="p">))</span>
		<span class="n">finished</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* read rx fifo bytes */</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ep %s: rxfifo read %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
	<span class="n">udc_rxfifo_read_bytes</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">finished</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* create/re-init a DMA descriptor or a DMA descriptor chain */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prep_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">tmp</span><span class="p">;</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;prep_dma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;prep_dma ep%d req-&gt;td_data=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="p">);</span>

	<span class="cm">/* set buffer pointer */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">bufptr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span><span class="p">;</span>

	<span class="cm">/* set last bit */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DMA_IN_STS_L</span><span class="p">);</span>

	<span class="cm">/* build/re-init dma chain if maxpkt scatter mode, not for EP0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma_ppb</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">udc_create_dma_chain</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span>
				<span class="n">DBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Out of DMA memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* write tx bytes */</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span>
					<span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
						<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">,</span>
						<span class="n">UDC_DMA_IN_STS_TXBYTES</span><span class="p">);</span>

			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IN: use_dma_ppb=%d req-&gt;req.len=%d &quot;</span>
				<span class="s">&quot;maxpacket=%d ep%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">use_dma_ppb</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * if bytes &lt; max packet then tx bytes must</span>
<span class="cm">		 * be written in packet per buffer mode</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma_ppb</span> <span class="o">||</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span>
				<span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="n">UDC_EP0OUT_IX</span>
				<span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="n">UDC_EP0IN_IX</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* write tx bytes */</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span>
				<span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
						<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
						<span class="n">UDC_DMA_IN_STS_TXBYTES</span><span class="p">);</span>
			<span class="cm">/* reset frame num */</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span>
				<span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="n">UDC_DMA_IN_STS_FRAMENUM</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* set HOST BUSY */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span>
			<span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
				<span class="n">UDC_DMA_STP_STS_BS_HOST_BUSY</span><span class="p">,</span>
				<span class="n">UDC_DMA_STP_STS_BS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OUT set host ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* set HOST READY */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span>
			<span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
				<span class="n">UDC_DMA_STP_STS_BS_HOST_READY</span><span class="p">,</span>
				<span class="n">UDC_DMA_STP_STS_BS</span><span class="p">);</span>


			<span class="cm">/* clear NAK by writing CNAK */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">naking</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_CNAK</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">naking</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">UDC_QUEUE_CNAK</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
			<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Completes request packet ... caller MUST hold lock */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">complete_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sts</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">halted</span><span class="p">;</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;complete_req(): ep%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="cm">/* unmap DMA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
		<span class="n">usb_gadget_unmap_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">);</span>

	<span class="n">halted</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* set new status if pending */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">sts</span><span class="p">;</span>

	<span class="cm">/* remove from ep queue */</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;req %p =&gt; complete %d bytes at %s with sts %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sts</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="n">halted</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* frees pci pool descriptors of a DMA chain */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udc_free_dma_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_data_dma</span>	<span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_data_dma</span>	<span class="o">*</span><span class="n">td_last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;free chain req = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="cm">/* do not free first desc., will be done by free for request */</span>
	<span class="n">td_last</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="p">;</span>
	<span class="n">td</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">td_last</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">chain_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_requests</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span>
				<span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="n">td_last</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">td_last</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>
		<span class="n">td</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">td_last</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Iterates to the end of a DMA chain and returns last descriptor */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">udc_data_dma</span> <span class="o">*</span><span class="nf">udc_get_last_dma_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc_data_dma</span>	<span class="o">*</span><span class="n">td</span><span class="p">;</span>

	<span class="n">td</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">td</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DMA_IN_STS_L</span><span class="p">)))</span>
		<span class="n">td</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">td</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* Iterates to the end of a DMA chain and counts bytes received */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">udc_get_ppbdu_rxbytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc_data_dma</span>	<span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">td</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="p">;</span>
	<span class="cm">/* received number bytes */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">AMD_GETBITS</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">UDC_DMA_OUT_STS_RXBYTES</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">td</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DMA_IN_STS_L</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">td</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="cm">/* received number bytes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">AMD_GETBITS</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
				<span class="n">UDC_DMA_OUT_STS_RXBYTES</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* Creates or re-inits a DMA chain */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udc_create_dma_chain</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">udc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_data_dma</span>	<span class="o">*</span><span class="n">td</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_data_dma</span>	<span class="o">*</span><span class="n">last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">txbytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">create_new_chain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;udc_create_dma_chain: bytes=%ld buf_len=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bytes</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">DMA_DONT_USE</span><span class="p">;</span>

	<span class="cm">/* unset L bit in first desc for OUT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="n">AMD_CLEAR_BIT</span><span class="p">(</span><span class="n">UDC_DMA_IN_STS_L</span><span class="p">);</span>

	<span class="cm">/* alloc only new desc&#39;s if not already available */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">/</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span>
		<span class="n">len</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">chain_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* shorter chain already allocated before */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">chain_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">udc_free_dma_chain</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">chain_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">create_new_chain</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">td</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="p">;</span>
	<span class="cm">/* gen. required number of descriptors and buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">buf_len</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bytes</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* create or determine next desc. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">create_new_chain</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">td</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_requests</span><span class="p">,</span>
					<span class="n">gfp_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">td</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

			<span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* first td */</span>
			<span class="n">td</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">udc_data_dma</span> <span class="o">*</span><span class="p">)</span> <span class="n">phys_to_virt</span><span class="p">(</span>
						<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
			<span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">td</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">udc_data_dma</span> <span class="o">*</span><span class="p">)</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
			<span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="p">)</span>
			<span class="n">td</span><span class="o">-&gt;</span><span class="n">bufptr</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span> <span class="cm">/* assign buffer */</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* short packet ? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bytes</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txbytes</span> <span class="o">=</span> <span class="n">buf_len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* short packet */</span>
			<span class="n">txbytes</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* link td and assign tx bytes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">create_new_chain</span><span class="p">)</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			else</span>
<span class="cm">				req-&gt;td_data-&gt;next = virt_to_phys(td);</span>
<span class="cm">			*/</span>
			<span class="cm">/* write tx bytes */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* first desc */</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span>
					<span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
							<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">,</span>
							<span class="n">UDC_DMA_IN_STS_TXBYTES</span><span class="p">);</span>
				<span class="cm">/* second desc */</span>
				<span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
							<span class="n">txbytes</span><span class="p">,</span>
							<span class="n">UDC_DMA_IN_STS_TXBYTES</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">create_new_chain</span><span class="p">)</span>
				<span class="n">last</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			else</span>
<span class="cm">				last-&gt;next = virt_to_phys(td);</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* write tx bytes */</span>
				<span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
							<span class="n">txbytes</span><span class="p">,</span>
							<span class="n">UDC_DMA_IN_STS_TXBYTES</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">last</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* set last bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DMA_IN_STS_L</span><span class="p">);</span>
		<span class="cm">/* last desc. points to itself */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data_last</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Enabling RX DMA */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_set_rde</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;udc_set_rde()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* stop RDE timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_rde</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* set RDE */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVCTL_RDE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Queues a request packet, called by gadget driver */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">udc_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">usbep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">usbreq</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">open_rxfifo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">iflags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_ep</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* check the inputs */</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">usbreq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbep</span> <span class="o">||</span> <span class="o">!</span><span class="n">usbreq</span> <span class="o">||</span> <span class="o">!</span><span class="n">usbreq</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">||</span> <span class="o">!</span><span class="n">usbreq</span><span class="o">-&gt;</span><span class="n">buf</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">usbep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="n">UDC_EP0OUT_IX</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;udc_queue(): ep%d-in=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="cm">/* map dma (usually done before) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA map req %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_gadget_map_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="n">usbreq</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s queue req %p, len %d req-&gt;td_data=%p buf %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">usbep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">usbreq</span><span class="p">,</span> <span class="n">usbreq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="p">,</span> <span class="n">usbreq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="n">usbreq</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbreq</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">dma_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* on empty queue just do first transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* zlp */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbreq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* IN zlp&#39;s are handled by hardware */</span>
			<span class="n">complete_req</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: zlp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * if set_config or set_intf is waiting for ack by zlp</span>
<span class="cm">			 * then set CSR_DONE</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">set_cfg_not_acked</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVCTL_CSR_DONE</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">set_cfg_not_acked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* setup command is ACK&#39;ed now by zlp */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">waiting_zlp_ack_ep0in</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* clear NAK by writing CNAK in EP0_IN */</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_CNAK</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">naking</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">UDC_QUEUE_CNAK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">],</span>
							<span class="n">UDC_EP0IN_IX</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">waiting_zlp_ack_ep0in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">prep_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
			<span class="cm">/* write desc pointer to enable DMA */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* set HOST READY */</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span>
					<span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
						<span class="n">UDC_DMA_IN_STS_BS_HOST_READY</span><span class="p">,</span>
						<span class="n">UDC_DMA_IN_STS_BS</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* disabled rx dma while descriptor update */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* stop RDE timer */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">set_rde</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="cm">/* clear RDE */</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">AMD_UNMASK_BIT</span><span class="p">(</span><span class="n">UDC_DEVCTL_RDE</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
				<span class="n">open_rxfifo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * if BNA occurred then let BNA dummy desc.</span>
<span class="cm">				 * point to current desc.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_occurred</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;copy to BNA dummy desc.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_dummy_req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="p">,</span>
						<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_data_dma</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* write desc pointer */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_phys</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">desptr</span><span class="p">);</span>

			<span class="cm">/* clear NAK by writing CNAK */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">naking</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_CNAK</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">naking</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">UDC_QUEUE_CNAK</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* enable ep irq */</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqmsk</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">AMD_UNMASK_BIT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqmsk</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* enable ep irq */</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqmsk</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">AMD_UNMASK_BIT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqmsk</span><span class="p">);</span>
			<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * prep_dma not used for OUT ep&#39;s, this is not possible</span>
<span class="cm">		 * for PPB modes, because of chain creation reasons</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">prep_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;list_add</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* add request to ep queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

		<span class="cm">/* open rxfifo if out data queued */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">open_rxfifo</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* enable DMA */</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">dma_going</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">udc_set_rde</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="n">UDC_EP0OUT_IX</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_ep_queued</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* stop OUT naking */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">udc_rxfifo_pending</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;udc_queue(): pending bytes in &quot;</span>
					<span class="s">&quot;rxfifo after nyet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * read pending bytes afer nyet:</span>
<span class="cm">				 * referring to isr</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">udc_rxfifo_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* finish */</span>
					<span class="n">complete_req</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">udc_rxfifo_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">finished:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Empty request queue of an endpoint; caller holds spinlock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">empty_req_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">udc_request</span><span class="p">,</span>
			<span class="n">queue</span><span class="p">);</span>
		<span class="n">complete_req</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Dequeues a request packet, called by gadget driver */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udc_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">usbep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">usbreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc_ep</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">halted</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">iflags</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">usbep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbep</span> <span class="o">||</span> <span class="o">!</span><span class="n">usbreq</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span>
				<span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="n">UDC_EP0OUT_IX</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">usbreq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="n">halted</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* request in processing or next one */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dma_going</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cancel_transfer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="n">u32</span> <span class="n">dma_sts</span><span class="p">;</span>
				<span class="cm">/* stop potential receive DMA */</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AMD_UNMASK_BIT</span><span class="p">(</span><span class="n">UDC_DEVCTL_RDE</span><span class="p">),</span>
							<span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * Cancel transfer later in ISR</span>
<span class="cm">				 * if descriptor was touched.</span>
<span class="cm">				 */</span>
				<span class="n">dma_sts</span> <span class="o">=</span> <span class="n">AMD_GETBITS</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
							<span class="n">UDC_DMA_OUT_STS_BS</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dma_sts</span> <span class="o">!=</span> <span class="n">UDC_DMA_OUT_STS_BS_HOST_READY</span><span class="p">)</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cancel_transfer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">udc_init_bna_dummy</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
					<span class="n">writel</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_dummy_req</span><span class="o">-&gt;</span><span class="n">td_phys</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">desptr</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">complete_req</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="n">halted</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Halt or clear halt of endpoint */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">udc_set_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">usbep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">halt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbep</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;set_halt %s: halt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usbep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">halt</span><span class="p">);</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">usbep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="n">UDC_EP0OUT_IX</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_stall_spinlock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="cm">/* halt or clear halt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">halt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stall_ep0in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * set STALL</span>
<span class="cm">			 * rxfifo empty not taken into acount</span>
<span class="cm">			 */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_S</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* setup poll timer */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_pollstall_timer</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">udc_pollstall_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
					<span class="n">HZ</span> <span class="o">*</span> <span class="n">UDC_POLLSTALL_TIMER_USECONDS</span>
					<span class="o">/</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stop_pollstall_timer</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;start polltimer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_pollstall_timer</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* ep is halted by set_halt() before */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
			<span class="cm">/* clear stall bit */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AMD_CLEAR_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_S</span><span class="p">);</span>
			<span class="cm">/* clear NAK by writing CNAK */</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_CNAK</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">UDC_QUEUE_CNAK</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_stall_spinlock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* gadget interface */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">udc_ep_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">udc_ep_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">udc_ep_disable</span><span class="p">,</span>

	<span class="p">.</span><span class="n">alloc_request</span>	<span class="o">=</span> <span class="n">udc_alloc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_request</span>	<span class="o">=</span> <span class="n">udc_free_request</span><span class="p">,</span>

	<span class="p">.</span><span class="n">queue</span>		<span class="o">=</span> <span class="n">udc_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue</span>	<span class="o">=</span> <span class="n">udc_dequeue</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_halt</span>	<span class="o">=</span> <span class="n">udc_set_halt</span><span class="p">,</span>
	<span class="cm">/* fifo ops not implemented */</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* Get frame counter (not implemented) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udc_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Remote wakeup gadget interface */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udc_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gadget</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">udc</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="n">udc_remote_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">amd5536_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bind</span><span class="p">)(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="p">));</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">amd5536_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>
<span class="cm">/* gadget operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_gadget_ops</span> <span class="n">udc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">wakeup</span>		<span class="o">=</span> <span class="n">udc_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frame</span>	<span class="o">=</span> <span class="n">udc_get_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="n">amd5536_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>		<span class="o">=</span> <span class="n">amd5536_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Setups endpoint parameters, adds endpoints to linked list */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">make_ep_lists</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* make gadget ep lists */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EPIN_STATUS_IX</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EPIN_IX</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EPOUT_IX</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="cm">/* fifo config */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EPIN_STATUS_IX</span><span class="p">].</span><span class="n">fifo_depth</span> <span class="o">=</span> <span class="n">UDC_EPIN_SMALLINT_BUFF_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EPIN_IX</span><span class="p">].</span><span class="n">fifo_depth</span> <span class="o">=</span> <span class="n">UDC_FS_EPIN_BUFF_SIZE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EPIN_IX</span><span class="p">].</span><span class="n">fifo_depth</span> <span class="o">=</span> <span class="n">hs_tx_buf</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EPOUT_IX</span><span class="p">].</span><span class="n">fifo_depth</span> <span class="o">=</span> <span class="n">UDC_RXFIFO_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* init registers at driver load time */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">startup_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* init controller by soft reset */</span>
	<span class="n">udc_soft_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* mask not needed interrupts */</span>
	<span class="n">udc_mask_unused_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* put into initial config */</span>
	<span class="n">udc_basic_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* link up all endpoints */</span>
	<span class="n">udc_setup_endpoints</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* program speed */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_fullspeed</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_DEVCFG_SPD_FS</span><span class="p">,</span> <span class="n">UDC_DEVCFG_SPD</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_DEVCFG_SPD_HS</span><span class="p">,</span> <span class="n">UDC_DEVCFG_SPD</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Inits UDC context */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_basic_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">tmp</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;udc_basic_init()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>

	<span class="cm">/* stop RDE timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_rde</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* stop poll stall timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_pollstall_timer</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_pollstall_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* disable DMA */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">AMD_UNMASK_BIT</span><span class="p">(</span><span class="n">UDC_DEVCTL_RDE</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">AMD_UNMASK_BIT</span><span class="p">(</span><span class="n">UDC_DEVCTL_TDE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>

	<span class="cm">/* enable dynamic CSR programming */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVCFG_CSR_PRG</span><span class="p">);</span>
	<span class="cm">/* set self powered */</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVCFG_SP</span><span class="p">);</span>
	<span class="cm">/* set remote wakeupable */</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVCFG_RWKP</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">);</span>

	<span class="n">make_ep_lists</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_ep_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_ep_queued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Sets initial endpoint parameters */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_setup_endpoints</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">reg</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;udc_setup_endpoints()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* read enum speed */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_GETBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_DEVSTS_ENUM_SPEED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">UDC_DEVSTS_ENUM_SPEED_HIGH</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">UDC_DEVSTS_ENUM_SPEED_FULL</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>

	<span class="cm">/* set basic ep parameters */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">UDC_EP_NUM</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ep_string</span><span class="p">[</span><span class="n">tmp</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="cm">/* txfifo size is calculated at enable time */</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">txfifo</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">txfifo</span><span class="p">;</span>

		<span class="cm">/* fifo size */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">UDC_EPIN_NUM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_depth</span> <span class="o">=</span> <span class="n">UDC_TXFIFO_SIZE</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_depth</span> <span class="o">=</span> <span class="n">UDC_RXFIFO_SIZE</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep_regs</span><span class="p">[</span><span class="n">tmp</span><span class="p">];</span>
		<span class="cm">/*</span>
<span class="cm">		 * ep will be reset only if ep was not enabled before to avoid</span>
<span class="cm">		 * disabling ep interrupts when ENUM interrupt occurs but ep is</span>
<span class="cm">		 * not enabled by gadget driver</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span>
			<span class="n">ep_init</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * ep-&gt;dma is not really used, just to indicate that</span>
<span class="cm">			 * DMA is active: remove this</span>
<span class="cm">			 * dma regs = dev control regs</span>
<span class="cm">			 */</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">;</span>

			<span class="cm">/* nak OUT endpoints until enable - not for ep0 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">UDC_EP0IN_IX</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="n">UDC_EP0OUT_IX</span>
						<span class="o">&amp;&amp;</span> <span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">UDC_EPIN_NUM</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* set NAK */</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
				<span class="n">reg</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_SNAK</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">naking</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* EP0 max packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">UDC_FS_EP0IN_MAX_PKT_SIZE</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span>
						<span class="n">UDC_FS_EP0OUT_MAX_PKT_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">UDC_EP0IN_MAX_PKT_SIZE</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">UDC_EP0OUT_MAX_PKT_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * with suspend bug workaround, ep0 params for gadget driver</span>
<span class="cm">	 * are set at gadget driver bind() call</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">halted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="cm">/* init cfg/alt/int */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cur_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cur_intf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cur_alt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Bringup after Connect event, initial bringup to be ready for ep0 events */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usb_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB Connect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* put into initial config */</span>
	<span class="n">udc_basic_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* enable device setup interrupts */</span>
	<span class="n">udc_enable_dev_setup_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calls gadget with disconnect event and resets the UDC and makes</span>
<span class="cm"> * initial bringup to be ready for ep0 events</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usb_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB Disconnect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* mask interrupts */</span>
	<span class="n">udc_mask_unused_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* REVISIT there doesn&#39;t seem to be a point to having this</span>
<span class="cm">	 * talk to a tasklet ... do it directly, we already hold</span>
<span class="cm">	 * the spinlock needed to process the disconnect.</span>
<span class="cm">	 */</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disconnect_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Tasklet for disconnect to be outside of interrupt context */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_tasklet_disconnect</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">par</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">**</span><span class="p">)</span> <span class="n">par</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Tasklet disconnect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="cm">/* empty queues */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">UDC_EP_NUM</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span>
			<span class="n">empty_req_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">]);</span>

	<span class="p">}</span>

	<span class="cm">/* disable ep0 */</span>
	<span class="n">ep_init</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">]);</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">soft_reset_occured</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* init controller by soft reset */</span>
		<span class="n">udc_soft_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">soft_reset_occured</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* re-enable dev interrupts */</span>
	<span class="n">udc_enable_dev_setup_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* back to full speed ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_fullspeed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_DEVCFG_SPD_FS</span><span class="p">,</span> <span class="n">UDC_DEVCFG_SPD</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Reset the UDC core */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_soft_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Soft reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * reset possible waiting interrupts, because int.</span>
<span class="cm">	 * status is lost after soft reset,</span>
<span class="cm">	 * ep int. status reset</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">UDC_EPINT_MSK_DISABLE_ALL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqsts</span><span class="p">);</span>
	<span class="cm">/* device int. status reset */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">UDC_DEV_MSK_DISABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqsts</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_irq_spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVCFG_SOFTRESET</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_irq_spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* RDE timer callback to set RDE bit */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_timer_function</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_irq_spinlock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_rde</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * open the fifo if fifo was filled on last timer call</span>
<span class="cm">		 * conditionally</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set_rde</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* set RDE to receive setup data */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVCTL_RDE</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
			<span class="n">set_rde</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVSTS_RXFIFO_EMPTY</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * if fifo empty setup polling, do not just</span>
<span class="cm">			 * open the fifo</span>
<span class="cm">			 */</span>
			<span class="n">udc_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="n">UDC_RDE_TIMER_DIV</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stop_timer</span><span class="p">)</span>
				<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * fifo contains data now, setup timer for opening</span>
<span class="cm">			 * the fifo when timer expires to be able to receive</span>
<span class="cm">			 * setup packets, when data packets gets queued by</span>
<span class="cm">			 * gadget layer then timer will forced to expire with</span>
<span class="cm">			 * set_rde=0 (RDE is set in udc_queue())</span>
<span class="cm">			 */</span>
			<span class="n">set_rde</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* debug: lhadmot_timer_start = 221070 */</span>
			<span class="n">udc_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">*</span><span class="n">UDC_RDE_TIMER_SECONDS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stop_timer</span><span class="p">)</span>
				<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span>
		<span class="n">set_rde</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* RDE was set by udc_queue() */</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_irq_spinlock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stop_timer</span><span class="p">)</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">on_exit</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* Handle halt state, used in stall poll timer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_handle_halt_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="cm">/* set stall as long not halted */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="cm">/* STALL cleared ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_S</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * FIXME: MSC spec requires that stall remains</span>
<span class="cm">			 * even on receivng of CLEAR_FEATURE HALT. So</span>
<span class="cm">			 * we would set STALL again here to be compliant.</span>
<span class="cm">			 * But with current mass storage drivers this does</span>
<span class="cm">			 * not work (would produce endless host retries).</span>
<span class="cm">			 * So we clear halt on CLEAR_FEATURE.</span>
<span class="cm">			 *</span>
<span class="cm">			DBG(ep-&gt;dev, &quot;ep %d: set STALL again\n&quot;, ep-&gt;num);</span>
<span class="cm">			tmp |= AMD_BIT(UDC_EPCTL_S);</span>
<span class="cm">			writel(tmp, &amp;ep-&gt;regs-&gt;ctl);*/</span>

			<span class="cm">/* clear NAK by writing CNAK */</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_CNAK</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">UDC_QUEUE_CNAK</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Stall timer callback to poll S bit and set it again after */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_pollstall_timer_function</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">halted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_stall_spinlock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * only one IN and OUT endpoints are handled</span>
<span class="cm">	 * IN poll stall</span>
<span class="cm">	 */</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EPIN_IX</span><span class="p">];</span>
	<span class="n">udc_handle_halt_state</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span><span class="p">)</span>
		<span class="n">halted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* OUT poll stall */</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EPOUT_IX</span><span class="p">];</span>
	<span class="n">udc_handle_halt_state</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span><span class="p">)</span>
		<span class="n">halted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* setup timer again when still halted */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stop_pollstall_timer</span> <span class="o">&amp;&amp;</span> <span class="n">halted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udc_pollstall_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
					<span class="n">HZ</span> <span class="o">*</span> <span class="n">UDC_POLLSTALL_TIMER_USECONDS</span>
					<span class="o">/</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_pollstall_timer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_stall_spinlock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stop_pollstall_timer</span><span class="p">)</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">on_pollstall_exit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Inits endpoint 0 so that SETUP packets are processed */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">activate_control_endpoints</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;activate_control_endpoints</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* flush fifo */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_F</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>

	<span class="cm">/* set ep0 directions */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set buffer size (tx fifo entries) of EP0_IN */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">bufin_framenum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_FS_EPIN0_BUFF_SIZE</span><span class="p">,</span>
					<span class="n">UDC_EPIN_BUFF_SIZE</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_EPIN0_BUFF_SIZE</span><span class="p">,</span>
					<span class="n">UDC_EPIN_BUFF_SIZE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">bufin_framenum</span><span class="p">);</span>

	<span class="cm">/* set max packet size of EP0_IN */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">bufout_maxpkt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_FS_EP0IN_MAX_PKT_SIZE</span><span class="p">,</span>
					<span class="n">UDC_EP_MAX_PKT_SIZE</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_EP0IN_MAX_PKT_SIZE</span><span class="p">,</span>
				<span class="n">UDC_EP_MAX_PKT_SIZE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">bufout_maxpkt</span><span class="p">);</span>

	<span class="cm">/* set max packet size of EP0_OUT */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">bufout_maxpkt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_FS_EP0OUT_MAX_PKT_SIZE</span><span class="p">,</span>
					<span class="n">UDC_EP_MAX_PKT_SIZE</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_EP0OUT_MAX_PKT_SIZE</span><span class="p">,</span>
					<span class="n">UDC_EP_MAX_PKT_SIZE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">bufout_maxpkt</span><span class="p">);</span>

	<span class="cm">/* set max packet size of EP0 in UDC CSR */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_FS_EP0OUT_MAX_PKT_SIZE</span><span class="p">,</span>
					<span class="n">UDC_CSR_NE_MAX_PKT</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_EP0OUT_MAX_PKT_SIZE</span><span class="p">,</span>
					<span class="n">UDC_CSR_NE_MAX_PKT</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span>
			<span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DMA_OUT_STS_L</span><span class="p">);</span>
		<span class="cm">/* write dma desc address */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">td_stp_dma</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">subptr</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">td_phys</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">desptr</span><span class="p">);</span>
		<span class="cm">/* stop RDE timer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_rde</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* stop pollstall timer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_pollstall_timer</span><span class="p">))</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_pollstall_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* enable DMA */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVCTL_MODE</span><span class="p">)</span>
				<span class="o">|</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVCTL_RDE</span><span class="p">)</span>
				<span class="o">|</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVCTL_TDE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_dma_bufferfill_mode</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVCTL_BF</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">use_dma_ppb_du</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVCTL_DU</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* clear NAK by writing CNAK for EP0IN */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_CNAK</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">naking</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">UDC_QUEUE_CNAK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">],</span> <span class="n">UDC_EP0IN_IX</span><span class="p">);</span>

	<span class="cm">/* clear NAK by writing CNAK for EP0OUT */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_CNAK</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">naking</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">UDC_QUEUE_CNAK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">],</span> <span class="n">UDC_EP0OUT_IX</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Make endpoint 0 ready for control traffic */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_ep0</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">activate_control_endpoints</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* enable ep0 interrupts */</span>
	<span class="n">udc_enable_ep0_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* enable device setup interrupts */</span>
	<span class="n">udc_enable_dev_setup_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called by gadget driver to register itself */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd5536_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bind</span><span class="p">)(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">udc</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span> <span class="o">||</span> <span class="o">!</span><span class="n">bind</span> <span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span>
			<span class="o">||</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">max_speed</span> <span class="o">&lt;</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>

	<span class="cm">/* Some gadget drivers use both ep0 directions.</span>
<span class="cm">	 * NOTE: to gadget driver, ep0 is just one endpoint...</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;binding to %s returning %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get ready for ep0 traffic */</span>
	<span class="n">setup_ep0</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* clear SD */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AMD_CLEAR_BIT</span><span class="p">(</span><span class="n">UDC_DEVCTL_SD</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>

	<span class="n">usb_connect</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* shutdown requests and disconnect from gadget */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">driver</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* empty queues and init hardware */</span>
	<span class="n">udc_basic_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">UDC_EP_NUM</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span>
		<span class="n">empty_req_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">]);</span>

	<span class="n">udc_setup_endpoints</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called by gadget driver to unregister itself */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd5536_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">udc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span> <span class="o">||</span> <span class="n">driver</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">udc_mask_unused_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">shutdown</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">driver</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* set SD */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVCTL_SD</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>


	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: unregistered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Clear pending NAK bits */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_process_cnak_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* check epin&#39;s */</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CNAK pending queue processing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">UDC_EPIN_NUM_USED</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnak_pending</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tmp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CNAK pending for ep%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="cm">/* clear NAK by writing CNAK */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_CNAK</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">naking</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">UDC_QUEUE_CNAK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">num</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* ...	and ep0out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnak_pending</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">UDC_EP0OUT_IX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CNAK pending for ep%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">UDC_EP0OUT_IX</span><span class="p">);</span>
		<span class="cm">/* clear NAK by writing CNAK */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_CNAK</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">naking</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">UDC_QUEUE_CNAK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">],</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">num</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Enabling RX DMA after setup packet */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_ep0_set_rde</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * only enable RXDMA when no data endpoint enabled</span>
<span class="cm">		 * or data is queued</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_ep_enabled</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_ep_queued</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udc_set_rde</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * setup timer for enabling RDE (to not enable</span>
<span class="cm">			 * RXFIFO DMA for data endpoints to early)</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">set_rde</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">udc_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
					<span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="n">UDC_RDE_TIMER_DIV</span><span class="p">;</span>
				<span class="n">set_rde</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stop_timer</span><span class="p">)</span>
					<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Interrupt handler for data OUT traffic */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">udc_data_out_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ep_ix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqreturn_t</span>		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_ep</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_data_dma</span>	<span class="o">*</span><span class="n">td</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">dma_done</span><span class="p">;</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ep%d irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep_ix</span><span class="p">);</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">ep_ix</span><span class="p">];</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BNA event ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_BNA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BNA ep%dout occurred - DESPTR = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">desptr</span><span class="p">));</span>
			<span class="cm">/* clear BNA */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_BNA</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">cancel_transfer</span><span class="p">)</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_occurred</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cancel_transfer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* HE event ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_HE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HE ep%dout occurred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>

		<span class="cm">/* clear HE */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_HE</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* next request */</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">udc_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">udc_rxfifo_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;req = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="cm">/* fifo mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* read fifo */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="n">udc_rxfifo_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

			<span class="cm">/* finish */</span>
			<span class="n">complete_req</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/* next request */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">udc_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/* DMA */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">cancel_transfer</span> <span class="o">&amp;&amp;</span> <span class="n">req</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

		<span class="cm">/* check for DMA done */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma_ppb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_done</span> <span class="o">=</span> <span class="n">AMD_GETBITS</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
						<span class="n">UDC_DMA_OUT_STS_BS</span><span class="p">);</span>
		<span class="cm">/* packet per buffer mode - rx bytes */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * if BNA occurred then recover desc. from</span>
<span class="cm">			 * BNA dummy desc.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_occurred</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Recover desc. from BNA dummy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_dummy_req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_data_dma</span><span class="p">));</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_occurred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">udc_init_bna_dummy</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">td</span> <span class="o">=</span> <span class="n">udc_get_last_dma_desc</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
			<span class="n">dma_done</span> <span class="o">=</span> <span class="n">AMD_GETBITS</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">UDC_DMA_OUT_STS_BS</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_done</span> <span class="o">==</span> <span class="n">UDC_DMA_OUT_STS_BS_DMA_DONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* buffer fill mode - rx bytes */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma_ppb</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* received number bytes */</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">AMD_GETBITS</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
						<span class="n">UDC_DMA_OUT_STS_RXBYTES</span><span class="p">);</span>
				<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rx bytes=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="cm">/* packet per buffer mode - rx bytes */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;req-&gt;td_data=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="p">);</span>
				<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;last desc = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
				<span class="cm">/* received number bytes */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">use_dma_ppb_du</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* every desc. counts bytes */</span>
					<span class="n">count</span> <span class="o">=</span> <span class="n">udc_get_ppbdu_rxbytes</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* last desc. counts bytes */</span>
					<span class="n">count</span> <span class="o">=</span> <span class="n">AMD_GETBITS</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
						<span class="n">UDC_DMA_OUT_STS_RXBYTES</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span>
						<span class="o">==</span> <span class="n">UDC_DMA_MAXPACKET</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/*</span>
<span class="cm">						 * on 64k packets the RXBYTES</span>
<span class="cm">						 * field is zero</span>
<span class="cm">						 */</span>
						<span class="n">count</span> <span class="o">=</span> <span class="n">UDC_DMA_MAXPACKET</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;last desc rx bytes=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: rx %db, space=%db</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">dma_going</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* complete request */</span>
			<span class="n">complete_req</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* next request */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">udc_request</span><span class="p">,</span>
					<span class="n">queue</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * DMA may be already started by udc_queue()</span>
<span class="cm">				 * called by gadget drivers completion</span>
<span class="cm">				 * routine. This happens when queue</span>
<span class="cm">				 * holds one request only.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dma_going</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* next dma */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">prep_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
					<span class="cm">/* write desc pointer */</span>
					<span class="n">writel</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_phys</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">desptr</span><span class="p">);</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">dma_going</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="cm">/* enable DMA */</span>
					<span class="n">udc_set_rde</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * implant BNA dummy descriptor to allow</span>
<span class="cm">				 * RXFIFO opening by RDE</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_dummy_req</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* write desc pointer */</span>
					<span class="n">writel</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_dummy_req</span><span class="o">-&gt;</span><span class="n">td_phys</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">desptr</span><span class="p">);</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_occurred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/*</span>
<span class="cm">				 * schedule timer for setting RDE if queue</span>
<span class="cm">				 * remains empty to allow ep0 packets pass</span>
<span class="cm">				 * through</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">set_rde</span> <span class="o">!=</span> <span class="mi">0</span>
						<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">udc_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
						<span class="n">jiffies</span>
						<span class="o">+</span> <span class="n">HZ</span><span class="o">*</span><span class="n">UDC_RDE_TIMER_SECONDS</span><span class="p">;</span>
					<span class="n">set_rde</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stop_timer</span><span class="p">)</span>
						<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="n">UDC_EP0OUT_IX</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_ep_queued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			* RX DMA must be reenabled for each desc in PPBDU mode</span>
<span class="cm">			* and must be enabled for PPBNDU mode in case of BNA</span>
<span class="cm">			*/</span>
			<span class="n">udc_set_rde</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">cancel_transfer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cancel_transfer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check pending CNAKS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnak_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* CNAk processing when rxfifo empty only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVSTS_RXFIFO_EMPTY</span><span class="p">))</span>
			<span class="n">udc_process_cnak_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* clear OUT bits in ep status */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">UDC_EPSTS_OUT_CLEAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
<span class="nl">finished:</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Interrupt handler for data IN traffic */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">udc_data_in_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ep_ix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqreturn_t</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">epsts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_data_dma</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">dma_done</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">ep_ix</span><span class="p">];</span>

	<span class="n">epsts</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BNA ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">epsts</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_BNA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;BNA ep%din occurred - DESPTR = %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">desptr</span><span class="p">));</span>

			<span class="cm">/* clear BNA */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">epsts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* HE event ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epsts</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_HE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;HE ep%dn occurred - DESPTR = %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">desptr</span><span class="p">));</span>

		<span class="cm">/* clear HE */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">epsts</span> <span class="o">|</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_HE</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* DMA completion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epsts</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_TDC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TDC set- completion</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">cancel_transfer</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">udc_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * length bytes transferred</span>
<span class="cm">			 * check dma done of last desc. in PPBDU mode</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">use_dma_ppb_du</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">td</span> <span class="o">=</span> <span class="n">udc_get_last_dma_desc</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dma_done</span> <span class="o">=</span>
						<span class="n">AMD_GETBITS</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
						<span class="n">UDC_DMA_IN_STS_BS</span><span class="p">);</span>
					<span class="cm">/* don&#39;t care DMA done */</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* assume all bytes transferred */</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* complete req */</span>
				<span class="n">complete_req</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">dma_going</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* further request available ? */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* disable interrupt */</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqmsk</span><span class="p">);</span>
					<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
					<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqmsk</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cancel_transfer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * status reg has IN bit set and TDC not set (if TDC was handled,</span>
<span class="cm">	 * IN must not be handled (UDC defect) ?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">epsts</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_IN</span><span class="p">))</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">epsts</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_TDC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* next request */</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">udc_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
			<span class="cm">/* FIFO mode */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* write fifo */</span>
				<span class="n">udc_txfifo_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span>
					<span class="n">len</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">;</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span>
					<span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* complete req */</span>
					<span class="n">complete_req</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="cm">/* DMA */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dma_going</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IN DMA : req=%p req-&gt;td_data=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">req</span><span class="o">-&gt;</span><span class="n">dma_going</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

					<span class="cm">/*</span>
<span class="cm">					 * unset L bit of first desc.</span>
<span class="cm">					 * for chain</span>
<span class="cm">					 */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">use_dma_ppb</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span>
							<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span>
							<span class="n">AMD_CLEAR_BIT</span><span class="p">(</span>
							<span class="n">UDC_DMA_IN_STS_L</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="cm">/* write desc pointer */</span>
					<span class="n">writel</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_phys</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">desptr</span><span class="p">);</span>

					<span class="cm">/* set HOST READY */</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span>
						<span class="n">AMD_ADDBITS</span><span class="p">(</span>
						<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
						<span class="n">UDC_DMA_IN_STS_BS_HOST_READY</span><span class="p">,</span>
						<span class="n">UDC_DMA_IN_STS_BS</span><span class="p">);</span>

					<span class="cm">/* set poll demand bit */</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
					<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_P</span><span class="p">);</span>
					<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* disable interrupt */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqmsk</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqmsk</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* clear status bits */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">epsts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>

<span class="nl">finished:</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* Interrupt handler for Control OUT traffic */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">udc_control_out_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqreturn_t</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">setup_supported</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_ep</span>	<span class="o">*</span><span class="n">ep_tmp</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">];</span>

	<span class="cm">/* clear irq */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPINT_OUT_EP0</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqsts</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
	<span class="cm">/* check BNA and clear if set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_BNA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ep0: BNA set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_BNA</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_occurred</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* type of data: SETUP or DATA 0 bytes */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_GETBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_EPSTS_OUT</span><span class="p">);</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;data_typ = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* setup data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">UDC_EPSTS_OUT_SETUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stall_ep0in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">waiting_zlp_ack_ep0in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* set NAK for EP0_IN */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_SNAK</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">naking</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* get setup data */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* clear OUT bits in ep status */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">UDC_EPSTS_OUT_CLEAR</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>

			<span class="n">setup_data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">td_stp</span><span class="o">-&gt;</span><span class="n">data12</span><span class="p">;</span>
			<span class="n">setup_data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">td_stp</span><span class="o">-&gt;</span><span class="n">data34</span><span class="p">;</span>
			<span class="cm">/* set HOST READY */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">td_stp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span>
					<span class="n">UDC_DMA_STP_STS_BS_HOST_READY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* read fifo */</span>
			<span class="n">udc_rxfifo_read_dwords</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">setup_data</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* determine direction of control data */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">setup_data</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">ep</span><span class="p">;</span>
			<span class="cm">/* enable RDE */</span>
			<span class="n">udc_ep0_set_rde</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">ep</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * implant BNA dummy descriptor to allow RXFIFO opening</span>
<span class="cm">			 * by RDE</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_dummy_req</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* write desc pointer */</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_dummy_req</span><span class="o">-&gt;</span><span class="n">td_phys</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">desptr</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">bna_occurred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">naking</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * setup timer for enabling RDE (to not enable</span>
<span class="cm">			 * RXFIFO DMA for data to early)</span>
<span class="cm">			 */</span>
			<span class="n">set_rde</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">udc_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
							<span class="n">HZ</span><span class="o">/</span><span class="n">UDC_RDE_TIMER_DIV</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stop_timer</span><span class="p">)</span>
					<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * mass storage reset must be processed here because</span>
<span class="cm">		 * next packet may be a CLEAR_FEATURE HALT which would not</span>
<span class="cm">		 * clear the stall bit when no STALL handshake was received</span>
<span class="cm">		 * before (autostall can cause this)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setup_data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">UDC_MSCRES_DWORD0</span>
				<span class="o">&amp;&amp;</span> <span class="n">setup_data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">UDC_MSCRES_DWORD1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MSC Reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * clear stall bits</span>
<span class="cm">			 * only one IN and OUT endpoints are handled</span>
<span class="cm">			 */</span>
			<span class="n">ep_tmp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EPIN_IX</span><span class="p">];</span>
			<span class="n">udc_set_halt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep_tmp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ep_tmp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EPOUT_IX</span><span class="p">];</span>
			<span class="n">udc_set_halt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep_tmp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* call gadget with setup data received */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">setup_supported</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">setup_data</span><span class="p">.</span><span class="n">request</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="cm">/* ep0 in returns data (not zlp) on IN phase */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setup_supported</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">setup_supported</span> <span class="o">&lt;</span>
				<span class="n">UDC_EP0IN_MAXPACKET</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* clear NAK by writing CNAK in EP0_IN */</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_CNAK</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">naking</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">UDC_QUEUE_CNAK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">],</span> <span class="n">UDC_EP0IN_IX</span><span class="p">);</span>

		<span class="cm">/* if unsupported request then stall */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">setup_supported</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_S</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">waiting_zlp_ack_ep0in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>


		<span class="cm">/* clear NAK by writing CNAK in EP0_OUT */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_CNAK</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">naking</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">UDC_QUEUE_CNAK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">],</span> <span class="n">UDC_EP0OUT_IX</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* clear OUT bits in ep status */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">UDC_EPSTS_OUT_CLEAR</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="cm">/* data packet 0 bytes */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">UDC_EPSTS_OUT_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clear OUT bits in ep status */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">UDC_EPSTS_OUT_CLEAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>

		<span class="cm">/* get setup data: only 0 packet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* no req if 0 packet, just reactivate */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ZLP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="cm">/* set HOST READY */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span>
					<span class="n">AMD_ADDBITS</span><span class="p">(</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
					<span class="n">UDC_DMA_OUT_STS_BS_HOST_READY</span><span class="p">,</span>
					<span class="n">UDC_DMA_OUT_STS_BS</span><span class="p">);</span>
				<span class="cm">/* enable RDE */</span>
				<span class="n">udc_ep0_set_rde</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* control write */</span>
				<span class="n">ret_val</span> <span class="o">|=</span> <span class="n">udc_data_out_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">UDC_EP0OUT_IX</span><span class="p">);</span>
				<span class="cm">/* re-program desc. pointer for possible ZLPs */</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">td_phys</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">desptr</span><span class="p">);</span>
				<span class="cm">/* enable RDE */</span>
				<span class="n">udc_ep0_set_rde</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="cm">/* received number bytes */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">AMD_GETBITS</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">UDC_EPSTS_RX_PKT_SIZE</span><span class="p">);</span>
			<span class="cm">/* out data for fifo mode not working */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* 0 packet or real data ? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret_val</span> <span class="o">|=</span> <span class="n">udc_data_out_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">UDC_EP0OUT_IX</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* dummy read confirm */</span>
				<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">confirm</span><span class="p">);</span>
				<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* check pending CNAKS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnak_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* CNAk processing when rxfifo empty only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVSTS_RXFIFO_EMPTY</span><span class="p">))</span>
			<span class="n">udc_process_cnak_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">finished:</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Interrupt handler for Control IN traffic */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">udc_control_in_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqreturn_t</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">];</span>

	<span class="cm">/* clear irq */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPINT_IN_EP0</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqsts</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
	<span class="cm">/* DMA completion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_TDC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;isr: TDC clear</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

		<span class="cm">/* clear TDC bit */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_TDC</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>

	<span class="cm">/* status reg has IN bit set ? */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_IN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* clear IN bit */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_IN</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stall_ep0in</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;stall ep0in</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* halt ep0in */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_S</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* next request */</span>
				<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">udc_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* write desc pointer */</span>
					<span class="n">writel</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_phys</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">desptr</span><span class="p">);</span>
					<span class="cm">/* set HOST READY */</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span>
						<span class="n">AMD_ADDBITS</span><span class="p">(</span>
						<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
						<span class="n">UDC_DMA_STP_STS_BS_HOST_READY</span><span class="p">,</span>
						<span class="n">UDC_DMA_STP_STS_BS</span><span class="p">);</span>

					<span class="cm">/* set poll demand bit */</span>
					<span class="n">tmp</span> <span class="o">=</span>
					<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
					<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_P</span><span class="p">);</span>
					<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>

					<span class="cm">/* all bytes will be transferred */</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>

					<span class="cm">/* complete req */</span>
					<span class="n">complete_req</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* write fifo */</span>
					<span class="n">udc_txfifo_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>

					<span class="cm">/* lengh bytes transferred */</span>
					<span class="n">len</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span>
						<span class="n">len</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">;</span>

					<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span>
						<span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">))</span> <span class="p">{</span>
						<span class="cm">/* complete req */</span>
						<span class="n">complete_req</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>

			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stall_ep0in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* clear IN bit */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPSTS_IN</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Interrupt handler for global device events */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">udc_dev_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dev_irq</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqreturn_t</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">udc_csr_epix</span><span class="p">;</span>

	<span class="cm">/* SET_CONFIG irq ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_irq</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_SC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

		<span class="cm">/* read config value */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
		<span class="n">cfg</span> <span class="o">=</span> <span class="n">AMD_GETBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_DEVSTS_CFG</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SET_CONFIG interrupt: config=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cur_config</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">set_cfg_not_acked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* make usb request for gadget driver */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">setup_data</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">udc_setup_data</span><span class="p">));</span>
		<span class="n">setup_data</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">USB_REQ_SET_CONFIGURATION</span><span class="p">;</span>
		<span class="n">setup_data</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">wValue</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cur_config</span><span class="p">);</span>

		<span class="cm">/* programm the NE registers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UDC_EP_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* ep ix in UDC CSR register space */</span>
				<span class="n">udc_csr_epix</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>


			<span class="cm">/* OUT ep */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* ep ix in UDC CSR register space */</span>
				<span class="n">udc_csr_epix</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">-</span> <span class="n">UDC_CSR_EP_OUT_IX_OFS</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">ne</span><span class="p">[</span><span class="n">udc_csr_epix</span><span class="p">]);</span>
			<span class="cm">/* ep cfg */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cur_config</span><span class="p">,</span>
						<span class="n">UDC_CSR_NE_CFG</span><span class="p">);</span>
			<span class="cm">/* write reg */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">ne</span><span class="p">[</span><span class="n">udc_csr_epix</span><span class="p">]);</span>

			<span class="cm">/* clear stall bits */</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AMD_CLEAR_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_S</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* call gadget zero with setup data received */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup_data</span><span class="p">.</span><span class="n">request</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="p">}</span> <span class="cm">/* SET_INTERFACE ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_irq</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_SI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">set_cfg_not_acked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* read interface and alt setting values */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cur_alt</span> <span class="o">=</span> <span class="n">AMD_GETBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_DEVSTS_ALT</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cur_intf</span> <span class="o">=</span> <span class="n">AMD_GETBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_DEVSTS_INTF</span><span class="p">);</span>

		<span class="cm">/* make usb request for gadget driver */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">setup_data</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">udc_setup_data</span><span class="p">));</span>
		<span class="n">setup_data</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">USB_REQ_SET_INTERFACE</span><span class="p">;</span>
		<span class="n">setup_data</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">;</span>
		<span class="n">setup_data</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">wValue</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cur_alt</span><span class="p">);</span>
		<span class="n">setup_data</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cur_intf</span><span class="p">);</span>

		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SET_INTERFACE interrupt: alt=%d intf=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cur_alt</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cur_intf</span><span class="p">);</span>

		<span class="cm">/* programm the NE registers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UDC_EP_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* ep ix in UDC CSR register space */</span>
				<span class="n">udc_csr_epix</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>


			<span class="cm">/* OUT ep */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* ep ix in UDC CSR register space */</span>
				<span class="n">udc_csr_epix</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">-</span> <span class="n">UDC_CSR_EP_OUT_IX_OFS</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* UDC CSR reg */</span>
			<span class="cm">/* set ep values */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">ne</span><span class="p">[</span><span class="n">udc_csr_epix</span><span class="p">]);</span>
			<span class="cm">/* ep interface */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cur_intf</span><span class="p">,</span>
						<span class="n">UDC_CSR_NE_INTF</span><span class="p">);</span>
			<span class="cm">/* tmp = AMD_ADDBITS(tmp, 2, UDC_CSR_NE_INTF); */</span>
			<span class="cm">/* ep alt */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">AMD_ADDBITS</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cur_alt</span><span class="p">,</span>
						<span class="n">UDC_CSR_NE_ALT</span><span class="p">);</span>
			<span class="cm">/* write reg */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">ne</span><span class="p">[</span><span class="n">udc_csr_epix</span><span class="p">]);</span>

			<span class="cm">/* clear stall bits */</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">halted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AMD_CLEAR_BIT</span><span class="p">(</span><span class="n">UDC_EPCTL_S</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* call gadget zero with setup data received */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup_data</span><span class="p">.</span><span class="n">request</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="p">}</span> <span class="cm">/* USB reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_irq</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_UR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB Reset interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

		<span class="cm">/* allow soft reset when suspend occurs */</span>
		<span class="n">soft_reset_occured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">waiting_zlp_ack_ep0in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">set_cfg_not_acked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* mask not needed interrupts */</span>
		<span class="n">udc_mask_unused_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* call gadget to resume and reset configs etc. */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sys_suspended</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sys_suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="cm">/* disable ep0 to empty req queue */</span>
		<span class="n">empty_req_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">]);</span>
		<span class="n">ep_init</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">]);</span>

		<span class="cm">/* soft reset when rxfifo not empty */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVSTS_RXFIFO_EMPTY</span><span class="p">))</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">soft_reset_after_usbreset_occured</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udc_soft_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">soft_reset_after_usbreset_occured</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * DMA reset to kill potential old DMA hw hang,</span>
<span class="cm">		 * POLL bit is already reset by ep_init() through</span>
<span class="cm">		 * disconnect()</span>
<span class="cm">		 */</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA machine reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVCFG_DMARST</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">);</span>

		<span class="cm">/* put into initial config */</span>
		<span class="n">udc_basic_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* enable device setup interrupts */</span>
		<span class="n">udc_enable_dev_setup_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* enable suspend interrupt */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqmsk</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">AMD_UNMASK_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_US</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqmsk</span><span class="p">);</span>

	<span class="p">}</span> <span class="cm">/* USB suspend */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_irq</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_US</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB Suspend interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sys_suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="cm">/* new speed ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_irq</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_ENUM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ENUM interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="n">soft_reset_after_usbreset_occured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* disable ep0 to empty req queue */</span>
		<span class="n">empty_req_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">]);</span>
		<span class="n">ep_init</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">]);</span>

		<span class="cm">/* link up all endpoints */</span>
		<span class="n">udc_setup_endpoints</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Connect: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">usb_speed_string</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span><span class="p">));</span>

		<span class="cm">/* init ep 0 */</span>
		<span class="n">activate_control_endpoints</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* enable ep0 interrupts */</span>
		<span class="n">udc_enable_ep0_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* session valid change interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_irq</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_SVC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB SVC interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

		<span class="cm">/* check that session is not valid to detect disconnect */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVSTS_SESSVLD</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* disable suspend interrupt */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqmsk</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVINT_US</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqmsk</span><span class="p">);</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB Disconnect (session valid low)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* cleanup on disconnect */</span>
			<span class="n">usb_disconnect</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Interrupt Service Routine, see Linux Kernel Doc for parameters */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">udc_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ep_irq</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* check for ep irq */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqsts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPINT_OUT_EP0</span><span class="p">))</span>
			<span class="n">ret_val</span> <span class="o">|=</span> <span class="n">udc_control_out_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_EPINT_IN_EP0</span><span class="p">))</span>
			<span class="n">ret_val</span> <span class="o">|=</span> <span class="n">udc_control_in_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * data endpoint</span>
<span class="cm">		 * iterate ep&#39;s</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UDC_EP_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep_irq</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">ep_irq</span><span class="p">)</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">UDC_EPINT_OUT_EP0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* clear irq status */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ep_irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqsts</span><span class="p">);</span>

			<span class="cm">/* irq for out ep ? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">UDC_EPIN_NUM</span><span class="p">)</span>
				<span class="n">ret_val</span> <span class="o">|=</span> <span class="n">udc_data_out_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ret_val</span> <span class="o">|=</span> <span class="n">udc_data_in_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>


	<span class="cm">/* check for dev irq */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqsts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clear irq */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqsts</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">|=</span> <span class="n">udc_dev_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Tears down device */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gadget_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd5536udc</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Cleanup on device remove */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* remove timer */</span>
	<span class="n">stop_timer</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">))</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">on_exit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc_timer</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">);</span>
	<span class="cm">/* remove pollstall timer */</span>
	<span class="n">stop_pollstall_timer</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_pollstall_timer</span><span class="p">))</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">on_pollstall_exit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc_pollstall_timer</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_pollstall_timer</span><span class="p">);</span>
	<span class="n">udc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Reset all pci context */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">usb_del_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="cm">/* gadget driver must not be registered */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* dma pool cleanup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_requests</span><span class="p">)</span>
		<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_requests</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stp_requests</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* cleanup DMA desc&#39;s for ep0in */</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stp_requests</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">td_stp</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">td_stp_dma</span><span class="p">);</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stp_requests</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">td</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">td_phys</span><span class="p">);</span>

		<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stp_requests</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* reset controller */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVCFG_SOFTRESET</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_registered</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_region</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">udc_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* create dma pools on init */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_dma_pools</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc_stp_dma</span>	<span class="o">*</span><span class="n">td_stp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udc_data_dma</span>	<span class="o">*</span><span class="n">td_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* consistent DMA mode setting ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma_ppb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">use_dma_bufferfill_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">use_dma_ppb_du</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">use_dma_bufferfill_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* DMA setup */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_requests</span> <span class="o">=</span> <span class="n">dma_pool_create</span><span class="p">(</span><span class="s">&quot;data_requests&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_data_dma</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_requests</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t get request data pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* EP0 in dma regs = dev control regs */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0IN_IX</span><span class="p">].</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">;</span>

	<span class="cm">/* dma desc for setup data */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stp_requests</span> <span class="o">=</span> <span class="n">dma_pool_create</span><span class="p">(</span><span class="s">&quot;setup requests&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc_stp_dma</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stp_requests</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t get stp request pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* setup */</span>
	<span class="n">td_stp</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stp_requests</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">td_stp_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td_stp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">td_stp</span> <span class="o">=</span> <span class="n">td_stp</span><span class="p">;</span>

	<span class="cm">/* data: 0 packets !? */</span>
	<span class="n">td_data</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stp_requests</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">td_phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_EP0OUT_IX</span><span class="p">].</span><span class="n">td</span> <span class="o">=</span> <span class="n">td_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">finished:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called by pci bus driver to init pci context */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udc_pci_probe</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udc</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">resource</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* one udc only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;already probed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* init */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* pci setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* PCI resource allocation */</span>
	<span class="n">resource</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pci device used already</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_region</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;start address cannot be mapped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* udc csr registers base */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">UDC_CSR_ADDR</span><span class="p">;</span>
	<span class="cm">/* dev registers base */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">UDC_DEVCFG_ADDR</span><span class="p">;</span>
	<span class="cm">/* ep registers base */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep_regs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">UDC_EPREGS_ADDR</span><span class="p">;</span>
	<span class="cm">/* fifo&#39;s base */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxfifo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">UDC_RXFIFO_ADDR</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">txfifo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">UDC_TXFIFO_ADDR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">udc_irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request_irq(%d) fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* chip revision for Hs AMD5536 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">chiprev</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_try_set_mwi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* init dma pools */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">init_dma_pools</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phys_addr</span> <span class="o">=</span> <span class="n">resource</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span><span class="p">;</span>

	<span class="cm">/* general probing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">finished:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">udc_pci_remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* general probe */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>		<span class="n">tmp</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="n">u32</span>		<span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* mark timer as not initialized */</span>
	<span class="n">udc_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">udc_pollstall_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* device struct setup */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc_ops</span><span class="p">;</span>

	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gadget&quot;</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">gadget_release</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">max_speed</span> <span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">;</span>

	<span class="cm">/* init registers, interrupts, ... */</span>
	<span class="n">startup_registers</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mod_desc</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;irq %s, pci mem %08lx, chip rev %02x(Geode5536 %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tmp</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">chiprev</span><span class="p">,</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chiprev</span> <span class="o">==</span> <span class="n">UDC_HSA0_REV</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;A0&quot;</span> <span class="o">:</span> <span class="s">&quot;B1&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">UDC_DRIVER_VERSION_STRING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chiprev</span> <span class="o">==</span> <span class="n">UDC_HSA0_REV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;chip revision is A0; too old</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;driver version: %s(for Geode5536 B1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">udc</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_add_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_del_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* timer init */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_timer</span><span class="p">);</span>
	<span class="n">udc_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">udc_timer_function</span><span class="p">;</span>
	<span class="n">udc_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* timer pollstall init */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_pollstall_timer</span><span class="p">);</span>
	<span class="n">udc_pollstall_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">udc_pollstall_timer_function</span><span class="p">;</span>
	<span class="n">udc_pollstall_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* set SD */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVCTL_SD</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>

	<span class="cm">/* print dev register info */</span>
	<span class="n">print_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">finished:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initiates a remote wakeup */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udc_remote_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;UDC initiates remote wakeup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">AMD_BIT</span><span class="p">(</span><span class="n">UDC_DEVCTL_RES</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">AMD_CLEAR_BIT</span><span class="p">(</span><span class="n">UDC_DEVCTL_RES</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* PCI device parameters */</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci_id</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_AMD</span><span class="p">,</span> <span class="mh">0x2096</span><span class="p">),</span>
		<span class="p">.</span><span class="n">class</span> <span class="o">=</span>	<span class="p">(</span><span class="n">PCI_CLASS_SERIAL_USB</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xfe</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class_mask</span> <span class="o">=</span>	<span class="mh">0xffffffff</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_id</span><span class="p">);</span>

<span class="cm">/* PCI functions */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">udc_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">pci_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">udc_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>	<span class="n">udc_pci_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">udc_pci_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">UDC_MOD_DESCRIPTION</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Thomas Dahlmann&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
