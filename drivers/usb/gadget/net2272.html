<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › gadget › net2272.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>net2272.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for PLX NET2272 USB device controller</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2006 PLX Technology, Inc.</span>
<span class="cm"> * Copyright (C) 2006-2011 Analog Devices, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>

<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &quot;net2272.h&quot;</span>

<span class="cp">#define DRIVER_DESC &quot;PLX NET2272 USB Peripheral Controller&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;net2272&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_vers</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;2006 October 17/mainline&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="n">DRIVER_DESC</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ep0name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;ep0&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">ep_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ep0name</span><span class="p">,</span>
	<span class="s">&quot;ep-a&quot;</span><span class="p">,</span> <span class="s">&quot;ep-b&quot;</span><span class="p">,</span> <span class="s">&quot;ep-c&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define DMA_ADDR_INVALID	(~(dma_addr_t)0)</span>
<span class="cp">#ifdef CONFIG_USB_GADGET_NET2272_DMA</span>
<span class="cm">/*</span>
<span class="cm"> * use_dma: the NET2272 can use an external DMA controller.</span>
<span class="cm"> * Note that since there is no generic DMA api, some functions,</span>
<span class="cm"> * notably request_dma, start_dma, and cancel_dma will need to be</span>
<span class="cm"> * modified for your platform&#39;s particular dma controller.</span>
<span class="cm"> *</span>
<span class="cm"> * If use_dma is disabled, pio will be used instead.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">use_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">use_dma</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * dma_ep: selects the endpoint for use with dma (1=ep-a, 2=ep-b)</span>
<span class="cm"> * The NET2272 can only use dma for a single endpoint at a time.</span>
<span class="cm"> * At some point this could be modified to allow either endpoint</span>
<span class="cm"> * to take control of dma as it becomes available.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that DMA should not be used on OUT endpoints unless it can</span>
<span class="cm"> * be guaranteed that no short packets will arrive on an IN endpoint</span>
<span class="cm"> * while the DMA operation is pending.  Otherwise the OUT DMA will</span>
<span class="cm"> * terminate prematurely (See NET2272 Errata 630-0213-0101)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">ushort</span> <span class="n">dma_ep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dma_ep</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * dma_mode: net2272 dma mode setting (see LOCCTL1 definiton):</span>
<span class="cm"> *	mode 0 == Slow DREQ mode</span>
<span class="cm"> *	mode 1 == Fast DREQ mode</span>
<span class="cm"> *	mode 2 == Burst mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">ushort</span> <span class="n">dma_mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dma_mode</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#define use_dma 0</span>
<span class="cp">#define dma_ep 1</span>
<span class="cp">#define dma_mode 2</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * fifo_mode: net2272 buffer configuration:</span>
<span class="cm"> *      mode 0 == ep-{a,b,c} 512db each</span>
<span class="cm"> *      mode 1 == ep-a 1k, ep-{b,c} 512db</span>
<span class="cm"> *      mode 2 == ep-a 1k, ep-b 1k, ep-c 512db</span>
<span class="cm"> *      mode 3 == ep-a 1k, ep-b disabled, ep-c 512db</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">ushort</span> <span class="n">fifo_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fifo_mode</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * enable_suspend: When enabled, the driver will respond to</span>
<span class="cm"> * USB suspend requests by powering down the NET2272.  Otherwise,</span>
<span class="cm"> * USB suspend requests will be ignored.  This is acceptible for</span>
<span class="cm"> * self-powered devices.  For bus powered devices set this to 1.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">ushort</span> <span class="n">enable_suspend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">enable_suspend</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">assert_out_naking</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">where</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

<span class="cp">#ifndef DEBUG</span>
	<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NAK_OUT_PACKETS</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s %s %02x !NAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_RSPSET</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ALT_NAK_OUT_PACKETS</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#define ASSERT_OUT_NAKING(ep) assert_out_naking(ep, __func__)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_out_naking</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NAK_OUT_PACKETS</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_RSPCLR</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ALT_NAK_OUT_PACKETS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PIPEDIR(bAddress) (usb_pipein(bAddress) ? &quot;in&quot; : &quot;out&quot;)</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">type_string</span><span class="p">(</span><span class="n">u8</span> <span class="n">bmAttributes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">bmAttributes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_XFERTYPE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>: <span class="k">return</span> <span class="s">&quot;bulk&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>: <span class="k">return</span> <span class="s">&quot;iso&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:  <span class="k">return</span> <span class="s">&quot;intr&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>                     <span class="k">return</span> <span class="s">&quot;control&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">buf_state_string</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BUFF_FREE</span>:  <span class="k">return</span> <span class="s">&quot;free&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BUFF_VALID</span>: <span class="k">return</span> <span class="s">&quot;valid&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BUFF_LCL</span>:   <span class="k">return</span> <span class="s">&quot;local&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BUFF_USB</span>:   <span class="k">return</span> <span class="s">&quot;usb&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>         <span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">dma_mode_string</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;PIO&quot;</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dma_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:  <span class="k">return</span> <span class="s">&quot;SLOW DREQ&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:  <span class="k">return</span> <span class="s">&quot;FAST DREQ&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:  <span class="k">return</span> <span class="s">&quot;BURST&quot;</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="s">&quot;invalid&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">net2272_dequeue_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">net2272_kick_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272_request</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">net2272_fifo_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">net2272_ep_ops</span><span class="p">;</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2272_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">||</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span>
			<span class="o">||</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">!=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="n">max</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">_ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">max</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>

	<span class="cm">/* net2272_ep_reset() has already been called */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">wedged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set speed-dependent max packet */</span>
	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_MAXPKT0</span><span class="p">,</span> <span class="n">max</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_MAXPKT1</span><span class="p">,</span> <span class="p">(</span><span class="n">max</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* set type, direction, address; reset fifo counters */</span>
	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BUFFER_FLUSH</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">usb_endpoint_type</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_xfer_bulk</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* catch some particularly blatant driver bugs */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span> <span class="o">&amp;&amp;</span> <span class="n">max</span> <span class="o">!=</span> <span class="mi">512</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span> <span class="o">&amp;&amp;</span> <span class="n">max</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_iso</span> <span class="o">=</span> <span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">&lt;&lt;=</span> <span class="n">ENDPOINT_TYPE</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ENDPOINT_NUMBER</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ENDPOINT_DIRECTION</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ENDPOINT_ENABLE</span><span class="p">);</span>

	<span class="cm">/* for OUT transfers, block the rx fifo until a read is posted */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">=</span> <span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
		<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_RSPSET</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ALT_NAK_OUT_PACKETS</span><span class="p">);</span>

	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_CFG</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* enable irqs */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span> <span class="o">|</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQENB0</span><span class="p">);</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQENB0</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_RECEIVED_INTERRUPT_ENABLE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_TRANSMITTED_INTERRUPT_ENABLE</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_IRQENB</span><span class="p">);</span>
	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_IRQENB</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;enabled %s (ep%d%s-%s) max %04x cfg %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">PIPEDIR</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span>
		<span class="n">type_string</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span><span class="p">),</span> <span class="n">max</span><span class="p">,</span>
		<span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_CFG</span><span class="p">));</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">net2272_ep_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">net2272_ep_ops</span><span class="p">;</span>

	<span class="cm">/* disable irqs, endpoint */</span>
	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_IRQENB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* init to our chosen defaults, notably so that we NAK OUT</span>
<span class="cm">	 * packets until the driver queues a read.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NAK_OUT_PACKETS_MODE</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ALT_NAK_OUT_PACKETS</span><span class="p">);</span>
	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_RSPSET</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTERRUPT_MODE</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HIDE_STATUS_PHASE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ENDPOINT_TOGGLE</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ENDPOINT_HALT</span><span class="p">);</span>

	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_RSPCLR</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* scrub most status bits, and flush any fifo state */</span>
	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">,</span>
			  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_IN_TOKEN_INTERRUPT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_OUT_TOKEN_INTERRUPT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_TRANSMITTED_INTERRUPT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_RECEIVED_INTERRUPT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SHORT_PACKET_TRANSFERRED_INTERRUPT</span><span class="p">));</span>

	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT1</span><span class="p">,</span>
			    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TIMEOUT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_OUT_ACK_SENT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_OUT_NAK_SENT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_IN_ACK_RCVD</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_IN_NAK_SENT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_STALL_SENT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LOCAL_OUT_ZLP</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BUFFER_FLUSH</span><span class="p">));</span>

	<span class="cm">/* fifo size is handled seperately */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">net2272_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">||</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">net2272_dequeue_all</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">net2272_ep_reset</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disabled %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span>
<span class="nf">net2272_alloc_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net2272_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2272_free_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net2272_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2272_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">stopped</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">protocol_stall</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">set_halt</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">allow_status</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
		<span class="n">usb_gadget_unmap_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;complete %s req %p stat %d len %u/%u buf %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>

	<span class="cm">/* don&#39;t modify queue heads during completion callback */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="n">stopped</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2272_write_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">net2272_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ep_data</span> <span class="o">=</span> <span class="n">net2272_reg_addr</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">EP_DATA</span><span class="p">);</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">bufp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">length</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;write packet %s req %p max %u len %u avail %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
		<span class="p">(</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_AVAIL1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_AVAIL0</span><span class="p">));</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">bufp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* no byte-swap required; chip endian set during init */</span>
		<span class="n">writew</span><span class="p">(</span><span class="o">*</span><span class="n">bufp</span><span class="o">++</span><span class="p">,</span> <span class="n">ep_data</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">bufp</span><span class="p">;</span>

	<span class="cm">/* write final byte by placing the NET2272 into 8-bit mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOCCTL</span><span class="p">);</span>
		<span class="n">net2272_write</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOCCTL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_WIDTH</span><span class="p">));</span>
		<span class="n">writeb</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">ep_data</span><span class="p">);</span>
		<span class="n">net2272_write</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOCCTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* returns: 0: still running, 1: completed, negative: errno */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2272_write_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">count</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;write_fifo %s actual %d len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Keep loading the endpoint until the final packet is loaded,</span>
<span class="cm">	 * or the endpoint buffer is full.</span>
<span class="cm">	 */</span>
 <span class="nl">top:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clear interrupt status</span>
<span class="cm">	 *  - Packet Transmitted interrupt will become set again when the</span>
<span class="cm">	 *    host successfully takes another packet</span>
<span class="cm">	 */</span>
	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_TRANSMITTED_INTERRUPT</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BUFFER_FULL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

		<span class="cm">/* force pagesel */</span>
		<span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">);</span>

		<span class="n">max</span> <span class="o">=</span> <span class="p">(</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_AVAIL1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_AVAIL0</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span>
			<span class="n">max</span> <span class="o">=</span> <span class="p">(</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_AVAIL1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_AVAIL0</span><span class="p">));</span>

		<span class="n">count</span> <span class="o">=</span> <span class="n">net2272_write_packet</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
		<span class="cm">/* see if we are done */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* validate short or zlp packet */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span>
				<span class="n">set_fifo_bytecount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">net2272_done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">net2272_request</span><span class="p">,</span>
						<span class="n">queue</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">net2272_kick_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">)</span>
							<span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BUFFER_EMPTY</span><span class="p">)))</span>
						<span class="k">goto</span> <span class="n">top</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_TRANSMITTED_INTERRUPT</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2272_out_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ASSERT_OUT_NAKING</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_OUT_TOKEN_INTERRUPT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_RECEIVED_INTERRUPT</span><span class="p">));</span>
	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BUFFER_FLUSH</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2272_read_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">net2272_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">avail</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ep_data</span> <span class="o">=</span> <span class="n">net2272_reg_addr</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">EP_DATA</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">is_short</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">bufp</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">avail</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;read packet %s req %p len %u avail %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">avail</span><span class="p">,</span>
		<span class="p">(</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_AVAIL1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_AVAIL0</span><span class="p">));</span>

	<span class="n">is_short</span> <span class="o">=</span> <span class="p">(</span><span class="n">avail</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">avail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* remove any zlp from the buffer */</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">readw</span><span class="p">(</span><span class="n">ep_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">is_short</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ensure we get the final byte */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">avail</span> <span class="o">%</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">avail</span><span class="o">++</span><span class="p">;</span>
	<span class="n">bufp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">bufp</span><span class="o">++</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ep_data</span><span class="p">);</span>
		<span class="n">avail</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">avail</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * To avoid false endpoint available race condition must read</span>
<span class="cm">	 * ep stat0 twice in the case of a short transfer</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SHORT_PACKET_TRANSFERRED_INTERRUPT</span><span class="p">))</span>
		<span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">is_short</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2272_read_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">is_short</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cleanup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;read_fifo %s actual %d len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

 <span class="nl">top:</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
		<span class="n">prefetchw</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

		<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_AVAIL1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_AVAIL0</span><span class="p">);</span>

		<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">,</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SHORT_PACKET_TRANSFERRED_INTERRUPT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_RECEIVED_INTERRUPT</span><span class="p">));</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s out fifo %d bytes, expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
				<span class="n">cleanup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">tmp</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">is_short</span> <span class="o">=</span> <span class="n">net2272_read_packet</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

		<span class="cm">/* completion */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cleanup</span> <span class="o">||</span> <span class="n">is_short</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
				 <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span><span class="p">)))</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cleanup</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">net2272_out_flush</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="n">net2272_done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">net2272_done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* re-initialize endpoint transfer registers</span>
<span class="cm">			 * otherwise they may result in erroneous pre-validation</span>
<span class="cm">			 * for subsequent control reads</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_TRANSFER2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_TRANSFER1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_TRANSFER0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net2272_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">net2272_kick_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="p">(</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BUFFER_EMPTY</span><span class="p">)))</span>
					<span class="k">goto</span> <span class="n">top</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BUFFER_EMPTY</span><span class="p">)));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2272_pio_advance</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">?</span> <span class="n">net2272_write_fifo</span> <span class="o">:</span> <span class="n">net2272_read_fifo</span><span class="p">)(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* returns 0 on success, else negative errno */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2272_request_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ep</span><span class="p">,</span> <span class="n">u32</span> <span class="n">buf</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request_dma ep %d buf %08x len %d dir %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ep</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>

	<span class="cm">/* The NET2272 only supports a single dma channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_busy</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * EP_TRANSFER (used to determine the number of bytes received</span>
<span class="cm">	 * in an OUT transfer) is 24 bits wide; don&#39;t ask for more than that.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dir</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mh">0x1000000</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* initialize platform&#39;s dma */</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="cm">/* NET2272 addr, buffer addr, length, etc. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RDK1</span>:
		<span class="cm">/* Setup PLX 9054 DMA mode */</span>
		<span class="n">writel</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LOCAL_BUS_WIDTH</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TA_READY_INPUT_ENABLE</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">LOCAL_BURST_ENABLE</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DONE_INTERRUPT_ENABLE</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LOCAL_ADDRESSING_MODE</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DEMAND_MODE</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_EOT_ENABLE</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FAST_SLOW_TERMINATE_MODE_SELECT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CHANNEL_INTERRUPT_SELECT</span><span class="p">),</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">DMAMODE0</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="mh">0x100000</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">DMALADR0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">DMAPADR0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">DMASIZ0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">dir</span> <span class="o">&lt;&lt;</span> <span class="n">DIRECTION_OF_TRANSFER</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTERRUPT_AFTER_TERMINAL_COUNT</span><span class="p">),</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">DMADPR0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LOCAL_DMA_CHANNEL_0_INTERRUPT_ENABLE</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">INTCSR</span><span class="p">),</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">INTCSR</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMAREQ</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_BUFFER_VALID</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_REQUEST_ENABLE</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CONTROL_DACK</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_eot_polarity</span> <span class="o">&lt;&lt;</span> <span class="n">EOT_POLARITY</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_dack_polarity</span> <span class="o">&lt;&lt;</span> <span class="n">DACK_POLARITY</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_dreq_polarity</span> <span class="o">&lt;&lt;</span> <span class="n">DREQ_POLARITY</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">ep</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_ENDPOINT_SELECT</span><span class="p">));</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCRATCH</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2272_start_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* start platform&#39;s dma controller */</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RDK1</span>:
		<span class="n">writeb</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CHANNEL_ENABLE</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CHANNEL_START</span><span class="p">),</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">DMACSR0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* returns 0 on success, else negative errno */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2272_kick_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma</span> <span class="o">||</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* don&#39;t use dma for odd-length transfers</span>
<span class="cm">	 * otherwise, we&#39;d need to deal with the last byte with pio</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;kick_dma %s req %p dma %08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>

	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_RSPSET</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ALT_NAK_OUT_PACKETS</span><span class="p">);</span>

	<span class="cm">/* The NET2272 can only use DMA on one endpoint at a time */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_busy</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Make sure we only DMA an even number of bytes (we&#39;ll use</span>
<span class="cm">	 * pio to complete the transfer)</span>
<span class="cm">	 */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* device-to-host transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* initialize platform&#39;s dma controller */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net2272_request_dma</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="cm">/* unable to obtain DMA channel; return error and use pio mode */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* host-to-device transfer */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">);</span>

		<span class="cm">/* initialize platform&#39;s dma controller */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net2272_request_dma</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="cm">/* unable to obtain DMA channel; return error and use pio mode */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BUFFER_EMPTY</span><span class="p">)))</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">not_empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">not_empty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


		<span class="cm">/* allow the endpoint&#39;s buffer to fill */</span>
		<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_RSPCLR</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ALT_NAK_OUT_PACKETS</span><span class="p">);</span>

		<span class="cm">/* this transfer completed and data&#39;s already in the fifo</span>
<span class="cm">		 * return error so pio gets used.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SHORT_PACKET_TRANSFERRED_INTERRUPT</span><span class="p">))</span> <span class="p">{</span>

			<span class="cm">/* deassert dreq */</span>
			<span class="n">net2272_write</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMAREQ</span><span class="p">,</span>
				<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_BUFFER_VALID</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_REQUEST_ENABLE</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CONTROL_DACK</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_eot_polarity</span> <span class="o">&lt;&lt;</span> <span class="n">EOT_POLARITY</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_dack_polarity</span> <span class="o">&lt;&lt;</span> <span class="n">DACK_POLARITY</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_dreq_polarity</span> <span class="o">&lt;&lt;</span> <span class="n">DREQ_POLARITY</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_ENDPOINT_SELECT</span><span class="p">));</span>

			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Don&#39;t use per-packet interrupts: use dma interrupts only */</span>
	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_IRQENB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">net2272_start_dma</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">net2272_cancel_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RDK1</span>:
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">DMACSR0</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CHANNEL_ABORT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">DMACSR0</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">DMACSR0</span><span class="p">)</span> <span class="o">&amp;</span>
		         <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CHANNEL_DONE</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>	<span class="cm">/* wait for dma to stabalize */</span>

		<span class="cm">/* dma abort generates an interrupt */</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CHANNEL_CLEAR_INTERRUPT</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">DMACSR0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2272_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">s</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_req</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="o">-&gt;</span><span class="n">buf</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="cm">/* set up dma mapping in case the caller didn&#39;t */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_gadget_map_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="n">_req</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s queue req %p, len %d buf %p dma %08llx %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">_req</span><span class="p">,</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">zero</span> <span class="o">?</span> <span class="s">&quot;zero&quot;</span> <span class="o">:</span> <span class="s">&quot;!zero&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">_req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">_req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* kickstart this i/o queue? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* maybe there&#39;s no control data, just status ack */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">net2272_done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s status ack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Return zlp, don&#39;t let it block subsequent packets */</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BUFFER_EMPTY</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Buffer is empty check for a blocking zlp, handle it */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NAK_OUT_PACKETS</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LOCAL_OUT_ZLP</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;WARNING: returning ZLP short packet termination!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * Request is going to terminate with a short packet ...</span>
<span class="cm">				 * hope the client is ready for it!</span>
<span class="cm">				 */</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">net2272_read_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
				<span class="cm">/* clear short packet naking */</span>
				<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NAK_OUT_PACKETS</span><span class="p">));</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* try dma first */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">net2272_kick_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* dma failed (most likely in use by another endpoint)</span>
<span class="cm">			 * fallback to pio</span>
<span class="cm">			 */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">net2272_write_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">s</span> <span class="o">=</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BUFFER_EMPTY</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">net2272_read_fifo</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)))</span>
		<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_RSPCLR</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ALT_NAK_OUT_PACKETS</span><span class="p">);</span>
 <span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* dequeue ALL requests */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2272_dequeue_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="cm">/* called with spinlock held */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net2272_request</span><span class="p">,</span>
				<span class="n">queue</span><span class="p">);</span>
		<span class="n">net2272_done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* dequeue JUST ONE request */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2272_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net2272_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stopped</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">stopped</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* make sure it&#39;s still queued on this endpoint */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">==</span> <span class="n">_req</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">!=</span> <span class="n">_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* queue head may be partially complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unlink (%s) pio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">net2272_done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="n">stopped</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2272_set_halt_and_wedge</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wedged</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="cm">/* not ep0 */</span> <span class="o">&amp;&amp;</span> <span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="n">net2272_fifo_status</span><span class="p">(</span><span class="n">_ep</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">value</span> <span class="o">?</span> <span class="s">&quot;set&quot;</span> <span class="o">:</span> <span class="s">&quot;clear&quot;</span><span class="p">,</span>
			<span class="n">wedged</span> <span class="o">?</span> <span class="s">&quot;wedge&quot;</span> <span class="o">:</span> <span class="s">&quot;halt&quot;</span><span class="p">);</span>
		<span class="cm">/* set/clear */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">protocol_stall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">set_halt</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wedged</span><span class="p">)</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">wedged</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">clear_halt</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">wedged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2272_set_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">net2272_set_halt_and_wedge</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2272_set_wedge</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">net2272_set_halt_and_wedge</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2272_fifo_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">avail</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="n">avail</span> <span class="o">=</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_AVAIL1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">avail</span> <span class="o">|=</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_AVAIL0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avail</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
		<span class="n">avail</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">-</span> <span class="n">avail</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">avail</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2272_fifo_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BUFFER_FLUSH</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">net2272_ep_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span>        <span class="o">=</span> <span class="n">net2272_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>       <span class="o">=</span> <span class="n">net2272_disable</span><span class="p">,</span>

	<span class="p">.</span><span class="n">alloc_request</span> <span class="o">=</span> <span class="n">net2272_alloc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_request</span>  <span class="o">=</span> <span class="n">net2272_free_request</span><span class="p">,</span>

	<span class="p">.</span><span class="n">queue</span>         <span class="o">=</span> <span class="n">net2272_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue</span>       <span class="o">=</span> <span class="n">net2272_dequeue</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_halt</span>      <span class="o">=</span> <span class="n">net2272_set_halt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wedge</span>     <span class="o">=</span> <span class="n">net2272_set_wedge</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_status</span>   <span class="o">=</span> <span class="n">net2272_fifo_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_flush</span>    <span class="o">=</span> <span class="n">net2272_fifo_flush</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2272_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_gadget</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FRAME1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FRAME0</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2272_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_gadget</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USBCTL0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IO_WAKEUP_ENABLE</span><span class="p">))</span>
		<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USBCTL1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">GENERATE_RESUME</span><span class="p">));</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2272_set_selfpowered</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_gadget</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">is_selfpowered</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2272_pullup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_gadget</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USBCTL0</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">softconnect</span> <span class="o">=</span> <span class="p">(</span><span class="n">is_on</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_on</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DETECT_ENABLE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DETECT_ENABLE</span><span class="p">);</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USBCTL0</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">net2272_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">net2272_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_gadget_ops</span> <span class="n">net2272_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_frame</span>	<span class="o">=</span> <span class="n">net2272_get_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wakeup</span>		<span class="o">=</span> <span class="n">net2272_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_selfpowered</span> <span class="o">=</span> <span class="n">net2272_set_selfpowered</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pullup</span>		<span class="o">=</span> <span class="n">net2272_pullup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_start</span>	<span class="o">=</span> <span class="n">net2272_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_stop</span>	<span class="o">=</span> <span class="n">net2272_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">net2272_show_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">size</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">_dev</span><span class="p">);</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;(none)&quot;</span><span class="p">;</span>

	<span class="cm">/* Main Control Registers */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%s version %s,&quot;</span>
		<span class="s">&quot;chiprev %02x, locctl %02x</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;irqenb0 %02x irqenb1 %02x &quot;</span>
		<span class="s">&quot;irqstat0 %02x irqstat1 %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">driver_name</span><span class="p">,</span> <span class="n">driver_vers</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">chiprev</span><span class="p">,</span>
		<span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOCCTL</span><span class="p">),</span>
		<span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQENB0</span><span class="p">),</span>
		<span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQENB1</span><span class="p">),</span>
		<span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQSTAT0</span><span class="p">),</span>
		<span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQSTAT1</span><span class="p">));</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

	<span class="cm">/* DMA */</span>
	<span class="n">t1</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMAREQ</span><span class="p">);</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">dmareq %02x: %s %s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">t1</span><span class="p">,</span> <span class="n">ep_name</span><span class="p">[(</span><span class="n">t1</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
		<span class="n">t1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CONTROL_DACK</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;dack &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">t1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_REQUEST_ENABLE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;reqenb &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">t1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_REQUEST</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;req &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">t1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_BUFFER_VALID</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;valid &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

	<span class="cm">/* USB Control Registers */</span>
	<span class="n">t1</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USBCTL1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VBUS_PIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_HIGH_SPEED</span><span class="p">))</span>
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;high speed&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;powered&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;full speed&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;not attached&quot;</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
		<span class="s">&quot;usbctl0 %02x usbctl1 %02x addr 0x%02x (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USBCTL0</span><span class="p">),</span> <span class="n">t1</span><span class="p">,</span>
		<span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OURADDR</span><span class="p">),</span> <span class="n">s</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

	<span class="cm">/* Endpoint Registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">t1</span> <span class="o">=</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_CFG</span><span class="p">);</span>
		<span class="n">t2</span> <span class="o">=</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_RSPSET</span><span class="p">);</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\n</span><span class="s">%s</span><span class="se">\t</span><span class="s">cfg %02x rsp (%02x) %s%s%s%s%s%s%s%s&quot;</span>
			<span class="s">&quot;irqenb %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span>
			<span class="p">(</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ALT_NAK_OUT_PACKETS</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;NAK &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HIDE_STATUS_PHASE</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;hide &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AUTOVALIDATE</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;auto &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTERRUPT_MODE</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;interrupt &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CONTROL_STATUS_PHASE_HANDSHAKE</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;status &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NAK_OUT_PACKETS_MODE</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;NAKmode &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ENDPOINT_TOGGLE</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;DATA1 &quot;</span> <span class="o">:</span> <span class="s">&quot;DATA0 &quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ENDPOINT_HALT</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;HALT &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_IRQENB</span><span class="p">));</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

		<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">stat0 %02x stat1 %02x avail %04x &quot;</span>
			<span class="s">&quot;(ep%d%s-%s)%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">),</span>
			<span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT1</span><span class="p">),</span>
			<span class="p">(</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_AVAIL1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_AVAIL0</span><span class="p">),</span>
			<span class="n">t1</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">,</span>
			<span class="n">type_string</span><span class="p">(</span><span class="n">t1</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">),</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">?</span> <span class="s">&quot;*&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

		<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">ep_transfer %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">((</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_TRANSFER2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_TRANSFER1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_TRANSFER0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)));</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

		<span class="n">t1</span> <span class="o">=</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_BUFF_STATES</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="n">t2</span> <span class="o">=</span> <span class="p">(</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_BUFF_STATES</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">buf-a %s buf-b %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">buf_state_string</span><span class="p">(</span><span class="n">t1</span><span class="p">),</span>
			<span class="n">buf_state_string</span><span class="p">(</span><span class="n">t2</span><span class="p">));</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">registers</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">net2272_show_registers</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2272_set_fifo_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOCCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOCCTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="cm">/* always ep-a, ep-c ... maybe not ep-b */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ep-c is always 2 512 byte buffers */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2272_usb_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>

	<span class="n">net2272_cancel_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQENB0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQENB1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* clear irq state */</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQSTAT0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQSTAT1</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SUSPEND_REQUEST_INTERRUPT</span><span class="p">));</span>

	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMAREQ</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_BUFFER_VALID</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_REQUEST_ENABLE</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CONTROL_DACK</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_eot_polarity</span> <span class="o">&lt;&lt;</span> <span class="n">EOT_POLARITY</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_dack_polarity</span> <span class="o">&lt;&lt;</span> <span class="n">DACK_POLARITY</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_dreq_polarity</span> <span class="o">&lt;&lt;</span> <span class="n">DREQ_POLARITY</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">dma_ep</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_ENDPOINT_SELECT</span><span class="p">));</span>

	<span class="n">net2272_cancel_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">net2272_set_fifo_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">fifo_mode</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="n">fifo_mode</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set the NET2272 ep fifo data width to 16-bit mode and for correct byte swapping</span>
<span class="cm">	 * note that the higher level gadget drivers are expected to convert data to little endian.</span>
<span class="cm">	 * Enable byte swap for your local bus/cpu if needed by setting BYTE_SWAP in LOCCTL here</span>
<span class="cm">	 */</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOCCTL</span><span class="p">,</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOCCTL</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_WIDTH</span><span class="p">));</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOCCTL1</span><span class="p">,</span> <span class="p">(</span><span class="n">dma_mode</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_MODE</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2272_usb_reinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* basic endpoint init */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ep_name</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">not_empty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="n">dma_ep</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">net2272_ep_reset</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">ep_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2272_ep0_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep0</span><span class="p">,</span> <span class="n">EP_RSPSET</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NAK_OUT_PACKETS_MODE</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ALT_NAK_OUT_PACKETS</span><span class="p">));</span>
	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep0</span><span class="p">,</span> <span class="n">EP_RSPCLR</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HIDE_STATUS_PHASE</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CONTROL_STATUS_PHASE_HANDSHAKE</span><span class="p">));</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USBCTL0</span><span class="p">,</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">softconnect</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DETECT_ENABLE</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_ROOT_PORT_WAKEUP_ENABLE</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IO_WAKEUP_ENABLE</span><span class="p">));</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQENB0</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SETUP_PACKET_INTERRUPT_ENABLE</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ENDPOINT_0_INTERRUPT_ENABLE</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_DONE_INTERRUPT_ENABLE</span><span class="p">));</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQENB1</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VBUS_INTERRUPT_ENABLE</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ROOT_PORT_RESET_INTERRUPT_ENABLE</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SUSPEND_REQUEST_CHANGE_INTERRUPT_ENABLE</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* when a driver is successfully registered, it will receive</span>
<span class="cm"> * control requests including set_configuration(), which enables</span>
<span class="cm"> * non-control requests.  then usb traffic follows until a</span>
<span class="cm"> * disconnect is reported.  then a host may connect again, or</span>
<span class="cm"> * the driver might get unbound.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">net2272_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span> <span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">unbind</span> <span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="o">||</span>
	    <span class="n">driver</span><span class="o">-&gt;</span><span class="n">max_speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* hook up the driver ... */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">softconnect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

	<span class="cm">/* ... then enable host detection and ep0; and we&#39;re ready</span>
<span class="cm">	 * for set_configuration as well as eventual disconnect.</span>
<span class="cm">	 */</span>
	<span class="n">net2272_ep0_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">stop_activity</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* don&#39;t disconnect if it&#39;s not connected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* stop hardware; prevent new request submissions;</span>
<span class="cm">	 * and kill any outstanding requests.</span>
<span class="cm">	 */</span>
	<span class="n">net2272_usb_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">net2272_dequeue_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">net2272_usb_reinit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">net2272_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">stop_activity</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">driver</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unregistered driver &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/* handle ep-a/ep-b dma completions */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2272_handle_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net2272_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;handle_dma %s req %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="cm">/* Ensure DREQ is de-asserted */</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMAREQ</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_BUFFER_VALID</span><span class="p">)</span>
	      <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_REQUEST_ENABLE</span><span class="p">)</span>
	      <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CONTROL_DACK</span><span class="p">)</span>
	      <span class="o">|</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_eot_polarity</span> <span class="o">&lt;&lt;</span> <span class="n">EOT_POLARITY</span><span class="p">)</span>
	      <span class="o">|</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_dack_polarity</span> <span class="o">&lt;&lt;</span> <span class="n">DACK_POLARITY</span><span class="p">)</span>
	      <span class="o">|</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_dreq_polarity</span> <span class="o">&lt;&lt;</span> <span class="n">DREQ_POLARITY</span><span class="p">)</span>
	      <span class="o">|</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_ENDPOINT_SELECT</span><span class="p">));</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_IRQENB</span><span class="p">,</span>
		  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_RECEIVED_INTERRUPT_ENABLE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_TRANSMITTED_INTERRUPT_ENABLE</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_IRQENB</span><span class="p">));</span>

	<span class="cm">/* device-to-host transfer completed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* validate a short packet or zlp if necessary */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span><span class="p">)</span>
			<span class="n">set_fifo_bytecount</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">net2272_done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net2272_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">net2272_kick_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">net2272_pio_advance</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="cm">/* host-to-device transfer completed */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* terminated with a short packet? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net2272_read</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQSTAT0</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_DONE_INTERRUPT</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* abort system dma */</span>
			<span class="n">net2272_cancel_dma</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* EP_TRANSFER will contain the number of bytes</span>
<span class="cm">		 * actually received.</span>
<span class="cm">		 * NOTE: There is no overflow detection on EP_TRANSFER:</span>
<span class="cm">		 * We can&#39;t deal with transfers larger than 2^24 bytes!</span>
<span class="cm">		 */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_TRANSFER2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_TRANSFER1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_TRANSFER0</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">not_empty</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

		<span class="cm">/* get any remaining data */</span>
		<span class="n">net2272_pio_advance</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2272_handle_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">stat0</span><span class="p">,</span> <span class="n">stat1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">net2272_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* ack all, and handle what we care about */</span>
	<span class="n">stat0</span> <span class="o">=</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">);</span>
	<span class="n">stat1</span> <span class="o">=</span> <span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT1</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ack ep_stat0 %02x, ep_stat1 %02x, req %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">stat0</span><span class="p">,</span> <span class="n">stat1</span><span class="p">,</span> <span class="n">req</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">,</span> <span class="n">stat0</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NAK_OUT_PACKETS</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SHORT_PACKET_TRANSFERRED_INTERRUPT</span><span class="p">)));</span>
	<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT1</span><span class="p">,</span> <span class="n">stat1</span><span class="p">);</span>

	<span class="cm">/* data packet(s) received (in the fifo, OUT)</span>
<span class="cm">	 * direction must be validated, otherwise control read status phase</span>
<span class="cm">	 * could be interpreted as a valid packet</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">stat0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_RECEIVED_INTERRUPT</span><span class="p">)))</span>
		<span class="n">net2272_pio_advance</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="cm">/* data packet(s) transmitted (IN) */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_TRANSMITTED_INTERRUPT</span><span class="p">))</span>
		<span class="n">net2272_pio_advance</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span>
<span class="nf">net2272_get_ep_by_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">wIndex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wIndex</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">bEndpointAddress</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">wIndex</span> <span class="o">^</span> <span class="n">bEndpointAddress</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">wIndex</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * USB Test Packet:</span>
<span class="cm"> * JKJKJKJK * 9</span>
<span class="cm"> * JJKKJJKK * 8</span>
<span class="cm"> * JJJJKKKK * 8</span>
<span class="cm"> * JJJJJJJKKKKKKK * 8</span>
<span class="cm"> * JJJJJJJK * 8</span>
<span class="cm"> * {JKKKKKKK * 10}, JK</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">net2272_test_packet</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span>
	<span class="mh">0xEE</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">,</span>
	<span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
	<span class="mh">0x7F</span><span class="p">,</span> <span class="mh">0xBF</span><span class="p">,</span> <span class="mh">0xDF</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">,</span> <span class="mh">0xFD</span><span class="p">,</span>
	<span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x7E</span><span class="p">,</span> <span class="mh">0xBF</span><span class="p">,</span> <span class="mh">0xDF</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="mh">0xFD</span><span class="p">,</span> <span class="mh">0x7E</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2272_set_test_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Disable all net2272 interrupts:</span>
<span class="cm">	 * Nothing but a power cycle should stop the test.</span>
<span class="cm">	 */</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQENB0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQENB1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* Force tranceiver to high-speed */</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">XCVRDIAG</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FORCE_HIGH_SPEED</span><span class="p">);</span>

	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGESEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_TRANSMITTED_INTERRUPT</span><span class="p">);</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EP_RSPCLR</span><span class="p">,</span>
			  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CONTROL_STATUS_PHASE_HANDSHAKE</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HIDE_STATUS_PHASE</span><span class="p">));</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EP_CFG</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ENDPOINT_DIRECTION</span><span class="p">);</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EP_STAT1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BUFFER_FLUSH</span><span class="p">);</span>

	<span class="cm">/* wait for status phase to complete */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_TRANSMITTED_INTERRUPT</span><span class="p">)))</span>
		<span class="p">;</span>

	<span class="cm">/* Enable test mode */</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USBTEST</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="cm">/* load test packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">TEST_PACKET</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* switch to 8 bit mode */</span>
		<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOCCTL</span><span class="p">,</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOCCTL</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_WIDTH</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">net2272_test_packet</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EP_DATA</span><span class="p">,</span> <span class="n">net2272_test_packet</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="cm">/* Validate test packet */</span>
		<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EP_TRANSFER0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2272_handle_stat0_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num</span><span class="p">,</span> <span class="n">scratch</span><span class="p">;</span>

	<span class="cm">/* starting a control request? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SETUP_PACKET_INTERRUPT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">union</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">raw</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">usb_ctrlrequest</span>	<span class="n">r</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">net2272_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USBCTL1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_HIGH_SPEED</span><span class="p">))</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">usb_speed_string</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* make sure any leftover interrupt state is cleared */</span>
		<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ENDPOINT_0_INTERRUPT</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net2272_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
			<span class="n">net2272_done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
				<span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">protocol_stall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT0</span><span class="p">,</span>
			    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_IN_TOKEN_INTERRUPT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_OUT_TOKEN_INTERRUPT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_TRANSMITTED_INTERRUPT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_RECEIVED_INTERRUPT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SHORT_PACKET_TRANSFERRED_INTERRUPT</span><span class="p">));</span>
		<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_STAT1</span><span class="p">,</span>
			    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TIMEOUT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_OUT_ACK_SENT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_OUT_NAK_SENT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_IN_ACK_RCVD</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_IN_NAK_SENT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_STALL_SENT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LOCAL_OUT_ZLP</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * Ensure Control Read pre-validation setting is beyond maximum size</span>
<span class="cm">		 *  - Control Writes can leave non-zero values in EP_TRANSFER. If</span>
<span class="cm">		 *    an EP0 transfer following the Control Write is a Control Read,</span>
<span class="cm">		 *    the NET2272 sees the non-zero EP_TRANSFER as an unexpected</span>
<span class="cm">		 *    pre-validation count.</span>
<span class="cm">		 *  - Setting EP_TRANSFER beyond the maximum EP0 transfer size ensures</span>
<span class="cm">		 *    the pre-validation count cannot cause an unexpected validatation</span>
<span class="cm">		 */</span>
		<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGESEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EP_TRANSFER2</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EP_TRANSFER1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EP_TRANSFER0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SETUP0</span><span class="p">);</span>
		<span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SETUP1</span><span class="p">);</span>
		<span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SETUP2</span><span class="p">);</span>
		<span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SETUP3</span><span class="p">);</span>
		<span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SETUP4</span><span class="p">);</span>
		<span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SETUP5</span><span class="p">);</span>
		<span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SETUP6</span><span class="p">);</span>
		<span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SETUP7</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If you have a big endian cpu make sure le16_to_cpus</span>
<span class="cm">		 * performs the proper byte swapping here...</span>
<span class="cm">		 */</span>
		<span class="n">le16_to_cpus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wValue</span><span class="p">);</span>
		<span class="n">le16_to_cpus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wIndex</span><span class="p">);</span>
		<span class="n">le16_to_cpus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wLength</span><span class="p">);</span>

		<span class="cm">/* ack the irq */</span>
		<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQSTAT0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SETUP_PACKET_INTERRUPT</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">^=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SETUP_PACKET_INTERRUPT</span><span class="p">);</span>

		<span class="cm">/* watch control traffic at the token level, and force</span>
<span class="cm">		 * synchronization before letting the status phase happen.</span>
<span class="cm">		 */</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scratch</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_TRANSMITTED_INTERRUPT_ENABLE</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_OUT_TOKEN_INTERRUPT_ENABLE</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_IN_TOKEN_INTERRUPT_ENABLE</span><span class="p">);</span>
			<span class="n">stop_out_naking</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">scratch</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_RECEIVED_INTERRUPT_ENABLE</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_OUT_TOKEN_INTERRUPT_ENABLE</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_IN_TOKEN_INTERRUPT_ENABLE</span><span class="p">);</span>
		<span class="n">net2272_ep_write</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_IRQENB</span><span class="p">,</span> <span class="n">scratch</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_TYPE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">USB_TYPE_STANDARD</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">delegate</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequest</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_REQ_GET_STATUS</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_RECIP_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">USB_RECIP_ENDPOINT</span>:
				<span class="n">e</span> <span class="o">=</span> <span class="n">net2272_get_ep_by_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wIndex</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span> <span class="o">||</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wLength</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">EP_RSPSET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ENDPOINT_HALT</span><span class="p">))</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

				<span class="cm">/* don&#39;t bother with a request object! */</span>
				<span class="n">net2272_ep_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">EP_IRQENB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">net2272_reg_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EP_DATA</span><span class="p">));</span>
				<span class="n">set_fifo_bytecount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">allow_status</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s stat %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">next_endpoints</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_RECIP_DEVICE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wLength</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">is_selfpowered</span><span class="p">)</span>
					<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DEVICE_SELF_POWERED</span><span class="p">);</span>

				<span class="cm">/* don&#39;t bother with a request object! */</span>
				<span class="n">net2272_ep_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">EP_IRQENB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">net2272_reg_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EP_DATA</span><span class="p">));</span>
				<span class="n">set_fifo_bytecount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">allow_status</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;device stat %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">next_endpoints</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_RECIP_INTERFACE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wLength</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>

				<span class="cm">/* don&#39;t bother with a request object! */</span>
				<span class="n">net2272_ep_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">EP_IRQENB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">net2272_reg_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EP_DATA</span><span class="p">));</span>
				<span class="n">set_fifo_bytecount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">allow_status</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;interface status %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">next_endpoints</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">USB_REQ_CLEAR_FEATURE</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="n">USB_RECIP_ENDPOINT</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">delegate</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wValue</span> <span class="o">!=</span> <span class="n">USB_ENDPOINT_HALT</span> <span class="o">||</span>
			    <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wLength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>
			<span class="n">e</span> <span class="o">=</span> <span class="n">net2272_get_ep_by_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wIndex</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">wedged</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s wedged, halt not cleared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s clear halt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
				<span class="n">clear_halt</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">allow_status</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">next_endpoints</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">USB_REQ_SET_FEATURE</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">net2272_ep</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">==</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">!=</span> <span class="n">NORMAL_OPERATION</span><span class="p">)</span>
					<span class="n">net2272_set_test_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
				<span class="n">allow_status</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;test mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wIndex</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">next_endpoints</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="n">USB_RECIP_ENDPOINT</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">delegate</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wValue</span> <span class="o">!=</span> <span class="n">USB_ENDPOINT_HALT</span> <span class="o">||</span>
			    <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wLength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>
			<span class="n">e</span> <span class="o">=</span> <span class="n">net2272_get_ep_by_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wIndex</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>
			<span class="n">set_halt</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
			<span class="n">allow_status</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s set halt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">next_endpoints</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">USB_REQ_SET_ADDRESS</span>: <span class="p">{</span>
			<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OURADDR</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wValue</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">allow_status</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nl">default:</span>
 <span class="nl">delegate:</span>
			<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setup %02x.%02x v%04x i%04x &quot;</span>
				<span class="s">&quot;ep_cfg %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequest</span><span class="p">,</span>
				<span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wValue</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wIndex</span><span class="p">,</span>
				<span class="n">net2272_ep_read</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">EP_CFG</span><span class="p">));</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* stall ep0 on error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 <span class="nl">do_stall:</span>
			<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;req %02x.%02x protocol STALL; stat %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequest</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">protocol_stall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="cm">/* endpoint dma irq? */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_DONE_INTERRUPT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">net2272_cancel_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQSTAT0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_DONE_INTERRUPT</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_DONE_INTERRUPT</span><span class="p">);</span>
		<span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMAREQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_ENDPOINT_SELECT</span><span class="p">))</span>
			<span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
		<span class="n">net2272_handle_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">next_endpoints:</span>
	<span class="cm">/* endpoint data irq? */</span>
	<span class="n">scratch</span> <span class="o">=</span> <span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">scratch</span><span class="p">;</span> <span class="n">num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">t</span><span class="p">;</span>

		<span class="cm">/* does this endpoint&#39;s FIFO and queue need tending? */</span>
		<span class="n">t</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">num</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scratch</span> <span class="o">&amp;</span> <span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">scratch</span> <span class="o">^=</span> <span class="n">t</span><span class="p">;</span>

		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
		<span class="n">net2272_handle_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* some interrupts we can just ignore */</span>
	<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SOF_INTERRUPT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unhandled irqstat0 %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2272_handle_stat1_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* after disconnect there&#39;s nothing else to do! */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VBUS_INTERRUPT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ROOT_PORT_RESET_INTERRUPT</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_HIGH_SPEED</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_FULL_SPEED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQSTAT1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ROOT_PORT_RESET_INTERRUPT</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				<span class="p">((</span><span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USBCTL1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="o">||</span> <span class="p">((</span><span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">USBCTL1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VBUS_PIN</span><span class="p">))</span>
				<span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disconnect %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="n">stop_activity</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
			<span class="n">net2272_ep0_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">tmp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stat</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SUSPEND_REQUEST_CHANGE_INTERRUPT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQSTAT1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SUSPEND_REQUEST_INTERRUPT</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable_suspend</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SUSPEND_REQUEST_INTERRUPT</span><span class="p">);</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Suspend disabled, ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* clear any other status/irqs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span>
		<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQSTAT1</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>

	<span class="cm">/* some status we can just ignore */</span>
	<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CONTROL_STATUS_INTERRUPT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SUSPEND_REQUEST_INTERRUPT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">RESUME_INTERRUPT</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stat</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unhandled irqstat1 %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">net2272_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">_dev</span><span class="p">;</span>
<span class="cp">#if defined(PLX_PCI_RDK) || defined(PLX_PCI_RDK2)</span>
	<span class="n">u32</span> <span class="n">intcsr</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(PLX_PCI_RDK)</span>
	<span class="n">u8</span> <span class="n">dmareq</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="cp">#if defined(PLX_PCI_RDK)</span>
	<span class="n">intcsr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">INTCSR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">intcsr</span> <span class="o">&amp;</span> <span class="n">LOCAL_INTERRUPT_TEST</span><span class="p">)</span> <span class="o">==</span> <span class="n">LOCAL_INTERRUPT_TEST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">intcsr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PCI_INTERRUPT_ENABLE</span><span class="p">),</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">INTCSR</span><span class="p">);</span>
		<span class="n">net2272_handle_stat1_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQSTAT1</span><span class="p">));</span>
		<span class="n">net2272_handle_stat0_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQSTAT0</span><span class="p">));</span>
		<span class="n">intcsr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">INTCSR</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">intcsr</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PCI_INTERRUPT_ENABLE</span><span class="p">),</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">INTCSR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">intcsr</span> <span class="o">&amp;</span> <span class="n">DMA_CHANNEL_0_TEST</span><span class="p">)</span> <span class="o">==</span> <span class="n">DMA_CHANNEL_0_TEST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CHANNEL_CLEAR_INTERRUPT</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">CHANNEL_ENABLE</span><span class="p">)),</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">DMACSR0</span><span class="p">);</span>

		<span class="n">dmareq</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMAREQ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmareq</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="n">net2272_handle_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">net2272_handle_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(PLX_PCI_RDK2)</span>
	<span class="cm">/* see if PCI int for us by checking irqstat */</span>
	<span class="n">intcsr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk2</span><span class="p">.</span><span class="n">fpga_base_addr</span> <span class="o">+</span> <span class="n">RDK2_IRQSTAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intcsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NET2272_PCI_IRQ</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="cm">/* check dma interrupts */</span>
<span class="cp">#endif</span>
	<span class="cm">/* Platform/devcice interrupt handler */</span>
<span class="cp">#if !defined(PLX_PCI_RDK)</span>
	<span class="n">net2272_handle_stat1_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQSTAT1</span><span class="p">));</span>
	<span class="n">net2272_handle_stat0_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQSTAT0</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">net2272_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Quick test to see if CPU can communicate properly with the NET2272.</span>
<span class="cm">	 * Verifies connection using writes and reads to write/read and</span>
<span class="cm">	 * read-only registers.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This routine is strongly recommended especially during early bring-up</span>
<span class="cm">	 * of new hardware, however for designs that do not apply Power On System</span>
<span class="cm">	 * Tests (POST) it may discarded (or perhaps minimized).</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">refval</span><span class="p">;</span>

	<span class="cm">/* Verify NET2272 write/read SCRATCH register can write and read */</span>
	<span class="n">refval</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCRATCH</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span> <span class="n">ii</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCRATCH</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCRATCH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">ii</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: write/read SCRATCH register test failed: &quot;</span>
				<span class="s">&quot;wrote:0x%2.2x, read:0x%2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* To be nice, we write the original SCRATCH value back: */</span>
	<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCRATCH</span><span class="p">,</span> <span class="n">refval</span><span class="p">);</span>

	<span class="cm">/* Verify NET2272 CHIPREV register is read-only: */</span>
	<span class="n">refval</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CHIPREV_2272</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span> <span class="n">ii</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">net2272_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CHIPREV_2272</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CHIPREV_2272</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">refval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: write/read CHIPREV register test failed: &quot;</span>
				<span class="s">&quot;wrote 0x%2.2x, read:0x%2.2x expected:0x%2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">refval</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Verify NET2272&#39;s &quot;NET2270 legacy revision&quot; register</span>
<span class="cm">	 *  - NET2272 has two revision registers. The NET2270 legacy revision</span>
<span class="cm">	 *    register should read the same value, regardless of the NET2272</span>
<span class="cm">	 *    silicon revision.  The legacy register applies to NET2270</span>
<span class="cm">	 *    firmware being applied to the NET2272.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CHIPREV_LEGACY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">NET2270_LEGACY_REV</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Unexpected legacy revision value</span>
<span class="cm">		 * - Perhaps the chip is a NET2270?</span>
<span class="cm">		 */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: WARNING: UNEXPECTED NET2272 LEGACY REGISTER VALUE:</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot; - CHIPREV_LEGACY: expected 0x%2.2x, got:0x%2.2x. (Not NET2272?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">NET2270_LEGACY_REV</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Verify NET2272 silicon revision</span>
<span class="cm">	 *  - This revision register is appropriate for the silicon version</span>
<span class="cm">	 *    of the NET2272</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CHIPREV_2272</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHIPREV_NET2272_R1</span>:
		<span class="cm">/*</span>
<span class="cm">		 * NET2272 Rev 1 has DMA related errata:</span>
<span class="cm">		 *  - Newer silicon (Rev 1A or better) required</span>
<span class="cm">		 */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: Rev 1 detected: newer silicon recommended for DMA support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHIPREV_NET2272_R1A</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* NET2272 silicon version *may* not work with this firmware */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: unexpected silicon revision register value: &quot;</span>
			<span class="s">&quot; CHIPREV_2272: 0x%2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Return Success, even though the chip rev is not an expected value</span>
<span class="cm">		 *  - Older, pre-built firmware can attempt to operate on newer silicon</span>
<span class="cm">		 *  - Often, new silicon is perfectly compatible</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

	<span class="cm">/* Success: NET2272 checks out OK */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2272_gadget_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">net2272_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_del_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>

	<span class="cm">/* start with the driver above us */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* should have been done already by driver model core */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pci remove, driver &#39;%s&#39; is still registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="n">usb_gadget_unregister_driver</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>

	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_registers</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unbind</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span> <span class="n">__devinit</span>
<span class="nf">net2272_probe_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No IRQ!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* alloc, and start init */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">ret</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">ret</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">net2272_ops</span><span class="p">;</span>
	<span class="n">ret</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">max_speed</span> <span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">;</span>

	<span class="cm">/* the &quot;gadget&quot; abstracts/virtualizes the controller */</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gadget&quot;</span><span class="p">);</span>
	<span class="n">ret</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">ret</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">ret</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">net2272_gadget_release</span><span class="p">;</span>
	<span class="n">ret</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">driver_name</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">net2272_probe_fin</span><span class="p">(</span><span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irqflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* See if there... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net2272_present</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;2272 not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">net2272_usb_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">net2272_usb_reinit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">net2272_irq</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request interrupt %i failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">chiprev</span> <span class="o">=</span> <span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CHIPREV_2272</span><span class="p">);</span>

	<span class="cm">/* done */</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_desc</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq %i, mem %p, chip rev %04x, dma %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">chiprev</span><span class="p">,</span>
		<span class="n">dma_mode_string</span><span class="p">());</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;version: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_vers</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_registers</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_dev_reg</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_add_gadget_udc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_add_udc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_add_udc:</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_registers</span><span class="p">);</span>
 <span class="nl">err_dev_reg:</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
 <span class="nl">err_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
 <span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>

<span class="cm">/*</span>
<span class="cm"> * wrap this driver around the specified device, but</span>
<span class="cm"> * don&#39;t respond over USB until a gadget driver binds to us</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">net2272_rdk1_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">resource</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_mapped_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * BAR 0 holds PLX 9054 config registers</span>
<span class="cm">	 * BAR 1 is i/o memory; unused here</span>
<span class="cm">	 * BAR 2 holds EPLD config registers</span>
<span class="cm">	 * BAR 3 holds NET2272 registers</span>
<span class="cm">	 */</span>

	<span class="cm">/* Find and map all address spaces */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>	<span class="cm">/* BAR1 unused */</span>

		<span class="n">resource</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mem_mapped_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem_mapped_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">release_mem_region</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t map memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">=</span> <span class="n">mem_mapped_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">epld_base_addr</span> <span class="o">=</span> <span class="n">mem_mapped_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">mem_mapped_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/* Set PLX 9054 bus width (16 bits) */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">LBRD1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">MEMORY_SPACE_LOCAL_BUS_WIDTH</span><span class="p">))</span> <span class="o">|</span> <span class="n">W16_BIT</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">LBRD1</span><span class="p">);</span>

	<span class="cm">/* Enable PLX 9054 Interrupts */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">INTCSR</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PCI_INTERRUPT_ENABLE</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LOCAL_INTERRUPT_INPUT_ENABLE</span><span class="p">),</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">INTCSR</span><span class="p">);</span>

	<span class="n">writeb</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CHANNEL_CLEAR_INTERRUPT</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">CHANNEL_ENABLE</span><span class="p">)),</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">DMACSR0</span><span class="p">);</span>

	<span class="cm">/* reset */</span>
	<span class="n">writeb</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">EPLD_DMA_ENABLE</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CTL_DACK</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_TIMEOUT_ENABLE</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USER</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">MPX_MODE</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BUSWIDTH</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NET2272_RESET</span><span class="p">),</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">EPLD_IO_CONTROL_REGISTER</span><span class="p">);</span>

	<span class="n">mb</span><span class="p">();</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">EPLD_IO_CONTROL_REGISTER</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NET2272_RESET</span><span class="p">),</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">EPLD_IO_CONTROL_REGISTER</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">mem_mapped_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
			<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">net2272_rdk2_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">resource</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_mapped_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * BAR 0 holds FGPA config registers</span>
<span class="cm">	 * BAR 1 holds NET2272 registers</span>
<span class="cm">	 */</span>

	<span class="cm">/* Find and map all address spaces, bar2-3 unused in rdk 2 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">resource</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mem_mapped_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem_mapped_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">release_mem_region</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t map memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk2</span><span class="p">.</span><span class="n">fpga_base_addr</span> <span class="o">=</span> <span class="n">mem_mapped_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">mem_mapped_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">mb</span><span class="p">();</span>
	<span class="cm">/* Set 2272 bus width (16 bits) and reset */</span>
	<span class="n">writel</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CHIP_RESET</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk2</span><span class="p">.</span><span class="n">fpga_base_addr</span> <span class="o">+</span> <span class="n">RDK2_LOCCTLRDK</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BUS_WIDTH</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk2</span><span class="p">.</span><span class="n">fpga_base_addr</span> <span class="o">+</span> <span class="n">RDK2_LOCCTLRDK</span><span class="p">);</span>
	<span class="cm">/* Print fpga version number */</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RDK2 FPGA version %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk2</span><span class="p">.</span><span class="n">fpga_base_addr</span> <span class="o">+</span> <span class="n">RDK2_FPGAREV</span><span class="p">));</span>
	<span class="cm">/* Enable FPGA Interrupts */</span>
	<span class="n">writel</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NET2272_PCI_IRQ</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk2</span><span class="p">.</span><span class="n">fpga_base_addr</span> <span class="o">+</span> <span class="n">RDK2_IRQENB</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">mem_mapped_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
			<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">net2272_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">net2272_probe_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RDK1</span>: <span class="n">ret</span> <span class="o">=</span> <span class="n">net2272_rdk1_probe</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RDK2</span>: <span class="n">ret</span> <span class="o">=</span> <span class="n">net2272_rdk2_probe</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pci</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">net2272_probe_fin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pci</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_pci:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
 <span class="nl">err_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">net2272_rdk1_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* disable PLX 9054 interrupts */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">INTCSR</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PCI_INTERRUPT_ENABLE</span><span class="p">),</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span> <span class="o">+</span> <span class="n">INTCSR</span><span class="p">);</span>

	<span class="cm">/* clean up resources allocated during probe() */</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">plx9054_base_addr</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk1</span><span class="p">.</span><span class="n">epld_base_addr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>	<span class="cm">/* BAR1 unused */</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
			<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">net2272_rdk2_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* disable fpga interrupts</span>
<span class="cm">	writel(readl(dev-&gt;rdk1.plx9054_base_addr + INTCSR) &amp;</span>
<span class="cm">			~(1 &lt;&lt; PCI_INTERRUPT_ENABLE),</span>
<span class="cm">			dev-&gt;rdk1.plx9054_base_addr + INTCSR);</span>
<span class="cm">	*/</span>

	<span class="cm">/* clean up resources allocated during probe() */</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rdk2</span><span class="p">.</span><span class="n">fpga_base_addr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
			<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">net2272_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">net2272_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RDK1</span>: <span class="n">net2272_rdk1_remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RDK2</span>: <span class="n">net2272_rdk2_remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Table of matching PCI IDs */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">__devinitdata</span> <span class="n">pci_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>	<span class="cm">/* RDK 1 card */</span>
		<span class="p">.</span><span class="n">class</span>       <span class="o">=</span> <span class="p">((</span><span class="n">PCI_CLASS_BRIDGE_OTHER</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xfe</span><span class="p">),</span>
		<span class="p">.</span><span class="n">class_mask</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vendor</span>      <span class="o">=</span> <span class="n">PCI_VENDOR_ID_PLX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>      <span class="o">=</span> <span class="n">PCI_DEVICE_ID_RDK1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>   <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>   <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* RDK 2 card */</span>
		<span class="p">.</span><span class="n">class</span>       <span class="o">=</span> <span class="p">((</span><span class="n">PCI_CLASS_BRIDGE_OTHER</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xfe</span><span class="p">),</span>
		<span class="p">.</span><span class="n">class_mask</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vendor</span>      <span class="o">=</span> <span class="n">PCI_VENDOR_ID_PLX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>      <span class="o">=</span> <span class="n">PCI_DEVICE_ID_RDK2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>   <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>   <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">net2272_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="n">driver_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">pci_ids</span><span class="p">,</span>

	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">net2272_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">net2272_pci_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">net2272_pci_register</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net2272_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">net2272_pci_unregister</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net2272_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">net2272_pci_register</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">net2272_pci_unregister</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">net2272_plat_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irqflags</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">base</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">iomem</span><span class="p">,</span> <span class="o">*</span><span class="n">iomem_bus</span><span class="p">,</span> <span class="o">*</span><span class="n">irq_res</span><span class="p">;</span>

	<span class="n">irq_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">iomem</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">iomem_bus</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_BUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_res</span> <span class="o">||</span> <span class="o">!</span><span class="n">iomem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;must provide irq/base addr&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">net2272_probe_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">irq_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">irqflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IRQ_HIGHEDGE</span><span class="p">)</span>
		<span class="n">irqflags</span> <span class="o">|=</span> <span class="n">IRQF_TRIGGER_RISING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IRQ_LOWEDGE</span><span class="p">)</span>
		<span class="n">irqflags</span> <span class="o">|=</span> <span class="n">IRQF_TRIGGER_FALLING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IRQ_HIGHLEVEL</span><span class="p">)</span>
		<span class="n">irqflags</span> <span class="o">|=</span> <span class="n">IRQF_TRIGGER_HIGH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IRQ_LOWLEVEL</span><span class="p">)</span>
		<span class="n">irqflags</span> <span class="o">|=</span> <span class="n">IRQF_TRIGGER_LOW</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">iomem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">iomem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iomem_bus</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_shift</span> <span class="o">=</span> <span class="n">iomem_bus</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;get request memory region!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t map memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_req</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">net2272_probe_fin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQF_TRIGGER_LOW</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_io</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;running in 16-bit, %sbyte swap local bus mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">net2272_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOCCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BYTE_SWAP</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;no &quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_io:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
 <span class="nl">err_req:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
 <span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span>
<span class="nf">net2272_plat_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2272</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">net2272_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
		<span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">net2272_plat_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>   <span class="o">=</span> <span class="n">net2272_plat_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>  <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">net2272_plat_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>  <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="n">driver_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* FIXME .suspend, .resume */</span>
<span class="p">};</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:net2272&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">net2272_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">net2272_pci_register</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net2272_plat_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pci</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">err_pci:</span>
	<span class="n">net2272_pci_unregister</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">net2272_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">net2272_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">net2272_pci_unregister</span><span class="p">();</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net2272_plat_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">net2272_cleanup</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;PLX Technology, Inc.&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
