<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › gadget › imx_udc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>imx_udc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	driver/usb/gadget/imx_udc.c</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (C) 2005 Mike Lee &lt;eemike@gmail.com&gt;</span>
<span class="cm"> *	Copyright (C) 2008 Darius Augulis &lt;augulis.darius@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *	it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *	(at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *	but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *	GNU General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>

<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>

<span class="cp">#include &lt;mach/usb.h&gt;</span>
<span class="cp">#include &lt;mach/hardware.h&gt;</span>

<span class="cp">#include &quot;imx_udc.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;imx_udc&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ep0name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;ep0&quot;</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">ep0_chg_stat</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span><span class="p">,</span>
							<span class="k">enum</span> <span class="n">ep0_state</span> <span class="n">stat</span><span class="p">);</span>

<span class="cm">/*******************************************************************************</span>
<span class="cm"> * IMX UDC hardware related functions</span>
<span class="cm"> *******************************************************************************</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">imx_udc_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_CTRL</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">CTRL_FE_ENA</span> <span class="o">|</span> <span class="n">CTRL_AFE_ENA</span><span class="p">,</span>
						<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_CTRL</span><span class="p">);</span>
	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">imx_udc_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_CTRL</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CTRL_FE_ENA</span> <span class="o">|</span> <span class="n">CTRL_AFE_ENA</span><span class="p">),</span>
		 <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_CTRL</span><span class="p">);</span>

	<span class="n">ep0_chg_stat</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="n">imx_usb</span><span class="p">,</span> <span class="n">EP0_IDLE</span><span class="p">);</span>
	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">imx_udc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_ENAB</span><span class="p">);</span>

	<span class="cm">/* set RST bit */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">ENAB_RST</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_ENAB</span><span class="p">);</span>

	<span class="cm">/* wait RST bit to clear */</span>
	<span class="k">do</span> <span class="p">{}</span> <span class="k">while</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_ENAB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ENAB_RST</span><span class="p">);</span>

	<span class="cm">/* wait CFG bit to assert */</span>
	<span class="k">do</span> <span class="p">{}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_DADR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DADR_CFG</span><span class="p">));</span>

	<span class="cm">/* udc module is now ready */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">imx_udc_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ep_conf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">;</span>

	<span class="cm">/* wait CFG bit to assert */</span>
	<span class="k">do</span> <span class="p">{}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_DADR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DADR_CFG</span><span class="p">));</span>

	<span class="cm">/* Download the endpoint buffer for endpoint 0. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">imx_ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fifosize</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_DDAT</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{}</span> <span class="k">while</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_DADR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DADR_BSY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Download the endpoint buffers for endpoints 1-5.</span>
<span class="cm">	 * We specify two configurations, one interface</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">cfg</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">cfg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IMX_USB_NB_EP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">imx_ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">imx_ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="cm">/* EP no | Config no */</span>
			<span class="n">ep_conf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="cm">/* Type | Direction */</span>
			<span class="n">ep_conf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">EP_DIR</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="cm">/* Max packet size */</span>
			<span class="n">ep_conf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">fifosize</span><span class="p">;</span>
			<span class="cm">/* TRXTYP */</span>
			<span class="n">ep_conf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>
			<span class="cm">/* FIFO no */</span>
			<span class="n">ep_conf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">D_INI</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;&lt;%s&gt; ep%d_conf[%d]:&quot;</span>
				<span class="s">&quot;[%02x-%02x-%02x-%02x-%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span>
				<span class="n">ep_conf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ep_conf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ep_conf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				<span class="n">ep_conf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ep_conf</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">ep_conf</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
					<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_DDAT</span><span class="p">);</span>
				<span class="k">do</span> <span class="p">{}</span> <span class="k">while</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span>
								<span class="o">+</span> <span class="n">USB_DADR</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="n">DADR_BSY</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* wait CFG bit to clear */</span>
	<span class="k">do</span> <span class="p">{}</span> <span class="k">while</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_DADR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DADR_CFG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">imx_udc_init_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Mask and clear all irqs */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_MASK</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_INTR</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IMX_USB_NB_EP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x1FF</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_MASK</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x1FF</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_INTR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Enable USB irqs */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">INTR_MSOF</span> <span class="o">|</span> <span class="n">INTR_FRAME_MATCH</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_MASK</span><span class="p">);</span>

	<span class="cm">/* Enable EP0 irqs */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x1FF</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">EPINTR_DEVREQ</span> <span class="o">|</span> <span class="n">EPINTR_MDEVREQ</span> <span class="o">|</span> <span class="n">EPINTR_EOT</span>
		<span class="o">|</span> <span class="n">EPINTR_EOF</span> <span class="o">|</span> <span class="n">EPINTR_FIFO_EMPTY</span> <span class="o">|</span> <span class="n">EPINTR_FIFO_FULL</span><span class="p">),</span>
		<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_MASK</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">imx_udc_init_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IMX_USB_NB_EP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">imx_ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">imx_ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">fifosize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">64</span>:
			<span class="n">max</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">EP_DIR</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_STAT</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">EPSTAT_FLUSH</span><span class="p">,</span>
						<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_STAT</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">D_INI</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; ep%d_stat %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_STAT</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">imx_udc_init_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IMX_USB_NB_EP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">imx_ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">imx_ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* Fifo control */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">EP_DIR</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0B000000</span> <span class="o">:</span> <span class="mh">0x0F000000</span><span class="p">;</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_FCTRL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">D_INI</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; ep%d_fctrl %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_FCTRL</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span>

		<span class="cm">/* Fifo alarm */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">?</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">fifosize</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_FALRM</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">D_INI</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; ep%d_falrm %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_FALRM</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">imx_udc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Reset UDC */</span>
	<span class="n">imx_udc_reset</span><span class="p">(</span><span class="n">imx_usb</span><span class="p">);</span>

	<span class="cm">/* Download config to enpoint buffer */</span>
	<span class="n">imx_udc_config</span><span class="p">(</span><span class="n">imx_usb</span><span class="p">);</span>

	<span class="cm">/* Setup interrups */</span>
	<span class="n">imx_udc_init_irq</span><span class="p">(</span><span class="n">imx_usb</span><span class="p">);</span>

	<span class="cm">/* Setup endpoints */</span>
	<span class="n">imx_udc_init_ep</span><span class="p">(</span><span class="n">imx_usb</span><span class="p">);</span>

	<span class="cm">/* Setup fifos */</span>
	<span class="n">imx_udc_init_fifo</span><span class="p">(</span><span class="n">imx_usb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">imx_ep_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x1FF</span><span class="p">,</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_MASK</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x1FF</span><span class="p">,</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_INTR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x1FF</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">EPINTR_EOT</span> <span class="o">|</span> <span class="n">EPINTR_EOF</span><span class="p">),</span>
		<span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_MASK</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">imx_ep_irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x1FF</span><span class="p">,</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_MASK</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x1FF</span><span class="p">,</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_INTR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">imx_ep_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span> <span class="o">=</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_FSTAT</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)))</span>
			<span class="o">&amp;</span> <span class="n">FSTAT_EMPTY</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="nf">imx_fifo_bcount</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span> <span class="o">=</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_STAT</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)))</span>
			<span class="o">&amp;</span> <span class="n">EPSTAT_BCOUNT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">imx_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span> <span class="o">=</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_STAT</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)));</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">EPSTAT_FLUSH</span><span class="p">,</span>
		<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_STAT</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">imx_ep_stall</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span> <span class="o">=</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;&lt;%s&gt; Forced stall on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="n">imx_flush</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>

	<span class="cm">/* Special care for ep0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_CTRL</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">CTRL_CMDOVER</span> <span class="o">|</span> <span class="n">CTRL_CMDERROR</span><span class="p">,</span>
						<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_CTRL</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span> <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_CTRL</span><span class="p">)</span>
						<span class="o">&amp;</span> <span class="n">CTRL_CMDOVER</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_CTRL</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CTRL_CMDERROR</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_CTRL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_STAT</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)));</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">EPSTAT_STALL</span><span class="p">,</span>
			<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_STAT</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span>
						<span class="o">+</span> <span class="n">USB_EP_STAT</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">EPSTAT_STALL</span><span class="p">))</span>
	 			<span class="k">break</span><span class="p">;</span>
	 		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	 	<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; Non finished stall on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx_udc_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_gadget</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">imx_udc_struct</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_FRAME</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7FF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx_udc_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*******************************************************************************</span>
<span class="cm"> * USB request control functions</span>
<span class="cm"> *******************************************************************************</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep_add_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">imx_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep_del_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">imx_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">done</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">imx_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ep_del_request</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">))</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span>
		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;&lt;%s&gt; complete %s req %p stat %d len %u/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nuke</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imx_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="n">done</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*******************************************************************************</span>
<span class="cm"> * Data tansfer over USB functions</span>
<span class="cm"> *******************************************************************************</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imx_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">bytes_ep</span><span class="p">,</span> <span class="n">bufferspace</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">bytes_ep</span> <span class="o">=</span> <span class="n">imx_fifo_bcount</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>
	<span class="n">bufferspace</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">prefetchw</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">imx_ep_empty</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)))</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* zlp */</span>
	<span class="k">else</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">bytes_ep</span><span class="p">,</span> <span class="n">bufferspace</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">__raw_readb</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span>
						<span class="o">+</span> <span class="n">USB_EP_FDAT0</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imx_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">length</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span>
				 <span class="n">USB_EP_STAT</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">EPSTAT_ZLPS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_TRX</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; zlp still queued in EP %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">fifosize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">imx_fifo_bcount</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)</span> <span class="o">+</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">fifosize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_TRX</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; packet overfill %s fifo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* zlp */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span>
			<span class="o">+</span> <span class="n">USB_EP_STAT</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)));</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">EPSTAT_ZLPS</span><span class="p">,</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span>
			<span class="o">+</span> <span class="n">USB_EP_STAT</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)));</span>
		<span class="n">D_TRX</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; zero packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* last byte */</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span>
				<span class="o">+</span> <span class="n">USB_EP_FCTRL</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)));</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">FCTRL_WFR</span><span class="p">,</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span>
				<span class="o">+</span> <span class="n">USB_EP_FCTRL</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)));</span>
		<span class="p">}</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">,</span>
			<span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_FDAT0</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imx_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> 	<span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">count</span><span class="p">,</span>
		<span class="n">completed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_FSTAT</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)))</span>
		<span class="o">&amp;</span> <span class="n">FSTAT_FR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">read_packet</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="n">bytes</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

			<span class="n">completed</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">fifosize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">completed</span> <span class="o">||</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">completed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">completed</span> <span class="o">||</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">done</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">D_REQ</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; %s req&lt;%p&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
			<span class="n">completed</span> <span class="o">?</span> <span class="s">&quot;completed&quot;</span> <span class="o">:</span> <span class="s">&quot;not completed&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">))</span>
			<span class="n">ep0_chg_stat</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="p">,</span> <span class="n">EP0_IDLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">D_TRX</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; bytes read: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">completed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imx_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">count</span><span class="p">,</span>
		<span class="n">completed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">completed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">write_packet</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* busy */</span>
		<span class="n">bytes</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

		<span class="cm">/* last packet &quot;must be&quot; short (or a zlp) */</span>
		<span class="n">completed</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">fifosize</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">completed</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">done</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">D_REQ</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; %s req&lt;%p&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
				<span class="n">completed</span> <span class="o">?</span> <span class="s">&quot;completed&quot;</span> <span class="o">:</span> <span class="s">&quot;not completed&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">))</span>
				<span class="n">ep0_chg_stat</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span>
						<span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="p">,</span> <span class="n">EP0_IDLE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">D_TRX</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; bytes sent: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">completed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*******************************************************************************</span>
<span class="cm"> * Endpoint handlers</span>
<span class="cm"> *******************************************************************************</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">completed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">imx_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">D_REQ</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; no request on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">EP_DIR</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">))</span>	<span class="cm">/* to host */</span>
			<span class="n">completed</span> <span class="o">=</span> <span class="n">write_fifo</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">else</span>			<span class="cm">/* to device */</span>
			<span class="n">completed</span> <span class="o">=</span> <span class="n">read_fifo</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

		<span class="n">dump_ep_stat</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="n">imx_ep</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">completed</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_ep0</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imx_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">ep0state</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">EP0_IN_DATA_PHASE</span>:			<span class="cm">/* GET_DESCRIPTOR */</span>
			<span class="n">write_fifo</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EP0_OUT_DATA_PHASE</span>:		<span class="cm">/* SET_DESCRIPTOR */</span>
			<span class="n">read_fifo</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">D_EP0</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;&lt;%s&gt; ep0 i/o, odd state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">ep0state</span><span class="p">);</span>
			<span class="n">ep_del_request</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EL2HLT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">else</span>
		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; no request on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_ep0_devreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">imx_ep</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_ctrlrequest</span>	<span class="n">r</span><span class="p">;</span>
		<span class="n">u8</span>			<span class="n">raw</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="n">u32</span>			<span class="n">word</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">nuke</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">,</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">);</span>

	<span class="cm">/* read SETUP packet */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imx_ep_empty</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;&lt;%s&gt; no setup packet received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">u</span><span class="p">.</span><span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span>
						<span class="o">+</span> <span class="n">USB_EP_FDAT</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">imx_ep_empty</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">imx_ep_empty</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span>	<span class="n">USB_EP_FDAT</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)));</span>
		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;&lt;%s&gt; wrong to have extra bytes for setup : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">temp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>

	<span class="n">le16_to_cpus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wValue</span><span class="p">);</span>
	<span class="n">le16_to_cpus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wIndex</span><span class="p">);</span>
	<span class="n">le16_to_cpus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wLength</span><span class="p">);</span>

	<span class="n">D_REQ</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; SETUP %02x.%02x v%04x i%04x l%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequest</span><span class="p">,</span>
		<span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wValue</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wIndex</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">wLength</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">set_config</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* NACK the host by using CMDOVER */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_CTRL</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">CTRL_CMDOVER</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_CTRL</span><span class="p">);</span>

		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;&lt;%s&gt; set config req is pending, NACK the host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
		<span class="n">ep0_chg_stat</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="n">imx_usb</span><span class="p">,</span> <span class="n">EP0_IN_DATA_PHASE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ep0_chg_stat</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="n">imx_usb</span><span class="p">,</span> <span class="n">EP0_OUT_DATA_PHASE</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; device setup error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="nl">stall:</span>
	<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; protocol STALL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">imx_ep_stall</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>
	<span class="n">ep0_chg_stat</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="n">imx_usb</span><span class="p">,</span> <span class="n">EP0_STALL</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*******************************************************************************</span>
<span class="cm"> * USB gadget callback functions</span>
<span class="cm"> *******************************************************************************</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx_ep_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">usb_ep</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">usb_ep</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">imx_ep_struct</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span> <span class="o">=</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_ep</span>
		<span class="o">||</span> <span class="o">!</span><span class="n">desc</span>
		<span class="o">||</span> <span class="o">!</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)</span>
		<span class="o">||</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">!=</span> <span class="n">USB_DT_ENDPOINT</span>
		<span class="o">||</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">!=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;&lt;%s&gt; bad ep or descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">!=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;&lt;%s&gt; %s type mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">usb_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">fifosize</span> <span class="o">&lt;</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;&lt;%s&gt; bad %s maxpacket</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">usb_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; bogus device state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">imx_flush</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>
	<span class="n">imx_ep_irq_enable</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">D_EPX</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; ENABLED %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">usb_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx_ep_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">usb_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">usb_ep</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">imx_ep_struct</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; %s can not be disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">usb_ep</span> <span class="o">?</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nuke</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="n">imx_flush</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>
	<span class="n">imx_ep_irq_disable</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">D_EPX</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;&lt;%s&gt; DISABLED %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">usb_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="nf">imx_ep_alloc_request</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">usb_ep</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_ep</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">imx_ep_free_request</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">usb_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">usb_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">usb_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imx_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx_ep_queue</span>
	<span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">usb_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">usb_req</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_ep_struct</span>	<span class="o">*</span><span class="n">imx_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imx_udc_struct</span>	<span class="o">*</span><span class="n">imx_usb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imx_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">imx_ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">usb_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imx_ep_struct</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">imx_usb</span> <span class="o">=</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">usb_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imx_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	  Special care on IMX udc.</span>
<span class="cm">	  Ignore enqueue when after set configuration from the</span>
<span class="cm">	  host. This assume all gadget drivers reply set</span>
<span class="cm">	  configuration with the next ep0 req enqueue.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">set_config</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">set_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;&lt;%s&gt; gadget reply set config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">usb_req</span> <span class="o">||</span> <span class="o">!</span><span class="n">req</span> <span class="o">||</span> <span class="o">!</span><span class="n">usb_req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">||</span> <span class="o">!</span><span class="n">usb_req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; bad params</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">usb_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">imx_ep</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; bad ep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; bogus device state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Debug */</span>
	<span class="n">D_REQ</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; ep%d %s request for [%d] bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">),</span>
		<span class="p">((</span><span class="o">!</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">ep0state</span>
							<span class="o">==</span> <span class="n">EP0_IN_DATA_PHASE</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">EP_DIR</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)))</span>
					<span class="o">?</span> <span class="s">&quot;IN&quot;</span> <span class="o">:</span> <span class="s">&quot;OUT&quot;</span><span class="p">,</span> <span class="n">usb_req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">dump_req</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="n">imx_ep</span><span class="p">,</span> <span class="n">usb_req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;&lt;%s&gt; refusing to queue req %p (already queued)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">usb_req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">usb_req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ep_add_request</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">handle_ep0</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">handle_ep</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx_ep_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">usb_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">usb_req</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span> <span class="o">=</span> <span class="n">container_of</span>
					<span class="p">(</span><span class="n">usb_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imx_ep_struct</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">imx_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">usb_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; bad ep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* make sure it&#39;s actually queued on this endpoint */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">==</span> <span class="n">usb_req</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">!=</span> <span class="n">usb_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">done</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx_ep_set_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">usb_ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span> <span class="o">=</span> <span class="n">container_of</span>
					<span class="p">(</span><span class="n">usb_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imx_ep_struct</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">usb_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; bad ep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">imx_ep_stall</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">D_EPX</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; %s halt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">usb_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx_ep_fifo_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">usb_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span> <span class="o">=</span> <span class="n">container_of</span>
					<span class="p">(</span><span class="n">usb_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imx_ep_struct</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; bad ep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">imx_fifo_bcount</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">imx_ep_fifo_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">usb_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span> <span class="o">=</span> <span class="n">container_of</span>
					<span class="p">(</span><span class="n">usb_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imx_ep_struct</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_ERR</span><span class="p">(</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; bad ep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* toggle and halt bits stay unchanged */</span>
	<span class="n">imx_flush</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">imx_ep_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">imx_ep_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">imx_ep_disable</span><span class="p">,</span>

	<span class="p">.</span><span class="n">alloc_request</span>	<span class="o">=</span> <span class="n">imx_ep_alloc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_request</span>	<span class="o">=</span> <span class="n">imx_ep_free_request</span><span class="p">,</span>

	<span class="p">.</span><span class="n">queue</span>		<span class="o">=</span> <span class="n">imx_ep_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue</span>	<span class="o">=</span> <span class="n">imx_ep_dequeue</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_halt</span>	<span class="o">=</span> <span class="n">imx_ep_set_halt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_status</span>	<span class="o">=</span> <span class="n">imx_ep_fifo_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_flush</span>	<span class="o">=</span> <span class="n">imx_ep_fifo_flush</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*******************************************************************************</span>
<span class="cm"> * USB endpoint control functions</span>
<span class="cm"> *******************************************************************************</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ep0_chg_stat</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ep0_state</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">D_EP0</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; from %15s to %15s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">label</span><span class="p">,</span> <span class="n">state_name</span><span class="p">[</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">ep0state</span><span class="p">],</span> <span class="n">state_name</span><span class="p">[</span><span class="n">stat</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">==</span> <span class="n">stat</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">stat</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usb_init_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* device/ep0 records init */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="n">ep0_chg_stat</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="n">imx_usb</span><span class="p">,</span> <span class="n">EP0_IDLE</span><span class="p">);</span>

	<span class="cm">/* basic endpoint records init */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IMX_USB_NB_EP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">imx_ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">imx_ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
			<span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_stop_activity</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* prevent new request submissions, kill any outstanding requests  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IMX_USB_NB_EP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">imx_ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">imx_ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">imx_flush</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>
		<span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">imx_ep_irq_disable</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>
		<span class="n">nuke</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">intf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="p">)</span>
		<span class="n">driver</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*******************************************************************************</span>
<span class="cm"> * Interrupt handlers</span>
<span class="cm"> *******************************************************************************</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Called when timer expires.</span>
<span class="cm"> * Timer is started when CFG_CHG is received.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_config</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="n">u</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">alt</span><span class="p">;</span>

	<span class="n">local_irq_disable</span><span class="p">();</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_STAT</span><span class="p">);</span>
	<span class="n">cfg</span>  <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">STAT_CFG</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">intf</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">STAT_INTF</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">alt</span>  <span class="o">=</span>  <span class="n">temp</span> <span class="o">&amp;</span> <span class="n">STAT_ALTSET</span><span class="p">;</span>

	<span class="n">D_REQ</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;&lt;%s&gt; orig config C=%d, I=%d, A=%d / &quot;</span>
		<span class="s">&quot;req config C=%d, I=%d, A=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">,</span>
		<span class="n">cfg</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">alt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">cfg</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">cfg</span> <span class="o">!=</span> <span class="n">cfg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">USB_REQ_SET_CONFIGURATION</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span>
					<span class="n">USB_TYPE_STANDARD</span> <span class="o">|</span>
					<span class="n">USB_RECIP_DEVICE</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">wValue</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>
			<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">intf</span> <span class="o">!=</span> <span class="n">intf</span> <span class="o">||</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">!=</span> <span class="n">alt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">USB_REQ_SET_INTERFACE</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span>
					  <span class="n">USB_TYPE_STANDARD</span> <span class="o">|</span>
					  <span class="n">USB_RECIP_INTERFACE</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">wValue</span> <span class="o">=</span> <span class="n">alt</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span> <span class="n">intf</span><span class="p">;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">intf</span> <span class="o">=</span> <span class="n">intf</span><span class="p">;</span>
			<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">=</span> <span class="n">alt</span><span class="p">;</span>
			<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">set_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">local_irq_enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">imx_udc_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_INTR</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INTR_WAKEUP</span> <span class="o">|</span> <span class="n">INTR_SUSPEND</span> <span class="o">|</span> <span class="n">INTR_RESUME</span> <span class="o">|</span> <span class="n">INTR_RESET_START</span>
			<span class="o">|</span> <span class="n">INTR_RESET_STOP</span> <span class="o">|</span> <span class="n">INTR_CFG_CHG</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dump_intr</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">dump_usb_stat</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="n">imx_usb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end_irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">INTR_SOF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Copy from Freescale BSP.</span>
<span class="cm">		   We must enable SOF intr and set CMDOVER.</span>
<span class="cm">		   Datasheet don&#39;t specifiy this action, but it</span>
<span class="cm">		   is done in Freescale BSP, so just copy it.</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">==</span> <span class="n">EP0_IDLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_CTRL</span><span class="p">);</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">CTRL_CMDOVER</span><span class="p">,</span>
						<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_CTRL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">INTR_CFG_CHG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* A workaround of serious IMX UDC bug.</span>
<span class="cm">		   Handling of CFG_CHG should be delayed for some time, because</span>
<span class="cm">		   IMX does not NACK the host when CFG_CHG interrupt is pending.</span>
<span class="cm">		   There is no time to handle current CFG_CHG</span>
<span class="cm">		   if next CFG_CHG or SETUP packed is send immediately.</span>
<span class="cm">		   We have to clear CFG_CHG, start the timer and</span>
<span class="cm">		   NACK the host by setting CTRL_CMDOVER</span>
<span class="cm">		   if it sends any SETUP packet.</span>
<span class="cm">		   When timer expires, handler is called to handle configuration</span>
<span class="cm">		   changes. While CFG_CHG is not handled (set_config=1),</span>
<span class="cm">		   we must NACK the host to every SETUP packed.</span>
<span class="cm">		   This delay prevents from going out of sync with host.</span>
<span class="cm">		 */</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">INTR_CFG_CHG</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_INTR</span><span class="p">);</span>
		<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">set_config</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">end_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">INTR_WAKEUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span>
			<span class="o">&amp;&amp;</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
				<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">set_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">INTR_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_UNKNOWN</span>
			<span class="o">&amp;&amp;</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
				<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">set_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">INTR_RESET_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">intr</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_INTR</span><span class="p">);</span>
		<span class="n">udc_stop_activity</span><span class="p">(</span><span class="n">imx_usb</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
		<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">set_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">INTR_RESET_STOP</span><span class="p">)</span>
		<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>

<span class="nl">end_irq:</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">intr</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_INTR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">imx_udc_ctrl_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">imx_ep</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">intr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_INTR</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="n">dump_ep_intr</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">intr</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_INTR</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* DEVREQ has highest priority */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EPINTR_DEVREQ</span> <span class="o">|</span> <span class="n">EPINTR_MDEVREQ</span><span class="p">))</span>
		<span class="n">handle_ep0_devreq</span><span class="p">(</span><span class="n">imx_usb</span><span class="p">);</span>
	<span class="cm">/* Seem i.MX is missing EOF interrupt sometimes.</span>
<span class="cm">	 * Therefore we don&#39;t monitor EOF.</span>
<span class="cm">	 * We call handle_ep0() only if a request is queued for ep0.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">handle_ep0</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">intr</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_INTR</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef MX1_INT_USBD0</span>
<span class="cp">#define MX1_INT_USBD0 MX1_USBD_INT0</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">imx_udc_bulk_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imx_ep_struct</span> <span class="o">*</span><span class="n">imx_ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">imx_ep</span><span class="p">[</span><span class="n">irq</span> <span class="o">-</span> <span class="n">MX1_INT_USBD0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">intr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_INTR</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)));</span>

	<span class="n">dump_ep_intr</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="n">irq</span> <span class="o">-</span> <span class="n">MX1_INT_USBD0</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">intr</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_INTR</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)));</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">handle_ep</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">intr</span><span class="p">,</span> <span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_EP_INTR</span><span class="p">(</span><span class="n">EP_NO</span><span class="p">(</span><span class="n">imx_ep</span><span class="p">)));</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">irq_handler_t</span> <span class="nf">intr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">imx_udc_ctrl_irq</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">3</span>:
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">return</span> <span class="n">imx_udc_bulk_irq</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">imx_udc_irq</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*******************************************************************************</span>
<span class="cm"> * Static defined IMX UDC structure</span>
<span class="cm"> *******************************************************************************</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">imx_udc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">imx_udc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_gadget_ops</span> <span class="n">imx_udc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_frame</span>	<span class="o">=</span> <span class="n">imx_udc_get_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wakeup</span>		<span class="o">=</span> <span class="n">imx_udc_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_start</span>	<span class="o">=</span> <span class="n">imx_udc_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_stop</span>	<span class="o">=</span> <span class="n">imx_udc_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="n">controller</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gadget</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">imx_udc_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ep0</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">controller</span><span class="p">.</span><span class="n">imx_ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">driver_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">init_name</span>	<span class="o">=</span> <span class="s">&quot;gadget&quot;</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">imx_ep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">ep0name</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">imx_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">imx_usb</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">controller</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifosize</span>		<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>		<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">.</span><span class="n">imx_ep</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep1in-bulk&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">imx_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">imx_usb</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">controller</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifosize</span>		<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span>	<span class="o">=</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>		<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">.</span><span class="n">imx_ep</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep2out-bulk&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">imx_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">imx_usb</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">controller</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifosize</span>		<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span>	<span class="o">=</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>		<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">.</span><span class="n">imx_ep</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep3out-bulk&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">imx_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">imx_usb</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">controller</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifosize</span>		<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> 	<span class="o">=</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>		<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">.</span><span class="n">imx_ep</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep4in-int&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">imx_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		 <span class="p">},</span>
		<span class="p">.</span><span class="n">imx_usb</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">controller</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifosize</span>		<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> 	<span class="o">=</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>		<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">.</span><span class="n">imx_ep</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ep5out-int&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">imx_ep_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxpacket</span>	<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">imx_usb</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">controller</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fifosize</span>		<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bEndpointAddress</span> 	<span class="o">=</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bmAttributes</span>		<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">,</span>
	 <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*******************************************************************************</span>
<span class="cm"> * USB gadget driver functions</span>
<span class="cm"> *******************************************************************************</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx_udc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">imx_usb</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imx_udc_struct</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="cm">/* first hook up the driver ... */</span>
	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">device_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">D_INI</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; registered gadget driver &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="n">imx_udc_enable</span><span class="p">(</span><span class="n">imx_usb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx_udc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">imx_udc_struct</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>

	<span class="n">udc_stop_activity</span><span class="p">(</span><span class="n">imx_usb</span><span class="p">,</span> <span class="n">driver</span><span class="p">);</span>
	<span class="n">imx_udc_disable</span><span class="p">(</span><span class="n">imx_usb</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">device_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">D_INI</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;%s&gt; unregistered gadget driver &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*******************************************************************************</span>
<span class="cm"> * Module functions</span>
<span class="cm"> *******************************************************************************</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">imx_udc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">controller</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imxusb_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">res_size</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t get device resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;driver needs platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">res_size</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t allocate %d bytes at %d address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">res_size</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">res_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ioremap failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;usbd_clk&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t get USB clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clk_get_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">48000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_INI</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Bad USB clock (%d Hz), changing to 48000000 Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">clk_get_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clk_set_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="mi">48000000</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Unable to set correct USB clock (48MHz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IMX_USB_NB_EP</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">usbd_int</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">usbd_int</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t get irq number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IMX_USB_NB_EP</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">usbd_int</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">intr_handler</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
				     <span class="mi">0</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">imx_usb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t get irq %i, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">usbd_int</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
				<span class="n">free_irq</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">usbd_int</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">imx_usb</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk</span><span class="p">;</span>
	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">device_initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">imx_usb</span><span class="p">);</span>

	<span class="n">usb_init_data</span><span class="p">(</span><span class="n">imx_usb</span><span class="p">);</span>
	<span class="n">imx_udc_init</span><span class="p">(</span><span class="n">imx_usb</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">handle_config</span><span class="p">;</span>
	<span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">imx_usb</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_add_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail4</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail4:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IMX_USB_NB_EP</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">usbd_int</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">imx_usb</span><span class="p">);</span>
<span class="nl">fail3:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
<span class="nl">fail2:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
<span class="nl">fail1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">)</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">fail0:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">res_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">imx_udc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx_udc_struct</span> <span class="o">*</span><span class="n">imx_usb</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">imxusb_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">usb_del_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="n">imx_udc_disable</span><span class="p">(</span><span class="n">imx_usb</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IMX_USB_NB_EP</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">usbd_int</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">imx_usb</span><span class="p">);</span>

	<span class="n">clk_put</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">imx_usb</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">)</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------------*/</span>

<span class="cp">#ifdef	CONFIG_PM</span>
<span class="cp">#define	imx_udc_suspend	NULL</span>
<span class="cp">#define	imx_udc_resume	NULL</span>
<span class="cp">#else</span>
<span class="cp">#define	imx_udc_suspend	NULL</span>
<span class="cp">#define	imx_udc_resume	NULL</span>
<span class="cp">#endif</span>

<span class="cm">/*----------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">udc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">driver_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">imx_udc_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">imx_udc_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">imx_udc_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">udc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_driver</span><span class="p">,</span> <span class="n">imx_udc_probe</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">udc_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">udc_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">udc_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;IMX USB Device Controller driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Darius Augulis &lt;augulis.darius@gmail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:imx_udc&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
