<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › gadget › goku_udc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>goku_udc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Toshiba TC86C001 (&quot;Goku-S&quot;) USB Device Controller driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2000-2002 Lineo</span>
<span class="cm"> *      by Stuart Lynne, Tom Rushworth, and Bruce Balden</span>
<span class="cm"> * Copyright (C) 2002 Toshiba Corporation</span>
<span class="cm"> * Copyright (C) 2003 MontaVista Software (source@mvista.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licensed under the terms of the GNU General Public</span>
<span class="cm"> * License version 2.  This program is licensed &quot;as is&quot; without any</span>
<span class="cm"> * warranty of any kind, whether express or implied.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This device has ep0 and three semi-configurable bulk/interrupt endpoints.</span>
<span class="cm"> *</span>
<span class="cm"> *  - Endpoint numbering is fixed: ep{1,2,3}-bulk</span>
<span class="cm"> *  - Gadget drivers can choose ep maxpacket (8/16/32/64)</span>
<span class="cm"> *  - Gadget drivers can choose direction (IN, OUT)</span>
<span class="cm"> *  - DMA works with ep1 (OUT transfers) and ep2 (IN transfers).</span>
<span class="cm"> */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define    VERBOSE     /* extra debug messages (success too) */</h1>

<h1>define    USB_TRACE   /* packet-level success messages */</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>

<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>


<span class="cp">#include &quot;goku_udc.h&quot;</span>

<span class="cp">#define	DRIVER_DESC		&quot;TC86C001 USB Device Controller&quot;</span>
<span class="cp">#define	DRIVER_VERSION		&quot;30-Oct 2003&quot;</span>

<span class="cp">#define	DMA_ADDR_INVALID	(~(dma_addr_t)0)</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_name</span> <span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;goku_udc&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_desc</span> <span class="p">[]</span> <span class="o">=</span> <span class="n">DRIVER_DESC</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;source@mvista.com&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * IN dma behaves ok under testing, though the IN-dma abort paths don&#39;t</span>
<span class="cm"> * seem to behave quite as expected.  Used by default.</span>
<span class="cm"> *</span>
<span class="cm"> * OUT dma documents design problems handling the common &quot;short packet&quot;</span>
<span class="cm"> * transfer termination policy; it couldn&#39;t be enabled by default, even</span>
<span class="cm"> * if the OUT-dma abort problems had a resolution.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">use_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><h1>include <linux/moduleparam.h></h1></td><td class="code"><div class="highlight"><pre><span class="c">/* &quot;modprobe goku_udc use_dma=1&quot; etc</span>
<span class="c"> *	0 to disable dma</span>
<span class="c"> *	1 to use IN dma only (normal operation)</span>
<span class="c"> *	2 to use IN and OUT dma</span>
<span class="c"> */</span>
<span class="c">module_param(use_dma, uint, S_IRUGO);</span>
<span class="cp">#endif</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">nuke</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_ep</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">command</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">epnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">COMMAND_EP</span><span class="p">(</span><span class="n">epnum</span><span class="p">)</span> <span class="o">|</span> <span class="n">command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Command</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">goku_ep_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_udc</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">goku_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">mode</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span>
			<span class="o">||</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">!=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="n">usb_endpoint_num</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">usb_endpoint_type</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>:
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EPxSTATUS_EP_MASK</span><span class="p">)</span>
			<span class="o">!=</span> <span class="n">EPxSTATUS_EP_INVALID</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* enabling the no-toggle interrupt mode would need an api hook */</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">max</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">max</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">64</span>:	<span class="n">mode</span><span class="o">++</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:	<span class="n">mode</span><span class="o">++</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:	<span class="n">mode</span><span class="o">++</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:		<span class="n">mode</span> <span class="o">&lt;&lt;=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mode</span> <span class="o">|=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* bulk, or intr-with-toggle */</span>

	<span class="cm">/* ep1/ep2 dma direction is chosen early; it works in the other</span>
<span class="cm">	 * direction, with pio.  be cautious with out-dma.</span>
<span class="cm">	 */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">=</span> <span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="n">UDC_MSTRD_ENDPOINT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="n">UDC_MSTWR_ENDPOINT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s out-dma hides short packets</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* ep1 and ep2 can do double buffering and/or dma */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
		<span class="n">u32</span>				<span class="n">tmp</span><span class="p">;</span>

		<span class="cm">/* double buffer except (for now) with pio in */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">||</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
				<span class="o">?</span> <span class="mh">0x10</span>	<span class="cm">/* double buffered */</span>
				<span class="o">:</span> <span class="mh">0x11</span>	<span class="cm">/* single buffer */</span>
			<span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EPxSingle</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EPxSingle</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">?</span> <span class="mh">0x10</span><span class="cm">/*dma*/</span> <span class="o">:</span> <span class="mh">0x11</span><span class="cm">/*pio*/</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EPxBCS</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EPxBCS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_mode</span><span class="p">);</span>
	<span class="n">command</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">COMMAND_RESET</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;enable %s %s %s maxpacket %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">?</span> <span class="s">&quot;IN&quot;</span> <span class="o">:</span> <span class="s">&quot;OUT&quot;</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">?</span> <span class="s">&quot;dma&quot;</span> <span class="o">:</span> <span class="s">&quot;pio&quot;</span><span class="p">,</span>
		<span class="n">max</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_udc</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">command</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">COMMAND_INVALID</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="n">UDC_MSTWR_ENDPOINT</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">INT_MSTWREND</span>
							<span class="o">|</span><span class="n">INT_MSTWRTMOUT</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="n">UDC_MSTRD_ENDPOINT</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INT_MSTRDEND</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INT_EPxDATASET</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INT_EP0</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
			<span class="n">u32</span>				<span class="n">tmp</span><span class="p">;</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">EPxSingle</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x11</span> <span class="o">&lt;&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">EPxSingle</span><span class="p">);</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">EPxBCS</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x11</span> <span class="o">&lt;&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">EPxBCS</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* reset dma in case we&#39;re still using it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">master</span><span class="p">;</span>

			<span class="n">master</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dma_master</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MST_RW_BITS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="n">UDC_MSTWR_ENDPOINT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">master</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MST_W_BITS</span><span class="p">;</span>
				<span class="n">master</span> <span class="o">|=</span> <span class="n">MST_WR_RESET</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">master</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MST_R_BITS</span><span class="p">;</span>
				<span class="n">master</span> <span class="o">|=</span> <span class="n">MST_RD_RESET</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dma_master</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">MAX_FIFO_SIZE</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">goku_ep_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">goku_udc</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">==</span> <span class="n">EP0_SUSPEND</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disable %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nuke</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="n">ep_reset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span>
<span class="nf">goku_alloc_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">goku_free_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">done</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_udc</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">stopped</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">;</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">))</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
		<span class="n">usb_gadget_unmap_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">);</span>

<span class="cp">#ifndef USB_TRACE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;complete %s req %p stat %d len %u/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="cm">/* don&#39;t modify queue heads during completion callback */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="n">stopped</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">write_packet</span><span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fifo</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>	<span class="n">length</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">))</span>
		<span class="n">writel</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>return:  0 = still running, 1 = completed, negative = errno</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">write_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_udc</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">is_last</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DataSet</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">!=</span> <span class="n">EP0_IN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EL2HLT</span><span class="p">;</span>

	<span class="cm">/* NOTE:  just single-buffered PIO-IN for now.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">DATASET_A</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* clear our &quot;packet available&quot; irq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="n">INT_EPxDATASET</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_status</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">write_packet</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_fifo</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">);</span>

	<span class="cm">/* last packet often short (sometimes a zlp, especially on ep0) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EOP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_STATUS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">is_last</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">)</span>
				<span class="o">||</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span><span class="p">)</span>
			<span class="n">is_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">is_last</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if 0</span><span class="c">		/* printk seemed to trash is_last...*/</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><h1>ifdef USB_TRACE</h1></td><td class="code"><div class="highlight"><pre><span class="c">	VDBG(dev, &quot;wrote %s %u bytes%s IN %u left %p\n&quot;,</span>
<span class="c">		ep-&gt;ep.name, count, is_last ? &quot;/last&quot; : &quot;&quot;,</span>
<span class="c">		req-&gt;req.length - req-&gt;req.actual, req);</span>
<span class="cp">#endif</span>

	<span class="cm">/* requests complete when all IN data is in the FIFO,</span>
<span class="cm">	 * or sometimes later, if a zlp was needed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_last</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">size</span><span class="p">,</span> <span class="n">set</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">bufferspace</span><span class="p">,</span> <span class="n">is_short</span><span class="p">,</span> <span class="n">dbuff</span><span class="p">;</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
<span class="nl">top:</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">prefetchw</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">!=</span> <span class="n">EP0_OUT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EL2HLT</span><span class="p">;</span>

	<span class="n">dbuff</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* ack dataset irq matching the status we&#39;ll handle */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="n">INT_EPxDATASET</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_status</span><span class="p">);</span>

		<span class="n">set</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DataSet</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DATASET_AB</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EPxSizeLA</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">]);</span>
		<span class="n">bufferspace</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>

		<span class="cm">/* usually do nothing without an OUT packet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">bufferspace</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">set</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* use ep1/ep2 double-buffering for OUT */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="n">PACKET_ACTIVE</span><span class="p">))</span>
				<span class="n">size</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EPxSizeLB</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="n">PACKET_ACTIVE</span><span class="p">))</span>	<span class="cm">/* &quot;can&#39;t happen&quot; */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">&amp;=</span> <span class="n">DATASIZE</span><span class="p">;</span>	<span class="cm">/* EPxSizeH == 0 */</span>

		<span class="cm">/* ep0out no-out-data case for set_config, etc */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* read all bytes from this packet */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">is_short</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">);</span>
<span class="cp">#ifdef USB_TRACE</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;read %s %u bytes%s OUT req %p %u/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">is_short</span> <span class="o">?</span> <span class="s">&quot;/S&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">size</span><span class="o">--</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span>	<span class="n">byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_fifo</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bufferspace</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* this happens when the driver&#39;s buffer</span>
<span class="cm">				 * is smaller than what the host sent.</span>
<span class="cm">				 * discard the extra data in this packet.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">)</span>
					<span class="n">DBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s overflow %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>
				<span class="n">bufferspace</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* completion */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">is_short</span> <span class="o">||</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* non-control endpoints now usable? */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_config</span><span class="p">)</span>
					<span class="n">writel</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">configured</span>
							<span class="o">?</span> <span class="n">USBSTATE_CONFIGURED</span>
							<span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">UsbState</span><span class="p">);</span>
				<span class="cm">/* ep0out status stage */</span>
				<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EOP</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_STATUS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* empty the second buffer asap */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dbuff</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">goku_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">top</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">dbuff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">pio_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">epnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span> <span class="o">|=</span> <span class="n">INT_EPxDATASET</span> <span class="p">(</span><span class="n">epnum</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">);</span>
	<span class="cm">/* write may still be posted */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">pio_irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">epnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INT_EPxDATASET</span> <span class="p">(</span><span class="n">epnum</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">);</span>
	<span class="cm">/* write may still be posted */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">pio_advance</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">?</span> <span class="n">write_fifo</span> <span class="o">:</span> <span class="n">read_fifo</span><span class="p">)(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>return:  0 = q running, 1 = q stopped, negative = errno</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">start_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">master</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">start</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">master</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dma_master</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MST_RW_BITS</span><span class="p">;</span>

	<span class="cm">/* re-init the bits affecting IN dma; careful with zlps */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">master</span> <span class="o">&amp;</span> <span class="n">MST_RD_ENA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;start, IN active dma %03x!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">master</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><pre><code>    return -EL2HLT;
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">in_dma_end</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">in_dma_start</span><span class="p">);</span>

		<span class="n">master</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MST_R_BITS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">master</span> <span class="o">=</span> <span class="n">MST_RD_ENA</span> <span class="o">|</span> <span class="n">MST_RD_EOPB</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
					<span class="o">||</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span><span class="p">)</span>
			<span class="n">master</span> <span class="o">=</span> <span class="n">MST_RD_ENA</span> <span class="o">|</span> <span class="n">MST_EOPB_ENA</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">master</span> <span class="o">=</span> <span class="n">MST_RD_ENA</span> <span class="o">|</span> <span class="n">MST_EOPB_DIS</span><span class="p">;</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span> <span class="o">|=</span> <span class="n">INT_MSTRDEND</span><span class="p">;</span>

	<span class="cm">/* Goku DMA-OUT merges short packets, which plays poorly with</span>
<span class="cm">	 * protocols where short packets mark the transfer boundaries.</span>
<span class="cm">	 * The chip supports a nonstandard policy with INT_MSTWRTMOUT,</span>
<span class="cm">	 * ending transfers after 3 SOFs; we don&#39;t turn it on.</span>
<span class="cm">	 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">master</span> <span class="o">&amp;</span> <span class="n">MST_WR_ENA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;start, OUT active dma %03x!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">master</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><pre><code>    return -EL2HLT;
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">out_dma_end</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">out_dma_start</span><span class="p">);</span>

		<span class="n">master</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MST_W_BITS</span><span class="p">;</span>
		<span class="n">master</span> <span class="o">|=</span> <span class="n">MST_WR_ENA</span> <span class="o">|</span> <span class="n">MST_TIMEOUT_DIS</span><span class="p">;</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span> <span class="o">|=</span> <span class="n">INT_MSTWREND</span><span class="o">|</span><span class="n">INT_MSTWRTMOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dma_master</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_advance</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_request</span>		<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">master</span><span class="p">;</span>

	<span class="n">master</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dma_master</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)))</span> <span class="p">{</span>
<span class="nl">stop:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INT_MSTRDEND</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">INT_MSTWREND</span><span class="o">|</span><span class="n">INT_MSTWRTMOUT</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="cm">/* normal hw dma completion (not abort) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">master</span> <span class="o">&amp;</span> <span class="n">MST_RD_ENA</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">in_dma_current</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">master</span> <span class="o">&amp;</span> <span class="n">MST_WR_ENA</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* hardware merges short packets, and also hides packet</span>
<span class="cm">		 * overruns.  a partial packet MAY be in the fifo here.</span>
<span class="cm">		 */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">out_dma_current</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">-=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#ifdef USB_TRACE</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;done %s %s dma, %u/%u bytes, req %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">?</span> <span class="s">&quot;IN&quot;</span> <span class="o">:</span> <span class="s">&quot;OUT&quot;</span><span class="p">,</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">stop</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">start_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">abort_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">goku_request</span>		<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">curr</span><span class="p">,</span> <span class="n">master</span><span class="p">;</span>

	<span class="cm">/* NAK future host requests, hoping the implicit delay lets the</span>
<span class="cm">	 * dma engine finish reading (or writing) its latest packet and</span>
<span class="cm">	 * empty the dma buffer (up to 16 bytes).</span>
<span class="cm">	 *</span>
<span class="cm">	 * This avoids needing to clean up a partial packet in the fifo;</span>
<span class="cm">	 * we can&#39;t do that for IN without side effects to HALT and TOGGLE.</span>
<span class="cm">	 */</span>
	<span class="n">command</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">COMMAND_FIFO_DISABLE</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="n">master</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dma_master</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MST_RW_BITS</span><span class="p">;</span>

	<span class="cm">/* FIXME using these resets isn&#39;t usably documented. this may</span>
<span class="cm">	 * not work unless it&#39;s followed by disabling the endpoint.</span>
<span class="cm">	 *</span>
<span class="cm">	 * FIXME the OUT reset path doesn&#39;t even behave consistently.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dma_master</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MST_RD_ENA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
		<span class="n">curr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">in_dma_current</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">in_dma_end</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">in_dma_start</span><span class="p">);</span>

		<span class="n">master</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MST_R_BITS</span><span class="p">;</span>
		<span class="n">master</span> <span class="o">|=</span> <span class="n">MST_RD_RESET</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dma_master</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dma_master</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MST_RD_ENA</span><span class="p">)</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IN dma active after reset!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dma_master</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MST_WR_ENA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
		<span class="n">curr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">out_dma_current</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">out_dma_end</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">out_dma_start</span><span class="p">);</span>

		<span class="n">master</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MST_W_BITS</span><span class="p">;</span>
		<span class="n">master</span> <span class="o">|=</span> <span class="n">MST_WR_RESET</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dma_master</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dma_master</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MST_WR_ENA</span><span class="p">)</span>
			<span class="n">DBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OUT dma active after reset!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s %s %s %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">?</span> <span class="s">&quot;IN&quot;</span> <span class="o">:</span> <span class="s">&quot;OUT&quot;</span><span class="p">,</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="n">command</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">COMMAND_FIFO_ENABLE</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">finished:</span>
	<span class="cm">/* dma already completed; no abort needed */</span>
	<span class="n">command</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">COMMAND_FIFO_ENABLE</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">goku_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">goku_ep</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">goku_udc</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">status</span><span class="p">;</span>

	<span class="cm">/* always require a cpu-view buffer so pio works */</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">_req</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="o">-&gt;</span><span class="n">complete</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="cm">/* can&#39;t touch registers when suspended */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">==</span> <span class="n">EP0_SUSPEND</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* set up dma mapping in case the caller didn&#39;t */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_gadget_map_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef USB_TRACE</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s queue req %p, len %u buf %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">_req</span><span class="p">,</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">_req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">_req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* for ep0 IN without premature status, zlp is required and</span>
<span class="cm">	 * writing EOP starts the status stage (OUT).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">))</span>
		<span class="n">_req</span><span class="o">-&gt;</span><span class="n">zero</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* kickstart this i/o queue? */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* dma:  done after dma completion IRQ (or error)</span>
<span class="cm">		 * pio:  done after last fifo operation</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">start_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">?</span> <span class="n">write_fifo</span> <span class="o">:</span> <span class="n">read_fifo</span><span class="p">)(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="cm">/* else pio or dma irq handler advances the queue. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
			<span class="o">&amp;&amp;</span> <span class="n">likely</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span> <span class="o">&amp;</span> <span class="n">INT_EPxDATASET</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)))</span>
		<span class="n">pio_irq_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* pci writes may still be posted */</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* dequeue ALL requests */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nuke</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
		<span class="n">abort_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* dequeue JUST ONE request */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">goku_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">goku_ep</span>		<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">goku_udc</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="cm">/* we can&#39;t touch (dma) registers when suspended */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">==</span> <span class="n">EP0_SUSPEND</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s %s %s %s %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">?</span> <span class="s">&quot;IN&quot;</span> <span class="o">:</span> <span class="s">&quot;OUT&quot;</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">?</span> <span class="s">&quot;dma&quot;</span> <span class="o">:</span> <span class="s">&quot;pio&quot;</span><span class="p">,</span>
		<span class="n">_req</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* make sure it&#39;s actually queued on this endpoint */</span>
	<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">==</span> <span class="n">_req</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">!=</span> <span class="n">_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">abort_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
		<span class="n">dma_advance</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">done</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">req</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">goku_clear_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>assert (ep->num !=0)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s clear halt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">command</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">COMMAND_SETDATA0</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="n">command</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">COMMAND_STALL_CLEAR</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">goku_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_request</span><span class="p">,</span>
						<span class="n">queue</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">start_dma</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">pio_advance</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">goku_set_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_STALL</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* don&#39;t change EPxSTATUS_EP_INVALID to READY */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s %s inactive?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">&amp;&amp;</span> <span class="n">value</span>
			<span class="cm">/* data in (either) packet buffer? */</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DataSet</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="n">DATASET_AB</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)))</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span>
		<span class="n">goku_clear_halt</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s set halt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="n">command</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">COMMAND_STALL</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">goku_fifo_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_ep</span>			<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="cm">/* size is only reported sanely for OUT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="cm">/* ignores 16-byte dma buffer; SizeH == 0 */</span>
	<span class="n">regs</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EPxSizeLA</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">DATASIZE</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EPxSizeLB</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">DATASIZE</span><span class="p">;</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s %s %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">goku_fifo_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_ep</span>			<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">goku_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* don&#39;t change EPxSTATUS_EP_INVALID to READY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s %s inactive?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EPxSizeLA</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">]);</span>
	<span class="n">size</span> <span class="o">&amp;=</span> <span class="n">DATASIZE</span><span class="p">;</span>

	<span class="cm">/* Non-desirable behavior:  FIFO_CLEAR also clears the</span>
<span class="cm">	 * endpoint halt feature.  For OUT, we _could_ just read</span>
<span class="cm">	 * the bytes out (PIO, if !ep-&gt;dma); for in, no choice.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span>
		<span class="n">command</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">COMMAND_FIFO_CLEAR</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">goku_ep_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">goku_ep_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">goku_ep_disable</span><span class="p">,</span>

	<span class="p">.</span><span class="n">alloc_request</span>	<span class="o">=</span> <span class="n">goku_alloc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_request</span>	<span class="o">=</span> <span class="n">goku_free_request</span><span class="p">,</span>

	<span class="p">.</span><span class="n">queue</span>		<span class="o">=</span> <span class="n">goku_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue</span>	<span class="o">=</span> <span class="n">goku_dequeue</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_halt</span>	<span class="o">=</span> <span class="n">goku_set_halt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_status</span>	<span class="o">=</span> <span class="n">goku_fifo_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_flush</span>	<span class="o">=</span> <span class="n">goku_fifo_flush</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">goku_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">goku_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bind</span><span class="p">)(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="p">));</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">goku_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_gadget_ops</span> <span class="n">goku_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_frame</span>	<span class="o">=</span> <span class="n">goku_get_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="n">goku_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>		<span class="o">=</span> <span class="n">goku_stop</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>no remote wakeup
not selfpowered</p></td><td class="code"><div class="highlight"><pre><span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">dmastr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;(dma disabled)&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;(dma IN and OUT)&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="s">&quot;(dma IN)&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_USB_GADGET_DEBUG_FILES</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">proc_node_name</span> <span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;driver/udc&quot;</span><span class="p">;</span>

<span class="cp">#define FOURBITS &quot;%s%s%s%s&quot;</span>
<span class="cp">#define EIGHTBITS FOURBITS FOURBITS</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dump_intmask</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">next</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">t</span><span class="p">;</span>

	<span class="cm">/* int_status is the same format ... */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span>
		<span class="s">&quot;%s %05X =&quot;</span> <span class="n">FOURBITS</span> <span class="n">EIGHTBITS</span> <span class="n">EIGHTBITS</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">label</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_PWRDETECT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; power&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_SYSERROR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; sys&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_MSTRDEND</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; in-dma&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_MSTWRTMOUT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; wrtmo&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>

		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_MSTWREND</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; out-dma&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_MSTWRSET</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; wrset&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_ERR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; err&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_SOF</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; sof&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>

		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_EP3NAK</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ep3nak&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_EP2NAK</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ep2nak&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_EP1NAK</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ep1nak&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_EP3DATASET</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ep3&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>

		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_EP2DATASET</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ep2&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_EP1DATASET</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ep1&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_STATUSNAK</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ep0snak&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_STATUS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ep0status&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>

		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_SETUP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; setup&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_ENDPOINT0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ep0&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_USBRESET</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; reset&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">INT_SUSPEND</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; suspend&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
	<span class="o">*</span><span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">udc_proc_read</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
		<span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>				<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">goku_udc</span>			<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">char</span>				<span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">size</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">is_usb_connected</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* basic device status */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">power_detect</span><span class="p">);</span>
	<span class="n">is_usb_connected</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">PW_DETECT</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
		<span class="s">&quot;%s - %s</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;%s version: %s %s</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;Gadget driver: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;Host %s, %s</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="n">driver_desc</span><span class="p">,</span>
		<span class="n">driver_name</span><span class="p">,</span> <span class="n">DRIVER_VERSION</span><span class="p">,</span> <span class="n">dmastr</span><span class="p">(),</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">?</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;(none)&quot;</span><span class="p">,</span>
		<span class="n">is_usb_connected</span>
			<span class="o">?</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">PW_PULLUP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;full speed&quot;</span> <span class="o">:</span> <span class="s">&quot;powered&quot;</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;disconnected&quot;</span><span class="p">,</span>
		<span class="p">({</span><span class="kt">char</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span><span class="p">){</span>
		<span class="k">case</span> <span class="n">EP0_DISCONNECT</span>:	<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;ep0_disconnect&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EP0_IDLE</span>:		<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;ep0_idle&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EP0_IN</span>:		<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;ep0_in&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EP0_OUT</span>:		<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;ep0_out&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EP0_STATUS</span>:	<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;ep0_status&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EP0_STALL</span>:		<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;ep0_stall&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EP0_SUSPEND</span>:	<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;ep0_suspend&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>		<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;ep0_?&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">state</span><span class="p">;</span> <span class="p">})</span>
		<span class="p">);</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">dump_intmask</span><span class="p">(</span><span class="s">&quot;int_status&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_status</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">dump_intmask</span><span class="p">(</span><span class="s">&quot;int_enable&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_usb_connected</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">PW_PULLUP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* registers for (active) device and ep0 */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">irqs %lu</span><span class="se">\n</span><span class="s">dataset %02x &quot;</span>
			<span class="s">&quot;single.bcs %02x.%02x state %x addr %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DataSet</span><span class="p">),</span>
			<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EPxSingle</span><span class="p">),</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EPxBCS</span><span class="p">),</span>
			<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">UsbState</span><span class="p">),</span>
			<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">));</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dma_master</span><span class="p">);</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
		<span class="s">&quot;dma %03X =&quot;</span> <span class="n">EIGHTBITS</span> <span class="s">&quot;%s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MST_EOPB_DIS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; eopb-&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MST_EOPB_ENA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; eopb+&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MST_TIMEOUT_DIS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; tmo-&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MST_TIMEOUT_ENA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; tmo+&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>

		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MST_RD_EOPB</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; eopb&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MST_RD_RESET</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; in_reset&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MST_WR_RESET</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; out_reset&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MST_RD_ENA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; IN&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>

		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MST_WR_ENA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; OUT&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MST_CONNECTION</span><span class="p">)</span>
			<span class="o">?</span> <span class="s">&quot;ep1in/ep2out&quot;</span>
			<span class="o">:</span> <span class="s">&quot;ep1out/ep2in&quot;</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

	<span class="cm">/* dump endpoint queues */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">goku_ep</span>		<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">goku_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_status</span><span class="p">);</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			<span class="s">&quot;%s %s max %u %s, irqs %lu, &quot;</span>
			<span class="s">&quot;status %02x (%s) &quot;</span> <span class="n">FOURBITS</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">?</span> <span class="s">&quot;dma&quot;</span> <span class="o">:</span> <span class="s">&quot;pio&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">,</span>
			<span class="n">tmp</span><span class="p">,</span> <span class="p">({</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">EPxSTATUS_EP_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">EPxSTATUS_EP_READY</span>:
				<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;ready&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">EPxSTATUS_EP_DATAIN</span>:
				<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;packet&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">EPxSTATUS_EP_FULL</span>:
				<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;full&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">EPxSTATUS_EP_TX_ERR</span>:	<span class="c1">// host will retry</span>
				<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;tx_err&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">EPxSTATUS_EP_RX_ERR</span>:
				<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;rx_err&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">EPxSTATUS_EP_BUSY</span>:		<span class="cm">/* ep0 only */</span>
				<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;busy&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">EPxSTATUS_EP_STALL</span>:
				<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;stall&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">EPxSTATUS_EP_INVALID</span>:	<span class="c1">// these &quot;can&#39;t happen&quot;</span>
				<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;invalid&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;?&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">};</span> <span class="n">s</span><span class="p">;</span> <span class="p">}),</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">EPxSTATUS_TOGGLE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;data1&quot;</span> <span class="o">:</span> <span class="s">&quot;data0&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">EPxSTATUS_SUSPEND</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; suspend&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">EPxSTATUS_FIFO_DISABLE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; disable&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">EPxSTATUS_STAGE_ERROR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ep0stat&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span>
			<span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">(nothing queued)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
			<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">prev</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">UDC_MSTRD_ENDPOINT</span><span class="p">)</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">in_dma_current</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">out_dma_current</span><span class="p">);</span>
				<span class="n">tmp</span> <span class="o">-=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span><span class="p">;</span>
				<span class="n">tmp</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>

			<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\t</span><span class="s">req %p len %u/%u buf %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
			<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif	</span><span class="cm">/* CONFIG_USB_GADGET_DEBUG_FILES */</span><span class="cp"></span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_reinit</span> <span class="p">(</span><span class="k">struct</span> <span class="n">goku_udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">names</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;ep0&quot;</span><span class="p">,</span> <span class="s">&quot;ep1-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep2-bulk&quot;</span><span class="p">,</span> <span class="s">&quot;ep3-bulk&quot;</span> <span class="p">};</span>

	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_DISCONNECT</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">goku_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_fifo</span> <span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_status</span> <span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">reg_mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_mode</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">goku_ep_ops</span><span class="p">;</span>
		<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

		<span class="n">ep_reset</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg_mode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">MAX_EP0_SIZE</span><span class="p">;</span>
	<span class="n">list_del_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">power_detect</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* deassert reset, leave USB D+ at hi-Z (no pullup)</span>
<span class="cm">	 * don&#39;t let INT_PWRDETECT sequence begin</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PW_RESETB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">power_detect</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep0_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">i</span><span class="p">;</span>

	<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">udc_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">udc_reinit</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>writel(MST<em>EOPB</em>ENA | MST<em>TIMEOUT</em>ENA, &amp;regs->dma_master);</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* hw handles set_address, set_feature, get_status; maybe more */</span>
	<span class="n">writel</span><span class="p">(</span>   <span class="n">G_REQMODE_SET_INTF</span> <span class="o">|</span> <span class="n">G_REQMODE_GET_INTF</span>
		<span class="o">|</span> <span class="n">G_REQMODE_SET_CONF</span> <span class="o">|</span> <span class="n">G_REQMODE_GET_CONF</span>
		<span class="o">|</span> <span class="n">G_REQMODE_GET_DESC</span>
		<span class="o">|</span> <span class="n">G_REQMODE_CLEAR_FEAT</span>
		<span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">reqmode</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* can&#39;t modify descriptors after writing UsbReady */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DESC_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">descriptors</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">UsbReady</span><span class="p">);</span>

	<span class="cm">/* expect ep0 requests when the host drops reset */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PW_RESETB</span> <span class="o">|</span> <span class="n">PW_PULLUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">power_detect</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span> <span class="o">=</span> <span class="n">INT_DEVWIDE</span> <span class="o">|</span> <span class="n">INT_EP0</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_IDLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* start enumeration now, or after power detect irq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">power_detect</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PW_DETECT</span><span class="p">)</span>
		<span class="n">ep0_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span> <span class="o">=</span> <span class="n">INT_PWRDETECT</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* keeping it simple:</span>
<span class="cm"> * - one bus driver, initted first;</span>
<span class="cm"> * - one function driver, initted second</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">goku_udc</span>	<span class="o">*</span><span class="n">the_controller</span><span class="p">;</span>

<span class="cm">/* when a driver is successfully registered, it will receive</span>
<span class="cm"> * control requests including set_configuration(), which enables</span>
<span class="cm"> * non-control requests.  then usb traffic follows until a</span>
<span class="cm"> * disconnect is reported.  then a host may connect again, or</span>
<span class="cm"> * the driver might get unbound.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">goku_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bind</span><span class="p">)(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_udc</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">the_controller</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span>
			<span class="o">||</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">max_speed</span> <span class="o">&lt;</span> <span class="n">USB_SPEED_FULL</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">bind</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disconnect</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* hook up the driver */</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bind to driver %s --&gt; error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* then enable host detection and ep0; and we&#39;re ready</span>
<span class="cm">	 * for set_configuration as well as eventual disconnect.</span>
<span class="cm">	 */</span>
	<span class="n">udc_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;registered gadget driver &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">stop_activity</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>	<span class="n">i</span><span class="p">;</span>

	<span class="n">DBG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* disconnect gadget driver after quiesceing hw and the driver */</span>
	<span class="n">udc_reset</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">nuke</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">driver</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="n">udc_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">goku_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_udc</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">the_controller</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span> <span class="o">||</span> <span class="n">driver</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">stop_activity</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">driver</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">unbind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unregistered driver &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep0_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">goku_udc</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_ctrlrequest</span>		<span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* read SETUP packet and enter DATA stage */</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">bRequestType</span><span class="p">);</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">bRequest</span><span class="p">);</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">wValue</span>  <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">wValueH</span><span class="p">)</span>  <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
					<span class="o">|</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">wValueL</span><span class="p">));</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">wIndex</span>  <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">wIndexH</span><span class="p">)</span>  <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
					<span class="o">|</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">wIndexL</span><span class="p">));</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">wLengthH</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
					<span class="o">|</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">wLengthL</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">SetupRecv</span><span class="p">);</span>

	<span class="n">nuke</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ctrl</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">is_in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_IN</span><span class="p">;</span>
		<span class="cm">/* detect early status stages */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ICONTROL_STATUSNAK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">IntControl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">is_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_OUT</span><span class="p">;</span>

		<span class="cm">/* NOTE:  CLEAR_FEATURE is done in software so that we can</span>
<span class="cm">		 * synchronize transfer restarts after bulk IN stalls.  data</span>
<span class="cm">		 * won&#39;t even enter the fifo until the halt is cleared.</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">.</span><span class="n">bRequest</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_REQ_CLEAR_FEATURE</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">.</span><span class="n">bRequestType</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">USB_RECIP_ENDPOINT</span>:
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="p">.</span><span class="n">wIndex</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
				<span class="cm">/* active endpoint */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">||</span>
				    <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
						<span class="n">USB_DIR_IN</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">is_in</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">is_in</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">.</span><span class="n">wValue</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
						<span class="n">USB_ENDPOINT_HALT</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
					<span class="n">goku_clear_halt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">tmp</span><span class="p">]);</span>
<span class="nl">succeed:</span>
				<span class="cm">/* start ep0out status stage */</span>
				<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EOP</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_STATUS</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_RECIP_DEVICE</span>:
				<span class="cm">/* device remote wakeup: always clear */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">.</span><span class="n">wValue</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
				<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;clear dev remote wakeup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">succeed</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_RECIP_INTERFACE</span>:
				<span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
			<span class="nl">default:</span>		<span class="cm">/* pass to gadget driver */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef USB_TRACE</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SETUP %02x.%02x v%04x i%04x l%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ctrl</span><span class="p">.</span><span class="n">bRequestType</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">.</span><span class="n">bRequest</span><span class="p">,</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="p">.</span><span class="n">wValue</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="p">.</span><span class="n">wIndex</span><span class="p">),</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctrl</span><span class="p">.</span><span class="n">wLength</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="cm">/* hw wants to know when we&#39;re configured (or not) */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_config</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">==</span> <span class="n">USB_REQ_SET_CONFIGURATION</span>
				<span class="o">&amp;&amp;</span> <span class="n">ctrl</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">==</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_config</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">.</span><span class="n">wValue</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* delegate everything to the gadget driver.</span>
<span class="cm">	 * it may respond after this irq handler returns.</span>
<span class="cm">	 */</span>
	<span class="n">spin_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">spin_lock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
<span class="nl">stall:</span>
<span class="cp">#ifdef USB_TRACE</span>
		<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;req %02x.%02x protocol STALL; err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ctrl</span><span class="p">.</span><span class="n">bRequestType</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">.</span><span class="n">bRequest</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">command</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">COMMAND_STALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_STALL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* expect at least one data or status stage irq */</span>
<span class="p">}</span>

<span class="cp">#define ACK(irqbit) { \</span>
<span class="cp">		stat &amp;= ~irqbit; \</span>
<span class="cp">		writel(~irqbit, &amp;regs-&gt;int_status); \</span>
<span class="cp">		handled = 1; \</span>
<span class="cp">		}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">goku_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_udc</span>			<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">goku_ep</span>			<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">stat</span><span class="p">,</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">i</span><span class="p">,</span> <span class="n">rescans</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="nl">rescan:</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stat</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* device-wide irqs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">INT_DEVWIDE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">INT_SYSERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;system error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">stop_activity</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
			<span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>FIXME have a neater way to prevent re-enumeration</p></td><td class="code"><div class="highlight"><pre>			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">INT_PWRDETECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="n">stat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">power_detect</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PW_DETECT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">VDBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;connect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ep0_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disconnect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span><span class="p">)</span>
					<span class="n">stop_activity</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_DISCONNECT</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span> <span class="o">=</span> <span class="n">INT_DEVWIDE</span><span class="p">;</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">INT_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ACK</span><span class="p">(</span><span class="n">INT_SUSPEND</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_status</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">EPxSTATUS_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">EP0_DISCONNECT</span>:
				<span class="k">case</span> <span class="n">EP0_SUSPEND</span>:
					<span class="k">goto</span> <span class="n">pm_next</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_SUSPEND</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_UNKNOWN</span>
						<span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span>
						<span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
					<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">!=</span> <span class="n">EP0_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bogus USB resume %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">pm_next</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_IDLE</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_UNKNOWN</span>
						<span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span>
						<span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
					<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="nl">pm_next:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">INT_USBRESET</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* hub reset done */</span>
			<span class="n">ACK</span><span class="p">(</span><span class="n">INT_USBRESET</span><span class="p">);</span>
			<span class="n">INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB reset done, gadget %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>and INT_ERR on some endpoint's crc/bitstuff/... problem</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>

	<span class="cm">/* progress ep0 setup, data, or status stages.</span>
<span class="cm">	 * no transition {EP0_STATUS, EP0_STALL} --&gt; EP0_IDLE; saves irqs</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">INT_SETUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ACK</span><span class="p">(</span><span class="n">INT_SETUP</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ep0_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">INT_STATUSNAK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ACK</span><span class="p">(</span><span class="n">INT_STATUSNAK</span><span class="o">|</span><span class="n">INT_ENDPOINT0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">==</span> <span class="n">EP0_IN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>
			<span class="n">nuke</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EOP</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_STATUS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">INT_ENDPOINT0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ACK</span><span class="p">(</span><span class="n">INT_ENDPOINT0</span><span class="p">);</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pio_advance</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
        <span class="p">}</span>

	<span class="cm">/* dma completion */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">INT_MSTRDEND</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* IN */</span>
		<span class="n">ACK</span><span class="p">(</span><span class="n">INT_MSTRDEND</span><span class="p">);</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_MSTRD_ENDPOINT</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dma_advance</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">INT_MSTWREND</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* OUT */</span>
		<span class="n">ACK</span><span class="p">(</span><span class="n">INT_MSTWREND</span><span class="p">);</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_MSTWR_ENDPOINT</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dma_advance</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">INT_MSTWRTMOUT</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* OUT */</span>
		<span class="n">ACK</span><span class="p">(</span><span class="n">INT_MSTWRTMOUT</span><span class="p">);</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">UDC_MSTWR_ENDPOINT</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ERROR</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s write timeout ?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>reset dma? then dma_advance()</p></td><td class="code"><div class="highlight"><pre>        <span class="p">}</span>

	<span class="cm">/* pio */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span>		<span class="n">tmp</span> <span class="o">=</span> <span class="n">INT_EPxDATASET</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">tmp</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">pio_advance</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
			<span class="n">pio_irq_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">tmp</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rescans</span><span class="o">--</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rescan</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unhandled irq status: %05x (%05x, %05x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span>
				<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">int_status</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_enable</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#undef ACK</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gadget_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_udc</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">_dev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* tear down the binding between this driver and the pci device */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">goku_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_udc</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">usb_del_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_USB_GADGET_DEBUG_FILES</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">proc_node_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span>
		<span class="n">udc_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">got_irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">got_region</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">pci_resource_len</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">registered</span><span class="p">)</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">the_controller</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unbind</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* wrap this driver around the specified pci device, but</span>
<span class="cm"> * don&#39;t respond over USB until a gadget driver binds to us.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">goku_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">goku_udc</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">resource</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* if you want to support more than one controller in a system,</span>
<span class="cm">	 * usb_gadget_driver_{register,unregister}() must change.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">the_controller</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;ignoring %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Check PCI %s IRQ setup!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* alloc, and start init */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;enomem %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">goku_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">max_speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>

	<span class="cm">/* the &quot;gadget&quot; abstracts/virtualizes the controller */</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gadget&quot;</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">gadget_release</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">driver_name</span><span class="p">;</span>

	<span class="cm">/* now all the pci goodies ... */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t enable, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">resource</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">got_region</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t map memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">goku_udc_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">base</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_desc</span><span class="p">);</span>
	<span class="n">INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;version: &quot;</span> <span class="n">DRIVER_VERSION</span> <span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dmastr</span><span class="p">());</span>
	<span class="n">INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq %d, pci mem %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="cm">/* init to known state, then setup irqs */</span>
	<span class="n">udc_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">udc_reinit</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">goku_irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="cm">/*|IRQF_SAMPLE_RANDOM*/</span><span class="p">,</span>
			<span class="n">driver_name</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request interrupt %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">got_irq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">)</span>
		<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>


<span class="cp">#ifdef CONFIG_USB_GADGET_DEBUG_FILES</span>
	<span class="n">create_proc_read_entry</span><span class="p">(</span><span class="n">proc_node_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">udc_proc_read</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">the_controller</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_add_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">goku_remove</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">pci_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">class</span> <span class="o">=</span>	<span class="p">((</span><span class="n">PCI_CLASS_SERIAL_USB</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xfe</span><span class="p">),</span>
	<span class="p">.</span><span class="n">class_mask</span> <span class="o">=</span>	<span class="o">~</span><span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span>	<span class="mh">0x102f</span><span class="p">,</span>		<span class="cm">/* Toshiba */</span>
	<span class="p">.</span><span class="n">device</span> <span class="o">=</span>	<span class="mh">0x0107</span><span class="p">,</span>		<span class="cm">/* this UDC */</span>
	<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span>	<span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span>	<span class="n">PCI_ANY_ID</span><span class="p">,</span>

<span class="p">},</span> <span class="p">{</span> <span class="cm">/* end: all zeroes */</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span> <span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">goku_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">driver_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">pci_ids</span><span class="p">,</span>

	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">goku_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>	<span class="n">goku_remove</span><span class="p">,</span>

	<span class="cm">/* FIXME add power management support */</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">goku_pci_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
