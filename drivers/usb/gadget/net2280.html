<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › gadget › net2280.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>net2280.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for the PLX NET2280 USB device controller.</span>
<span class="cm"> * Specs and errata are available from &lt;http://www.plxtech.com&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * PLX Technology Inc. (formerly NetChip Technology) supported the</span>
<span class="cm"> * development of this driver.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * CODE STATUS HIGHLIGHTS</span>
<span class="cm"> *</span>
<span class="cm"> * This driver should work well with most &quot;gadget&quot; drivers, including</span>
<span class="cm"> * the File Storage, Serial, and Ethernet/RNDIS gadget drivers</span>
<span class="cm"> * as well as Gadget Zero and Gadgetfs.</span>
<span class="cm"> *</span>
<span class="cm"> * DMA is enabled by default.  Drivers using transfer queues might use</span>
<span class="cm"> * DMA chaining to remove IRQ latencies between transfers.  (Except when</span>
<span class="cm"> * short OUT transfers happen.)  Drivers can use the req-&gt;no_interrupt</span>
<span class="cm"> * hint to completely eliminate some IRQs, if a later IRQ is guaranteed</span>
<span class="cm"> * and DMA chaining is enabled.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that almost all the errata workarounds here are only needed for</span>
<span class="cm"> * rev1 chips.  Rev1a silicon (0110) fixes almost all of them.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2003 David Brownell</span>
<span class="cm"> * Copyright (C) 2003-2005 PLX Technology, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Modified Seth Levy 2005 PLX Technology, Inc. to provide compatibility</span>
<span class="cm"> *	with 2282 chip</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#undef	DEBUG		</span><span class="cm">/* messages on error and most fault paths */</span><span class="cp"></span>
<span class="cp">#undef	VERBOSE		</span><span class="cm">/* extra debug messages (success too) */</span><span class="cp"></span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>

<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>


<span class="cp">#define	DRIVER_DESC		&quot;PLX NET228x USB Peripheral Controller&quot;</span>
<span class="cp">#define	DRIVER_VERSION		&quot;2005 Sept 27&quot;</span>

<span class="cp">#define	DMA_ADDR_INVALID	(~(dma_addr_t)0)</span>
<span class="cp">#define	EP_DONTUSE		13	</span><span class="cm">/* nonzero */</span><span class="cp"></span>

<span class="cp">#define USE_RDK_LEDS		</span><span class="cm">/* GPIO pins control three LEDs */</span><span class="cp"></span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_name</span> <span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;net2280&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_desc</span> <span class="p">[]</span> <span class="o">=</span> <span class="n">DRIVER_DESC</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ep0name</span> <span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;ep0&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">ep_name</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ep0name</span><span class="p">,</span>
	<span class="s">&quot;ep-a&quot;</span><span class="p">,</span> <span class="s">&quot;ep-b&quot;</span><span class="p">,</span> <span class="s">&quot;ep-c&quot;</span><span class="p">,</span> <span class="s">&quot;ep-d&quot;</span><span class="p">,</span>
	<span class="s">&quot;ep-e&quot;</span><span class="p">,</span> <span class="s">&quot;ep-f&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* use_dma -- general goodness, fewer interrupts, less cpu load (vs PIO)</span>
<span class="cm"> * use_dma_chaining -- dma descriptor queueing gives even more irq reduction</span>
<span class="cm"> *</span>
<span class="cm"> * The net2280 DMA engines are not tightly integrated with their FIFOs;</span>
<span class="cm"> * not all cases are (yet) handled well in this driver or the silicon.</span>
<span class="cm"> * Some gadget drivers work better with the dma support here than others.</span>
<span class="cm"> * These two parameters let you use PIO or more aggressive DMA.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">use_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">use_dma_chaining</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* &quot;modprobe net2280 use_dma=n&quot; etc */</span>
<span class="n">module_param</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param</span> <span class="p">(</span><span class="n">use_dma_chaining</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>


<span class="cm">/* mode 0 == ep-{a,b,c,d} 1K fifo each</span>
<span class="cm"> * mode 1 == ep-{a,b} 2K fifo each, ep-{c,d} unavailable</span>
<span class="cm"> * mode 2 == ep-a 2K fifo, ep-{b,c} 1K each, ep-d unavailable</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">ushort</span> <span class="n">fifo_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* &quot;modprobe net2280 fifo_mode=1&quot; etc */</span>
<span class="n">module_param</span> <span class="p">(</span><span class="n">fifo_mode</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cm">/* enable_suspend -- When enabled, the driver will respond to</span>
<span class="cm"> * USB suspend requests by powering down the NET2280.  Otherwise,</span>
<span class="cm"> * USB suspend requests will be ignored.  This is acceptable for</span>
<span class="cm"> * self-powered devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable_suspend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* &quot;modprobe net2280 enable_suspend=1&quot; etc */</span>
<span class="n">module_param</span> <span class="p">(</span><span class="n">enable_suspend</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>


<span class="cp">#define	DIR_STRING(bAddress) (((bAddress) &amp; USB_DIR_IN) ? &quot;in&quot; : &quot;out&quot;)</span>

<span class="cp">#if defined(CONFIG_USB_GADGET_DEBUG_FILES) || defined (DEBUG)</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">type_string</span> <span class="p">(</span><span class="n">u8</span> <span class="n">bmAttributes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">bmAttributes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_XFERTYPE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>:	<span class="k">return</span> <span class="s">&quot;bulk&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>:	<span class="k">return</span> <span class="s">&quot;iso&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:	<span class="k">return</span> <span class="s">&quot;intr&quot;</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="s">&quot;control&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;net2280.h&quot;</span>

<span class="cp">#define valid_bit	cpu_to_le32 (1 &lt;&lt; VALID_BIT)</span>
<span class="cp">#define dma_done_ie	cpu_to_le32 (1 &lt;&lt; DMA_DONE_INTERRUPT_ENABLE)</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2280_enable</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">max</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">||</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span>
			<span class="o">||</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">!=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="cm">/* erratum 0119 workaround ties up an endpoint number */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">EP_DONTUSE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EDOM</span><span class="p">;</span>

	<span class="cm">/* sanity check ep-e/ep-f since their fifos are small */</span>
	<span class="n">max</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span> <span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">max</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">_ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">max</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>

	<span class="cm">/* ep_reset() has already been called */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">wedged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">out_overflow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set speed-dependent max packet; may kick in high bandwidth */</span>
	<span class="n">set_idx_reg</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG_EP_MAXPKT</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">),</span> <span class="n">max</span><span class="p">);</span>

	<span class="cm">/* FIFO lines can&#39;t go to different packets.  PIO is ok, so</span>
<span class="cm">	 * use it instead of troublesome (non-bulk) multi-packet DMA.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">max</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">use_dma_chaining</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s, no dma for maxpacket %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set type, direction, address; reset fifo counters */</span>
	<span class="n">writel</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FIFO_FLUSH</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_stat</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_XFERTYPE_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* erratum 0105 workaround prevents hs NYET */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chiprev</span> <span class="o">==</span> <span class="mo">0100</span>
				<span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">))</span>
			<span class="n">writel</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_NAK_OUT_PACKETS_MODE</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_rsp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* catch some particularly blatant driver bugs */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span>
					<span class="o">&amp;&amp;</span> <span class="n">max</span> <span class="o">!=</span> <span class="mi">512</span><span class="p">)</span>
				<span class="o">||</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span>
					<span class="o">&amp;&amp;</span> <span class="n">max</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_iso</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">&lt;&lt;=</span> <span class="n">ENDPOINT_TYPE</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="n">ENDPOINT_BYTE_COUNT</span><span class="p">);</span>	<span class="cm">/* default full fifo lines */</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ENDPOINT_ENABLE</span><span class="p">;</span>
	<span class="n">wmb</span> <span class="p">();</span>

	<span class="cm">/* for OUT transfers, block the rx fifo until a read is posted */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
		<span class="n">writel</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SET_NAK_OUT_PACKETS</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_rsp</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="mh">0x2280</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Added for 2282, Don&#39;t use nak packets on an in endpoint,</span>
<span class="cm">		 * this was ignored on 2280</span>
<span class="cm">		 */</span>
		<span class="n">writel</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_NAK_OUT_PACKETS</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_NAK_OUT_PACKETS_MODE</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_rsp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_cfg</span><span class="p">);</span>

	<span class="cm">/* enable irqs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>				<span class="cm">/* pio, per-packet */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span> <span class="o">|</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb0</span><span class="p">);</span>
		<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb0</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_RECEIVED_INTERRUPT_ENABLE</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_TRANSMITTED_INTERRUPT_ENABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x2280</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqenb</span><span class="p">);</span>
		<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqenb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>				<span class="cm">/* dma, per-request */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">));</span>	<span class="cm">/* completion */</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb1</span><span class="p">);</span>
		<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb1</span><span class="p">);</span>

		<span class="cm">/* for short OUT transfers, dma completions can&#39;t</span>
<span class="cm">		 * advance the queue; do it pio-style, by hand.</span>
<span class="cm">		 * NOTE erratum 0112 workaround #2</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SHORT_PACKET_TRANSFERRED_INTERRUPT_ENABLE</span><span class="p">);</span>
			<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqenb</span><span class="p">);</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span> <span class="o">|</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb0</span><span class="p">);</span>
			<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">;</span>
	<span class="n">DEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;enabled %s (ep%d%s-%s) %s max %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">DIR_STRING</span> <span class="p">(</span><span class="n">tmp</span><span class="p">),</span>
		<span class="n">type_string</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span><span class="p">),</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">?</span> <span class="s">&quot;dma&quot;</span> <span class="o">:</span> <span class="s">&quot;pio&quot;</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>

	<span class="cm">/* pci writes may still be posted */</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">handshake</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">done</span><span class="p">,</span> <span class="kt">int</span> <span class="n">usec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">result</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">~</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span>		<span class="cm">/* &quot;device unplugged&quot; */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">done</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udelay</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">usec</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">usec</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">net2280_ep_ops</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep_reset</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>		<span class="n">tmp</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">net2280_ep_ops</span><span class="p">;</span>

	<span class="cm">/* disable the dma, irqs, endpoint... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmactl</span><span class="p">);</span>
		<span class="n">writel</span> <span class="p">(</span>  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_SCATTER_GATHER_DONE_INTERRUPT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_TRANSACTION_DONE_INTERRUPT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_ABORT</span><span class="p">)</span>
			<span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmastat</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb0</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb1</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">));</span>	<span class="cm">/* completion */</span>
		<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">writel</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqenb</span><span class="p">);</span>

	<span class="cm">/* init to our chosen defaults, notably so that we NAK OUT</span>
<span class="cm">	 * packets until the driver queues a read (+note erratum 0112)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x2280</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SET_NAK_OUT_PACKETS_MODE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SET_NAK_OUT_PACKETS</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_EP_HIDE_STATUS_PHASE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_INTERRUPT_MODE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* added for 2282 */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_NAK_OUT_PACKETS_MODE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_NAK_OUT_PACKETS</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_EP_HIDE_STATUS_PHASE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_INTERRUPT_MODE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_ENDPOINT_TOGGLE</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_ENDPOINT_HALT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_rsp</span><span class="p">);</span>

	<span class="cm">/* scrub most status bits, and flush any fifo state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x2280</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FIFO_OVERFLOW</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FIFO_UNDERFLOW</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TIMEOUT</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_STALL_SENT</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_IN_NAK_SENT</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_IN_ACK_RCVD</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_OUT_PING_NAK_SENT</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_OUT_ACK_SENT</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FIFO_FLUSH</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SHORT_PACKET_OUT_DONE_INTERRUPT</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SHORT_PACKET_TRANSFERRED_INTERRUPT</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_RECEIVED_INTERRUPT</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_TRANSMITTED_INTERRUPT</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_OUT_PING_TOKEN_INTERRUPT</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_IN_TOKEN_INTERRUPT</span><span class="p">)</span>
		<span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_stat</span><span class="p">);</span>

	<span class="cm">/* fifo size is handled separately */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">nuke</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">net2280_disable</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">||</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nuke</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">ep_reset</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="n">VDEBUG</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disabled %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">?</span> <span class="s">&quot;dma&quot;</span> <span class="o">:</span> <span class="s">&quot;pio&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* synch memory views with the device */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_cfg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span>
<span class="nf">net2280_alloc_request</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net2280_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="cm">/* this dma descriptor may be swapped with the previous dummy */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net2280_dma</span>	<span class="o">*</span><span class="n">td</span><span class="p">;</span>

		<span class="n">td</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">td</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span> <span class="p">(</span><span class="n">req</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">dmacount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* not VALID */</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">dmaaddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span> <span class="p">(</span><span class="n">DMA_ADDR_INVALID</span><span class="p">);</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">dmadesc</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">dmaaddr</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2280_free_request</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net2280_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">WARN_ON</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="p">)</span>
		<span class="n">pci_pool_free</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_dma</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* load a packet into the fifo we use for usb IN transfers.</span>
<span class="cm"> * works for all endpoints.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: pio with ep-a..ep-d could stuff multiple packets into the fifo</span>
<span class="cm"> * at a time, but this code is simpler because it knows it only writes</span>
<span class="cm"> * one packet.  ep-a..ep-d should use dma instead.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">write_fifo</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_ep_regs</span>	<span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">count</span><span class="p">,</span> <span class="n">total</span><span class="p">;</span>

	<span class="cm">/* INVARIANT:  fifo is currently empty. (testable) */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">;</span>
		<span class="n">prefetch</span> <span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">total</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* write just one packet at a time */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">total</span><span class="p">)</span>	<span class="cm">/* min() cannot be used on a bitfield */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>

	<span class="n">VDEBUG</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;write %s fifo (IN) %d bytes%s req %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
			<span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; (short)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* NOTE be careful if you try to align these. fifo lines</span>
<span class="cm">		 * should normally be full (4 bytes) and successive partial</span>
<span class="cm">		 * lines are ok only in certain cases.</span>
<span class="cm">		 */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">get_unaligned</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">cpu_to_le32s</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_data</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* last fifo entry is &quot;short&quot; unless we wrote a full packet.</span>
<span class="cm">	 * also explicitly validate last word in (periodic) transfers</span>
<span class="cm">	 * when maxpacket is not a multiple of 4 bytes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">||</span> <span class="n">total</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">count</span> <span class="o">?</span> <span class="n">get_unaligned</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">)</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">cpu_to_le32s</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">set_fifo_bytecount</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* pci writes may still be posted */</span>
<span class="p">}</span>

<span class="cm">/* work around erratum 0106: PCI and USB race over the OUT fifo.</span>
<span class="cm"> * caller guarantees chiprev 0100, out endpoint is NAKing, and</span>
<span class="cm"> * there&#39;s no real data in the fifo.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:  also used in cases where that erratum doesn&#39;t apply:</span>
<span class="cm"> * where the host wrote &quot;too much&quot; data to us.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">out_flush</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">__iomem</span> <span class="o">*</span><span class="n">statp</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">tmp</span><span class="p">;</span>

	<span class="n">ASSERT_OUT_NAKING</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>

	<span class="n">statp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_stat</span><span class="p">;</span>
	<span class="n">writel</span> <span class="p">(</span>  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_OUT_PING_TOKEN_INTERRUPT</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_RECEIVED_INTERRUPT</span><span class="p">)</span>
		<span class="p">,</span> <span class="n">statp</span><span class="p">);</span>
	<span class="n">writel</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FIFO_FLUSH</span><span class="p">),</span> <span class="n">statp</span><span class="p">);</span>
	<span class="n">mb</span> <span class="p">();</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="n">statp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_OUT_PING_TOKEN_INTERRUPT</span><span class="p">)</span>
			<span class="cm">/* high speed did bulk NYET; fifo isn&#39;t filling */</span>
			<span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span>	<span class="n">usec</span><span class="p">;</span>

		<span class="n">usec</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>		<span class="cm">/* 64 byte bulk/interrupt */</span>
		<span class="n">handshake</span> <span class="p">(</span><span class="n">statp</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_OUT_PING_NAK_SENT</span><span class="p">),</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_OUT_PING_NAK_SENT</span><span class="p">),</span> <span class="n">usec</span><span class="p">);</span>
		<span class="cm">/* NAK done; now CLEAR_NAK_OUT_PACKETS is safe */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* unload packet(s) from the fifo we use for usb OUT transfers.</span>
<span class="cm"> * returns true iff the request completed, because of short packet</span>
<span class="cm"> * or the request buffer having filled with full packets.</span>
<span class="cm"> *</span>
<span class="cm"> * for ep-a..ep-d this will read multiple packets out when they</span>
<span class="cm"> * have been accepted.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">read_fifo</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_ep_regs</span>	<span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">count</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">is_short</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">cleanup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prevent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* erratum 0106 ... packets coming in during fifo reads might</span>
<span class="cm">	 * be incompletely rejected.  not all cases have workarounds.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chiprev</span> <span class="o">==</span> <span class="mh">0x0100</span>
			<span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_stat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NAK_OUT_PACKETS</span><span class="p">)))</span>
			<span class="n">cleanup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FIFO_FULL</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">start_out_naking</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="n">prevent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* else: hope we don&#39;t see the problem */</span>
	<span class="p">}</span>

	<span class="cm">/* never overflow the rx buffer. the fifo reads packets until</span>
<span class="cm">	 * it sees a short one; we might not be ready for them all.</span>
<span class="cm">	 */</span>
	<span class="n">prefetchw</span> <span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_avail</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_stat</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_avail</span><span class="p">);</span>
		<span class="cm">/* handled that data already? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NAK_OUT_PACKETS</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* as with DMA, data overflow gets flushed */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERROR</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s out fifo %d bytes, expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
			<span class="n">cleanup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* NAK_OUT_PACKETS will be set, so flushing is safe;</span>
<span class="cm">			 * the next read will start with the next packet</span>
<span class="cm">			 */</span>
		<span class="p">}</span> <span class="cm">/* else it&#39;s a ZLP, no worries */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">is_short</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">count</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">VDEBUG</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;read %s fifo (OUT) %d bytes%s%s%s req %p %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">is_short</span> <span class="o">?</span> <span class="s">&quot; (short)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">cleanup</span> <span class="o">?</span> <span class="s">&quot; flush&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">prevent</span> <span class="o">?</span> <span class="s">&quot; nak&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_data</span><span class="p">);</span>
		<span class="n">cpu_to_le32s</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">put_unaligned</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_data</span><span class="p">);</span>
		<span class="cm">/* LE conversion is implicit here: */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cleanup</span><span class="p">)</span>
		<span class="n">out_flush</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prevent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_NAK_OUT_PACKETS</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_rsp</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_rsp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">is_short</span> <span class="o">||</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* fill out dma descriptor to match a given request */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fill_dma_desc</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">valid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_dma</span>	<span class="o">*</span><span class="n">td</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">dmacount</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>

	<span class="cm">/* don&#39;t let DMA continue after a short OUT packet,</span>
<span class="cm">	 * so overruns can&#39;t affect the next transfer.</span>
<span class="cm">	 * in case of overruns on max-size packets, we can&#39;t</span>
<span class="cm">	 * stop the fifo from filling but we can flush it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
		<span class="n">dmacount</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_DIRECTION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dmacount</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="mh">0x2280</span><span class="p">)</span>
		<span class="n">dmacount</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">END_OF_CHAIN</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="n">valid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">valid</span><span class="p">)</span>
		<span class="n">dmacount</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VALID_BIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">no_interrupt</span> <span class="o">||</span> <span class="o">!</span><span class="n">use_dma_chaining</span><span class="p">))</span>
		<span class="n">dmacount</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_DONE_INTERRUPT_ENABLE</span><span class="p">);</span>

	<span class="cm">/* td-&gt;dmadesc = previously set by caller */</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">dmaaddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>

	<span class="cm">/* 2280 may be polling VALID_BIT through ep-&gt;dma-&gt;dmadesc */</span>
	<span class="n">wmb</span> <span class="p">();</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">dmacount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dmacount</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">dmactl_default</span> <span class="o">=</span>
		  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_SCATTER_GATHER_DONE_INTERRUPT</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CLEAR_COUNT_ENABLE</span><span class="p">)</span>
		<span class="cm">/* erratum 0116 workaround part 1 (use POLLING) */</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">POLL_100_USEC</span> <span class="o">&lt;&lt;</span> <span class="n">DESCRIPTOR_POLLING_RATE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_VALID_BIT_POLLING_ENABLE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_VALID_BIT_ENABLE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_SCATTER_GATHER_ENABLE</span><span class="p">)</span>
		<span class="cm">/* erratum 0116 workaround part 2 (no AUTOSTART) */</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_ENABLE</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">spin_stop_dma</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_dma_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">handshake</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmactl</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_ENABLE</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">stop_dma</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_dma_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span> <span class="p">(</span><span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmactl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_ENABLE</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmactl</span><span class="p">);</span>
	<span class="n">spin_stop_dma</span> <span class="p">(</span><span class="n">dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_queue</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dmactl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">td_dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_dma_regs</span>	<span class="n">__iomem</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VALID_BIT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_DIRECTION</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="mh">0x2280</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">END_OF_CHAIN</span><span class="p">);</span>

	<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmacount</span><span class="p">);</span>
	<span class="n">writel</span> <span class="p">(</span><span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmastat</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmastat</span><span class="p">);</span>

	<span class="n">writel</span> <span class="p">(</span><span class="n">td_dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmadesc</span><span class="p">);</span>
	<span class="n">writel</span> <span class="p">(</span><span class="n">dmactl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmactl</span><span class="p">);</span>

	<span class="cm">/* erratum 0116 workaround part 3:  pci arbiter away from net2280 */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">pcimstctl</span><span class="p">);</span>

	<span class="n">writel</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_START</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmastat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
		<span class="n">stop_out_naking</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_dma</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>			<span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net2280_dma_regs</span>	<span class="n">__iomem</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>

	<span class="cm">/* FIXME can&#39;t use DMA for ZLPs */</span>

	<span class="cm">/* on this path we &quot;know&quot; there&#39;s no dma active (yet) */</span>
	<span class="n">WARN_ON</span> <span class="p">(</span><span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmactl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_ENABLE</span><span class="p">));</span>
	<span class="n">writel</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmactl</span><span class="p">);</span>

	<span class="cm">/* previous OUT packet might have been short */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_stat</span><span class="p">))</span>
				<span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NAK_OUT_PACKETS</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SHORT_PACKET_TRANSFERRED_INTERRUPT</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_stat</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_avail</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span> <span class="p">(</span><span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmastat</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmastat</span><span class="p">);</span>

			<span class="cm">/* transfer all/some fifo data */</span>
			<span class="n">writel</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmaaddr</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">min</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

			<span class="cm">/* dma irq, faking scatterlist status */</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmacount</span> <span class="o">=</span> <span class="n">cpu_to_le32</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">writel</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_DONE_INTERRUPT_ENABLE</span><span class="p">)</span>
				<span class="o">|</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmacount</span><span class="p">);</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmadesc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">writel</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_ENABLE</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmactl</span><span class="p">);</span>
			<span class="n">writel</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_START</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmastat</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">dmactl_default</span><span class="p">;</span>

	<span class="cm">/* force packet boundaries between dma requests, but prevent the</span>
<span class="cm">	 * controller from automagically writing a last &quot;short&quot; packet</span>
<span class="cm">	 * (zero length) unless the driver explicitly said to do that.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
				<span class="o">||</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_FIFO_VALIDATE</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">in_fifo_validate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">in_fifo_validate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* init req-&gt;td, pointing to the current dummy */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmadesc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_dma</span><span class="p">);</span>
	<span class="n">fill_dma_desc</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma_chaining</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmacount</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">END_OF_CHAIN</span><span class="p">);</span>

	<span class="n">start_queue</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">queue_dma</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">valid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_dma</span>	<span class="o">*</span><span class="n">end</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* swap new dummy for old, link; fill and maybe activate */</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dummy</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dummy</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_dma</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_dma</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_dma</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">td_dma</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">end</span><span class="o">-&gt;</span><span class="n">dmadesc</span> <span class="o">=</span> <span class="n">cpu_to_le32</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_dma</span><span class="p">);</span>

	<span class="n">fill_dma_desc</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">valid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">done</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">stopped</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">;</span>

	<span class="n">list_del_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
		<span class="n">usb_gadget_unmap_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span>
		<span class="n">VDEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;complete %s req %p stat %d len %u/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="cm">/* don&#39;t modify queue heads during completion callback */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="n">spin_lock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="n">stopped</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2280_queue</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net2280</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* we always require a cpu-view buffer, so that we can</span>
<span class="cm">	 * always use pio (as fallback or whatever).</span>
<span class="cm">	 */</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_request</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_req</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="o">-&gt;</span><span class="n">buf</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">~</span><span class="mi">0</span> <span class="o">&amp;</span> <span class="n">DMA_BYTE_COUNT_MASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EDOM</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="cm">/* FIXME implement PIO fallback for ZLPs with DMA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&amp;&amp;</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="cm">/* set up dma mapping in case the caller didn&#39;t */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_gadget_map_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="n">_req</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	VDEBUG (dev, &quot;%s queue req %p, len %d buf %p\n&quot;,</span>
<span class="c">			_ep-&gt;name, _req, _req-&gt;length, _req-&gt;buf);</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">_req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">_req</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* kickstart this i/o queue? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* use DMA if the endpoint supports it, else pio */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
			<span class="n">start_dma</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* maybe there&#39;s no control data, just status ack */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">_req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">allow_status</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="n">done</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">VDEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s status ack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* PIO ... stuff the fifo, or unblock it.  */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
				<span class="n">write_fifo</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">_req</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u32</span>	<span class="n">s</span><span class="p">;</span>

				<span class="cm">/* OUT FIFO might have packet(s) buffered */</span>
				<span class="n">s</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_stat</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FIFO_EMPTY</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* note:  _req-&gt;short_not_ok is</span>
<span class="cm">					 * ignored here since PIO _always_</span>
<span class="cm">					 * stops queue advance here, and</span>
<span class="cm">					 * _req-&gt;status doesn&#39;t change for</span>
<span class="cm">					 * short reads (only _req-&gt;actual)</span>
<span class="cm">					 */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">read_fifo</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">done</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
							<span class="n">allow_status</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
						<span class="cm">/* don&#39;t queue it */</span>
						<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">s</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_stat</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="cm">/* don&#39;t NAK, let the fifo fill */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NAK_OUT_PACKETS</span><span class="p">)))</span>
					<span class="n">writel</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_NAK_OUT_PACKETS</span><span class="p">),</span>
							<span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_rsp</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span>	<span class="n">expect</span><span class="p">;</span>

			<span class="cm">/* preventing magic zlps is per-engine state, not</span>
<span class="cm">			 * per-transfer; irq logic must recover hiccups.</span>
<span class="cm">			 */</span>
			<span class="n">expect</span> <span class="o">=</span> <span class="n">likely</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span>
				<span class="o">||</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">expect</span> <span class="o">!=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">in_fifo_validate</span><span class="p">)</span>
				<span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">queue_dma</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">valid</span><span class="p">);</span>

	<span class="p">}</span> <span class="cm">/* else the irq handler advances the queue. */</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">responded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span>
		<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* pci writes may still be posted */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">dma_done</span> <span class="p">(</span>
	<span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">net2280_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">dmacount</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">status</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="p">(</span><span class="n">DMA_BYTE_COUNT_MASK</span> <span class="o">&amp;</span> <span class="n">dmacount</span><span class="p">);</span>
	<span class="n">done</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">restart_dma</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scan_dma_completions</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* only look at descriptors that were &quot;naturally&quot; retired,</span>
<span class="cm">	 * so fifo and list head state won&#39;t matter</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net2280_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
		<span class="n">u32</span>			<span class="n">tmp</span><span class="p">;</span>

		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net2280_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rmb</span> <span class="p">();</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">le32_to_cpup</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmacount</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VALID_BIT</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* SHORT_PACKET_TRANSFERRED_INTERRUPT handles &quot;usb-short&quot;</span>
<span class="cm">		 * cases where DMA must be aborted; this code handles</span>
<span class="cm">		 * all non-abort DMA completions.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmadesc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* paranoia */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmacount</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">DMA_BYTE_COUNT_MASK</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* single transfer mode */</span>
			<span class="n">dma_done</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_stat</span><span class="p">);</span>

			<span class="cm">/* AVOID TROUBLE HERE by not issuing short reads from</span>
<span class="cm">			 * your gadget driver.  That helps avoids errata 0121,</span>
<span class="cm">			 * 0122, and 0124; not all cases trigger the warning.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NAK_OUT_PACKETS</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARNING</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s lost packet sync!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_avail</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* fifo gets flushed later */</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">out_overflow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">DEBUG</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s dma, discard %d len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
						<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">dma_done</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">restart_dma</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">dmactl</span> <span class="o">=</span> <span class="n">dmactl_default</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma_chaining</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start_dma</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the 2280 will be processing the queue unless queue hiccups after</span>
<span class="cm">	 * the previous transfer:</span>
<span class="cm">	 *  IN:   wanted automagic zlp, head doesn&#39;t (or vice versa)</span>
<span class="cm">	 *        DMA_FIFO_VALIDATE doesn&#39;t init from dma descriptors.</span>
<span class="cm">	 *  OUT:  was &quot;usb-short&quot;, we must restart.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net2280_request</span>	<span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">int</span>			<span class="n">reqmode</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">DEBUG</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s dma hiccup td %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">in_fifo_validate</span> <span class="o">=</span> <span class="n">likely</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">in_fifo_validate</span><span class="p">)</span>
			<span class="n">dmactl</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_FIFO_VALIDATE</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__le32</span>		<span class="n">dmacount</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="n">req</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">dmacount</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmacount</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reqmode</span> <span class="o">=</span> <span class="n">likely</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span>
					<span class="o">||</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span>
						<span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">reqmode</span> <span class="o">==</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">in_fifo_validate</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">entry</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">dmacount</span> <span class="o">|=</span> <span class="n">valid_bit</span><span class="p">;</span>
					<span class="n">entry</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmacount</span> <span class="o">=</span> <span class="n">dmacount</span><span class="p">;</span>
					<span class="n">prev</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* force a hiccup */</span>
					<span class="n">prev</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmacount</span> <span class="o">|=</span> <span class="n">dma_done_ie</span><span class="p">;</span>
					<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* walk the rest of the queue so unlinks behave */</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dmacount</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">valid_bit</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmacount</span> <span class="o">=</span> <span class="n">dmacount</span><span class="p">;</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">writel</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmactl</span><span class="p">);</span>
	<span class="n">start_queue</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">dmactl</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">abort_dma</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* abort the current transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* FIXME work around errata 0121, 0122, 0124 */</span>
		<span class="n">writel</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_ABORT</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmastat</span><span class="p">);</span>
		<span class="n">spin_stop_dma</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">stop_dma</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">scan_dma_completions</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* dequeue ALL requests */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nuke</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="cm">/* called with spinlock held */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
		<span class="n">abort_dma</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net2280_request</span><span class="p">,</span>
				<span class="n">queue</span><span class="p">);</span>
		<span class="n">done</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* dequeue JUST ONE request */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">net2280_dequeue</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net2280_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">dmactl</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">stopped</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">stopped</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">;</span>

	<span class="cm">/* quiesce dma while we patch the queue */</span>
	<span class="n">dmactl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmactl</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmactl</span><span class="p">);</span>
		<span class="cm">/* WARNING erratum 0127 may kick in ... */</span>
		<span class="n">stop_dma</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">scan_dma_completions</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* make sure it&#39;s still queued on this endpoint */</span>
	<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">==</span> <span class="n">_req</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">!=</span> <span class="n">_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* queue head may be partially complete. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unlink (%s) dma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">_req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
			<span class="n">abort_dma</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>NOTE: misreports single-transfer mode</p></td><td class="code"><div class="highlight"><pre>				<span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmacount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* invalidate */</span>
				<span class="n">dma_done</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
					<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmacount</span><span class="p">),</span>
					<span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DEBUG</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unlink (%s) pio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">done</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* patch up hardware chaining data */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&amp;&amp;</span> <span class="n">use_dma_chaining</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">prev</span> <span class="o">==</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span> <span class="p">(</span><span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmadesc</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmadesc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmacount</span> <span class="o">&amp;</span> <span class="n">dma_done_ie</span><span class="p">)</span>
				<span class="n">writel</span> <span class="p">(</span><span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmacount</span><span class="p">)</span>
						<span class="o">|</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dma_done_ie</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmacount</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">net2280_request</span>	<span class="o">*</span><span class="n">prev</span><span class="p">;</span>

			<span class="n">prev</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net2280_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
			<span class="n">prev</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmadesc</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmadesc</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmacount</span> <span class="o">&amp;</span> <span class="n">dma_done_ie</span><span class="p">)</span>
				<span class="n">prev</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmacount</span> <span class="o">|=</span> <span class="n">dma_done_ie</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span>
		<span class="n">done</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="n">stopped</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* turn off dma on inactive queues */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
			<span class="n">stop_dma</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* resume current request, or start new one */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span>
				<span class="n">writel</span> <span class="p">(</span><span class="n">dmactl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmactl</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">start_dma</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net2280_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">net2280_fifo_status</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2280_set_halt_and_wedge</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wedged</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="cm">/* not ep0 */</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span>
						<span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="n">net2280_fifo_status</span> <span class="p">(</span><span class="n">_ep</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">VDEBUG</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">value</span> <span class="o">?</span> <span class="s">&quot;set&quot;</span> <span class="o">:</span> <span class="s">&quot;clear&quot;</span><span class="p">,</span>
				<span class="n">wedged</span> <span class="o">?</span> <span class="s">&quot;wedge&quot;</span> <span class="o">:</span> <span class="s">&quot;halt&quot;</span><span class="p">);</span>
		<span class="cm">/* set/clear, then synch memory views with the device */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">protocol_stall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">set_halt</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wedged</span><span class="p">)</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">wedged</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">clear_halt</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">wedged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_rsp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2280_set_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">net2280_set_halt_and_wedge</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2280_set_wedge</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="n">_ep</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">net2280_set_halt_and_wedge</span><span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net2280_fifo_status</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">avail</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="n">avail</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_avail</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avail</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
		<span class="n">avail</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">-</span> <span class="n">avail</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">avail</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net2280_fifo_flush</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ep</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">writel</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FIFO_FLUSH</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_stat</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_rsp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">net2280_ep_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">net2280_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">net2280_disable</span><span class="p">,</span>

	<span class="p">.</span><span class="n">alloc_request</span>	<span class="o">=</span> <span class="n">net2280_alloc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_request</span>	<span class="o">=</span> <span class="n">net2280_free_request</span><span class="p">,</span>

	<span class="p">.</span><span class="n">queue</span>		<span class="o">=</span> <span class="n">net2280_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue</span>	<span class="o">=</span> <span class="n">net2280_dequeue</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_halt</span>	<span class="o">=</span> <span class="n">net2280_set_halt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wedge</span>	<span class="o">=</span> <span class="n">net2280_set_wedge</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_status</span>	<span class="o">=</span> <span class="n">net2280_fifo_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_flush</span>	<span class="o">=</span> <span class="n">net2280_fifo_flush</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">net2280_get_frame</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_gadget</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">get_idx_reg</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG_FRAME</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03ff</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">net2280_wakeup</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_gadget</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">usbctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DEVICE_REMOTE_WAKEUP_ENABLE</span><span class="p">))</span>
		<span class="n">writel</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">GENERATE_RESUME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">usbstat</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* pci writes may still be posted */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">net2280_set_selfpowered</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_gadget</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">usbctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SELF_POWERED_STATUS</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SELF_POWERED_STATUS</span><span class="p">);</span>
	<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">usbctl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">net2280_pullup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280</span>  <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span>             <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_gadget</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">usbctl</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">softconnect</span> <span class="o">=</span> <span class="p">(</span><span class="n">is_on</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_on</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DETECT_ENABLE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DETECT_ENABLE</span><span class="p">);</span>
	<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">usbctl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">net2280_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">net2280_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_gadget_ops</span> <span class="n">net2280_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_frame</span>	<span class="o">=</span> <span class="n">net2280_get_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wakeup</span>		<span class="o">=</span> <span class="n">net2280_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_selfpowered</span> <span class="o">=</span> <span class="n">net2280_set_selfpowered</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pullup</span>		<span class="o">=</span> <span class="n">net2280_pullup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_start</span>	<span class="o">=</span> <span class="n">net2280_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_stop</span>	<span class="o">=</span> <span class="n">net2280_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#ifdef	CONFIG_USB_GADGET_DEBUG_FILES</span>

<span class="cm">/* FIXME move these into procfs, and use seq_file.</span>
<span class="cm"> * Sysfs _still_ doesn&#39;t behave for arbitrarily sized files,</span>
<span class="cm"> * and also doesn&#39;t help products using this with 2.4 kernels.</span>
<span class="cm"> */</span>

<span class="cm">/* &quot;function&quot; sysfs attribute */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_function</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span> <span class="p">(</span><span class="n">_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">function</span>
			<span class="o">||</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span> <span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_function</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">net2280_show_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">size</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span> <span class="p">(</span><span class="n">_dev</span><span class="p">);</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;(none)&quot;</span><span class="p">;</span>

	<span class="cm">/* Main Control Registers */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%s version &quot;</span> <span class="n">DRIVER_VERSION</span>
			<span class="s">&quot;, chiprev %04x, dma %s</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="s">&quot;devinit %03x fifoctl %08x gadget &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;pci irqenb0 %02x irqenb1 %08x &quot;</span>
			<span class="s">&quot;irqstat0 %04x irqstat1 %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">driver_name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">chiprev</span><span class="p">,</span>
			<span class="n">use_dma</span>
				<span class="o">?</span> <span class="p">(</span><span class="n">use_dma_chaining</span> <span class="o">?</span> <span class="s">&quot;chaining&quot;</span> <span class="o">:</span> <span class="s">&quot;enabled&quot;</span><span class="p">)</span>
				<span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span>
			<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">devinit</span><span class="p">),</span>
			<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">fifoctl</span><span class="p">),</span>
			<span class="n">s</span><span class="p">,</span>
			<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb0</span><span class="p">),</span>
			<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb1</span><span class="p">),</span>
			<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqstat0</span><span class="p">),</span>
			<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqstat1</span><span class="p">));</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

	<span class="cm">/* USB Control Registers */</span>
	<span class="n">t1</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">usbctl</span><span class="p">);</span>
	<span class="n">t2</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">usbstat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VBUS_PIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HIGH_SPEED</span><span class="p">))</span>
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;high speed&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;powered&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;full speed&quot;</span><span class="p">;</span>
		<span class="cm">/* full speed bit (6) not working?? */</span>
	<span class="p">}</span> <span class="k">else</span>
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;not attached&quot;</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			<span class="s">&quot;stdrsp %08x usbctl %08x usbstat %08x &quot;</span>
				<span class="s">&quot;addr 0x%02x (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">stdrsp</span><span class="p">),</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span>
			<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">ouraddr</span><span class="p">),</span> <span class="n">s</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

	<span class="cm">/* PCI Master Control Registers */</span>

	<span class="cm">/* DMA Control Registers */</span>

	<span class="cm">/* Configurable EP Control Registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>

		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">t1</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_cfg</span><span class="p">);</span>
		<span class="n">t2</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_rsp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\n</span><span class="s">%s</span><span class="se">\t</span><span class="s">cfg %05x rsp (%02x) %s%s%s%s%s%s%s%s&quot;</span>
					<span class="s">&quot;irqenb %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span>
				<span class="p">(</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_NAK_OUT_PACKETS</span><span class="p">))</span>
					<span class="o">?</span> <span class="s">&quot;NAK &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_EP_HIDE_STATUS_PHASE</span><span class="p">))</span>
					<span class="o">?</span> <span class="s">&quot;hide &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_EP_FORCE_CRC_ERROR</span><span class="p">))</span>
					<span class="o">?</span> <span class="s">&quot;CRC &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_INTERRUPT_MODE</span><span class="p">))</span>
					<span class="o">?</span> <span class="s">&quot;interrupt &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">CLEAR_CONTROL_STATUS_PHASE_HANDSHAKE</span><span class="p">))</span>
					<span class="o">?</span> <span class="s">&quot;status &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_NAK_OUT_PACKETS_MODE</span><span class="p">))</span>
					<span class="o">?</span> <span class="s">&quot;NAKmode &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_ENDPOINT_TOGGLE</span><span class="p">))</span>
					<span class="o">?</span> <span class="s">&quot;DATA1 &quot;</span> <span class="o">:</span> <span class="s">&quot;DATA0 &quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_ENDPOINT_HALT</span><span class="p">))</span>
					<span class="o">?</span> <span class="s">&quot;HALT &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_irqenb</span><span class="p">));</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

		<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\t</span><span class="s">stat %08x avail %04x &quot;</span>
				<span class="s">&quot;(ep%d%s-%s)%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_stat</span><span class="p">),</span>
				<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_avail</span><span class="p">),</span>
				<span class="n">t1</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">DIR_STRING</span> <span class="p">(</span><span class="n">t1</span><span class="p">),</span>
				<span class="n">type_string</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">?</span> <span class="s">&quot;*&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				<span class="s">&quot;  dma</span><span class="se">\t</span><span class="s">ctl %08x stat %08x count %08x</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;</span><span class="se">\t</span><span class="s">addr %08x desc %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmactl</span><span class="p">),</span>
				<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmastat</span><span class="p">),</span>
				<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmacount</span><span class="p">),</span>
				<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmaaddr</span><span class="p">),</span>
				<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmadesc</span><span class="p">));</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/* Indexed Registers */</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>none yet</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* Statistics */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">irqs:  &quot;</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>

		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot; %s/%lu&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">registers</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">net2280_show_registers</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_queues</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span> <span class="p">(</span><span class="n">_dev</span><span class="p">);</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net2280_ep</span>		<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">net2280_request</span>		<span class="o">*</span><span class="n">req</span><span class="p">;</span>
		<span class="kt">int</span>				<span class="n">t</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span>	<span class="o">*</span><span class="n">d</span><span class="p">;</span>

			<span class="n">d</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">;</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\n</span><span class="s">%s (ep%d%s-%s) max %04x %s fifo %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">,</span>
				<span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">,</span>
				<span class="p">({</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
				 <span class="k">switch</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
				 <span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>:
					<span class="n">val</span> <span class="o">=</span> <span class="s">&quot;bulk&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				 <span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:
					<span class="n">val</span> <span class="o">=</span> <span class="s">&quot;intr&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				 <span class="nl">default:</span>
					<span class="n">val</span> <span class="o">=</span> <span class="s">&quot;iso&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				 <span class="p">};</span> <span class="n">val</span><span class="p">;</span> <span class="p">}),</span>
				<span class="n">usb_endpoint_maxp</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">?</span> <span class="s">&quot;dma&quot;</span> <span class="o">:</span> <span class="s">&quot;pio&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_size</span>
				<span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="cm">/* ep0 should only have one transfer queued */</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;ep0 max 64 pio %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">(nothing queued)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
			<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_dma</span> <span class="o">==</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmadesc</span><span class="p">))</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					<span class="s">&quot;</span><span class="se">\t</span><span class="s">req %p len %d/%d &quot;</span>
					<span class="s">&quot;buf %p (dmacount %08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span>
					<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmacount</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					<span class="s">&quot;</span><span class="se">\t</span><span class="s">req %p len %d/%d buf %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
			<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">net2280_dma</span>	<span class="o">*</span><span class="n">td</span><span class="p">;</span>

				<span class="n">td</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="p">;</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">    td %08x &quot;</span>
					<span class="s">&quot; count %08x buf %08x desc %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_dma</span><span class="p">,</span>
					<span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmacount</span><span class="p">),</span>
					<span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmaaddr</span><span class="p">),</span>
					<span class="n">le32_to_cpu</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmadesc</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
				<span class="n">size</span> <span class="o">-=</span> <span class="n">t</span><span class="p">;</span>
				<span class="n">next</span> <span class="o">+=</span> <span class="n">t</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span> <span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_queues</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>


<span class="cp">#else</span>

<span class="cp">#define device_create_file(a,b)	(0)</span>
<span class="cp">#define device_remove_file(a,b)	do { } while (0)</span>

<span class="cp">#endif</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* another driver-specific mode might be a request type doing dma</span>
<span class="cm"> * to/from another device fifo instead of to/from memory.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_fifo_mode</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* keeping high bits preserves BAR2 */</span>
	<span class="n">writel</span> <span class="p">((</span><span class="mh">0xffff</span> <span class="o">&lt;&lt;</span> <span class="n">PCI_BASE2_RANGE</span><span class="p">)</span> <span class="o">|</span> <span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">fifoctl</span><span class="p">);</span>

	<span class="cm">/* always ep-{a,b,e,f} ... maybe not ep-c or ep-d */</span>
	<span class="n">INIT_LIST_HEAD</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
		<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* fifo sizes for ep0, ep-c, ep-d, ep-e, and ep-f never change */</span>
	<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
	<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* keeping it simple:</span>
<span class="cm"> * - one bus driver, initted first;</span>
<span class="cm"> * - one function driver, initted second</span>
<span class="cm"> *</span>
<span class="cm"> * most of the work to support multiple net2280 controllers would</span>
<span class="cm"> * be to associate this gadget driver (yes?) with all of them, or</span>
<span class="cm"> * perhaps to bind specific drivers to specific devices.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usb_reset</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">tmp</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">usbctl</span><span class="p">);</span>

	<span class="n">net2280_led_init</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* disable automatic responses, and irqs */</span>
	<span class="n">writel</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">stdrsp</span><span class="p">);</span>
	<span class="n">writel</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb0</span><span class="p">);</span>
	<span class="n">writel</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb1</span><span class="p">);</span>

	<span class="cm">/* clear old dma and irq state */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
			<span class="n">abort_dma</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">writel</span> <span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqstat0</span><span class="p">),</span>
	<span class="n">writel</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SUSPEND_REQUEST_INTERRUPT</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqstat1</span><span class="p">),</span>

	<span class="cm">/* reset, and enable pci */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">devinit</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PCI_ENABLE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FIFO_SOFT_RESET</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_SOFT_RESET</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">M8051_RESET</span><span class="p">);</span>
	<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">devinit</span><span class="p">);</span>

	<span class="cm">/* standard fifo and endpoint allocations */</span>
	<span class="n">set_fifo_mode</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">fifo_mode</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="n">fifo_mode</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usb_reinit</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">init_dma</span><span class="p">;</span>

	<span class="cm">/* use_dma changes are ignored till next device re-init */</span>
	<span class="n">init_dma</span> <span class="o">=</span> <span class="n">use_dma</span><span class="p">;</span>

	<span class="cm">/* basic endpoint init */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">tmp</span><span class="p">];</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ep_name</span> <span class="p">[</span><span class="n">tmp</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">init_dma</span><span class="p">)</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="p">[</span><span class="n">tmp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">epregs</span> <span class="p">[</span><span class="n">tmp</span><span class="p">];</span>
		<span class="n">ep_reset</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="cm">/* we want to prevent lowlevel/insecure access from the USB host,</span>
<span class="cm">	 * but erratum 0119 means this enable bit is ignored</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel</span> <span class="p">(</span><span class="n">EP_DONTUSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dep</span> <span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">dep_cfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep0_start</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span> <span class="p">(</span>  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_EP_HIDE_STATUS_PHASE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_NAK_OUT_PACKETS</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CLEAR_CONTROL_STATUS_PHASE_HANDSHAKE</span><span class="p">)</span>
		<span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">epregs</span> <span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep_rsp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * hardware optionally handles a bunch of standard requests</span>
<span class="cm">	 * that the API hides from drivers anyway.  have it do so.</span>
<span class="cm">	 * endpoint status/features are handled in software, to</span>
<span class="cm">	 * help pass tests for some dubious behavior.</span>
<span class="cm">	 */</span>
	<span class="n">writel</span> <span class="p">(</span>  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SET_TEST_MODE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SET_ADDRESS</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DEVICE_SET_CLEAR_DEVICE_REMOTE_WAKEUP</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">GET_DEVICE_STATUS</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">GET_INTERFACE_STATUS</span><span class="p">)</span>
		<span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">stdrsp</span><span class="p">);</span>
	<span class="n">writel</span> <span class="p">(</span>  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_ROOT_PORT_WAKEUP_ENABLE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SELF_POWERED_USB_DEVICE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REMOTE_WAKEUP_SUPPORT</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">softconnect</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DETECT_ENABLE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SELF_POWERED_STATUS</span><span class="p">)</span>
		<span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">usbctl</span><span class="p">);</span>

	<span class="cm">/* enable irqs so we can see ep0 and general operation  */</span>
	<span class="n">writel</span> <span class="p">(</span>  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SETUP_PACKET_INTERRUPT_ENABLE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ENDPOINT_0_INTERRUPT_ENABLE</span><span class="p">)</span>
		<span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb0</span><span class="p">);</span>
	<span class="n">writel</span> <span class="p">(</span>  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PCI_INTERRUPT_ENABLE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PCI_MASTER_ABORT_RECEIVED_INTERRUPT_ENABLE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PCI_TARGET_ABORT_RECEIVED_INTERRUPT_ENABLE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PCI_RETRY_ABORT_INTERRUPT_ENABLE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VBUS_INTERRUPT_ENABLE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ROOT_PORT_RESET_INTERRUPT_ENABLE</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SUSPEND_REQUEST_CHANGE_INTERRUPT_ENABLE</span><span class="p">)</span>
		<span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb1</span><span class="p">);</span>

	<span class="cm">/* don&#39;t leave any writes posted */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">usbctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* when a driver is successfully registered, it will receive</span>
<span class="cm"> * control requests including set_configuration(), which enables</span>
<span class="cm"> * non-control requests.  then usb traffic follows until a</span>
<span class="cm"> * disconnect is reported.  then a host may connect again, or</span>
<span class="cm"> * the driver might get unbound.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">net2280_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">i</span><span class="p">;</span>

	<span class="cm">/* insist on high speed support from the driver, since</span>
<span class="cm">	 * (dev-&gt;usb-&gt;xcvrdiag &amp; FORCE_FULL_SPEED_MODE)</span>
<span class="cm">	 * &quot;must not be used in normal operation&quot;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span> <span class="o">||</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">max_speed</span> <span class="o">&lt;</span> <span class="n">USB_SPEED_HIGH</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* hook up the driver ... */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">softconnect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">device_create_file</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_function</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="k">goto</span> <span class="n">err_unbind</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">device_create_file</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_queues</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="k">goto</span> <span class="n">err_func</span><span class="p">;</span>

	<span class="cm">/* ... then enable host detection and ep0; and we&#39;re ready</span>
<span class="cm">	 * for set_configuration as well as eventual disconnect.</span>
<span class="cm">	 */</span>
	<span class="n">net2280_led_active</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ep0_start</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ready, usbctl %08x stdrsp %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">usbctl</span><span class="p">),</span>
			<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">stdrsp</span><span class="p">));</span>

	<span class="cm">/* pci writes may still be posted */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_func:</span>
	<span class="n">device_remove_file</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_function</span><span class="p">);</span>
<span class="nl">err_unbind:</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">unbind</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">stop_activity</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>

	<span class="cm">/* don&#39;t disconnect if it&#39;s not connected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* stop hardware; prevent new request submissions;</span>
<span class="cm">	 * and kill any outstanding requests.</span>
<span class="cm">	 */</span>
	<span class="n">usb_reset</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">nuke</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">usb_reinit</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">net2280_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span> <span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net2280</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">stop_activity</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">driver</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">net2280_led_active</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">device_remove_file</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_function</span><span class="p">);</span>
	<span class="n">device_remove_file</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_queues</span><span class="p">);</span>

	<span class="n">DEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unregistered driver &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* handle ep0, ep-e, ep-f with 64 byte packets: packet per irq.</span>
<span class="cm"> * also works for dma-capable endpoints, in pio mode or just</span>
<span class="cm"> * to manually advance the queue after short OUT transfers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_ep_small</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">t</span><span class="p">;</span>
	<span class="cm">/* 0 error, 1 mid-data, 2 done */</span>
	<span class="kt">int</span>			<span class="n">mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">net2280_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* ack all, and handle what we care about */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_stat</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	VDEBUG (ep-&gt;dev, &quot;%s ack ep_stat %08x, req %p\n&quot;,</span>
<span class="c">			ep-&gt;ep.name, t, req ? &amp;req-&gt;req : 0);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x2280</span><span class="p">)</span>
		<span class="n">writel</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NAK_OUT_PACKETS</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_stat</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* Added for 2282 */</span>
		<span class="n">writel</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_stat</span><span class="p">);</span>

	<span class="cm">/* for ep0, monitor token irqs to catch data stage length errors</span>
<span class="cm">	 * and to synchronize on status.</span>
<span class="cm">	 *</span>
<span class="cm">	 * also, to defer reporting of protocol stalls ... here&#39;s where</span>
<span class="cm">	 * data or status first appears, handling stalls here should never</span>
<span class="cm">	 * cause trouble on the host side..</span>
<span class="cm">	 *</span>
<span class="cm">	 * control requests could be slightly faster without token synch for</span>
<span class="cm">	 * status, but status can jam up that way.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* status; stop NAKing */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_OUT_PING_TOKEN_INTERRUPT</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">protocol_stall</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">set_halt</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
					<span class="n">allow_status</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="n">mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="cm">/* reply to extra IN data tokens with a zlp */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_IN_TOKEN_INTERRUPT</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">protocol_stall</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">set_halt</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
					<span class="n">mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">responded</span> <span class="o">&amp;&amp;</span>
						<span class="o">!</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
					<span class="n">write_fifo</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* status; stop NAKing */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_IN_TOKEN_INTERRUPT</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">protocol_stall</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">set_halt</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="cm">/* an extra OUT token is an error */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">t</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_OUT_PING_TOKEN_INTERRUPT</span><span class="p">))</span>
					<span class="o">&amp;&amp;</span> <span class="n">req</span>
					<span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
					<span class="o">||</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">responded</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">protocol_stall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">set_halt</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span>
					<span class="n">done</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">);</span>
				<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* manual DMA queue advance after short OUT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SHORT_PACKET_TRANSFERRED_INTERRUPT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">count</span><span class="p">;</span>
			<span class="kt">int</span>	<span class="n">stopped</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">;</span>

			<span class="cm">/* TRANSFERRED works around OUT_DONE erratum 0112.</span>
<span class="cm">			 * we expect (N &lt;= maxpacket) bytes; host wrote M.</span>
<span class="cm">			 * iff (M &lt; N) we won&#39;t ever see a DMA interrupt.</span>
<span class="cm">			 */</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_stat</span><span class="p">))</span> <span class="p">{</span>

				<span class="cm">/* any preceding dma transfers must finish.</span>
<span class="cm">				 * dma handles (M &gt;= N), may empty the queue</span>
<span class="cm">				 */</span>
				<span class="n">scan_dma_completions</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span>
						<span class="o">||</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">out_overflow</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net2280_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

				<span class="cm">/* here either (M &lt; N), a &quot;real&quot; short rx;</span>
<span class="cm">				 * or (M == N) and the queue didn&#39;t empty</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FIFO_EMPTY</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">count</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmacount</span><span class="p">);</span>
					<span class="n">count</span> <span class="o">&amp;=</span> <span class="n">DMA_BYTE_COUNT_MASK</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmadesc</span><span class="p">)</span>
							<span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td_dma</span><span class="p">)</span>
						<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* stop DMA, leave ep NAKing */</span>
			<span class="n">writel</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_ABORT</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmastat</span><span class="p">);</span>
			<span class="n">spin_stop_dma</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmacount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_avail</span><span class="p">);</span>
				<span class="n">dma_done</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
					<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">out_overflow</span> <span class="o">||</span> <span class="n">t</span><span class="p">)</span>
						<span class="o">?</span> <span class="o">-</span><span class="n">EOVERFLOW</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* also flush to prevent erratum 0106 trouble */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">out_overflow</span>
					<span class="o">||</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chiprev</span> <span class="o">==</span> <span class="mh">0x0100</span>
						<span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span>
							<span class="o">==</span> <span class="n">USB_SPEED_FULL</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">out_flush</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">out_overflow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* (re)start dma if needed, stop NAKing */</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="n">stopped</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
				<span class="n">restart_dma</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">DEBUG</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s dma ep_stat %08x ??</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* data packet(s) received (in the fifo, OUT) */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_RECEIVED_INTERRUPT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_fifo</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* data packet(s) transmitted (IN) */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_TRANSMITTED_INTERRUPT</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span>	<span class="n">len</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

		<span class="cm">/* if we wrote it all, we&#39;re usually done */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* send zlps until the status stage */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span> <span class="o">||</span> <span class="n">len</span> <span class="o">!=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span><span class="p">)</span>
				<span class="n">mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/* there was nothing to do ...  */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* done */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* stream endpoints often resubmit/unlink in completion */</span>
		<span class="n">done</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* maybe advance queue to next request */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* NOTE:  net2280 could let gadget driver start the</span>
<span class="cm">			 * status stage later. since not all controllers let</span>
<span class="cm">			 * them control that, the api doesn&#39;t (yet) allow it.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
				<span class="n">allow_status</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
				<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net2280_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span>
				<span class="n">stop_out_naking</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* is there a buffer for the next packet?</span>
<span class="cm">	 * for best streaming performance, make sure there is one.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* load IN fifo with next packet (may be zlp) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_TRANSMITTED_INTERRUPT</span><span class="p">))</span>
			<span class="n">write_fifo</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net2280_ep</span> <span class="o">*</span>
<span class="nf">get_ep_by_addr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">wIndex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wIndex</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span>	<span class="n">bEndpointAddress</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">wIndex</span> <span class="o">^</span> <span class="n">bEndpointAddress</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">wIndex</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_stat0_irqs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">num</span><span class="p">,</span> <span class="n">scratch</span><span class="p">;</span>

	<span class="cm">/* most of these don&#39;t need individual acks */</span>
	<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTA_ASSERTED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stat</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>DEBUG (dev, "irqstat0 %04x\n", stat);</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* starting a control request? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SETUP_PACKET_INTERRUPT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">union</span> <span class="p">{</span>
			<span class="n">u32</span>			<span class="n">raw</span> <span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">usb_ctrlrequest</span>	<span class="n">r</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
		<span class="kt">int</span>				<span class="n">tmp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">net2280_request</span>		<span class="o">*</span><span class="n">req</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">usbstat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HIGH_SPEED</span><span class="p">))</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
			<span class="n">net2280_led_speed</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span><span class="p">);</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usb_speed_string</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* make sure any leftover request state is cleared */</span>
		<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ENDPOINT_0_INTERRUPT</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net2280_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
			<span class="n">done</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
						<span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">protocol_stall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x2280</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FIFO_OVERFLOW</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FIFO_UNDERFLOW</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TIMEOUT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_STALL_SENT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_IN_NAK_SENT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_IN_ACK_RCVD</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_OUT_PING_NAK_SENT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_OUT_ACK_SENT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SHORT_PACKET_OUT_DONE_INTERRUPT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SHORT_PACKET_TRANSFERRED_INTERRUPT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_RECEIVED_INTERRUPT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_TRANSMITTED_INTERRUPT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_OUT_PING_TOKEN_INTERRUPT</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_IN_TOKEN_INTERRUPT</span><span class="p">)</span>
			<span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_stat</span><span class="p">);</span>
		<span class="n">u</span><span class="p">.</span><span class="n">raw</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">setup0123</span><span class="p">);</span>
		<span class="n">u</span><span class="p">.</span><span class="n">raw</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">setup4567</span><span class="p">);</span>

		<span class="n">cpu_to_le32s</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span> <span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">cpu_to_le32s</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span> <span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#define	w_value		le16_to_cpu(u.r.wValue)</span>
<span class="cp">#define	w_index		le16_to_cpu(u.r.wIndex)</span>
<span class="cp">#define	w_length	le16_to_cpu(u.r.wLength)</span>

		<span class="cm">/* ack the irq */</span>
		<span class="n">writel</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SETUP_PACKET_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqstat0</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">^=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SETUP_PACKET_INTERRUPT</span><span class="p">);</span>

		<span class="cm">/* watch control traffic at the token level, and force</span>
<span class="cm">		 * synchronization before letting the status stage happen.</span>
<span class="cm">		 * FIXME ignore tokens we&#39;ll NAK, until driver responds.</span>
<span class="cm">		 * that&#39;ll mean a lot less irqs for some drivers.</span>
<span class="cm">		 */</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scratch</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_TRANSMITTED_INTERRUPT</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_OUT_PING_TOKEN_INTERRUPT</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_IN_TOKEN_INTERRUPT</span><span class="p">);</span>
			<span class="n">stop_out_naking</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">scratch</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_PACKET_RECEIVED_INTERRUPT</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_OUT_PING_TOKEN_INTERRUPT</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DATA_IN_TOKEN_INTERRUPT</span><span class="p">);</span>
		<span class="n">writel</span> <span class="p">(</span><span class="n">scratch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">epregs</span> <span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep_irqenb</span><span class="p">);</span>

		<span class="cm">/* we made the hardware handle most lowlevel requests;</span>
<span class="cm">		 * everything else goes uplevel to the gadget code.</span>
<span class="cm">		 */</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">responded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequest</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_REQ_GET_STATUS</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">e</span><span class="p">;</span>
			<span class="n">__le32</span>			<span class="n">status</span><span class="p">;</span>

			<span class="cm">/* hw handles device and interface status */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="p">(</span><span class="n">USB_DIR_IN</span><span class="o">|</span><span class="n">USB_RECIP_ENDPOINT</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">delegate</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">get_ep_by_addr</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">w_index</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
					<span class="o">||</span> <span class="n">w_length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_rsp</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SET_ENDPOINT_HALT</span><span class="p">))</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* don&#39;t bother with a request object! */</span>
			<span class="n">writel</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">epregs</span> <span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep_irqenb</span><span class="p">);</span>
			<span class="n">set_fifo_bytecount</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">w_length</span><span class="p">);</span>
			<span class="n">writel</span> <span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">epregs</span> <span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ep_data</span><span class="p">);</span>
			<span class="n">allow_status</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="n">VDEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s stat %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">next_endpoints</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_REQ_CLEAR_FEATURE</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">e</span><span class="p">;</span>

			<span class="cm">/* hw handles device features */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="n">USB_RECIP_ENDPOINT</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">delegate</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w_value</span> <span class="o">!=</span> <span class="n">USB_ENDPOINT_HALT</span>
					<span class="o">||</span> <span class="n">w_length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">get_ep_by_addr</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">w_index</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">wedged</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">VDEBUG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s wedged, halt not cleared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">VDEBUG</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s clear halt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
				<span class="n">clear_halt</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">allow_status</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">next_endpoints</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_REQ_SET_FEATURE</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">e</span><span class="p">;</span>

			<span class="cm">/* hw handles device features */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="n">USB_RECIP_ENDPOINT</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">delegate</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w_value</span> <span class="o">!=</span> <span class="n">USB_ENDPOINT_HALT</span>
					<span class="o">||</span> <span class="n">w_length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">get_ep_by_addr</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">w_index</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ep0name</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do_stall</span><span class="p">;</span>
			<span class="n">set_halt</span> <span class="p">(</span><span class="n">e</span><span class="p">);</span>
			<span class="n">allow_status</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="n">VDEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s set halt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">next_endpoints</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
<span class="nl">delegate:</span>
			<span class="n">VDEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setup %02x.%02x v%04x i%04x l%04x &quot;</span>
				<span class="s">&quot;ep_cfg %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequest</span><span class="p">,</span>
				<span class="n">w_value</span><span class="p">,</span> <span class="n">w_index</span><span class="p">,</span> <span class="n">w_length</span><span class="p">,</span>
				<span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ep_cfg</span><span class="p">));</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">responded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">);</span>
			<span class="n">spin_lock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* stall ep0 on error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">do_stall:</span>
			<span class="n">VDEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;req %02x.%02x protocol STALL; stat %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequestType</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bRequest</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">protocol_stall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* some in/out token irq should follow; maybe stall then.</span>
<span class="cm">		 * driver must queue a request (even zlp) or halt ep0</span>
<span class="cm">		 * before the host times out.</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

<span class="cp">#undef	w_value</span>
<span class="cp">#undef	w_index</span>
<span class="cp">#undef	w_length</span>

<span class="nl">next_endpoints:</span>
	<span class="cm">/* endpoint data irq ? */</span>
	<span class="n">scratch</span> <span class="o">=</span> <span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x7f</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">scratch</span><span class="p">;</span> <span class="n">num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span>		<span class="n">t</span><span class="p">;</span>

		<span class="cm">/* do this endpoint&#39;s FIFO and queue need tending? */</span>
		<span class="n">t</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">num</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scratch</span> <span class="o">&amp;</span> <span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">scratch</span> <span class="o">^=</span> <span class="n">t</span><span class="p">;</span>

		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">num</span><span class="p">];</span>
		<span class="n">handle_ep_small</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span>
		<span class="n">DEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unhandled irqstat0 %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define DMA_INTERRUPTS ( \</span>
<span class="cp">		  (1 &lt;&lt; DMA_D_INTERRUPT) \</span>
<span class="cp">		| (1 &lt;&lt; DMA_C_INTERRUPT) \</span>
<span class="cp">		| (1 &lt;&lt; DMA_B_INTERRUPT) \</span>
<span class="cp">		| (1 &lt;&lt; DMA_A_INTERRUPT))</span>
<span class="cp">#define	PCI_ERROR_INTERRUPTS ( \</span>
<span class="cp">		  (1 &lt;&lt; PCI_MASTER_ABORT_RECEIVED_INTERRUPT) \</span>
<span class="cp">		| (1 &lt;&lt; PCI_TARGET_ABORT_RECEIVED_INTERRUPT) \</span>
<span class="cp">		| (1 &lt;&lt; PCI_RETRY_ABORT_INTERRUPT))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_stat1_irqs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">tmp</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">scratch</span><span class="p">;</span>

	<span class="cm">/* after disconnect there&#39;s nothing else to do! */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VBUS_INTERRUPT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ROOT_PORT_RESET_INTERRUPT</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HIGH_SPEED</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FULL_SPEED</span><span class="p">);</span>

	<span class="cm">/* VBUS disconnect is indicated by VBUS_PIN and VBUS_INTERRUPT set.</span>
<span class="cm">	 * Root Port Reset is indicated by ROOT_PORT_RESET_INTERRUPT set and</span>
<span class="cm">	 * both HIGH_SPEED and FULL_SPEED clear (as ROOT_PORT_RESET_INTERRUPT</span>
<span class="cm">	 * only indicates a change in the reset state).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqstat1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ROOT_PORT_RESET_INTERRUPT</span><span class="p">))</span>
					<span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">usbstat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
							<span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
				<span class="o">||</span> <span class="p">((</span><span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">usbctl</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VBUS_PIN</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			    <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disconnect %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="n">stop_activity</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
			<span class="n">ep0_start</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">tmp</span><span class="p">;</span>

		<span class="cm">/* vBUS can bounce ... one of many reasons to ignore the</span>
<span class="cm">		 * notion of hotplug events on bus connect/disconnect!</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stat</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* NOTE: chip stays in PCI D0 state for now, but it could</span>
<span class="cm">	 * enter D1 to save more power</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SUSPEND_REQUEST_CHANGE_INTERRUPT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqstat1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SUSPEND_REQUEST_INTERRUPT</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable_suspend</span><span class="p">)</span>
				<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SUSPEND_REQUEST_INTERRUPT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
			<span class="cm">/* at high speed, note erratum 0133 */</span>
		<span class="p">}</span>
		<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* clear any other status/irqs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span>
		<span class="n">writel</span> <span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqstat1</span><span class="p">);</span>

	<span class="cm">/* some status we can just ignore */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x2280</span><span class="p">)</span>
		<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CONTROL_STATUS_INTERRUPT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SUSPEND_REQUEST_INTERRUPT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">RESUME_INTERRUPT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SOF_INTERRUPT</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CONTROL_STATUS_INTERRUPT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">RESUME_INTERRUPT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SOF_DOWN_INTERRUPT</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SOF_INTERRUPT</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stat</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>DEBUG (dev, "irqstat1 %08x\n", stat);</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* DMA status, for ep-{a,b,c,d} */</span>
	<span class="n">scratch</span> <span class="o">=</span> <span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DMA_INTERRUPTS</span><span class="p">;</span>
	<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_INTERRUPTS</span><span class="p">;</span>
	<span class="n">scratch</span> <span class="o">&gt;&gt;=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">scratch</span><span class="p">;</span> <span class="n">num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net2280_dma_regs</span>	<span class="n">__iomem</span> <span class="o">*</span><span class="n">dma</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">num</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">scratch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">scratch</span> <span class="o">^=</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* clear ep&#39;s dma status */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmastat</span><span class="p">);</span>
		<span class="n">writel</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmastat</span><span class="p">);</span>

		<span class="cm">/* chaining should stop on abort, short OUT from fifo,</span>
<span class="cm">		 * or (stat0 codepath) short OUT transfer.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma_chaining</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_TRANSACTION_DONE_INTERRUPT</span><span class="p">))</span>
					<span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s no xact done? %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">stop_dma</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* OUT transfers terminate when the data from the</span>
<span class="cm">		 * host is in our memory.  Process whatever&#39;s done.</span>
<span class="cm">		 * On this path, we know transfer&#39;s last packet wasn&#39;t</span>
<span class="cm">		 * less than req-&gt;length. NAK_OUT_PACKETS may be set,</span>
<span class="cm">		 * or the FIFO may already be holding new packets.</span>
<span class="cm">		 *</span>
<span class="cm">		 * IN transfers can linger in the FIFO for a very</span>
<span class="cm">		 * long time ... we ignore that for now, accounting</span>
<span class="cm">		 * precisely (like PIO does) needs per-packet irqs</span>
<span class="cm">		 */</span>
		<span class="n">scan_dma_completions</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>

		<span class="cm">/* disable dma on inactive queues; else maybe restart */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">use_dma_chaining</span><span class="p">)</span>
				<span class="n">stop_dma</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dmactl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma_chaining</span>
					<span class="o">||</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_ENABLE</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">restart_dma</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">is_in</span> <span class="o">&amp;&amp;</span> <span class="n">use_dma_chaining</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">net2280_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
				<span class="n">__le32</span>			<span class="n">dmacount</span><span class="p">;</span>

				<span class="cm">/* the descriptor at the head of the chain</span>
<span class="cm">				 * may still have VALID_BIT clear; that&#39;s</span>
<span class="cm">				 * used to trigger changing DMA_FIFO_VALIDATE</span>
<span class="cm">				 * (affects automagic zlp writes).</span>
<span class="cm">				 */</span>
				<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">net2280_request</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
				<span class="n">dmacount</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dmacount</span><span class="p">;</span>
				<span class="n">dmacount</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le32</span> <span class="p">(</span>
						<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">VALID_BIT</span><span class="p">)</span>
						<span class="o">|</span> <span class="n">DMA_BYTE_COUNT_MASK</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dmacount</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dmacount</span> <span class="o">&amp;</span> <span class="n">valid_bit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">restart_dma</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* NOTE:  there are other PCI errors we might usefully notice.</span>
<span class="cm">	 * if they appear very often, here&#39;s where to try recovering.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">PCI_ERROR_INTERRUPTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERROR</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pci dma error; stat %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_ERROR_INTERRUPTS</span><span class="p">;</span>
		<span class="cm">/* these are fatal errors, but &quot;maybe&quot; they won&#39;t</span>
<span class="cm">		 * happen again ...</span>
<span class="cm">		 */</span>
		<span class="n">stop_activity</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
		<span class="n">ep0_start</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span>
		<span class="n">DEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unhandled irqstat1 %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">net2280_irq</span> <span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">_dev</span><span class="p">;</span>

	<span class="cm">/* shared interrupt, not ours */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqstat0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTA_ASSERTED</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">spin_lock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* handle disconnect, dma, and more */</span>
	<span class="n">handle_stat1_irqs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqstat1</span><span class="p">));</span>

	<span class="cm">/* control requests and PIO */</span>
	<span class="n">handle_stat0_irqs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">readl</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">irqstat0</span><span class="p">));</span>

	<span class="n">spin_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gadget_release</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span> <span class="p">(</span><span class="n">_dev</span><span class="p">);</span>

	<span class="n">kfree</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* tear down the binding between this driver and the pci device */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">net2280_remove</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">usb_del_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>

	<span class="cm">/* then clean up the resources we allocated during probe() */</span>
	<span class="n">net2280_led_shutdown</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dummy</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">pci_pool_free</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dummy</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">td_dma</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pci_pool_destroy</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">got_irq</span><span class="p">)</span>
		<span class="n">free_irq</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span>
		<span class="n">iounmap</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">)</span>
		<span class="n">release_mem_region</span> <span class="p">(</span><span class="n">pci_resource_start</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">pci_resource_len</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">pci_disable_device</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">device_unregister</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">device_remove_file</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_registers</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">INFO</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unbind</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* wrap this driver around the specified device, but</span>
<span class="cm"> * don&#39;t respond over USB until a gadget driver binds to us.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">net2280_probe</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">resource</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* alloc, and start init */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">net2280_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">max_speed</span> <span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">;</span>

	<span class="cm">/* the &quot;gadget&quot; abstracts/virtualizes the controller */</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gadget&quot;</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">gadget_release</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">driver_name</span><span class="p">;</span>

	<span class="cm">/* now all the pci goodies ... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span> <span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	        <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* BAR 0 holds all the registers</span>
<span class="cm">	 * BAR 1 is 8051 memory; unused here (note erratum 0103)</span>
<span class="cm">	 * BAR 2 is fifo memory; unused here</span>
<span class="cm">	 */</span>
	<span class="n">resource</span> <span class="o">=</span> <span class="n">pci_resource_start</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">pci_resource_len</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span> <span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">region</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* FIXME provide firmware download interface to put</span>
<span class="cm">	 * 8051 code into the chip, e.g. to turn on PCI PM.</span>
<span class="cm">	 */</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span> <span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t map memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_usb_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x0080</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_pci_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x0100</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_dma_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x0180</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dep</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_dep_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x0200</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">epregs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_ep_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x0300</span><span class="p">);</span>

	<span class="cm">/* put into initial config, link up all endpoints */</span>
	<span class="n">writel</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">usbctl</span><span class="p">);</span>
	<span class="n">usb_reset</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">usb_reinit</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* irq setup after old hardware is cleaned up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERROR</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No IRQ.  Check PCI setup!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">net2280_irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span>
			<span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERROR</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request interrupt %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">got_irq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* DMA setup */</span>
	<span class="cm">/* NOTE:  we know only the 32 LSBs of dma addresses may be nonzero */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">requests</span> <span class="o">=</span> <span class="n">pci_pool_create</span> <span class="p">(</span><span class="s">&quot;requests&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span>
		<span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net2280_dma</span><span class="p">),</span>
		<span class="mi">0</span> <span class="cm">/* no alignment requirements */</span><span class="p">,</span>
		<span class="mi">0</span> <span class="cm">/* or page-crossing issues */</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t get request pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net2280_dma</span>	<span class="o">*</span><span class="n">td</span><span class="p">;</span>

		<span class="n">td</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">td_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">td</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t get dummy %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">dmacount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* not VALID */</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">dmaaddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span> <span class="p">(</span><span class="n">DMA_ADDR_INVALID</span><span class="p">);</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">dmadesc</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">dmaaddr</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dummy</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enable lower-overhead pci memory bursts during DMA */</span>
	<span class="n">writel</span> <span class="p">(</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_MEMORY_WRITE_AND_INVALIDATE_ENABLE</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>256 write retries may not be enough...
| (1 &lt;&lt; PCI<em>RETRY</em>ABORT_ENABLE)</p></td><td class="code"><div class="highlight"><pre>			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_READ_MULTIPLE_ENABLE</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_READ_LINE_ENABLE</span><span class="p">)</span>
			<span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">pcimstctl</span><span class="p">);</span>
	<span class="cm">/* erratum 0115 shouldn&#39;t appear: Linux inits PCI_LATENCY_TIMER */</span>
	<span class="n">pci_set_master</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_try_set_mwi</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* ... also flushes any posted pci writes */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">chiprev</span> <span class="o">=</span> <span class="n">get_idx_reg</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG_CHIPREV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="cm">/* done */</span>
	<span class="n">INFO</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_desc</span><span class="p">);</span>
	<span class="n">INFO</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq %d, pci mem %p, chip rev %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">chiprev</span><span class="p">);</span>
	<span class="n">INFO</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;version: &quot;</span> <span class="n">DRIVER_VERSION</span> <span class="s">&quot;; dma %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">use_dma</span>
				<span class="o">?</span> <span class="p">(</span><span class="n">use_dma_chaining</span> <span class="o">?</span> <span class="s">&quot;chaining&quot;</span> <span class="o">:</span> <span class="s">&quot;enabled&quot;</span><span class="p">)</span>
				<span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">device_register</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">device_create_file</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_registers</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_add_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">net2280_remove</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* make sure the board is quiescent; otherwise it will continue</span>
<span class="cm"> * generating IRQs across the upcoming reboot.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">net2280_shutdown</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net2280</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* disable IRQs */</span>
	<span class="n">writel</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb0</span><span class="p">);</span>
	<span class="n">writel</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pciirqenb1</span><span class="p">);</span>

	<span class="cm">/* disable the pullup so the host will think we&#39;re gone */</span>
	<span class="n">writel</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">usbctl</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">pci_ids</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">class</span> <span class="o">=</span>	<span class="p">((</span><span class="n">PCI_CLASS_SERIAL_USB</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xfe</span><span class="p">),</span>
	<span class="p">.</span><span class="n">class_mask</span> <span class="o">=</span>	<span class="o">~</span><span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span>	<span class="mh">0x17cc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span> <span class="o">=</span>	<span class="mh">0x2280</span><span class="p">,</span>
	<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span>	<span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span>	<span class="n">PCI_ANY_ID</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">class</span> <span class="o">=</span>	<span class="p">((</span><span class="n">PCI_CLASS_SERIAL_USB</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xfe</span><span class="p">),</span>
	<span class="p">.</span><span class="n">class_mask</span> <span class="o">=</span>	<span class="o">~</span><span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span>	<span class="mh">0x17cc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span> <span class="o">=</span>	<span class="mh">0x2282</span><span class="p">,</span>
	<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span>	<span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span>	<span class="n">PCI_ANY_ID</span><span class="p">,</span>

<span class="p">},</span> <span class="p">{</span> <span class="cm">/* end: all zeroes */</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span> <span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_ids</span><span class="p">);</span>

<span class="cm">/* pci driver glue; this is a &quot;new style&quot; PCI driver module */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">net2280_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">driver_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">pci_ids</span><span class="p">,</span>

	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">net2280_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>	<span class="n">net2280_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span>	<span class="n">net2280_shutdown</span><span class="p">,</span>

	<span class="cm">/* FIXME add power management support */</span>
<span class="p">};</span>

<span class="n">MODULE_DESCRIPTION</span> <span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span> <span class="p">(</span><span class="s">&quot;David Brownell&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span> <span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma</span><span class="p">)</span>
		<span class="n">use_dma_chaining</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">net2280_pci_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span> <span class="p">(</span><span class="n">init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">net2280_pci_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span> <span class="p">(</span><span class="n">cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
