<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › dwc3 › core.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>core.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * core.h - DesignWare USB3 DRD Core Header</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010-2011 Texas Instruments Incorporated - http://www.ti.com</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Felipe Balbi &lt;balbi@ti.com&gt;,</span>
<span class="cm"> *	    Sebastian Andrzej Siewior &lt;bigeasy@linutronix.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions, and the following disclaimer,</span>
<span class="cm"> *    without modification.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *    documentation and/or other materials provided with the distribution.</span>
<span class="cm"> * 3. The names of the above-listed copyright holders may not be used</span>
<span class="cm"> *    to endorse or promote products derived from this software without</span>
<span class="cm"> *    specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * ALTERNATIVELY, this software may be distributed under the terms of the</span>
<span class="cm"> * GNU General Public License (&quot;GPL&quot;) version 2, as published by the Free</span>
<span class="cm"> * Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS</span>
<span class="cm"> * IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,</span>
<span class="cm"> * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR</span>
<span class="cm"> * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR</span>
<span class="cm"> * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,</span>
<span class="cm"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,</span>
<span class="cm"> * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR</span>
<span class="cm"> * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF</span>
<span class="cm"> * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
<span class="cm"> * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="cm"> * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __DRIVERS_USB_DWC3_CORE_H</span>
<span class="cp">#define __DRIVERS_USB_DWC3_CORE_H</span>

<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>

<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>

<span class="cm">/* Global constants */</span>
<span class="cp">#define DWC3_EP0_BOUNCE_SIZE	512</span>
<span class="cp">#define DWC3_ENDPOINTS_NUM	32</span>
<span class="cp">#define DWC3_XHCI_RESOURCES_NUM	2</span>

<span class="cp">#define DWC3_EVENT_BUFFERS_SIZE	PAGE_SIZE</span>
<span class="cp">#define DWC3_EVENT_TYPE_MASK	0xfe</span>

<span class="cp">#define DWC3_EVENT_TYPE_DEV	0</span>
<span class="cp">#define DWC3_EVENT_TYPE_CARKIT	3</span>
<span class="cp">#define DWC3_EVENT_TYPE_I2C	4</span>

<span class="cp">#define DWC3_DEVICE_EVENT_DISCONNECT		0</span>
<span class="cp">#define DWC3_DEVICE_EVENT_RESET			1</span>
<span class="cp">#define DWC3_DEVICE_EVENT_CONNECT_DONE		2</span>
<span class="cp">#define DWC3_DEVICE_EVENT_LINK_STATUS_CHANGE	3</span>
<span class="cp">#define DWC3_DEVICE_EVENT_WAKEUP		4</span>
<span class="cp">#define DWC3_DEVICE_EVENT_EOPF			6</span>
<span class="cp">#define DWC3_DEVICE_EVENT_SOF			7</span>
<span class="cp">#define DWC3_DEVICE_EVENT_ERRATIC_ERROR		9</span>
<span class="cp">#define DWC3_DEVICE_EVENT_CMD_CMPL		10</span>
<span class="cp">#define DWC3_DEVICE_EVENT_OVERFLOW		11</span>

<span class="cp">#define DWC3_GEVNTCOUNT_MASK	0xfffc</span>
<span class="cp">#define DWC3_GSNPSID_MASK	0xffff0000</span>
<span class="cp">#define DWC3_GSNPSREV_MASK	0xffff</span>

<span class="cm">/* DWC3 registers memory space boundries */</span>
<span class="cp">#define DWC3_XHCI_REGS_START		0x0</span>
<span class="cp">#define DWC3_XHCI_REGS_END		0x7fff</span>
<span class="cp">#define DWC3_GLOBALS_REGS_START		0xc100</span>
<span class="cp">#define DWC3_GLOBALS_REGS_END		0xc6ff</span>
<span class="cp">#define DWC3_DEVICE_REGS_START		0xc700</span>
<span class="cp">#define DWC3_DEVICE_REGS_END		0xcbff</span>
<span class="cp">#define DWC3_OTG_REGS_START		0xcc00</span>
<span class="cp">#define DWC3_OTG_REGS_END		0xccff</span>

<span class="cm">/* Global Registers */</span>
<span class="cp">#define DWC3_GSBUSCFG0		0xc100</span>
<span class="cp">#define DWC3_GSBUSCFG1		0xc104</span>
<span class="cp">#define DWC3_GTXTHRCFG		0xc108</span>
<span class="cp">#define DWC3_GRXTHRCFG		0xc10c</span>
<span class="cp">#define DWC3_GCTL		0xc110</span>
<span class="cp">#define DWC3_GEVTEN		0xc114</span>
<span class="cp">#define DWC3_GSTS		0xc118</span>
<span class="cp">#define DWC3_GSNPSID		0xc120</span>
<span class="cp">#define DWC3_GGPIO		0xc124</span>
<span class="cp">#define DWC3_GUID		0xc128</span>
<span class="cp">#define DWC3_GUCTL		0xc12c</span>
<span class="cp">#define DWC3_GBUSERRADDR0	0xc130</span>
<span class="cp">#define DWC3_GBUSERRADDR1	0xc134</span>
<span class="cp">#define DWC3_GPRTBIMAP0		0xc138</span>
<span class="cp">#define DWC3_GPRTBIMAP1		0xc13c</span>
<span class="cp">#define DWC3_GHWPARAMS0		0xc140</span>
<span class="cp">#define DWC3_GHWPARAMS1		0xc144</span>
<span class="cp">#define DWC3_GHWPARAMS2		0xc148</span>
<span class="cp">#define DWC3_GHWPARAMS3		0xc14c</span>
<span class="cp">#define DWC3_GHWPARAMS4		0xc150</span>
<span class="cp">#define DWC3_GHWPARAMS5		0xc154</span>
<span class="cp">#define DWC3_GHWPARAMS6		0xc158</span>
<span class="cp">#define DWC3_GHWPARAMS7		0xc15c</span>
<span class="cp">#define DWC3_GDBGFIFOSPACE	0xc160</span>
<span class="cp">#define DWC3_GDBGLTSSM		0xc164</span>
<span class="cp">#define DWC3_GPRTBIMAP_HS0	0xc180</span>
<span class="cp">#define DWC3_GPRTBIMAP_HS1	0xc184</span>
<span class="cp">#define DWC3_GPRTBIMAP_FS0	0xc188</span>
<span class="cp">#define DWC3_GPRTBIMAP_FS1	0xc18c</span>

<span class="cp">#define DWC3_GUSB2PHYCFG(n)	(0xc200 + (n * 0x04))</span>
<span class="cp">#define DWC3_GUSB2I2CCTL(n)	(0xc240 + (n * 0x04))</span>

<span class="cp">#define DWC3_GUSB2PHYACC(n)	(0xc280 + (n * 0x04))</span>

<span class="cp">#define DWC3_GUSB3PIPECTL(n)	(0xc2c0 + (n * 0x04))</span>

<span class="cp">#define DWC3_GTXFIFOSIZ(n)	(0xc300 + (n * 0x04))</span>
<span class="cp">#define DWC3_GRXFIFOSIZ(n)	(0xc380 + (n * 0x04))</span>

<span class="cp">#define DWC3_GEVNTADRLO(n)	(0xc400 + (n * 0x10))</span>
<span class="cp">#define DWC3_GEVNTADRHI(n)	(0xc404 + (n * 0x10))</span>
<span class="cp">#define DWC3_GEVNTSIZ(n)	(0xc408 + (n * 0x10))</span>
<span class="cp">#define DWC3_GEVNTCOUNT(n)	(0xc40c + (n * 0x10))</span>

<span class="cp">#define DWC3_GHWPARAMS8		0xc600</span>

<span class="cm">/* Device Registers */</span>
<span class="cp">#define DWC3_DCFG		0xc700</span>
<span class="cp">#define DWC3_DCTL		0xc704</span>
<span class="cp">#define DWC3_DEVTEN		0xc708</span>
<span class="cp">#define DWC3_DSTS		0xc70c</span>
<span class="cp">#define DWC3_DGCMDPAR		0xc710</span>
<span class="cp">#define DWC3_DGCMD		0xc714</span>
<span class="cp">#define DWC3_DALEPENA		0xc720</span>
<span class="cp">#define DWC3_DEPCMDPAR2(n)	(0xc800 + (n * 0x10))</span>
<span class="cp">#define DWC3_DEPCMDPAR1(n)	(0xc804 + (n * 0x10))</span>
<span class="cp">#define DWC3_DEPCMDPAR0(n)	(0xc808 + (n * 0x10))</span>
<span class="cp">#define DWC3_DEPCMD(n)		(0xc80c + (n * 0x10))</span>

<span class="cm">/* OTG Registers */</span>
<span class="cp">#define DWC3_OCFG		0xcc00</span>
<span class="cp">#define DWC3_OCTL		0xcc04</span>
<span class="cp">#define DWC3_OEVTEN		0xcc08</span>
<span class="cp">#define DWC3_OSTS		0xcc0C</span>

<span class="cm">/* Bit fields */</span>

<span class="cm">/* Global Configuration Register */</span>
<span class="cp">#define DWC3_GCTL_PWRDNSCALE(n)	((n) &lt;&lt; 19)</span>
<span class="cp">#define DWC3_GCTL_U2RSTECN	(1 &lt;&lt; 16)</span>
<span class="cp">#define DWC3_GCTL_RAMCLKSEL(x)	(((x) &amp; DWC3_GCTL_CLK_MASK) &lt;&lt; 6)</span>
<span class="cp">#define DWC3_GCTL_CLK_BUS	(0)</span>
<span class="cp">#define DWC3_GCTL_CLK_PIPE	(1)</span>
<span class="cp">#define DWC3_GCTL_CLK_PIPEHALF	(2)</span>
<span class="cp">#define DWC3_GCTL_CLK_MASK	(3)</span>

<span class="cp">#define DWC3_GCTL_PRTCAP(n)	(((n) &amp; (3 &lt;&lt; 12)) &gt;&gt; 12)</span>
<span class="cp">#define DWC3_GCTL_PRTCAPDIR(n)	((n) &lt;&lt; 12)</span>
<span class="cp">#define DWC3_GCTL_PRTCAP_HOST	1</span>
<span class="cp">#define DWC3_GCTL_PRTCAP_DEVICE	2</span>
<span class="cp">#define DWC3_GCTL_PRTCAP_OTG	3</span>

<span class="cp">#define DWC3_GCTL_CORESOFTRESET	(1 &lt;&lt; 11)</span>
<span class="cp">#define DWC3_GCTL_SCALEDOWN(n)	((n) &lt;&lt; 4)</span>
<span class="cp">#define DWC3_GCTL_SCALEDOWN_MASK DWC3_GCTL_SCALEDOWN(3)</span>
<span class="cp">#define DWC3_GCTL_DISSCRAMBLE	(1 &lt;&lt; 3)</span>
<span class="cp">#define DWC3_GCTL_DSBLCLKGTNG	(1 &lt;&lt; 0)</span>

<span class="cm">/* Global USB2 PHY Configuration Register */</span>
<span class="cp">#define DWC3_GUSB2PHYCFG_PHYSOFTRST (1 &lt;&lt; 31)</span>
<span class="cp">#define DWC3_GUSB2PHYCFG_SUSPHY	(1 &lt;&lt; 6)</span>

<span class="cm">/* Global USB3 PIPE Control Register */</span>
<span class="cp">#define DWC3_GUSB3PIPECTL_PHYSOFTRST (1 &lt;&lt; 31)</span>
<span class="cp">#define DWC3_GUSB3PIPECTL_SUSPHY (1 &lt;&lt; 17)</span>

<span class="cm">/* Global TX Fifo Size Register */</span>
<span class="cp">#define DWC3_GTXFIFOSIZ_TXFDEF(n) ((n) &amp; 0xffff)</span>
<span class="cp">#define DWC3_GTXFIFOSIZ_TXFSTADDR(n) ((n) &amp; 0xffff0000)</span>

<span class="cm">/* Global HWPARAMS1 Register */</span>
<span class="cp">#define DWC3_GHWPARAMS1_EN_PWROPT(n)	(((n) &amp; (3 &lt;&lt; 24)) &gt;&gt; 24)</span>
<span class="cp">#define DWC3_GHWPARAMS1_EN_PWROPT_NO	0</span>
<span class="cp">#define DWC3_GHWPARAMS1_EN_PWROPT_CLK	1</span>

<span class="cm">/* Device Configuration Register */</span>
<span class="cp">#define DWC3_DCFG_LPM_CAP	(1 &lt;&lt; 22)</span>
<span class="cp">#define DWC3_DCFG_DEVADDR(addr)	((addr) &lt;&lt; 3)</span>
<span class="cp">#define DWC3_DCFG_DEVADDR_MASK	DWC3_DCFG_DEVADDR(0x7f)</span>

<span class="cp">#define DWC3_DCFG_SPEED_MASK	(7 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_DCFG_SUPERSPEED	(4 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_DCFG_HIGHSPEED	(0 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_DCFG_FULLSPEED2	(1 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_DCFG_LOWSPEED	(2 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_DCFG_FULLSPEED1	(3 &lt;&lt; 0)</span>

<span class="cm">/* Device Control Register */</span>
<span class="cp">#define DWC3_DCTL_RUN_STOP	(1 &lt;&lt; 31)</span>
<span class="cp">#define DWC3_DCTL_CSFTRST	(1 &lt;&lt; 30)</span>
<span class="cp">#define DWC3_DCTL_LSFTRST	(1 &lt;&lt; 29)</span>

<span class="cp">#define DWC3_DCTL_HIRD_THRES_MASK	(0x1f &lt;&lt; 24)</span>
<span class="cp">#define DWC3_DCTL_HIRD_THRES(n)	(((n) &amp; DWC3_DCTL_HIRD_THRES_MASK) &gt;&gt; 24)</span>

<span class="cp">#define DWC3_DCTL_APPL1RES	(1 &lt;&lt; 23)</span>

<span class="cp">#define DWC3_DCTL_TRGTULST_MASK	(0x0f &lt;&lt; 17)</span>
<span class="cp">#define DWC3_DCTL_TRGTULST(n)	((n) &lt;&lt; 17)</span>

<span class="cp">#define DWC3_DCTL_TRGTULST_U2	(DWC3_DCTL_TRGTULST(2))</span>
<span class="cp">#define DWC3_DCTL_TRGTULST_U3	(DWC3_DCTL_TRGTULST(3))</span>
<span class="cp">#define DWC3_DCTL_TRGTULST_SS_DIS (DWC3_DCTL_TRGTULST(4))</span>
<span class="cp">#define DWC3_DCTL_TRGTULST_RX_DET (DWC3_DCTL_TRGTULST(5))</span>
<span class="cp">#define DWC3_DCTL_TRGTULST_SS_INACT (DWC3_DCTL_TRGTULST(6))</span>

<span class="cp">#define DWC3_DCTL_INITU2ENA	(1 &lt;&lt; 12)</span>
<span class="cp">#define DWC3_DCTL_ACCEPTU2ENA	(1 &lt;&lt; 11)</span>
<span class="cp">#define DWC3_DCTL_INITU1ENA	(1 &lt;&lt; 10)</span>
<span class="cp">#define DWC3_DCTL_ACCEPTU1ENA	(1 &lt;&lt; 9)</span>
<span class="cp">#define DWC3_DCTL_TSTCTRL_MASK	(0xf &lt;&lt; 1)</span>

<span class="cp">#define DWC3_DCTL_ULSTCHNGREQ_MASK	(0x0f &lt;&lt; 5)</span>
<span class="cp">#define DWC3_DCTL_ULSTCHNGREQ(n) (((n) &lt;&lt; 5) &amp; DWC3_DCTL_ULSTCHNGREQ_MASK)</span>

<span class="cp">#define DWC3_DCTL_ULSTCHNG_NO_ACTION	(DWC3_DCTL_ULSTCHNGREQ(0))</span>
<span class="cp">#define DWC3_DCTL_ULSTCHNG_SS_DISABLED	(DWC3_DCTL_ULSTCHNGREQ(4))</span>
<span class="cp">#define DWC3_DCTL_ULSTCHNG_RX_DETECT	(DWC3_DCTL_ULSTCHNGREQ(5))</span>
<span class="cp">#define DWC3_DCTL_ULSTCHNG_SS_INACTIVE	(DWC3_DCTL_ULSTCHNGREQ(6))</span>
<span class="cp">#define DWC3_DCTL_ULSTCHNG_RECOVERY	(DWC3_DCTL_ULSTCHNGREQ(8))</span>
<span class="cp">#define DWC3_DCTL_ULSTCHNG_COMPLIANCE	(DWC3_DCTL_ULSTCHNGREQ(10))</span>
<span class="cp">#define DWC3_DCTL_ULSTCHNG_LOOPBACK	(DWC3_DCTL_ULSTCHNGREQ(11))</span>

<span class="cm">/* Device Event Enable Register */</span>
<span class="cp">#define DWC3_DEVTEN_VNDRDEVTSTRCVEDEN	(1 &lt;&lt; 12)</span>
<span class="cp">#define DWC3_DEVTEN_EVNTOVERFLOWEN	(1 &lt;&lt; 11)</span>
<span class="cp">#define DWC3_DEVTEN_CMDCMPLTEN		(1 &lt;&lt; 10)</span>
<span class="cp">#define DWC3_DEVTEN_ERRTICERREN		(1 &lt;&lt; 9)</span>
<span class="cp">#define DWC3_DEVTEN_SOFEN		(1 &lt;&lt; 7)</span>
<span class="cp">#define DWC3_DEVTEN_EOPFEN		(1 &lt;&lt; 6)</span>
<span class="cp">#define DWC3_DEVTEN_WKUPEVTEN		(1 &lt;&lt; 4)</span>
<span class="cp">#define DWC3_DEVTEN_ULSTCNGEN		(1 &lt;&lt; 3)</span>
<span class="cp">#define DWC3_DEVTEN_CONNECTDONEEN	(1 &lt;&lt; 2)</span>
<span class="cp">#define DWC3_DEVTEN_USBRSTEN		(1 &lt;&lt; 1)</span>
<span class="cp">#define DWC3_DEVTEN_DISCONNEVTEN	(1 &lt;&lt; 0)</span>

<span class="cm">/* Device Status Register */</span>
<span class="cp">#define DWC3_DSTS_PWRUPREQ		(1 &lt;&lt; 24)</span>
<span class="cp">#define DWC3_DSTS_COREIDLE		(1 &lt;&lt; 23)</span>
<span class="cp">#define DWC3_DSTS_DEVCTRLHLT		(1 &lt;&lt; 22)</span>

<span class="cp">#define DWC3_DSTS_USBLNKST_MASK		(0x0f &lt;&lt; 18)</span>
<span class="cp">#define DWC3_DSTS_USBLNKST(n)		(((n) &amp; DWC3_DSTS_USBLNKST_MASK) &gt;&gt; 18)</span>

<span class="cp">#define DWC3_DSTS_RXFIFOEMPTY		(1 &lt;&lt; 17)</span>

<span class="cp">#define DWC3_DSTS_SOFFN_MASK		(0x3ff &lt;&lt; 3)</span>
<span class="cp">#define DWC3_DSTS_SOFFN(n)		(((n) &amp; DWC3_DSTS_SOFFN_MASK) &gt;&gt; 3)</span>

<span class="cp">#define DWC3_DSTS_CONNECTSPD		(7 &lt;&lt; 0)</span>

<span class="cp">#define DWC3_DSTS_SUPERSPEED		(4 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_DSTS_HIGHSPEED		(0 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_DSTS_FULLSPEED2		(1 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_DSTS_LOWSPEED		(2 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_DSTS_FULLSPEED1		(3 &lt;&lt; 0)</span>

<span class="cm">/* Device Generic Command Register */</span>
<span class="cp">#define DWC3_DGCMD_SET_LMP		0x01</span>
<span class="cp">#define DWC3_DGCMD_SET_PERIODIC_PAR	0x02</span>
<span class="cp">#define DWC3_DGCMD_XMIT_FUNCTION	0x03</span>
<span class="cp">#define DWC3_DGCMD_SELECTED_FIFO_FLUSH	0x09</span>
<span class="cp">#define DWC3_DGCMD_ALL_FIFO_FLUSH	0x0a</span>
<span class="cp">#define DWC3_DGCMD_SET_ENDPOINT_NRDY	0x0c</span>
<span class="cp">#define DWC3_DGCMD_RUN_SOC_BUS_LOOPBACK	0x10</span>

<span class="cp">#define DWC3_DGCMD_STATUS(n)		(((n) &gt;&gt; 15) &amp; 1)</span>
<span class="cp">#define DWC3_DGCMD_CMDACT		(1 &lt;&lt; 10)</span>

<span class="cm">/* Device Endpoint Command Register */</span>
<span class="cp">#define DWC3_DEPCMD_PARAM_SHIFT		16</span>
<span class="cp">#define DWC3_DEPCMD_PARAM(x)		((x) &lt;&lt; DWC3_DEPCMD_PARAM_SHIFT)</span>
<span class="cp">#define DWC3_DEPCMD_GET_RSC_IDX(x)     (((x) &gt;&gt; DWC3_DEPCMD_PARAM_SHIFT) &amp; 0x7f)</span>
<span class="cp">#define DWC3_DEPCMD_STATUS(x)		(((x) &gt;&gt; 15) &amp; 1)</span>
<span class="cp">#define DWC3_DEPCMD_HIPRI_FORCERM	(1 &lt;&lt; 11)</span>
<span class="cp">#define DWC3_DEPCMD_CMDACT		(1 &lt;&lt; 10)</span>
<span class="cp">#define DWC3_DEPCMD_CMDIOC		(1 &lt;&lt; 8)</span>

<span class="cp">#define DWC3_DEPCMD_DEPSTARTCFG		(0x09 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_DEPCMD_ENDTRANSFER		(0x08 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_DEPCMD_UPDATETRANSFER	(0x07 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_DEPCMD_STARTTRANSFER	(0x06 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_DEPCMD_CLEARSTALL		(0x05 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_DEPCMD_SETSTALL		(0x04 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_DEPCMD_GETSEQNUMBER	(0x03 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_DEPCMD_SETTRANSFRESOURCE	(0x02 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_DEPCMD_SETEPCONFIG		(0x01 &lt;&lt; 0)</span>

<span class="cm">/* The EP number goes 0..31 so ep0 is always out and ep1 is always in */</span>
<span class="cp">#define DWC3_DALEPENA_EP(n)		(1 &lt;&lt; n)</span>

<span class="cp">#define DWC3_DEPCMD_TYPE_CONTROL	0</span>
<span class="cp">#define DWC3_DEPCMD_TYPE_ISOC		1</span>
<span class="cp">#define DWC3_DEPCMD_TYPE_BULK		2</span>
<span class="cp">#define DWC3_DEPCMD_TYPE_INTR		3</span>

<span class="cm">/* Structures */</span>

<span class="k">struct</span> <span class="n">dwc3_trb</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * struct dwc3_event_buffer - Software event buffer representation</span>
<span class="cm"> * @list: a list of event buffers</span>
<span class="cm"> * @buf: _THE_ buffer</span>
<span class="cm"> * @length: size of this buffer</span>
<span class="cm"> * @dma: dma_addr_t</span>
<span class="cm"> * @dwc: pointer to DWC controller</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dwc3_event_buffer</span> <span class="p">{</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">lpos</span><span class="p">;</span>

	<span class="n">dma_addr_t</span>		<span class="n">dma</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dwc3</span>		<span class="o">*</span><span class="n">dwc</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define DWC3_EP_FLAG_STALLED	(1 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_EP_FLAG_WEDGED	(1 &lt;&lt; 1)</span>

<span class="cp">#define DWC3_EP_DIRECTION_TX	true</span>
<span class="cp">#define DWC3_EP_DIRECTION_RX	false</span>

<span class="cp">#define DWC3_TRB_NUM		32</span>
<span class="cp">#define DWC3_TRB_MASK		(DWC3_TRB_NUM - 1)</span>

<span class="cm">/**</span>
<span class="cm"> * struct dwc3_ep - device side endpoint representation</span>
<span class="cm"> * @endpoint: usb endpoint</span>
<span class="cm"> * @request_list: list of requests for this endpoint</span>
<span class="cm"> * @req_queued: list of requests on this ep which have TRBs setup</span>
<span class="cm"> * @trb_pool: array of transaction buffers</span>
<span class="cm"> * @trb_pool_dma: dma address of @trb_pool</span>
<span class="cm"> * @free_slot: next slot which is going to be used</span>
<span class="cm"> * @busy_slot: first slot which is owned by HW</span>
<span class="cm"> * @desc: usb_endpoint_descriptor pointer</span>
<span class="cm"> * @dwc: pointer to DWC controller</span>
<span class="cm"> * @flags: endpoint flags (wedged, stalled, ...)</span>
<span class="cm"> * @current_trb: index of current used trb</span>
<span class="cm"> * @number: endpoint number (1 - 15)</span>
<span class="cm"> * @type: set to bmAttributes &amp; USB_ENDPOINT_XFERTYPE_MASK</span>
<span class="cm"> * @res_trans_idx: Resource transfer index</span>
<span class="cm"> * @interval: the intervall on which the ISOC transfer is started</span>
<span class="cm"> * @name: a human readable name e.g. ep1out-bulk</span>
<span class="cm"> * @direction: true for TX, false for RX</span>
<span class="cm"> * @stream_capable: true when streams are enabled</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_ep</span>		<span class="n">endpoint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">request_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">req_queued</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dwc3_trb</span>		<span class="o">*</span><span class="n">trb_pool</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">trb_pool_dma</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">free_slot</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">busy_slot</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ss_ep_comp_descriptor</span> <span class="o">*</span><span class="n">comp_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3</span>		<span class="o">*</span><span class="n">dwc</span><span class="p">;</span>

	<span class="kt">unsigned</span>		<span class="n">flags</span><span class="p">;</span>
<span class="cp">#define DWC3_EP_ENABLED		(1 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_EP_STALL		(1 &lt;&lt; 1)</span>
<span class="cp">#define DWC3_EP_WEDGE		(1 &lt;&lt; 2)</span>
<span class="cp">#define DWC3_EP_BUSY		(1 &lt;&lt; 4)</span>
<span class="cp">#define DWC3_EP_PENDING_REQUEST	(1 &lt;&lt; 5)</span>

	<span class="cm">/* This last one is specific to EP0 */</span>
<span class="cp">#define DWC3_EP0_DIR_IN		(1 &lt;&lt; 31)</span>

	<span class="kt">unsigned</span>		<span class="n">current_trb</span><span class="p">;</span>

	<span class="n">u8</span>			<span class="n">number</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">res_trans_idx</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">interval</span><span class="p">;</span>

	<span class="kt">char</span>			<span class="n">name</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>

	<span class="kt">unsigned</span>		<span class="n">direction</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">stream_capable</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">dwc3_phy</span> <span class="p">{</span>
	<span class="n">DWC3_PHY_UNKNOWN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">DWC3_PHY_USB3</span><span class="p">,</span>
	<span class="n">DWC3_PHY_USB2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">dwc3_ep0_next</span> <span class="p">{</span>
	<span class="n">DWC3_EP0_UNKNOWN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">DWC3_EP0_COMPLETE</span><span class="p">,</span>
	<span class="n">DWC3_EP0_NRDY_SETUP</span><span class="p">,</span>
	<span class="n">DWC3_EP0_NRDY_DATA</span><span class="p">,</span>
	<span class="n">DWC3_EP0_NRDY_STATUS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">dwc3_ep0_state</span> <span class="p">{</span>
	<span class="n">EP0_UNCONNECTED</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">EP0_SETUP_PHASE</span><span class="p">,</span>
	<span class="n">EP0_DATA_PHASE</span><span class="p">,</span>
	<span class="n">EP0_STATUS_PHASE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">dwc3_link_state</span> <span class="p">{</span>
	<span class="cm">/* In SuperSpeed */</span>
	<span class="n">DWC3_LINK_STATE_U0</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* in HS, means ON */</span>
	<span class="n">DWC3_LINK_STATE_U1</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">DWC3_LINK_STATE_U2</span>		<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span> <span class="cm">/* in HS, means SLEEP */</span>
	<span class="n">DWC3_LINK_STATE_U3</span>		<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span> <span class="cm">/* in HS, means SUSPEND */</span>
	<span class="n">DWC3_LINK_STATE_SS_DIS</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">DWC3_LINK_STATE_RX_DET</span>		<span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span> <span class="cm">/* in HS, means Early Suspend */</span>
	<span class="n">DWC3_LINK_STATE_SS_INACT</span>	<span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="n">DWC3_LINK_STATE_POLL</span>		<span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>
	<span class="n">DWC3_LINK_STATE_RECOV</span>		<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">DWC3_LINK_STATE_HRESET</span>		<span class="o">=</span> <span class="mh">0x09</span><span class="p">,</span>
	<span class="n">DWC3_LINK_STATE_CMPLY</span>		<span class="o">=</span> <span class="mh">0x0a</span><span class="p">,</span>
	<span class="n">DWC3_LINK_STATE_LPBK</span>		<span class="o">=</span> <span class="mh">0x0b</span><span class="p">,</span>
	<span class="n">DWC3_LINK_STATE_MASK</span>		<span class="o">=</span> <span class="mh">0x0f</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">dwc3_device_state</span> <span class="p">{</span>
	<span class="n">DWC3_DEFAULT_STATE</span><span class="p">,</span>
	<span class="n">DWC3_ADDRESS_STATE</span><span class="p">,</span>
	<span class="n">DWC3_CONFIGURED_STATE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* TRB Length, PCM and Status */</span>
<span class="cp">#define DWC3_TRB_SIZE_MASK	(0x00ffffff)</span>
<span class="cp">#define DWC3_TRB_SIZE_LENGTH(n)	((n) &amp; DWC3_TRB_SIZE_MASK)</span>
<span class="cp">#define DWC3_TRB_SIZE_PCM1(n)	(((n) &amp; 0x03) &lt;&lt; 24)</span>
<span class="cp">#define DWC3_TRB_SIZE_TRBSTS(n)	(((n) &amp; (0x0f &lt;&lt; 28) &gt;&gt; 28))</span>

<span class="cp">#define DWC3_TRBSTS_OK			0</span>
<span class="cp">#define DWC3_TRBSTS_MISSED_ISOC		1</span>
<span class="cp">#define DWC3_TRBSTS_SETUP_PENDING	2</span>

<span class="cm">/* TRB Control */</span>
<span class="cp">#define DWC3_TRB_CTRL_HWO		(1 &lt;&lt; 0)</span>
<span class="cp">#define DWC3_TRB_CTRL_LST		(1 &lt;&lt; 1)</span>
<span class="cp">#define DWC3_TRB_CTRL_CHN		(1 &lt;&lt; 2)</span>
<span class="cp">#define DWC3_TRB_CTRL_CSP		(1 &lt;&lt; 3)</span>
<span class="cp">#define DWC3_TRB_CTRL_TRBCTL(n)		(((n) &amp; 0x3f) &lt;&lt; 4)</span>
<span class="cp">#define DWC3_TRB_CTRL_ISP_IMI		(1 &lt;&lt; 10)</span>
<span class="cp">#define DWC3_TRB_CTRL_IOC		(1 &lt;&lt; 11)</span>
<span class="cp">#define DWC3_TRB_CTRL_SID_SOFN(n)	(((n) &amp; 0xffff) &lt;&lt; 14)</span>

<span class="cp">#define DWC3_TRBCTL_NORMAL		DWC3_TRB_CTRL_TRBCTL(1)</span>
<span class="cp">#define DWC3_TRBCTL_CONTROL_SETUP	DWC3_TRB_CTRL_TRBCTL(2)</span>
<span class="cp">#define DWC3_TRBCTL_CONTROL_STATUS2	DWC3_TRB_CTRL_TRBCTL(3)</span>
<span class="cp">#define DWC3_TRBCTL_CONTROL_STATUS3	DWC3_TRB_CTRL_TRBCTL(4)</span>
<span class="cp">#define DWC3_TRBCTL_CONTROL_DATA	DWC3_TRB_CTRL_TRBCTL(5)</span>
<span class="cp">#define DWC3_TRBCTL_ISOCHRONOUS_FIRST	DWC3_TRB_CTRL_TRBCTL(6)</span>
<span class="cp">#define DWC3_TRBCTL_ISOCHRONOUS		DWC3_TRB_CTRL_TRBCTL(7)</span>
<span class="cp">#define DWC3_TRBCTL_LINK_TRB		DWC3_TRB_CTRL_TRBCTL(8)</span>

<span class="cm">/**</span>
<span class="cm"> * struct dwc3_trb - transfer request block (hw format)</span>
<span class="cm"> * @bpl: DW0-3</span>
<span class="cm"> * @bph: DW4-7</span>
<span class="cm"> * @size: DW8-B</span>
<span class="cm"> * @trl: DWC-F</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dwc3_trb</span> <span class="p">{</span>
	<span class="n">u32</span>		<span class="n">bpl</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">bph</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">ctrl</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * dwc3_hwparams - copy of HWPARAMS registers</span>
<span class="cm"> * @hwparams0 - GHWPARAMS0</span>
<span class="cm"> * @hwparams1 - GHWPARAMS1</span>
<span class="cm"> * @hwparams2 - GHWPARAMS2</span>
<span class="cm"> * @hwparams3 - GHWPARAMS3</span>
<span class="cm"> * @hwparams4 - GHWPARAMS4</span>
<span class="cm"> * @hwparams5 - GHWPARAMS5</span>
<span class="cm"> * @hwparams6 - GHWPARAMS6</span>
<span class="cm"> * @hwparams7 - GHWPARAMS7</span>
<span class="cm"> * @hwparams8 - GHWPARAMS8</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dwc3_hwparams</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">hwparams0</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">hwparams1</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">hwparams2</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">hwparams3</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">hwparams4</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">hwparams5</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">hwparams6</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">hwparams7</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">hwparams8</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* HWPARAMS0 */</span>
<span class="cp">#define DWC3_MODE(n)		((n) &amp; 0x7)</span>

<span class="cp">#define DWC3_MODE_DEVICE	0</span>
<span class="cp">#define DWC3_MODE_HOST		1</span>
<span class="cp">#define DWC3_MODE_DRD		2</span>
<span class="cp">#define DWC3_MODE_HUB		3</span>

<span class="cp">#define DWC3_MDWIDTH(n)		(((n) &amp; 0xff00) &gt;&gt; 8)</span>

<span class="cm">/* HWPARAMS1 */</span>
<span class="cp">#define DWC3_NUM_INT(n)		(((n) &amp; (0x3f &lt;&lt; 15)) &gt;&gt; 15)</span>

<span class="cm">/* HWPARAMS7 */</span>
<span class="cp">#define DWC3_RAM1_DEPTH(n)	((n) &amp; 0xffff)</span>

<span class="k">struct</span> <span class="n">dwc3_request</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_request</span>	<span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3_ep</span>		<span class="o">*</span><span class="n">dep</span><span class="p">;</span>

	<span class="n">u8</span>			<span class="n">epnum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3_trb</span>		<span class="o">*</span><span class="n">trb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">trb_dma</span><span class="p">;</span>

	<span class="kt">unsigned</span>		<span class="n">direction</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">mapped</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">queued</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct dwc3 - representation of our controller</span>
<span class="cm"> * @ctrl_req: usb control request which is used for ep0</span>
<span class="cm"> * @ep0_trb: trb which is used for the ctrl_req</span>
<span class="cm"> * @ep0_bounce: bounce buffer for ep0</span>
<span class="cm"> * @setup_buf: used while precessing STD USB requests</span>
<span class="cm"> * @ctrl_req_addr: dma address of ctrl_req</span>
<span class="cm"> * @ep0_trb: dma address of ep0_trb</span>
<span class="cm"> * @ep0_usb_req: dummy req used while handling STD USB requests</span>
<span class="cm"> * @ep0_bounce_addr: dma address of ep0_bounce</span>
<span class="cm"> * @lock: for synchronizing</span>
<span class="cm"> * @dev: pointer to our struct device</span>
<span class="cm"> * @xhci: pointer to our xHCI child</span>
<span class="cm"> * @event_buffer_list: a list of event buffers</span>
<span class="cm"> * @gadget: device side representation of the peripheral controller</span>
<span class="cm"> * @gadget_driver: pointer to the gadget driver</span>
<span class="cm"> * @regs: base address for our registers</span>
<span class="cm"> * @regs_size: address space size</span>
<span class="cm"> * @irq: IRQ number</span>
<span class="cm"> * @num_event_buffers: calculated number of event buffers</span>
<span class="cm"> * @u1u2: only used on revisions &lt;1.83a for workaround</span>
<span class="cm"> * @maximum_speed: maximum speed requested (mainly for testing purposes)</span>
<span class="cm"> * @revision: revision register contents</span>
<span class="cm"> * @mode: mode of operation</span>
<span class="cm"> * @is_selfpowered: true when we are selfpowered</span>
<span class="cm"> * @three_stage_setup: set if we perform a three phase setup</span>
<span class="cm"> * @ep0_bounced: true when we used bounce buffer</span>
<span class="cm"> * @ep0_expect_in: true when we expect a DATA IN transfer</span>
<span class="cm"> * @start_config_issued: true when StartConfig command has been issued</span>
<span class="cm"> * @setup_packet_pending: true when there&#39;s a Setup Packet in FIFO. Workaround</span>
<span class="cm"> * @needs_fifo_resize: not all users might want fifo resizing, flag it</span>
<span class="cm"> * @resize_fifos: tells us it&#39;s ok to reconfigure our TxFIFO sizes.</span>
<span class="cm"> * @isoch_delay: wValue from Set Isochronous Delay request;</span>
<span class="cm"> * @u2sel: parameter from Set SEL request.</span>
<span class="cm"> * @u2pel: parameter from Set SEL request.</span>
<span class="cm"> * @u1sel: parameter from Set SEL request.</span>
<span class="cm"> * @u1pel: parameter from Set SEL request.</span>
<span class="cm"> * @ep0_next_event: hold the next expected event</span>
<span class="cm"> * @ep0state: state of endpoint zero</span>
<span class="cm"> * @link_state: link state</span>
<span class="cm"> * @speed: device speed (super, high, full, low)</span>
<span class="cm"> * @mem: points to start of memory which is used for this struct.</span>
<span class="cm"> * @hwparams: copy of hwparams registers</span>
<span class="cm"> * @root: debugfs root folder pointer</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dwc3</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_ctrlrequest</span>	<span class="o">*</span><span class="n">ctrl_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3_trb</span>		<span class="o">*</span><span class="n">ep0_trb</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">ep0_bounce</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="o">*</span><span class="n">setup_buf</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">ctrl_req_addr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">ep0_trb_addr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">ep0_bounce_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3_request</span>	<span class="n">ep0_usb_req</span><span class="p">;</span>
	<span class="cm">/* device lock */</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">platform_device</span>	<span class="o">*</span><span class="n">xhci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>		<span class="n">xhci_resources</span><span class="p">[</span><span class="n">DWC3_XHCI_RESOURCES_NUM</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">dwc3_event_buffer</span> <span class="o">**</span><span class="n">ev_buffs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3_ep</span>		<span class="o">*</span><span class="n">eps</span><span class="p">[</span><span class="n">DWC3_ENDPOINTS_NUM</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">usb_gadget</span>	<span class="n">gadget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">gadget_driver</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">size_t</span>			<span class="n">regs_size</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">num_event_buffers</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">u1u2</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">maximum_speed</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">revision</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">mode</span><span class="p">;</span>

<span class="cp">#define DWC3_REVISION_173A	0x5533173a</span>
<span class="cp">#define DWC3_REVISION_175A	0x5533175a</span>
<span class="cp">#define DWC3_REVISION_180A	0x5533180a</span>
<span class="cp">#define DWC3_REVISION_183A	0x5533183a</span>
<span class="cp">#define DWC3_REVISION_185A	0x5533185a</span>
<span class="cp">#define DWC3_REVISION_188A	0x5533188a</span>
<span class="cp">#define DWC3_REVISION_190A	0x5533190a</span>
<span class="cp">#define DWC3_REVISION_200A	0x5533200a</span>
<span class="cp">#define DWC3_REVISION_202A	0x5533202a</span>
<span class="cp">#define DWC3_REVISION_210A	0x5533210a</span>
<span class="cp">#define DWC3_REVISION_220A	0x5533220a</span>

	<span class="kt">unsigned</span>		<span class="n">is_selfpowered</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">three_stage_setup</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">ep0_bounced</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">ep0_expect_in</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">start_config_issued</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">setup_packet_pending</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">delayed_status</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">needs_fifo_resize</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">resize_fifos</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">dwc3_ep0_next</span>	<span class="n">ep0_next_event</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dwc3_ep0_state</span>	<span class="n">ep0state</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dwc3_link_state</span>	<span class="n">link_state</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dwc3_device_state</span>	<span class="n">dev_state</span><span class="p">;</span>

	<span class="n">u16</span>			<span class="n">isoch_delay</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">u2sel</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">u2pel</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">u1sel</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">u1pel</span><span class="p">;</span>

	<span class="n">u8</span>			<span class="n">speed</span><span class="p">;</span>

	<span class="kt">void</span>			<span class="o">*</span><span class="n">mem</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dwc3_hwparams</span>	<span class="n">hwparams</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">root</span><span class="p">;</span>

	<span class="n">u8</span>			<span class="n">test_mode</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">test_mode_nr</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* -------------------------------------------------------------------------- */</span>

<span class="cm">/* -------------------------------------------------------------------------- */</span>

<span class="k">struct</span> <span class="n">dwc3_event_type</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">is_devspec</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">type</span><span class="o">:</span><span class="mi">6</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">reserved8_31</span><span class="o">:</span><span class="mi">25</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define DWC3_DEPEVT_XFERCOMPLETE	0x01</span>
<span class="cp">#define DWC3_DEPEVT_XFERINPROGRESS	0x02</span>
<span class="cp">#define DWC3_DEPEVT_XFERNOTREADY	0x03</span>
<span class="cp">#define DWC3_DEPEVT_RXTXFIFOEVT		0x04</span>
<span class="cp">#define DWC3_DEPEVT_STREAMEVT		0x06</span>
<span class="cp">#define DWC3_DEPEVT_EPCMDCMPLT		0x07</span>

<span class="cm">/**</span>
<span class="cm"> * struct dwc3_event_depvt - Device Endpoint Events</span>
<span class="cm"> * @one_bit: indicates this is an endpoint event (not used)</span>
<span class="cm"> * @endpoint_number: number of the endpoint</span>
<span class="cm"> * @endpoint_event: The event we have:</span>
<span class="cm"> *	0x00	- Reserved</span>
<span class="cm"> *	0x01	- XferComplete</span>
<span class="cm"> *	0x02	- XferInProgress</span>
<span class="cm"> *	0x03	- XferNotReady</span>
<span class="cm"> *	0x04	- RxTxFifoEvt (IN-&gt;Underrun, OUT-&gt;Overrun)</span>
<span class="cm"> *	0x05	- Reserved</span>
<span class="cm"> *	0x06	- StreamEvt</span>
<span class="cm"> *	0x07	- EPCmdCmplt</span>
<span class="cm"> * @reserved11_10: Reserved, don&#39;t use.</span>
<span class="cm"> * @status: Indicates the status of the event. Refer to databook for</span>
<span class="cm"> *	more information.</span>
<span class="cm"> * @parameters: Parameters of the current event. Refer to databook for</span>
<span class="cm"> *	more information.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dwc3_event_depevt</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">one_bit</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">endpoint_number</span><span class="o">:</span><span class="mi">5</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">endpoint_event</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">reserved11_10</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">status</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>

<span class="cm">/* Within XferNotReady */</span>
<span class="cp">#define DEPEVT_STATUS_TRANSFER_ACTIVE	(1 &lt;&lt; 3)</span>

<span class="cm">/* Within XferComplete */</span>
<span class="cp">#define DEPEVT_STATUS_BUSERR	(1 &lt;&lt; 0)</span>
<span class="cp">#define DEPEVT_STATUS_SHORT	(1 &lt;&lt; 1)</span>
<span class="cp">#define DEPEVT_STATUS_IOC	(1 &lt;&lt; 2)</span>
<span class="cp">#define DEPEVT_STATUS_LST	(1 &lt;&lt; 3)</span>

<span class="cm">/* Stream event only */</span>
<span class="cp">#define DEPEVT_STREAMEVT_FOUND		1</span>
<span class="cp">#define DEPEVT_STREAMEVT_NOTFOUND	2</span>

<span class="cm">/* Control-only Status */</span>
<span class="cp">#define DEPEVT_STATUS_CONTROL_SETUP	0</span>
<span class="cp">#define DEPEVT_STATUS_CONTROL_DATA	1</span>
<span class="cp">#define DEPEVT_STATUS_CONTROL_STATUS	2</span>

	<span class="n">u32</span>	<span class="n">parameters</span><span class="o">:</span><span class="mi">16</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * struct dwc3_event_devt - Device Events</span>
<span class="cm"> * @one_bit: indicates this is a non-endpoint event (not used)</span>
<span class="cm"> * @device_event: indicates it&#39;s a device event. Should read as 0x00</span>
<span class="cm"> * @type: indicates the type of device event.</span>
<span class="cm"> *	0	- DisconnEvt</span>
<span class="cm"> *	1	- USBRst</span>
<span class="cm"> *	2	- ConnectDone</span>
<span class="cm"> *	3	- ULStChng</span>
<span class="cm"> *	4	- WkUpEvt</span>
<span class="cm"> *	5	- Reserved</span>
<span class="cm"> *	6	- EOPF</span>
<span class="cm"> *	7	- SOF</span>
<span class="cm"> *	8	- Reserved</span>
<span class="cm"> *	9	- ErrticErr</span>
<span class="cm"> *	10	- CmdCmplt</span>
<span class="cm"> *	11	- EvntOverflow</span>
<span class="cm"> *	12	- VndrDevTstRcved</span>
<span class="cm"> * @reserved15_12: Reserved, not used</span>
<span class="cm"> * @event_info: Information about this event</span>
<span class="cm"> * @reserved31_24: Reserved, not used</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dwc3_event_devt</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">one_bit</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">device_event</span><span class="o">:</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">type</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">reserved15_12</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">event_info</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">reserved31_24</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * struct dwc3_event_gevt - Other Core Events</span>
<span class="cm"> * @one_bit: indicates this is a non-endpoint event (not used)</span>
<span class="cm"> * @device_event: indicates it&#39;s (0x03) Carkit or (0x04) I2C event.</span>
<span class="cm"> * @phy_port_number: self-explanatory</span>
<span class="cm"> * @reserved31_12: Reserved, not used.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dwc3_event_gevt</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">one_bit</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">device_event</span><span class="o">:</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">phy_port_number</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">reserved31_12</span><span class="o">:</span><span class="mi">20</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * union dwc3_event - representation of Event Buffer contents</span>
<span class="cm"> * @raw: raw 32-bit event</span>
<span class="cm"> * @type: the type of the event</span>
<span class="cm"> * @depevt: Device Endpoint Event</span>
<span class="cm"> * @devt: Device Event</span>
<span class="cm"> * @gevt: Global Event</span>
<span class="cm"> */</span>
<span class="k">union</span> <span class="n">dwc3_event</span> <span class="p">{</span>
	<span class="n">u32</span>				<span class="n">raw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3_event_type</span>		<span class="n">type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3_event_depevt</span>	<span class="n">depevt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3_event_devt</span>		<span class="n">devt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3_event_gevt</span>		<span class="n">gevt</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * DWC3 Features to be used as Driver Data</span>
<span class="cm"> */</span>

<span class="cp">#define DWC3_HAS_PERIPHERAL		BIT(0)</span>
<span class="cp">#define DWC3_HAS_XHCI			BIT(1)</span>
<span class="cp">#define DWC3_HAS_OTG			BIT(3)</span>

<span class="cm">/* prototypes */</span>
<span class="kt">void</span> <span class="n">dwc3_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">dwc3_gadget_resize_tx_fifos</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">dwc3_host_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">dwc3_host_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">dwc3_gadget_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">dwc3_gadget_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">dwc3_get_device_id</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">dwc3_put_device_id</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* __DRIVERS_USB_DWC3_CORE_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
