<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › dwc3 › gadget.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>gadget.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * gadget.c - DesignWare USB3 DRD Controller Gadget Framework Link</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010-2011 Texas Instruments Incorporated - http://www.ti.com</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Felipe Balbi &lt;balbi@ti.com&gt;,</span>
<span class="cm"> *	    Sebastian Andrzej Siewior &lt;bigeasy@linutronix.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions, and the following disclaimer,</span>
<span class="cm"> *    without modification.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *    documentation and/or other materials provided with the distribution.</span>
<span class="cm"> * 3. The names of the above-listed copyright holders may not be used</span>
<span class="cm"> *    to endorse or promote products derived from this software without</span>
<span class="cm"> *    specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * ALTERNATIVELY, this software may be distributed under the terms of the</span>
<span class="cm"> * GNU General Public License (&quot;GPL&quot;) version 2, as published by the Free</span>
<span class="cm"> * Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS</span>
<span class="cm"> * IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,</span>
<span class="cm"> * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR</span>
<span class="cm"> * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR</span>
<span class="cm"> * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,</span>
<span class="cm"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,</span>
<span class="cm"> * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR</span>
<span class="cm"> * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF</span>
<span class="cm"> * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
<span class="cm"> * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="cm"> * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>

<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>

<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;gadget.h&quot;</span>
<span class="cp">#include &quot;io.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * dwc3_gadget_set_test_mode - Enables USB2 Test Modes</span>
<span class="cm"> * @dwc: pointer to our context structure</span>
<span class="cm"> * @mode: the mode to set (J, K SE0 NAK, Force Enable)</span>
<span class="cm"> *</span>
<span class="cm"> * Caller should take care of locking. This function will</span>
<span class="cm"> * return 0 on success or -EINVAL if wrong Test Selector</span>
<span class="cm"> * is passed</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dwc3_gadget_set_test_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>		<span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCTL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DWC3_DCTL_TSTCTRL_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TEST_J</span>:
	<span class="k">case</span> <span class="n">TEST_K</span>:
	<span class="k">case</span> <span class="n">TEST_SE0_NAK</span>:
	<span class="k">case</span> <span class="n">TEST_PACKET</span>:
	<span class="k">case</span> <span class="n">TEST_FORCE_EN</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">mode</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dwc3_gadget_set_link_state - Sets USB Link to a particular State</span>
<span class="cm"> * @dwc: pointer to our context structure</span>
<span class="cm"> * @state: the state to put link into</span>
<span class="cm"> *</span>
<span class="cm"> * Caller should take care of locking. This function will</span>
<span class="cm"> * return 0 on success or -ETIMEDOUT.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dwc3_gadget_set_link_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dwc3_link_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">retries</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCTL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DWC3_DCTL_ULSTCHNGREQ_MASK</span><span class="p">;</span>

	<span class="cm">/* set requested state */</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">DWC3_DCTL_ULSTCHNGREQ</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* wait for a change in DSTS */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DSTS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">DWC3_DSTS_USBLNKST</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">==</span> <span class="n">state</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link state change request timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dwc3_gadget_resize_tx_fifos - reallocate fifo spaces for current use-case</span>
<span class="cm"> * @dwc: pointer to our context structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function will a best effort FIFO allocation in order</span>
<span class="cm"> * to improve FIFO usage and throughput, while still allowing</span>
<span class="cm"> * us to enable as many endpoints as possible.</span>
<span class="cm"> *</span>
<span class="cm"> * Keep in mind that this operation will be highly dependent</span>
<span class="cm"> * on the configured size for RAM1 - which contains TxFifo -,</span>
<span class="cm"> * the amount of endpoints enabled on coreConsultant tool, and</span>
<span class="cm"> * the width of the Master Bus.</span>
<span class="cm"> *</span>
<span class="cm"> * In the ideal world, we would always be able to satisfy the</span>
<span class="cm"> * following equation:</span>
<span class="cm"> *</span>
<span class="cm"> * ((512 + 2 * MDWIDTH-Bytes) + (Number of IN Endpoints - 1) * \</span>
<span class="cm"> * (3 * (1024 + MDWIDTH-Bytes) + MDWIDTH-Bytes)) / MDWIDTH-Bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Unfortunately, due to many variables that&#39;s not always the case.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dwc3_gadget_resize_tx_fifos</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">last_fifo_depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ram1_depth</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">fifo_size</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">mdwidth</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">needs_fifo_resize</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ram1_depth</span> <span class="o">=</span> <span class="n">DWC3_RAM1_DEPTH</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">hwparams</span><span class="p">.</span><span class="n">hwparams7</span><span class="p">);</span>
	<span class="n">mdwidth</span> <span class="o">=</span> <span class="n">DWC3_MDWIDTH</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">hwparams</span><span class="p">.</span><span class="n">hwparams0</span><span class="p">);</span>

	<span class="cm">/* MDWIDTH is represented in bits, we need it in bytes */</span>
	<span class="n">mdwidth</span> <span class="o">&gt;&gt;=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME For now we will only allocate 1 wMaxPacketSize space</span>
<span class="cm">	 * for each enabled endpoint, later patches will come to</span>
<span class="cm">	 * improve this algorithm so that we better use the internal</span>
<span class="cm">	 * FIFO space</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="n">DWC3_ENDPOINTS_NUM</span><span class="p">;</span> <span class="n">num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dwc3_ep</span>	<span class="o">*</span><span class="n">dep</span> <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
		<span class="kt">int</span>		<span class="n">fifo_number</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="kt">int</span>		<span class="n">mult</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="kt">int</span>		<span class="n">tmp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DWC3_EP_ENABLED</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_xfer_bulk</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span>
				<span class="o">||</span> <span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">))</span>
			<span class="n">mult</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * REVISIT: the following assumes we will always have enough</span>
<span class="cm">		 * space available on the FIFO RAM for all possible use cases.</span>
<span class="cm">		 * Make sure that&#39;s true somehow and change FIFO allocation</span>
<span class="cm">		 * accordingly.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If we have Bulk or Isochronous endpoints, we want</span>
<span class="cm">		 * them to be able to be very, very fast. So we&#39;re giving</span>
<span class="cm">		 * those endpoints a fifo_size which is enough for 3 full</span>
<span class="cm">		 * packets</span>
<span class="cm">		 */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">mult</span> <span class="o">*</span> <span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">+</span> <span class="n">mdwidth</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">+=</span> <span class="n">mdwidth</span><span class="p">;</span>

		<span class="n">fifo_size</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">mdwidth</span><span class="p">);</span>

		<span class="n">fifo_size</span> <span class="o">|=</span> <span class="p">(</span><span class="n">last_fifo_depth</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Fifo Addr %04x Size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">last_fifo_depth</span><span class="p">,</span> <span class="n">fifo_size</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>

		<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GTXFIFOSIZ</span><span class="p">(</span><span class="n">fifo_number</span><span class="p">),</span>
				<span class="n">fifo_size</span><span class="p">);</span>

		<span class="n">last_fifo_depth</span> <span class="o">+=</span> <span class="p">(</span><span class="n">fifo_size</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dwc3_gadget_giveback</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dwc3_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3</span>			<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queued</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">num_mapped_sgs</span><span class="p">)</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">busy_slot</span> <span class="o">+=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">num_mapped_sgs</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">busy_slot</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Skip LINK TRB. We can&#39;t use req-&gt;trb and check for</span>
<span class="cm">		 * DWC3_TRBCTL_LINK_TRB because it points the TRB we just</span>
<span class="cm">		 * completed (not the LINK TRB).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">busy_slot</span> <span class="o">&amp;</span> <span class="n">DWC3_TRB_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">DWC3_TRB_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">))</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">busy_slot</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">trb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">usb_gadget_unmap_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request %p from %s completed %d/%d ===&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">actual</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">dwc3_gadget_ep_cmd_string</span><span class="p">(</span><span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DWC3_DEPCMD_DEPSTARTCFG</span>:
		<span class="k">return</span> <span class="s">&quot;Start New Configuration&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEPCMD_ENDTRANSFER</span>:
		<span class="k">return</span> <span class="s">&quot;End Transfer&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEPCMD_UPDATETRANSFER</span>:
		<span class="k">return</span> <span class="s">&quot;Update Transfer&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEPCMD_STARTTRANSFER</span>:
		<span class="k">return</span> <span class="s">&quot;Start Transfer&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEPCMD_CLEARSTALL</span>:
		<span class="k">return</span> <span class="s">&quot;Clear Stall&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEPCMD_SETSTALL</span>:
		<span class="k">return</span> <span class="s">&quot;Set Stall&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEPCMD_GETSEQNUMBER</span>:
		<span class="k">return</span> <span class="s">&quot;Get Data Sequence Number&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEPCMD_SETTRANSFRESOURCE</span>:
		<span class="k">return</span> <span class="s">&quot;Set Endpoint Transfer Resource&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEPCMD_SETEPCONFIG</span>:
		<span class="k">return</span> <span class="s">&quot;Set Endpoint Configuration&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="s">&quot;UNKNOWN command&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dwc3_send_gadget_generic_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">reg</span><span class="p">;</span>

	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DGCMDPAR</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DGCMD</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">|</span> <span class="n">DWC3_DGCMD_CMDACT</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DGCMD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">DWC3_DGCMD_CMDACT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Command Complete --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">DWC3_DGCMD_STATUS</span><span class="p">(</span><span class="n">reg</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * We can&#39;t sleep here, because it&#39;s also called from</span>
<span class="cm">		 * interrupt context.</span>
<span class="cm">		 */</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dwc3_send_gadget_ep_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ep</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dwc3_gadget_ep_cmd_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_ep</span>		<span class="o">*</span><span class="n">dep</span> <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">ep</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">timeout</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">reg</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: cmd &#39;%s&#39; params %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">dwc3_gadget_ep_cmd_string</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">param0</span><span class="p">,</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">param1</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">param2</span><span class="p">);</span>

	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DEPCMDPAR0</span><span class="p">(</span><span class="n">ep</span><span class="p">),</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">param0</span><span class="p">);</span>
	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DEPCMDPAR1</span><span class="p">(</span><span class="n">ep</span><span class="p">),</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">param1</span><span class="p">);</span>
	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DEPCMDPAR2</span><span class="p">(</span><span class="n">ep</span><span class="p">),</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">param2</span><span class="p">);</span>

	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DEPCMD</span><span class="p">(</span><span class="n">ep</span><span class="p">),</span> <span class="n">cmd</span> <span class="o">|</span> <span class="n">DWC3_DEPCMD_CMDACT</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DEPCMD</span><span class="p">(</span><span class="n">ep</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">DWC3_DEPCMD_CMDACT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Command Complete --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">DWC3_DEPCMD_STATUS</span><span class="p">(</span><span class="n">reg</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * We can&#39;t sleep here, because it is also called from</span>
<span class="cm">		 * interrupt context.</span>
<span class="cm">		 */</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dma_addr_t</span> <span class="nf">dwc3_trb_dma_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dwc3_trb</span> <span class="o">*</span><span class="n">trb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">trb</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">trb_pool</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">trb_pool_dma</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_alloc_trb_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3</span>		<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">trb_pool</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dep</span><span class="o">-&gt;</span><span class="n">trb_pool</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3_trb</span><span class="p">)</span> <span class="o">*</span> <span class="n">DWC3_TRB_NUM</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">trb_pool_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">trb_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate trb pool for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_free_trb_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3</span>		<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3_trb</span><span class="p">)</span> <span class="o">*</span> <span class="n">DWC3_TRB_NUM</span><span class="p">,</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">trb_pool</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">trb_pool_dma</span><span class="p">);</span>

	<span class="n">dep</span><span class="o">-&gt;</span><span class="n">trb_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dep</span><span class="o">-&gt;</span><span class="n">trb_pool_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_gadget_start_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_gadget_ep_cmd_params</span> <span class="n">params</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">cmd</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">DWC3_DEPCMD_DEPSTARTCFG</span><span class="p">;</span>
		<span class="cm">/* XferRscIdx == 0 for ep0 and 2 for the remaining */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">start_config_issued</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">start_config_issued</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">cmd</span> <span class="o">|=</span> <span class="n">DWC3_DEPCMD_PARAM</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">dwc3_send_gadget_ep_cmd</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_gadget_set_ep_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ss_ep_comp_descriptor</span> <span class="o">*</span><span class="n">comp_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_gadget_ep_cmd_params</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

	<span class="n">params</span><span class="p">.</span><span class="n">param0</span> <span class="o">=</span> <span class="n">DWC3_DEPCFG_EP_TYPE</span><span class="p">(</span><span class="n">usb_endpoint_type</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
		<span class="o">|</span> <span class="n">DWC3_DEPCFG_MAX_PACKET_SIZE</span><span class="p">(</span><span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
		<span class="o">|</span> <span class="n">DWC3_DEPCFG_BURST_SIZE</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">maxburst</span><span class="p">);</span>

	<span class="n">params</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">DWC3_DEPCFG_XFER_COMPLETE_EN</span>
		<span class="o">|</span> <span class="n">DWC3_DEPCFG_XFER_NOT_READY_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_ss_max_streams</span><span class="p">(</span><span class="n">comp_desc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">usb_endpoint_xfer_bulk</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">params</span><span class="p">.</span><span class="n">param1</span> <span class="o">|=</span> <span class="n">DWC3_DEPCFG_STREAM_CAPABLE</span>
			<span class="o">|</span> <span class="n">DWC3_DEPCFG_STREAM_EVENT_EN</span><span class="p">;</span>
		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">stream_capable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
		<span class="n">params</span><span class="p">.</span><span class="n">param1</span> <span class="o">|=</span> <span class="n">DWC3_DEPCFG_XFER_IN_PROGRESS_EN</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are doing 1:1 mapping for endpoints, meaning</span>
<span class="cm">	 * Physical Endpoints 2 maps to Logical Endpoint 2 and</span>
<span class="cm">	 * so on. We consider the direction bit as part of the physical</span>
<span class="cm">	 * endpoint number. So USB endpoint 0x81 is 0x03.</span>
<span class="cm">	 */</span>
	<span class="n">params</span><span class="p">.</span><span class="n">param1</span> <span class="o">|=</span> <span class="n">DWC3_DEPCFG_EP_NUMBER</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must use the lower 16 TX FIFOs even though</span>
<span class="cm">	 * HW might have more</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">)</span>
		<span class="n">params</span><span class="p">.</span><span class="n">param0</span> <span class="o">|=</span> <span class="n">DWC3_DEPCFG_FIFO_NUMBER</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">params</span><span class="p">.</span><span class="n">param1</span> <span class="o">|=</span> <span class="n">DWC3_DEPCFG_BINTERVAL_M1</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bInterval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bInterval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dwc3_send_gadget_ep_cmd</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
			<span class="n">DWC3_DEPCMD_SETEPCONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_gadget_set_xfer_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_gadget_ep_cmd_params</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

	<span class="n">params</span><span class="p">.</span><span class="n">param0</span> <span class="o">=</span> <span class="n">DWC3_DEPXFERCFG_NUM_XFER_RES</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dwc3_send_gadget_ep_cmd</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
			<span class="n">DWC3_DEPCMD_SETTRANSFRESOURCE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __dwc3_gadget_ep_enable - Initializes a HW endpoint</span>
<span class="cm"> * @dep: endpoint to be initialized</span>
<span class="cm"> * @desc: USB Endpoint Descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * Caller should take care of locking</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__dwc3_gadget_ep_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ss_ep_comp_descriptor</span> <span class="o">*</span><span class="n">comp_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3</span>		<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DWC3_EP_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_gadget_start_config</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_gadget_set_ep_config</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">comp_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DWC3_EP_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dwc3_trb</span>	<span class="o">*</span><span class="n">trb_st_hw</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">dwc3_trb</span>	<span class="o">*</span><span class="n">trb_link</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_gadget_set_xfer_resource</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">comp_desc</span> <span class="o">=</span> <span class="n">comp_desc</span><span class="p">;</span>
		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">usb_endpoint_type</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DWC3_EP_ENABLED</span><span class="p">;</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DALEPENA</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">DWC3_DALEPENA_EP</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DALEPENA</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trb_link</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">trb_link</span><span class="p">));</span>

		<span class="cm">/* Link TRB for ISOC. The HWO bit is never reset */</span>
		<span class="n">trb_st_hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">trb_pool</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">trb_link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">trb_pool</span><span class="p">[</span><span class="n">DWC3_TRB_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

		<span class="n">trb_link</span><span class="o">-&gt;</span><span class="n">bpl</span> <span class="o">=</span> <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">dwc3_trb_dma_offset</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">trb_st_hw</span><span class="p">));</span>
		<span class="n">trb_link</span><span class="o">-&gt;</span><span class="n">bph</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">dwc3_trb_dma_offset</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">trb_st_hw</span><span class="p">));</span>
		<span class="n">trb_link</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DWC3_TRBCTL_LINK_TRB</span><span class="p">;</span>
		<span class="n">trb_link</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DWC3_TRB_CTRL_HWO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">dwc3_stop_active_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">epnum</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_remove_requests</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_request</span>		<span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">req_queued</span><span class="p">))</span>
		<span class="n">dwc3_stop_active_transfer</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">next_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">);</span>

		<span class="n">dwc3_gadget_giveback</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __dwc3_gadget_ep_disable - Disables a HW endpoint</span>
<span class="cm"> * @dep: the endpoint to disable</span>
<span class="cm"> *</span>
<span class="cm"> * This function also removes requests which are currently processed ny the</span>
<span class="cm"> * hardware and those which are not yet scheduled.</span>
<span class="cm"> * Caller should take care of locking.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__dwc3_gadget_ep_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3</span>		<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">reg</span><span class="p">;</span>

	<span class="n">dwc3_remove_requests</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DALEPENA</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DWC3_DALEPENA_EP</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DALEPENA</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">dep</span><span class="o">-&gt;</span><span class="n">stream_capable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dep</span><span class="o">-&gt;</span><span class="n">comp_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dep</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_gadget_ep0_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_gadget_ep0_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_gadget_ep_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_ep</span>			<span class="o">*</span><span class="n">dep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3</span>			<span class="o">*</span><span class="n">dwc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span> <span class="o">||</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">!=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dwc3: invalid parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dwc3: missing wMaxPacketSize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dep</span> <span class="o">=</span> <span class="n">to_dwc3_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">usb_endpoint_type</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span>:
		<span class="n">strlcat</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;-control&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>:
		<span class="n">strlcat</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;-isoc&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>:
		<span class="n">strlcat</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;-bulk&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:
		<span class="n">strlcat</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;-int&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid endpoint transfer type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DWC3_EP_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_WARN_ONCE</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="s">&quot;%s is already enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Enabling %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__dwc3_gadget_ep_enable</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">comp_desc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_gadget_ep_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_ep</span>			<span class="o">*</span><span class="n">dep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3</span>			<span class="o">*</span><span class="n">dwc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dwc3: invalid parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dep</span> <span class="o">=</span> <span class="n">to_dwc3_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DWC3_EP_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_WARN_ONCE</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="s">&quot;%s is already disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;ep%d%s&quot;</span><span class="p">,</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__dwc3_gadget_ep_disable</span><span class="p">(</span><span class="n">dep</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="nf">dwc3_gadget_ep_alloc_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
	<span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_request</span>		<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3_ep</span>			<span class="o">*</span><span class="n">dep</span> <span class="o">=</span> <span class="n">to_dwc3_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dwc3</span>			<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;not enough memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">epnum</span>	<span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">dep</span>	<span class="o">=</span> <span class="n">dep</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_gadget_ep_free_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_request</span>		<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">to_dwc3_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dwc3_prepare_one_trb - setup one TRB from one request</span>
<span class="cm"> * @dep: endpoint for which this request is prepared</span>
<span class="cm"> * @req: dwc3_request pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_prepare_one_trb</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dwc3_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">length</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">last</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">chain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3</span>		<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3_trb</span>		<span class="o">*</span><span class="n">trb</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">cur_slot</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: req %p dma %08llx length %d%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dma</span><span class="p">,</span>
			<span class="n">length</span><span class="p">,</span> <span class="n">last</span> <span class="o">?</span> <span class="s">&quot; last&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">chain</span> <span class="o">?</span> <span class="s">&quot; chain&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">trb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">trb_pool</span><span class="p">[</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">free_slot</span> <span class="o">&amp;</span> <span class="n">DWC3_TRB_MASK</span><span class="p">];</span>
	<span class="n">cur_slot</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">free_slot</span><span class="p">;</span>
	<span class="n">dep</span><span class="o">-&gt;</span><span class="n">free_slot</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Skip the LINK-TRB on ISOC */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">cur_slot</span> <span class="o">&amp;</span> <span class="n">DWC3_TRB_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">DWC3_TRB_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">trb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dwc3_gadget_move_request_queued</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">trb</span> <span class="o">=</span> <span class="n">trb</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">trb_dma</span> <span class="o">=</span> <span class="n">dwc3_trb_dma_offset</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">trb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">trb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">DWC3_TRB_SIZE_LENGTH</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
	<span class="n">trb</span><span class="o">-&gt;</span><span class="n">bpl</span> <span class="o">=</span> <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">trb</span><span class="o">-&gt;</span><span class="n">bph</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">usb_endpoint_type</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span>:
		<span class="n">trb</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">DWC3_TRBCTL_CONTROL_SETUP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>:
		<span class="n">trb</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">DWC3_TRBCTL_ISOCHRONOUS_FIRST</span><span class="p">;</span>

		<span class="cm">/* IOC every DWC3_TRB_NUM / 4 so we can refill */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cur_slot</span> <span class="o">%</span> <span class="p">(</span><span class="n">DWC3_TRB_NUM</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)))</span>
			<span class="n">trb</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DWC3_TRB_CTRL_IOC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>:
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:
		<span class="n">trb</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">DWC3_TRBCTL_NORMAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * This is only possible with faulty memory because we</span>
<span class="cm">		 * checked it already :)</span>
<span class="cm">		 */</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">trb</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DWC3_TRB_CTRL_ISP_IMI</span><span class="p">;</span>
		<span class="n">trb</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DWC3_TRB_CTRL_CSP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chain</span><span class="p">)</span>
			<span class="n">trb</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DWC3_TRB_CTRL_CHN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
			<span class="n">trb</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DWC3_TRB_CTRL_LST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_xfer_bulk</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">stream_capable</span><span class="p">)</span>
		<span class="n">trb</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DWC3_TRB_CTRL_SID_SOFN</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">stream_id</span><span class="p">);</span>

	<span class="n">trb</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DWC3_TRB_CTRL_HWO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * dwc3_prepare_trbs - setup TRBs from requests</span>
<span class="cm"> * @dep: endpoint for which requests are being prepared</span>
<span class="cm"> * @starting: true if the endpoint is idle and no requests are queued.</span>
<span class="cm"> *</span>
<span class="cm"> * The function goes through the requests list and sets up TRBs for the</span>
<span class="cm"> * transfers. The function returns once there are no more TRBs available or</span>
<span class="cm"> * it runs out of requests.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_prepare_trbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">,</span> <span class="n">bool</span> <span class="n">starting</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">trbs_left</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">last_one</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON_NOT_POWER_OF_2</span><span class="p">(</span><span class="n">DWC3_TRB_NUM</span><span class="p">);</span>

	<span class="cm">/* the first request must not be queued */</span>
	<span class="n">trbs_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">busy_slot</span> <span class="o">-</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">free_slot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DWC3_TRB_MASK</span><span class="p">;</span>

	<span class="cm">/* Can&#39;t wrap around on a non-isoc EP since there&#39;s no link TRB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">DWC3_TRB_NUM</span> <span class="o">-</span> <span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">free_slot</span> <span class="o">&amp;</span> <span class="n">DWC3_TRB_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trbs_left</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
			<span class="n">trbs_left</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If busy &amp; slot are equal than it is either full or empty. If we are</span>
<span class="cm">	 * starting to process requests then we are empty. Otherwise we are</span>
<span class="cm">	 * full and don&#39;t do anything</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trbs_left</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">starting</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">trbs_left</span> <span class="o">=</span> <span class="n">DWC3_TRB_NUM</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * In case we start from scratch, we queue the ISOC requests</span>
<span class="cm">		 * starting from slot 1. This is done because we use ring</span>
<span class="cm">		 * buffer and have no LST bit to stop us. Instead, we place</span>
<span class="cm">		 * IOC bit every TRB_NUM/4. We try to avoid having an interrupt</span>
<span class="cm">		 * after the first request so we start at slot 1 and have</span>
<span class="cm">		 * 7 requests proceed before we hit the first IOC.</span>
<span class="cm">		 * Other transfer types don&#39;t use the ring buffer and are</span>
<span class="cm">		 * processed from the first TRB until the last one. Since we</span>
<span class="cm">		 * don&#39;t wrap around we have to start at the beginning.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">busy_slot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">free_slot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">busy_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">free_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* The last TRB is a link TRB, not used for xfer */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">trbs_left</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span>	<span class="n">length</span><span class="p">;</span>
		<span class="n">dma_addr_t</span>	<span class="n">dma</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">num_mapped_sgs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
			<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>

			<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">num_mapped_sgs</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="n">chain</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="n">length</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
				<span class="n">dma</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">num_mapped_sgs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
						<span class="n">sg_is_last</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">last_one</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">chain</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">trbs_left</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trbs_left</span><span class="p">)</span>
					<span class="n">last_one</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">last_one</span><span class="p">)</span>
					<span class="n">chain</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

				<span class="n">dwc3_prepare_one_trb</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
						<span class="n">last_one</span><span class="p">,</span> <span class="n">chain</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">last_one</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dma</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">dma</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
			<span class="n">trbs_left</span><span class="o">--</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trbs_left</span><span class="p">)</span>
				<span class="n">last_one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* Is this the last request? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">))</span>
				<span class="n">last_one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">dwc3_prepare_one_trb</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
					<span class="n">last_one</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">last_one</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__dwc3_gadget_kick_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd_param</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">start_new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_gadget_ep_cmd_params</span> <span class="n">params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3_request</span>		<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3</span>			<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_new</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DWC3_EP_BUSY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: endpoint busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DWC3_EP_PENDING_REQUEST</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are getting here after a short-out-packet we don&#39;t enqueue any</span>
<span class="cm">	 * new requests as we try to set the IOC bit only on the last request.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start_new</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">req_queued</span><span class="p">))</span>
			<span class="n">dwc3_prepare_trbs</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">start_new</span><span class="p">);</span>

		<span class="cm">/* req points to the first request which will be sent */</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">next_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">req_queued</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dwc3_prepare_trbs</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">start_new</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * req points to the first request where HWO changed from 0 to 1</span>
<span class="cm">		 */</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">next_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">req_queued</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DWC3_EP_PENDING_REQUEST</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
	<span class="n">params</span><span class="p">.</span><span class="n">param0</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">trb_dma</span><span class="p">);</span>
	<span class="n">params</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">trb_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_new</span><span class="p">)</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">DWC3_DEPCMD_STARTTRANSFER</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">DWC3_DEPCMD_UPDATETRANSFER</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">|=</span> <span class="n">DWC3_DEPCMD_PARAM</span><span class="p">(</span><span class="n">cmd_param</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_send_gadget_ep_cmd</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to send STARTTRANSFER command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * FIXME we need to iterate over the list of requests</span>
<span class="cm">		 * here and stop, unmap, free and del each of the linked</span>
<span class="cm">		 * requests instead of what we do now.</span>
<span class="cm">		 */</span>
		<span class="n">usb_gadget_unmap_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DWC3_EP_BUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">res_trans_idx</span> <span class="o">=</span> <span class="n">dwc3_gadget_ep_get_transfer_index</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span>
				<span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">res_trans_idx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__dwc3_gadget_ep_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dwc3_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3</span>		<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ret</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">actual</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">status</span>	<span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">direction</span>		<span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">epnum</span>		<span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We only add to our list of requests now and</span>
<span class="cm">	 * start consuming the list once we get XferNotReady</span>
<span class="cm">	 * IRQ.</span>
<span class="cm">	 *</span>
<span class="cm">	 * That way, we avoid doing anything that we don&#39;t need</span>
<span class="cm">	 * to do now and defer it until the point we receive a</span>
<span class="cm">	 * particular token from the Host side.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This will also avoid Host cancelling URBs due to too</span>
<span class="cm">	 * many NAKs.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_gadget_map_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DWC3_EP_BUSY</span><span class="p">))</span>
		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DWC3_EP_PENDING_REQUEST</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * There are two special cases:</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1. XferNotReady with empty list of requests. We need to kick the</span>
<span class="cm">	 *    transfer here in that situation, otherwise we will be NAKing</span>
<span class="cm">	 *    forever. If we get XferNotReady before gadget driver has a</span>
<span class="cm">	 *    chance to queue a request, we will ACK the IRQ but won&#39;t be</span>
<span class="cm">	 *    able to receive the data until the next request is queued.</span>
<span class="cm">	 *    The following code is handling exactly that.</span>
<span class="cm">	 *</span>
<span class="cm">	 * 2. XferInProgress on Isoc EP with an active transfer. We need to</span>
<span class="cm">	 *    kick the transfer here after queuing a request, otherwise the</span>
<span class="cm">	 *    core may not see the modified TRB(s).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DWC3_EP_PENDING_REQUEST</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">ret</span><span class="p">;</span>
		<span class="kt">int</span>	<span class="n">start_trans</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">u8</span>	<span class="n">trans_idx</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">res_trans_idx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DWC3_EP_BUSY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">start_trans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">trans_idx</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">trans_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">__dwc3_gadget_kick_transfer</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">trans_idx</span><span class="p">,</span> <span class="n">start_trans</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dwc3</span>	<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: failed to kick transfers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_gadget_ep_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
	<span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_request</span>		<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">to_dwc3_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dwc3_ep</span>			<span class="o">*</span><span class="n">dep</span> <span class="o">=</span> <span class="n">to_dwc3_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dwc3</span>			<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">flags</span><span class="p">;</span>

	<span class="kt">int</span>				<span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;trying to queue request %p to disabled %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">request</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;queing request %p to %s length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">request</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__dwc3_gadget_ep_queue</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_gadget_ep_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_request</span>		<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">to_dwc3_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dwc3_request</span>		<span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dwc3_ep</span>			<span class="o">*</span><span class="n">dep</span> <span class="o">=</span> <span class="n">to_dwc3_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dwc3</span>			<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">req</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">req_queued</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">req</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">req</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* wait until it is processed */</span>
			<span class="n">dwc3_stop_active_transfer</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request %p was not queued to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">request</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out1:</span>
	<span class="cm">/* giveback the request */</span>
	<span class="n">dwc3_gadget_giveback</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">);</span>

<span class="nl">out0:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__dwc3_gadget_ep_set_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_gadget_ep_cmd_params</span>	<span class="n">params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3</span>				<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>
	<span class="kt">int</span>					<span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Whenever EP0 is stalled, we will restart</span>
<span class="cm">			 * the state machine, thus moving back to</span>
<span class="cm">			 * Setup Phase</span>
<span class="cm">			 */</span>
			<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_SETUP_PHASE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_send_gadget_ep_cmd</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
			<span class="n">DWC3_DEPCMD_SETSTALL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to %s STALL on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">value</span> <span class="o">?</span> <span class="s">&quot;set&quot;</span> <span class="o">:</span> <span class="s">&quot;clear&quot;</span><span class="p">,</span>
					<span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DWC3_EP_STALL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DWC3_EP_WEDGE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_send_gadget_ep_cmd</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
			<span class="n">DWC3_DEPCMD_CLEARSTALL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to %s STALL on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">value</span> <span class="o">?</span> <span class="s">&quot;set&quot;</span> <span class="o">:</span> <span class="s">&quot;clear&quot;</span><span class="p">,</span>
					<span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DWC3_EP_STALL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_gadget_ep_set_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_ep</span>			<span class="o">*</span><span class="n">dep</span> <span class="o">=</span> <span class="n">to_dwc3_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dwc3</span>			<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">flags</span><span class="p">;</span>

	<span class="kt">int</span>				<span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s is of Isochronous type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__dwc3_gadget_ep_set_halt</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_gadget_ep_set_wedge</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_ep</span>			<span class="o">*</span><span class="n">dep</span> <span class="o">=</span> <span class="n">to_dwc3_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dwc3</span>			<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DWC3_EP_WEDGE</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dwc3_gadget_ep_set_halt</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">dwc3_gadget_ep0_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span>	<span class="o">=</span> <span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span>	<span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">dwc3_gadget_ep0_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">dwc3_gadget_ep0_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">dwc3_gadget_ep0_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_request</span>	<span class="o">=</span> <span class="n">dwc3_gadget_ep_alloc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_request</span>	<span class="o">=</span> <span class="n">dwc3_gadget_ep_free_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queue</span>		<span class="o">=</span> <span class="n">dwc3_gadget_ep0_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue</span>	<span class="o">=</span> <span class="n">dwc3_gadget_ep_dequeue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_halt</span>	<span class="o">=</span> <span class="n">dwc3_gadget_ep_set_halt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wedge</span>	<span class="o">=</span> <span class="n">dwc3_gadget_ep_set_wedge</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">dwc3_gadget_ep_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">dwc3_gadget_ep_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">dwc3_gadget_ep_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_request</span>	<span class="o">=</span> <span class="n">dwc3_gadget_ep_alloc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_request</span>	<span class="o">=</span> <span class="n">dwc3_gadget_ep_free_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queue</span>		<span class="o">=</span> <span class="n">dwc3_gadget_ep_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue</span>	<span class="o">=</span> <span class="n">dwc3_gadget_ep_dequeue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_halt</span>	<span class="o">=</span> <span class="n">dwc3_gadget_ep_set_halt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wedge</span>	<span class="o">=</span> <span class="n">dwc3_gadget_ep_set_wedge</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* -------------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_gadget_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">g</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3</span>		<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">gadget_to_dwc</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
	<span class="n">u32</span>			<span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DSTS</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">DWC3_DSTS_SOFFN</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_gadget_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">g</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3</span>		<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">gadget_to_dwc</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">reg</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">u8</span>			<span class="n">link_state</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">speed</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * According to the Databook Remote wakeup request should</span>
<span class="cm">	 * be issued only when the device is in early suspend state.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We can check that via USB Link State bits in DSTS register.</span>
<span class="cm">	 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DSTS</span><span class="p">);</span>

	<span class="n">speed</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">DWC3_DSTS_CONNECTSPD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">DWC3_DSTS_SUPERSPEED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no wakeup on SuperSpeed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">link_state</span> <span class="o">=</span> <span class="n">DWC3_DSTS_USBLNKST</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">link_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DWC3_LINK_STATE_RX_DET</span>:	<span class="cm">/* in HS, means Early Suspend */</span>
	<span class="k">case</span> <span class="n">DWC3_LINK_STATE_U3</span>:	<span class="cm">/* in HS, means SUSPEND */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t wakeup from link state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">link_state</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_gadget_set_link_state</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">DWC3_LINK_STATE_RECOV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to put link in Recovery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* write zeroes to Link Change Request */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DWC3_DCTL_ULSTCHNGREQ_MASK</span><span class="p">;</span>
	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* poll until Link State changes to ON */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DSTS</span><span class="p">);</span>

		<span class="cm">/* in HS, means ON */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DWC3_DSTS_USBLNKST</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">==</span> <span class="n">DWC3_LINK_STATE_U0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DWC3_DSTS_USBLNKST</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DWC3_LINK_STATE_U0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to send remote wakeup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_gadget_set_selfpowered</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">is_selfpowered</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3</span>		<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">gadget_to_dwc</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">is_selfpowered</span> <span class="o">=</span> <span class="o">!!</span><span class="n">is_selfpowered</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_gadget_run_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>			<span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">timeout</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DWC3_DCTL_TRGTULST_MASK</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DWC3_DCTL_RUN_STOP</span>
				<span class="o">|</span> <span class="n">DWC3_DCTL_TRGTULST_RX_DET</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DWC3_DCTL_RUN_STOP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DSTS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_on</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">DWC3_DSTS_DEVCTRLHLT</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">DWC3_DSTS_DEVCTRLHLT</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gadget %s data soft-%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget_driver</span>
			<span class="o">?</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget_driver</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">:</span> <span class="s">&quot;no-function&quot;</span><span class="p">,</span>
			<span class="n">is_on</span> <span class="o">?</span> <span class="s">&quot;connect&quot;</span> <span class="o">:</span> <span class="s">&quot;disconnect&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_gadget_pullup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3</span>		<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">gadget_to_dwc</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">is_on</span> <span class="o">=</span> <span class="o">!!</span><span class="n">is_on</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dwc3_gadget_run_stop</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">is_on</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_gadget_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3</span>		<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">gadget_to_dwc</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dwc3_ep</span>		<span class="o">*</span><span class="n">dep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">reg</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget_driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s is already bound to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
				<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget_driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget_driver</span>	<span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCFG</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DWC3_DCFG_SPEED_MASK</span><span class="p">);</span>

	<span class="cm">/**</span>
<span class="cm">	 * WORKAROUND: DWC3 revision &lt; 2.20a have an issue</span>
<span class="cm">	 * which would cause metastability state on Run/Stop</span>
<span class="cm">	 * bit if we try to force the IP to USB2-only mode.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Because of that, we cannot configure the IP to any</span>
<span class="cm">	 * speed other than the SuperSpeed</span>
<span class="cm">	 *</span>
<span class="cm">	 * Refers to:</span>
<span class="cm">	 *</span>
<span class="cm">	 * STAR#9000525659: Clock Domain Crossing on DCTL in</span>
<span class="cm">	 * USB 2.0 Mode</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="n">DWC3_REVISION_220A</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">DWC3_DCFG_SUPERSPEED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">maximum_speed</span><span class="p">;</span>
	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">start_config_issued</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Start with SuperSpeed Default */</span>
	<span class="n">dwc3_gadget_ep0_desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">512</span><span class="p">);</span>

	<span class="n">dep</span> <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__dwc3_gadget_ep_enable</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwc3_gadget_ep0_desc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to enable %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dep</span> <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__dwc3_gadget_ep_enable</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwc3_gadget_ep0_desc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to enable %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* begin to receive SETUP packets */</span>
	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0state</span> <span class="o">=</span> <span class="n">EP0_SETUP_PHASE</span><span class="p">;</span>
	<span class="n">dwc3_ep0_out_start</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err1:</span>
	<span class="n">__dwc3_gadget_ep_disable</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

<span class="nl">err0:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_gadget_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3</span>		<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">gadget_to_dwc</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">__dwc3_gadget_ep_disable</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">__dwc3_gadget_ep_disable</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget_driver</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_gadget_ops</span> <span class="n">dwc3_gadget_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_frame</span>		<span class="o">=</span> <span class="n">dwc3_gadget_get_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wakeup</span>			<span class="o">=</span> <span class="n">dwc3_gadget_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_selfpowered</span>	<span class="o">=</span> <span class="n">dwc3_gadget_set_selfpowered</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pullup</span>			<span class="o">=</span> <span class="n">dwc3_gadget_pullup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_start</span>		<span class="o">=</span> <span class="n">dwc3_gadget_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_stop</span>		<span class="o">=</span> <span class="n">dwc3_gadget_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* -------------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">dwc3_gadget_init_endpoints</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_ep</span>			<span class="o">*</span><span class="n">dep</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="n">epnum</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">epnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">epnum</span> <span class="o">&lt;</span> <span class="n">DWC3_ENDPOINTS_NUM</span><span class="p">;</span> <span class="n">epnum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dep</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dep</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dep</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t allocate endpoint %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">epnum</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">dwc</span><span class="p">;</span>
		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">epnum</span><span class="p">;</span>
		<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">epnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">dep</span><span class="p">;</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;ep%d%s&quot;</span><span class="p">,</span> <span class="n">epnum</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
				<span class="p">(</span><span class="n">epnum</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">);</span>
		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="p">(</span><span class="n">epnum</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">epnum</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">epnum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dwc3_gadget_ep0_ops</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">epnum</span><span class="p">)</span>
				<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span>		<span class="n">ret</span><span class="p">;</span>

			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">max_streams</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dwc3_gadget_ep_ops</span><span class="p">;</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_alloc_trb_pool</span><span class="p">(</span><span class="n">dep</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">req_queued</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_gadget_free_endpoints</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_ep</span>			<span class="o">*</span><span class="n">dep</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="n">epnum</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">epnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">epnum</span> <span class="o">&lt;</span> <span class="n">DWC3_ENDPOINTS_NUM</span><span class="p">;</span> <span class="n">epnum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dep</span> <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">epnum</span><span class="p">];</span>
		<span class="n">dwc3_free_trb_pool</span><span class="p">(</span><span class="n">dep</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">epnum</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">epnum</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">dep</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_gadget_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_cleanup_done_reqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">dwc3_event_depevt</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3_trb</span>		<span class="o">*</span><span class="n">trb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">s_pkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">next_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">req_queued</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">trb</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">trb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">trb</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">DWC3_TRB_CTRL_HWO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * We continue despite the error. There is not much we</span>
<span class="cm">			 * can do. If we don&#39;t clean it up we loop forever. If</span>
<span class="cm">			 * we skip the TRB then it gets overwritten after a</span>
<span class="cm">			 * while since we use them in a ring buffer. A BUG()</span>
<span class="cm">			 * would help. Lets hope that if this occurs, someone</span>
<span class="cm">			 * fixes the root cause instead of looking away :)</span>
<span class="cm">			 */</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s&#39;s TRB (%p) still owned by HW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">trb</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">trb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&amp;</span> <span class="n">DWC3_TRB_SIZE_MASK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;incomplete IN transfer %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DEPEVT_STATUS_SHORT</span><span class="p">))</span>
				<span class="n">s_pkt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * We assume here we will always receive the entire data block</span>
<span class="cm">		 * which we should receive. Meaning, if we program RX to</span>
<span class="cm">		 * receive 4K but we receive only 2K, we assume that&#39;s all we</span>
<span class="cm">		 * should receive and we simply bounce the request back to the</span>
<span class="cm">		 * gadget driver for further processing.</span>
<span class="cm">		 */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">dwc3_gadget_giveback</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s_pkt</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DEPEVT_STATUS_LST</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">trb</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">DWC3_TRB_CTRL_LST</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DEPEVT_STATUS_IOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">trb</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">DWC3_TRB_CTRL_IOC</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DEPEVT_STATUS_IOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">trb</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">DWC3_TRB_CTRL_IOC</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_endpoint_transfer_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dwc3_event_depevt</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">start_new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">clean_busy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DEPEVT_STATUS_BUSERR</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>

	<span class="n">clean_busy</span> <span class="o">=</span> <span class="n">dwc3_cleanup_done_reqs</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clean_busy</span><span class="p">)</span>
		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DWC3_EP_BUSY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * WORKAROUND: This is the 2nd half of U1/U2 -&gt; U0 workaround.</span>
<span class="cm">	 * See dwc3_gadget_linksts_change_interrupt() for 1st half.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="n">DWC3_REVISION_183A</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span>		<span class="n">reg</span><span class="p">;</span>
		<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DWC3_ENDPOINTS_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dwc3_ep</span>	<span class="o">*</span><span class="n">dep</span> <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DWC3_EP_ENABLED</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">req_queued</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCTL</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">u1u2</span><span class="p">;</span>
		<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">u1u2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_gadget_start_isoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dwc3_event_depevt</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">uf</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ISOC ep %s run out for requests.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">uf</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">parameters</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="cm">/* 4 micro frames in the future */</span>
	<span class="n">uf</span> <span class="o">+=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">__dwc3_gadget_kick_transfer</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">uf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_process_ep_cmd_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">dwc3_event_depevt</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">dwc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3_event_depevt</span> <span class="n">mod_ev</span> <span class="o">=</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We were asked to remove one request. It is possible that this</span>
<span class="cm">	 * request and a few others were started together and have the same</span>
<span class="cm">	 * transfer index. Since we stopped the complete endpoint we don&#39;t</span>
<span class="cm">	 * know how many requests were already completed (and not yet)</span>
<span class="cm">	 * reported and how could be done (later). We purge them all until</span>
<span class="cm">	 * the end of the list.</span>
<span class="cm">	 */</span>
	<span class="n">mod_ev</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">DEPEVT_STATUS_LST</span><span class="p">;</span>
	<span class="n">dwc3_cleanup_done_reqs</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod_ev</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DWC3_EP_BUSY</span><span class="p">;</span>
	<span class="cm">/* pending requests are ignored and are queued on XferNotReady */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_ep_cmd_compl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">dwc3_event_depevt</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">param</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">parameters</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DWC3_DEPCMD_ENDTRANSFER</span>:
		<span class="n">dwc3_process_ep_cmd_complete</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEPCMD_STARTTRANSFER</span>:
		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">res_trans_idx</span> <span class="o">=</span> <span class="n">param</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() unknown /unexpected type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">cmd_type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_endpoint_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">dwc3_event_depevt</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_ep</span>		<span class="o">*</span><span class="n">dep</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">epnum</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">endpoint_number</span><span class="p">;</span>

	<span class="n">dep</span> <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">epnum</span><span class="p">];</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">dwc3_ep_event_string</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">endpoint_event</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">epnum</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">epnum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dwc3_ep0_interrupt</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">endpoint_event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DWC3_DEPEVT_XFERCOMPLETE</span>:
		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">res_trans_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s is an Isochronous endpoint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dwc3_endpoint_transfer_complete</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEPEVT_XFERINPROGRESS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s is not an Isochronous endpoint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dwc3_endpoint_transfer_complete</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEPEVT_XFERNOTREADY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dwc3_gadget_start_isoc</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: reason %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span>
					<span class="n">DEPEVT_STATUS_TRANSFER_ACTIVE</span>
					<span class="o">?</span> <span class="s">&quot;Transfer Active&quot;</span>
					<span class="o">:</span> <span class="s">&quot;Transfer Not Active&quot;</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">__dwc3_gadget_kick_transfer</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: failed to kick transfers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEPEVT_STREAMEVT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_endpoint_xfer_bulk</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">.</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Stream event for non-Bulk %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DEPEVT_STREAMEVT_FOUND</span>:
			<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Stream %d found and started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">event</span><span class="o">-&gt;</span><span class="n">parameters</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DEPEVT_STREAMEVT_NOTFOUND</span>:
			<span class="cm">/* FALLTHROUGH */</span>
		<span class="nl">default:</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t find suitable stream</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEPEVT_RXTXFIFOEVT</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s FIFO Overrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEPEVT_EPCMDCMPLT</span>:
		<span class="n">dwc3_ep_cmd_compl</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_disconnect_gadget</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget_driver</span> <span class="o">&amp;&amp;</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget_driver</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget_driver</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_stop_active_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">epnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3_gadget_ep_cmd_params</span> <span class="n">params</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dep</span> <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">epnum</span><span class="p">];</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">res_trans_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">res_trans_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">DWC3_DEPCMD_ENDTRANSFER</span><span class="p">;</span>
		<span class="n">cmd</span> <span class="o">|=</span> <span class="n">DWC3_DEPCMD_HIPRI_FORCERM</span> <span class="o">|</span> <span class="n">DWC3_DEPCMD_CMDIOC</span><span class="p">;</span>
		<span class="n">cmd</span> <span class="o">|=</span> <span class="n">DWC3_DEPCMD_PARAM</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">res_trans_idx</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_send_gadget_ep_cmd</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">res_trans_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_stop_active_transfers</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">epnum</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">epnum</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">epnum</span> <span class="o">&lt;</span> <span class="n">DWC3_ENDPOINTS_NUM</span><span class="p">;</span> <span class="n">epnum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">;</span>

		<span class="n">dep</span> <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">epnum</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DWC3_EP_ENABLED</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dwc3_remove_requests</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_clear_stall_all_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">epnum</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">epnum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">epnum</span> <span class="o">&lt;</span> <span class="n">DWC3_ENDPOINTS_NUM</span><span class="p">;</span> <span class="n">epnum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dwc3_ep</span> <span class="o">*</span><span class="n">dep</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">dwc3_gadget_ep_cmd_params</span> <span class="n">params</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">dep</span> <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="n">epnum</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DWC3_EP_STALL</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dep</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DWC3_EP_STALL</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_send_gadget_ep_cmd</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				<span class="n">DWC3_DEPCMD_CLEARSTALL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_gadget_disconnect_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	XXX</span>
<span class="c">	U1/U2 is powersave optimization. Skip it for now. Anyway we need to</span>
<span class="c">	enable it before we can disable it.</span>

<span class="c">	reg = dwc3_readl(dwc-&gt;regs, DWC3_DCTL);</span>
<span class="c">	reg &amp;= ~DWC3_DCTL_INITU1ENA;</span>
<span class="c">	dwc3_writel(dwc-&gt;regs, DWC3_DCTL, reg);</span>

<span class="c">	reg &amp;= ~DWC3_DCTL_INITU2ENA;</span>
<span class="c">	dwc3_writel(dwc-&gt;regs, DWC3_DCTL, reg);</span>
<span class="cp">#endif</span>

	<span class="n">dwc3_stop_active_transfers</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
	<span class="n">dwc3_disconnect_gadget</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">start_config_issued</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">setup_packet_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_gadget_usb3_phy_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>			<span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GUSB3PIPECTL</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DWC3_GUSB3PIPECTL_SUSPHY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">DWC3_GUSB3PIPECTL_SUSPHY</span><span class="p">;</span>

	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GUSB3PIPECTL</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_gadget_usb2_phy_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>			<span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GUSB2PHYCFG</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DWC3_GUSB2PHYCFG_SUSPHY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">DWC3_GUSB2PHYCFG_SUSPHY</span><span class="p">;</span>

	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GUSB2PHYCFG</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_gadget_reset_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>			<span class="n">reg</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * WORKAROUND: DWC3 revisions &lt;1.88a have an issue which</span>
<span class="cm">	 * would cause a missing Disconnect Event if there&#39;s a</span>
<span class="cm">	 * pending Setup Packet in the FIFO.</span>
<span class="cm">	 *</span>
<span class="cm">	 * There&#39;s no suggested workaround on the official Bug</span>
<span class="cm">	 * report, which states that &quot;unless the driver/application</span>
<span class="cm">	 * is doing any special handling of a disconnect event,</span>
<span class="cm">	 * there is no functional issue&quot;.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Unfortunately, it turns out that we _do_ some special</span>
<span class="cm">	 * handling of a disconnect event, namely complete all</span>
<span class="cm">	 * pending transfers, notify gadget driver of the</span>
<span class="cm">	 * disconnection, and so on.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Our suggested workaround is to follow the Disconnect</span>
<span class="cm">	 * Event steps here, instead, based on a setup_packet_pending</span>
<span class="cm">	 * flag. Such flag gets set whenever we have a XferNotReady</span>
<span class="cm">	 * event on EP0 and gets cleared on XferComplete for the</span>
<span class="cm">	 * same endpoint.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Refers to:</span>
<span class="cm">	 *</span>
<span class="cm">	 * STAR#9000466709: RTL: Device : Disconnect event not</span>
<span class="cm">	 * generated if setup packet pending in FIFO</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="n">DWC3_REVISION_188A</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">setup_packet_pending</span><span class="p">)</span>
			<span class="n">dwc3_gadget_disconnect_interrupt</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* after reset -&gt; Default State */</span>
	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev_state</span> <span class="o">=</span> <span class="n">DWC3_DEFAULT_STATE</span><span class="p">;</span>

	<span class="cm">/* Enable PHYs */</span>
	<span class="n">dwc3_gadget_usb2_phy_power</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">dwc3_gadget_usb3_phy_power</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">)</span>
		<span class="n">dwc3_disconnect_gadget</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCTL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DWC3_DCTL_TSTCTRL_MASK</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DWC3_DCTL_INITU1ENA</span> <span class="o">|</span> <span class="n">DWC3_DCTL_INITU2ENA</span><span class="p">);</span>
	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">test_mode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">dwc3_stop_active_transfers</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
	<span class="n">dwc3_clear_stall_all_ep</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">start_config_issued</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Reset device address to zero */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCFG</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DWC3_DCFG_DEVADDR_MASK</span><span class="p">);</span>
	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_update_ram_clk_sel</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">usb30_clock</span> <span class="o">=</span> <span class="n">DWC3_GCTL_CLK_BUS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We change the clock only at SS but I dunno why I would want to do</span>
<span class="cm">	 * this. Maybe it becomes part of the power saving plan.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">DWC3_DSTS_SUPERSPEED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * RAMClkSel is reset to 0 after USB reset, so it must be reprogrammed</span>
<span class="cm">	 * each time on Connect Done.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb30_clock</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GCTL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">DWC3_GCTL_RAMCLKSEL</span><span class="p">(</span><span class="n">usb30_clock</span><span class="p">);</span>
	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_gadget_disable_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_SPEED_SUPER</span>:
		<span class="n">dwc3_gadget_usb2_phy_power</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
	<span class="k">case</span> <span class="n">USB_SPEED_FULL</span>:
	<span class="k">case</span> <span class="n">USB_SPEED_LOW</span>:
		<span class="n">dwc3_gadget_usb3_phy_power</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_gadget_conndone_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_gadget_ep_cmd_params</span> <span class="n">params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dwc3_ep</span>		<span class="o">*</span><span class="n">dep</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">speed</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DSTS</span><span class="p">);</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">DWC3_DSTS_CONNECTSPD</span><span class="p">;</span>
	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>

	<span class="n">dwc3_update_ram_clk_sel</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DWC3_DCFG_SUPERSPEED</span>:
		<span class="cm">/*</span>
<span class="cm">		 * WORKAROUND: DWC3 revisions &lt;1.90a have an issue which</span>
<span class="cm">		 * would cause a missing USB3 Reset event.</span>
<span class="cm">		 *</span>
<span class="cm">		 * In such situations, we should force a USB3 Reset</span>
<span class="cm">		 * event by calling our dwc3_gadget_reset_interrupt()</span>
<span class="cm">		 * routine.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Refers to:</span>
<span class="cm">		 *</span>
<span class="cm">		 * STAR#9000483510: RTL: SS : USB3 reset event may</span>
<span class="cm">		 * not be generated always when the link enters poll</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="n">DWC3_REVISION_190A</span><span class="p">)</span>
			<span class="n">dwc3_gadget_reset_interrupt</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>

		<span class="n">dwc3_gadget_ep0_desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">512</span><span class="p">);</span>
		<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_SUPER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DCFG_HIGHSPEED</span>:
		<span class="n">dwc3_gadget_ep0_desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
		<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DCFG_FULLSPEED2</span>:
	<span class="k">case</span> <span class="n">DWC3_DCFG_FULLSPEED1</span>:
		<span class="n">dwc3_gadget_ep0_desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
		<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DCFG_LOWSPEED</span>:
		<span class="n">dwc3_gadget_ep0_desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_LOW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable unneded PHY */</span>
	<span class="n">dwc3_gadget_disable_phy</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span><span class="p">);</span>

	<span class="n">dep</span> <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__dwc3_gadget_ep_enable</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwc3_gadget_ep0_desc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to enable %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dep</span> <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">eps</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__dwc3_gadget_ep_enable</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwc3_gadget_ep0_desc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to enable %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dep</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure PHY via GUSB3PIPECTLn if required.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Update GTXFIFOSIZn</span>
<span class="cm">	 *</span>
<span class="cm">	 * In both cases reset values should be sufficient.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_gadget_wakeup_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO take core out of low power mode when that&#39;s</span>
<span class="cm">	 * implemented.</span>
<span class="cm">	 */</span>

	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget_driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_gadget_linksts_change_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">evtinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">dwc3_link_state</span>	<span class="n">next</span> <span class="o">=</span> <span class="n">evtinfo</span> <span class="o">&amp;</span> <span class="n">DWC3_LINK_STATE_MASK</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * WORKAROUND: DWC3 Revisions &lt;1.83a have an issue which, depending</span>
<span class="cm">	 * on the link partner, the USB session might do multiple entry/exit</span>
<span class="cm">	 * of low power states before a transfer takes place.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Due to this problem, we might experience lower throughput. The</span>
<span class="cm">	 * suggested workaround is to disable DCTL[12:9] bits if we&#39;re</span>
<span class="cm">	 * transitioning from U1/U2 to U0 and enable those bits again</span>
<span class="cm">	 * after a transfer completes and there are no pending transfers</span>
<span class="cm">	 * on any of the enabled endpoints.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This is the first half of that workaround.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Refers to:</span>
<span class="cm">	 *</span>
<span class="cm">	 * STAR#9000446952: RTL: Device SS : if U1/U2 -&gt;U0 takes &gt;128us</span>
<span class="cm">	 * core send LGO_Ux entering U0</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="n">DWC3_REVISION_183A</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">==</span> <span class="n">DWC3_LINK_STATE_U0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">u1u2</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">reg</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">DWC3_LINK_STATE_U1</span>:
			<span class="k">case</span> <span class="n">DWC3_LINK_STATE_U2</span>:
				<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCTL</span><span class="p">);</span>
				<span class="n">u1u2</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DWC3_DCTL_INITU2ENA</span>
						<span class="o">|</span> <span class="n">DWC3_DCTL_ACCEPTU2ENA</span>
						<span class="o">|</span> <span class="n">DWC3_DCTL_INITU1ENA</span>
						<span class="o">|</span> <span class="n">DWC3_DCTL_ACCEPTU1ENA</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">u1u2</span><span class="p">)</span>
					<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">u1u2</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">u1u2</span><span class="p">;</span>

				<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">u1u2</span><span class="p">;</span>

				<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="cm">/* do nothing */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s link %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_gadget_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">dwc3_event_devt</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DWC3_DEVICE_EVENT_DISCONNECT</span>:
		<span class="n">dwc3_gadget_disconnect_interrupt</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEVICE_EVENT_RESET</span>:
		<span class="n">dwc3_gadget_reset_interrupt</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEVICE_EVENT_CONNECT_DONE</span>:
		<span class="n">dwc3_gadget_conndone_interrupt</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEVICE_EVENT_WAKEUP</span>:
		<span class="n">dwc3_gadget_wakeup_interrupt</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEVICE_EVENT_LINK_STATUS_CHANGE</span>:
		<span class="n">dwc3_gadget_linksts_change_interrupt</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">event_info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEVICE_EVENT_EOPF</span>:
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;End of Periodic Frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEVICE_EVENT_SOF</span>:
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Start of Periodic Frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEVICE_EVENT_ERRATIC_ERROR</span>:
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Erratic Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEVICE_EVENT_CMD_CMPL</span>:
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Command Complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DWC3_DEVICE_EVENT_OVERFLOW</span>:
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;UNKNOWN IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_process_event_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">union</span> <span class="n">dwc3_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Endpoint IRQ, handle it and return early */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">is_devspec</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* depevt */</span>
		<span class="k">return</span> <span class="n">dwc3_endpoint_interrupt</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">depevt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DWC3_EVENT_TYPE_DEV</span>:
		<span class="n">dwc3_gadget_interrupt</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">devt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* REVISIT what to do with Carkit and I2C events ? */</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;UNKNOWN IRQ type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">dwc3_process_event_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3_event_buffer</span> <span class="o">*</span><span class="n">evt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GEVNTCOUNT</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">count</span> <span class="o">&amp;=</span> <span class="n">DWC3_GEVNTCOUNT_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">evt</span> <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ev_buffs</span><span class="p">[</span><span class="n">buf</span><span class="p">];</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">dwc3_event</span> <span class="n">event</span><span class="p">;</span>

		<span class="n">event</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">lpos</span><span class="p">);</span>

		<span class="n">dwc3_process_event_entry</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * XXX we wrap around correctly to the next entry as almost all</span>
<span class="cm">		 * entries are 4 bytes in size. There is one entry which has 12</span>
<span class="cm">		 * bytes which is a regular entry followed by 8 bytes data. ATM</span>
<span class="cm">		 * I don&#39;t know how things are organized if were get next to the</span>
<span class="cm">		 * a boundary so I worry about that once we try to handle that.</span>
<span class="cm">		 */</span>
		<span class="n">evt</span><span class="o">-&gt;</span><span class="n">lpos</span> <span class="o">=</span> <span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">lpos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="n">DWC3_EVENT_BUFFERS_SIZE</span><span class="p">;</span>
		<span class="n">left</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GEVNTCOUNT</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">dwc3_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_dwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dwc3</span>			<span class="o">*</span><span class="n">dwc</span> <span class="o">=</span> <span class="n">_dwc</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">i</span><span class="p">;</span>
	<span class="n">irqreturn_t</span>			<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">num_event_buffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irqreturn_t</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">dwc3_process_event_buf</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">IRQ_HANDLED</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dwc3_gadget_init - Initializes gadget related registers</span>
<span class="cm"> * @dwc: pointer to our controller context structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success otherwise negative errno.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">dwc3_gadget_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>					<span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span>					<span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span>					<span class="n">irq</span><span class="p">;</span>

	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ctrl_req</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ctrl_req</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ctrl_req_addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ctrl_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate ctrl request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0_trb</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0_trb</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0_trb_addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0_trb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate ep0 trb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">setup_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">DWC3_EP0_BOUNCE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">setup_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate setup buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0_bounce</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">DWC3_EP0_BOUNCE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0_bounce_addr</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0_bounce</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate ep0 bounce buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gadget&quot;</span><span class="p">);</span>

	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ops</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">dwc3_gadget_ops</span><span class="p">;</span>
	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">max_speed</span>		<span class="o">=</span> <span class="n">USB_SPEED_SUPER</span><span class="p">;</span>
	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span>		<span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">sg_supported</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">dma_set_coherent_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">coherent_dma_mask</span><span class="p">);</span>

	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_parms</span>	<span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_parms</span><span class="p">;</span>
	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span>	<span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">dwc3_gadget_release</span><span class="p">;</span>
	<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;dwc3-gadget&quot;</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * REVISIT: Here we should clear all pending IRQs to be</span>
<span class="cm">	 * sure we&#39;re starting from a well known location.</span>
<span class="cm">	 */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_gadget_init_endpoints</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">to_platform_device</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dwc3_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="s">&quot;dwc3&quot;</span><span class="p">,</span> <span class="n">dwc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request irq #%d --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCFG</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">DWC3_DCFG_LPM_CAP</span><span class="p">;</span>
	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCTL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">DWC3_DCTL_ACCEPTU1ENA</span> <span class="o">|</span> <span class="n">DWC3_DCTL_ACCEPTU2ENA</span><span class="p">;</span>
	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Enable all but Start and End of Frame IRQs */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWC3_DEVTEN_VNDRDEVTSTRCVEDEN</span> <span class="o">|</span>
			<span class="n">DWC3_DEVTEN_EVNTOVERFLOWEN</span> <span class="o">|</span>
			<span class="n">DWC3_DEVTEN_CMDCMPLTEN</span> <span class="o">|</span>
			<span class="n">DWC3_DEVTEN_ERRTICERREN</span> <span class="o">|</span>
			<span class="n">DWC3_DEVTEN_WKUPEVTEN</span> <span class="o">|</span>
			<span class="n">DWC3_DEVTEN_ULSTCNGEN</span> <span class="o">|</span>
			<span class="n">DWC3_DEVTEN_CONNECTDONEEN</span> <span class="o">|</span>
			<span class="n">DWC3_DEVTEN_USBRSTEN</span> <span class="o">|</span>
			<span class="n">DWC3_DEVTEN_DISCONNEVTEN</span><span class="p">);</span>
	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DEVTEN</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register gadget device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err6</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_add_gadget_udc</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register udc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err7</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err7:</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err6:</span>
	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DEVTEN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dwc</span><span class="p">);</span>

<span class="nl">err5:</span>
	<span class="n">dwc3_gadget_free_endpoints</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>

<span class="nl">err4:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DWC3_EP0_BOUNCE_SIZE</span><span class="p">,</span>
			<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0_bounce</span><span class="p">,</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0_bounce_addr</span><span class="p">);</span>

<span class="nl">err3:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">setup_buf</span><span class="p">);</span>

<span class="nl">err2:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0_trb</span><span class="p">),</span>
			<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0_trb</span><span class="p">,</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0_trb_addr</span><span class="p">);</span>

<span class="nl">err1:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ctrl_req</span><span class="p">),</span>
			<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ctrl_req</span><span class="p">,</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ctrl_req_addr</span><span class="p">);</span>

<span class="nl">err0:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dwc3_gadget_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">irq</span><span class="p">;</span>

	<span class="n">usb_del_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">to_platform_device</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_DEVTEN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dwc</span><span class="p">);</span>

	<span class="n">dwc3_gadget_free_endpoints</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DWC3_EP0_BOUNCE_SIZE</span><span class="p">,</span>
			<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0_bounce</span><span class="p">,</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0_bounce_addr</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">setup_buf</span><span class="p">);</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0_trb</span><span class="p">),</span>
			<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0_trb</span><span class="p">,</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ep0_trb_addr</span><span class="p">);</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ctrl_req</span><span class="p">),</span>
			<span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ctrl_req</span><span class="p">,</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">ctrl_req_addr</span><span class="p">);</span>

	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
