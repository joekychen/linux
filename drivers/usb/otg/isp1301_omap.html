<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › otg › isp1301_omap.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>isp1301_omap.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * isp1301_omap - ISP 1301 USB transceiver, talking to OMAP OTG controller</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004 Texas Instruments</span>
<span class="cm"> * Copyright (C) 2004 David Brownell</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/otg.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/mach-types.h&gt;</span>

<span class="cp">#include &lt;plat/usb.h&gt;</span>
<span class="cp">#include &lt;plat/mux.h&gt;</span>


<span class="cp">#ifndef	DEBUG</span>
<span class="cp">#undef	VERBOSE</span>
<span class="cp">#endif</span>


<span class="cp">#define	DRIVER_VERSION	&quot;24 August 2004&quot;</span>
<span class="cp">#define	DRIVER_NAME	(isp1301_driver.driver.name)</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ISP1301 USB OTG Transceiver Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">isp1301</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_phy</span>		<span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>	<span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="p">(</span><span class="o">*</span><span class="n">i2c_release</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

	<span class="kt">int</span>			<span class="n">irq_type</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">last_otg_ctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">working</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">timer</span><span class="p">;</span>

	<span class="cm">/* use keventd context to change the state for us */</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">work</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">todo</span><span class="p">;</span>
<span class="cp">#		define WORK_UPDATE_ISP	0	</span><span class="cm">/* update ISP from OTG */</span><span class="cp"></span>
<span class="cp">#		define WORK_UPDATE_OTG	1	</span><span class="cm">/* update OTG from ISP */</span><span class="cp"></span>
<span class="cp">#		define WORK_HOST_RESUME	4	</span><span class="cm">/* resume host */</span><span class="cp"></span>
<span class="cp">#		define WORK_TIMER	6	</span><span class="cm">/* timer fired */</span><span class="cp"></span>
<span class="cp">#		define WORK_STOP	7	</span><span class="cm">/* don&#39;t resubmit */</span><span class="cp"></span>
<span class="p">};</span>


<span class="cm">/* bits in OTG_CTRL */</span>

<span class="cp">#define	OTG_XCEIV_OUTPUTS \</span>
<span class="cp">	(OTG_ASESSVLD|OTG_BSESSEND|OTG_BSESSVLD|OTG_VBUSVLD|OTG_ID)</span>
<span class="cp">#define	OTG_XCEIV_INPUTS \</span>
<span class="cp">	(OTG_PULLDOWN|OTG_PULLUP|OTG_DRV_VBUS|OTG_PD_VBUS|OTG_PU_VBUS|OTG_PU_ID)</span>
<span class="cp">#define	OTG_CTRL_BITS \</span>
<span class="cp">	(OTG_A_BUSREQ|OTG_A_SETB_HNPEN|OTG_B_BUSREQ|OTG_B_HNPEN|OTG_BUSDROP)</span>
	<span class="cm">/* and OTG_PULLUP is sometimes written */</span>

<span class="cp">#define	OTG_CTRL_MASK	(OTG_DRIVER_SEL| \</span>
<span class="cp">	OTG_XCEIV_OUTPUTS|OTG_XCEIV_INPUTS| \</span>
<span class="cp">	OTG_CTRL_BITS)</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* board-specific PM hooks */</span>

<span class="cp">#if defined(CONFIG_MACH_OMAP_H2) || defined(CONFIG_MACH_OMAP_H3)</span>

<span class="cp">#if	defined(CONFIG_TPS65010) || defined(CONFIG_TPS65010_MODULE)</span>

<span class="cp">#include &lt;linux/i2c/tps65010.h&gt;</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tps65010_set_vbus_draw</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">mA</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;tps65010: draw %d mA (STUB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mA</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_vbus_draw</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">mA</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">tps65010_set_vbus_draw</span><span class="p">(</span><span class="n">mA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  VBUS %d mA error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mA</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_vbus_draw</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">mA</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* H4 controls this by DIP switch S2.4; no soft control.</span>
<span class="cm">	 * ON means the charger is always enabled.  Leave it OFF</span>
<span class="cm">	 * unless the OTG port is used only in B-peripheral mode.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_vbus_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* this board won&#39;t supply more than 8mA vbus power.</span>
<span class="cm">	 * some boards can switch a 100ma &quot;unit load&quot; (or more).</span>
<span class="cm">	 */</span>
<span class="p">}</span>


<span class="cm">/* products will deliver OTG messages with LEDs, GUI, etc */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">notresponding</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;OTG device not responding.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">isp1301_driver</span><span class="p">;</span>

<span class="cm">/* smbus apis are used for portability */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span>
<span class="nf">isp1301_get_u8</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">isp1301_get_u16</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2c_smbus_read_word_data</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">isp1301_set_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">isp1301_clear_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* identification */</span>
<span class="cp">#define	ISP1301_VENDOR_ID		0x00	</span><span class="cm">/* u16 read */</span><span class="cp"></span>
<span class="cp">#define	ISP1301_PRODUCT_ID		0x02	</span><span class="cm">/* u16 read */</span><span class="cp"></span>
<span class="cp">#define	ISP1301_BCD_DEVICE		0x14	</span><span class="cm">/* u16 read */</span><span class="cp"></span>

<span class="cp">#define	I2C_VENDOR_ID_PHILIPS		0x04cc</span>
<span class="cp">#define	I2C_PRODUCT_ID_PHILIPS_1301	0x1301</span>

<span class="cm">/* operational registers */</span>
<span class="cp">#define	ISP1301_MODE_CONTROL_1		0x04	</span><span class="cm">/* u8 read, set, +1 clear */</span><span class="cp"></span>
<span class="cp">#	define	MC1_SPEED		(1 &lt;&lt; 0)</span>
<span class="cp">#	define	MC1_SUSPEND		(1 &lt;&lt; 1)</span>
<span class="cp">#	define	MC1_DAT_SE0		(1 &lt;&lt; 2)</span>
<span class="cp">#	define	MC1_TRANSPARENT		(1 &lt;&lt; 3)</span>
<span class="cp">#	define	MC1_BDIS_ACON_EN	(1 &lt;&lt; 4)</span>
<span class="cp">#	define	MC1_OE_INT_EN		(1 &lt;&lt; 5)</span>
<span class="cp">#	define	MC1_UART_EN		(1 &lt;&lt; 6)</span>
<span class="cp">#	define	MC1_MASK		0x7f</span>
<span class="cp">#define	ISP1301_MODE_CONTROL_2		0x12	</span><span class="cm">/* u8 read, set, +1 clear */</span><span class="cp"></span>
<span class="cp">#	define	MC2_GLOBAL_PWR_DN	(1 &lt;&lt; 0)</span>
<span class="cp">#	define	MC2_SPD_SUSP_CTRL	(1 &lt;&lt; 1)</span>
<span class="cp">#	define	MC2_BI_DI		(1 &lt;&lt; 2)</span>
<span class="cp">#	define	MC2_TRANSP_BDIR0	(1 &lt;&lt; 3)</span>
<span class="cp">#	define	MC2_TRANSP_BDIR1	(1 &lt;&lt; 4)</span>
<span class="cp">#	define	MC2_AUDIO_EN		(1 &lt;&lt; 5)</span>
<span class="cp">#	define	MC2_PSW_EN		(1 &lt;&lt; 6)</span>
<span class="cp">#	define	MC2_EN2V7		(1 &lt;&lt; 7)</span>
<span class="cp">#define	ISP1301_OTG_CONTROL_1		0x06	</span><span class="cm">/* u8 read, set, +1 clear */</span><span class="cp"></span>
<span class="cp">#	define	OTG1_DP_PULLUP		(1 &lt;&lt; 0)</span>
<span class="cp">#	define	OTG1_DM_PULLUP		(1 &lt;&lt; 1)</span>
<span class="cp">#	define	OTG1_DP_PULLDOWN	(1 &lt;&lt; 2)</span>
<span class="cp">#	define	OTG1_DM_PULLDOWN	(1 &lt;&lt; 3)</span>
<span class="cp">#	define	OTG1_ID_PULLDOWN	(1 &lt;&lt; 4)</span>
<span class="cp">#	define	OTG1_VBUS_DRV		(1 &lt;&lt; 5)</span>
<span class="cp">#	define	OTG1_VBUS_DISCHRG	(1 &lt;&lt; 6)</span>
<span class="cp">#	define	OTG1_VBUS_CHRG		(1 &lt;&lt; 7)</span>
<span class="cp">#define	ISP1301_OTG_STATUS		0x10	</span><span class="cm">/* u8 readonly */</span><span class="cp"></span>
<span class="cp">#	define	OTG_B_SESS_END		(1 &lt;&lt; 6)</span>
<span class="cp">#	define	OTG_B_SESS_VLD		(1 &lt;&lt; 7)</span>

<span class="cp">#define	ISP1301_INTERRUPT_SOURCE	0x08	</span><span class="cm">/* u8 read */</span><span class="cp"></span>
<span class="cp">#define	ISP1301_INTERRUPT_LATCH		0x0A	</span><span class="cm">/* u8 read, set, +1 clear */</span><span class="cp"></span>

<span class="cp">#define	ISP1301_INTERRUPT_FALLING	0x0C	</span><span class="cm">/* u8 read, set, +1 clear */</span><span class="cp"></span>
<span class="cp">#define	ISP1301_INTERRUPT_RISING	0x0E	</span><span class="cm">/* u8 read, set, +1 clear */</span><span class="cp"></span>

<span class="cm">/* same bitfields in all interrupt registers */</span>
<span class="cp">#	define	INTR_VBUS_VLD		(1 &lt;&lt; 0)</span>
<span class="cp">#	define	INTR_SESS_VLD		(1 &lt;&lt; 1)</span>
<span class="cp">#	define	INTR_DP_HI		(1 &lt;&lt; 2)</span>
<span class="cp">#	define	INTR_ID_GND		(1 &lt;&lt; 3)</span>
<span class="cp">#	define	INTR_DM_HI		(1 &lt;&lt; 4)</span>
<span class="cp">#	define	INTR_ID_FLOAT		(1 &lt;&lt; 5)</span>
<span class="cp">#	define	INTR_BDIS_ACON		(1 &lt;&lt; 6)</span>
<span class="cp">#	define	INTR_CR_INT		(1 &lt;&lt; 7)</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">state_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">otg_state_string</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* NOTE:  some of this ISP1301 setup is specific to H2 boards;</span>
<span class="cm"> * not everything is guarded by board-specific checks, or even using</span>
<span class="cm"> * omap_usb_config data to deduce MC1_DAT_SE0 and MC2_BI_DI.</span>
<span class="cm"> *</span>
<span class="cm"> * ALSO:  this currently doesn&#39;t use ISP1301 low-power modes</span>
<span class="cm"> * while OTG is running.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_UNDEFINED</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>isp1301<em>set</em>bits(isp, ISP1301<em>MODE</em>CONTROL<em>2, MC2</em>GLOBAL<em>PWR</em>DN);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_MODE_CONTROL_1</span><span class="p">,</span> <span class="n">MC1_SUSPEND</span><span class="p">);</span>

	<span class="n">isp1301_clear_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_OTG_CONTROL_1</span><span class="p">,</span> <span class="n">OTG1_ID_PULLDOWN</span><span class="p">);</span>
	<span class="n">isp1301_clear_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_MODE_CONTROL_1</span><span class="p">,</span> <span class="n">MC1_DAT_SE0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">power_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>isp1301<em>clear</em>bits(isp, ISP1301<em>MODE</em>CONTROL<em>2, MC2</em>GLOBAL<em>PWR</em>DN);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">isp1301_clear_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_MODE_CONTROL_1</span><span class="p">,</span> <span class="n">MC1_SUSPEND</span><span class="p">);</span>

	<span class="cm">/* do this only when cpu is driving transceiver,</span>
<span class="cm">	 * so host won&#39;t see a low speed device...</span>
<span class="cm">	 */</span>
	<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_MODE_CONTROL_1</span><span class="p">,</span> <span class="n">MC1_DAT_SE0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define	NO_HOST_SUSPEND</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">host_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef	NO_HOST_SUSPEND</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">struct</span> <span class="n">device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Currently ASSUMES only the OTG port matters;</span>
<span class="cm">	 * other ports could be active...</span>
<span class="cm">	 */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">host_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef	NO_HOST_SUSPEND</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">struct</span> <span class="n">device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gadget_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">b_hnp_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">a_hnp_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">a_alt_hnp_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">usb_gadget_vbus_disconnect</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#define	TIMER_MINUTES	10</span>
<span class="cp">#define	TIMER_JIFFIES	(TIMER_MINUTES * 60 * HZ)</span>

<span class="cm">/* Almost all our I2C messaging comes from a work queue&#39;s task context.</span>
<span class="cm"> * NOTE: guaranteeing certain response times might mean we shouldn&#39;t</span>
<span class="cm"> * share keventd&#39;s work queue; a realtime task might be safest.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp1301_defer_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">))</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">working</span><span class="p">)</span>
			<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;work item %d may be lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* called from irq handlers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">a_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">OTG_STATE_A_IDLE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">default_a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">is_b_host</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">host_suspend</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">is_a_peripheral</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">gadget_suspend</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_IDLE</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OTG_XCEIV_OUTPUTS</span><span class="p">;</span>
	<span class="n">omap_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">last_otg_ctrl</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  --&gt; %s/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state_name</span><span class="p">(</span><span class="n">isp</span><span class="p">),</span> <span class="n">tag</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* called from irq handlers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">OTG_STATE_B_IDLE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">default_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">is_b_host</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">host_suspend</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">is_a_peripheral</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gadget_suspend</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_IDLE</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OTG_XCEIV_OUTPUTS</span><span class="p">;</span>
	<span class="n">omap_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">last_otg_ctrl</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  --&gt; %s/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state_name</span><span class="p">(</span><span class="n">isp</span><span class="p">),</span> <span class="n">tag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef	DEBUG</span>
	<span class="n">u8</span>	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">isp1301_get_u8</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_OTG_CONTROL_1</span><span class="p">);</span>
	<span class="n">u8</span>	<span class="n">status</span> <span class="o">=</span> <span class="n">isp1301_get_u8</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_OTG_STATUS</span><span class="p">);</span>
	<span class="n">u8</span>	<span class="n">src</span> <span class="o">=</span> <span class="n">isp1301_get_u8</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_SOURCE</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;otg: %06x, %s %s, otg/%02x stat/%02x.%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">),</span> <span class="n">label</span><span class="p">,</span> <span class="n">state_name</span><span class="p">(</span><span class="n">isp</span><span class="p">),</span>
		<span class="n">ctrl</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="cm">/* mode control and irq enables don&#39;t change much */</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#ifdef	CONFIG_USB_OTG</span>

<span class="cm">/*</span>
<span class="cm"> * The OMAP OTG controller handles most of the OTG state transitions.</span>
<span class="cm"> *</span>
<span class="cm"> * We translate isp1301 outputs (mostly voltage comparator status) into</span>
<span class="cm"> * OTG inputs; OTG outputs (mostly pullup/pulldown controls) and HNP state</span>
<span class="cm"> * flags into isp1301 inputs ... and infer state transitions.</span>
<span class="cm"> */</span>

<span class="cp">#ifdef	VERBOSE</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">usb_otg_state</span>	<span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_UNDEFINED</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">fsm</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">OTG_TEST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0ff</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">extra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fsm</span><span class="p">)</span> <span class="p">{</span>

	<span class="cm">/* default-b */</span>
	<span class="k">case</span> <span class="mh">0x0</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_IDLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3</span>:
	<span class="k">case</span> <span class="mh">0x7</span>:
		<span class="n">extra</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_PERIPHERAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x11</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_SRP_INIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* extra dual-role default-b states */</span>
	<span class="k">case</span> <span class="mh">0x12</span>:
	<span class="k">case</span> <span class="mh">0x13</span>:
	<span class="k">case</span> <span class="mh">0x16</span>:
		<span class="n">extra</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x17</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_WAIT_ACON</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_HOST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* default-a */</span>
	<span class="k">case</span> <span class="mh">0x36</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_IDLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3c</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_WAIT_VFALL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x7d</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_VBUS_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x9e</span>:
	<span class="k">case</span> <span class="mh">0x9f</span>:
		<span class="n">extra</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x89</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_PERIPHERAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xb7</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_WAIT_VRISE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xb8</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_WAIT_BCON</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xb9</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_HOST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xba</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_SUSPEND</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">state</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">extra</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;otg: %s FSM %s/%02x, %s, %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span>
		<span class="n">otg_state_string</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">fsm</span><span class="p">,</span> <span class="n">state_name</span><span class="p">(</span><span class="n">isp</span><span class="p">),</span>
		<span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">check_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/* outputs from ISP1301_INTERRUPT_SOURCE */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_otg1</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">int_src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">otg_ctrl</span><span class="p">;</span>

	<span class="n">otg_ctrl</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OTG_CTRL_MASK</span><span class="p">;</span>
	<span class="n">otg_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OTG_XCEIV_INPUTS</span><span class="p">;</span>
	<span class="n">otg_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">OTG_ID</span><span class="o">|</span><span class="n">OTG_ASESSVLD</span><span class="o">|</span><span class="n">OTG_VBUSVLD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_src</span> <span class="o">&amp;</span> <span class="n">INTR_SESS_VLD</span><span class="p">)</span>
		<span class="n">otg_ctrl</span> <span class="o">|=</span> <span class="n">OTG_ASESSVLD</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">OTG_STATE_A_WAIT_VFALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a_idle</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="s">&quot;vfall&quot;</span><span class="p">);</span>
		<span class="n">otg_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OTG_CTRL_BITS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_src</span> <span class="o">&amp;</span> <span class="n">INTR_VBUS_VLD</span><span class="p">)</span>
		<span class="n">otg_ctrl</span> <span class="o">|=</span> <span class="n">OTG_VBUSVLD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_src</span> <span class="o">&amp;</span> <span class="n">INTR_ID_GND</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* default-A */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">OTG_STATE_B_IDLE</span>
				<span class="o">||</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span>
					<span class="o">==</span> <span class="n">OTG_STATE_UNDEFINED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a_idle</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="s">&quot;init&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>				<span class="cm">/* default-B */</span>
		<span class="n">otg_ctrl</span> <span class="o">|=</span> <span class="n">OTG_ID</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">OTG_STATE_A_IDLE</span>
			<span class="o">||</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">OTG_STATE_UNDEFINED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b_idle</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="s">&quot;init&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">omap_writel</span><span class="p">(</span><span class="n">otg_ctrl</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* outputs from ISP1301_OTG_STATUS */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_otg2</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">otg_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">otg_ctrl</span><span class="p">;</span>

	<span class="n">otg_ctrl</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OTG_CTRL_MASK</span><span class="p">;</span>
	<span class="n">otg_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OTG_XCEIV_INPUTS</span><span class="p">;</span>
	<span class="n">otg_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">OTG_BSESSVLD</span> <span class="o">|</span> <span class="n">OTG_BSESSEND</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">otg_status</span> <span class="o">&amp;</span> <span class="n">OTG_B_SESS_VLD</span><span class="p">)</span>
		<span class="n">otg_ctrl</span> <span class="o">|=</span> <span class="n">OTG_BSESSVLD</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">otg_status</span> <span class="o">&amp;</span> <span class="n">OTG_B_SESS_END</span><span class="p">)</span>
		<span class="n">otg_ctrl</span> <span class="o">|=</span> <span class="n">OTG_BSESSEND</span><span class="p">;</span>
	<span class="n">omap_writel</span><span class="p">(</span><span class="n">otg_ctrl</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* inputs going to ISP1301 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">otg_update_isp</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">otg_ctrl</span><span class="p">,</span> <span class="n">otg_change</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">set</span> <span class="o">=</span> <span class="n">OTG1_DM_PULLDOWN</span><span class="p">,</span> <span class="n">clr</span> <span class="o">=</span> <span class="n">OTG1_DM_PULLUP</span><span class="p">;</span>

	<span class="n">otg_ctrl</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">);</span>
	<span class="n">otg_change</span> <span class="o">=</span> <span class="n">otg_ctrl</span> <span class="o">^</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">last_otg_ctrl</span><span class="p">;</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">last_otg_ctrl</span> <span class="o">=</span> <span class="n">otg_ctrl</span><span class="p">;</span>
	<span class="n">otg_ctrl</span> <span class="o">=</span> <span class="n">otg_ctrl</span> <span class="o">&amp;</span> <span class="n">OTG_XCEIV_INPUTS</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OTG_STATE_B_IDLE</span>:
	<span class="k">case</span> <span class="n">OTG_STATE_B_PERIPHERAL</span>:
	<span class="k">case</span> <span class="n">OTG_STATE_B_SRP_INIT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">otg_ctrl</span> <span class="o">&amp;</span> <span class="n">OTG_PULLUP</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>if (otg<em>ctrl &amp; OTG</em>B_HNPEN) {</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">b_hnp_enable</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_WAIT_ACON</span><span class="p">;</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  --&gt; b_wait_acon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">pulldown</span><span class="p">;</span>
		<span class="p">}</span>
<span class="nl">pullup:</span>
		<span class="n">set</span> <span class="o">|=</span> <span class="n">OTG1_DP_PULLUP</span><span class="p">;</span>
		<span class="n">clr</span> <span class="o">|=</span> <span class="n">OTG1_DP_PULLDOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OTG_STATE_A_SUSPEND</span>:
	<span class="k">case</span> <span class="n">OTG_STATE_A_PERIPHERAL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">otg_ctrl</span> <span class="o">&amp;</span> <span class="n">OTG_PULLUP</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">pullup</span><span class="p">;</span>
		<span class="cm">/* FALLTHROUGH */</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>case OTG<em>STATE</em>B<em>WAIT</em>ACON:</p></td><td class="code"><div class="highlight"><pre>	<span class="nl">default:</span>
<span class="nl">pulldown:</span>
		<span class="n">set</span> <span class="o">|=</span> <span class="n">OTG1_DP_PULLDOWN</span><span class="p">;</span>
		<span class="n">clr</span> <span class="o">|=</span> <span class="n">OTG1_DP_PULLUP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#	define toggle(OTG,ISP) do { \</span>
<span class="cp">		if (otg_ctrl &amp; OTG) set |= ISP; \</span>
<span class="cp">		else clr |= ISP; \</span>
<span class="cp">		} while (0)</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">))</span>
		<span class="n">otg_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OTG_DRV_VBUS</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OTG_STATE_A_SUSPEND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">otg_ctrl</span> <span class="o">&amp;</span> <span class="n">OTG_DRV_VBUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set</span> <span class="o">|=</span> <span class="n">OTG1_VBUS_DRV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* HNP failed for some reason (A_AIDL_BDIS timeout) */</span>
		<span class="n">notresponding</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

		<span class="cm">/* FALLTHROUGH */</span>
	<span class="k">case</span> <span class="n">OTG_STATE_A_VBUS_ERR</span>:
		<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_WAIT_VFALL</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  --&gt; a_wait_vfall</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* FALLTHROUGH */</span>
	<span class="k">case</span> <span class="n">OTG_STATE_A_WAIT_VFALL</span>:
		<span class="cm">/* FIXME usbcore thinks port power is still on ... */</span>
		<span class="n">clr</span> <span class="o">|=</span> <span class="n">OTG1_VBUS_DRV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OTG_STATE_A_IDLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">otg_ctrl</span> <span class="o">&amp;</span> <span class="n">OTG_DRV_VBUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_WAIT_VRISE</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  --&gt; a_wait_vrise</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* FALLTHROUGH */</span>
	<span class="nl">default:</span>
		<span class="n">toggle</span><span class="p">(</span><span class="n">OTG_DRV_VBUS</span><span class="p">,</span> <span class="n">OTG1_VBUS_DRV</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">toggle</span><span class="p">(</span><span class="n">OTG_PU_VBUS</span><span class="p">,</span> <span class="n">OTG1_VBUS_CHRG</span><span class="p">);</span>
	<span class="n">toggle</span><span class="p">(</span><span class="n">OTG_PD_VBUS</span><span class="p">,</span> <span class="n">OTG1_VBUS_DISCHRG</span><span class="p">);</span>

<span class="cp">#	undef toggle</span>

	<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_OTG_CONTROL_1</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>
	<span class="n">isp1301_clear_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_OTG_CONTROL_1</span><span class="p">,</span> <span class="n">clr</span><span class="p">);</span>

	<span class="cm">/* HNP switch to host or peripheral; and SRP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">otg_change</span> <span class="o">&amp;</span> <span class="n">OTG_PULLUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OTG_STATE_B_IDLE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">clr</span> <span class="o">&amp;</span> <span class="n">OTG1_DP_PULLUP</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_PERIPHERAL</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  --&gt; b_peripheral</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OTG_STATE_A_SUSPEND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">clr</span> <span class="o">&amp;</span> <span class="n">OTG1_DP_PULLUP</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_PERIPHERAL</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  --&gt; a_peripheral</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="n">OTG_PULLUP</span><span class="p">;</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">check_state</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">dump_regs</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="s">&quot;otg-&gt;isp1301&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">omap_otg_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>		<span class="n">otg_irq</span> <span class="o">=</span> <span class="n">omap_readw</span><span class="p">(</span><span class="n">OTG_IRQ_SRC</span><span class="p">);</span>
	<span class="n">u32</span>		<span class="n">otg_ctrl</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1301</span>	<span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">_isp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_otg</span>	<span class="o">*</span><span class="n">otg</span> <span class="o">=</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="p">;</span>

	<span class="cm">/* update ISP1301 transceiver from OTG controller */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">otg_irq</span> <span class="o">&amp;</span> <span class="n">OPRT_CHG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">OPRT_CHG</span><span class="p">,</span> <span class="n">OTG_IRQ_SRC</span><span class="p">);</span>
		<span class="n">isp1301_defer_work</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">WORK_UPDATE_ISP</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="cm">/* SRP to become b_peripheral failed */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">otg_irq</span> <span class="o">&amp;</span> <span class="n">B_SRP_TMROUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;otg: B_SRP_TIMEOUT, %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">));</span>
		<span class="n">notresponding</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

		<span class="cm">/* gadget drivers that care should monitor all kinds of</span>
<span class="cm">		 * remote wakeup (SRP, normal) using their own timer</span>
<span class="cm">		 * to give &quot;check cable and A-device&quot; messages.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">OTG_STATE_B_SRP_INIT</span><span class="p">)</span>
			<span class="n">b_idle</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="s">&quot;srp_timeout&quot;</span><span class="p">);</span>

		<span class="n">omap_writew</span><span class="p">(</span><span class="n">B_SRP_TMROUT</span><span class="p">,</span> <span class="n">OTG_IRQ_SRC</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="cm">/* HNP to become b_host failed */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">otg_irq</span> <span class="o">&amp;</span> <span class="n">B_HNP_FAIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;otg: %s B_HNP_FAIL, %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">state_name</span><span class="p">(</span><span class="n">isp</span><span class="p">),</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">));</span>
		<span class="n">notresponding</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

		<span class="n">otg_ctrl</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">);</span>
		<span class="n">otg_ctrl</span> <span class="o">|=</span> <span class="n">OTG_BUSDROP</span><span class="p">;</span>
		<span class="n">otg_ctrl</span> <span class="o">&amp;=</span> <span class="n">OTG_CTRL_MASK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">OTG_XCEIV_INPUTS</span><span class="p">;</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="n">otg_ctrl</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>

		<span class="cm">/* subset of b_peripheral()... */</span>
		<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_PERIPHERAL</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  --&gt; b_peripheral</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">omap_writew</span><span class="p">(</span><span class="n">B_HNP_FAIL</span><span class="p">,</span> <span class="n">OTG_IRQ_SRC</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="cm">/* detect SRP from B-device ... */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">otg_irq</span> <span class="o">&amp;</span> <span class="n">A_SRP_DETECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;otg: %s SRP_DETECT, %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">state_name</span><span class="p">(</span><span class="n">isp</span><span class="p">),</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">));</span>

		<span class="n">isp1301_defer_work</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">WORK_UPDATE_OTG</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OTG_STATE_A_IDLE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">isp1301_defer_work</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">WORK_HOST_RESUME</span><span class="p">);</span>
			<span class="n">otg_ctrl</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">);</span>
			<span class="n">otg_ctrl</span> <span class="o">|=</span> <span class="n">OTG_A_BUSREQ</span><span class="p">;</span>
			<span class="n">otg_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">OTG_BUSDROP</span><span class="o">|</span><span class="n">OTG_B_BUSREQ</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="o">~</span><span class="n">OTG_XCEIV_INPUTS</span>
					<span class="o">&amp;</span> <span class="n">OTG_CTRL_MASK</span><span class="p">;</span>
			<span class="n">omap_writel</span><span class="p">(</span><span class="n">otg_ctrl</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">omap_writew</span><span class="p">(</span><span class="n">A_SRP_DETECT</span><span class="p">,</span> <span class="n">OTG_IRQ_SRC</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="cm">/* timer expired:  T(a_wait_bcon) and maybe T(a_wait_vrise)</span>
<span class="cm">	 * we don&#39;t track them separately</span>
<span class="cm">	 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">otg_irq</span> <span class="o">&amp;</span> <span class="n">A_REQ_TMROUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">otg_ctrl</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;otg: BCON_TMOUT from %s, %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">state_name</span><span class="p">(</span><span class="n">isp</span><span class="p">),</span> <span class="n">otg_ctrl</span><span class="p">);</span>
		<span class="n">notresponding</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

		<span class="n">otg_ctrl</span> <span class="o">|=</span> <span class="n">OTG_BUSDROP</span><span class="p">;</span>
		<span class="n">otg_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OTG_A_BUSREQ</span> <span class="o">&amp;</span> <span class="n">OTG_CTRL_MASK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">OTG_XCEIV_INPUTS</span><span class="p">;</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="n">otg_ctrl</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>
		<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_WAIT_VFALL</span><span class="p">;</span>

		<span class="n">omap_writew</span><span class="p">(</span><span class="n">A_REQ_TMROUT</span><span class="p">,</span> <span class="n">OTG_IRQ_SRC</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="cm">/* A-supplied voltage fell too low; overcurrent */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">otg_irq</span> <span class="o">&amp;</span> <span class="n">A_VBUS_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">otg_ctrl</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;otg: %s, VBUS_ERR %04x ctrl %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">state_name</span><span class="p">(</span><span class="n">isp</span><span class="p">),</span> <span class="n">otg_irq</span><span class="p">,</span> <span class="n">otg_ctrl</span><span class="p">);</span>

		<span class="n">otg_ctrl</span> <span class="o">|=</span> <span class="n">OTG_BUSDROP</span><span class="p">;</span>
		<span class="n">otg_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OTG_A_BUSREQ</span> <span class="o">&amp;</span> <span class="n">OTG_CTRL_MASK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">OTG_XCEIV_INPUTS</span><span class="p">;</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="n">otg_ctrl</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>
		<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_VBUS_ERR</span><span class="p">;</span>

		<span class="n">omap_writew</span><span class="p">(</span><span class="n">A_VBUS_ERR</span><span class="p">,</span> <span class="n">OTG_IRQ_SRC</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="cm">/* switch driver; the transceiver code activates it,</span>
<span class="cm">	 * ungating the udc clock or resuming OHCI.</span>
<span class="cm">	 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">otg_irq</span> <span class="o">&amp;</span> <span class="n">DRIVER_SWITCH</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">kick</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">otg_ctrl</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;otg: %s, SWITCH to %s, ctrl %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">state_name</span><span class="p">(</span><span class="n">isp</span><span class="p">),</span>
				<span class="p">(</span><span class="n">otg_ctrl</span> <span class="o">&amp;</span> <span class="n">OTG_DRIVER_SEL</span><span class="p">)</span>
					<span class="o">?</span> <span class="s">&quot;gadget&quot;</span> <span class="o">:</span> <span class="s">&quot;host&quot;</span><span class="p">,</span>
				<span class="n">otg_ctrl</span><span class="p">);</span>
		<span class="n">isp1301_defer_work</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">WORK_UPDATE_ISP</span><span class="p">);</span>

		<span class="cm">/* role is peripheral */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">otg_ctrl</span> <span class="o">&amp;</span> <span class="n">OTG_DRIVER_SEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">OTG_STATE_A_IDLE</span>:
				<span class="n">b_idle</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">isp1301_defer_work</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">WORK_UPDATE_ISP</span><span class="p">);</span>

		<span class="cm">/* role is host */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">otg_ctrl</span> <span class="o">&amp;</span> <span class="n">OTG_ID</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">otg_ctrl</span> <span class="o">&amp;=</span> <span class="n">OTG_CTRL_MASK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">OTG_XCEIV_INPUTS</span><span class="p">;</span>
				<span class="n">omap_writel</span><span class="p">(</span><span class="n">otg_ctrl</span> <span class="o">|</span> <span class="n">OTG_A_BUSREQ</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">OTG_STATE_B_WAIT_ACON</span>:
					<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_HOST</span><span class="p">;</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  --&gt; b_host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">kick</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">OTG_STATE_A_WAIT_BCON</span>:
					<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_HOST</span><span class="p">;</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  --&gt; a_host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">OTG_STATE_A_PERIPHERAL</span>:
					<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_WAIT_BCON</span><span class="p">;</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  --&gt; a_wait_bcon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">isp1301_defer_work</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">WORK_HOST_RESUME</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">omap_writew</span><span class="p">(</span><span class="n">DRIVER_SWITCH</span><span class="p">,</span> <span class="n">OTG_IRQ_SRC</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kick</span><span class="p">)</span>
			<span class="n">usb_bus_start_enum</span><span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">otg_port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">check_state</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">otg_dev</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp1301_otg_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">otg_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">dump_regs</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="cm">/* some of these values are board-specific... */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_SYSCON_2</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">OTG_EN</span>
		<span class="cm">/* for B-device: */</span>
		<span class="o">|</span> <span class="n">SRP_GPDATA</span>		<span class="cm">/* 9msec Bdev D+ pulse */</span>
		<span class="o">|</span> <span class="n">SRP_GPDVBUS</span>		<span class="cm">/* discharge after VBUS pulse */</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>| (3 &lt;&lt; 24)        /* 2msec VBUS pulse */</p></td><td class="code"><div class="highlight"><pre>		<span class="cm">/* for A-device: */</span>
		<span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span>		<span class="cm">/* 200ms nominal A_WAIT_VRISE timer */</span>
		<span class="o">|</span> <span class="n">SRP_DPW</span>		<span class="cm">/* detect 167+ns SRP pulses */</span>
		<span class="o">|</span> <span class="n">SRP_DATA</span> <span class="o">|</span> <span class="n">SRP_VBUS</span>	<span class="cm">/* accept both kinds of SRP pulse */</span>
		<span class="p">;</span>
	<span class="n">omap_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OTG_SYSCON_2</span><span class="p">);</span>

	<span class="n">update_otg1</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">isp1301_get_u8</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_SOURCE</span><span class="p">));</span>
	<span class="n">update_otg2</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">isp1301_get_u8</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_OTG_STATUS</span><span class="p">));</span>

	<span class="n">check_state</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;otg: %s, %s %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">state_name</span><span class="p">(</span><span class="n">isp</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">));</span>

	<span class="n">omap_writew</span><span class="p">(</span><span class="n">DRIVER_SWITCH</span> <span class="o">|</span> <span class="n">OPRT_CHG</span>
			<span class="o">|</span> <span class="n">B_SRP_TMROUT</span> <span class="o">|</span> <span class="n">B_HNP_FAIL</span>
			<span class="o">|</span> <span class="n">A_VBUS_ERR</span> <span class="o">|</span> <span class="n">A_SRP_DETECT</span> <span class="o">|</span> <span class="n">A_REQ_TMROUT</span><span class="p">,</span> <span class="n">OTG_IRQ_EN</span><span class="p">);</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_SYSCON_2</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">OTG_EN</span><span class="p">;</span>
	<span class="n">omap_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OTG_SYSCON_2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">otg_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>struct omap<em>usb</em>config *config = dev->platform_data;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">otg_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">otg_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">otg_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">omap_otg_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">otg_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">otg_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;omap_otg&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">otg_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">otg_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_otg_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">otg_dev</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">otg_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="n">omap_otg_irq</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">isp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_otg_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">otg_unbind</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">otg_dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">otg_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="n">isp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cm">/* OTG controller isn&#39;t clocked */</span>

<span class="cp">#endif	</span><span class="cm">/* CONFIG_USB_OTG */</span><span class="cp"></span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b_peripheral</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OTG_XCEIV_OUTPUTS</span><span class="p">;</span>
	<span class="n">omap_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>

	<span class="n">usb_gadget_vbus_connect</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>

<span class="cp">#ifdef	CONFIG_USB_OTG</span>
	<span class="n">enable_vbus_draw</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">otg_update_isp</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">enable_vbus_draw</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="cm">/* UDC driver just set OTG_BSESSVLD */</span>
	<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_OTG_CONTROL_1</span><span class="p">,</span> <span class="n">OTG1_DP_PULLUP</span><span class="p">);</span>
	<span class="n">isp1301_clear_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_OTG_CONTROL_1</span><span class="p">,</span> <span class="n">OTG1_DP_PULLDOWN</span><span class="p">);</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_PERIPHERAL</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  --&gt; b_peripheral</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dump_regs</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="s">&quot;2periph&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp_update_otg</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_otg</span>		<span class="o">*</span><span class="n">otg</span> <span class="o">=</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">isp_stat</span><span class="p">,</span> <span class="n">isp_bstat</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">usb_otg_state</span>	<span class="n">state</span> <span class="o">=</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">INTR_BDIS_ACON</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;OTG:  BDIS_ACON, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state_name</span><span class="p">(</span><span class="n">isp</span><span class="p">));</span>

	<span class="cm">/* start certain state transitions right away */</span>
	<span class="n">isp_stat</span> <span class="o">=</span> <span class="n">isp1301_get_u8</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_SOURCE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp_stat</span> <span class="o">&amp;</span> <span class="n">INTR_ID_GND</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">default_a</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">OTG_STATE_B_IDLE</span>:
				<span class="n">a_idle</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="s">&quot;idle&quot;</span><span class="p">);</span>
				<span class="cm">/* FALLTHROUGH */</span>
			<span class="k">case</span> <span class="n">OTG_STATE_A_IDLE</span>:
				<span class="n">enable_vbus_source</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
				<span class="cm">/* FALLTHROUGH */</span>
			<span class="k">case</span> <span class="n">OTG_STATE_A_WAIT_VRISE</span>:
				<span class="cm">/* we skip over OTG_STATE_A_WAIT_BCON, since</span>
<span class="cm">				 * the HC will transition to A_HOST (or</span>
<span class="cm">				 * A_SUSPEND!) without our noticing except</span>
<span class="cm">				 * when HNP is used.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">isp_stat</span> <span class="o">&amp;</span> <span class="n">INTR_VBUS_VLD</span><span class="p">)</span>
					<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_HOST</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OTG_STATE_A_WAIT_VFALL</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp_stat</span> <span class="o">&amp;</span> <span class="n">INTR_SESS_VLD</span><span class="p">))</span>
					<span class="n">a_idle</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="s">&quot;vfell&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp_stat</span> <span class="o">&amp;</span> <span class="n">INTR_VBUS_VLD</span><span class="p">))</span>
					<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_VBUS_ERR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">isp_bstat</span> <span class="o">=</span> <span class="n">isp1301_get_u8</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_OTG_STATUS</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">OTG_STATE_B_PERIPHERAL</span>:
			<span class="k">case</span> <span class="n">OTG_STATE_B_HOST</span>:
			<span class="k">case</span> <span class="n">OTG_STATE_B_WAIT_ACON</span>:
				<span class="n">usb_gadget_vbus_disconnect</span><span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">OTG_STATE_A_IDLE</span><span class="p">)</span>
				<span class="n">a_idle</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">==</span> <span class="n">OTG_STATE_A_IDLE</span><span class="p">)</span>
				<span class="n">isp1301_defer_work</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">WORK_HOST_RESUME</span><span class="p">);</span>
			<span class="n">isp_bstat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

		<span class="cm">/* if user unplugged mini-A end of cable,</span>
<span class="cm">		 * don&#39;t bypass A_WAIT_VFALL.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">default_a</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="nl">default:</span>
				<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_WAIT_VFALL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OTG_STATE_A_WAIT_VFALL</span>:
				<span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_IDLE</span><span class="p">;</span>
				<span class="cm">/* khubd may take a while to notice and</span>
<span class="cm">				 * handle this disconnect, so don&#39;t go</span>
<span class="cm">				 * to B_IDLE quite yet.</span>
<span class="cm">				 */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OTG_STATE_A_IDLE</span>:
				<span class="n">host_suspend</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
				<span class="n">isp1301_clear_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_MODE_CONTROL_1</span><span class="p">,</span>
						<span class="n">MC1_BDIS_ACON_EN</span><span class="p">);</span>
				<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_IDLE</span><span class="p">;</span>
				<span class="n">l</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OTG_CTRL_MASK</span><span class="p">;</span>
				<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OTG_CTRL_BITS</span><span class="p">;</span>
				<span class="n">omap_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OTG_STATE_B_IDLE</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">isp_bstat</span> <span class="o">=</span> <span class="n">isp1301_get_u8</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_OTG_STATUS</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OTG_STATE_B_PERIPHERAL</span>:
		<span class="k">case</span> <span class="n">OTG_STATE_B_WAIT_ACON</span>:
		<span class="k">case</span> <span class="n">OTG_STATE_B_HOST</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">isp_bstat</span> <span class="o">&amp;</span> <span class="n">OTG_B_SESS_VLD</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">enable_vbus_draw</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifndef	CONFIG_USB_OTG</span>
			<span class="cm">/* UDC driver will clear OTG_BSESSVLD */</span>
			<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_OTG_CONTROL_1</span><span class="p">,</span>
						<span class="n">OTG1_DP_PULLDOWN</span><span class="p">);</span>
			<span class="n">isp1301_clear_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_OTG_CONTROL_1</span><span class="p">,</span>
						<span class="n">OTG1_DP_PULLUP</span><span class="p">);</span>
			<span class="n">dump_regs</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="cm">/* FALLTHROUGH */</span>
		<span class="k">case</span> <span class="n">OTG_STATE_B_SRP_INIT</span>:
			<span class="n">b_idle</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">l</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OTG_XCEIV_OUTPUTS</span><span class="p">;</span>
			<span class="n">omap_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>
			<span class="cm">/* FALLTHROUGH */</span>
		<span class="k">case</span> <span class="n">OTG_STATE_B_IDLE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">isp_bstat</span> <span class="o">&amp;</span> <span class="n">OTG_B_SESS_VLD</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef	CONFIG_USB_OTG</span>
				<span class="n">update_otg1</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">isp_stat</span><span class="p">);</span>
				<span class="n">update_otg2</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">isp_bstat</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">b_peripheral</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp_stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INTR_VBUS_VLD</span><span class="o">|</span><span class="n">INTR_SESS_VLD</span><span class="p">)))</span>
				<span class="n">isp_bstat</span> <span class="o">|=</span> <span class="n">OTG_B_SESS_END</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OTG_STATE_A_WAIT_VFALL</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;otg: unsupported b-device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">state_name</span><span class="p">(</span><span class="n">isp</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  isp, %s -&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">otg_state_string</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">state_name</span><span class="p">(</span><span class="n">isp</span><span class="p">));</span>

<span class="cp">#ifdef	CONFIG_USB_OTG</span>
	<span class="cm">/* update the OTG controller state to match the isp1301; may</span>
<span class="cm">	 * trigger OPRT_CHG irqs for changes going to the isp1301.</span>
<span class="cm">	 */</span>
	<span class="n">update_otg1</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">isp_stat</span><span class="p">);</span>
	<span class="n">update_otg2</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">isp_bstat</span><span class="p">);</span>
	<span class="n">check_state</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">dump_regs</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="s">&quot;isp1301-&gt;otg&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">isp1301_clear_latch</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">latch</span> <span class="o">=</span> <span class="n">isp1301_get_u8</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_LATCH</span><span class="p">);</span>
	<span class="n">isp1301_clear_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_LATCH</span><span class="p">,</span> <span class="n">latch</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">latch</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isp1301_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1301</span>	<span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp1301</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">stop</span><span class="p">;</span>

	<span class="cm">/* implicit lock:  we&#39;re the only task using this device */</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">working</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">stop</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">WORK_STOP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>

<span class="cp">#ifdef	CONFIG_USB_OTG</span>
		<span class="cm">/* transfer state from otg engine to isp1301 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WORK_UPDATE_ISP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">otg_update_isp</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
			<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="cm">/* transfer state from isp1301 to otg engine */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WORK_UPDATE_OTG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span>		<span class="n">stat</span> <span class="o">=</span> <span class="n">isp1301_clear_latch</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

			<span class="n">isp_update_otg</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
			<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WORK_HOST_RESUME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">otg_ctrl</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * skip A_WAIT_VRISE; hc transitions invisibly</span>
<span class="cm">			 * skip A_WAIT_BCON; same.</span>
<span class="cm">			 */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">OTG_STATE_A_WAIT_BCON</span>:
			<span class="k">case</span> <span class="n">OTG_STATE_A_WAIT_VRISE</span>:
				<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_HOST</span><span class="p">;</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  --&gt; a_host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">otg_ctrl</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">);</span>
				<span class="n">otg_ctrl</span> <span class="o">|=</span> <span class="n">OTG_A_BUSREQ</span><span class="p">;</span>
				<span class="n">otg_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">OTG_BUSDROP</span><span class="o">|</span><span class="n">OTG_B_BUSREQ</span><span class="p">)</span>
						<span class="o">&amp;</span> <span class="n">OTG_CTRL_MASK</span><span class="p">;</span>
				<span class="n">omap_writel</span><span class="p">(</span><span class="n">otg_ctrl</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OTG_STATE_B_WAIT_ACON</span>:
				<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_HOST</span><span class="p">;</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  --&gt; b_host (acon)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OTG_STATE_B_HOST</span>:
			<span class="k">case</span> <span class="n">OTG_STATE_B_IDLE</span>:
			<span class="k">case</span> <span class="n">OTG_STATE_A_IDLE</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  host resume in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">state_name</span><span class="p">(</span><span class="n">isp</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">host_resume</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>mdelay(10);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WORK_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef	VERBOSE</span>
			<span class="n">dump_regs</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="s">&quot;timer&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stop</span><span class="p">)</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">TIMER_JIFFIES</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">)</span>
			<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;work done, todo = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">isp</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;stop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">working</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">isp1301_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isp1301_defer_work</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">WORK_UPDATE_OTG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp1301_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isp1301_defer_work</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">_isp</span><span class="p">,</span> <span class="n">WORK_TIMER</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp1301_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1301</span>	<span class="o">*</span><span class="n">isp</span><span class="p">;</span>

	<span class="n">isp</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* FIXME -- not with a &quot;new style&quot; driver, it doesn&#39;t!! */</span>

	<span class="cm">/* ugly -- i2c hijacks our memory hook to wait_for_completion() */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">i2c_release</span><span class="p">)</span>
		<span class="n">isp</span><span class="o">-&gt;</span><span class="n">i2c_release</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">the_transceiver</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">isp1301_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1301</span>	<span class="o">*</span><span class="n">isp</span><span class="p">;</span>

	<span class="n">isp</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>

	<span class="n">isp1301_clear_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_FALLING</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">isp1301_clear_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_RISING</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">isp</span><span class="p">);</span>
<span class="cp">#ifdef	CONFIG_USB_OTG</span>
	<span class="n">otg_unbind</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_omap_h2</span><span class="p">())</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">WORK_STOP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">the_transceiver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* NOTE:  three modes are possible here, only one of which</span>
<span class="cm"> * will be standards-conformant on any given system:</span>
<span class="cm"> *</span>
<span class="cm"> *  - OTG mode (dual-role), required if there&#39;s a Mini-AB connector</span>
<span class="cm"> *  - HOST mode, for when there&#39;s one or more A (host) connectors</span>
<span class="cm"> *  - DEVICE mode, for when there&#39;s a B/Mini-B (device) connector</span>
<span class="cm"> *</span>
<span class="cm"> * As a rule, you won&#39;t have an isp1301 chip unless it&#39;s there to</span>
<span class="cm"> * support the OTG mode.  Other modes help testing USB controllers</span>
<span class="cm"> * in isolation from (full) OTG support, or maybe so later board</span>
<span class="cm"> * revisions can help to support those feature.</span>
<span class="cm"> */</span>

<span class="cp">#ifdef	CONFIG_USB_OTG</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp1301_otg_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1301</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">power_up</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="n">isp1301_otg_init</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

	<span class="cm">/* NOTE:  since we don&#39;t change this, this provides</span>
<span class="cm">	 * a few more interrupts than are strictly needed.</span>
<span class="cm">	 */</span>
	<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_RISING</span><span class="p">,</span>
		<span class="n">INTR_VBUS_VLD</span> <span class="o">|</span> <span class="n">INTR_SESS_VLD</span> <span class="o">|</span> <span class="n">INTR_ID_GND</span><span class="p">);</span>
	<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_FALLING</span><span class="p">,</span>
		<span class="n">INTR_VBUS_VLD</span> <span class="o">|</span> <span class="n">INTR_SESS_VLD</span> <span class="o">|</span> <span class="n">INTR_ID_GND</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ready for dual-role USB ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/* add or disable the host device+driver */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isp1301_set_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_otg</span> <span class="o">*</span><span class="n">otg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_bus</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1301</span>	<span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp1301</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">otg</span> <span class="o">||</span> <span class="n">isp</span> <span class="o">!=</span> <span class="n">the_transceiver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">OTG_IRQ_EN</span><span class="p">);</span>
		<span class="n">power_down</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
		<span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef	CONFIG_USB_OTG</span>
	<span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;registered host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">host_suspend</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">isp1301_otg_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#elif	!defined(CONFIG_USB_GADGET_OMAP)</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>FIXME update its refcount</p></td><td class="code"><div class="highlight"><pre>	<span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>

	<span class="n">power_up</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_omap_h2</span><span class="p">())</span>
		<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_MODE_CONTROL_1</span><span class="p">,</span> <span class="n">MC1_DAT_SE0</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;A-Host sessions ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_RISING</span><span class="p">,</span>
		<span class="n">INTR_ID_GND</span><span class="p">);</span>
	<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_FALLING</span><span class="p">,</span>
		<span class="n">INTR_ID_GND</span><span class="p">);</span>

	<span class="cm">/* If this has a Mini-AB connector, this mode is highly</span>
<span class="cm">	 * nonstandard ... but can be handy for testing, especially with</span>
<span class="cm">	 * the Mini-A end of an OTG cable.  (Or something nonstandard</span>
<span class="cm">	 * like MiniB-to-StandardB, maybe built with a gender mender.)</span>
<span class="cm">	 */</span>
	<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_OTG_CONTROL_1</span><span class="p">,</span> <span class="n">OTG1_VBUS_DRV</span><span class="p">);</span>

	<span class="n">dump_regs</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#else</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;host sessions not allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isp1301_set_peripheral</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_otg</span> <span class="o">*</span><span class="n">otg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1301</span>	<span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp1301</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
<span class="cp">#ifndef	CONFIG_USB_OTG</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">otg</span> <span class="o">||</span> <span class="n">isp</span> <span class="o">!=</span> <span class="n">the_transceiver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gadget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">OTG_IRQ_EN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">default_a</span><span class="p">)</span>
			<span class="n">enable_vbus_draw</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">usb_gadget_vbus_disconnect</span><span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">power_down</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef	CONFIG_USB_OTG</span>
	<span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">gadget</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;registered gadget</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* gadget driver may be suspended until vbus_connect () */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">isp1301_otg_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#elif	!defined(CONFIG_USB_OHCI_HCD) &amp;&amp; !defined(CONFIG_USB_OHCI_HCD_MODULE)</span>
	<span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">gadget</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>FIXME update its refcount</p></td><td class="code"><div class="highlight"><pre>	<span class="n">l</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OTG_CTRL_MASK</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">OTG_XCEIV_OUTPUTS</span><span class="o">|</span><span class="n">OTG_CTRL_BITS</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">OTG_ID</span><span class="p">;</span>
	<span class="n">omap_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>

	<span class="n">power_up</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_IDLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_omap_h2</span><span class="p">()</span> <span class="o">||</span> <span class="n">machine_is_omap_h3</span><span class="p">())</span>
		<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_MODE_CONTROL_1</span><span class="p">,</span> <span class="n">MC1_DAT_SE0</span><span class="p">);</span>

	<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_RISING</span><span class="p">,</span>
		<span class="n">INTR_SESS_VLD</span><span class="p">);</span>
	<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_FALLING</span><span class="p">,</span>
		<span class="n">INTR_VBUS_VLD</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;B-Peripheral sessions ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dump_regs</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* If this has a Mini-AB connector, this mode is highly</span>
<span class="cm">	 * nonstandard ... but can be handy for testing, so long</span>
<span class="cm">	 * as you don&#39;t plug a Mini-A cable into the jack.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp1301_get_u8</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_SOURCE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INTR_VBUS_VLD</span><span class="p">)</span>
		<span class="n">b_peripheral</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#else</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;peripheral sessions not allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isp1301_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_phy</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">mA</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">the_transceiver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">OTG_STATE_B_PERIPHERAL</span><span class="p">)</span>
		<span class="n">enable_vbus_draw</span><span class="p">(</span><span class="n">the_transceiver</span><span class="p">,</span> <span class="n">mA</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isp1301_start_srp</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_otg</span> <span class="o">*</span><span class="n">otg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1301</span>	<span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp1301</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
	<span class="n">u32</span>		<span class="n">otg_ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">otg</span> <span class="o">||</span> <span class="n">isp</span> <span class="o">!=</span> <span class="n">the_transceiver</span>
			<span class="o">||</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">OTG_STATE_B_IDLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">otg_ctrl</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">otg_ctrl</span> <span class="o">&amp;</span> <span class="n">OTG_BSESSEND</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">otg_ctrl</span> <span class="o">|=</span> <span class="n">OTG_B_BUSREQ</span><span class="p">;</span>
	<span class="n">otg_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OTG_A_BUSREQ</span> <span class="o">&amp;</span> <span class="n">OTG_CTRL_MASK</span><span class="p">;</span>
	<span class="n">omap_writel</span><span class="p">(</span><span class="n">otg_ctrl</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_SRP_INIT</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;otg: SRP, %s ... %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state_name</span><span class="p">(</span><span class="n">isp</span><span class="p">),</span>
			<span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">));</span>
<span class="cp">#ifdef	CONFIG_USB_OTG</span>
	<span class="n">check_state</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isp1301_start_hnp</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_otg</span> <span class="o">*</span><span class="n">otg</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef	CONFIG_USB_OTG</span>
	<span class="k">struct</span> <span class="n">isp1301</span>	<span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp1301</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">otg</span> <span class="o">||</span> <span class="n">isp</span> <span class="o">!=</span> <span class="n">the_transceiver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">default_a</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">b_hnp_enable</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">default_a</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span> <span class="o">==</span> <span class="nb">NULL</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">b_hnp_enable</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>

	<span class="cm">/* We want hardware to manage most HNP protocol timings.</span>
<span class="cm">	 * So do this part as early as possible...</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OTG_STATE_B_HOST</span>:
		<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_PERIPHERAL</span><span class="p">;</span>
		<span class="cm">/* caller will suspend next */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OTG_STATE_A_HOST</span>:
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		/* autoconnect mode avoids irq latency bugs */</span>
<span class="c">		isp1301_set_bits(isp, ISP1301_MODE_CONTROL_1,</span>
<span class="c">				MC1_BDIS_ACON_EN);</span>
<span class="cp">#endif</span>
		<span class="cm">/* caller must suspend then clear A_BUSREQ */</span>
		<span class="n">usb_gadget_vbus_connect</span><span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="n">OTG_A_SETB_HNPEN</span><span class="p">;</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OTG_CTRL</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OTG_STATE_A_PERIPHERAL</span>:
		<span class="cm">/* initiated by B-Host suspend */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;otg: HNP %s, %06x ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">state_name</span><span class="p">(</span><span class="n">isp</span><span class="p">),</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">OTG_CTRL</span><span class="p">));</span>
	<span class="n">check_state</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="cm">/* srp-only */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">isp1301_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1301</span>		<span class="o">*</span><span class="n">isp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">the_transceiver</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">isp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isp</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">isp1301_work</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">isp1301_timer</span><span class="p">;</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">isp</span><span class="p">;</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">isp</span><span class="p">);</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>

	<span class="cm">/* verify the chip (shouldn&#39;t be necessary) */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">isp1301_get_u16</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_VENDOR_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">I2C_VENDOR_ID_PHILIPS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;not philips id: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">isp1301_get_u16</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_PRODUCT_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">I2C_PRODUCT_ID_PHILIPS_1301</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;not isp1301, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">i2c_release</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">isp1301_release</span><span class="p">;</span>

	<span class="cm">/* initial development used chiprev 2.00 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_smbus_read_word_data</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">ISP1301_BCD_DEVICE</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;chiprev %x.%02x, driver &quot;</span> <span class="n">DRIVER_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* make like power-on reset */</span>
	<span class="n">isp1301_clear_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_MODE_CONTROL_1</span><span class="p">,</span> <span class="n">MC1_MASK</span><span class="p">);</span>

	<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_MODE_CONTROL_2</span><span class="p">,</span> <span class="n">MC2_BI_DI</span><span class="p">);</span>
	<span class="n">isp1301_clear_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_MODE_CONTROL_2</span><span class="p">,</span> <span class="o">~</span><span class="n">MC2_BI_DI</span><span class="p">);</span>

	<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_OTG_CONTROL_1</span><span class="p">,</span>
				<span class="n">OTG1_DM_PULLDOWN</span> <span class="o">|</span> <span class="n">OTG1_DP_PULLDOWN</span><span class="p">);</span>
	<span class="n">isp1301_clear_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_OTG_CONTROL_1</span><span class="p">,</span>
				<span class="o">~</span><span class="p">(</span><span class="n">OTG1_DM_PULLDOWN</span> <span class="o">|</span> <span class="n">OTG1_DP_PULLDOWN</span><span class="p">));</span>

	<span class="n">isp1301_clear_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_LATCH</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">isp1301_clear_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_FALLING</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">isp1301_clear_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_RISING</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>

<span class="cp">#ifdef	CONFIG_USB_OTG</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">otg_bind</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t bind OTG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_omap_h2</span><span class="p">())</span> <span class="p">{</span>
		<span class="cm">/* full speed signaling by default */</span>
		<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_MODE_CONTROL_1</span><span class="p">,</span>
			<span class="n">MC1_SPEED</span><span class="p">);</span>
		<span class="n">isp1301_set_bits</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_MODE_CONTROL_2</span><span class="p">,</span>
			<span class="n">MC2_SPD_SUSP_CTRL</span><span class="p">);</span>

		<span class="cm">/* IRQ wired at M14 */</span>
		<span class="n">omap_cfg_reg</span><span class="p">(</span><span class="n">M14_1510_GPIO2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_request</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;isp1301&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">gpio_direction_input</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">isp</span><span class="o">-&gt;</span><span class="n">irq_type</span> <span class="o">=</span> <span class="n">IRQF_TRIGGER_FALLING</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">irq_type</span> <span class="o">|=</span> <span class="n">IRQF_SAMPLE_RANDOM</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">isp1301_irq</span><span class="p">,</span>
			<span class="n">isp</span><span class="o">-&gt;</span><span class="n">irq_type</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t get IRQ %d, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">;</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">set_power</span> <span class="o">=</span> <span class="n">isp1301_set_power</span><span class="p">,</span>

	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">set_host</span> <span class="o">=</span> <span class="n">isp1301_set_host</span><span class="p">,</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">set_peripheral</span> <span class="o">=</span> <span class="n">isp1301_set_peripheral</span><span class="p">,</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">start_srp</span> <span class="o">=</span> <span class="n">isp1301_start_srp</span><span class="p">,</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">start_hnp</span> <span class="o">=</span> <span class="n">isp1301_start_hnp</span><span class="p">,</span>

	<span class="n">enable_vbus_draw</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">power_down</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="n">the_transceiver</span> <span class="o">=</span> <span class="n">isp</span><span class="p">;</span>

<span class="cp">#ifdef	CONFIG_USB_OTG</span>
	<span class="n">update_otg1</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">isp1301_get_u8</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_INTERRUPT_SOURCE</span><span class="p">));</span>
	<span class="n">update_otg2</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">isp1301_get_u8</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISP1301_OTG_STATUS</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="n">dump_regs</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

<span class="cp">#ifdef	VERBOSE</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">TIMER_JIFFIES</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;scheduled timer, %d min</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TIMER_MINUTES</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_set_transceiver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t register transceiver, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">isp1301_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;isp1301_omap&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">isp1301_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">isp1301_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;isp1301_omap&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">isp1301_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">isp1301_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">isp1301_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">isp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1301_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">isp_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">isp_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">the_transceiver</span><span class="p">)</span>
		<span class="n">usb_set_transceiver</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="n">i2c_del_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1301_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">isp_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
