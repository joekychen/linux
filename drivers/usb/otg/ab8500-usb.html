<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › otg › ab8500-usb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ab8500-usb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/usb/otg/ab8500_usb.c</span>
<span class="cm"> *</span>
<span class="cm"> * USB transceiver driver for AB8500 chip</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 ST-Ericsson AB</span>
<span class="cm"> * Mian Yousaf Kaukab &lt;mian.yousaf.kaukab@stericsson.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/usb/otg.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500/ab8500.h&gt;</span>

<span class="cp">#define AB8500_MAIN_WD_CTRL_REG 0x01</span>
<span class="cp">#define AB8500_USB_LINE_STAT_REG 0x80</span>
<span class="cp">#define AB8500_USB_PHY_CTRL_REG 0x8A</span>

<span class="cp">#define AB8500_BIT_OTG_STAT_ID (1 &lt;&lt; 0)</span>
<span class="cp">#define AB8500_BIT_PHY_CTRL_HOST_EN (1 &lt;&lt; 0)</span>
<span class="cp">#define AB8500_BIT_PHY_CTRL_DEVICE_EN (1 &lt;&lt; 1)</span>
<span class="cp">#define AB8500_BIT_WD_CTRL_ENABLE (1 &lt;&lt; 0)</span>
<span class="cp">#define AB8500_BIT_WD_CTRL_KICK (1 &lt;&lt; 1)</span>

<span class="cp">#define AB8500_V1x_LINK_STAT_WAIT (HZ/10)</span>
<span class="cp">#define AB8500_WD_KICK_DELAY_US 100 </span><span class="cm">/* usec */</span><span class="cp"></span>
<span class="cp">#define AB8500_WD_V11_DISABLE_DELAY_US 100 </span><span class="cm">/* usec */</span><span class="cp"></span>
<span class="cp">#define AB8500_WD_V10_DISABLE_DELAY_MS 100 </span><span class="cm">/* ms */</span><span class="cp"></span>

<span class="cm">/* Usb line status register */</span>
<span class="k">enum</span> <span class="n">ab8500_usb_link_status</span> <span class="p">{</span>
	<span class="n">USB_LINK_NOT_CONFIGURED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">USB_LINK_STD_HOST_NC</span><span class="p">,</span>
	<span class="n">USB_LINK_STD_HOST_C_NS</span><span class="p">,</span>
	<span class="n">USB_LINK_STD_HOST_C_S</span><span class="p">,</span>
	<span class="n">USB_LINK_HOST_CHG_NM</span><span class="p">,</span>
	<span class="n">USB_LINK_HOST_CHG_HS</span><span class="p">,</span>
	<span class="n">USB_LINK_HOST_CHG_HS_CHIRP</span><span class="p">,</span>
	<span class="n">USB_LINK_DEDICATED_CHG</span><span class="p">,</span>
	<span class="n">USB_LINK_ACA_RID_A</span><span class="p">,</span>
	<span class="n">USB_LINK_ACA_RID_B</span><span class="p">,</span>
	<span class="n">USB_LINK_ACA_RID_C_NM</span><span class="p">,</span>
	<span class="n">USB_LINK_ACA_RID_C_HS</span><span class="p">,</span>
	<span class="n">USB_LINK_ACA_RID_C_HS_CHIRP</span><span class="p">,</span>
	<span class="n">USB_LINK_HM_IDGND</span><span class="p">,</span>
	<span class="n">USB_LINK_RESERVED</span><span class="p">,</span>
	<span class="n">USB_LINK_NOT_VALID_LINK</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_phy</span> <span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_num_id_rise</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_num_id_fall</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_num_vbus_rise</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_num_vbus_fall</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_num_link_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">vbus_draw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">dwork</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">phy_dis_work</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">link_status_wait</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rev</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="nf">phy_to_ab</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_phy</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ab8500_usb</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_usb_wd_workaround</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_SYS_CTRL2_BLOCK</span><span class="p">,</span>
		<span class="n">AB8500_MAIN_WD_CTRL_REG</span><span class="p">,</span>
		<span class="n">AB8500_BIT_WD_CTRL_ENABLE</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="n">AB8500_WD_KICK_DELAY_US</span><span class="p">);</span>

	<span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_SYS_CTRL2_BLOCK</span><span class="p">,</span>
		<span class="n">AB8500_MAIN_WD_CTRL_REG</span><span class="p">,</span>
		<span class="p">(</span><span class="n">AB8500_BIT_WD_CTRL_ENABLE</span>
		<span class="o">|</span> <span class="n">AB8500_BIT_WD_CTRL_KICK</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="cm">/* v1.1 v2.0 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">AB8500_WD_V11_DISABLE_DELAY_US</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/* v1.0 */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">AB8500_WD_V10_DISABLE_DELAY_MS</span><span class="p">);</span>

	<span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_SYS_CTRL2_BLOCK</span><span class="p">,</span>
		<span class="n">AB8500_MAIN_WD_CTRL_REG</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_usb_phy_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="n">ab</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sel_host</span><span class="p">,</span>
					<span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ctrl_reg</span><span class="p">;</span>
	<span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">AB8500_USB</span><span class="p">,</span>
				<span class="n">AB8500_USB_PHY_CTRL_REG</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ctrl_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sel_host</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
			<span class="n">ctrl_reg</span> <span class="o">|=</span> <span class="n">AB8500_BIT_PHY_CTRL_HOST_EN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctrl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AB8500_BIT_PHY_CTRL_HOST_EN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
			<span class="n">ctrl_reg</span> <span class="o">|=</span> <span class="n">AB8500_BIT_PHY_CTRL_DEVICE_EN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctrl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AB8500_BIT_PHY_CTRL_DEVICE_EN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">AB8500_USB</span><span class="p">,</span>
				<span class="n">AB8500_USB_PHY_CTRL_REG</span><span class="p">,</span>
				<span class="n">ctrl_reg</span><span class="p">);</span>

	<span class="cm">/* Needed to enable the phy.*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">ab8500_usb_wd_workaround</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define ab8500_usb_host_phy_en(ab)	ab8500_usb_phy_ctrl(ab, true, true)</span>
<span class="cp">#define ab8500_usb_host_phy_dis(ab)	ab8500_usb_phy_ctrl(ab, true, false)</span>
<span class="cp">#define ab8500_usb_peri_phy_en(ab)	ab8500_usb_phy_ctrl(ab, false, true)</span>
<span class="cp">#define ab8500_usb_peri_phy_dis(ab)	ab8500_usb_phy_ctrl(ab, false, false)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_usb_link_status_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ab8500_usb_link_status</span> <span class="n">lsts</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">usb_phy_events</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_USB</span><span class="p">,</span>
			<span class="n">AB8500_USB_LINE_STAT_REG</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>

	<span class="n">lsts</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">lsts</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_LINK_NOT_CONFIGURED</span>:
	<span class="k">case</span> <span class="n">USB_LINK_RESERVED</span>:
	<span class="k">case</span> <span class="n">USB_LINK_NOT_VALID_LINK</span>:
		<span class="cm">/* TODO: Disable regulators. */</span>
		<span class="n">ab8500_usb_host_phy_dis</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
		<span class="n">ab8500_usb_peri_phy_dis</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
		<span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_IDLE</span><span class="p">;</span>
		<span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">default_a</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">ab</span><span class="o">-&gt;</span><span class="n">vbus_draw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">USB_EVENT_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_LINK_STD_HOST_NC</span>:
	<span class="k">case</span> <span class="n">USB_LINK_STD_HOST_C_NS</span>:
	<span class="k">case</span> <span class="n">USB_LINK_STD_HOST_C_S</span>:
	<span class="k">case</span> <span class="n">USB_LINK_HOST_CHG_NM</span>:
	<span class="k">case</span> <span class="n">USB_LINK_HOST_CHG_HS</span>:
	<span class="k">case</span> <span class="n">USB_LINK_HOST_CHG_HS_CHIRP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* TODO: Enable regulators. */</span>
			<span class="n">ab8500_usb_peri_phy_en</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">USB_EVENT_VBUS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_LINK_HM_IDGND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* TODO: Enable regulators. */</span>
			<span class="n">ab8500_usb_host_phy_en</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_IDLE</span><span class="p">;</span>
		<span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">default_a</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">USB_EVENT_ID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_LINK_ACA_RID_A</span>:
	<span class="k">case</span> <span class="n">USB_LINK_ACA_RID_B</span>:
		<span class="cm">/* TODO */</span>
	<span class="k">case</span> <span class="n">USB_LINK_ACA_RID_C_NM</span>:
	<span class="k">case</span> <span class="n">USB_LINK_ACA_RID_C_HS</span>:
	<span class="k">case</span> <span class="n">USB_LINK_ACA_RID_C_HS_CHIRP</span>:
	<span class="k">case</span> <span class="n">USB_LINK_DEDICATED_CHG</span>:
		<span class="cm">/* TODO: vbus_draw */</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">USB_EVENT_CHARGER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">notifier</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_usb_delayed_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="n">ab</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ab8500_usb</span><span class="p">,</span>
						<span class="n">dwork</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">ab8500_usb_link_status_update</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_usb_v1x_common_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="n">ab</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Wait for link status to become stable. */</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">dwork</span><span class="p">,</span> <span class="n">ab</span><span class="o">-&gt;</span><span class="n">link_status_wait</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_usb_v1x_vbus_fall_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="n">ab</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Link status will not be updated till phy is disabled. */</span>
	<span class="n">ab8500_usb_peri_phy_dis</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>

	<span class="cm">/* Wait for link status to become stable. */</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">dwork</span><span class="p">,</span> <span class="n">ab</span><span class="o">-&gt;</span><span class="n">link_status_wait</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_usb_v20_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="n">ab</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">ab8500_usb_link_status_update</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_usb_phy_disable_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="n">ab</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ab8500_usb</span><span class="p">,</span>
						<span class="n">phy_dis_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
		<span class="n">ab8500_usb_host_phy_dis</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">)</span>
		<span class="n">ab8500_usb_peri_phy_dis</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_usb_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">mA</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="n">ab</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ab</span> <span class="o">=</span> <span class="n">phy_to_ab</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>

	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">vbus_draw</span> <span class="o">=</span> <span class="n">mA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mA</span><span class="p">)</span>
		<span class="n">atomic_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">notifier</span><span class="p">,</span>
				<span class="n">USB_EVENT_ENUMERATED</span><span class="p">,</span> <span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TODO: Implement some way for charging or other drivers to read</span>
<span class="cm"> * ab-&gt;vbus_draw.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_usb_set_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_phy</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">suspend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TODO */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_usb_set_peripheral</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_otg</span> <span class="o">*</span><span class="n">otg</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="n">ab</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">otg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ab</span> <span class="o">=</span> <span class="n">phy_to_ab</span><span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>

	<span class="cm">/* Some drivers call this function in atomic context.</span>
<span class="cm">	 * Do not update ab8500 registers directly till this</span>
<span class="cm">	 * is fixed.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gadget</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TODO: Disable regulators. */</span>
		<span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy_dis_work</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">gadget</span><span class="p">;</span>
		<span class="n">otg</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_IDLE</span><span class="p">;</span>

		<span class="cm">/* Phy will not be enabled if cable is already</span>
<span class="cm">		 * plugged-in. Schedule to enable phy.</span>
<span class="cm">		 * Use same delay to avoid any race condition.</span>
<span class="cm">		 */</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">dwork</span><span class="p">,</span> <span class="n">ab</span><span class="o">-&gt;</span><span class="n">link_status_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_usb_set_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_otg</span> <span class="o">*</span><span class="n">otg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_bus</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="n">ab</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">otg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ab</span> <span class="o">=</span> <span class="n">phy_to_ab</span><span class="p">(</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>

	<span class="cm">/* Some drivers call this function in atomic context.</span>
<span class="cm">	 * Do not update ab8500 registers directly till this</span>
<span class="cm">	 * is fixed.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TODO: Disable regulators. */</span>
		<span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy_dis_work</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
		<span class="cm">/* Phy will not be enabled if cable is already</span>
<span class="cm">		 * plugged-in. Schedule to enable phy.</span>
<span class="cm">		 * Use same delay to avoid any race condition.</span>
<span class="cm">		 */</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">dwork</span><span class="p">,</span> <span class="n">ab</span><span class="o">-&gt;</span><span class="n">link_status_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_usb_irq_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_id_rise</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_id_fall</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_vbus_rise</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_vbus_fall</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_link_status</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_usb_v1x_res_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_id_rise</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;ID_WAKEUP_R&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_id_rise</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ID rise irq not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_id_rise</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_id_rise</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="n">ab8500_usb_v1x_common_irq</span><span class="p">,</span>
		<span class="n">IRQF_NO_SUSPEND</span> <span class="o">|</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
		<span class="s">&quot;usb-id-rise&quot;</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request_irq failed for ID rise irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_id_fall</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;ID_WAKEUP_F&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_id_fall</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ID fall irq not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_id_fall</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_id_fall</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="n">ab8500_usb_v1x_common_irq</span><span class="p">,</span>
		<span class="n">IRQF_NO_SUSPEND</span> <span class="o">|</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
		<span class="s">&quot;usb-id-fall&quot;</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request_irq failed for ID fall irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_vbus_rise</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;VBUS_DET_R&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_vbus_rise</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VBUS rise irq not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_vbus_rise</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_vbus_rise</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="n">ab8500_usb_v1x_common_irq</span><span class="p">,</span>
		<span class="n">IRQF_NO_SUSPEND</span> <span class="o">|</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
		<span class="s">&quot;usb-vbus-rise&quot;</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request_irq failed for Vbus rise irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_vbus_fall</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;VBUS_DET_F&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_vbus_fall</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VBUS fall irq not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_vbus_fall</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_vbus_fall</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="n">ab8500_usb_v1x_vbus_fall_irq</span><span class="p">,</span>
		<span class="n">IRQF_NO_SUSPEND</span> <span class="o">|</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
		<span class="s">&quot;usb-vbus-fall&quot;</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request_irq failed for Vbus fall irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail3:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_vbus_rise</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>
<span class="nl">fail2:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_id_fall</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>
<span class="nl">fail1:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_id_rise</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>
<span class="nl">fail0:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_usb_v2_res_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_link_status</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
						<span class="s">&quot;USB_LINK_STATUS&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_link_status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Link status irq not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_link_status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">irq_num_link_status</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="n">ab8500_usb_v20_irq</span><span class="p">,</span>
		<span class="n">IRQF_NO_SUSPEND</span> <span class="o">|</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
		<span class="s">&quot;usb-link-status&quot;</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;request_irq failed for link status irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ab8500_usb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_usb</span>	<span class="o">*</span><span class="n">ab</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_otg</span>		<span class="o">*</span><span class="n">otg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rev</span><span class="p">;</span>

	<span class="n">rev</span> <span class="o">=</span> <span class="n">abx500_get_chip_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Chip id read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rev</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unsupported AB8500 chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ab</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">ab</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">otg</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">otg</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">otg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">dev</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">rev</span>			<span class="o">=</span> <span class="n">rev</span><span class="p">;</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="n">ab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span>		<span class="o">=</span> <span class="n">otg</span><span class="p">;</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">label</span>		<span class="o">=</span> <span class="s">&quot;ab8500&quot;</span><span class="p">;</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">set_suspend</span>	<span class="o">=</span> <span class="n">ab8500_usb_set_suspend</span><span class="p">;</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">set_power</span>	<span class="o">=</span> <span class="n">ab8500_usb_set_power</span><span class="p">;</span>
	<span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span>		<span class="o">=</span> <span class="n">OTG_STATE_UNDEFINED</span><span class="p">;</span>

	<span class="n">otg</span><span class="o">-&gt;</span><span class="n">phy</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">otg</span><span class="o">-&gt;</span><span class="n">set_host</span>		<span class="o">=</span> <span class="n">ab8500_usb_set_host</span><span class="p">;</span>
	<span class="n">otg</span><span class="o">-&gt;</span><span class="n">set_peripheral</span>	<span class="o">=</span> <span class="n">ab8500_usb_set_peripheral</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>

	<span class="n">ATOMIC_INIT_NOTIFIER_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">notifier</span><span class="p">);</span>

	<span class="cm">/* v1: Wait for link status to become stable.</span>
<span class="cm">	 * all: Updates form set_host and set_peripheral as they are atomic.</span>
<span class="cm">	 */</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">dwork</span><span class="p">,</span> <span class="n">ab8500_usb_delayed_work</span><span class="p">);</span>

	<span class="cm">/* all: Disable phy when called from set_host and set_peripheral */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy_dis_work</span><span class="p">,</span> <span class="n">ab8500_usb_phy_disable_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ab8500_usb_v1x_res_setup</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>
		<span class="n">ab</span><span class="o">-&gt;</span><span class="n">link_status_wait</span> <span class="o">=</span> <span class="n">AB8500_V1x_LINK_STAT_WAIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ab8500_usb_v2_res_setup</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_set_transceiver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t register transceiver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AB8500 usb driver initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail1:</span>
	<span class="n">ab8500_usb_irq_free</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
<span class="nl">fail0:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">otg</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">ab8500_usb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_usb</span> <span class="o">*</span><span class="n">ab</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ab8500_usb_irq_free</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">dwork</span><span class="p">);</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy_dis_work</span><span class="p">);</span>

	<span class="n">usb_set_transceiver</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="n">ab8500_usb_host_phy_dis</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
	<span class="n">ab8500_usb_peri_phy_dis</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">otg</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ab8500_usb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ab8500_usb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ab8500_usb_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ab8500-usb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ab8500_usb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500_usb_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">ab8500_usb_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ab8500_usb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500_usb_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ab8500_usb_exit</span><span class="p">);</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:ab8500_usb&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;ST-Ericsson AB&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;AB8500 usb transceiver driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
