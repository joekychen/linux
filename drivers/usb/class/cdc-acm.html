<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › class › cdc-acm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cdc-acm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * cdc-acm.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 1999 Armin Fuerst	&lt;fuerst@in.tum.de&gt;</span>
<span class="cm"> * Copyright (c) 1999 Pavel Machek	&lt;pavel@ucw.cz&gt;</span>
<span class="cm"> * Copyright (c) 1999 Johannes Erdfelt	&lt;johannes@erdfelt.com&gt;</span>
<span class="cm"> * Copyright (c) 2000 Vojtech Pavlik	&lt;vojtech@suse.cz&gt;</span>
<span class="cm"> * Copyright (c) 2004 Oliver Neukum	&lt;oliver@neukum.name&gt;</span>
<span class="cm"> * Copyright (c) 2005 David Kubicek	&lt;dave@awk.cz&gt;</span>
<span class="cm"> * Copyright (c) 2011 Johan Hovold	&lt;jhovold@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * USB Abstract Control Model driver for USB modems and ISDN adapters</span>
<span class="cm"> *</span>
<span class="cm"> * Sponsored by SuSE</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#undef DEBUG</span>
<span class="cp">#undef VERBOSE_DEBUG</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/tty_driver.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/cdc.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>

<span class="cp">#include &quot;cdc-acm.h&quot;</span>


<span class="cp">#define DRIVER_AUTHOR &quot;Armin Fuerst, Pavel Machek, Johannes Erdfelt, Vojtech Pavlik, David Kubicek, Johan Hovold&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;USB Abstract Control Model driver for USB modems and ISDN adapters&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">acm_driver</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">acm_tty_driver</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm_table</span><span class="p">[</span><span class="n">ACM_TTY_MINORS</span><span class="p">];</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">acm_table_lock</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * acm_table accessors</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Look up an ACM structure by index. If found and not disconnected, increment</span>
<span class="cm"> * its refcount and return it with its mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="nf">acm_get_by_index</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm_table_lock</span><span class="p">);</span>
	<span class="n">acm</span> <span class="o">=</span> <span class="n">acm_table</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">disconnected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="n">acm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tty_port_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm_table_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">acm</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try to find an available minor number and if found, associate it with &#39;acm&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_alloc_minor</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">minor</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm_table_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">minor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">minor</span> <span class="o">&lt;</span> <span class="n">ACM_TTY_MINORS</span><span class="p">;</span> <span class="n">minor</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acm_table</span><span class="p">[</span><span class="n">minor</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">acm_table</span><span class="p">[</span><span class="n">minor</span><span class="p">]</span> <span class="o">=</span> <span class="n">acm</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm_table_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">minor</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Release the minor number associated with &#39;acm&#39;.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_release_minor</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm_table_lock</span><span class="p">);</span>
	<span class="n">acm_table</span><span class="p">[</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm_table_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Functions for ACM control messages.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_ctrl_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span>
							<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">request</span><span class="p">,</span> <span class="n">USB_RT_ACM</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
		<span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span>
		<span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - rq 0x%02x, val %#x, len %#x, result %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">retval</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* devices aren&#39;t required to support these requests.</span>
<span class="cm"> * the cdc acm descriptor tells whether they do...</span>
<span class="cm"> */</span>
<span class="cp">#define acm_set_control(acm, control) \</span>
<span class="cp">	acm_ctrl_msg(acm, USB_CDC_REQ_SET_CONTROL_LINE_STATE, control, NULL, 0)</span>
<span class="cp">#define acm_set_line(acm, line) \</span>
<span class="cp">	acm_ctrl_msg(acm, USB_CDC_REQ_SET_LINE_CODING, 0, line, sizeof *(line))</span>
<span class="cp">#define acm_send_break(acm, ms) \</span>
<span class="cp">	acm_ctrl_msg(acm, USB_CDC_REQ_SEND_BREAK, ms, NULL, 0)</span>

<span class="cm">/*</span>
<span class="cm"> * Write buffer management.</span>
<span class="cm"> * All of these assume proper locks taken by the caller.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_wb_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">wbn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acm_wb</span> <span class="o">*</span><span class="n">wb</span><span class="p">;</span>

	<span class="n">wbn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">wb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">[</span><span class="n">wbn</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wb</span><span class="o">-&gt;</span><span class="n">use</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wb</span><span class="o">-&gt;</span><span class="n">use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">wbn</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wbn</span> <span class="o">=</span> <span class="p">(</span><span class="n">wbn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ACM_NW</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ACM_NW</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_wb_is_avail</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">ACM_NW</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ACM_NW</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">-=</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">use</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Finish write. Caller must hold acm-&gt;write_lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_write_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">acm_wb</span> <span class="o">*</span><span class="n">wb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wb</span><span class="o">-&gt;</span><span class="n">use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">transmitting</span><span class="o">--</span><span class="p">;</span>
	<span class="n">usb_autopm_put_interface_async</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Poke write.</span>
<span class="cm"> *</span>
<span class="cm"> * the caller is responsible for locking</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_start_wb</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">acm_wb</span> <span class="o">*</span><span class="n">wb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">transmitting</span><span class="o">++</span><span class="p">;</span>

	<span class="n">wb</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">wb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">wb</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span> <span class="o">=</span> <span class="n">wb</span><span class="o">-&gt;</span><span class="n">dmah</span><span class="p">;</span>
	<span class="n">wb</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="n">wb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">wb</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">wb</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - usb_submit_urb(write bulk) failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">acm_write_done</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">wb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_write_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wbn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acm_wb</span> <span class="o">*</span><span class="n">wb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">[</span><span class="n">wbn</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wb</span><span class="o">-&gt;</span><span class="n">use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - susp_count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
							<span class="n">acm</span><span class="o">-&gt;</span><span class="n">susp_count</span><span class="p">);</span>
	<span class="n">usb_autopm_get_interface_async</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">susp_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">delayed_wb</span><span class="p">)</span>
			<span class="n">acm</span><span class="o">-&gt;</span><span class="n">delayed_wb</span> <span class="o">=</span> <span class="n">wb</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">usb_autopm_put_interface_async</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* A white lie */</span>
	<span class="p">}</span>
	<span class="n">usb_mark_last_busy</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">acm_start_wb</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">wb</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * attributes exported through sysfs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_caps</span>
<span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span> <span class="o">=</span> <span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrl_caps</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">bmCapabilities</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_caps</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_country_codes</span>
<span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span> <span class="o">=</span> <span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">country_codes</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">country_code_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">country_code_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wCountryCodes</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_country_codes</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_country_rel_date</span>
<span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span> <span class="o">=</span> <span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">country_rel_date</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">iCountryCodeRelDate</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_country_rel_date</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> * Interrupt handlers for various ACM device responses</span>
<span class="cm"> */</span>

<span class="cm">/* control interface reports status changes with &quot;interrupt&quot; transfers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_ctrl_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_cdc_notification</span> <span class="o">*</span><span class="n">dr</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">newctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* success */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* this urb is terminated, clean up */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s - urb shutting down with status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s - nonzero urb status received: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_mark_last_busy</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">dr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">bNotificationType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_CDC_NOTIFY_NETWORK_CONNECTION</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - network connection: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_CDC_NOTIFY_SERIAL_STATE</span>:
		<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">newctrl</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">clocal</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlin</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">newctrl</span> <span class="o">&amp;</span> <span class="n">ACM_CTRL_DCD</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s - calling hangup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">tty_hangup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlin</span> <span class="o">=</span> <span class="n">newctrl</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - input control lines: dcd%c dsr%c break%c &quot;</span>
			<span class="s">&quot;ring%c framing%c parity%c overrun%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlin</span> <span class="o">&amp;</span> <span class="n">ACM_CTRL_DCD</span> <span class="o">?</span> <span class="sc">&#39;+&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
			<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlin</span> <span class="o">&amp;</span> <span class="n">ACM_CTRL_DSR</span> <span class="o">?</span> <span class="sc">&#39;+&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
			<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlin</span> <span class="o">&amp;</span> <span class="n">ACM_CTRL_BRK</span> <span class="o">?</span> <span class="sc">&#39;+&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
			<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlin</span> <span class="o">&amp;</span> <span class="n">ACM_CTRL_RI</span>  <span class="o">?</span> <span class="sc">&#39;+&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
			<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlin</span> <span class="o">&amp;</span> <span class="n">ACM_CTRL_FRAMING</span> <span class="o">?</span> <span class="sc">&#39;+&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
			<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlin</span> <span class="o">&amp;</span> <span class="n">ACM_CTRL_PARITY</span> <span class="o">?</span> <span class="sc">&#39;+&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
			<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlin</span> <span class="o">&amp;</span> <span class="n">ACM_CTRL_OVERRUN</span> <span class="o">?</span> <span class="sc">&#39;+&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - unknown notification %d received: index %d &quot;</span>
			<span class="s">&quot;len %d data0 %d data1 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="n">dr</span><span class="o">-&gt;</span><span class="n">bNotificationType</span><span class="p">,</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">,</span>
			<span class="n">dr</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - usb_submit_urb failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_submit_read_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">mem_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_urbs_free</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - urb %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_urbs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">mem_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s - usb_submit_urb failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_urbs_free</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_submit_read_urbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">mem_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">rx_buflimit</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">acm_submit_read_urb</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mem_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_process_read_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tty_insert_flip_string</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_read_bulk_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm_rb</span> <span class="o">*</span><span class="n">rb</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - urb %d, len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">rb</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_urbs_free</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usb_mark_last_busy</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - non-zero urb status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">acm_process_read_urb</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>

	<span class="cm">/* throttle device if requested by tty */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">throttled</span> <span class="o">=</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">throttle_req</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">throttled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">susp_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">acm_submit_read_urb</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* data interface wrote those outgoing bytes */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_write_bulk</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm_wb</span> <span class="o">*</span><span class="n">wb</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">wb</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span>	<span class="o">||</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">!=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">))</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - len %d/%d, status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">acm_write_done</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">wb</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_softint</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">acm</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TTY handlers</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_tty_install</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">acm</span> <span class="o">=</span> <span class="n">acm_get_by_index</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acm</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_standard_install</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_init_termios</span><span class="p">;</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">acm</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_init_termios:</span>
	<span class="n">tty_port_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_tty_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tty_port_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_port_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">acm</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">disconnected</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">disconnected</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_autopm_get_interface</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_get_interface</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: Why do we need this? Allocating 64K of physically contiguous</span>
<span class="cm">	 * memory is really nasty...</span>
<span class="cm">	 */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_NO_WRITE_SPLIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">needs_remote_wakeup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlurb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlurb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - usb_submit_urb(ctrl irq) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_submit_urb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlout</span> <span class="o">=</span> <span class="n">ACM_CTRL_DTR</span> <span class="o">|</span> <span class="n">ACM_CTRL_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acm_set_control</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrl_caps</span> <span class="o">&amp;</span> <span class="n">USB_CDC_CAP_LINE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error_set_control</span><span class="p">;</span>

	<span class="n">usb_autopm_put_interface</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Unthrottle device in case the TTY was closed while throttled.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">throttled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">throttle_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acm_submit_read_urbs</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error_submit_read_urbs</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_submit_read_urbs:</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">acm_set_control</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlout</span><span class="p">);</span>
<span class="nl">error_set_control:</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlurb</span><span class="p">);</span>
<span class="nl">error_submit_urb:</span>
	<span class="n">usb_autopm_put_interface</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
<span class="nl">error_get_interface:</span>
<span class="nl">disconnected:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_port_destruct</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">acm</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">tty_unregister_device</span><span class="p">(</span><span class="n">acm_tty_driver</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
	<span class="n">acm_release_minor</span><span class="p">(</span><span class="n">acm</span><span class="p">);</span>
	<span class="n">usb_put_intf</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">country_codes</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_port_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">acm</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">disconnected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_autopm_get_interface</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
		<span class="n">acm_set_control</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlurb</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ACM_NW</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">rx_buflimit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_urbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">needs_remote_wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">usb_autopm_put_interface</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_tty_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">tty_port_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_tty_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">tty_port_hangup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_tty_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">tty_port_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_tty_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wbn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acm_wb</span> <span class="o">*</span><span class="n">wb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wbn</span> <span class="o">=</span> <span class="n">acm_wb_alloc</span><span class="p">(</span><span class="n">acm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wbn</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">[</span><span class="n">wbn</span><span class="p">];</span>

	<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">)</span> <span class="o">?</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - write %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">wb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">acm_write_start</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">wbn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_tty_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Do not let the line discipline to know that we have a reserve,</span>
<span class="cm">	 * or it might get too enthusiastic.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">acm_wb_is_avail</span><span class="p">(</span><span class="n">acm</span><span class="p">)</span> <span class="o">?</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_tty_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * if the device was unplugged then any remaining characters fell out</span>
<span class="cm">	 * of the connector ;)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">disconnected</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * This is inaccurate (overcounts), but it works.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ACM_NW</span> <span class="o">-</span> <span class="n">acm_wb_is_avail</span><span class="p">(</span><span class="n">acm</span><span class="p">))</span> <span class="o">*</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_tty_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">throttle_req</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_tty_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">was_throttled</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>
	<span class="n">was_throttled</span> <span class="o">=</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">throttled</span><span class="p">;</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">throttled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">throttle_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">was_throttled</span><span class="p">)</span>
		<span class="n">acm_submit_read_urbs</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_tty_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">acm_send_break</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">state</span> <span class="o">?</span> <span class="mh">0xffff</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - send break failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_tty_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlout</span> <span class="o">&amp;</span> <span class="n">ACM_CTRL_DTR</span> <span class="o">?</span> <span class="n">TIOCM_DTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlout</span> <span class="o">&amp;</span> <span class="n">ACM_CTRL_RTS</span> <span class="o">?</span> <span class="n">TIOCM_RTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlin</span>  <span class="o">&amp;</span> <span class="n">ACM_CTRL_DSR</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlin</span>  <span class="o">&amp;</span> <span class="n">ACM_CTRL_RI</span>  <span class="o">?</span> <span class="n">TIOCM_RI</span>  <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlin</span>  <span class="o">&amp;</span> <span class="n">ACM_CTRL_DCD</span> <span class="o">?</span> <span class="n">TIOCM_CD</span>  <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">TIOCM_CTS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_tty_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">newctrl</span><span class="p">;</span>

	<span class="n">newctrl</span> <span class="o">=</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlout</span><span class="p">;</span>
	<span class="n">set</span> <span class="o">=</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span> <span class="o">?</span> <span class="n">ACM_CTRL_DTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span> <span class="o">?</span> <span class="n">ACM_CTRL_RTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">clear</span> <span class="o">=</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span> <span class="o">?</span> <span class="n">ACM_CTRL_DTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span> <span class="o">?</span> <span class="n">ACM_CTRL_RTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">newctrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">newctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">clear</span><span class="p">)</span> <span class="o">|</span> <span class="n">set</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlout</span> <span class="o">==</span> <span class="n">newctrl</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">acm_set_control</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlout</span> <span class="o">=</span> <span class="n">newctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ASYNC_LOW_LATENCY</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">xmit_fifo_size</span> <span class="o">=</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">baud_base</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">.</span><span class="n">dwDTERate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_tty_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIOCGSERIAL</span>: <span class="cm">/* gets serial port data */</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">get_serial_info</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">__u32</span> <span class="n">acm_tty_speed</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span>
	<span class="mi">1200</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="mi">2400</span><span class="p">,</span> <span class="mi">4800</span><span class="p">,</span> <span class="mi">9600</span><span class="p">,</span> <span class="mi">19200</span><span class="p">,</span> <span class="mi">38400</span><span class="p">,</span>
	<span class="mi">57600</span><span class="p">,</span> <span class="mi">115200</span><span class="p">,</span> <span class="mi">230400</span><span class="p">,</span> <span class="mi">460800</span><span class="p">,</span> <span class="mi">500000</span><span class="p">,</span> <span class="mi">576000</span><span class="p">,</span>
	<span class="mi">921600</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mi">1152000</span><span class="p">,</span> <span class="mi">1500000</span><span class="p">,</span> <span class="mi">2000000</span><span class="p">,</span>
	<span class="mi">2500000</span><span class="p">,</span> <span class="mi">3000000</span><span class="p">,</span> <span class="mi">3500000</span><span class="p">,</span> <span class="mi">4000000</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">__u8</span> <span class="n">acm_tty_size</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_tty_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios_old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_cdc_line_coding</span> <span class="n">newline</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">newctrl</span> <span class="o">=</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlout</span><span class="p">;</span>

	<span class="n">newline</span><span class="p">.</span><span class="n">dwDTERate</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
	<span class="n">newline</span><span class="p">.</span><span class="n">bCharFormat</span> <span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">newline</span><span class="p">.</span><span class="n">bParityType</span> <span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span> <span class="o">?</span>
				<span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CMSPAR</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">newline</span><span class="p">.</span><span class="n">bDataBits</span> <span class="o">=</span> <span class="n">acm_tty_size</span><span class="p">[(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">];</span>
	<span class="cm">/* FIXME: Needs to clear unsupported bits in the termios */</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">clocal</span> <span class="o">=</span> <span class="p">((</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newline</span><span class="p">.</span><span class="n">dwDTERate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">newline</span><span class="p">.</span><span class="n">dwDTERate</span> <span class="o">=</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">.</span><span class="n">dwDTERate</span><span class="p">;</span>
		<span class="n">newctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACM_CTRL_DTR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">newctrl</span> <span class="o">|=</span>  <span class="n">ACM_CTRL_DTR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newctrl</span> <span class="o">!=</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlout</span><span class="p">)</span>
		<span class="n">acm_set_control</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlout</span> <span class="o">=</span> <span class="n">newctrl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newline</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">newline</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newline</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">newline</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - set line: %d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">newline</span><span class="p">.</span><span class="n">dwDTERate</span><span class="p">),</span>
			<span class="n">newline</span><span class="p">.</span><span class="n">bCharFormat</span><span class="p">,</span> <span class="n">newline</span><span class="p">.</span><span class="n">bParityType</span><span class="p">,</span>
			<span class="n">newline</span><span class="p">.</span><span class="n">bDataBits</span><span class="p">);</span>
		<span class="n">acm_set_line</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_port_operations</span> <span class="n">acm_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">acm_port_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">acm_port_activate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destruct</span> <span class="o">=</span> <span class="n">acm_port_destruct</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * USB probe and disconnect routines.</span>
<span class="cm"> */</span>

<span class="cm">/* Little helpers: write/read buffers free */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_write_buffers_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acm_wb</span> <span class="o">*</span><span class="n">wb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">wb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ACM_NW</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">wb</span><span class="o">++</span><span class="p">)</span>
		<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="n">wb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">wb</span><span class="o">-&gt;</span><span class="n">dmah</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_read_buffers_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">rx_buflimit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">readsize</span><span class="p">,</span>
			  <span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Little helper: write buffers allocate */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_write_buffers_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acm_wb</span> <span class="o">*</span><span class="n">wb</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">wb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ACM_NW</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">wb</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wb</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">wb</span><span class="o">-&gt;</span><span class="n">dmah</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">--</span><span class="n">i</span><span class="p">;</span>
				<span class="o">--</span><span class="n">wb</span><span class="p">;</span>
				<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span>
				    <span class="n">wb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">wb</span><span class="o">-&gt;</span><span class="n">dmah</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
		     <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_cdc_union_desc</span> <span class="o">*</span><span class="n">union_header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_cdc_country_functional_desc</span> <span class="o">*</span><span class="n">cfd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buflen</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="o">-&gt;</span><span class="n">extralen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">control_interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">data_interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">epctrl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">epread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">epwrite</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">minor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ctrlsize</span><span class="p">,</span> <span class="n">readsize</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ac_management_function</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">call_management_function</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">call_interface_num</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_interface_num</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">quirks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_rx_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">combined_interfaces</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* normal quirks */</span>
	<span class="n">quirks</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">;</span>
	<span class="n">num_rx_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">quirks</span> <span class="o">==</span> <span class="n">SINGLE_RX_URB</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">ACM_NR</span><span class="p">;</span>

	<span class="cm">/* handle quirks deadly to normal probing*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quirks</span> <span class="o">==</span> <span class="n">NO_UNION_NORMAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data_interface</span> <span class="o">=</span> <span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">control_interface</span> <span class="o">=</span> <span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">skip_normal_probe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* normal probing*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Weird descriptor references</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buflen</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">&amp;&amp;</span>
				<span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">extralen</span> <span class="o">&amp;&amp;</span>
				<span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Seeking extra descriptors on endpoint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">buflen</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">extralen</span><span class="p">;</span>
			<span class="n">buffer</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Zero length descriptor references</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;skipping garbage</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">next_desc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_CDC_UNION_TYPE</span>: <span class="cm">/* we&#39;ve found it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">union_header</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;More than one &quot;</span>
					<span class="s">&quot;union descriptor, skipping ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">next_desc</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">union_header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_union_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_CDC_COUNTRY_TYPE</span>: <span class="cm">/* export through sysfs*/</span>
			<span class="n">cfd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_country_functional_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_CDC_HEADER_TYPE</span>: <span class="cm">/* maybe check version */</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* for now we ignore it */</span>
		<span class="k">case</span> <span class="n">USB_CDC_ACM_TYPE</span>:
			<span class="n">ac_management_function</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_CDC_CALL_MANAGEMENT_TYPE</span>:
			<span class="n">call_management_function</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">call_interface_num</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">NOT_A_MODEM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">call_management_function</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;This device cannot do calls on its own. It is not a modem.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* there are LOTS more CDC descriptors that</span>
<span class="cm">			 * could legitimately be found here.</span>
<span class="cm">			 */</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Ignoring descriptor: &quot;</span>
					<span class="s">&quot;type %02x, length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="nl">next_desc:</span>
		<span class="n">buflen</span> <span class="o">-=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">buffer</span> <span class="o">+=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">union_header</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call_interface_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No union descriptor, using call management descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* quirks for Droids MuIn LCD */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">NO_DATA_INTERFACE</span><span class="p">)</span>
				<span class="n">data_interface</span> <span class="o">=</span> <span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">data_interface</span> <span class="o">=</span> <span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="p">(</span><span class="n">data_interface_num</span> <span class="o">=</span> <span class="n">call_interface_num</span><span class="p">));</span>
			<span class="n">control_interface</span> <span class="o">=</span> <span class="n">intf</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;No union descriptor, giving up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;No union descriptor, testing for castrated device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">combined_interfaces</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">control_interface</span> <span class="o">=</span> <span class="n">data_interface</span> <span class="o">=</span> <span class="n">intf</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">look_for_collapsed_interface</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">control_interface</span> <span class="o">=</span> <span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">union_header</span><span class="o">-&gt;</span><span class="n">bMasterInterface0</span><span class="p">);</span>
		<span class="n">data_interface</span> <span class="o">=</span> <span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="p">(</span><span class="n">data_interface_num</span> <span class="o">=</span> <span class="n">union_header</span><span class="o">-&gt;</span><span class="n">bSlaveInterface0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">control_interface</span> <span class="o">||</span> <span class="o">!</span><span class="n">data_interface</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no interfaces</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_interface_num</span> <span class="o">!=</span> <span class="n">call_interface_num</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Separate call control interface. That is not fully supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">control_interface</span> <span class="o">==</span> <span class="n">data_interface</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* some broken devices designed for windows work this way */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;Control and data interfaces are not separated!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">combined_interfaces</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* a popular other OS doesn&#39;t use it */</span>
		<span class="n">quirks</span> <span class="o">|=</span> <span class="n">NO_CAP_LINE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;This needs exactly 3 endpoints</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
<span class="nl">look_for_collapsed_interface:</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data_interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_is_int_in</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span>
				<span class="n">epctrl</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_is_bulk_out</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span>
				<span class="n">epwrite</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_is_bulk_in</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span>
				<span class="n">epread</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">epctrl</span> <span class="o">||</span> <span class="o">!</span><span class="n">epread</span> <span class="o">||</span> <span class="o">!</span><span class="n">epwrite</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">made_compressed_probe</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">skip_normal_probe:</span>

	<span class="cm">/*workaround for switched interfaces */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceClass</span>
						<span class="o">!=</span> <span class="n">CDC_DATA_INTERFACE_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">control_interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceClass</span>
						<span class="o">==</span> <span class="n">CDC_DATA_INTERFACE_TYPE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Your device has switched interfaces.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">control_interface</span><span class="p">;</span>
			<span class="n">control_interface</span> <span class="o">=</span> <span class="n">data_interface</span><span class="p">;</span>
			<span class="n">data_interface</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Accept probe requests only for the control interface */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">combined_interfaces</span> <span class="o">&amp;&amp;</span> <span class="n">intf</span> <span class="o">!=</span> <span class="n">control_interface</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">combined_interfaces</span> <span class="o">&amp;&amp;</span> <span class="n">usb_interface_claimed</span><span class="p">(</span><span class="n">data_interface</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* valid in this context */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The data interface isn&#39;t available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">data_interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">epctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">control_interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">epread</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data_interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">epwrite</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data_interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>


	<span class="cm">/* workaround for switched endpoints */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="n">epread</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* descriptors are swapped */</span>
		<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;The data interface has switched endpoints</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">epread</span><span class="p">;</span>
		<span class="n">epread</span> <span class="o">=</span> <span class="n">epwrite</span><span class="p">;</span>
		<span class="n">epwrite</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">made_compressed_probe:</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;interfaces are valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">acm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory (acm kzalloc)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">alloc_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">minor</span> <span class="o">=</span> <span class="n">acm_alloc_minor</span><span class="p">(</span><span class="n">acm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minor</span> <span class="o">==</span> <span class="n">ACM_TTY_MINORS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no more free acm devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">acm</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctrlsize</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">epctrl</span><span class="p">);</span>
	<span class="n">readsize</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">epread</span><span class="p">)</span> <span class="o">*</span>
				<span class="p">(</span><span class="n">quirks</span> <span class="o">==</span> <span class="n">SINGLE_RX_URB</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">combined_interfaces</span> <span class="o">=</span> <span class="n">combined_interfaces</span><span class="p">;</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">writesize</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">epwrite</span><span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="n">control_interface</span><span class="p">;</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data_interface</span><span class="p">;</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">minor</span><span class="p">;</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usb_dev</span><span class="p">;</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrl_caps</span> <span class="o">=</span> <span class="n">ac_management_function</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">NO_CAP_LINE</span><span class="p">)</span>
		<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrl_caps</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_CDC_CAP_LINE</span><span class="p">;</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlsize</span> <span class="o">=</span> <span class="n">ctrlsize</span><span class="p">;</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">readsize</span> <span class="o">=</span> <span class="n">readsize</span><span class="p">;</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">rx_buflimit</span> <span class="o">=</span> <span class="n">num_rx_buf</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">acm_softint</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">rx_endpoint</span> <span class="o">=</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">epread</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">is_int_ep</span> <span class="o">=</span> <span class="n">usb_endpoint_xfer_int</span><span class="p">(</span><span class="n">epread</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">is_int_ep</span><span class="p">)</span>
		<span class="n">acm</span><span class="o">-&gt;</span><span class="n">bInterval</span> <span class="o">=</span> <span class="n">epread</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">;</span>
	<span class="n">tty_port_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acm_port_ops</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">ctrlsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrl_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory (ctrl buffer alloc)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">alloc_fail2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrl_buffer</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acm_write_buffers_alloc</span><span class="p">(</span><span class="n">acm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory (write buffer alloc)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">alloc_fail4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlurb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlurb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory (ctrlurb kmalloc)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">alloc_fail5</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_rx_buf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">acm_rb</span> <span class="o">*</span><span class="n">rb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>

		<span class="n">rb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">readsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory &quot;</span>
					<span class="s">&quot;(read bufs usb_alloc_coherent)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">alloc_fail6</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rb</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">rb</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">=</span> <span class="n">acm</span><span class="p">;</span>

		<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;out of memory (read urbs usb_alloc_urb)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">alloc_fail6</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span> <span class="o">=</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">is_int_ep</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">acm</span><span class="o">-&gt;</span><span class="n">rx_endpoint</span><span class="p">,</span>
					 <span class="n">rb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
					 <span class="n">acm</span><span class="o">-&gt;</span><span class="n">readsize</span><span class="p">,</span>
					 <span class="n">acm_read_bulk_callback</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span>
					 <span class="n">acm</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">acm</span><span class="o">-&gt;</span><span class="n">rx_endpoint</span><span class="p">,</span>
					  <span class="n">rb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
					  <span class="n">acm</span><span class="o">-&gt;</span><span class="n">readsize</span><span class="p">,</span>
					  <span class="n">acm_read_bulk_callback</span><span class="p">,</span> <span class="n">rb</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_urbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">urb</span><span class="p">;</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_urbs_free</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ACM_NW</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">acm_wb</span> <span class="o">*</span><span class="n">snd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">snd</span><span class="o">-&gt;</span><span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd</span><span class="o">-&gt;</span><span class="n">urb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;out of memory (write urbs usb_alloc_urb)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">alloc_fail7</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_xfer_int</span><span class="p">(</span><span class="n">epwrite</span><span class="p">))</span>
			<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">snd</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">,</span> <span class="n">usb_dev</span><span class="p">,</span>
				<span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">epwrite</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">),</span>
				<span class="nb">NULL</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="n">acm_write_bulk</span><span class="p">,</span> <span class="n">snd</span><span class="p">,</span> <span class="n">epwrite</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">snd</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">,</span> <span class="n">usb_dev</span><span class="p">,</span>
				<span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">epwrite</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">),</span>
				<span class="nb">NULL</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">writesize</span><span class="p">,</span> <span class="n">acm_write_bulk</span><span class="p">,</span> <span class="n">snd</span><span class="p">);</span>
		<span class="n">snd</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>
		<span class="n">snd</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">=</span> <span class="n">acm</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">acm</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_bmCapabilities</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">alloc_fail7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfd</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* export the country data */</span>
		<span class="n">acm</span><span class="o">-&gt;</span><span class="n">country_codes</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">cfd</span><span class="o">-&gt;</span><span class="n">bLength</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">country_codes</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">skip_countries</span><span class="p">;</span>
		<span class="n">acm</span><span class="o">-&gt;</span><span class="n">country_code_size</span> <span class="o">=</span> <span class="n">cfd</span><span class="o">-&gt;</span><span class="n">bLength</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">country_codes</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cfd</span><span class="o">-&gt;</span><span class="n">wCountyCode0</span><span class="p">,</span>
							<span class="n">cfd</span><span class="o">-&gt;</span><span class="n">bLength</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">acm</span><span class="o">-&gt;</span><span class="n">country_rel_date</span> <span class="o">=</span> <span class="n">cfd</span><span class="o">-&gt;</span><span class="n">iCountryCodeRelDate</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_wCountryCodes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">country_codes</span><span class="p">);</span>
			<span class="n">acm</span><span class="o">-&gt;</span><span class="n">country_codes</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">acm</span><span class="o">-&gt;</span><span class="n">country_code_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">skip_countries</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dev_attr_iCountryCodeRelDate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_wCountryCodes</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">country_codes</span><span class="p">);</span>
			<span class="n">acm</span><span class="o">-&gt;</span><span class="n">country_codes</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">acm</span><span class="o">-&gt;</span><span class="n">country_code_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">skip_countries</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">skip_countries:</span>
	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlurb</span><span class="p">,</span> <span class="n">usb_dev</span><span class="p">,</span>
			 <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">epctrl</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">),</span>
			 <span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrl_buffer</span><span class="p">,</span> <span class="n">ctrlsize</span><span class="p">,</span> <span class="n">acm_ctrl_irq</span><span class="p">,</span> <span class="n">acm</span><span class="p">,</span>
			 <span class="cm">/* works around buggy devices */</span>
			 <span class="n">epctrl</span><span class="o">-&gt;</span><span class="n">bInterval</span> <span class="o">?</span> <span class="n">epctrl</span><span class="o">-&gt;</span><span class="n">bInterval</span> <span class="o">:</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlurb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlurb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span> <span class="o">=</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrl_dma</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ttyACM%d: USB ACM device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>

	<span class="n">acm_set_control</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlout</span><span class="p">);</span>

	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">.</span><span class="n">dwDTERate</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">.</span><span class="n">bDataBits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">acm_set_line</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>

	<span class="n">usb_driver_claim_interface</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm_driver</span><span class="p">,</span> <span class="n">data_interface</span><span class="p">,</span> <span class="n">acm</span><span class="p">);</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">data_interface</span><span class="p">,</span> <span class="n">acm</span><span class="p">);</span>

	<span class="n">usb_get_intf</span><span class="p">(</span><span class="n">control_interface</span><span class="p">);</span>
	<span class="n">tty_register_device</span><span class="p">(</span><span class="n">acm_tty_driver</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control_interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">alloc_fail7:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ACM_NW</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span><span class="p">);</span>
<span class="nl">alloc_fail6:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_rx_buf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_urbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">acm_read_buffers_free</span><span class="p">(</span><span class="n">acm</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlurb</span><span class="p">);</span>
<span class="nl">alloc_fail5:</span>
	<span class="n">acm_write_buffers_free</span><span class="p">(</span><span class="n">acm</span><span class="p">);</span>
<span class="nl">alloc_fail4:</span>
	<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">ctrlsize</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrl_buffer</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrl_dma</span><span class="p">);</span>
<span class="nl">alloc_fail2:</span>
	<span class="n">acm_release_minor</span><span class="p">(</span><span class="n">acm</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acm</span><span class="p">);</span>
<span class="nl">alloc_fail:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_data_traffic</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlurb</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ACM_NW</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">rx_buflimit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_urbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* sibling interface is already cleaning up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acm</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">disconnected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">country_codes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev_attr_wCountryCodes</span><span class="p">);</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev_attr_iCountryCodeRelDate</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_bmCapabilities</span><span class="p">);</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_vhangup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">stop_data_traffic</span><span class="p">(</span><span class="n">acm</span><span class="p">);</span>

	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlurb</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ACM_NW</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">wb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">rx_buflimit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_urbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">acm_write_buffers_free</span><span class="p">(</span><span class="n">acm</span><span class="p">);</span>
	<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlsize</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrl_buffer</span><span class="p">,</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrl_dma</span><span class="p">);</span>
	<span class="n">acm_read_buffers_free</span><span class="p">(</span><span class="n">acm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">combined_interfaces</span><span class="p">)</span>
		<span class="n">usb_driver_release_interface</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm_driver</span><span class="p">,</span> <span class="n">intf</span> <span class="o">==</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">?</span>
					<span class="n">acm</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">:</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>

	<span class="n">tty_port_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PMSG_IS_AUTO</span><span class="p">(</span><span class="n">message</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">b</span><span class="p">;</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">transmitting</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">susp_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ASYNCB_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">stop_data_traffic</span><span class="p">(</span><span class="n">acm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">acm_wb</span> <span class="o">*</span><span class="n">wb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>
	<span class="n">acm</span><span class="o">-&gt;</span><span class="n">susp_count</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">susp_count</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ASYNCB_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">ctrlurb</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">delayed_wb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wb</span> <span class="o">=</span> <span class="n">acm</span><span class="o">-&gt;</span><span class="n">delayed_wb</span><span class="p">;</span>
			<span class="n">acm</span><span class="o">-&gt;</span><span class="n">delayed_wb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
			<span class="n">acm_start_wb</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">wb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * delayed error checking because we must</span>
<span class="cm">		 * do the write path at all cost</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="n">rv</span> <span class="o">=</span> <span class="n">acm_submit_read_urbs</span><span class="p">(</span><span class="n">acm</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acm_reset_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acm</span> <span class="o">*</span><span class="n">acm</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ASYNCB_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tty_hangup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">acm_resume</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#define NOKIA_PCSUITE_ACM_INFO(x) \</span>
<span class="cp">		USB_DEVICE_AND_INTERFACE_INFO(0x0421, x, \</span>
<span class="cp">		USB_CLASS_COMM, USB_CDC_SUBCLASS_ACM, \</span>
<span class="cp">		USB_CDC_ACM_PROTO_VENDOR)</span>

<span class="cp">#define SAMSUNG_PCSUITE_ACM_INFO(x) \</span>
<span class="cp">		USB_DEVICE_AND_INTERFACE_INFO(0x04e7, x, \</span>
<span class="cp">		USB_CLASS_COMM, USB_CDC_SUBCLASS_ACM, \</span>
<span class="cp">		USB_CDC_ACM_PROTO_VENDOR)</span>

<span class="cm">/*</span>
<span class="cm"> * USB driver structure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">acm_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* quirky and broken devices */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0870</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="cm">/* Metricom GS Modem */</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">NO_UNION_NORMAL</span><span class="p">,</span> <span class="cm">/* has no union descriptor */</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0e8d</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">),</span> <span class="cm">/* FIREFLY, MediaTek Inc; andrey.arapov@gmail.com */</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">NO_UNION_NORMAL</span><span class="p">,</span> <span class="cm">/* has no union descriptor */</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0e8d</span><span class="p">,</span> <span class="mh">0x3329</span><span class="p">),</span> <span class="cm">/* MediaTek Inc GPS */</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">NO_UNION_NORMAL</span><span class="p">,</span> <span class="cm">/* has no union descriptor */</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0482</span><span class="p">,</span> <span class="mh">0x0203</span><span class="p">),</span> <span class="cm">/* KYOCERA AH-K3001V */</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">NO_UNION_NORMAL</span><span class="p">,</span> <span class="cm">/* has no union descriptor */</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x079b</span><span class="p">,</span> <span class="mh">0x000f</span><span class="p">),</span> <span class="cm">/* BT On-Air USB MODEM */</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">NO_UNION_NORMAL</span><span class="p">,</span> <span class="cm">/* has no union descriptor */</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0ace</span><span class="p">,</span> <span class="mh">0x1602</span><span class="p">),</span> <span class="cm">/* ZyDAS 56K USB MODEM */</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">SINGLE_RX_URB</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0ace</span><span class="p">,</span> <span class="mh">0x1608</span><span class="p">),</span> <span class="cm">/* ZyDAS 56K USB MODEM */</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">SINGLE_RX_URB</span><span class="p">,</span> <span class="cm">/* firmware bug */</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0ace</span><span class="p">,</span> <span class="mh">0x1611</span><span class="p">),</span> <span class="cm">/* ZyDAS 56K USB MODEM - new version */</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">SINGLE_RX_URB</span><span class="p">,</span> <span class="cm">/* firmware bug */</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x22b8</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">),</span> <span class="cm">/* Motorola Q Phone */</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">NO_UNION_NORMAL</span><span class="p">,</span> <span class="cm">/* has no union descriptor */</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0803</span><span class="p">,</span> <span class="mh">0x3095</span><span class="p">),</span> <span class="cm">/* Zoom Telephonics Model 3095F USB MODEM */</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">NO_UNION_NORMAL</span><span class="p">,</span> <span class="cm">/* has no union descriptor */</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0572</span><span class="p">,</span> <span class="mh">0x1321</span><span class="p">),</span> <span class="cm">/* Conexant USB MODEM CX93010 */</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">NO_UNION_NORMAL</span><span class="p">,</span> <span class="cm">/* has no union descriptor */</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0572</span><span class="p">,</span> <span class="mh">0x1324</span><span class="p">),</span> <span class="cm">/* Conexant USB MODEM RD02-D400 */</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">NO_UNION_NORMAL</span><span class="p">,</span> <span class="cm">/* has no union descriptor */</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0572</span><span class="p">,</span> <span class="mh">0x1328</span><span class="p">),</span> <span class="cm">/* Shiro / Aztech USB MODEM UM-3100 */</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">NO_UNION_NORMAL</span><span class="p">,</span> <span class="cm">/* has no union descriptor */</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x22b8</span><span class="p">,</span> <span class="mh">0x6425</span><span class="p">),</span> <span class="cm">/* Motorola MOTOMAGX phones */</span>
	<span class="p">},</span>
	<span class="cm">/* Motorola H24 HSPA module: */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x22b8</span><span class="p">,</span> <span class="mh">0x2d91</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* modem                                */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x22b8</span><span class="p">,</span> <span class="mh">0x2d92</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* modem           + diagnostics        */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x22b8</span><span class="p">,</span> <span class="mh">0x2d93</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* modem + AT port                      */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x22b8</span><span class="p">,</span> <span class="mh">0x2d95</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* modem + AT port + diagnostics        */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x22b8</span><span class="p">,</span> <span class="mh">0x2d96</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* modem                         + NMEA */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x22b8</span><span class="p">,</span> <span class="mh">0x2d97</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* modem           + diagnostics + NMEA */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x22b8</span><span class="p">,</span> <span class="mh">0x2d99</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* modem + AT port               + NMEA */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x22b8</span><span class="p">,</span> <span class="mh">0x2d9a</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* modem + AT port + diagnostics + NMEA */</span>

	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0572</span><span class="p">,</span> <span class="mh">0x1329</span><span class="p">),</span> <span class="cm">/* Hummingbird huc56s (Conexant) */</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">NO_UNION_NORMAL</span><span class="p">,</span> <span class="cm">/* union descriptor misplaced on</span>
<span class="cm">					   data interface instead of</span>
<span class="cm">					   communications interface.</span>
<span class="cm">					   Maybe we should define a new</span>
<span class="cm">					   quirk for this. */</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1bbb</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">),</span> <span class="cm">/* Alcatel OT-I650 */</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">NO_UNION_NORMAL</span><span class="p">,</span> <span class="cm">/* reports zero length descriptor */</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1576</span><span class="p">,</span> <span class="mh">0x03b1</span><span class="p">),</span> <span class="cm">/* Maretron USB100 */</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">NO_UNION_NORMAL</span><span class="p">,</span> <span class="cm">/* reports zero length descriptor */</span>
	<span class="p">},</span>

	<span class="cm">/* Nokia S60 phones expose two ACM channels. The first is</span>
<span class="cm">	 * a modem and is picked up by the standard AT-command</span>
<span class="cm">	 * information below. The second is &#39;vendor-specific&#39; but</span>
<span class="cm">	 * is treated as a serial device at the S60 end, so we want</span>
<span class="cm">	 * to expose it on Linux too. */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x042D</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 3250 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x04D8</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 5500 Sport */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x04C9</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia E50 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0419</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia E60 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x044D</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia E61 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia E61i */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0475</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia E62 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0508</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia E65 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0418</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia E70 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0425</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N71 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0486</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N73 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x04DF</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N75 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x000e</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N77 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0445</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N80 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x042F</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N91 &amp; N91 8GB */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x048E</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N92 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0420</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N93 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x04E6</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N93i  */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x04B2</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 5700 XpressMusic */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0134</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 6110 Navigator (China) */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x046E</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 6110 Navigator */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x002f</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 6120 classic &amp;  */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0088</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 6121 classic */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x00fc</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 6124 classic */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0042</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia E51 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x00b0</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia E66 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x00ab</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia E71 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0481</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N76 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0007</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N81 &amp; N81 8GB */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0071</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N82 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x04F0</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N95 &amp; N95-3 NAM */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0070</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N95 8GB  */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x00e9</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 5320 XpressMusic */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0099</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 6210 Navigator, RM-367 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0128</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 6210 Navigator, RM-419 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x008f</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 6220 Classic */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x00a0</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 6650 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x007b</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N78 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0094</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N85 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x003a</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N96 &amp; N96-3  */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x00e9</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 5320 XpressMusic */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0108</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 5320 XpressMusic 2G */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x01f5</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N97, RM-505 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x02e3</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 5230, RM-588 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0178</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia E63 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x010e</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia E75 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x02d9</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 6760 Slide */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x01d0</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia E52 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0223</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia E72 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0275</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia X6 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x026c</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N97 Mini */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0154</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia 5800 XpressMusic */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x04ce</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia E90 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x01d4</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia E55 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0302</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia N8 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x0335</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia E7 */</span>
	<span class="p">{</span> <span class="n">NOKIA_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x03cd</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Nokia C7 */</span>
	<span class="p">{</span> <span class="n">SAMSUNG_PCSUITE_ACM_INFO</span><span class="p">(</span><span class="mh">0x6651</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Samsung GTi8510 (INNOV8) */</span>

	<span class="cm">/* Support for Owen devices */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x03eb</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">),</span> <span class="p">},</span> <span class="cm">/* Owen SI30 */</span>

	<span class="cm">/* NOTE: non-Nokia COMM/ACM/0xff is likely MSFT RNDIS... NOT a modem! */</span>

	<span class="cm">/* Support Lego NXT using pbLua firmware */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0694</span><span class="p">,</span> <span class="mh">0xff00</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">NOT_A_MODEM</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="cm">/* Support for Droids MuIn LCD */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x04d8</span><span class="p">,</span> <span class="mh">0x000b</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">NO_DATA_INTERFACE</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="cm">/* control interfaces without any protocol set */</span>
	<span class="p">{</span> <span class="n">USB_INTERFACE_INFO</span><span class="p">(</span><span class="n">USB_CLASS_COMM</span><span class="p">,</span> <span class="n">USB_CDC_SUBCLASS_ACM</span><span class="p">,</span>
		<span class="n">USB_CDC_PROTO_NONE</span><span class="p">)</span> <span class="p">},</span>

	<span class="cm">/* control interfaces with various AT-command sets */</span>
	<span class="p">{</span> <span class="n">USB_INTERFACE_INFO</span><span class="p">(</span><span class="n">USB_CLASS_COMM</span><span class="p">,</span> <span class="n">USB_CDC_SUBCLASS_ACM</span><span class="p">,</span>
		<span class="n">USB_CDC_ACM_PROTO_AT_V25TER</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_INTERFACE_INFO</span><span class="p">(</span><span class="n">USB_CLASS_COMM</span><span class="p">,</span> <span class="n">USB_CDC_SUBCLASS_ACM</span><span class="p">,</span>
		<span class="n">USB_CDC_ACM_PROTO_AT_PCCA101</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_INTERFACE_INFO</span><span class="p">(</span><span class="n">USB_CLASS_COMM</span><span class="p">,</span> <span class="n">USB_CDC_SUBCLASS_ACM</span><span class="p">,</span>
		<span class="n">USB_CDC_ACM_PROTO_AT_PCCA101_WAKE</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_INTERFACE_INFO</span><span class="p">(</span><span class="n">USB_CLASS_COMM</span><span class="p">,</span> <span class="n">USB_CDC_SUBCLASS_ACM</span><span class="p">,</span>
		<span class="n">USB_CDC_ACM_PROTO_AT_GSM</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_INTERFACE_INFO</span><span class="p">(</span><span class="n">USB_CLASS_COMM</span><span class="p">,</span> <span class="n">USB_CDC_SUBCLASS_ACM</span><span class="p">,</span>
		<span class="n">USB_CDC_ACM_PROTO_AT_3G</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_INTERFACE_INFO</span><span class="p">(</span><span class="n">USB_CLASS_COMM</span><span class="p">,</span> <span class="n">USB_CDC_SUBCLASS_ACM</span><span class="p">,</span>
		<span class="n">USB_CDC_ACM_PROTO_AT_CDMA</span><span class="p">)</span> <span class="p">},</span>

	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">acm_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">acm_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;cdc_acm&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">acm_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span>	<span class="n">acm_disconnect</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span>	<span class="n">acm_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span>	<span class="n">acm_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_resume</span> <span class="o">=</span>	<span class="n">acm_reset_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">acm_ids</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">supports_autosuspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">disable_hub_initiated_lpm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * TTY driver structures.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">acm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">install</span> <span class="o">=</span>		<span class="n">acm_tty_install</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">acm_tty_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">acm_tty_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span>		<span class="n">acm_tty_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hangup</span> <span class="o">=</span>		<span class="n">acm_tty_hangup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>		<span class="n">acm_tty_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span>		<span class="n">acm_tty_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">acm_tty_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span>		<span class="n">acm_tty_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span>		<span class="n">acm_tty_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span>	<span class="n">acm_tty_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span> <span class="o">=</span>		<span class="n">acm_tty_break_ctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span>		<span class="n">acm_tty_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span>		<span class="n">acm_tty_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span>		<span class="n">acm_tty_tiocmset</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Init / exit.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">acm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">acm_tty_driver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">ACM_TTY_MINORS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acm_tty_driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">acm_tty_driver</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;acm&quot;</span><span class="p">,</span>
	<span class="n">acm_tty_driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ttyACM&quot;</span><span class="p">,</span>
	<span class="n">acm_tty_driver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">ACM_TTY_MAJOR</span><span class="p">,</span>
	<span class="n">acm_tty_driver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">acm_tty_driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_SERIAL</span><span class="p">,</span>
	<span class="n">acm_tty_driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">SERIAL_TYPE_NORMAL</span><span class="p">,</span>
	<span class="n">acm_tty_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_REAL_RAW</span> <span class="o">|</span> <span class="n">TTY_DRIVER_DYNAMIC_DEV</span><span class="p">;</span>
	<span class="n">acm_tty_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">acm_tty_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span> <span class="n">B9600</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span>
								<span class="n">HUPCL</span> <span class="o">|</span> <span class="n">CLOCAL</span><span class="p">;</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">acm_tty_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acm_ops</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_register_driver</span><span class="p">(</span><span class="n">acm_tty_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">acm_tty_driver</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">acm_tty_driver</span><span class="p">);</span>
		<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">acm_tty_driver</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">KBUILD_MODNAME</span> <span class="s">&quot;: &quot;</span> <span class="n">DRIVER_DESC</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">acm_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm_driver</span><span class="p">);</span>
	<span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">acm_tty_driver</span><span class="p">);</span>
	<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">acm_tty_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">acm_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">acm_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_CHARDEV_MAJOR</span><span class="p">(</span><span class="n">ACM_TTY_MAJOR</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
